cscope 15 $HOME/MySpace/gearkit               0000630436
	@Gear.cpp

1 
	~"G—r.h
"

2 
	~"RefPoŞ.h
"

3 
	~"Logg”.h
"

4 
	~"G—r.h
"

5 
	~"BufãrPoŞ.h
"

6 
	~"RefPoŞ.h
"

7 
	~"Logg”.h
"

8 
	~"SšgËtÚ.h
"

10 
	#DEFAULT_FRAME_RATE
 60

	)

11 
Çme¥aû
 
	gk™
 {

13 
	gG—r
::
G—r
()

14 : 
äame_
(0)

15 , 
äame_¿‹_
(
DEFAULT_FRAME_RATE
)

16 , 
äame_m£c_
(1000 / 
DEFAULT_FRAME_RATE
)

17 , 
v®id_
(
çl£
)

18 , 
begše_time_
(0)

19 , 
wa™_time_
(0)

23 
	gG—r
::~
G—r
()

27 
boŞ
 
G—r
::
ba£In™
()

29  
Œue
;

32 
	gG—r
::
logic
()

34 
upd©e
();

37 
	gG—r
::
begš
()

39 
begše_time_
 = 
k™
::
time
(è- 
äame_m£c_
;

40 
DBG
("[G—r](¡¬tèbegš_time:%d f¿me_m£c_:%d", 
begše_time_
, 
äame_m£c_
);

42 
	gv®id_
 = 
Œue
;

45 
	gG—r
::
¡İ
()

47 
v®id_
 = 
çl£
;

50 
	gG—r
::
’d
()

52 
SšgËtÚ
<
BufãrPoŞMªag”
>::
de¡royIn¡ªû
();

53 
	gSšgËtÚ
<
	gRefPoŞMªag”
>::
de¡royIn¡ªû
();

54 
	gSšgËtÚ
<
	gLogg”
>::
de¡royIn¡ªû
();

56 
	gSšgËtÚ
<
	gG—r
>::
de¡royIn¡ªû
();

59 
	gG—r
::
mašLoİ
()

61 
begše_time_
 +ğ
äame_m£c_
;

63 ++
	gäame_
;

65 
logic
();

67 
ušt32_t
 
	g’d_time
 = 
k™
::
time
();

69 
ušt32_t
 
	g¥¬e
 = 0;

70 ià(
	g’d_time
 > 
	gbegše_time_
)

73 
ušt32_t
 
	g·s£d
 = 
’d_time
 - 
begše_time_
;

74 ià(
	g·s£d
 <ğ
äame_m£c_
)

76 
¥¬e
 = 
äame_m£c_
 - 
·s£d
;

80 
	gwa™_time_
 = 
·s£d
 - 
äame_m£c_
;

86 
	g¥¬e
 = 
begše_time_
 - 
’d_time
;

89 ià(
	gwa™_time_
 > 0)

91 ià(
	gwa™_time_
 >ğ
¥¬e
)

93 
wa™_time_
 -ğ
¥¬e
;

94 
	g¥¬e
 = 0;

98 
	gwa™_time_
 = 0;

99 
	g¥¬e
 -ğ
wa™_time_
;

102 ià(
	gwa™_time_
 > 0)

103 
DBG
("[G—r](mašLoİèWAIT TIME:%d, %d\n", 
wa™_time_
, 
äame_
);

106 ià(
	g¥¬e
 > 0)

109 
	gg_RefPoŞ
->
g‘Cu¼’tPoŞ
()->
ş—r
();

110 
	g¥¬e
 = 
¥¬eLogic
(
¥¬e
);

112 ià(
	g¥¬e
 > 0)

113 
	gk™
::
¦“p
(
¥¬e
);

117 
	gG—r
::
£tF¿meR©e
(
¿‹
)

119 
äame_¿‹_
 = 
¿‹
;

120 
	gäame_m£c_
 = (1000 / 
äame_¿‹_
);

	@Gear.h

1 #iâdeà
__KIT_GEAR_H__


2 
	#__KIT_GEAR_H__


	)

4 
	~"Ref.h
"

6 
Çme¥aû
 
	gk™
 {

8 şas 
	cG—r
 : 
public
 
Ref


10 
public
:

12 
G—r
();

13 
	gvœtu®
 ~
G—r
();

15 
vœtu®
 
boŞ
 
ba£In™
();

17 
vœtu®
 
begš
();

18 
vœtu®
 
¡İ
();

19 
vœtu®
 
’d
();

20 
vœtu®
 
logic
();

22 
vœtu®
 
ušt32_t
 
¥¬eLogic
(ušt32_ˆ
¥¬e_time
è{  
	g¥¬e_time
; };

25 
mašLoİ
();

28 
ušt32_t
 
g‘F¿me
(ècÚ¡ {  
	gäame_
; }

30 
ušt32_t
 
g‘F¿meR©e
(ècÚ¡ {  
	gäame_¿‹_
; }

31 
£tF¿meR©e
(
ušt32_t
 
¿‹
);

33 
ušt32_t
 
g‘F¿meD–
(ècÚ¡ {  
	gäame_d–_
; }

34 
£tNextD–Z”o
(
boŞ
 
z”o
è{ 
	gÃxt_d–_z”o_
 = zero; }

36 
boŞ
 
isV®id
(ècÚ¡ {  
	gv®id_
; }

37 
	g´Ùeùed
:

39 
ušt32_t
 
äame_
;

41 
ušt32_t
 
	gäame_¿‹_
;

43 
ušt32_t
 
	gäame_m£c_
;

45 
ušt32_t
 
	gäame_d–_
;

49 
boŞ
 
	gÃxt_d–_z”o_
;

50 
boŞ
 
	gv®id_
;

51 
	g´iv©e
:

52 
ušt32_t
 
begše_time_
;

53 
ušt32_t
 
	gwa™_time_
;

58 
	#g_G—r
 (
k™
::
SšgËtÚ
<k™::
G—r
>::
	`š¡ªû
())

	)

	@base/Array.h

1 #iâdeà
__KIT_ARRAY_H__


2 
	#__KIT_ARRAY_H__


	)

6 
	~<¡dio.h
>

7 
	~<memÜy.h
>

9 
Çme¥aû
 
	gk™
 {

14 
	g‹m¶©e
<
ty³Çme
 
	gTy³
, cÚ¡ 
	gL’gth
>

15 şas 
	cA¼ay


17 
	sI‹m


19 
	gÃxt
;

20 
	g´ev
;

21 
Ty³
 
	gv®ue
;

23 
	gpublic
:

24 
A¼ay
(è: 
couÁ_
(0), 
h—d_
(-1), 
_
(-1)

26 
ş—r
();

29 
boŞ
 
g‘
(
šdex
, 
Ty³
& 
v®
)

31 
	gI‹m
& 
	g™em
 = 
¬¿y_
[
šdex
];

32 ià(
™emEm±y
(
™em
))

33  
	gçl£
;

34 
	gv®
 = 
™em
.
v®ue
;

35  
	gŒue
;

38 
£t
(
šdex
, cÚ¡ 
Ty³
& 
v®
)

40 
	gI‹m
& 
	g™em
 = 
¬¿y_
[
šdex
];

41 ià(
™emEm±y
(
™em
))

43 
	g™em
.
	g´ev
 = 
_
;

44 
	g™em
.
	gv®ue
 = 
v®
;

45 
	g™em
.
	gÃxt
 = -1;

46 ià(
	gh—d_
 == -1)

47 
h—d_
 = 
šdex
;

49 ià(
	g_
 != -1)

50 
¬¿y_
[
_
].
Ãxt
 = 
šdex
;

51 
	g_
 = 
šdex
;

52 ++
	gcouÁ_
;

56 
	g™em
.
	gv®ue
 = 
v®
;

60 
d–
(
šdex
)

62 
	gI‹m
& 
	g™em
 = 
¬¿y_
[
šdex
];

63 ià(
™emEm±y
(
™em
))

65 
	gÃxt
 = 
™em
.
Ãxt
;

66 
	g´ev
 = 
™em
.
´ev
;

67 ià(
	g´ev
 != -1)

68 
¬¿y_
[
´ev
].
Ãxt
 =‚ext;

69 ià(
	gÃxt
 != -1)

70 
¬¿y_
[
Ãxt
].
´ev
 =…rev;

71 ià(
	gh—d_
 =ğ
šdex
)

72 
h—d_
 = 
Ãxt
;

73 ià(
	g_
 =ğ
šdex
)

74 
_
 = 
´ev
;

75 
em±yI‹m
(
™em
);

76 --
	gcouÁ_
;

78 
couÁ
(ècÚ¡ {  
	gcouÁ_
; }

80 
ş—r
()

82 
mem£t
(
¬¿y_
, 0, (
I‹m
è* 
L’gth
);

83 
	gh—d_
 = 
_
 = -1;

84 
	gcouÁ_
 = 0;

87 
	g´iv©e
:

88 
boŞ
 
™emEm±y
(cÚ¡ 
I‹m
& 
™em
) const

90  
™em
.
Ãxt
 =ğ0 && i‹m.
´ev
 == 0;

92 
em±yI‹m
(
I‹m
& 
™em
)

94 
	g™em
.
	gÃxt
 = 
™em
.
´ev
 = 0;

96 
	gcouÁ_
;

97 
	gh—d_
;

98 
	g_
;

99 
	gpos_
;

100 
I‹m
 
	g¬¿y_
[
L’gth
];

102 
	gpublic
:

104 şas 
	cI‹¿tÜ


106 
public
:

107 
I‹¿tÜ
(
I‹m
* 
¬¿y
, 
šdex
)

108 : 
¬¿y_
(
¬¿y
)

109 , 
šdex_
(
šdex
)

112 
	gI‹¿tÜ
& 
	gİ”©Ü
 ++()

114 
	gšdex_
 = 
¬¿y_
[
šdex_
].
Ãxt
;

115  *
	gthis
;

117 
boŞ
 
	gİ”©Ü
 ==(cÚ¡ 
I‹¿tÜ
& 
™
)

119  
šdex_
 =ğ
™
.index_ ;

121 
boŞ
 
	gİ”©Ü
 !=(cÚ¡ 
I‹¿tÜ
& 
™
)

124  
šdex_
 !ğ
™
.index_;

126 
	gTy³
& 
	gİ”©Ü
 *()

128  
	g¬¿y_
[
šdex_
].
	gv®ue
;

130 
	g´iv©e
:

131 
I‹m
* 
¬¿y_
;

132 
	gšdex_
;

135 
I‹¿tÜ
 
begš
()

137  
I‹¿tÜ
(
¬¿y_
, 
h—d_
);

139 
I‹¿tÜ
 
’d
()

141  
I‹¿tÜ
(
¬¿y_
, -1);

	@base/List.h

1 #iâdeà
__KIT_LIST_H__


2 
	#__KIT_LIST_H__


	)

4 
Çme¥aû
 
	gk™
 {

6 
	g‹m¶©e
<
ty³Çme
 
	gTy³
>

7 şas 
	cLi¡


9 
	sI‹m


11 
Ty³
 
	gv®ue
;

12 
I‹m
* 
	gÃxt
;

13 
I‹m
* 
	g´ev
;

15 
	gpublic
:

16 
Li¡
(): 
h—d_
(0), 
_
(0), 
couÁ_
(0)

19 ~
Li¡
()

21 
ş—r
();

24 
couÁ
(ècÚ¡ {  
	gcouÁ_
; }

26 
boŞ
 
äÚt
(
Ty³
& 
v®ue
)

28 ià(
	gcouÁ_
 =ğ0 || 
h—d_
 == 0)

29  
çl£
;

30 
	gv®ue
 = 
h—d_
->
v®ue
;

31  
	gŒue
;

35 
boŞ
 
pİ
(
Ty³
& 
v®ue
)

37 ià(
	gcouÁ_
 =ğ0 || 
h—d_
 == 0)

38  
çl£
;

39 
	gv®ue
 = 
h—d_
->
v®ue
;

40 
I‹m
* 
	gnxt
 = 
h—d_
->
Ãxt
;

41 ià(
	gnxt
)

42 
	gnxt
->
	g´ev
 = 0;

44 
	g_
 = 0;

45 
d–‘e
 
	gh—d_
;

46 
	gh—d_
 = 
nxt
;

47 --
	gcouÁ_
;

48  
	gŒue
;

52 
boŞ
 
push
(cÚ¡ 
Ty³
& 
™em
)

54 
I‹m
* 
	gp
 = 
Ãw
 Item();

55 
	gp
->
	gv®ue
 = 
™em
;

56 
	gp
->
	gÃxt
 = 0;

57 
	gp
->
	g´ev
 = 
_
;

58 ià(
	g_
)

59 
	g_
->
	gÃxt
 = 
p
;

60 ià(
	gh—d_
 == 0)

61 
h—d_
 = 
p
;

62 
	g_
 = 
p
;

63 ++
	gcouÁ_
;

64  
	gŒue
;

67 
ş—r
()

69 
I‹m
* 
	gp
 = 
h—d_
;

70 
I‹m
* 
	g²
 = 0;

71 
	gp
)

73 
	g²
 = 
p
->
Ãxt
;

74 
d–‘e
 
	gp
;

75 
	gp
 = 
²
;

80 
boŞ
 
š£¹
(
šdex
, cÚ¡ 
Ty³
& 
™em
)

82  
	gŒue
;

86 
boŞ
 
”a£
(
šdex
)

88  
	gŒue
;

91 
	g´iv©e
:

92 
I‹m
* 
h—d_
;

93 
I‹m
* 
	g_
;

94 
	gcouÁ_
;

95 
	gpublic
:

97 şas 
	cI‹¿tÜ


99 
public
:

100 
I‹m
* 
node_
;

101 
I‹¿tÜ
(
I‹m
* 
node
è: 
node_
(node)

104 
I‹¿tÜ
& 
İ”©Ü
 ++()

106 
node_
 =‚ode_->
Ãxt
;

107  *
	gthis
;

109 
boŞ
 
	gİ”©Ü
 ==(cÚ¡ 
I‹¿tÜ
& 
™
)

111  
node_
 =ğ
™
.node_;

113 
boŞ
 
	gİ”©Ü
 !=(cÚ¡ 
I‹¿tÜ
& 
™
)

115  
node_
 !ğ
™
.node_;

117 
	gTy³
& 
	gİ”©Ü
 *()

119  
	gnode_
->
	gv®ue
;

122 
I‹¿tÜ
 
begš
() const

124  
I‹¿tÜ
(
h—d_
);

126 
I‹¿tÜ
 
’d
() const

128  
I‹¿tÜ
(
NULL
);

	@base/Map.h

1 #iâdeà
__KIT_MAP_H__


2 
	#__KIT_MAP_H__


	)

8 
	~<memÜy.h
>

9 
	~<funùiÚ®
>

11 
Çme¥aû
 
	gk™
 {

13 
	g‹m¶©e
<
ty³Çme
 
	gKeyTy³
,y³Çm
	gV®ueTy³
, cÚ¡ 
	gL’gth
>

14 şas 
	cM­


17 
	sI‹m


19 
I‹m
(
KeyTy³
 
k
, cÚ¡ 
V®ueTy³
& 
v
, I‹m* 
n
): 
key
(k), 
v®ue
(v), 
Ãxt
(n) {}

20 
KeyTy³
 
	gkey
;

21 
V®ueTy³
 
	gv®ue
;

22 
I‹m
* 
	gÃxt
;

23 } *
	tI‹mLi¡
;

25 
	gpublic
:

26 
M­
()

28 
mem£t
(
vec_
, 0, (
I‹mLi¡
è* 
L’gth
);

30 ~
M­
()

32 
ş—r
();

34 
boŞ
 
has
(
KeyTy³
 
key
) const

36 
	gšdex
 = 
key
 % 
L’gth
;

37 
I‹mLi¡
 
	g¶i¡
 = 
vec_
[
šdex
];

38 ià(
	g¶i¡
 == 0)

39  
çl£
;

40 
	g¶i¡
)

42 ià(
	g¶i¡
->
	gkey
 =ğ
key
)

44  
Œue
;

46 
	g¶i¡
 = 
¶i¡
->
Ãxt
;

48  
	gçl£
;

50 
boŞ
 
g‘
(
KeyTy³
 
key
, 
V®ueTy³
& 
v
) const

52 
	gšdex
 = 
key
 % 
L’gth
;

53 
I‹mLi¡
 
	g¶i¡
 = 
vec_
[
šdex
];

54 ià(
	g¶i¡
 == 0)

55  
çl£
;

56 
	g¶i¡
)

58 ià(
	g¶i¡
->
	gkey
 =ğ
key
)

60 
v
 = 
¶i¡
->
v®ue
;

61  
	gŒue
;

63 
	g¶i¡
 = 
¶i¡
->
Ãxt
;

65  
	gçl£
;

67 
£t
(
KeyTy³
 
key
, cÚ¡ 
V®ueTy³
& 
v
)

69 
	gšdex
 = (
key
 % 
L’gth
);

70 
I‹mLi¡
 
	g¶i¡
 = 
vec_
[
šdex
];

71 
I‹mLi¡
 
	gµ»v
 = 0;

72 
	g¶i¡
)

74 ià(
	g¶i¡
->
	gkey
 =ğ
key
)

76 
	gµ»v
 = 
¶i¡
;

77 
	g¶i¡
 = 
¶i¡
->
Ãxt
;

79 ià(
	g¶i¡
 == 0)

81 
¶i¡
 = 
Ãw
 
I‹m
(
key
, 
v
, 0);

83 ià(
	gµ»v
)

84 
	gµ»v
->
	gÃxt
 = 
¶i¡
;

86 
	gvec_
[
šdex
] = 
¶i¡
;

88 
boŞ
 
d–
(
KeyTy³
 
key
, 
¡d
::
funùiÚ
<(
V®ueTy³
&)> 
d–_ÿÎback
 = 
nuÎ±r
)

90 
šdex
 = (
key
 % 
L’gth
);

91 
I‹mLi¡
 
	g¶i¡
 = 
vec_
[
šdex
];

92 ià(
	g¶i¡
 == 0)

93  
çl£
;

94 
I‹mLi¡
 
	gµ»v
 = 0;

95 
	g¶i¡
)

97 ià(
	g¶i¡
->
	gkey
 =ğ
key
)

99 
	gµ»v
 = 
¶i¡
;

100 
	g¶i¡
 = 
¶i¡
->
Ãxt
;

102 ià(
	g¶i¡
)

104 ià(
	gµ»v
)

105 
	gµ»v
->
	gÃxt
 = 
¶i¡
->
Ãxt
;

107 
	gvec_
[
šdex
] = 0;

108 ià(
	gd–_ÿÎback
 !ğ
nuÎ±r
)

109 
d–_ÿÎback
(
¶i¡
->
v®ue
);

110 
d–‘e
 
	g¶i¡
;

111  
	gŒue
;

113  
	gçl£
;

115 
ş—r
(
¡d
::
funùiÚ
<(
V®ueTy³
&)> 
d–_ÿÎback
 = 
nuÎ±r
)

117 ià(
d–_ÿÎback
 =ğ
nuÎ±r
)

118 
d–_ÿÎback
 = [](
V®ueTy³
& 
v
){ };

119 
I‹mLi¡
 
	g¶i¡
 = 0;

120 
I‹mLi¡
 
	g²ext
 = 0;

121 
	gi
 = 0; i !ğ
L’gth
; ++i)

123 
	g¶i¡
 = 
vec_
[
i
];

124 
	g¶i¡
)

126 
	g²ext
 = 
¶i¡
->
Ãxt
;

127 
d–_ÿÎback
(
¶i¡
->
v®ue
);

128 
d–‘e
 
	g¶i¡
;

129 
	g¶i¡
 = 
²ext
;

131 
	gvec_
[
i
] = 0;

135 
	gV®ueTy³
& 
	gİ”©Ü
 [] (
KeyTy³
 
	gkey
)

137 
	gšdex
 = 
key
 % 
L’gth
;

138 
I‹mLi¡
 
	g¶i¡
 = 
vec_
[
šdex
];

139 
	g¶i¡
)

141 ià(
	g¶i¡
->
	gkey
 =ğ
key
)

143  
¶i¡
->
v®ue
;

145 
	g¶i¡
 = 
¶i¡
->
Ãxt
;

147  
V®ueTy³
();

149 
	g´iv©e
:

150 
I‹mLi¡
 
vec_
[
L’gth
];

	@base/QList.h

1 #iâdeà
__KIT_QLIST_H__


2 
	#__KIT_QLIST_H__


	)

7 
	~"Queue.h
"

8 
	~"Li¡.h
"

10 
Çme¥aû
 
	gk™
 {

12 
	g‹m¶©e
<
ty³Çme
 
	gTy³
, cÚ¡ 
	gQL’gth
>

13 şas 
	cQLi¡


15 
	gpublic
:

16 
QLi¡
(): 
couÁ_
(0)

20 
boŞ
 
pİ
(
Ty³
& 
v®ue
)

22 
boŞ
 
»t
 = 
que_
.
pİ
(
v®ue
è|| 
li¡_
.pop(value);

23 ià(
	g»t
)

24 --
	gcouÁ_
;

25  
	g»t
;

28 
boŞ
 
push
(cÚ¡ 
Ty³
& 
v®ue
)

30 ià(
	gli¡_
.
couÁ
(è> 0 || !
	gque_
.
push
(
v®ue
))

31 
	gli¡_
.
push
(
v®ue
);

32 ++
	gcouÁ_
 ;

33  
	gŒue
;

36 
boŞ
 
äÚt
(
Ty³
& 
v®ue
)

38  
	gque_
.
äÚt
(
v®ue
è|| 
	gli¡_
.front(value);

41 
couÁ
() const

43  
	gcouÁ_
;

46 
	g´iv©e
:

47 
couÁ_
;

48 
	gQueue
<
	gTy³
, 
	gQL’gth
> 
	gque_
;

49 
	gLi¡
<
	gTy³
> 
	gli¡_
;

	@base/Queue.h

1 #iâdeà
__KIT_QUEUE_H__


2 
	#__KIT_QUEUE_H__


	)

4 
Çme¥aû
 
	gk™
 {

7 
	g‹m¶©e
<
ty³Çme
 
	gTy³
, cÚ¡ 
	gL’gth
>

8 şas 
	cQueue


10 
	gpublic
:

11 
Queue
(): 
couÁ_
(0), 
h—d_
(0), 
_
(0)

15 
boŞ
 
pİ
(
Ty³
& 
v®ue
)

17 ià(
	gcouÁ_
 == 0)

18  
çl£
;

19 
	gv®ue
 = 
que_
[
h—d_
];

20 ++
	gh—d_
;

21 
	gh—d_
 %ğ
L’gth
;

22 --
	gcouÁ_
;

24  
	gŒue
;

27 
boŞ
 
push
(cÚ¡ 
Ty³
& 
v®ue
)

29 ià(
	gcouÁ_
 =ğ
L’gth
)

30  
çl£
;

31 
	gque_
[
_
] = 
v®ue
;

32 ++
	g_
;

33 
	g_
 %ğ
L’gth
;

34 ++
	gcouÁ_
;

36  
	gŒue
;

39 
boŞ
 
äÚt
(
Ty³
& 
v®ue
)

41 ià(
	gcouÁ_
 == 0)

42  
çl£
;

43 
	gv®ue
 = 
que_
[
h—d_
];

44  
	gŒue
;

47 
couÁ
()

49  
	gcouÁ_
;

52 
»¡
()

54  
	gL’gth
 - 
	gcouÁ_
;

57 
	g´iv©e
:

58 
couÁ_
;

59 
	gh—d_
;

60 
	g_
;

61 
Ty³
 
	gque_
[
L’gth
];

66 
	g‹m¶©e
<
ty³Çme
 
	gTy³
, cÚ¡ 
	gL’gth
>

67 şas 
	cMšQueue


69 
	gpublic
:

70 
MšQueue
(): 
couÁ_
(0)

74 
boŞ
 
pİ
(
Ty³
& 
v®ue
)

76 ià(
couÁ_
 == 0)

77  
çl£
;

78 
	gv®ue
 = 
que_
[1];

79 
	gque_
[1] = 
que_
[
couÁ_
];

80 --
	gcouÁ_
;

81 
adju¡Down
(1);

82  
	gŒue
;

85 
boŞ
 
push
(cÚ¡ 
Ty³
& 
v®ue
)

87 ià(
	gcouÁ_
 =ğ
L’gth
)

88  
çl£
;

89 ++
	gcouÁ_
;

90 
	gque_
[
couÁ_
] = 
v®ue
;

91 
adju¡
(
couÁ_
);

92  
	gŒue
;

95 
boŞ
 
äÚt
(
Ty³
& 
v®ue
)

97 ià(
	gcouÁ_
 == 0)

98  
çl£
;

99 
	gv®ue
 = 
que_
[1];

100  
	gŒue
;

103 
couÁ
(ècÚ¡ {  
	gcouÁ_
; }

104 
»¡
(ècÚ¡ {  
	gL’gth
 + 1 - 
	gcouÁ_
; }

105 
	g´Ùeùed
:

106 
vœtu®
 
boŞ
 
com·»
(cÚ¡ 
Ty³
& 
a
, cÚ¡ Ty³& 
b
) const

108  
	ga
 > 
	gb
;

111 
boŞ
 
adju¡Down
(
šdex
)

113 
	gËá
;

114 
	gright
;

115 
	grg‘
;

116 
boŞ
 
	gchªged
 = 
çl£
;

117 
	gšdex
 < 
	gcouÁ_
)

119 
	gËá
 = 
šdex
 << 1;

120 
	gright
 = 
Ëá
 + 1;

121 
	grg‘
 = 
Ëá
;

122 ià(
	gright
 <ğ
couÁ_
 && 
com·»
(
que_
[
Ëá
], que_[
right
]))

124 
	grg‘
 = 
right
;

126 ià(
	grg‘
 <ğ
couÁ_
 && 
com·»
(
que_
[
šdex
], que_[
rg‘
]))

128 
exchªge
(
šdex
, 
rg‘
);

129 
	gšdex
 = 
rg‘
;

130 
	gchªged
 = 
Œue
;

135  
	gchªged
;

138 
adju¡
(
šdex
)

140 (
	gšdex
 >>= 1) > 0)

142 ià(! 
adju¡Down
(
šdex
))

147 
exchªge
(
šdex1
, 
šdex2
)

149 
Ty³
 
	gtmp
 = 
que_
[
šdex1
];

150 
	gque_
[
šdex1
] = 
que_
[
šdex2
];

151 
	gque_
[
šdex2
] = 
tmp
;

153 
	g´iv©e
:

154 
couÁ_
;

155 
Ty³
 
	gque_
[
L’gth
 + 1];

158 
	g‹m¶©e
<
ty³Çme
 
	gTy³
, cÚ¡ 
	gL’gth
>

159 
şass
 
	gMaxQueue
 : 
public
 
MšQueue
<
Ty³
, 
	gL’gth
>

161 
	g´Ùeùed
:

162 
vœtu®
 
boŞ
 
com·»
(cÚ¡ 
Ty³
&
a
, cÚ¡ Ty³& 
b
) const

164  
	ga
 < 
	gb
;

	@base/Singleton.h

1 #iâdeà
__KIT_SINGLETON_H__


2 
	#__KIT_SINGLETON_H__


	)

10 
Çme¥aû
 
	gk™
 {

12 
	g‹m¶©e
< 
ty³Çme
 
	gT
 >

13 şas 
	cSšgËtÚ


15 
	gpublic
:

17 
šlše
 
T
* 
š¡ªû
()

19 ifĞ!
š¡ªû_
 )

21 
š¡ªû_
 = 
Ãw
 
T
();

22 
	gš¡ªû_
->
ba£In™
();

25  
	gš¡ªû_
;

29 
de¡royIn¡ªû
()

31 ià(
	gš¡ªû_
)

33 
d–‘e
 
	gš¡ªû_
;

34 
	gš¡ªû_
 = 0;

39 
boŞ
 
exi¡s
()

41  !
	gš¡ªû_
;

44 
	g´Ùeùed
:

45 
T
* 
š¡ªû_
;

48 
	g‹m¶©e
<
ty³Çme
 
	gT
> 
T
* 
	gSšgËtÚ
<T>::
š¡ªû_
 = 0;

	@base/base.h

1 #iâdeà
__KIT_BASE_H__


2 
	#__KIT_BASE_H__


	)

4 
	~"SšgËtÚ.h
"

5 
	~"Queue.h
"

6 
	~"Bufãr.h
"

7 
	~"A¼ay.h
"

	@debug/DebugInput.cpp

1 
	~"DebugIÅut.h
"

2 
	~<¡dio.h
>

4 
	~<sys/ioùl.h
>

5 
	~<uni¡d.h
>

7 
Çme¥aû
 
	gk™
 {

9 
	gDebugIÅut
::
DebugIÅut
()

13 
DebugIÅut
::~DebugInput()

17 
boŞ
 
DebugIÅut
::
ba£In™
()

19 
št32_t
 
noblock
 = 1;

20 
ioùl
(
STDIN_FILENO
, 
FIONBIO
, &
noblock
);

21  
	gŒue
;

24 
	gDebugIÅut
::
upd©e
()

26 
št32_t
 
Ën
 = 
»ad
(
STDIN_FILENO
, 
buf_
, 
DEBUG_INPUT_SIZE
);

27 ià(
	gËn
 > 0)

29 
	gbuf_
[
Ën
 - 1] = '\0';

30 autØ
	gix1
 = 
hªdËr_m­_
.
fšd
(
buf_
);

31 ià(
	gix1
 !ğ
hªdËr_m­_
.
’d
())

33 
ix1
->
£cÚd
(
buf_
);

35 autØ
	gix2
 = 
hªdËr_vec_
.
begš
(); ix2 !ğhªdËr_vec_.
’d
(); ++ix2)

37 (*
	gix2
)(
	gbuf_
);

42 
	gDebugIÅut
::
addHªdËr
(
DebugCmdHªdËr
 
hªdËr
)

44 
hªdËr_vec_
.
push_back
(
hªdËr
);

47 
	gDebugIÅut
::
£tHªdËr
(cÚ¡ 
¡d
::
¡ršg
& 
cmd
, 
DebugCmdHªdËr
 
hªdËr
)

49 
	ghªdËr_m­_
[
cmd
] = 
hªdËr
;

	@debug/DebugInput.h

1 #iâdeà
__KIT_DEBUG_INPUT_H__


2 
	#__KIT_DEBUG_INPUT_H__


	)

4 
	~"Ref.h
"

5 
	~"SšgËtÚ.h
"

6 
	~<funùiÚ®
>

7 
	~<¡ršg
>

8 
	~<unÜd”ed_m­
>

10 #iâdeà
DEBUG_INPUT_SIZE


11 
	#DEBUG_INPUT_SIZE
 (512)

	)

14 
Çme¥aû
 
	gk™
 {

16 
	g¡d
::
	tfunùiÚ
<(cÚ¡ 
	t¡d
::
	t¡ršg
&)> 
	tDebugCmdHªdËr
;

18 şas 
	cDebugIÅut
 : 
public
 
Ref


20 
public
:

21 
KIT_CREATE_FUNC
(
DebugIÅut
)

22 
DebugIÅut
();

23 
	gvœtu®
 ~
DebugIÅut
();

25 
vœtu®
 
boŞ
 
ba£In™
();

27 
vœtu®
 
upd©e
();

29 
vœtu®
 
addHªdËr
(
DebugCmdHªdËr
 
hªdËr
);

30 
vœtu®
 
£tHªdËr
(cÚ¡ 
¡d
::
¡ršg
& 
cmd
, 
DebugCmdHªdËr
 
hªdËr
);

31 
	g´iv©e
:

32 
buf_
[
DEBUG_INPUT_SIZE
];

34 
	g¡d
::
veùÜ
<
DebugCmdHªdËr
> 
hªdËr_vec_
;

35 
	g¡d
::
unÜd”ed_m­
<
¡d
::
¡ršg
, 
	gDebugCmdHªdËr
> 
	ghªdËr_m­_
;

38 
	#g_Debug
 (
k™
::
SšgËtÚ
<k™::
DebugIÅut
>::
	`š¡ªû
())

	)

	@debug/debugfunc.h

1 #iâdeà
__DEBUG_FUNC_H__


2 
	#__DEBUG_FUNC_H__


	)

4 
	~<time.h
>

5 
	~<¡dio.h
>

7 
	#KIT_BEGIN
(
x
) \

8 
şock_t
 
şock_¡¬t_xx
##
x
, 
şock_fšish_xx
##x; \

9 
şock_¡¬t_xx
##
x
 = 
	`şock
()

	)

11 
	#KIT_END
(
x
, 
s
) \

12 
şock_fšish_xx
##
x
 = 
	`şock
(); \

13 
	`´štf
(
s
); \

14 
	`´štf
("%lf\n", ()(
şock_fšish_xx
##
x
 - 
şock_¡¬t_xx
##xè/ 
CLOCKS_PER_SEC
)

	)

16 
	#KIT_RUN
(
Ën
è
i
 = 0; i !ğËn; ++i){}

	)

	@gearkit.h

1 #iâdeà
__GEAR_KIT_H__


2 
	#__GEAR_KIT_H__


	)

4 
	~"ba£/ba£.h
"

5 
	~"k™/k™.h
"

6 
	~"ÃtwÜk/ÃtwÜk.h
"

7 
	~"G—r.h
"

	@kit/Buffer.cpp

1 
	~"Bufãr.h
"

2 
	~<¡dlib.h
>

3 
	~<¡dio.h
>

5 
Çme¥aû
 
	gk™
 {

7 
	gBufãr
::
Bufãr
()

8 : 
ÿ·c™y_
(0)

9 , 
h—d_
(
NULL
)

10 , 
_
(
NULL
)

11 , 
wr™e_cur_
(
NULL
)

12 , 
»ad_cur_
(
NULL
)

16 
	gBufãr
::~
Bufãr
()

18 ià(
h—d_
)

20 
ä“
(
h—d_
);

24 
boŞ
 
	gBufãr
::
š™
(
size_t
 
size
)

26 
ÿ·c™y_
 = 
size
;

27 
	gh—d_
 = 
»š‹½»t_ÿ¡
<
ušt8_t
*>(
m®loc
((è* 
size
));

28 
	g_
 = 
h—d_
 + 
size
;

29 
	gwr™e_cur_
 = 
h—d_
;

30 
	g»ad_cur_
 = 
h—d_
;

31  
	gŒue
;

34 
boŞ
 
	gBufãr
::
ex·ndBufãr
(
size_t
 
»quœed_ÿ·c™y
)

36 
size_t
 
»que¡ed_ÿ·c™y
 = 
¡d
::
max
(
»quœed_ÿ·c™y
 + 64, 
ÿ·c™y_
 * 2);

37 
size_t
 
	gwr™‹n_size
 = 
g‘Wr™‹nSize
();

38 
size_t
 
	g»ad_size
 = 
g‘R—dSize
();

39 * 
	gÃw_buf
 = 
»®loc
(
h—d_
, 
»que¡ed_ÿ·c™y
);

40 ià(
	gÃw_buf
)

42 
	gh—d_
 = 
»š‹½»t_ÿ¡
<
ušt8_t
*>(
Ãw_buf
);

43 
	g_
 = 
h—d_
 + 
»que¡ed_ÿ·c™y
;

44 
	gwr™e_cur_
 = 
h—d_
 + 
wr™‹n_size
;

45 
	g»ad_cur_
 = 
h—d_
 + 
»ad_size
;

46 
	gÿ·c™y_
 = 
»que¡ed_ÿ·c™y
;

47  
	gŒue
;

49  
	gçl£
;

53 
boŞ
 
	gBufãr
::
»£rveBufãr
(
size_t
 
size
)

55 
ušt8_t
* 
Ãw_
 = 
wr™e_cur_
 + 
size
;

56 ià(
	gÃw_
 <ğ
_
)

57  
Œue
;

58 
size_t
 
	g»u£_size
 = 
»ad_cur_
 - 
h—d_
 + 
_
 - 
wr™e_cur_
;

59 if(
	g»u£_size
 >ğ
size
)

61 
size_t
 
rsz
 = 
g‘R—dabËSize
();

62 
memmove
(
h—d_
, 
»ad_cur_
, 
rsz
);

63 
	g»ad_cur_
 = 
h—d_
;

64 
	gwr™e_cur_
 = 
»ad_cur_
 + 
rsz
;

65  
	gŒue
;

67 ià(
	gÃw_
 <ğ
h—d_
 + 
ÿ·c™y_
)

69 
_
 = 
Ãw_
;

70  
	gŒue
;

72  
ex·ndBufãr
(
Ãw_
 - 
h—d_
);

75 
boŞ
 
	gBufãr
::
wr™eBufãr
(cÚ¡ * 
buf
, 
size_t
 
size
)

77 ià(
»£rveBufãr
(
size
))

79 
memıy
(
wr™e_cur_
, 
buf
, 
size
);

80 
	gwr™e_cur_
 +ğ
size
;

81  
	gŒue
;

83  
	gçl£
;

86 
boŞ
 
	gBufãr
::
»adBufãr
(* 
buf
, 
size_t
 
size
)

88 if(
	g»ad_cur_
 + 
	gsize
 > 
	g_
)

89  
	gçl£
;

90 
memıy
(
buf
, 
»ad_cur_
, 
size
);

91 
	g»ad_cur_
 +ğ
size
;

92  
	gŒue
;

95 
	g¡d
::
¡ršg
 
Bufãr
::
toSŒšg
() const

97 
size_t
 
size
 = 
g‘Wr™‹nSize
();

98 
	g¡d
::
¡ršg
 
s
 = "[Bufãr][" + 
¡d
::
to_¡ršg
(
g‘C­ac™y
()) + "]("

99 + 
¡d
::
to_¡ršg
(
size
) + ")\n";

100 
size_t
 
	gi
 = 0; i !ğ
size
; ++i)

102 
	gs
 +ğ"[" + 
¡d
::
to_¡ršg
(
¡©ic_ÿ¡
<
ušt8_t
>(
h—d_
[
i
])) + "]";

104  
	gs
;

	@kit/Buffer.h

1 #iâdeà
__KIT_BUFFER_H__


2 
	#__KIT_BUFFER_H__


	)

4 
	~"Ref.h
"

5 
	~"k™sys.h
"

6 
	~<¡ršg.h
>

7 
	~<¡ršg
>

8 
	~<veùÜ
>

12 
Çme¥aû
 
	gk™
 {

14 şas 
	cBufãr
 : 
public
 
Ref


16 
public
:

17 
KIT_CREATE_FUNC
(
Bufãr
);

19 
Bufãr
();

20 
	gvœtu®
 ~
Bufãr
();

22 
boŞ
 
š™
(
size_t
 
size
);

24 
»£t
();

25 
size_t
 
g‘Size
() const;

26 
£tSize
(
size_t
 
size
);

27 
size_t
 
g‘C­ac™y
() const;

28 
size_t
 
g‘Wr™‹nSize
() const;

29 
size_t
 
g‘Wr™abËSize
() const;

30 
size_t
 
g‘R—dSize
() const;

31 
size_t
 
g‘R—dabËSize
() const;

32 * 
wr™eCur
();

33 * 
»adCur
();

34 
skWr™e
(
size_t
 
size
);

35 
skR—d
(
size_t
 
size
);

37 
boŞ
 
»£rveBufãr
(
size_t
 
size
);

38 
boŞ
 
ex·ndBufãr
(
size_t
 
»quœe_size
);

39 
boŞ
 
wr™eBufãr
(cÚ¡ * 
buf
, 
size_t
 
size
);

40 
boŞ
 
»adBufãr
(* 
buf
, 
size_t
 
size
);

42 
	g‹m¶©e
<
ty³Çme
 
	gT
>

43 
boŞ
 
	gİ”©Ü
<<(
T
 
	gv
);

45 
	g‹m¶©e
<
ty³Çme
 
	gT
>

46 
boŞ
 
	gİ”©Ü
>>(
	gT
& 
	gv
);

48 
	g‹m¶©e
<
ty³Çme
 
	gT
>

49 
boŞ
 
wr™eVeùÜ
(cÚ¡ 
¡d
::
veùÜ
<
T
>& 
vec
);

50 
	g‹m¶©e
<
ty³Çme
 
	gT
>

51 
boŞ
 
»adVeùÜ
(
¡d
::
veùÜ
<
T
>& 
vec
);

54 
	g‹m¶©e
<
ty³Çme
 
	gT
>

55 
boŞ
 
wr™eV¬ušt
(
T
 
v®ue
);

56 
	g‹m¶©e
<
ty³Çme
 
	gT
>

57 
boŞ
 
wr™eV¬št
(
T
 
v®ue
);

58 
	g‹m¶©e
<
ty³Çme
 
	gT
>

59 
boŞ
 
»adV¬ušt
(
T
& 
v®ue
);

60 
	g‹m¶©e
<
ty³Çme
 
	gT
>

61 
boŞ
 
»adV¬št
(
T
& 
v®ue
);

63 
	g¡d
::
¡ršg
 
toSŒšg
() const;

64 
	g´Ùeùed
:

65 
size_t
 
ÿ·c™y_
;

66 
ušt8_t
* 
	gh—d_
;

67 
ušt8_t
* 
	g_
;

68 
ušt8_t
* 
	gwr™e_cur_
;

69 
ušt8_t
* 
	g»ad_cur_
;

75 
	~"im¶/BufãrIm¶.h
"

	@kit/BufferPool.cpp

1 
	~"BufãrPoŞ.h
"

3 
Çme¥aû
 
	gk™
 {

5 
	gBufãrPoŞ
::
BufãrPoŞ
()

9 
BufãrPoŞ
::~BufferPool()

11 
ş—r
();

14 
Bufãr
* 
	gBufãrPoŞ
::
ü—‹Bufãr
(
size_t
 
size
)

16 
šdex
 = 0;

17 
size_t
 
	gfix_size
 = 1;

18 
size_t
 
	gsize_tmp
 = 
size
;

19 
	gsize_tmp
 >>= 1)

21 ++
šdex
;

22 
	gfix_size
 <<= 1;

25 
Bufãr
* 
	gbuf
 = 
NULL
;

26 ià(
	gšdex
 < 
	gBUFFER_QUEUE_CNT
 || !
	gques_
[
šdex
].
pİ
(
buf
))

28 
	gbuf
 = 
Bufãr
::
ü—‹
(
çl£
);

29 
	gbuf
->
š™
(
fix_size
);

31 
	gbuf
->
»£t
();

33 
	gbuf
->
£tSize
(
size
);

35  
	gbuf
;

38 
	gBufãrPoŞ
::
de¡royBufãr
(
Bufãr
* 
bufãr
)

40 
size_t
 
size
 = 
bufãr
->
g‘C­ac™y
();

41 
	gšdex
 = 0;

42 
size_t
 
	gfix_size
 = 8;

43 
	gfix_size
 >ğ
size
)

45 ++
šdex
;

46 
	gfix_size
 <<= 1;

48 ià(
	gšdex
 < 
	gBUFFER_QUEUE_CNT
 || !
	gques_
[
šdex
].
push
(
bufãr
))

50 
	gbufãr
->
»Ëa£
();

54 
	gBufãrPoŞ
::
ş—r
()

56 
Bufãr
* 
p
 = 
NULL
;

57 
	gi
 = 0; i !ğ
BUFFER_QUEUE_CNT
; ++i)

59 
	gBufãrQue
& 
	gque
 = 
ques_
[
i
];

60 
	gque
.
pİ
(
p
))

62 
	gp
->
»Ëa£
();

71 
	gBufãrPoŞMªag”
::
BufãrPoŞMªag”
()

72 : 
poŞ_
(
NULL
)

73 , 
th»ad_poŞ_
(
NULL
)

77 
	gBufãrPoŞMªag”
::~
BufãrPoŞMªag”
()

79 
KIT_SAFE_RELEASE
(
poŞ_
)

80 
KIT_SAFE_RELEASE
(
th»ad_poŞ_
)

83 
boŞ
 
BufãrPoŞMªag”
::
ba£In™
()

85 
poŞ_
 = 
Ãw
 
BufãrPoŞ
();

86 
	gth»ad_poŞ_
 = 
Ãw
 
BufãrPoŞ
();

87  
	gŒue
;

	@kit/BufferPool.h

1 #iâdeà
__KIT_BUFFER_POOL_H__


2 
	#__KIT_BUFFER_POOL_H__


	)

7 
	~"Bufãr.h
"

8 
	~"Queue.h
"

9 
	~"SšgËtÚ.h
"

11 #iâdeà
BUFFER_POOL_SIZE


12 
	#BUFFER_POOL_SIZE
 (200)

	)

15 
Çme¥aû
 
	gk™
 {

17 cÚ¡ 
št32_t
 
	gBUFFER_QUEUE_CNT
 = 8;

19 şas 
	cBufãrPoŞ
 : 
public
 
Ref


21 
public
:

22 
BufãrPoŞ
();

23 
	gvœtu®
 ~
BufãrPoŞ
();

25 
Bufãr
* 
ü—‹Bufãr
(
size_t
 
size
);

26 
de¡royBufãr
(
Bufãr
* 
bufãr
);

28 
ş—r
();

29 
	g´iv©e
:

30 
Queue
<
	tBufãr
*, 
	tBUFFER_POOL_SIZE
> 
	tBufãrQue
;

31 
BufãrQue
 
	gques_
[
BUFFER_QUEUE_CNT
];

34 şas 
	cBufãrPoŞMªag”
 : 
public
 
Ref


36 
public
:

37 
BufãrPoŞMªag”
();

38 
	gvœtu®
 ~
BufãrPoŞMªag”
();

40 
vœtu®
 
boŞ
 
ba£In™
();

42 
BufãrPoŞ
* 
g‘PoŞ
(ècÚ¡ {  
	gpoŞ_
; }

43 
BufãrPoŞ
* 
g‘Th»adPoŞ
(ècÚ¡ {  
	gth»ad_poŞ_
; }

44 
	g´iv©e
:

45 
BufãrPoŞ
* 
poŞ_
;

46 
BufãrPoŞ
* 
	gth»ad_poŞ_
;

51 
	#g_BufPoŞMng
 (
k™
::
SšgËtÚ
<k™::
BufãrPoŞMªag”
>::
	`š¡ªû
())

	)

54 
	#g_BufPoŞ
 (
g_BufPoŞMng
->
	`g‘PoŞ
())

	)

57 
	#g_BufPoŞTh»ad
 (
g_BufPoŞMng
->
	`g‘Th»adPoŞ
())

	)

	@kit/Emitter.h

1 #iâdeà
__KIT_EMITTER_H__


2 
	#__KIT_EMITTER_H__


	)

10 
	~"Ref.h
"

11 
	~<veùÜ
>

12 
	~<funùiÚ®
>

14 #iâdeà
DEFAULT_EVNET_LENGTH


15 
	#DEFAULT_EVNET_LENGTH
 16

	)

18 
Çme¥aû
 
	gk™
 {

20 şas 
	cEv’t
 : 
public
 
Ref


22 
public
:

23 
ev’t_id
;

26 
	g‹m¶©e
<
	gEv’tL’gth
 = 16>

27 şas 
	cEm™‹r


29 
public
:

30 
	tHªdËrID
;

31 
	g¡d
::
	tfunùiÚ
<(cÚ¡ 
	tEv’t
*)> 
	tHªdËr
;

35 
HªdËrID
 
	gid
;

36 
HªdËr
 
	ghªdËr
;

37 
boŞ
 
	gÚû
;

38 
boŞ
 
	gd–‘ed
;

39 } 
	tHªdËrI‹m
;

41 
	gpublic
:

42 
Em™‹r
()

43 : 
id_
(0)

46 ~
Em™‹r
()

48 
ş—r
();

51 
HªdËrID
 
Ú
(
ev’t_id
, 
HªdËr
 
hªdËr
)

53 
	ghªdËr_vecs_
[
ev’t_id
].
push_back
({++
id_
, 
hªdËr
, 
çl£
, false});

54  
	gid_
;

57 
Úû
(
ev’t_id
, 
HªdËr
 
hªdËr
)

59 
	ghªdËr_vecs_
[
ev’t_id
].
push_back
({++
id_
, 
hªdËr
, 
Œue
, 
çl£
});

62 
off
(
ev’t_id
, 
HªdËrID
 
id
)

64 
	gHªdËrVec
& 
	gvec
 = 
hªdËr_vecs_
[
ev’t_id
];

65 
	gËn
 = 
vec
.
size
();

66 
	gi
 = 0; i !ğ
Ën
; ++i)

68 ià(
	gvec
[
i
].
	gid
 =ğ
id
)

70 
vec
[
i
].
d–‘ed
 = 
Œue
;

76 
em™
(
ev’t_id
, cÚ¡ 
Ev’t
* 
ev’t
)

78 
	gHªdËrVec
& 
	gvec
 = 
hªdËr_vecs_
[
ev’t_id
];

79 
	gËn
 = 
vec
.
size
();

80 
	g
 = 
Ën
;

82 
	gi
 = 0; i !ğ

;)

84 auto& 
	g™em
 = 
vec
[
i
];

85 ià(!
	g™em
.
	gd–‘ed
)

87 
	g™em
.
hªdËr
(
ev’t
);

88 ià(
	g™em
.
	gÚû
)

89 
	g™em
.
	gd–‘ed
 = 
Œue
;

91 ià(
	g™em
.
	gd–‘ed
)

92 
__sw­
(
vec
, 
i
, --

);

94 ++
	gi
;

96 ià(
	gËn
 =ğ
vec
.
size
())

98 
vec
.
»size
(

);

103 
ş—r
()

105 
	gi
 = 0; i !ğ
Ev’tL’gth
; ++i)

107 
	ghªdËr_vecs_
[
i
].
ş—r
();

110 
	g´iv©e
:

111 
¡d
::
	tveùÜ
<
	tHªdËrI‹m
> 
	tHªdËrVec
;

113 
__sw­
(
HªdËrVec
& 
vec
, 
Ÿ
, 
ib
)

115 cÚ¡ 
	gHªdËrI‹m
& 
	g‹mp
 = 
vec
[
Ÿ
];

116 
	gvec
[
Ÿ
] = 
vec
[
ib
];

117 
	gvec
[
ib
] = 
‹mp
;

120 
HªdËrID
 
	gid_
;

121 
HªdËrVec
 
	ghªdËr_vecs_
[
Ev’tL’gth
];

127 
	#EMITTER
(
¬gs
...) \

128 ’um { 
¬gs
, 
__EVENT_MAX__
, }; \

129 
k™
::
Em™‹r
<
__EVENT_MAX__
 < 
DEFAULT_EVNET_LENGTH
 ? DEFAULT_EVNET_LENGTH : __EVENT_MAX__> 
___em™‹r___
;

	)

132 
	#EMIT
(
__EVENT_TYPE__
, 
__EVENT__
) \

133 
___em™‹r___
.
	`em™
(
__EVENT_TYPE__
, 
__EVENT__
);

	)

136 
	#SENDER_EMIT
(
__SENDER__
, 
__EVENT_TYPE__
, 
__EVENT__
) \

137 
__SENDER__
.
___em™‹r___
.
	`em™
(
__EVENT_TYPE__
, 
__EVENT__
);

	)

140 
	#SLOT
(
__SENDER__
, 
__EVENT_TYPE__
, 
__HANDLER__
) \

141 
__SENDER__
.
___em™‹r___
.
	`Ú
(
__EVENT_TYPE__
, 
__HANDLER__
);

	)

143 
	#UNSLOT
(
__SENDER__
, 
__EVENT_TYPE__
, 
__HANDLER_ID__
) \

144 
__SENDER__
.
___em™‹r___
.
	`off
(
__EVENT_TYPE__
, 
__HANDLER_ID__
);

	)

146 
	#SLOT_ONCE
(
__SENDER__
, 
__EVENT_TYPE__
, 
__HANDLER__
) \

147 
__SENDER__
.
___em™‹r___
.
	`Úû
(
__EVENT_TYPE__
, 
__HANDLER__
);

	)

	@kit/Functions.cpp

1 
	~"FunùiÚs.h
"

2 
	~<¡d¬g.h
>

4 
Çme¥aû
 
	gk™
 {

6 
¥l™
(cÚ¡ 
¡d
::
¡ršg
& 
‹xt
, std::
veùÜ
<¡d::¡ršg>& 
vec
, 
£·¿tÜ
)

8 
	g¡d
::
¡ršg
::
size_ty³
 
pos
 = 0;

9 
	g¡d
::
¡ršg
::
size_ty³
 
ed
 = 0;

10 
	g¡d
::
¡ršg
::
size_ty³
 
Ëngth
 = 
‹xt
.length();

11 
	gpos
 < 
	gËngth
)

13 ià(
	g‹xt
[
pos
] =ğ
£·¿tÜ
)

15 ++
pos
;

18 
	ged
 = 
‹xt
.
fšd
(
£·¿tÜ
, 
pos
);

19 ià(
	ged
 =ğ
¡d
::
¡ršg
::
Åos
)

21 
	gvec
.
push_back
(
‹xt
.
sub¡r
(
pos
, 
ed
 -…os));

22 
	gpos
 = 
ed
 + 1;

24 ià(
	gpos
 < 
	gËngth
)

25 
	gvec
.
push_back
(
‹xt
.
sub¡r
(
pos
, 
Ëngth
 -…os));

28 
¥l™W™hSŒšg
(cÚ¡ 
¡d
::
¡ršg
& 
‹xt
, std::
veùÜ
<¡d::¡ršg>& 
vec
, cÚ¡ std::¡ršg& 
£·¿tÜ
)

30 
¡d
::
¡ršg
::
size_ty³
 
pos
 = 0;

31 
	g¡d
::
¡ršg
::
size_ty³
 
ed
 = 0;

32 
	g¡d
::
¡ršg
::
size_ty³
 
Ëngth
 = 
‹xt
.length();

33 
	g¡d
::
¡ršg
::
size_ty³
 
Ëngth_¥
 = 
£·¿tÜ
.
Ëngth
();

34 
	gpos
 < 
	gËngth
)

36 
	ged
 = 
‹xt
.
fšd
(
£·¿tÜ
, 
pos
);

37 ià(
	ged
 =ğ
¡d
::
¡ršg
::
Åos
)

39 ià(
	ged
 =ğ
pos
)

41 
pos
 +ğ
Ëngth_¥
;

44 
	gvec
.
push_back
(
‹xt
.
sub¡r
(
pos
, 
ed
 -…os));

45 
	gpos
 = 
ed
 + 1;

47 ià(
	gpos
 < 
	gËngth
)

48 
	gvec
.
push_back
(
‹xt
.
sub¡r
(
pos
, 
Ëngth
 -…os));

51 
	g¡d
::
¡ršg
 
fÜm©SŒšg
(cÚ¡ * 
fÜm©
, ...)

53 
	gbufãr
[1024];

54 
va_li¡
 
	g¬gs
;

55 
va_¡¬t
(
¬gs
, 
fÜm©
);

56 
v¢´štf
(
bufãr
, 1024, 
fÜm©
, 
¬gs
);

57 
va_’d
(
¬gs
);

58  
	g¡d
::
¡ršg
(
bufãr
);

	@kit/Functions.h

1 #iâdeà
__KIT_FUNCTIONS_H__


2 
	#__KIT_FUNCTIONS_H__


	)

4 
	~<veùÜ
>

5 
	~<¡ršg
>

7 
Çme¥aû
 
	gk™
 {

9 
¥l™
(cÚ¡ 
¡d
::
¡ršg
& 
‹xt
, std::
veùÜ
<¡d::¡ršg>& 
vec
, cÚ¡ 
£·¿tÜ
);

10 
¥l™W™hSŒšg
(cÚ¡ 
¡d
::
¡ršg
& 
‹xt
, std::
veùÜ
<¡d::¡ršg>& 
vec
, cÚ¡ std::¡ršg& 
£·¿tÜ
);

12 
	g¡d
::
¡ršg
 
fÜm©SŒšg
(cÚ¡ * 
fÜm©
, ...);

	@kit/Logger.cpp

1 
	~"Logg”.h
"

3 
Çme¥aû
 
	gk™
 {

5 
	gLogg”
::
Logg”
()

7 
­i_bË_
[
LOG_TYPE_LOG
] = &
Logg”
::
wr™eLog
<LOG_TYPE_LOG>;

8 
	g­i_bË_
[
LOG_TYPE_ERR
] = &
Logg”
::
wr™eLog
<LOG_TYPE_ERR>;

9 
	g­i_bË_
[
LOG_TYPE_DBG
] = &
Logg”
::
wr™eLog
<LOG_TYPE_DBG>;

10 
	g­i_bË_
[
LOG_TYPE_SQL
] = &
Logg”
::
wr™eLog
<LOG_TYPE_SQL>;

13 
	gLogg”
::~
Logg”
()

17 
boŞ
 
Logg”
::
ba£In™
()

19  
Œue
;

22 
	gLogg”
::
Logg”API
 
Logg”
::
g‘API
(
t
)

24 ià(
t
 >ğ0 && < ()
MAX_LOG_TYPE
)

25  
­i_bË_
[
t
];

27  &
	gLogg”
::
wr™eNÚe
;

30 
	gLogg”
::
£tAPI
(
t
, 
Logg”
::
Logg”API
 
­i
)

32 ià(
t
 >ğ0 && < ()
MAX_LOG_TYPE
)

33 
­i_bË_
[
t
] = 
­i
;

	@kit/Logger.h

1 #iâdeà
__KIT_LOGGER_H__


2 
	#__KIT_LOGGER_H__


	)

4 
	~"Ref.h
"

5 
	~<¡d¬g.h
>

6 
	~<¡dio.h
>

7 
	~<¡ršg.h
>

8 
	~"SšgËtÚ.h
"

10 
Çme¥aû
 
	gk™
 {

14 
	gLOG_TYPE_LOG
,

15 
	gLOG_TYPE_ERR
,

16 
	gLOG_TYPE_DBG
,

17 
	gLOG_TYPE_SQL
,

19 
	gMAX_LOG_TYPE
,

23 cÚ¡ 
	gMAX_LOG_BUFFER_LEN
 = 1024 * 16;

25 
	#g_Log
 (
k™
::
SšgËtÚ
<k™::
Logg”
>::
	`š¡ªû
())

	)

27 
	#LOG
 ( 
g_Log
->*Ğg_Log->
	`g‘API
Ğ
k™
::
LOG_TYPE_LOG
 ) ) )

	)

28 
	#DBG
 ( 
g_Log
->*Ğg_Log->
	`g‘API
Ğ
k™
::
LOG_TYPE_DBG
 ) ) )

	)

29 
	#ERR
 ( 
g_Log
->*Ğg_Log->
	`g‘API
Ğ
k™
::
LOG_TYPE_ERR
 ) ) )

	)

30 
	#SQL
 ( 
g_Log
->*Ğg_Log->
	`g‘API
Ğ
k™
::
LOG_TYPE_SQL
 ) ) )

	)

32 şas 
	cLogg”
 : 
public
 
Ref


34 
public
:

35 
Logg”
();

36 ~
Logg”
();

38 
vœtu®
 
boŞ
 
ba£In™
();

40 (
	gLogg”
::* 
	tLogg”API
)(cÚ¡ * 
	tfÜm©
, ...);

42 
Logg”API
 
g‘API
(
t
);

43 
£tAPI
(
t
, 
Logg”API
 
­i
);

45 
wr™eNÚe
(cÚ¡ * 
fÜm©
, ...) {};

47 
	g‹m¶©e
<
	gty³
>

48 
wr™eLog
(cÚ¡ * 
fÜm©
, ...)

50 cÚ¡ * 
	glog_¡r
[] = {"[LOG]", "[ERR]", "[DBG]", "[SQL]"};

51 
	gbufãr
[
MAX_LOG_BUFFER_LEN
];

52 cÚ¡ * 
	g´e¡r
 = 
log_¡r
[
ty³
];

53 
	gËn_´e
 = 
¡¾’
(
´e¡r
);

54 
¡ºıy
(
bufãr
, 
´e¡r
, 
Ën_´e
);

55 
va_li¡
 
	g¬gs
;

56 
va_¡¬t
(
¬gs
, 
fÜm©
);

57 
v¢´štf
(
bufãr
 + 
Ën_´e
, 
MAX_LOG_BUFFER_LEN
 -†’_´e, 
fÜm©
, 
¬gs
);

58 
	gËn_buf
 = 
¡¾’
(
bufãr
);

59 
	gbufãr
[
Ën_buf
] = '\n';

60 
	gbufãr
[
Ën_buf
 + 1] = 0;

61 
´štf
(
bufãr
);

62 
va_’d
(
¬gs
);

64 
	g´iv©e
:

66 
Logg”API
 
­i_bË_
[
MAX_LOG_TYPE
];

	@kit/Ref.cpp

1 
	~"Ref.h
"

2 
	~"RefPoŞ.h
"

3 
	~<as£¹.h
>

5 
Çme¥aû
 
	gk™
 {

7 
	gRef
::
Ref
()

8 : 
»ã»nû_couÁ_
(1)

9 , 
·»Á_
(
NULL
)

13 
	gRef
::~
Ref
()

15 
ş—rChd»n
();

18 
	gRef
::
»š
()

20 ++
»ã»nû_couÁ_
;

23 
	gRef
::
»Ëa£
()

25 
as£¹
(
»ã»nû_couÁ_
 > 0);

27 --
	g»ã»nû_couÁ_
;

28 ià(
	g»ã»nû_couÁ_
 == 0)

29 
d–‘e
 
this
;

32 
Ref
* 
	gRef
::
autoR–—£
()

34 
g_RefPoŞ
->
g‘Cu¼’tPoŞ
()->
addRef
(
this
);

35  
	gthis
;

38 
	gRef
::
upd©e
()

40 
út
 = ()
chd»n_
.
size
();

41 
	gi
 = 0; i !ğ
út
; ++i)

43 
	gchd»n_
[
i
]->
upd©e
();

47 
	gRef
::
addChd
(
Ref
* 
chd
)

49 ià(
chd»n_
.
em±y
())

51 
chd»n_
.
»£rve
(5);

53 
	gchd
->
»š
();

54 
	gchd
->
	g·»Á_
 = 
this
;

55 
	gchd»n_
.
push_back
(
chd
);

58 
	gRef
::
d–Chd
(
Ref
* 
chd
)

60 
RefVec
::
™”©Ü
 
ix
 = 
chd»n_
.
begš
(); 
	gix
 !ğchd»n_.
’d
(); ++ix)

62 ià((*
	gix
è=ğ
chd
)

64 
chd»n_
.
”a£
(
ix
);

65 
	gchd
->
	g·»Á_
 = 
NULL
;

66 
	gchd
->
»Ëa£
();

72 
	gRef
::
ş—rChd»n
()

74 
RefVec
::
™”©Ü
 
ix
 = 
chd»n_
.
begš
(); 
	gix
 !ğchd»n_.
’d
(); ++ix)

76 (*
	gix
)->
	g·»Á_
 = 
NULL
;

77 (*
	gix
)->
»Ëa£
();

79 
	gchd»n_
.
ş—r
();

82 
	gRef
::
»moveFromP¬’t
()

84 ià(
·»Á_
)

86 
·»Á_
->
d–Chd
(
this
);

	@kit/Ref.h

1 #iâdeà
__KIT_REF_H__


2 
	#__KIT_REF_H__


	)

4 
	~"k™sys.h
"

5 
	~<Ãw
>

6 
	~<veùÜ
>

7 
	~<¡ršg
>

9 
Çme¥aû
 
	gk™
 {

11 şas 
	cRef


13 
	g´Ùeùed
:

14 
Ref
();

15 
vœtu®
 
boŞ
 
ba£In™
(è{  
	gŒue
; }

17 
	g»ã»nû_couÁ_
;

18 
	gpublic
:

19 
vœtu®
 ~
Ref
();

21 
»š
();

22 
»Ëa£
();

24 
vœtu®
 
upd©e
();

26 
Ref
* 
autoR–—£
();

27 
g‘Reã»nûCouÁ
(ècÚ¡ {  
	g»ã»nû_couÁ_
; };

29 
addChd
(
Ref
* 
obj
);

30 
d–Chd
(
Ref
* 
obj
);

31 
ş—rChd»n
();

32 
vœtu®
 
»moveFromP¬’t
();

34 
vœtu®
 
	g¡d
::
¡ršg
 
toSŒšg
() const {  "----[Ref]----"; }

35 
	g´iv©e
:

36 
¡d
::
	tveùÜ
<
	tRef
*> 
	tRefVec
;

37 
RefVec
 
	gchd»n_
;

38 
Ref
* 
	g·»Á_
;

41 
	#KIT_SAFE_RELEASE
(
r
) \

42 ià(
r
) \

44 
r
->
	`»Ëa£
(); \

45 
r
 = 0; \

46 }

	)

48 
	#KIT_SAFE_RETAIN
(
r
) \

49 ià(
r
) \

51 
r
->
	`»š
(); \

52 }

	)

54 
	#KIT_CREATE_FUNC
(
__TYPE__
) \

55 
__TYPE__
* 
	`ü—‹
(
boŞ
 
špoŞ
 = 
Œue
) \

57 
__TYPE__
* 
»t
 = 
	`Ãw
(
¡d
::
nÙhrow
è
	`__TYPE__
(); \

58 ià(
»t
 &&„‘->
	`ba£In™
()) \

60 ià(
špoŞ
) \

61 
»t
->
	`autoR–—£
(); \

62  
»t
; \

64 
	`KIT_SAFE_RELEASE
(
»t
) \

65  
»t
; \

66 }

	)

	@kit/RefPool.cpp

1 
	~"RefPoŞ.h
"

2 
	~"Ref.h
"

4 
Çme¥aû
 
	gk™
 {

10 
	gRefPoŞ
::
RefPoŞ
()

12 
»f_vec_
.
»£rve
(150);

15 
	gRefPoŞ
::~
RefPoŞ
()

17 
ş—r
();

20 
	gRefPoŞ
::
addRef
(
Ref
* 
»f
)

22 
»f_vec_
.
push_back
(
»f
);

26 
	gRefPoŞ
::
d–Ref
(
Ref
* 
»f
)

28 
RefVec
::
™”©Ü
 
ix
 = 
»f_vec_
.
begš
(); 
	gix
 !ğ»f_vec_.
’d
(); ++ix)

30 ià((*
	gix
è=ğ
»f
)

32 
»f_vec_
.
”a£
(
ix
);

38 
	gRefPoŞ
::
ş—r
()

40 
RefVec
 
vec
;

41 
	gvec
.
sw­
(
»f_vec_
);

42 
	gRefVec
::
™”©Ü
 
ix
 = 
vec
.
begš
(); 
	gix
 !ğvec.
’d
(); ++ix)

44 (*
	gix
)->
»Ëa£
();

52 
	gRefPoŞMªag”
::
RefPoŞMªag”
()

53 : 
cur_poŞ_
(0)

55 
poŞ_vec_
.
»£rve
(10);

58 
	gRefPoŞMªag”
::~
RefPoŞMªag”
()

60 !
poŞ_vec_
.
em±y
())

62 
pİ
();

66 
boŞ
 
	gRefPoŞMªag”
::
ba£In™
()

68 
push
(
Ãw
 
RefPoŞ
());

69  
	gŒue
;

72 
	gRefPoŞMªag”
::
push
(
RefPoŞ
* 
poŞ
)

74 
cur_poŞ_
 = 
poŞ
;

75 
	gpoŞ_vec_
.
push_back
(
poŞ
);

78 
	gRefPoŞMªag”
::
pİ
()

80 ià(
poŞ_vec_
.
em±y
())

83 
	gpoŞ_vec_
.
pİ_back
();

84 
d–‘e
 
	gcur_poŞ_
;

85 ià(
	gpoŞ_vec_
.
em±y
())

86 
	gcur_poŞ_
 = 0;

88 
	gcur_poŞ_
 = 
poŞ_vec_
.
back
();

	@kit/RefPool.h

1 #iâdeà
__KIT_REF_POLL_H__


2 
	#__KIT_REF_POLL_H__


	)

11 
	~"Ref.h
"

12 
	~<veùÜ
>

13 
	~"SšgËtÚ.h
"

15 
Çme¥aû
 
	gk™
 {

17 
şass
 
	gRef
;

19 şas 
	cRefPoŞ
 : 
public
 
Ref


21 
public
:

22 
RefPoŞ
();

23 
	gvœtu®
 ~
RefPoŞ
();

25 
addRef
(
Ref
* 
»f
);

26 
d–Ref
(
Ref
* 
»f
);

27 
ş—r
();

28 
	g´iv©e
:

29 
¡d
::
	tveùÜ
<
	tRef
*> 
	tRefVec
;

30 
RefVec
 
	g»f_vec_
;

33 şas 
	cRefPoŞMªag”
 : 
public
 
Ref


35 
public
:

36 
RefPoŞMªag”
();

37 
	gvœtu®
 ~
RefPoŞMªag”
();

39 
vœtu®
 
boŞ
 
ba£In™
();

41 
RefPoŞ
* 
g‘Cu¼’tPoŞ
(ècÚ¡ {  
	gcur_poŞ_
; }

42 
push
(
RefPoŞ
* 
poŞ
);

43 
pİ
();

44 
	g´iv©e
:

45 
RefPoŞ
* 
cur_poŞ_
;

47 
	g¡d
::
	tveùÜ
<
	tRefPoŞ
*> 
	tPoŞVec
;

48 
PoŞVec
 
	gpoŞ_vec_
;

52 
	#g_RefPoŞ
 (
k™
::
SšgËtÚ
<k™::
RefPoŞMªag”
>::
	`š¡ªû
())

	)

	@kit/Thread.cpp

1 
	~"Th»ad.h
"

3 
Çme¥aû
 
	gk™
 {

5 
	gAutoLock
::
AutoLock
(
IMu‹x
* 
mu‹x
)

6 : 
mu‹x_
(
mu‹x
)

8 
mu‹x
->
lock
();

11 
	gAutoLock
::~
AutoLock
()

13 
mu‹x_
->
uÆock
();

18 
	gITh»ad
::
ITh»ad
()

19 : 
aùive_
(
çl£
)

20 , 
mu‹x_
(
NULL
)

21 , 
hªdËr_
(
NULL
)

25 
	gITh»ad
::~
ITh»ad
()

27 
mu‹x_
->
lock
();

28 ià(
	gaùive_
)

29 
¡İ
();

30 
	gmu‹x_
->
uÆock
();

32 
	gmu‹x_
->
»Ëa£
();

35 
boŞ
 
	gITh»ad
::
ba£In™
()

37 
mu‹x_
 = 
Mu‹x
::
ü—‹
(
çl£
);

38  
	gŒue
;

41 
	gITh»ad
::
š™
(
Th»adHªdËr
* 
hªdËr
)

43 
£tHªdËr
(
hªdËr
);

46 
	gITh»ad
::
£tHªdËr
(
Th»adHªdËr
* 
hªdËr
)

48 
hªdËr_
 = 
hªdËr
;

51 
	gITh»ad
::
run
()

53 ià(
hªdËr_
)

54 
hªdËr_
->
hªdËTh»ad
();

57 
	gITh»ad
::
¡İ
()

59 
mu‹x_
->
lock
();

60 ià(
	gaùive_
)

62 
	gaùive_
 = 
çl£
;

63 
	gmu‹x_
->
uÆock
();

64 
	gthis
->
još
();

67 
	gmu‹x_
->
uÆock
();

	@kit/Thread.h

1 #iâdeà
__KIT_THREAD_H__


2 
	#__KIT_THREAD_H__


	)

4 
	~"k™sys.h
"

5 
	~"Ref.h
"

7 
Çme¥aû
 
	gk™
 {

10 şas 
	cIMu‹x
 : 
public
 
Ref


12 
public
:

13 
IMu‹x
() {}

14 
vœtu®
 ~
IMu‹x
() {}

16 
vœtu®
 
št32_t
 
lock
() = 0;

17 
vœtu®
 
št32_t
 
uÆock
() = 0;

18 
vœtu®
 
št32_t
 
ŒyLock
() = 0;

21 şas 
	cAutoLock


23 
	gpublic
:

24 
AutoLock
(
IMu‹x
* 
mu‹x
);

25 ~
AutoLock
();

26 
	g´Ùeùed
:

27 
IMu‹x
* 
mu‹x_
;

33 
	sTh»adHªdËr


35 
vœtu®
 
hªdËTh»ad
() = 0;

38 şas 
	cITh»ad
 : 
public
 
Ref


40 
public
:

41 
ITh»ad
();

42 
	gvœtu®
 ~
ITh»ad
();

44 
vœtu®
 
boŞ
 
ba£In™
();

45 
vœtu®
 
š™
(
Th»adHªdËr
* 
hªdËr
);

46 
vœtu®
 
£tHªdËr
(
Th»adHªdËr
* 
hªdËr
);

49 
vœtu®
 
još
() = 0;

50 
vœtu®
 
št32_t
 
¡¬t
() = 0;

52 
vœtu®
 
¡İ
();

53 
vœtu®
 
run
();

54 
	g´Ùeùed
:

55 
boŞ
 
aùive_
;

56 
IMu‹x
* 
	gmu‹x_
;

57 
Th»adHªdËr
* 
	ghªdËr_
;

63 #ifdeà
PLATFORM_LINUX


64 
	~"¶©fÜm/lšux/Th»ad_lšux.h
"

65 #–ià
defšed
 
PLATFORM_WINDOWS


66 
	~"¶©fÜm/wš/Th»ad_wš.h
"

	@kit/Timer.cpp

1 
	~"Tim”.h
"

2 
	~<memÜy.h
>

3 
	~<¡dio.h
>

5 
Çme¥aû
 
	gk™
 {

7 
	gTim”
::
Wh“l
::Wheel()

9 
mem£t
(
nodes
, 0, (
Node
*));

12 
	gTim”
::
Wh“l
::~Wheel()

14 
Node
* 
p
;

15 
Node
* 
	gÅ
;

16 
	gi
 = 0; i != 512; ++i)

18 
	gp
 = 
nodes
[
i
];

19 
	gp
)

21 
	gÅ
 = 
p
->
Ãxt
;

22 
d–‘e
 
	gp
;

23 
	gp
 = 
Å
;

28 
	gTim”
::
Tim”
()

29 : 
id_
(0)

33 
Tim”
::~Timer()

37 
Tim”
::
upd©e
()

39 
wh“lšg
(0);

42 
ušt32_t
 
	gTim”
::
addTim”
(ušt32_ˆ
d–ay
, 
Tim”HªdËr
 
hªdËr
, ušt32_ˆ
cyşe
)

44 
Node
* 
	gnode
 = 
Ãw
 Node(++
id_
, 
d–ay
, 
cyşe
);

45 
addNode
(3, 
node
);

47 
	ghªdËr_m­_
.
£t
(
id_
, 
hªdËr
);

48  
	gid_
;

51 
	gTim”
::
d–Tim”
(
ušt32_t
 
id
)

53 
hªdËr_m­_
.
d–
(
id
);

56 
	gTim”
::
wh“lšg
(
ušt8_t
 
šdex
)

58 
Wh“l
& 
wh“l
 = 
wh“ls_
[
šdex
];

59 ++
	gwh“l
.
	gpos
;

61 
Node
* 
	gÅ
;

62 
boŞ
 
	g»t
;

63 
Node
* 
	gp
 = 
wh“l
.
nodes
[wh“l.
pos
];

64 
	gp
)

66 
	gÅ
 = 
p
->
Ãxt
;

67 ià(!
addNode
(
šdex
 - 1, 
p
))

69 
	g»t
 = 
hªdËTim”
(
p
->
id
);

70 ià(!
	g»t
 && 
	gp
->
	gcyşe
 > 0)

72 
	gp
->
	gd–ay
 = 
p
->
cyşe
;

73 
addNode
(3, 
p
);

76 
	gp
 = 
Å
;

78 
	gwh“l
.
	gnodes
[
wh“l
.
pos
] = 
NULL
;

81 ià(
	gwh“l
.
	gpos
 =ğ0 && 
šdex
 < 3)

83 
wh“lšg
(
šdex
 + 1);

87 
boŞ
 
	gTim”
::
addNode
(
ušt8_t
 
šdex
, 
Node
* 
node
)

89 ià(
	gšdex
 > 3)

90  
	gçl£
;

91 
	gWh“l
& 
	gwh“l
 = 
wh“ls_
[
šdex
];

92 
ušt8_t
 
	gpos
 = 
node
->
b™s
[
šdex
];

93 ià(
	gpos
 > 0)

95 
	gpos
 = 
wh“l
.
pos
 +…os;

96 
	gnode
->
	gÃxt
 = 
wh“l
.
nodes
[
pos
];

97 
	gwh“l
.
	gnodes
[
pos
] = 
node
;

98  
	gŒue
;

101  
addNode
(
šdex
 - 1, 
node
);

104 
boŞ
 
	gTim”
::
hªdËTim”
(
ušt32_t
 
id
)

106 
Tim”HªdËr
 
hªdËr
;

107 ià(
	ghªdËr_m­_
.
g‘
(
id
, 
hªdËr
))

109  
hªdËr
(
id
);

111  
	gŒue
;

	@kit/Timer.h

1 #iâdeà
__KIT_TIMER_H__


2 
	#__KIT_TIMER_H__


	)

4 
	~"k™sys.h
"

5 
	~"Ref.h
"

6 
	~"M­.h
"

7 
	~<funùiÚ®
>

9 #iâdeà
TIMER_MAP_SIZE


10 
	#TIMER_MAP_SIZE
 (512)

	)

13 
Çme¥aû
 
	gk™
 {

15 
	g¡d
::
	tfunùiÚ
<
	tboŞ
(
	tušt32_t
)> 
	tTim”HªdËr
;

17 şas 
	cTim”
 : 
public
 
Ref


19 
	sNode


21 
Node
(
ušt32_t
 
_id
, ušt32_ˆ
_d–ay
, ušt32_ˆ
_cyşe
 = 0)

22 : 
id
(
_id
)

23 , 
d–ay
(
_d–ay
)

24 , 
cyşe
(
_cyşe
)

25 , 
Ãxt
(
NULL
)

29 
ušt32_t
 
	gid
;

31 
ušt32_t
 
	gd–ay
;

32 
ušt8_t
 
	gb™s
[4];

34 
ušt32_t
 
	gcyşe
;

36 
Node
* 
	gÃxt
;

39 
	sWh“l


41 
Wh“l
();

42 ~
Wh“l
();

43 
ušt8_t
 
	gpos
;

44 
Node
* 
	gnodes
[512];

47 
	gpublic
:

48 
KIT_CREATE_FUNC
(
Tim”
)

49 
Tim”
();

50 
	gvœtu®
 ~
Tim”
();

53 
ušt32_t
 
addTim”
(ušt32_ˆ
d–ay
, 
Tim”HªdËr
 
hªdËr
, ušt32_ˆ
cyşe
 = 0);

54 
d–Tim”
(
ušt32_t
 
id
);

56 
upd©e
();

58 
	g´iv©e
:

60 
wh“lšg
(
ušt8_t
 
šdex
 = 0);

63 
boŞ
 
hªdËTim”
(
ušt32_t
 
id
);

64 
boŞ
 
addNode
(
ušt8_t
 
šdex
, 
Node
* 
node
);

65 
	g´iv©e
:

66 
ušt32_t
 
id_
;

67 
Wh“l
 
	gwh“ls_
[4];

68 
	gM­
<
	gušt32_t
, 
	gTim”HªdËr
, 
	gTIMER_MAP_SIZE
> 
	ghªdËr_m­_
;

	@kit/impl/BufferImpl.h

1 
Çme¥aû
 
	gk™
 {

3 
šlše
 
	gBufãr
::
»£t
()

5 
wr™e_cur_
 = 
h—d_
;

6 
	g»ad_cur_
 = 
h—d_
;

9 
šlše
 
size_t
 
	gBufãr
::
g‘Size
() const

11  
¡©ic_ÿ¡
<
size_t
>(
_
 - 
h—d_
);

14 
šlše
 
	gBufãr
::
£tSize
(
size_t
 
size
)

16 
_
 = 
h—d_
 + 
size
;

19 
šlše
 
size_t
 
	gBufãr
::
g‘C­ac™y
() const

21  
ÿ·c™y_
;

24 
šlše
 
size_t
 
	gBufãr
::
g‘Wr™‹nSize
() const

26  
¡©ic_ÿ¡
<
size_t
>(
wr™e_cur_
 - 
h—d_
);

29 
šlše
 
size_t
 
	gBufãr
::
g‘Wr™abËSize
() const

31  
¡©ic_ÿ¡
<
size_t
>(
_
 - 
wr™e_cur_
);

34 
šlše
 
size_t
 
	gBufãr
::
g‘R—dSize
() const

36  
¡©ic_ÿ¡
<
size_t
>(
»ad_cur_
 - 
h—d_
);

39 
šlše
 
size_t
 
	gBufãr
::
g‘R—dabËSize
() const

41  
¡©ic_ÿ¡
<
size_t
>(
wr™e_cur_
 - 
»ad_cur_
);

44 
šlše
 * 
	gBufãr
::
wr™eCur
()

46  
»š‹½»t_ÿ¡
<*>(
wr™e_cur_
);

49 
šlše
 * 
	gBufãr
::
»adCur
()

51  
»š‹½»t_ÿ¡
<*>(
»ad_cur_
);

54 
šlše
 
	gBufãr
::
skWr™e
(
size_t
 
size
)

56 
wr™e_cur_
 +ğ
size
;

59 
šlše
 
	gBufãr
::
skR—d
(
size_t
 
size
)

61 
»ad_cur_
 +ğ
size
;

64 
	g‹m¶©e
<
ty³Çme
 
	gT
>

65 
šlše
 
boŞ
 
	gBufãr
::
İ”©Ü
<<(
T
 
v
)

68  
wr™eBufãr
(&
v
, (
T
));

71 
	g‹m¶©e
<>

72 
šlše
 
boŞ
 
	gBufãr
::
İ”©Ü
<< <cÚ¡ *>(cÚ¡ * 
v
)

74 
size_t
 
size
 = 
¡¾’
(
v
);

75 
	gwr™eV¬ušt
<
	gsize_t
>(
	gsize
);

76  
wr™eBufãr
(
v
, (
size_t
)
size
);

79 
	g‹m¶©e
<
ty³Çme
 
	gT
>

80 
šlše
 
boŞ
 
	gBufãr
::
İ”©Ü
>>(
T
& 
v
)

82 
buf
[(
T
)];

83 if(
»adBufãr
(
buf
, (
T
)))

85 
	gv
 = *((
T
*)
buf
);

86  
	gŒue
;

89  
	gçl£
;

92 
	g‹m¶©e
<>

93 
šlše
 
boŞ
 
	gBufãr
::
İ”©Ü
>> <*>(*& 
v
)

95 * 
buf
 = 
v
;

96 
size_t
 
	gsize
;

97 
	g»adV¬ušt
<
	gsize_t
>(
	gsize
);

98  
»adBufãr
(
buf
, 
size
);

101 
	g‹m¶©e
<>

102 
šlše
 
boŞ
 
	gBufãr
::
İ”©Ü
>> <
¡d
::
¡ršg
>(¡d::¡ršg& 
v
)

104 
ušt16_t
 
size
;

105 (*
	gthis
è>> 
	gsize
;

106 ià(
	gsize
 < 512)

108 
	gbuf
[512];

109 ià(!
»adBufãr
(
buf
, 
size
))

110  
	gçl£
;

111 
	gbuf
[
size
] = 0;

112 
	gv
 = 
buf
;

116 * 
	gbuf
 = 
Ãw
 [
size
 + 1];

117 ià(!
»adBufãr
(
buf
, 
size
))

118  
	gçl£
;

119 
	gbuf
[
size
] = 0;

120 
	gv
 = 
buf
;

121 
	gd–‘e
 [] 
	gbuf
;

123  
	gŒue
;

126 
	g‹m¶©e
<
ty³Çme
 
	gT
>

127 
šlše
 
boŞ
 
	gBufãr
::
wr™eVeùÜ
(cÚ¡ 
¡d
::
veùÜ
<
T
>& 
vec
)

129 
size_t
 
size
 = 
vec
.size();

130 ià(!
	gwr™eV¬ušt
<
	gsize_t
>(
	gsize
))

131  
	gçl£
;

132 
size_t
 
	gi
 = 0; i !ğ
size
; ++i)

134 ià(!((*
	gthis
è<< 
	gvec
[
i
]))

135  
	gçl£
;

137  
	gŒue
;

140 
	g‹m¶©e
<
ty³Çme
 
	gT
>

141 
šlše
 
boŞ
 
	gBufãr
::
»adVeùÜ
(
¡d
::
veùÜ
<
T
>& 
vec
)

143 
size_t
 
size
 = 0;

144 ià(!
	g»adV¬ušt
<
	gsize_t
>(
	gsize
))

145  
	gçl£
;

146 
	gvec
.
»size
(
size
);

147 
size_t
 
	gi
 = 0; i !ğ
size
; ++i)

149 ià(!((*
	gthis
è>> 
	gvec
[
i
]))

150  
	gçl£
;

152  
	gŒue
;

156 
	g‹m¶©e
<
ty³Çme
 
	gT
>

157 
šlše
 
boŞ
 
	gBufãr
::
wr™eV¬ušt
(
T
 
v®ue
)

159 
¡©ic_as£¹
(
¡d
::
is_š‹g¿l
<
T
>::
v®ue
 && std::
is_unsigÃd
<T>::value,

161 
ušt8_t
 
	g¡ack_buf
[(
T
) * 8 / 7 + 1];

162 
ušt8_t
* 
	gÃxt_by‹
 = &
¡ack_buf
[0];

165 *
	gÃxt_by‹
 = (
v®ue
 & 0x7f) | 0x80;

166 
	gÃxt_by‹
++;

167 
	gv®ue
 >>= 7;

168 } 
	gv®ue
);

169 *(
	gÃxt_by‹
 - 1) &= 0x7f;

170  
wr™eBufãr
(
¡ack_buf
, 
Ãxt_by‹
 - stack_buf);

173 
	g‹m¶©e
<
ty³Çme
 
	gT
>

174 
šlše
 
boŞ
 
	gBufãr
::
wr™eV¬št
(
T
 
v®ue
)

176 
¡©ic_as£¹
(
¡d
::
is_š‹g¿l
<
T
>::
v®ue
 && std::
is_sigÃd
<T>::value,

178 
usšg
 
	gUnsigÃdT
 = 
ty³Çme
 
¡d
::
make_unsigÃd
<
T
>::
ty³
;

179  
wr™eV¬ušt
((
¡©ic_ÿ¡
<
UnsigÃdT
>(
v®ue
è<< 1è^ (v®u>> (8 * (
T
) - 1)));

182 
	g‹m¶©e
<
ty³Çme
 
	gT
>

183 
šlše
 
boŞ
 
	gBufãr
::
»adV¬ušt
(
T
& 
v®ue
)

185 
¡©ic_as£¹
(
¡d
::
is_š‹g¿l
<
T
>::
v®ue
 && std::
is_unsigÃd
<T>::value,

187 
T
 
	gv®
 = 0;

188 
	gshiá
 = 0;

189 
boŞ
 
	ghas_ªÙh”_by‹
;

192 ià(
	g»ad_cur_
 >ğ
_
)

193  
çl£
;

194 
ušt8_t
 
	gby‹
 = *
»ad_cur_
;

195 ià(
	gshiá
 < (
	gT
) * 8)

197 
	gv®ue
 |ğ
¡©ic_ÿ¡
<
T
>(
by‹
 & 0x7fè<< 
shiá
;

198 
	gshiá
 += 7;

200 
	ghas_ªÙh”_by‹
 = 
by‹
 & 0x80;

201 
	g»ad_cur_
++;

202 } 
	ghas_ªÙh”_by‹
);

203 
	gv®ue
 = 
v®
;

204  
	gŒue
;

208 
	g‹m¶©e
<
ty³Çme
 
	gT
>

209 
šlše
 
boŞ
 
	gBufãr
::
»adV¬št
(
T
& 
v®ue
)

211 
¡©ic_as£¹
(
¡d
::
is_š‹g¿l
<
T
>::
v®ue
 && std::
is_sigÃd
<T>::value,

213 
usšg
 
	gUnsigÃdT
 = 
ty³Çme
 
¡d
::
make_unsigÃd
<
T
>::
ty³
;

214 
UnsigÃdT
 
	gunsigÃd_v®ue
;

215 ià(!
	g»adV¬ušt
<
	gUnsigÃdT
>(
	gunsigÃd_v®ue
))

216  
	gçl£
;

217 
	gv®ue
 = 
¡©ic_ÿ¡
<
T
>((
unsigÃd_v®ue
 >> 1) ^ -static_cast<T>(unsigned_value & 1));

218  
	gŒue
;

	@kit/kit.h

1 #iâdeà
__KIT_H__


2 
	#__KIT_H__


	)

4 
	~"Ref.h
"

5 
	~"RefPoŞ.h
"

6 
	~"Bufãr.h
"

7 
	~"BufãrPoŞ.h
"

8 
	~"Logg”.h
"

	@kit/kitsys.cpp

1 
	~"k™sys.h
"

2 
	~<¡dio.h
>

3 #ifdeà
PLATFORM_WINDOWS


4 
	~<wšdows.h
>

7 #ifdeà
PLATFORM_LINUX


8 
	~<uni¡d.h
>

9 
	~<sys/time.h
>

10 #ifdeà
LINUX_TIME_HIGH_PRECISION


11 
	~<fú.h
>

12 
	~<¡ršg.h
>

13 
	~<¡dlib.h
>

17 
Çme¥aû
 
	gk™
 {

20 
¦“p
(
ušt32_t
 
m£c
)

22 #ifdeà
PLATFORM_LINUX


23 
u¦“p
((
m£c
 << 10) - (msec << 4) - (msec << 3));

24 #–ià
defšed
 
PLATFORM_WINDOWS


25 
SË•
(
m£c
);

29 #ià(
defšed
 
PLATFORM_LINUX
è&& 
LINUX_TIME_HIGH_PRECISION


32 
šlše
 
ušt64_t
 
tick
()

34 
ušt32_t
 
	g___L
, 
	g___H
;

35 
__asm__
 
__vŞ©e__
("rdtsc" : "÷" ( 
___L
), "=d" ( 
___H
) );

36  ((
	gušt64_t
)
	g___H
è<< 32 | 
	g___L
;

39 
št64_t
 
g‘_num_äom_sysfe
ĞcÚ¡ * 
_Çme
, cÚ¡ * 
_h—d
 )

41 ifĞ!
	g_Çme
 || ! 
	g_h—d
 )  -1;

42 
	gbuff
[4096] = {0,};

43 
št32_t
 
	gfd
 = 
İ’
Ğ
_Çme
, 
O_RDONLY
 );

44 ifĞ
	gfd
 > 0 ) {

45 
št32_t
 
	gËn
 = 
»ad
Ğ
fd
, 
buff
, (buff)-1 );

46 
şo£
(
fd
);

47 
	gbuff
[
Ën
-1] = '\0';

48 * 
	gp
 = 
¡r¡r
Ğ
buff
, 
_h—d
);

49 ifĞ
	gp
 ) {

50 
št32_t
 
	gj
 = 0;

51 
št32_t
 
	gk
 = 0;

52 
	gnum
[11] = {0,};

53 
boŞ
 
	g¡¬t
 = 
çl£
;

54  
	gj
 = 0; j < 50; ++j ) {

55 ifĞ
	gp
[
j
] >ğ'0' && 
p
[j] <= '9' ) {

56 
num
[
k
++] = 
p
[
j
];

57 
	g¡¬t
 = 
Œue
;

58 ifĞ
	gk
 >= 11 ) ;

60 ifĞ
	g¡¬t
 =ğ
Œue
 ) { ; }

63  (
	gšt64_t
)
©Şl
(
num
);

69 
ušt64_t
 
g‘_ıu_tick
()

71 
	g·th
[64]={0,};

72 
¢´štf
Ğ
·th
, (path), "/proc/cpuinfo" );

73 
št64_t
 
	gtick
 = 
g‘_num_äom_sysfe
Ğ
·th
, "cpu MHz" );

74 
ušt64_t
 
	g»s
 = 0;

75 ifĞ
	gtick
 <= 0 ){

76 
»s
 = 1995*1000000;

78 
	g»s
 = (
ušt64_t
)
tick
*1000000;

80 
´štf
("ıu hz:%Îd\n", 
»s
);

81  
	g»s
;

85 
ušt32_t
 
time
()

87 #ifdeà
PLATFORM_LINUX


88 #ià
LINUX_TIME_HIGH_PRECISION


89 
št64_t
 
	gäeq
;

90 ià(
	gäeq
 == 0)

91 
äeq
 = 
g‘_ıu_tick
();

92  
ušt32_t
(
tick
(è* 1000 / 
äeq
);

94 
boŞ
 
	ghas_š™
 = 
çl£
;

95 
timev®
 
	gbegš_time
;

96 
timezÚe
 
	gtz
={0, 0};

97 ià(!
	ghas_š™
)

99 
g‘timeofday
(&
begš_time
, &
tz
);

100 
	ghas_š™
 = 
Œue
;

102 
timev®
 
	gtime
;

103 
g‘timeofday
(&
time
, &
tz
);

104  
ušt32_t
((
time
.
tv_£c
 - 
begš_time
.tv_£cè* 1000.0 +ime.
tv_u£c
 / 1000.0);

106 #–ià
defšed
 
PLATFORM_WINDOWS


107 
boŞ
 
	ghas_š™
 = 
çl£
;

108 
boŞ
 
	gu£_high_»sŞutiÚ
 = 
Œue
;

109 
št64_t
 
	gäeq
;

110 
LARGE_INTEGER
 
	gbegš_time
;

112 ià(!
	ghas_š™
)

114 
LARGE_INTEGER
 
	gv®ue
;

115 ià(
Qu”yP”fÜmªûF»qu’cy
(&
v®ue
) == 0)

117 
u£_high_»sŞutiÚ
 = 
çl£
;

121 
	gäeq
 = 
št64_t
(
v®ue
.
QuadP¬t
 / 1000);

122 
Qu”yP”fÜmªûCouÁ”
(&
begš_time
);

124 
	ghas_š™
 = 
Œue
;

127 ià(!
	gu£_high_»sŞutiÚ
)

129  
G‘TickCouÁ
();

132 
LARGE_INTEGER
 
	gnow
;

133 
Qu”yP”fÜmªûCouÁ”
(&
now
);

134  
ušt32_t
(
now
.
QuadP¬t
 - 
begš_time
.QuadP¬tè/ 
	gäeq
;

	@kit/kitsys.h

1 #iâdeà
__KIT_SYS_H__


2 
	#__KIT_SYS_H__


	)

5 
	#LINUX_TIME_HIGH_PRECISION
 0

	)

12 
	~<¡dšt.h
>

14 #ifdeà
PLATFORM_LINUX


17 #ifdeà
PLATFORM_WINDOWS


18 
	~<šŒš.h
>

22 #iâdeà
NULL


23 
	#NULL
 0

	)

26 #ifdeà
KIT_DEBUG_MODE


28 
	#DPART
(
g¿m
è
	)
gram

30 
	#DCHECK
(
g¿m
, 
msg
) \

31 ià(!(
g¿m
)) { \

32 
	`³¼Ü
(
msg
); \

33 }

	)

37 
	#DPART
(
g¿m
)

	)

39 
	#DCHECK
(
g¿m
, 
msg
)

	)

43 
Çme¥aû
 
	gk™
 {

46 
¦“p
(
ušt32_t
 
m£c
);

49 
ušt32_t
 
time
();

	@kit/platform/linux/Thread_linux.cpp

1 
	~"Th»ad_lšux.h
"

3 
Çme¥aû
 
	gk™
 {

6 
	gMu‹x
::
Mu‹x
()

10 
boŞ
 
Mu‹x
::
ba£In™
()

13 
±h»ad_mu‹x©Œ_t
 
ma
;

14 
±h»ad_mu‹x©Œ_š™
Ğ&
ma
 );

15 
±h»ad_mu‹x©Œ_£‰y³
Ğ&
ma
, 
PTHREAD_MUTEX_RECURSIVE
 );

16 
±h»ad_mu‹x_š™
(&
mu‹x_
, &
ma
);

17 
±h»ad_mu‹x©Œ_de¡roy
Ğ&
ma
 );

18  
	gŒue
;

21 
	gMu‹x
::~
Mu‹x
()

23 
±h»ad_mu‹x_de¡roy
(&
mu‹x_
);

26 
št32_t
 
	gMu‹x
::
lock
()

28  
±h»ad_mu‹x_lock
(&
mu‹x_
);

31 
št32_t
 
	gMu‹x
::
uÆock
()

33  
±h»ad_mu‹x_uÆock
(&
mu‹x_
);

36 
št32_t
 
	gMu‹x
::
ŒyLock
()

38  
±h»ad_mu‹x_Œylock
(&
mu‹x_
);

43 
	gSpšMu‹x
::
SpšMu‹x
()

45 
±h»ad_¥š_š™
(&
mu‹x_
, 
PTHREAD_PROCESS_SHARED
);

48 
	gSpšMu‹x
::~
SpšMu‹x
()

50 
±h»ad_¥š_de¡roy
(&
mu‹x_
);

53 
boŞ
 
	gSpšMu‹x
::
ba£In™
()

55 
±h»ad_¥š_š™
(&
mu‹x_
, 
PTHREAD_PROCESS_SHARED
);

56  
	gŒue
;

59 
št32_t
 
	gSpšMu‹x
::
lock
()

61  
±h»ad_¥š_lock
(&
mu‹x_
);

64 
št32_t
 
	gSpšMu‹x
::
uÆock
()

66  
±h»ad_¥š_uÆock
(&
mu‹x_
);

69 
št32_t
 
	gSpšMu‹x
::
ŒyLock
()

71  
±h»ad_¥š_Œylock
(&
mu‹x_
);

77 * 
th»ad_¡¬t
(*
p
)

79 if(!
	gp
è 
	gNULL
;

81 
Th»ad
 *
	gthr
 = (Th»ad*)
p
;

82 
	gthr
->
run
();

83  
	gNULL
;

86 
	gTh»ad
::
Th»ad
()

90 
Th»ad
::~Thread()

94 
Th»ad
::
još
()

96 
±h»ad_još
(
pid_
, 
NULL
);

99 
št32_t
 
	gTh»ad
::
¡¬t
()

101 
mu‹x_
->
lock
();

102 
	gaùive_
 = 
Œue
;

103 
št32_t
 
	g»t
 = 
±h»ad_ü—‹
(&
pid_
, 
NULL
, 
th»ad_¡¬t
, (*)
this
);

104 
	gmu‹x_
->
uÆock
();

105  
	g»t
;

	@kit/platform/linux/Thread_linux.h

1 #iâdeà
__KIT_THREAD_LINUX_H__


2 
	#__KIT_THREAD_LINUX_H__


	)

4 
	~"Th»ad.h
"

5 
	~<±h»ad.h
>

7 
Çme¥aû
 
	gk™
 {

9 şas 
	cMu‹x
 : 
public
 
IMu‹x


11 
public
:

12 
KIT_CREATE_FUNC
(
Mu‹x
)

14 
Mu‹x
();

15 
	gvœtu®
 ~
Mu‹x
();

17 
vœtu®
 
št32_t
 
lock
();

18 
vœtu®
 
št32_t
 
uÆock
();

19 
vœtu®
 
št32_t
 
ŒyLock
();

20 
	g´Ùeùed
:

21 
vœtu®
 
boŞ
 
ba£In™
();

23 
±h»ad_mu‹x_t
 
	gmu‹x_
;

26 şas 
	cSpšMu‹x
 : 
public
 
IMu‹x


28 
public
:

29 
KIT_CREATE_FUNC
(
SpšMu‹x
)

31 
SpšMu‹x
();

32 
	gvœtu®
 ~
SpšMu‹x
();

34 
vœtu®
 
št32_t
 
lock
();

35 
vœtu®
 
št32_t
 
uÆock
();

36 
vœtu®
 
št32_t
 
ŒyLock
();

37 
	g´Ùeùed
:

38 
vœtu®
 
boŞ
 
ba£In™
();

40 
±h»ad_¥šlock_t
 
	gmu‹x_
;

46 şas 
	cTh»ad
 : 
public
 
ITh»ad


48 
public
:

49 
KIT_CREATE_FUNC
(
Th»ad
)

51 
Th»ad
();

52 
	gvœtu®
 ~
Th»ad
();

54 
vœtu®
 
još
();

55 
vœtu®
 
št32_t
 
¡¬t
();

56 
	g´iv©e
:

57 
±h»ad_t
 
pid_
;

	@network/Client.cpp

1 
	~"Cl›Á.h
"

2 
	~"Ãtsys.h
"

3 
	~"Sock‘.h
"

4 
	~"SockAddr.h
"

5 
	~"Pack‘.h
"

6 
	~"Logg”.h
"

8 
Çme¥aû
 
	gk™
 {

10 cÚ¡ 
št32_t
 
	gMAX_LISTEN
 = 50;

12 
	gICl›Á
::
ICl›Á
()

13 : 
sock‘_
(
NULL
)

14 , 
aùive_
(
çl£
)

18 
	gICl›Á
::~
ICl›Á
()

20 ià(
sock‘_
 !ğ
NULL
)

22 
sock‘_
->
»Ëa£
();

23 
	gsock‘_
 = 
NULL
;

28 
št32_t
 
	gICl›Á
::
¡¬tup
(cÚ¡ * 

, iÁ32_ˆ
pÜt
)

30 ià(
	gsock‘_
)

32 
shutdown
();

36 
SockAddr
* 
	gaddr
 = SockAddr::
ü—‹
();

37 
	gaddr
->
š™
(

, 
pÜt
, 
KIT_AF_INET
);

38 ià(!
	gaddr
->
v®id
())

40 
ERR
("[ICl›Á](¡¬tupèsockadd¸”rÜ! %s, %d", 

, 
pÜt
);

45 
Sock‘
* 
	gsock
 = Sock‘::
ü—‹
();

46 
	gsock
->
š™
(
KIT_AF_INET
, 
KIT_SOCK_STREAM
, 0);

48 ià(!
	gsock
->
v®id
())

50 
ERR
("[ICl›Á](¡¬tupèsock‘ƒ¼Ü! %s, %d", 

, 
pÜt
);

54 
	gsock
->
£tAddr
(
addr
);

65 
	gsock
->
»š
();

66 
	gsock‘_
 = 
sock
;

68 
	gaùive_
 = 
Œue
;

73 
	gICl›Á
::
hªdËPŞlEv’t
()

75 
Sock‘
* 
sock
 = 
sock‘_
;

77 
PŞlEv’t
 
	gev
;

78 
št32_t
 
	gsock_ev
;

79 
št32_t
 
	gút
 = 
ev’t_que_
.
couÁ
();

81 
	gi
 = 0; i !ğ
út
; ++i)

83 ià(!
	gev’t_que_
.
pİ
(
ev
))

85 
	gsock_ev
 = 
ev
.
ev’ts
;

86 ià(
	gsock_ev
 & 
	gKIT_POLLIN
)

88 
SessiÚ
* 
	gsd
 = 
sock
->
g‘SessiÚ
();

89 ià(
	gsd
)

90 
hªdËSessiÚRecv
(
sd
);

92 ià(
	gsock_ev
 & 
	gKIT_POLLOUT
)

94 
	gsock
->
	g»ady_out
 = 
Œue
;

95 
št32_t
 
	g»t
 = 
sock
->
æushS’d
();

96 ià(
	g»t
 == -1)

98 
sock_ev
 |ğ
KIT_POLLERR
;

101 ià(
	gsock_ev
 & 
	gKIT_POLLERR
)

104 
	gsock‘_
->
»Ëa£
();

105 
	gsock‘_
 = 
NULL
;

109 
DBG
("[S”v”](upd©eèpŞÈev’ˆfd=%d", 
ev
.
fd
);

113 
	gICl›Á
::
upd©e
()

115 
T”mš®
::
upd©e
();

116 
hªdËPŞlEv’t
();

119 
št32_t
 
	gICl›Á
::
shutdown
()

121 
aùive_
 = 
çl£
;

122 ià(
	gsock‘_
)

124 
	gsock‘_
->
şo£
();

125 
	gsock‘_
->
»Ëa£
();

126 
	gsock‘_
 = 
NULL
;

132 
	gICl›Á
::
£ndPack‘
(
Pack‘
* 
buf
)

134 
sock‘_
->
£ndPack‘
(
buf
);

	@network/Client.h

1 #iâdeà
__KIT_CLIENT_H__


2 
	#__KIT_CLIENT_H__


	)

4 
	~"T”mš®.h
"

5 
	~"Queue.h
"

6 
	~"Ãtsys.h
"

8 
Çme¥aû
 
	gk™
 {

10 
şass
 
	gSock‘
;

11 
şass
 
	gPack‘
;

12 
şass
 
	gIPack‘HªdËr
;

14 cÚ¡ 
ušt16_t
 
	gCLIENT_EVENT_CNT
 = 128;

16 şas 
	cICl›Á
 : 
public
 
T”mš®


18 
public
:

19 
ICl›Á
();

20 
	gvœtu®
 ~
ICl›Á
();

21 
vœtu®
 
št32_t
 
¡¬tup
(cÚ¡ * 

, iÁ32_ˆ
pÜt
);

22 
vœtu®
 
št32_t
 
shutdown
();

25 
vœtu®
 
upd©e
();

27 
£ndPack‘
(
Pack‘
* 
buf
);

28 
	g´Ùeùed
:

29 
vœtu®
 
hªdËPŞlEv’t
();

30 
	g´Ùeùed
:

31 
Sock‘
* 
sock‘_
;

33 
IPack‘HªdËr
* 
	g·ck‘_hªdËr_
;

34 
boŞ
 
	gaùive_
;

37 
	gQueue
<
	tPŞlEv’t
, 
	tCLIENT_EVENT_CNT
> 
	tEv’tQue
;

38 
Ev’tQue
 
	gev’t_que_
;

43 #ifdeà
PLATFORM_LINUX


44 
	~"¶©fÜm/lšux/Cl›Á_lšux.h
"

45 #–ià
defšed
 
PLATFORM_WINDOWS


46 
	~"¶©fÜm/wš/Cl›Á_wš.h
"

	@network/Packet.cpp

1 
	~"Pack‘.h
"

2 
	~"Bufãr.h
"

4 
Çme¥aû
 
	gk™
 {

6 
	gPack‘
::
Pack‘
()

7 : 
buf_
(
NULL
)

11 
Pack‘
::~Packet()

13 
KIT_SAFE_RELEASE
(
buf_
);

16 
	gPack‘
::
š™
(
ušt16_t
 
pid
, 
Bufãr
* 
buf
)

18 
	gbuf_
 = 
buf
;

19 
	gbuf_
->
»š
();

21 
	gh—d”_
.
	gpid
 = 
pid
;

22 
	gh—d”_
.
	gËngth
 = (
ušt16_t
)
buf
->
g‘Wr™‹nSize
();

25 
	gPack‘
::
£tBufãr
(
Bufãr
* 
buf
)

27 ià(
buf_
)

28 
buf_
->
»Ëa£
();

29 
	gbuf
->
»š
();

30 
	gbuf_
 = 
buf
;

33 
	gPack‘
::
d–Bufãr
()

35 ià(
buf_
)

37 
buf_
->
»Ëa£
();

38 
	gbuf_
 = 
NULL
;

42 
	gPack‘
::
·ckH—d”
(
Bufãr
* 
h—d_buf
)

44 (*
h—d_buf
è<< 
h—d”_
.
£ed
;

45 (*
	gh—d_buf
è<< 
	gh—d”_
.
	gËngth
;

46 (*
	gh—d_buf
è<< 
	gh—d”_
.
	gpid
;

49 
	gPack‘
::
uÅackH—d”
(
Bufãr
* 
h—d_buf
)

51 (*
h—d_buf
è>> 
h—d”_
.
£ed
;

52 (*
	gh—d_buf
è>> 
	gh—d”_
.
	gËngth
;

53 (*
	gh—d_buf
è>> 
	gh—d”_
.
	gpid
;

	@network/Packet.h

1 #iâdeà
__KIT_PACKET_H__


2 
	#__KIT_PACKET_H__


	)

4 
	~"k™sys.h
"

5 
	~"Ref.h
"

7 
Çme¥aû
 
	gk™
 {

9 
şass
 
	gBufãr
;

11 
	sPack‘H—d”


13 
ušt16_t
 
	g£ed
;

14 
ušt16_t
 
	gËngth
;

15 
ušt16_t
 
	gpid
;

19 cÚ¡ 
ušt32_t
 
	gPACKET_MAX_SIZE
 = 0xFFFF;

21 cÚ¡ 
ušt32_t
 
	gPACKET_HEADER_SIZE
 = (
Pack‘H—d”
);

23 şas 
	cPack‘
 : 
public
 
Ref


25 
public
:

26 
KIT_CREATE_FUNC
(
Pack‘
)

27 
Pack‘
();

28 
	gvœtu®
 ~
Pack‘
();

30 
š™
(
ušt16_t
 
pid
, 
Bufãr
* 
buf
);

32 
£tS“d
(
ušt16_t
 
£ed
è{ 
	gh—d”_
.
	g£ed
 = seed; }

33 
ušt16_t
 
g‘PID
(ècÚ¡ {  
	gh—d”_
.
	gpid
; }

34 
ušt16_t
 
g‘S“d
(ècÚ¡ {  
	gh—d”_
.
	g£ed
; }

35 
ušt16_t
 
g‘L’gth
(ècÚ¡ {  
	gh—d”_
.
	gËngth
; }

36 
£tBufãr
(
Bufãr
* 
buf
);

37 
Bufãr
* 
g‘Bufãr
(ècÚ¡ {  
	gbuf_
; }

38 
d–Bufãr
();

40 
·ckH—d”
(
Bufãr
* 
h—d_buf
);

41 
uÅackH—d”
(
Bufãr
* 
h—d_buf
);

42 
	gpublic
:

43 
Pack‘H—d”
 
h—d”_
;

44 
Bufãr
* 
	gbuf_
;

	@network/Protocol.cpp

1 
	~"PrÙocŞ.h
"

3 
Çme¥aû
 
	gk™
 {

6 
	g‹m¶©e
<
ty³Çme
 
	gT
>

7 
boŞ
 
	gPTV®ue
<
	gT
>::
£rŸlize
(
Bufãr
* 
bufãr
) const

9  (*
bufãr
è<< 
v®ue_
;

12 
	g‹m¶©e
<
ty³Çme
 
	gT
>

13 
boŞ
 
	gPTV®ue
<
	gT
>::
un£rŸlize
(
Bufãr
* 
bufãr
)

15  (*
bufãr
è>> 
v®ue_
;

18 
	g‹m¶©e
<
ty³Çme
 
	gT
>

19 
PTD©a
* 
	gPTV®ue
<
	gT
>::
şÚe
() const

21 
PTV®ue
<
T
>* 
Ãw_d©a
 = PTV®ue<T>::
ü—‹
();

22 
	gÃw_d©a
->
	gty³_
 = 
this
->
ty³_
;

23  
	gÃw_d©a
;

26 
	g‹m¶©e
<
ty³Çme
 
	gT
>

27 
	g¡d
::
¡ršg
 
PTV®ue
<
T
>::
toSŒšg
() const

29  
¡d
::
¡ršg
("{"è+ 
key_
 + ":" + std::
to_¡ršg
(
v®ue_
) + "}";

32 
	g‹m¶©e
<>

33 
	g¡d
::
¡ršg
 
PTV®ue
<
¡d
::¡ršg>::
toSŒšg
() const

35  
¡d
::
¡ršg
("{"è+ 
key_
 + ":" + 
v®ue_
 + "}";

39 
boŞ
 
	gPTV¬št
::
£rŸlize
(
Bufãr
* 
bufãr
) const

41  
bufãr
->
wr™eV¬ušt
(
v®ue_
);

44 
boŞ
 
	gPTV¬št
::
un£rŸlize
(
Bufãr
* 
bufãr
)

46  
bufãr
->
»adV¬ušt
(
v®ue_
);

49 
PTD©a
* 
	gPTV¬št
::
şÚe
() const

51  
PTV¬št
::
ü—‹
();

55 
	gPTA¼ay
::
PTA¼ay
()

56 : 
™em_‹m¶©e_
(
NULL
)

60 
PTA¼ay
::~PTArray()

62 
ş—r
();

63 
KIT_SAFE_RELEASE
(
™em_‹m¶©e_
);

66 
boŞ
 
	gPTA¼ay
::
£rŸlize
(
Bufãr
* 
bufãr
) const

68 
size_t
 
Ën
 = 
d©as_
.
size
();

69 ià(!
	gbufãr
->
	gwr™eV¬ušt
<
	gsize_t
>(
	gËn
))

70  
	gçl£
;

72 autØ
	gp
 : 
d©as_
)

74 ià(!
p
->
£rŸlize
(
bufãr
))

75  
çl£
;

78  
	gŒue
;

81 
boŞ
 
	gPTA¼ay
::
un£rŸlize
(
Bufãr
* 
bufãr
)

83 ià(
™em_‹m¶©e_
 =ğ
NULL
)

84  
çl£
;

85 
size_t
 
	gËn
;

86 ià(!
	gbufãr
->
	g»adV¬ušt
<
	gsize_t
>(
	gËn
))

87  
	gçl£
;

88 
ş—r
();

89 
	gd©as_
.
»size
(
Ën
);

90 
PTD©a
* 
	gd©a
;

91 
ušt32_t
 
	gi
 = 0; i !ğ
Ën
; ++i)

93 
	gd©a
 = 
™em_‹m¶©e_
->
şÚe
();

94 ià(!
	gd©a
 || !d©a->
un£rŸlize
(
bufãr
))

95  
	gçl£
;

96 
addD©a
(
d©a
);

99  
	gŒue
;

102 
	gPTA¼ay
::
»£tV®ue
()

104 
ş—r
();

107 
	gPTA¼ay
::
addD©a
(
PTD©a
* 
d©a
)

109 
KIT_SAFE_RETAIN
(
d©a
);

110 
	gd©as_
.
push_back
(
d©a
);

113 
PTD©a
* 
	gPTA¼ay
::
şÚe
() const

115 
PTA¼ay
* 
±
 = PTA¼ay::
ü—‹
();

116 ià(
	gthis
->
	g™em_‹m¶©e_
)

118 
PTD©a
* 
	gd©a
 = 
this
->
™em_‹m¶©e_
->
şÚe
();

119 
	g±
->
£tTem¶©e
(
d©a
);

121  
	g±
;

124 
	g¡d
::
¡ršg
 
PTA¼ay
::
toSŒšg
() const

126 
¡d
::
¡ršg
 
s
 = "{" + 
key_
 + ":[";

127 autØ
	gp
 : 
d©as_
)

129 
s
 +ğ
p
->
toSŒšg
();

131 
	gs
 += "]}";

132  
	gs
;

135 
	gPTA¼ay
::
£tTem¶©e
(
PTD©a
* 
d©a
)

137 ià(
™em_‹m¶©e_
 =ğ
d©a
)

139 
KIT_SAFE_RELEASE
(
™em_‹m¶©e_
);

140 
	g™em_‹m¶©e_
 = 
d©a
;

141 
KIT_SAFE_RETAIN
(
™em_‹m¶©e_
);

144 
PTD©a
* 
	gPTA¼ay
::
şÚeI‹m
()

146  
™em_‹m¶©e_
->
şÚe
();

149 
	gPTA¼ay
::
ş—r
()

151 autØ
p
 : 
d©as_
)

153 ià(
p
)

154 
p
->
»Ëa£
();

156 
	gd©as_
.
ş—r
();

160 
	gPTTabË
::~
PTTabË
()

162 
ş—r
();

165 
boŞ
 
	gPTTabË
::
£rŸlize
(
Bufãr
* 
bufãr
) const

167 autØ
p
 : 
d©as_
)

169 ià(!
p
->
£rŸlize
(
bufãr
))

170  
çl£
;

172  
	gŒue
;

175 
PTD©a
* 
	gPTTabË
::
şÚe
() const

177  
NULL
;

180 
	g¡d
::
¡ršg
 
PTTabË
::
toSŒšg
() const

182 
¡d
::
¡ršg
 
s
 = "{" + 
key_
 + ":\n";

183 autØ
	gp
 : 
d©as_
)

185 
s
 +ğ
p
->
toSŒšg
() + "\n";

187 
	gs
 += "}";

188  
	gs
;

191 
boŞ
 
	gPTTabË
::
un£rŸlize
(
Bufãr
* 
bufãr
)

193 autØ
p
 : 
d©as_
)

195 ià(!
p
->
un£rŸlize
(
bufãr
))

196  
çl£
;

198  
	gŒue
;

201 
	gPTTabË
::
addD©a
(
PTD©a
* 
d©a
)

203 
KIT_SAFE_RETAIN
(
d©a
);

204 
	gd©as_
.
push_back
(
d©a
);

207 
	gPTTabË
::
d–D©a
(
PTD©a
* 
d©a
)

209 
PTD©aVec
::
™”©Ü
 
ix
 = 
d©as_
.
begš
(); 
	gix
 !ğd©as_.
’d
(); ++ix)

211 ià(*
	gix
 =ğ
d©a
)

213 (*
ix
)->
»Ëa£
();

214 
	gd©as_
.
”a£
(
ix
);

220 
	gPTTabË
::
»£tV®ue
()

222 autØ
p
 : 
d©as_
)

224 
p
->
»£tV®ue
();

228 
	gPTTabË
::
ş—r
()

230 autØ
p
 : 
d©as_
)

232 ià(
p
)

233 
p
->
»Ëa£
();

235 
	gd©as_
.
ş—r
();

240 
	gPrÙocŞ
::
PrÙocŞ
()

244 
PrÙocŞ
::~Protocol()

248 
PrÙocŞ
::
š™
(
št32_t
 
pid
)

250 
pid_
 = 
pid
;

253 
	g¡d
::
¡ršg
 
PrÙocŞ
::
toSŒšg
() const

255 
¡d
::
¡ršg
 
s
 = "[" + std::
to_¡ršg
(
pid_
) + "]\n";

256 
	gs
 +ğ
PTTabË
::
toSŒšg
();

257  
	gs
;

261 
	gPTD©aC»©Ü
::
PTD©aC»©Ü
()

263 
usšg
 
±
 = 
PTTy³
 ;

264 
	g­i_bË_
[
tošt
(
±
::
INT8
)] = &
PTD©aC»©Ü
::
ü—‹V®ue
<
št8_t
>;

265 
	g­i_bË_
[
tošt
(
±
::
UINT8
)] = &
PTD©aC»©Ü
::
ü—‹V®ue
<
ušt8_t
>;

266 
	g­i_bË_
[
tošt
(
±
::
INT16
)] = &
PTD©aC»©Ü
::
ü—‹V®ue
<
št16_t
>;

267 
	g­i_bË_
[
tošt
(
±
::
UINT16
)] = &
PTD©aC»©Ü
::
ü—‹V®ue
<
ušt16_t
>;

268 
	g­i_bË_
[
tošt
(
±
::
INT32
)] = &
PTD©aC»©Ü
::
ü—‹V®ue
<
št32_t
>;

269 
	g­i_bË_
[
tošt
(
±
::
UINT32
)] = &
PTD©aC»©Ü
::
ü—‹V®ue
<
ušt32_t
>;

270 
	g­i_bË_
[
tošt
(
±
::
INT64
)] = &
PTD©aC»©Ü
::
ü—‹V®ue
<
št64_t
>;

271 
	g­i_bË_
[
tošt
(
±
::
UINT64
)] = &
PTD©aC»©Ü
::
ü—‹V®ue
<
ušt64_t
>;

272 
	g­i_bË_
[
tošt
(
±
::
VARINT
)] = &
PTD©aC»©Ü
::
ü—‹V¬št
;

273 
	g­i_bË_
[
tošt
(
±
::
STRING
)] = &
PTD©aC»©Ü
::
ü—‹V®ue
<
¡d
::
¡ršg
>;

275 
	g­i_bË_
[
tošt
(
±
::
ARRAY
)] = &
PTD©aC»©Ü
::
ü—‹A¼ay
;

276 
	g­i_bË_
[
tošt
(
±
::
TABLE
)] = &
PTD©aC»©Ü
::
ü—‹TabË
;

279 
	gPTD©aC»©Ü
::~
PTD©aC»©Ü
()

283 
PTD©a
* 
PTD©aC»©Ü
::
ü—‹PTD©a
(
PTTy³
 
ty³
)

285 
DCHECK
(
ty³
 !ğ
PTTy³
::
NONE
 &&y³ !ğPTTy³::
MAX
,

287 
PTD©aAPI
 
	gfunc
 = 
­i_bË_
[
tošt
(
ty³
)];

288 
PTD©a
* 
	gd©a
 = ((
this
->*(
func
))());

289 
	gd©a
->
£tTy³
(
ty³
);

290  
	gd©a
;

293 
	g‹m¶©e
<
ty³Çme
 
	gT
>

294 
PTD©a
* 
	gPTD©aC»©Ü
::
ü—‹V®ue
()

296  
PTV®ue
<
T
>::
ü—‹
();

300 
PTD©a
* 
	gPTD©aC»©Ü
::
ü—‹V¬št
()

302  
PTV¬št
::
ü—‹
();

305 
PTD©a
* 
	gPTD©aC»©Ü
::
ü—‹A¼ay
()

307  
PTA¼ay
::
ü—‹
();

310 
PTD©a
* 
	gPTD©aC»©Ü
::
ü—‹TabË
()

312  
PTTabË
::
ü—‹
();

	@network/Protocol.h

1 #iâdeà
__PROTOCOL_H__


2 
	#__PROTOCOL_H__


	)

4 
	~"Ref.h
"

5 
	~"Bufãr.h
"

6 
	~<veùÜ
>

7 
	~<¡ršg
>

8 
	~<funùiÚ®
>

10 
Çme¥aû
 
	gk™
 {

12 şas 
	cPTTy³
 : 
ušt8_t


14 
NONE
,

15 
	gINT8
,

16 
	gUINT8
,

17 
	gINT16
,

18 
	gUINT16
,

19 
	gINT32
,

20 
	gUINT32
,

21 
	gINT64
,

22 
	gUINT64
,

23 
	gVARINT
,

24 
	gSTRING
,

26 
	gARRAY
,

27 
	gTABLE
,

28 
	gMAX
,

31 
šlše
 
cÚ¡ex´
 
	$tošt
(
PTTy³
 
t
)

33  
¡©ic_ÿ¡
<>(
t
);

34 
	}
}

37 şas 
	cPTD©a
 : 
public
 
Ref


39 
public
:

40 
vœtu®
 ~
PTD©a
() {}

41 
vœtu®
 
PTTy³
 
g‘Ty³
(ècÚ¡ {  PTTy³::
NONE
; }

42 
vœtu®
 
£tTy³
(
PTTy³
 
ty³
) {}

44 
vœtu®
 
boŞ
 
£rŸlize
(
Bufãr
* 
bufãr
) const = 0;

45 
vœtu®
 
boŞ
 
un£rŸlize
(
Bufãr
* 
bufãr
) = 0;

47 cÚ¡ 
	g¡d
::
¡ršg
& 
g‘Key
(ècÚ¡ {  
key_
; }

48 
£tKey
(cÚ¡ 
¡d
::
¡ršg
& 
k
è{ 
key_
 = k; }

50 
vœtu®
 
»£tV®ue
() {}

52 
vœtu®
 
PTD©a
* 
şÚe
(ècÚ¡ {  
	gNULL
; }

54 
	g´Ùeùed
:

55 
¡d
::
¡ršg
 
key_
;

59 
	g‹m¶©e
<
ty³Çme
 
	gT
>

60 şas 
	cPTV®ue
 : 
public
 
PTD©a


62 
public
:

63 
KIT_CREATE_FUNC
(
PTV®ue
<
T
>)

64 
vœtu®
 
PTTy³
 
g‘Ty³
(ècÚ¡ {  
ty³_
; }

65 
vœtu®
 
£tTy³
(
PTTy³
 
ty³
è{ 
	gty³_
 =ype; }

67 cÚ¡ 
	gT
& 
g‘V®ue
(ècÚ¡ {  
	gv®ue_
; }

68 
£tV®ue
(cÚ¡ 
T
& 
v
è{ 
	gv®ue_
 = v; }

69 
»£tV®ue
(è{ 
	gv®ue_
 = 0; }

71 
vœtu®
 
boŞ
 
£rŸlize
(
Bufãr
* 
bufãr
) const;

72 
vœtu®
 
boŞ
 
un£rŸlize
(
Bufãr
* 
bufãr
);

74 
vœtu®
 
PTD©a
* 
şÚe
() const;

75 
vœtu®
 
	g¡d
::
¡ršg
 
toSŒšg
() const;

77 
	g´Ùeùed
:

78 
PTTy³
 
ty³_
;

79 
T
 
	gv®ue_
;

82 
	g‹m¶©e
<>

83 
šlše
 
	gPTV®ue
<
	g¡d
::
¡ršg
>::
	$»£tV®ue
()

85 
v®ue_
 = "";

86 
	}
}

89 
şass
 
	gPTV¬št
 : 
public
 
PTV®ue
<
ušt32_t
>

91 
public
:

92 
KIT_CREATE_FUNC
(
PTV¬št
);

93 
vœtu®
 
boŞ
 
£rŸlize
(
Bufãr
* 
bufãr
) const;

94 
vœtu®
 
boŞ
 
un£rŸlize
(
Bufãr
* 
bufãr
);

95 
vœtu®
 
PTD©a
* 
şÚe
() const;

98 
	g¡d
::
	tveùÜ
<
	tPTD©a
*> 
	tPTD©aVec
;

101 şas 
	cPTA¼ay
 : 
public
 
PTD©a


103 
public
:

104 
KIT_CREATE_FUNC
(
PTA¼ay
)

106 
PTA¼ay
();

107 
	gvœtu®
 ~
PTA¼ay
();

109 
vœtu®
 
PTTy³
 
g‘Ty³
(ècÚ¡ {  
	gPTTy³
::
ARRAY
; }

111 
vœtu®
 
boŞ
 
£rŸlize
(
Bufãr
* 
bufãr
) const;

112 
vœtu®
 
boŞ
 
un£rŸlize
(
Bufãr
* Buffer);

113 
vœtu®
 
PTD©a
* 
şÚe
() const;

114 
vœtu®
 
	g¡d
::
¡ršg
 
toSŒšg
() const;

115 
vœtu®
 
»£tV®ue
();

117 
addD©a
(
PTD©a
* 
d©a
);

119 
£tTem¶©e
(
PTD©a
* 
d©a
);

120 
PTD©a
* 
şÚeI‹m
();

121 
ş—r
();

123 cÚ¡ 
	gPTD©aVec
& 
g‘D©as
(ècÚ¡ {  
	gd©as_
; }

124 
	g´Ùeùed
:

125 
PTD©aVec
 
d©as_
;

126 
PTD©a
* 
	g™em_‹m¶©e_
;

130 şas 
	cPTTabË
 : 
public
 
PTD©a


132 
public
:

133 
KIT_CREATE_FUNC
(
PTTabË
)

135 
vœtu®
 ~
PTTabË
();

137 
vœtu®
 
PTTy³
 
g‘Ty³
(ècÚ¡ {  
	gPTTy³
::
TABLE
; }

139 
vœtu®
 
boŞ
 
£rŸlize
(
Bufãr
* 
bufãr
) const;

140 
vœtu®
 
boŞ
 
un£rŸlize
(
Bufãr
* 
bufãr
);

141 
vœtu®
 
PTD©a
* 
şÚe
() const;

142 
vœtu®
 
	g¡d
::
¡ršg
 
toSŒšg
() const;

144 
addD©a
(
PTD©a
* 
d©a
);

145 
d–D©a
(
PTD©a
* 
d©a
);

146 
vœtu®
 
»£tV®ue
();

147 
vœtu®
 
ş—r
();

149 cÚ¡ 
	gPTD©aVec
& 
g‘D©as
(ècÚ¡ {  
	gd©as_
; }

150 
	g´Ùeùed
:

151 
PTD©aVec
 
d©as_
;

155 şas 
	cPrÙocŞ
 : 
public
 
PTTabË


157 
public
:

158 
KIT_CREATE_FUNC
(
PrÙocŞ
)

159 
PrÙocŞ
();

160 
	gvœtu®
 ~
PrÙocŞ
();

162 
vœtu®
 
š™
(
št32_t
 
pid
);

164 
št32_t
 
g‘PID
(ècÚ¡ {  
	gpid_
; }

165 
size_t
 
g‘Budg‘Size
(ècÚ¡ {  
	gbudg‘_size_
; }

166 
£tBudg‘Size
(
size_t
 
size
è{ 
	gbudg‘_size_
 = size; }

168 
vœtu®
 
	g¡d
::
¡ršg
 
toSŒšg
() const;

169 
	g´Ùeùed
:

170 
št32_t
 
pid_
;

171 
size_t
 
	gbudg‘_size_
 = 64;

174 şas 
	cPTD©aC»©Ü
 : 
public
 
Ref


176 
public
:

177 
KIT_CREATE_FUNC
(
PTD©aC»©Ü
)

179 
PTD©aC»©Ü
();

180 
	gvœtu®
 ~
PTD©aC»©Ü
();

182 
PTD©a
* 
ü—‹PTD©a
(
PTTy³
 
ty³
);

183 
	g´iv©e
:

184 
‹m¶©e
<
ty³Çme
 
T
>

185 
PTD©a
* 
ü—‹V®ue
();

187 
PTD©a
* 
ü—‹V¬št
();

189 
PTD©a
* 
ü—‹A¼ay
();

190 
PTD©a
* 
ü—‹TabË
();

192 
	gPTD©a
* (
	tPTD©aC»©Ü
::* 
	tPTD©aAPI
)();

193 
PTD©aAPI
 
	g­i_bË_
[
tošt
(
PTTy³
::
MAX
)];

	@network/Server.cpp

1 
	~"S”v”.h
"

2 
	~"Ãtsys.h
"

3 
	~"Sock‘.h
"

4 
	~"SessiÚ.h
"

5 
	~"SockAddr.h
"

6 
	~"Th»ad.h
"

7 
	~"Logg”.h
"

9 
Çme¥aû
 
	gk™
 {

11 cÚ¡ 
št32_t
 
	gMAX_LISTEN
 = 50;

13 
	gIS”v”
::
IS”v”
()

14 : 
sock‘_
(
NULL
)

15 , 
aùive_
(
çl£
)

16 , 
d–_sock‘_mu‹x_
(
NULL
)

20 
	gIS”v”
::~
IS”v”
()

22 ià(
aùive_
)

24 
shutdown
();

27 
KIT_SAFE_RELEASE
(
sock‘_
)

28 
KIT_SAFE_RELEASE
(
d–_sock‘_mu‹x_
)

31 
boŞ
 
	gIS”v”
::
ba£In™
()

33 
T”mš®
::
ba£In™
();

35 
	gd–_sock‘_mu‹x_
 = 
Mu‹x
::
ü—‹
(
çl£
);

37 
mem£t
(
sock‘s_
, 0, (
Sock‘
*è* 
CONNECTION_LIMIT
);

39  
	gŒue
;

42 
št32_t
 
	gIS”v”
::
¡¬tup
(cÚ¡ * 

, iÁ32_ˆ
pÜt
)

44 ià(
	gsock‘_
)

46 
shutdown
();

50 
SockAddr
* 
	gaddr
 = SockAddr::
ü—‹
();

51 
	gaddr
->
š™
(

, 
pÜt
, 
KIT_AF_INET
);

52 ià(!
	gaddr
->
v®id
())

54 
ERR
("[IS”v”](¡¬tupèsockadd¸”rÜ! %s, %d", 

, 
pÜt
);

59 
Sock‘
* 
	gsock
 = Sock‘::
ü—‹
();

60 
	gsock
->
š™
(
KIT_AF_INET
, 
KIT_SOCK_STREAM
, 0);

62 ià(!
	gsock
->
v®id
())

64 
ERR
("[IS”v”](¡¬tupèsock‘ƒ¼Ü! %s, %d", 

, 
pÜt
);

69 ià(
	gsock
->
bšd
(
addr
) < 0)

71 
ERR
("[IS”v”](¡¬tupèbšdƒ¼Ü! %s, %d", 

, 
pÜt
);

76 ià(
	gsock
->
li¡’
(
MAX_LISTEN
) < 0)

78 
ERR
("[IS”v”](¡¬tupèli¡’ƒ¼Ü! %s, %d", 

, 
pÜt
);

82 
	gsock
->
»š
();

83 
	gsock‘_
 = 
sock
;

85 
addSock‘
(
sock
->
g‘HªdË
(), sock);

87 
	gaùive_
 = 
Œue
;

92 
	gIS”v”
::
hªdËPŞlEv’t
()

95 
PŞlEv’t
 
ev
;

96 
št32_t
 
	gút
 = 
ev’t_que_
.
couÁ
();

97 
Sock‘ID
 
	gsock_fd
;

98 
št32_t
 
	gsock_ev
;

99 
Sock‘
* 
	gsock
;

101 
	gi
 = 0; i !ğ
út
; ++i)

103 ià(!
	gev’t_que_
.
pİ
(
ev
))

105 
	gsock_fd
 = (
Sock‘ID
)
ev
.
fd
;

106 
	gsock_ev
 = 
ev
.
ev’ts
;

107 
	gsock
 = 
g‘Sock‘
(
sock_fd
);

108 ià(
	gsock
 =ğ
NULL
 || 
sock
 =ğ
sock‘_
)

113 ià(
	gsock_ev
 & 
	gKIT_POLLIN
)

116 
SessiÚ
* 
	gsd
 = 
sock
->
g‘SessiÚ
();

117 ià(!
	gsd
)

120 
	gsd
 = 
SessiÚ
::
ü—‹
();

121 
	gsd
->
£tSock‘
(
sock
);

122 
addSessiÚ
(
sd
);

124 
hªdËSessiÚRecv
(
sd
);

126 ià(
	gsock_ev
 & 
	gKIT_POLLOUT
)

128 
	gsock
->
	g»ady_out
 = 
Œue
;

129 
št32_t
 
	g»t
 = 
sock
->
æushS’d
();

130 ià(
	g»t
 == -1)

132 
sock_ev
 |ğ
KIT_POLLERR
;

135 ià(
	gsock_ev
 & 
	gKIT_POLLERR
)

138 
d–Sock‘
(
sock_fd
);

142 
DBG
("[S”v”](upd©eèpŞÈev’ˆfd=%d", 
ev
.
fd
);

146 
	gIS”v”
::
upd©e
()

148 
T”mš®
::
upd©e
();

150 
hªdËPŞlEv’t
();

154 
št32_t
 
	gIS”v”
::
addSock‘
(
Sock‘ID
 
fd
, 
Sock‘
* 
sock
)

156 
Sock‘
* 
	gŞd_sock
 = 
g‘Sock‘
(
fd
);

157 ià(
	gŞd_sock
)

160 
d–Sock‘
(
fd
);

162 ià(
	gsock
 =ğ
NULL
)

165 
sock
 = 
Sock‘
::
ü—‹
();

166 
	gsock
->
š™
(
fd
);

169 
	gsock
->
	gd–‘ed
 = 
çl£
;

170 
	gsock
->
»š
();

171 
	gsock‘s_
[
fd
] = 
sock
;

176 
št32_t
 
	gIS”v”
::
d–Sock‘
(
Sock‘ID
 
fd
)

178 
AutoLock
 
lock
(
d–_sock‘_mu‹x_
);

180 
Sock‘
* 
	gsock
 = 
g‘Sock‘
(
fd
);

181 ià(
	gsock
)

183 
	gsock
->
şo£
();

184 
	gsock
->
	gd–‘ed
 = 
Œue
;

185 
	gsock
->
»Ëa£
();

186 
	gsock‘s_
[
fd
] = 
NULL
;

195 
Sock‘
* 
	gIS”v”
::
g‘Sock‘
(
Sock‘ID
 
fd
)

197  
sock‘s_
[
fd
];

200 
št32_t
 
	gIS”v”
::
shutdown
()

202 
aùive_
 = 
çl£
;

203 ià(
	gsock‘_
)

205 
	gsock‘_
->
şo£
();

206 
	gsock‘_
->
»Ëa£
();

207 
	gsock‘_
 = 
NULL
;

210 
Sock‘
* 
	gsock
;

211 
	gi
 = 0; i !ğ
CONNECTION_LIMIT
; ++i)

213 
	gsock
 = 
sock‘s_
[
i
];

214 ià(
	gsock
)

216 
	gsock
->
şo£
();

217 
	gsock
->
»Ëa£
();

	@network/Server.h

1 #iâdeà
__KIT_SERVER_H__


2 
	#__KIT_SERVER_H__


	)

13 
	~"T”mš®.h
"

14 
	~"Ãtsys.h
"

15 
	~"Queue.h
"

16 
	~"A¼ay.h
"

17 
	~"M­.h
"

19 
Çme¥aû
 
	gk™
 {

21 cÚ¡ 
ušt16_t
 
	gCONNECTION_LIMIT
 = 0x7FFF;

22 cÚ¡ 
ušt16_t
 
	gSERVER_EVENT_CNT
 = 512;

24 
şass
 
	gSock‘
;

25 
şass
 
	gMu‹x
;

27 şas 
	cIS”v”
 : 
public
 
T”mš®


29 
public
:

30 
IS”v”
();

31 
	gvœtu®
 ~
IS”v”
();

32 
vœtu®
 
št32_t
 
¡¬tup
(cÚ¡ * 

, iÁ32_ˆ
pÜt
);

33 
vœtu®
 
št32_t
 
shutdown
();

36 
vœtu®
 
upd©e
() = 0;

37 
	g´Ùeùed
:

38 
vœtu®
 
boŞ
 
ba£In™
();

41 
vœtu®
 
hªdËPŞlEv’t
();

43 
vœtu®
 
št32_t
 
addSock‘
(
Sock‘ID
 
fd
, 
Sock‘
* 
sock
 = 
NULL
);

44 
vœtu®
 
št32_t
 
d–Sock‘
(
Sock‘ID
 
fd
);

45 
Sock‘
* 
g‘Sock‘
(
št32_t
 
fd
);

47 
	g´Ùeùed
:

48 
Sock‘
* 
sock‘_
;

49 
boŞ
 
	gaùive_
;

50 
Mu‹x
* 
	gd–_sock‘_mu‹x_
;

55 
Sock‘
* 
	gsock‘s_
[
CONNECTION_LIMIT
];

58 
	gQueue
<
	tPŞlEv’t
, 
	tSERVER_EVENT_CNT
> 
	tEv’tQue
;

59 
Ev’tQue
 
	gev’t_que_
;

64 #ifdeà
PLATFORM_LINUX


65 
	~"¶©fÜm/lšux/S”v”_lšux.h
"

66 #–ià
defšed
 
PLATFORM_WINDOWS


67 
	~"¶©fÜm/wš/S”v”_wš.h
"

	@network/Session.cpp

1 
	~"SessiÚ.h
"

2 
	~"Sock‘.h
"

3 
	~"Pack‘.h
"

5 
Çme¥aû
 
	gk™
 {

7 
SessiÚID
 
	gSessiÚ
::
£ssiÚ_id_couÁ_
 = 0;

9 
	gSessiÚ
::
SessiÚ
()

10 : 
sid_
(++
£ssiÚ_id_couÁ_
)

11 , 
time_
(0)

12 , 
sock‘_
(
NULL
)

16 
	gSessiÚ
::~
SessiÚ
()

20 
SessiÚ
::
š™
(
Sock‘
* 
sock
)

22 
£tSock‘
(
sock
);

25 
	gSessiÚ
::
£tSock‘
(
Sock‘
* 
sock
)

27 ià(
sock‘_
)

28 
sock‘_
->
»Ëa£
();

29 
	gsock‘_
 = 
sock
;

30 
	gsock‘_
->
»š
();

32 
	gtime_
 = 
k™
::
time
();

35 
boŞ
 
	gSessiÚ
::
£ndPack‘
(
Pack‘
* 
·ck
)

38 ià(
£nd_·ck‘s_
.
couÁ
(è=ğ0 && 
sock‘_
 && sock‘_->
v®id
())

40 
št32_t
 
»t
 = 
sock‘_
->
£ndPack‘
(
·ck
);

41  
	g»t
 == 0;

43 
	g£nd_·ck‘s_
.
push
(
·ck
);

44  
	gçl£
;

48 
boŞ
 
	gSessiÚ
::
»cvPack‘
(
Pack‘
* 
·ck
)

50 
KIT_SAFE_RETAIN
(
·ck
);

51 
	g»cv_·ck‘s_
.
push
(
·ck
);

52  
	gŒue
;

55 
boŞ
 
	gSessiÚ
::
æush
()

57 
Pakût
* 
pk
 = 
nuÎ±r
;

58 !
	g£nd_·ck‘s_
.
äÚt
(
pk
))

60 ià(!
	gsock‘_
->
£ndPack‘
(
pk
))

62 
	g£nd_·ck‘s_
.
pİ
(
pk
);

	@network/Session.h

1 #iâdeà
__KIT_SESSION_H__


2 
	#__KIT_SESSION_H__


	)

4 
	~"k™sys.h
"

5 
	~"Ãtsys.h
"

6 
	~"Ref.h
"

7 
	~"Li¡.h
"

8 
	~"Sock‘.h
"

10 
Çme¥aû
 
	gk™
 {

12 
şass
 
	gPack‘
;

14 şas 
	cSessiÚ
 : 
public
 
Ref


16 
public
:

17 
SessiÚID
 
£ssiÚ_id_couÁ_
;

18 
KIT_CREATE_FUNC
(
SessiÚ
)

19 
SessiÚ
();

20 
	gvœtu®
 ~
SessiÚ
();

22 
š™
(
Sock‘
* 
sock
);

24 
SessiÚID
 
g‘ID
(ècÚ¡ {  
	gsid_
; }

26 
£tSock‘
(
Sock‘
* 
sock
);

27 
Sock‘
* 
g‘Sock‘
(ècÚ¡ {  
	gsock‘_
; }

29 
boŞ
 
£ndPack‘
(
Pack‘
* 
·ck
);

30 
boŞ
 
»cvPack‘
(
Pack‘
* 
·ck
);

31 
boŞ
 
æush
();

33 
	gPack‘Que
& 
g‘RecvPack‘s
(è{  
	g»cv_·ck‘s_
; }

34 
	gPack‘Que
& 
g‘S’dPack‘s
(è{  
	g£nd_·ck‘s_
; }

36 
boŞ
 
	gout_dœty
 = 
çl£
;

37 
	g´Ùeùed
:

38 
SessiÚID
 
sid_
;

40 
ušt32_t
 
	gtime_
;

42 
Sock‘
* 
	gsock‘_
;

44 
Pack‘Que
 
	g£nd_·ck‘s_
;

46 
Pack‘Que
 
	g»cv_·ck‘s_
;

	@network/SockAddr.cpp

1 
	~"SockAddr.h
"

3 
Çme¥aû
 
	gk™
 {

5 
	gISockAddr
::
ISockAddr
()

6 : 
addr_
(
NULL
)

7 , 
v®id_
(
çl£
)

8 , 

("")

9 , 
pÜt
(0)

13 
	gISockAddr
::~
ISockAddr
()

17 
ISockAddr
::
š™
(cÚ¡ * 

, 
ušt16_t
 
pÜt
, ušt16_ˆ
çmy
)

19 
	gthis
->
	g
 = 

;

20 
	gthis
->
	gpÜt
 = 
pÜt
;

22 
	gv®id_
 = 
Œue
;

	@network/SockAddr.h

1 #iâdeà
__KIT_SOCK_ADDR_H__


2 
	#__KIT_SOCK_ADDR_H__


	)

4 
	~"Ref.h
"

5 
	~"k™sys.h
"

6 
	~<¡ršg
>

8 
	gsockaddr
;

9 
	gsockaddr_š
;

11 
Çme¥aû
 
	gk™
 {

13 şas 
	cISockAddr
 : 
public
 
Ref


15 
public
:

16 
ISockAddr
();

17 
	gvœtu®
 ~
ISockAddr
();

18 
vœtu®
 
š™
(cÚ¡ * 

, 
ušt16_t
 
pÜt
, ušt16_ˆ
çmy
);

19 
boŞ
 
v®id
(ècÚ¡ {  
	gv®id_
; }

21 
İ”©Ü
 
	gsockaddr_š
*(è{  (sockaddr_š*)
	gaddr_
; }

22 
İ”©Ü
 
	gsockaddr
*(è{  (sockaddr*)
	gaddr_
; }

23 
	g´Ùeùed
:

24 
sockaddr
* 
addr_
;

25 
boŞ
 
	gv®id_
;

27 
	gpublic
:

28 
¡d
::
¡ršg
 

;

29 
ušt16_t
 
	gpÜt
;

34 #ifdeà
PLATFORM_LINUX


35 
	~"¶©fÜm/lšux/SockAddr_lšux.h
"

36 #–ià
defšed
 
PLATFORM_WINDOWS


37 
	~"¶©fÜm/wš/SockAddr_wš.h
"

	@network/Socket.cpp

1 
	~"Sock‘.h
"

2 
	~"SockAddr.h
"

3 
	~"Bufãr.h
"

4 
	~"BufãrPoŞ.h
"

5 
	~"Pack‘.h
"

6 
	~"SessiÚ.h
"

7 
	~"Ãtsys.h
"

8 
	~"ba£.h
"

9 
	~<”ºo.h
>

10 
	~<¡dio.h
>

11 
	~<¡dlib.h
>

13 
Çme¥aû
 
	gk™
 {

15 
	gISock‘
::
ISock‘
()

16 : 
sock_
(
DSOCKERR
)

17 , 
£ssiÚ_
(
NULL
)

18 , 
addr_
(
NULL
)

19 , 
·ck‘_£ed_
(0)

20 , 
»cv_couÁ_
(0)

21 , 
»cv_h—d_buf_
(
NULL
)

22 , 
£nd_h—d_buf_
(
NULL
)

23 , 
»cv_buf_
(
NULL
)

24 , 
»cv_·ck‘_
(
NULL
)

25 , 
£nd_buf_
(
NULL
)

26 , 
£nd_bufs_
(
NULL
)

27 , 
£nd_·ck‘_
(
NULL
)

28 , 
d–‘ed
(
çl£
)

29 , 
»ady_out
(
çl£
)

33 
	gISock‘
::~
ISock‘
()

35 ià(
sock_
 !ğ
DSOCKERR
)

36 
şo£
();

37 
KIT_SAFE_RELEASE
(
addr_
);

38 
KIT_SAFE_RELEASE
(
»cv_h—d_buf_
);

39 
KIT_SAFE_RELEASE
(
£nd_h—d_buf_
);

40 
KIT_SAFE_RELEASE
(
»cv_buf_
);

41 
KIT_SAFE_RELEASE
(
»cv_·ck‘_
);

42 
KIT_SAFE_RELEASE
(
£nd_buf_
);

43 
KIT_SAFE_RELEASE
(
£nd_bufs_
);

46 
boŞ
 
	gISock‘
::
ba£In™
()

48 ià(!
»cv_h—d_buf_
)

49 
»cv_h—d_buf_
 = 
Bufãr
::
ü—‹
(
çl£
);

50 
	g»cv_h—d_buf_
->
š™
(
PACKET_HEADER_SIZE
);

51 ià(!
	g£nd_h—d_buf_
)

52 
	g£nd_h—d_buf_
 = 
Bufãr
::
ü—‹
(
çl£
);

53 
	g£nd_h—d_buf_
->
š™
(
PACKET_HEADER_SIZE
);

57  
	gŒue
;

60 
	gISock‘
::
š™
(
št32_t
 
çmy
, iÁ32_ˆ
ty³
, iÁ32_ˆ
´ÙocŞ
)

62 ià(
	gsock_
 !ğ
DSOCKERR
)

63 
şo£
();

64 
	gsock_
 = (
Sock‘ID
)::
sock‘
(
çmy
, 
ty³
, 
´ÙocŞ
);

65 ià(
	gsock_
 < 0)

67 
	gsock_
 = 
DSOCKERR
;

71 
İ’
();

74 
	gISock‘
::
š™
(
Sock‘ID
 
sock
)

76 
£tHªdË
(
sock
);

79 
	gISock‘
::
İ’
()

81 
št32_t
 
noblock
 = 1;

82 
št32_t
 
	g»v®ue
 = 1;

85 
ioùl
(
FIONBIO
, (*)(&
noblock
));

88 
£tO±iÚ
(
SOL_SOCKET
, 
SO_REUSEADDR
, (*)&
»v®ue
, (
št32_t
)(revalue));

91 #iâdeà
PLATFORM_LINUX


92 
£tO±iÚ
(
IPPROTO_TCP
, 
TCP_NODELAY
, (*)&
»v®ue
, (
št32_t
)(revalue));

94 
£tO±iÚ
(
SOL_TCP
, 
TCP_NODELAY
, (*)&
»v®ue
, (
št32_t
)(revalue));

98 
	gISock‘
::
şo£
()

100 ià(
sock_
 =ğ
DSOCKERR
)

103 ::
şo£
(
sock_
);

105 
	gsock_
 = 
DSOCKERR
;

108 
	gISock‘
::
£tHªdË
(
Sock‘ID
 
sock
)

110 ià(
sock_
 !ğ
DSOCKERR
)

111 
şo£
();

113 
	gsock_
 = 
sock
;

114 
İ’
();

117 
št32_t
 
	gISock‘
::
cÚÃù
(
SockAddr
* 
addr
)

119 
sockËn_t
 
Ën
 = (sockËn_t)(
sockaddr
);

120 
št32_t
 
	g»t
 = ::
cÚÃù
(
sock_
, *
addr
, 
Ën
);

122 
£tAddr
(
addr
);

124  
	g»t
;

127 
št32_t
 
	gISock‘
::
shutdown
(št32_ˆ
mode
)

129 ià(
sock_
 =ğ
DSOCKERR
)

132 
št32_t
 
	g»t
 = ::
shutdown
(
sock_
, 
mode
);

133 if(
	g»t
 =ğ0 && 
mode
 == 2)

134 
sock_
 = 
DSOCKERR
;

135  
	g»t
;

138 
št32_t
 
	gISock‘
::
bšd
(
SockAddr
* 
addr
)

140 
£tAddr
(
addr
);

141 
sockËn_t
 
	gËn
 = (sockËn_t)(
sockaddr
);

142  ::
bšd
(
sock_
, *
addr
, 
Ën
);

145 
št32_t
 
	gISock‘
::
li¡’
(št32_ˆ
couÁ
)

147  ::
li¡’
(
sock_
, 
couÁ
);

150 
št32_t
 
	gISock‘
::
acû±
(
SockAddr
* 
addr
)

152 
sockËn_t
 
Ën
 = (sockËn_t)(
sockaddr
);

153  ::
acû±
(
sock_
, *
addr
, &
Ën
);

156 
št32_t
 
	gISock‘
::
ioùl
(
cmd
, * 
¬gp
)

158  ::
ioùl
(
sock_
, 
cmd
, 
¬gp
);

161 
št32_t
 
	gISock‘
::
£tO±iÚ
(št32_ˆ
Ëv–
, iÁ32_ˆ
İŠame
, cÚ¡ * 
İtv®
, iÁ32_ˆ
İ’
)

163  ::
£tsockİt
(
sock_
, 
Ëv–
, 
İŠame
, 
İtv®
, 
İ’
);

166 
št32_t
 
	gISock‘
::
g‘O±iÚ
(št32_ˆ
Ëv–
, iÁ32_ˆ
İŠame
, * 
İtv®
, iÁ32_t* 
İ’
)

168 
sockËn_t
 
	gËn
 = (sockËn_t)((
İ’
) ? *optlen : 0);

169 
št32_t
 
	g»tv®
;

170 
	g»tv®
 = 
g‘sockİt
(
sock_
, 
Ëv–
, 
İŠame
, 
İtv®
, &
Ën
);

171 ià(
	gİ’
)

172 *
	gİ’
 = 
Ën
;

174  
	g»tv®
;

177 
št32_t
 
	gISock‘
::
g‘E¼no
()

179  
”ºo
;

182 
št32_t
 
	gISock‘
::
doRecv
()

185 
ušt32_t
 
Äecv
 = 0;

186 ià(
	g»cv_·ck‘_
 =ğ
NULL
)

188 
ušt32_t
 
»¡_h—d”_size
 = 
»cv_h—d_buf_
->
g‘Wr™abËSize
();

189 
št32_t
 
	gËn
 = 
»cvBufãr
(
»cv_h—d_buf_
);

191 ià(
	gËn
 == -1)

196 ià(
	gËn
 < (
	gšt32_t
)
	g»¡_h—d”_size
)

200 
	gÄecv
 +ğ
Ën
;

202 
Pack‘
* 
	g·ck‘
 = Pack‘::
ü—‹
(
çl£
);

203 
	g·ck‘
->
uÅackH—d”
(
»cv_h—d_buf_
);

204 
	g»cv_h—d_buf_
->
»£t
();

205 ià(
	g·ck‘
->
g‘S“d
(è!ğ
·ck‘_£ed_
)

208 
»cvCË¬
();

209 
	g·ck‘
->
»Ëa£
();

212 
	g»cv_·ck‘_
 = 
·ck‘
;

215 
KIT_SAFE_RELEASE
(
»cv_buf_
);

216 
	g»cv_buf_
 = 
g_BufPoŞTh»ad
->
ü—‹Bufãr
(
·ck‘
->
g‘L’gth
());

220 ià(
	g»cv_buf_
 =ğ
NULL
 || 
»cv_·ck‘_
 == NULL)

224 
ušt32_t
 
	g»¡_size
 = 
»cv_buf_
->
g‘Wr™abËSize
();

225 ià(
	g»¡_size
 > 0)

227 
št32_t
 
	gËn
 = 
»cvBufãr
(
»cv_buf_
);

229 ià(
	gËn
 == -1)

232 ià(
	gËn
 < (
	gšt32_t
)
	g»¡_size
)

234 
	gÄecv
 +ğ
»¡_size
;

238 
	g»cv_·ck‘_
->
£tBufãr
(
»cv_buf_
);

239 
KIT_SAFE_RELEASE
(
»cv_buf_
);

241 
»cvPack‘
(
»cv_·ck‘_
);

242 
KIT_SAFE_RELEASE
(
»cv_·ck‘_
);

244  
	gÄecv
;

247 
št32_t
 
	gISock‘
::
doS’d
()

249 
ušt32_t
 
»¡_size
 = 0;

250 
	g»¡_size
 = 
£nd_bufs_
->
g‘Wr™abËSize
();

252 
ušt32_t
 
	g»¡_h—d”_size
 = 
£nd_h—d_buf_
->
g‘R—dabËSize
();

253 ià(
	g»¡_h—d”_size
 > 0)

255 
	gËn
 = 
¡d
::
mš
(
»¡_h—d”_size
, 
»¡_size
);

256 
	g£nd_bufs_
->
wr™eBufãr
(
£nd_h—d_buf_
->
»adCur
(), 
Ën
);

257 
	g»¡_size
 -ğ
Ën
;

258 
	g£nd_h—d_buf_
->
skR—d
(
Ën
);

259 
	g»¡_h—d”_size
 -ğ
Ën
;

262 ià(
	g»¡_h—d”_size
 > 0 || 
	g»¡_size
 == 0)

265 ià(
	g£nd_·ck‘_
 =ğ
NULL
)

267 ià(!
£nd_que_
.
pİ
(
£nd_·ck‘_
))

272 
	g£nd_h—d_buf_
->
»£t
();

273 
	g£nd_·ck‘_
->
£tS“d
(
·ck‘_£ed_
);

274 
	g£nd_·ck‘_
->
·ckH—d”
(
£nd_h—d_buf_
);

275 
ušt32_t
 
	gsize
 = 
¡d
::
mš
(
PACKET_HEADER_SIZE
, 
»¡_size
);

276 
	g£nd_bufs_
->
wr™eBufãr
(
£nd_h—d_buf_
->
»adCur
(), 
size
);

277 
	g£nd_h—d_buf_
->
skR—d
(
size
);

278 
	g»¡_size
 -ğ
size
;

281 
KIT_SAFE_RELEASE
(
£nd_buf_
);

282 
	g£nd_buf_
 = 
£nd_·ck‘_
->
g‘Bufãr
();

283 ià(
	g£nd_buf_
)

285 
	g£nd_buf_
->
»š
();

286 
	g£nd_·ck‘_
->
d–Bufãr
();

289 ià(
	g»¡_size
 =ğ0 || 
£nd_buf_
 =ğ
NULL
)

292 
ušt32_t
 
	g»¡_bufãr_size
 = 
£nd_buf_
->
g‘R—dabËSize
();

293 ià(
	g»¡_bufãr_size
 > 0)

295 
ušt32_t
 
	gËn
 = 
¡d
::
mš
(
»¡_size
, 
»¡_bufãr_size
);

296 
	g£nd_bufs_
->
wr™eBufãr
(
£nd_buf_
->
»adCur
(), 
Ën
);

297 
	g»¡_size
 -ğ
Ën
;

298 
	g»¡_bufãr_size
 -ğ
Ën
;

301 ià(
	g»¡_bufãr_size
 > 0)

305 
KIT_SAFE_RELEASE
(
£nd_·ck‘_
);

306 
	gg_BufPoŞ
->
de¡royBufãr
(
£nd_buf_
);

307 
	g£nd_buf_
 = 
NULL
;

310 ià(
	g»¡_size
 == 0)

315 
št32_t
 
	gISock‘
::
£ndPack‘
(
Pack‘
* 
·ck
)

317 
·ck
->
»š
();

318 
	g£nd_que_
.
push
(
·ck
);

320 ià(
	g»ady_out
)

321  
æushS’d
();

325 
št32_t
 
	gISock‘
::
»cvPack‘
(
Pack‘
* 
·ck
)

327 ià(
»cv_que_
.
couÁ
(è=ğ0 && 
£ssiÚ_
)

329 
£ssiÚ_
->
»cvPack‘
(
·ck
);

334 
KIT_SAFE_RETAIN
(
·ck
);

335 
	g»cv_que_
.
push
(
·ck
);

336 
puÎPack‘sToSessiÚ
();

340 
	gISock‘
::
puÎPack‘sToSessiÚ
()

342 ià(!
£ssiÚ_
)

344 
Pack‘
* 
	g·ck
;

345 
	gút
 = 
»cv_que_
.
couÁ
();

346 
	gi
 = 0; i !ğ
út
; ++i)

348 ià(!
	g»cv_que_
.
pİ
(
·ck
))

350 
	g£ssiÚ_
->
»cvPack‘
(
·ck
);

351 
	g·ck
->
»Ëa£
();

355 
št32_t
 
	gISock‘
::
£nd
(cÚ¡ * 
buf
, iÁ32_ˆ
size
, iÁ32_ˆ
mode
)

357 
´štf
("_______£nd_______%d\n", 
size
);

358  ::
£nd
(
sock_
, 
buf
, 
size
, 
mode
);

361 
št32_t
 
	gISock‘
::
»cv
(* 
buf
, iÁ32_ˆ
size
, iÁ32_ˆ
mode
)

363 
´štf
("_______»cv_______%d\n", 
size
);

364  ::
»cv
(
sock_
, 
buf
, 
size
, 
mode
);

367 
št32_t
 
	gISock‘
::
»cvFrom
(* 
buf
, iÁ32_ˆ
size
, iÁ32_ˆ
mode
, 
SockAddr
 *
addr
)

369 
sockËn_t
 
	gËn
 = (
sockaddr
);

370  ::
»cväom
(
sock_
, 
buf
, 
size
, 
mode
, *
addr
, &
Ën
);

373 
št32_t
 
	gISock‘
::
£ndTo
(cÚ¡ * 
buf
, iÁ32_ˆ
size
, iÁ32_ˆ
mode
, 
SockAddr
* 
addr
)

375 
sockËn_t
 
	gËn
 = (
sockaddr
);

376  ::
£ndto
(
sock_
, 
buf
, 
size
, 
mode
, *
addr
, 
Ën
);

379 
	gISock‘
::
£tAddr
(
SockAddr
* 
addr
)

381 ià(
addr_
 =ğ
addr
)

383 ià(
	gaddr_
)

384 
	gaddr_
->
»Ëa£
();

385 
	gaddr_
 = 
addr
;

386 
	gaddr_
->
»š
();

389 
št32_t
 
	gISock‘
::
»cvBufãr
(
Bufãr
* 
buf
)

391 
ušt32_t
 
size
 = 
buf
->
g‘Wr™abËSize
();

392 
ušt32_t
 
	gÄecv
 = 0;

393 
št32_t
 
	gËn
 = 0;

394 
	gÄecv
 < 
	gsize
)

396 
	gËn
 = 
this
->
»cv
(
buf
->
wr™eCur
(), 
size
 - 
Äecv
, 0);

397 ià(
	gËn
 < 0 && 
g‘E¼no
(è!ğ
KIT_WOULDBLOCK
)

399 ià(
	gËn
 <= 0)

401 
	gÄecv
 +ğ
Ën
;

402 
	gbuf
->
skWr™e
(
Ën
);

404  
	gÄecv
;

407 
št32_t
 
	gISock‘
::
£ndBufãr
(
Bufãr
* 
buf
)

409 
ušt32_t
 
size
 = 
buf
->
g‘R—dabËSize
();

410 
ušt32_t
 
	gn£nd
 = 0;

411 
št32_t
 
	gËn
 = 0;

412 
	gn£nd
 < 
	gsize
)

414 
	gËn
 = 
this
->
£nd
(
buf
->
»adCur
(), 
size
 - 
n£nd
, 0);

415 ià(
	gËn
 < 0 && 
g‘E¼no
(è!ğ
KIT_WOULDBLOCK
)

417 ià(
	gËn
 <= 0)

419 
	gn£nd
 +ğ
Ën
;

420 
	gbuf
->
skR—d
(
Ën
);

422  
	gn£nd
;

425 
	gISock‘
::
»cvCË¬
()

427 cÚ¡ 
št32_t
 
BSIZE
 = 512;

428 
	gbuf
[
BSIZE
];

429 
št32_t
 
	gËn
 = -1;

431 
	gËn
 = 
this
->
»cv
(
buf
, 
BSIZE
, 0);

432 } 
	gËn
 > 0);

435 
	gISock‘
::
£ndCË¬
()

440 
št32_t
 
ISock‘
::
æushRecv
()

442 
št32_t
 
Ën
 = 0;

444 
	gËn
 = 
doRecv
();

445 ià(
	gËn
 < 0)

447 } 
	gËn
 > 0);

451 
št32_t
 
	gISock‘
::
æushS’d
()

453 
št32_t
 
Ën
 = 0;

454 
št32_t
 
	g»t
 = 0;

455 
št32_t
 
	g£nd_Ën
 = 0;

456 ià(
	g£nd_bufs_
 =ğ
NULL
)

457 
£nd_bufs_
 = 
g_BufPoŞ
->
ü—‹Bufãr
(
PACKET_SIZE
);

459 
	gËn
 = 
doS’d
();

460 ià(
	gËn
 == -1)

462 
»t
 = -1;

465 ià(
	g£nd_bufs_
->
g‘Wr™abËSize
(è=ğ0 || (
Ën
 =ğ0 
ªd
 
£nd_bufs_
->
g‘R—dabËSize
() > 0))

467 
£nd_Ën
 = 
this
->
£ndBufãr
(
£nd_bufs_
);

468 ià(
	g£nd_Ën
 == -1)

470 
»t
 = -1;

474 } 
	gËn
 > 0);

475 ià(
	g»t
 =ğ-1 || 
£nd_bufs_
->
g‘R—dabËSize
() == 0)

477 
g_BufPoŞ
->
de¡royBufãr
(
£nd_bufs_
);

478 
	g£nd_bufs_
 = 
NULL
;

480  
	g»t
;

	@network/Socket.h

1 #iâdeà
__KIT_SOCKET_H__


2 
	#__KIT_SOCKET_H__


	)

4 
	~"Ref.h
"

5 
	~"k™sys.h
"

6 
	~"Ãtsys.h
"

7 
	~"QLi¡.h
"

9 #iâdeà
PACKET_QUEUE_LENGTH


10 
	#PACKET_QUEUE_LENGTH
 (200)

	)

13 
Çme¥aû
 
	gk™
 {

15 
şass
 
	gSockAddr
;

16 
şass
 
	gPack‘
;

17 
şass
 
	gBufãr
;

18 
şass
 
	gSessiÚ
;

20 
	gQLi¡
<
	tPack‘
*, 
	tPACKET_QUEUE_LENGTH
> 
	tPack‘Que
;

22 şas 
	cISock‘
 : 
public
 
Ref


24 
public
:

25 
ISock‘
();

26 
	gvœtu®
 ~
ISock‘
();

28 
vœtu®
 
boŞ
 
ba£In™
();

29 
vœtu®
 
š™
(
št32_t
 
çmy
, iÁ32_ˆ
ty³
, iÁ32_ˆ
´ÙocŞ
);

30 
vœtu®
 
š™
(
Sock‘ID
 
sock
);

32 
İ’
();

33 
şo£
();

35 
št32_t
 
cÚÃù
(
SockAddr
* 
addr
);

36 
št32_t
 
shutdown
(št32_ˆ
mode
);

37 
št32_t
 
bšd
(
SockAddr
* 
addr
);

38 
št32_t
 
li¡’
(št32_ˆ
couÁ
);

39 
št32_t
 
acû±
(
SockAddr
* 
addr
);

40 
št32_t
 
g‘E¼no
();

43 
št32_t
 
£nd
(cÚ¡ * 
buf
, iÁ32_ˆ
size
, iÁ32_ˆ
mode
 = 0);

44 
št32_t
 
»cv
(* 
buf
, iÁ32_ˆ
size
, iÁ32_ˆ
mode
 = 0);

45 
št32_t
 
£ndTo
(cÚ¡ * 
buf
, iÁ32_ˆ
size
, iÁ32_ˆ
mode
, 
SockAddr
* 
addr
);

46 
št32_t
 
»cvFrom
(* 
buf
, iÁ32_ˆ
size
, iÁ32_ˆ
mode
, 
SockAddr
* 
addr
);

48 
št32_t
 
ioùl
(
cmd
, * 
¬gp
);

49 
št32_t
 
£tO±iÚ
(št32_ˆ
Ëv–
, iÁ32_ˆ
İŠame
, cÚ¡ * 
İtv®
, iÁ32_ˆ
İ’
);

50 
št32_t
 
g‘O±iÚ
(št32_ˆ
Ëv–
, iÁ32_ˆ
İŠame
, * 
İtv®
, iÁ32_t* 
İ’
);

52 
£tHªdË
(
Sock‘ID
 
sock
);

53 
šlše
 
Sock‘ID
 
g‘HªdË
(ècÚ¡ {  
	gsock_
; }

56 
SessiÚ
* 
g‘SessiÚ
(ècÚ¡ {  
	g£ssiÚ_
; }

57 
£tSessiÚ
(
SessiÚ
* 
£ssiÚ
è{ 
	g£ssiÚ_
 = session; }

58 
puÎPack‘sToSessiÚ
();

60 
£tAddr
(
SockAddr
* 
addr
);

61 
SockAddr
* 
g‘Addr
(ècÚ¡ {  
	gaddr_
; }

63 
	gPack‘Que
& 
g‘RecvQueue
(è{  
	g»cv_que_
; }

67 
št32_t
 
æushRecv
();

68 
št32_t
 
æushS’d
();

72 
št32_t
 
£ndPack‘
(
Pack‘
* 
·ck
);

75 
št32_t
 
»cvPack‘
(
Pack‘
* 
·ck
);

77 
boŞ
 
v®id
(ècÚ¡ {  
	gsock_
 !ğ
DSOCKERR
; }

78 
	g´Ùeùed
:

81 
št32_t
 
»cvBufãr
(
Bufãr
* 
buf
);

82 
št32_t
 
£ndBufãr
(
Bufãr
* 
buf
);

84 
»cvCË¬
();

85 
£ndCË¬
();

88 
št32_t
 
doRecv
();

91 
št32_t
 
doS’d
();

93 
	g´Ùeùed
:

94 
Sock‘ID
 
sock_
;

95 
SessiÚ
* 
	g£ssiÚ_
;

96 
SockAddr
* 
	gaddr_
;

97 
	g´iv©e
:

99 
ušt32_t
 
·ck‘_£ed_
;

101 
ušt32_t
 
	g»cv_couÁ_
;

104 
Bufãr
* 
	g»cv_h—d_buf_
;

105 
Bufãr
* 
	g£nd_h—d_buf_
;

107 
Bufãr
* 
	g»cv_buf_
;

108 
Pack‘
* 
	g»cv_·ck‘_
;

110 
Bufãr
* 
	g£nd_buf_
;

111 
Bufãr
* 
	g£nd_bufs_
;

112 
Pack‘
* 
	g£nd_·ck‘_
;

116 
Pack‘Que
 
	g»cv_que_
;

117 
Pack‘Que
 
	g£nd_que_
;

119 
	gpublic
:

121 
boŞ
 
d–‘ed
;

123 
boŞ
 
	g»ady_out
;

128 #ifdeà
PLATFORM_LINUX


129 
	~"¶©fÜm/lšux/Sock‘_lšux.h
"

130 #–ià
defšed
 
PLATFORM_WINDOWS


131 
	~"¶©fÜm/wš/Sock‘_wš.h
"

	@network/Terminal.cpp

1 
	~"T”mš®.h
"

2 
	~"Pack‘.h
"

3 
	~"SessiÚ.h
"

4 
	~"PrÙocŞ.h
"

5 
	~"BufãrPoŞ.h
"

6 
	~"Logg”.h
"

8 
Çme¥aû
 
	gk™
 {

10 
	gT”mš®
::
T”mš®
()

14 
T”mš®
::~Terminal()

16 
ş—rPrÙocŞs
();

17 
ş—rSessiÚs
();

20 
boŞ
 
	gT”mš®
::
ba£In™
()

22  
Œue
;

25 
	gT”mš®
::
hªdËSessiÚRecv
(
SessiÚ
* 
£ssiÚ
)

27 
Pack‘Que
& 
que
 = 
£ssiÚ
->
g‘RecvPack‘s
();

28 
Pack‘
* 
	g·ck
 = 
NULL
;

29 
	gút
 = 
que
.
couÁ
();

30 
	gi
 = 0; i !ğ
út
; ++i)

32 ià(!
	gque
.
pİ
(
·ck
))

34 
PrÙocŞID
 
	gpid
 = 
·ck
->
g‘PID
();

35 
PrÙocŞ
* 
	g±o
;

36 ià(!
	g´ÙocŞ_m­_
.
g‘
(
pid
, 
±o
))

38 
	g·ck
->
»Ëa£
();

42 
	g±o
->
un£rŸlize
(
·ck
->
g‘Bufãr
());

43 
	g·ck
->
»Ëa£
();

44 
»cvPrÙocŞ
(
£ssiÚ
->
g‘ID
(), 
±o
);

48 
	gT”mš®
::
hªdËSessiÚS’d
(
SessiÚ
* 
£ssiÚ
)

53 
T”mš®
::
addPrÙocŞ
(
PrÙocŞID
 
pid
, 
PrÙocŞ
* 
±o
)

55 
d–PrÙocŞ
(
pid
);

56 
	g´ÙocŞ_m­_
.
£t
(
pid
, 
±o
);

57 
KIT_SAFE_RETAIN
(
±o
);

60 
	gT”mš®
::
d–PrÙocŞ
(
PrÙocŞID
 
pid
)

62 
´ÙocŞ_m­_
.
d–
(
pid
, [](
PrÙocŞ
* 
p
){

63 
KIT_SAFE_RELEASE
(
p
);

67 
PrÙocŞ
* 
	gT”mš®
::
g‘PrÙocŞ
(
PrÙocŞID
 
pid
) const

69 
PrÙocŞ
* 
±o
 = 
NULL
;

70 
	g´ÙocŞ_m­_
.
g‘
(
pid
, 
±o
);

71  
	g±o
;

74 
SessiÚ
* 
	gT”mš®
::
g‘SessiÚ
(
SessiÚID
 
sid
) const

76 
SessiÚ
* 
sd
 = 
NULL
;

77 
	g£ssiÚ_m­_
.
g‘
(
sid
, 
sd
);

78  
	gsd
;

81 
	gT”mš®
::
addSessiÚ
(
SessiÚ
* 
£ssiÚ
)

83 
SessiÚID
 
sid
 = 
£ssiÚ
->
g‘ID
();

84 
d–SessiÚ
(
sid
);

85 
	g£ssiÚ_m­_
.
£t
(
sid
, 
£ssiÚ
);

86 
KIT_SAFE_RETAIN
(
£ssiÚ
);

89 
	gT”mš®
::
d–SessiÚ
(
SessiÚID
 
sid
)

91 
£ssiÚ_m­_
.
d–
(
sid
, [](
SessiÚ
* 
p
){

92 
KIT_SAFE_RELEASE
(
p
);

96 
	gT”mš®
::
£ndPrÙocŞ
(
SessiÚID
 
sid
, cÚ¡ 
PrÙocŞ
* 
±o
)

98 
SessiÚ
* 
	gsd
 = 
g‘SessiÚ
(
sid
);

99 ià(
	gsd
 =ğ
NULL
)

101 
ERR
("[T”mš®](£ndPrÙocŞènØ£ssiÚ:%d\n", 
sid
);

104 
Pack‘
* 
	g·ck
 = Pack‘::
ü—‹
();

105 
Bufãr
* 
	gbuf
 = 
g_BufPoŞ
->
ü—‹Bufãr
(
±o
->
g‘Budg‘Size
());

106 
	g±o
->
£rŸlize
(
buf
);

107 
	g·ck
->
š™
(
±o
->
g‘PID
(), 
buf
);

108 
boŞ
 
	gş—r_out
 = 
sd
->
£ndPack‘
(
·ck
);

111 
	gT”mš®
::
»cvPrÙocŞ
(
SessiÚID
 
sid
, cÚ¡ 
PrÙocŞ
* 
±o
)

113 
DBG
(
±o
->
toSŒšg
().
c_¡r
());

116 
	gT”mš®
::
ş—rPrÙocŞs
()

118 
´ÙocŞ_m­_
.
ş—r
([](
PrÙocŞ
* 
p
){

119 
KIT_SAFE_RELEASE
(
p
);

123 
	gT”mš®
::
ş—rSessiÚs
()

125 
£ssiÚ_m­_
.
ş—r
([](
SessiÚ
* 
p
){

126 
KIT_SAFE_RELEASE
(
p
);

	@network/Terminal.h

1 #iâdeà
__KIT_TERMINAL_H__


2 
	#__KIT_TERMINAL_H__


	)

4 
	~"Ãtsys.h
"

5 
	~"Ref.h
"

6 
	~"M­.h
"

8 #iâdeà
SESSION_LENGTH


9 
	#SESSION_LENGTH
 1024

	)

12 #iâdeà
PROTOCOL_LENGTH


13 
	#PROTOCOL_LENGTH
 512

	)

16 
Çme¥aû
 
	gk™
 {

18 
şass
 
	gSessiÚ
;

19 
şass
 
	gPrÙocŞ
;

20 
şass
 
	gPack‘HªdËr
;

22 şas 
	cT”mš®
 : 
public
 
Ref


24 
public
:

25 
T”mš®
();

26 
	gvœtu®
 ~
T”mš®
();

28 
hªdËSessiÚRecv
(
SessiÚ
* 
£ssiÚ
);

29 
hªdËSessiÚS’d
(
SessiÚ
* 
£ssiÚ
);

31 
£ndPrÙocŞ
(
SessiÚID
 
sid
, cÚ¡ 
PrÙocŞ
* 
±o
);

32 
»cvPrÙocŞ
(
SessiÚID
 
sid
, cÚ¡ 
PrÙocŞ
* 
±o
);

34 
PrÙocŞ
* 
g‘PrÙocŞ
(
PrÙocŞID
 
pid
) const;

35 
addPrÙocŞ
(
PrÙocŞID
 
pid
, 
PrÙocŞ
* 
±o
);

36 
d–PrÙocŞ
(
PrÙocŞID
 
pid
);

38 
SessiÚ
* 
g‘SessiÚ
(
SessiÚID
 
sid
) const;

39 
addSessiÚ
(
SessiÚ
* 
£ssiÚ
);

40 
d–SessiÚ
(
SessiÚID
 
sid
);

42 
ş—rPrÙocŞs
();

43 
ş—rSessiÚs
();

44 
	g´Ùeùed
:

45 
vœtu®
 
boŞ
 
ba£In™
();

47 
	gM­
<
	tSessiÚID
, 
	tSessiÚ
*, 
	tSESSION_LENGTH
> 
	tSessiÚM­
;

48 
SessiÚM­
 
	g£ssiÚ_m­_
;

50 
	gM­
<
	tPrÙocŞID
, 
	tPrÙocŞ
*, 
	tPROTOCOL_LENGTH
> 
	tPrÙocŞM­
;

51 
PrÙocŞM­
 
	g´ÙocŞ_m­_
;

54 
	g¡d
::
veùÜ
<
SessiÚ
*> 
out_vec_
;

	@network/msg.h

1 #iâdeà
__KIT_MSG_H__


2 
	#__KIT_MSG_H__


	)

7 
	~"k™sys.h
"

9 
Çme¥aû
 
	gk™
 {

11 cÚ¡ 
ušt16_t
 
	gPT_CONNECT
 = 1;

12 cÚ¡ 
ušt16_t
 
	gPT_KEEP_ALIVE
 = 2;

14 cÚ¡ 
ušt16_t
 
	gPT_PACKET_ID_MAX
 = 0xFFFF;

	@network/netsys.h

1 #iâdeà
__KIT_NET_SYS_H__


2 
	#__KIT_NET_SYS_H__


	)

4 #ifdeà
PLATFORM_LINUX


5 
	~<uni¡d.h
>

6 
	~<Ãtdb.h
>

7 
	~<sys/ioùl.h
>

8 
	~<sys/sock‘.h
>

9 
	~<sys/•Şl.h
>

10 
	~<¬·/š‘.h
>

11 
	~<Ãtš‘/š.h
>

12 
	~<Ãtš‘/tı.h
>

14 
	#KIT_AF_INET
 
AF_INET


	)

15 
	#KIT_SOCK_STREAM
 
SOCK_STREAM


	)

17 
	#KIT_POLLIN
 
EPOLLIN


	)

18 
	#KIT_POLLOUT
 
EPOLLOUT


	)

19 
	#KIT_POLLERR
 
EPOLLERR


	)

21 
	#KIT_WOULDBLOCK
 
EWOULDBLOCK


	)

22 
	#KIT_SOCKERR
 -1

	)

25 #–ià
defšed
 
PLATFORM_WINDOWS


28 
	#KIT_AF_INET
 
AF_INET


	)

29 
	#KIT_SOCK_STREAM
 
SOCK_STREAM


	)

31 
	#KIT_POLLIN
 
EPOLLIN


	)

32 
	#KIT_POLLOUT
 
EPOLLOUT


	)

33 
	#KIT_POLLERR
 
EPOLLERR


	)

35 
	#KIT_WOULDBLOCK
 
WSAEWOULDBLOCK


	)

36 
	#KIT_SOCKERR
 -1

	)

40 
	~"k™sys.h
"

42 
Çme¥aû
 
	gk™
 {

45 
št32_t
 
	tSessiÚID
;

47 
št32_t
 
	tSock‘ID
;

48 
št32_t
 
	tPrÙocŞID
;

50 cÚ¡ 
SessiÚID
 
	gDSESSIONERR
 = -1;

51 cÚ¡ 
SessiÚID
 
	gSIDNULL
 = 0;

52 cÚ¡ 
PrÙocŞID
 
	gDPROTOCOLERR
 = -1;

53 cÚ¡ 
PrÙocŞID
 
	gPIDNULL
 = 0;

54 cÚ¡ 
Sock‘ID
 
	gDSOCKERR
 = -1;

56 cÚ¡ 
ušt32_t
 
	gPACKET_SIZE
 = 512;

58 
	sPŞlEv’t
 {

59 
št32_t
 
	gev’ts
;

60 
št32_t
 
	gfd
;

	@network/network.h

1 #iâdeà
__KIT_NETWORK_H__


2 
	#__KIT_NETWORK_H__


	)

4 
	~"SockAddr.h
"

5 
	~"Sock‘.h
"

6 
	~"S”v”.h
"

	@network/platform/linux/Client_linux.cpp

1 
	~"Cl›Á_lšux.h
"

2 
	~"Sock‘.h
"

3 
	~"SockAddr.h
"

4 
	~<uni¡d.h
>

5 
	~<Ãtdb.h
>

6 
	~<sys/•Şl.h
>

7 
	~<sys/ioùl.h
>

8 
	~<sys/sock‘.h
>

9 
	~<¬·/š‘.h
>

10 
	~<Ãtš‘/š.h
>

11 
	~<Ãtš‘/tı.h
>

12 
	~<”ºo.h
>

13 
	~<¡dlib.h
>

14 
	~"Logg”.h
"

16 
Çme¥aû
 
	gk™
 {

18 cÚ¡ 
št32_t
 
	gMAX_LISTEN
 = 50;

20 
	gCl›Á
::
Cl›Á
()

21 : 
pŞl_fd_
(0)

22 , 
th»ad_
(
NULL
)

26 
	gCl›Á
::~
Cl›Á
()

30 
št32_t
 
Cl›Á
::
¡¬tup
(cÚ¡ * 

, iÁ32_ˆ
pÜt
)

32 
	g»t
 = 
ICl›Á
::
¡¬tup
(

, 
pÜt
);

33 ià(
	g»t
 < 0)

34  
	g»t
;

36 
	gaùive_
 = 
çl£
;

39 
št32_t
 
	gpŞl_fd
 = 
•Şl_ü—‹
(1);

40 ià(
	gpŞl_fd
 < 0)

42 
ERR
("[Cl›Á](¡¬tupè•Şl_ü—‹ƒ¼Ü! %s, %d", 
__FILE__
, 
__LINE__
);

46 
	gpŞl_fd_
 = 
pŞl_fd
;

48 
št32_t
 
	gsockfd
 = 
sock‘_
->
g‘HªdË
();

49 
	g»t
 = 
addCŒl
(
sockfd
, 
EPOLLET
 | 
EPOLLOUT
 | 
EPOLLIN
);

50 ià(
	g»t
 < 0)

52 
ERR
("[Cl›Á](¡¬tupèadd cŒÈ”rÜ! %s, %d", 
__FILE__
, 
__LINE__
);

57 
Th»ad
* 
	gth»ad
 = Th»ad::
ü—‹
();

58 
	gth»ad
->
š™
(
this
);

59 
	g»t
 = 
th»ad
->
¡¬t
();

60 ià(
	g»t
 < 0)

62 
ERR
("[Cl›Á](¡¬tupèü—‹h»adƒ¼Ü! %s, %d", 
__FILE__
, 
__LINE__
);

65 
	gth»ad
->
»š
();

66 
	gth»ad_
 = 
th»ad
;

71 
	gCl›Á
::
hªdËTh»ad
()

73 autØ
addr
 = 
sock‘_
->
g‘Addr
();

74 
	gsock‘_
->
cÚÃù
(
addr
) < 0)

76 
	gk™
::
¦“p
(2000);

77 
DBG
("[Cl›Á](hªdËTh»adècÚÃù ip:% pÜt:%d", 
addr
->

.
c_¡r
(),‡ddr->
pÜt
);

80 
	gaùive_
 = 
Œue
;

82 
LOG
("[Cl›Á](¡¬tupèsucûssæy! ip: % pÜt: %d", 
addr
->

.
c_¡r
(),‡ddr->
pÜt
);

86 
št32_t
 
	gút
 = 0;

87 
št32_t
 
	g»¡
 = 0;

88 
št32_t
 
	g•Şl_fd
 = 
pŞl_fd_
;

90 
•Şl_ev’t
 
	gev’ts
[
CLIENT_EVENT_CNT
];

91 
mem£t
(&
ev’ts
, 0, (events));

93 
PŞlEv’t
 
	gout_ev
;

94 
	gEv’tQue
& 
	gque
 = 
ev’t_que_
;

96 
	gaùive_
)

98 
	g»¡
 = 
que
.
»¡
();

99 ià(
	g»¡
 == 0)

101 
k™
::
¦“p
(100);

102 
DBG
("[Client](handleThread) EPOLL WAIT");

106 
	gút
 = 
•Şl_wa™
(
•Şl_fd
, 
ev’ts
, 
»¡
, -1);

107 ià(
	gút
 =ğ-1 && 
”ºo
 =ğ
EINTR
)

110 
out_ev
.
ev’ts
 = 
EPOLLERR
;

111 
	gout_ev
.
	gfd
 = 
sock‘_
->
g‘HªdË
();

112 
	gque
.
push
(
out_ev
);

117 
	gi
 = 0; i !ğ
út
; ++i)

119 cÚ¡ 
	g•Şl_ev’t
& 
	gev
 = 
ev’ts
[
i
];

120 
hªdËEv’ts
(
ev
.
ev’ts
);

122 
	gout_ev
.
	gev’ts
 = 
ev
.
ev’ts
;

123 
	gout_ev
.
	gfd
 = 
ev
.
d©a
.
fd
;

124 ià(!
	gque
.
push
(
out_ev
))

126 
DBG
("[Client](handleThread) EventQue…ush ERROR!");

133 
	gCl›Á
::
upd©e
()

135 
ICl›Á
::
upd©e
();

138 
	gCl›Á
::
hªdËEv’ts
(
št32_t
 
ev’ts
)

140 ià(
ev’ts
 & 
EPOLLIN
)

142 
DBG
("[Client](handleEvents) EPOLLIN");

144 ià(
	gev’ts
 & 
	gEPOLLOUT
)

146 
DBG
("[Client](handleEvents) EPOLLOUT");

148 ià(
	gev’ts
 & 
	gEPOLLERR
)

152 
DBG
("[Client](handleEvents) EPOLLERR");

156 
št32_t
 
	gCl›Á
::
addCŒl
(št32_ˆ
fd
, iÁ32_ˆ
ev’ts
)

159 
•Şl_ev’t
 
	gev
;

160 
mem£t
(&
ev
, 0, (ev));

161 
	gev
.
	gev’ts
 = 
ev’ts
;

162 
	gev
.
	gd©a
.
	gfd
 = 
fd
;

163 
št32_t
 
	g»t
 = 
•Şl_ùl
(
pŞl_fd_
, 
EPOLL_CTL_ADD
, 
fd
, &
ev
);

164  
	g»t
;

167 
št32_t
 
	gCl›Á
::
d–CŒl
(št32_ˆ
fd
)

170 
•Şl_ev’t
 
ev
;

171 
mem£t
(&
ev
, 0, (ev));

172 
	gev
.
	gev’ts
 = 0;

173 
	gev
.
	gd©a
.
	gfd
 = 
fd
;

174 
št32_t
 
	g»t
 = 
•Şl_ùl
(
pŞl_fd_
, 
EPOLL_CTL_DEL
, 
fd
, &
ev
);

175  
	g»t
;

178 
št32_t
 
	gCl›Á
::
shutdown
()

180 
ICl›Á
::
shutdown
();

181 
KIT_SAFE_RELEASE
(
th»ad_
)

183 
LOG
("[Client](shutdown) successfly!");

	@network/platform/linux/Client_linux.h

1 #iâdeà
__KIT_CLIENT_LINUX_H__


2 
	#__KIT_CLIENT_LINUX_H__


	)

4 
	~"Cl›Á.h
"

5 
	~"Th»ad.h
"

6 
	~<sys/•Şl.h
>

8 
Çme¥aû
 
	gk™
 {

10 
şass
 
	gCl›Á
 : 
public
 
ICl›Á
, 
	gTh»adHªdËr


12 
	gpublic
:

13 
KIT_CREATE_FUNC
(
Cl›Á
)

15 
Cl›Á
();

16 
	gvœtu®
 ~
Cl›Á
();

17 
vœtu®
 
št32_t
 
¡¬tup
(cÚ¡ * 

, iÁ32_ˆ
pÜt
);

18 
vœtu®
 
št32_t
 
shutdown
();

21 
vœtu®
 
upd©e
();

22 
	g´Ùeùed
:

23 
št32_t
 
addCŒl
(št32_ˆ
fd
, iÁ32_ˆ
ev’ts
);

24 
št32_t
 
d–CŒl
(št32_ˆ
fd
);

26 
hªdËEv’ts
(
št32_t
 
ev’ts
);

27 
hªdËTh»ad
();

28 
	g´iv©e
:

29 
št32_t
 
pŞl_fd_
;

30 
Th»ad
* 
	gth»ad_
;

	@network/platform/linux/Server_linux.cpp

1 
	~"S”v”_lšux.h
"

2 
	~"Sock‘.h
"

3 
	~"SockAddr.h
"

4 
	~<uni¡d.h
>

5 
	~<Ãtdb.h
>

6 
	~<sys/•Şl.h
>

7 
	~<sys/ioùl.h
>

8 
	~<sys/sock‘.h
>

9 
	~<¬·/š‘.h
>

10 
	~<Ãtš‘/š.h
>

11 
	~<Ãtš‘/tı.h
>

12 
	~<”ºo.h
>

13 
	~<¡dlib.h
>

14 
	~"Logg”.h
"

16 
Çme¥aû
 
	gk™
 {

18 cÚ¡ 
št32_t
 
	gMAX_LISTEN
 = 50;

20 
	gS”v”
::
S”v”
()

21 : 
pŞl_fd_
(0)

22 , 
th»ad_
(
NULL
)

26 
	gS”v”
::~
S”v”
()

30 
št32_t
 
S”v”
::
¡¬tup
(cÚ¡ * 

, iÁ32_ˆ
pÜt
)

32 
	g»t
 = 
IS”v”
::
¡¬tup
(

, 
pÜt
);

33 ià(
	g»t
 < 0)

34  
	g»t
;

36 
	gaùive_
 = 
çl£
;

39 
št32_t
 
	gpŞl_fd
 = 
•Şl_ü—‹
(
CONNECTION_LIMIT
);

40 ià(
	gpŞl_fd
 < 0)

42 
ERR
("[S”v”](¡¬tupè•Şl_ü—‹ƒ¼Ü! %s, %d", 
__FILE__
, 
__LINE__
);

46 
	gpŞl_fd_
 = 
pŞl_fd
;

48 
št32_t
 
	gli¡’fd
 = 
sock‘_
->
g‘HªdË
();

49 
	g»t
 = 
addCŒl
(
li¡’fd
, 
EPOLLET
 | 
EPOLLIN
);

50 ià(
	g»t
 < 0)

52 
ERR
("[S”v”](¡¬tupèadd†i¡’ sock‘ƒ¼Ü! %s, %d", 
__FILE__
, 
__LINE__
);

56 
	gaùive_
 = 
Œue
;

59 
Th»ad
* 
	gth»ad
 = Th»ad::
ü—‹
();

60 
	gth»ad
->
š™
(
this
);

61 
	g»t
 = 
th»ad
->
¡¬t
();

62 ià(
	g»t
 < 0)

64 
ERR
("[S”v”](¡¬tupèü—‹h»adƒ¼Ü! %s, %d", 
__FILE__
, 
__LINE__
);

68 
	gth»ad
->
»š
();

69 
	gth»ad_
 = 
th»ad
;

71 
LOG
("[S”v”](¡¬tupèsucûssæy! ip: % pÜt: %d", 

, 
pÜt
);

75 
	gS”v”
::
upd©e
()

77 
IS”v”
::
upd©e
();

81 
št32_t
 
	gS”v”
::
hªdËSock‘
(
Sock‘
* 
sock
, iÁ32_ˆ
ev’ts
)

83 ià(
	gsock
 =ğ
sock‘_
 && 
ev’ts
 & 
EPOLLIN
)

85 ià(
ev’ts
 & 
EPOLLERR
)

87 
DBG
("[Server](handleSocket) server disconnect!");

93 
SockAddr
* 
	gaddr
 = SockAddr::
ü—‹
();

94 
št32_t
 
	gfd
 = 
sock‘_
->
acû±
(
addr
);

95 ià(
	gfd
 =ğ
DSOCKERR
)

97 
ERR
("[Server](handleAccept)‡ccept fail!");

102 
addSock‘
(
fd
);

103 
addCŒl
(
fd
, 
EPOLLET
 | 
EPOLLIN
 | 
EPOLLOUT
);

104 
LOG
("[S”v”](hªdËAcû±èacû± sucûssfuÎy! fd:%d", 
fd
);

111 ià(
	gev’ts
 & 
	gEPOLLIN
)

113 
št32_t
 
	g»t
 = 
sock
->
æushRecv
();

114 ià(
	g»t
 == -1)

117 
sock
->
»ady_out
 = 
çl£
;

120 
DBG
("[S”v”](hªdËSock‘èEPOLLIN fd:%d", 
sock
->
g‘HªdË
());

122 ià(
	gev’ts
 & 
	gEPOLLOUT
)

125 
	gsock
->
	g»ady_out
 = 
Œue
;

126 
DBG
("[S”v”](hªdËSock‘èEPOLLOUT fd:%d", 
sock
->
g‘HªdË
());

129 ià(
	gev’ts
 & 
	gEPOLLERR
)

132 
DBG
("[S”v”](hªdËSock‘èEPOLLERR fd:%d", 
sock
->
g‘HªdË
());

142 
	gS”v”
::
hªdËTh»ad
()

144 
št32_t
 
út
 = 0;

145 
št32_t
 
	g»¡
 = 0;

146 
št32_t
 
	g•Şl_fd
 = 
pŞl_fd_
;

147 
št32_t
 
	g»t
 = 0;

148 
št32_t
 
	gsock_fd
 = 0;

149 
št32_t
 
	gsock_ev
 = 0;

151 
•Şl_ev’t
 
	gev’ts
[
SERVER_EVENT_CNT
];

152 
mem£t
(&
ev’ts
, 0, (events));

154 
PŞlEv’t
 
	gout_ev
;

155 
Sock‘
* 
	gsock‘
;

156 
	gEv’tQue
& 
	gque
 = 
ev’t_que_
;

158 
	gaùive_
)

160 
	g»¡
 = 
que
.
»¡
();

161 ià(
	g»¡
 == 0)

163 
k™
::
¦“p
(100);

164 
DBG
("[Server](handleThread) EPOLL WAIT");

168 
	gút
 = 
•Şl_wa™
(
•Şl_fd
, 
ev’ts
, 
»¡
, -1);

169 ià(
	gút
 =ğ-1 && 
”ºo
 =ğ
EINTR
)

172 
out_ev
.
ev’ts
 = 
EPOLLERR
;

173 
	gout_ev
.
	gfd
 = 
sock‘_
->
g‘HªdË
();

174 
	gque
.
push
(
out_ev
);

179 
	gi
 = 0; i !ğ
út
; ++i)

181 cÚ¡ 
	g•Şl_ev’t
& 
	gev
 = 
ev’ts
[
i
];

182 
	gsock_fd
 = 
ev
.
d©a
.
fd
;

183 
	gsock_ev
 = 
ev
.
ev’ts
;

185 
	gsock‘
 = 
g‘Sock‘
(
sock_fd
);

186 ià(
	gsock‘
)

187 
	g»t
 = 
hªdËSock‘
(
sock‘
, 
sock_ev
);

189 
	g»t
 = -1;

190 ià(
	g»t
 == -1)

192 
d–Sock‘
(
sock_fd
);

193 
d–CŒl
(
sock_fd
);

194 
	gsock_ev
 |ğ
EPOLLERR
;

198 
	gout_ev
.
	gfd
 = 
sock_fd
;

199 
	gout_ev
.
	gev’ts
 = 
sock_ev
;

200 ià(!
	gque
.
push
(
out_ev
))

203 
DBG
("[Server](handleThread) EventQue…ush ERROR!");

212 
št32_t
 
	gS”v”
::
addCŒl
(št32_ˆ
fd
, iÁ32_ˆ
ev’ts
)

215 
•Şl_ev’t
 
	gev
;

216 
mem£t
(&
ev
, 0, (ev));

217 
	gev
.
	gev’ts
 = 
ev’ts
;

218 
	gev
.
	gd©a
.
	gfd
 = 
fd
;

219 
št32_t
 
	g»t
 = 
•Şl_ùl
(
pŞl_fd_
, 
EPOLL_CTL_ADD
, 
fd
, &
ev
);

220  
	g»t
;

224 
št32_t
 
	gS”v”
::
d–CŒl
(št32_ˆ
fd
)

227 
•Şl_ev’t
 
ev
;

228 
mem£t
(&
ev
, 0, (ev));

229 
	gev
.
	gev’ts
 = 0;

230 
	gev
.
	gd©a
.
	gfd
 = 
fd
;

231 
št32_t
 
	g»t
 = 
•Şl_ùl
(
pŞl_fd_
, 
EPOLL_CTL_DEL
, 
fd
, &
ev
);

232  
	g»t
;

235 
št32_t
 
	gS”v”
::
shutdown
()

237 
IS”v”
::
shutdown
();

238 
KIT_SAFE_RELEASE
(
th»ad_
);

240 
LOG
("[Server](shutdown) successfly!");

	@network/platform/linux/Server_linux.h

1 #iâdeà
__KIT_SERVER_LINUX_H__


2 
	#__KIT_SERVER_LINUX_H__


	)

4 
	~"S”v”.h
"

5 
	~"Ãtsys.h
"

6 
	~"Queue.h
"

7 
	~"Th»ad.h
"

9 
Çme¥aû
 
	gk™
 {

12 
şass
 
	gS”v”
 : 
public
 
IS”v”
,…ubliø
	gTh»adHªdËr


14 
	gpublic
:

15 
KIT_CREATE_FUNC
(
S”v”
)

17 
S”v”
();

18 
	gvœtu®
 ~
S”v”
();

19 
vœtu®
 
št32_t
 
¡¬tup
(cÚ¡ * 

, iÁ32_ˆ
pÜt
);

20 
vœtu®
 
št32_t
 
shutdown
();

23 
vœtu®
 
upd©e
();

24 
	g´Ùeùed
:

25 
št32_t
 
addCŒl
(št32_ˆ
fd
, iÁ32_ˆ
ev’ts
);

26 
št32_t
 
d–CŒl
(št32_ˆ
fd
);

29 
št32_t
 
hªdËSock‘
(
Sock‘
* 
sock
, iÁ32_ˆ
ev’ts
);

32 
vœtu®
 
hªdËTh»ad
();

33 
	g´iv©e
:

34 
št32_t
 
pŞl_fd_
;

35 
Th»ad
* 
	gth»ad_
;

	@network/platform/linux/SockAddr_linux.cpp

1 
	~"SockAddr_lšux.h
"

2 
	~<sys/sock‘.h
>

3 
	~<Ãtdb.h
>

4 
	~<¬·/š‘.h
>

5 
	~"Logg”.h
"

7 
Çme¥aû
 
	gk™
 {

9 
	gSockAddr
::~
SockAddr
()

11 ià(
addr_
)

13 
d–‘e
 
addr_
;

14 
	gaddr_
 = 
NULL
;

17 
	gSockAddr
::
š™
(cÚ¡ * 

, 
ušt16_t
 
pÜt
, ušt16_ˆ
çmy
)

19 
	gISockAddr
::
š™
(

, 
pÜt
, 
çmy
);

21 
	gv®id_
 = 
çl£
;

22 ià(
	gaddr_
 =ğ
NULL
)

24 
addr_
 = 
Ãw
 
sockaddr
();

26 
mem£t
(
addr_
, 0, (*addr_));

28 
sockaddr_š
* 
	gaddr
 = (sockaddr_š*)
addr_
;

31 
boŞ
 
	gis_Çme
 = 
çl£
;

32 
	gi
 = 0; 
	g
[
i
]; ++i)

34 
	gs
 = 

[
i
];

35 ià(!((
	gs
 >ğ'0' && 
s
 <= '9') || s == '.'))

37 
is_Çme
 = 
Œue
;

42 ià(
	gis_Çme
)

44 
ho¡’t
* 
	ght
 = ::
g‘ho¡byÇme
(

);

45 ià(
	ght
 =ğ
NULL
 || 
ht
->
h_Ëngth
 != 4)

47 
ERR
("[SockAddr](š™è”rÜ! %s, %d", 
__FILE__
, 
__LINE__
);

51 
memıy
((*)&(
addr
->
sš_addr
), 
ht
->
h_addr
, ht->
h_Ëngth
);

55 
	gaddr
->
	gsš_addr
.
	gs_addr
 = 
š‘_addr
(

);

58 
	gaddr
->
	gsš_pÜt
 = 
htÚs
(
pÜt
);

59 
	gaddr
->
	gsš_çmy
 = 
çmy
;

60 
	gv®id_
 = 
Œue
;

	@network/platform/linux/SockAddr_linux.h

1 #iâdeà
__KIT_SOCK_ADDR_LINUX_H__


2 
	#__KIT_SOCK_ADDR_LINUX_H__


	)

4 
	~"SockAddr.h
"

6 
Çme¥aû
 
	gk™
 {

8 şas 
	cSockAddr
 : 
public
 
ISockAddr


10 
public
:

11 
KIT_CREATE_FUNC
(
SockAddr
)

12 
vœtu®
 ~
SockAddr
();

13 
vœtu®
 
š™
(cÚ¡ * 

, 
ušt16_t
 
pÜt
, ušt16_ˆ
çmy
);

	@network/platform/linux/Socket_linux.cpp

1 
	~"Sock‘_lšux.h
"

2 
	~"SockAddr.h
"

3 
	~<uni¡d.h
>

4 
	~<Ãtdb.h
>

5 
	~<sys/ioùl.h
>

6 
	~<sys/sock‘.h
>

7 
	~<¬·/š‘.h
>

8 
	~<Ãtš‘/š.h
>

9 
	~<Ãtš‘/tı.h
>

10 
	~<”ºo.h
>

11 
	~<¡dio.h
>

12 
	~"ba£.h
"

14 
Çme¥aû
 
	gk™
 {

	@network/platform/linux/Socket_linux.h

1 #iâdeà
__KIT_SOCKET_LINUX_H__


2 
	#__KIT_SOCKET_LINUX_H__


	)

4 
	~"Sock‘.h
"

6 
Çme¥aû
 
	gk™
 {

8 şas 
	cSock‘
 : 
public
 
ISock‘


10 
public
:

11 
KIT_CREATE_FUNC
(
Sock‘
)

	@network/platform/win/Client.cpp

	@network/platform/win/Server.cpp

1 
	~"S”v”.h
"

2 
	~"Sock‘.h
"

3 
	~"SockAddr.h
"

4 
	~<uni¡d.h
>

5 
	~<Ãtdb.h
>

6 
	~<sys/•Şl.h
>

7 
	~<sys/ioùl.h
>

8 
	~<sys/sock‘.h
>

9 
	~<¬·/š‘.h
>

10 
	~<Ãtš‘/š.h
>

11 
	~<Ãtš‘/tı.h
>

12 
	~<”ºo.h
>

13 
	~<¡dlib.h
>

14 
	~"Logg”.h
"

16 
Çme¥aû
 
	gk™
 {

18 cÚ¡ 
št32_t
 
	gMAX_LISTEN
 = 50;

20 
	gS”v”
::
S”v”
()

21 : 
sock‘_
(
NULL
)

25 
S”v”
::~Server()

29 
S”v”
::
¡¬tup
(cÚ¡ * 

, 
št32_t
 
pÜt
)

31 ià(
	gsock‘_
)

33 
shutdown
();

37 
SockAddr
 
	gaddr
;

38 
	gaddr
.
š™
(

, 
pÜt
, 
AF_INET
);

39 ià(!
	gaddr
.
v®id
())

41 
ERR
("[S”v”](¡¬upèsockadd¸”rÜ! %s, %d", 

, 
pÜt
);

46 
	gsock‘_
 = 
Ãw
 
Sock‘
();

47 
	gsock‘_
->
š™
(
AF_INET
, 
SOCK_STREAM
, 0);

48 ià(!
	gsock‘_
->
v®id
())

50 
ERR
("[S”v”](¡¬upèsock‘ƒ¼Ü! %s, %d", 

, 
pÜt
);

55 ià(
	gsock‘_
->
bšd
(
addr
) < 0)

57 
ERR
("[S”v”](¡¬upèbšdƒ¼Ü! %s, %d", 

, 
pÜt
);

62 ià(
	gsock‘_
->
li¡’
(
MAX_LISTEN
) < 0)

64 
ERR
("[S”v”](¡¬upèli¡’ƒ¼Ü! %s, %d", 

, 
pÜt
);

71 
	gS”v”
::
shutdown
()

73 ià(
sock‘_
)

75 
sock‘_
->
şo£
();

76 
d–‘e
 
	gsock‘_
;

77 
	gsock‘_
 = 
NULL
;

	@network/platform/win/SockAddr.cpp

1 
	~"SockAddr.h
"

2 
	~"ba£.h
"

3 
	~<Ãtš‘/š.h
>

5 
Çme¥aû
 
	gk™
 {

7 
	gSockAddr
::
SockAddr
()

8 : 
addr_
(
NULL
)

12 
SockAddr
::~SockAddr()

14 ià(
addr_
 !ğ
NULL
)

16 
d–‘e
 
addr_
;

20 
	gSockAddr
::
š™
(cÚ¡ * 

, 
ušt16_t
 
pÜt
, ušt16_ˆ
çmy
)

22 ià(
	gaddr_
 =ğ
NULL
)

24 
addr_
 = 
Ãw
 
sockaddr
();

26 
mem£t
(
addr_
, 0, (*addr_));

28 
sockaddr_š
 *
	gaddr
 = (sockaddr_š*)
addr_
;

31 
boŞ
 
	gis_Çme
 = 
çl£
;

32 
	gi
 = 0; 
	g
[
i
]; ++i)

34 
	gs
 = 

[
i
];

35 ià(!((
	gs
 >ğ'0' && 
s
 <= '9') || s == '.'))

37 
is_Çme
 = 
Œue
;

42 ià(
	gis_Çme
)

44 
ho¡’t
* 
	ght
 = ::
g‘ho¡byÇme
(

);

45 ià(
	ght
 =ğ
NULL
 || 
ht
->
h_Ëngth
 != 4)

47 
ERR
("[SockAddr](š™è”rÜ! %s, %d", 
__FILE__
, 
__LINE__
);

51 
memıy
((*)&(
addr
->
sš_addr
), 
ht
->
h_addr
, ht->
h_Ëngth
);

55 
	gaddr
->
	gsš_addr
.
	gS_un
.
	gS_addr
 = 
š‘_addr
(

);

58 
	gaddr
->
	gsš_pÜt
 = 
htÚs
(
pÜt
);

59 
	gaddr
->
	gsš_çmy
 = 
çmy
;

	@network/platform/win/Socket.cpp

1 
	~"Sock‘.h
"

2 
	~<uni¡d.h
>

3 
	~<Ãtdb.h
>

4 
	~<sys/ioùl.h
>

5 
	~<sys/sock‘.h
>

6 
	~<¬·/š‘.h
>

7 
	~<Ãtš‘/š.h
>

8 
	~<Ãtš‘/tı.h
>

9 
	~<”ºo.h
>

10 
	~<¡dio.h
>

11 
	~"ba£.h
"

13 
Çme¥aû
 
	gk™
 {

15 
	gSock‘
::
Sock‘
()

16 : 
sock_
(
DSOCKERR
)

20 
Sock‘
::~Socket()

22 ià(
sock_
 !ğ
DSOCKERR
)

23 
şo£
();

26 
	gSock‘
::
š™
(
št32_t
 
çmy
, iÁ32_ˆ
ty³
, iÁ32_ˆ
´ÙocŞ
)

28 ià(
	gsock_
 !ğ
DSOCKERR
)

29 
şo£
();

30 
	gsock_
 = (
št32_t
)::
sock‘
(
çmy
, 
ty³
, 
´ÙocŞ
);

31 ià(
	gsock_
 < 0)

33 
	gsock_
 = 
DSOCKERR
;

37 
İ’
();

40 
	gSock‘
::
İ’
()

42 
št32_t
 
noblock
 = 1;

43 
št32_t
 
	g»v®ue
 = 1;

46 
ioùl
(
FIONBIO
, (*)(&
noblock
));

49 
£tO±iÚ
(
SOL_SOCKET
, 
SO_REUSEADDR
, (*)&
»v®ue
, (
št32_t
)(revalue));

52 #iâdeà
PLATFORM_LINUX


53 
£tO±iÚ
(
IPPROTO_TCP
, 
TCP_NODELAY
, (*)&
»v®ue
, (
št32_t
)(revalue));

55 
£tO±iÚ
(
SOL_TCP
, 
TCP_NODELAY
, (*)&
»v®ue
, (
št32_t
)(revalue));

60 
	gSock‘
::
şo£
()

62 ià(
sock_
 =ğ
DSOCKERR
)

65 ::
şo£
(
sock_
);

67 
	gsock_
 = 
DSOCKERR
;

70 
	gSock‘
::
£tHªdË
(
št32_t
 
sock
)

72 ià(
sock_
 !ğ
DSOCKERR
)

73 
şo£
();

74 ià(
	gsock
 < 0)

77 
	gsock_
 = 
sock
;

78 
İ’
();

81 
št32_t
 
	gSock‘
::
cÚÃù
(cÚ¡ 
sockaddr
* 
addr
)

83 
sockËn_t
 
Ën
 = (sockËn_t)(
sockaddr
);

84 
št32_t
 
	g»t
 = ::
cÚÃù
(
sock_
, 
addr
, 
Ën
);

86  
	g»t
;

89 
št32_t
 
	gSock‘
::
shutdown
(št32_ˆ
mode
)

91 ià(
sock_
 =ğ
DSOCKERR
)

94 
št32_t
 
	g»t
 = ::
shutdown
(
sock_
, 
mode
);

95 if(
	g»t
 =ğ0 && 
mode
 == 2)

96 
sock_
 = 
DSOCKERR
;

97  
	g»t
;

100 
št32_t
 
	gSock‘
::
bšd
(cÚ¡ 
sockaddr
* 
addr
)

102 
sockËn_t
 
Ën
 = (sockËn_t)(
sockaddr
);

103  ::
bšd
(
sock_
, 
addr
, 
Ën
);

106 
št32_t
 
	gSock‘
::
li¡’
(št32_ˆ
couÁ
)

108  ::
li¡’
(
sock_
, 
couÁ
);

111 
št32_t
 
	gSock‘
::
acû±
(
sockaddr
* 
addr
)

113 
sockËn_t
 
Ën
 = (sockËn_t)(
sockaddr
);

114  ::
acû±
(
sock_
, 
addr
, &
Ën
);

117 
št32_t
 
	gSock‘
::
ioùl
(
cmd
, * 
¬gp
)

119  ::
ioùl
(
sock_
, 
cmd
, 
¬gp
);

122 
št32_t
 
	gSock‘
::
£tO±iÚ
(št32_ˆ
Ëv–
, iÁ32_ˆ
İŠame
, cÚ¡ * 
İtv®
, iÁ32_ˆ
İ’
)

124  ::
£tsockİt
(
sock_
, 
Ëv–
, 
İŠame
, 
İtv®
, 
İ’
);

127 
št32_t
 
	gSock‘
::
g‘O±iÚ
(št32_ˆ
Ëv–
, iÁ32_ˆ
İŠame
, * 
İtv®
, iÁ32_t* 
İ’
)

129 
sockËn_t
 
	gËn
 = (sockËn_t)((
İ’
) ? *optlen : 0);

130 
št32_t
 
	g»tv®
;

131 
	g»tv®
 = 
g‘sockİt
(
sock_
, 
Ëv–
, 
İŠame
, 
İtv®
, &
Ën
);

132 ià(
	gİ’
)

133 *
	gİ’
 = 
Ën
;

135  
	g»tv®
;

138 
št32_t
 
	gSock‘
::
g‘E¼no
()

140  
”ºo
;

143 
št32_t
 
	gSock‘
::
£nd
(cÚ¡ * 
buf
, iÁ32_ˆ
size
, iÁ32_ˆ
mode
)

145  ::
£nd
(
sock_
, 
buf
, 
size
, 
mode
);

148 
št32_t
 
	gSock‘
::
»cv
(* 
buf
, iÁ32_ˆ
size
, iÁ32_ˆ
mode
)

150  ::
»cv
(
sock_
, 
buf
, 
size
, 
mode
);

153 
št32_t
 
	gSock‘
::
»cvFrom
(* 
buf
, iÁ32_ˆ
size
, iÁ32_ˆ
mode
, 
sockaddr
 *
addr
)

155 
sockËn_t
 
	gËn
 = (
sockaddr
);

156  ::
»cväom
(
sock_
, 
buf
, 
size
, 
mode
, 
addr
, &
Ën
);

159 
št32_t
 
	gSock‘
::
£ndTo
(cÚ¡ * 
buf
, iÁ32_ˆ
size
, iÁ32_ˆ
mode
, cÚ¡ 
sockaddr
* 
addr
)

161 
sockËn_t
 
	gËn
 = (
sockaddr
);

162  ::
£ndto
(
sock_
, 
buf
, 
size
, 
mode
, 
addr
, 
Ën
);

	@script/ScriptSupport.cpp

1 
	~"SütSuµÜt.h
"

2 
	~<memÜy.h
>

4 
Çme¥aû
 
	gk™
 {

6 
	gSütMªag”
::
SütMªag”
()

10 
SütMªag”
::~ScriptManager()

14 
boŞ
 
SütMªag”
::
ba£In™
()

16 
mem£t
(
cÜes_
, 0, (
SütCÜe
*è* 
SCRIPT_TYPE_MAX
);

17  
	gŒue
;

20 
	gSütMªag”
::
addCÜe
(
SütCÜe
* 
cÜe
)

22 
SütTy³
 
ty³
 = 
cÜe
->
g‘SütTy³
();

24 
SütCÜe
* 
	gŞd_cÜe
 = 
cÜes_
[
ty³
];

25 
KIT_SAFE_RELEASE
(
Şd_cÜe
);

27 
	gcÜe
->
»š
();

28 
	gcÜes_
[
ty³
] = 
cÜe
;

	@script/ScriptSupport.h

1 #iâdeà
__KIT_SCRIPT_SUPPORT_H__


2 
	#__KIT_SCRIPT_SUPPORT_H__


	)

4 
	~"Ref.h
"

5 
	~<¡ršg
>

7 
Çme¥aû
 
	gk™
 {

9 
	eSütTy³
 {

10 
	gSCRIPT_TYPE_NONE
 = 0,

11 
	gSCRIPT_TYPE_JAVASCRIPT
,

12 
	gSCRIPT_TYPE_LUA
,

13 
	gSCRIPT_TYPE_PYTHON
,

15 
	gSCRIPT_TYPE_MAX
,

18 şas 
	cSütCÜe
 : 
public
 
Ref


20 
public
:

21 
SütCÜe
() {}

22 
vœtu®
 ~
SütCÜe
() {}

24 
vœtu®
 
SütTy³
 
g‘SütTy³
(è{  
SCRIPT_TYPE_NONE
; }

26 
vœtu®
 
de¡roy
() {}

28 
vœtu®
 
£tSütDœ
(cÚ¡ * 
·th
è{ 
	g·th_
 =…ath; }

29 
vœtu®
 cÚ¡ * 
g‘SütDœ
(è{  
	g·th_
.
c_¡r
(); }

32 
vœtu®
 
execu‹SŒšg
(cÚ¡ * 
codes
) = 0;

33 
vœtu®
 
execu‹Fe
(cÚ¡ * 
fe_Çme
) = 0;

34 
vœtu®
 
execu‹FunùiÚ
(cÚ¡ * 
funùiÚ_Çme
) = 0;

36 
	g´Ùeùed
:

37 
¡d
::
¡ršg
 
·th_
;

40 şas 
	cSütMªag”


42 
	gpublic
:

43 
SütMªag”
();

44 
	gvœtu®
 ~
SütMªag”
();

46 
vœtu®
 
boŞ
 
ba£In™
();

47 
vœtu®
 
SütCÜe
* 
g‘CÜe
(
SütTy³
 
ty³
ècÚ¡ {  
	gcÜes_
[type]; }

48 
vœtu®
 
addCÜe
(
SütCÜe
* 
cÜe
);

49 
	g´iv©e
:

50 
SütCÜe
* 
cÜes_
[
SCRIPT_TYPE_MAX
];

55 
	#g_SütMªag”
 (
k™
::
SšgËtÚ
<k™::
SütMªag”
>::
	`š¡ªû
())

	)

	@script/js/JSCore.cpp

1 
	~"JSCÜe.h
"

5 
	gJSCÜe
::
	$JSCÜe
()

7 
	}
}

9 
JSCÜe
::~
	$JSCÜe
()

11 
	}
}

13 
JSCÜe
::
	$š™
()

15 
	}
}

17 
JSCÜe
::
	$de¡roy
()

19 
	}
}

21 
JSCÜe
::
	$execu‹SŒšg
(cÚ¡ * 
codes
)

24 
	}
}

26 
	gJSCÜe
::
	$execu‹Fe
(cÚ¡ * 
f’ame
)

29 
	}
}

31 
	gJSCÜe
::
	$execu‹FunùiÚ
(cÚ¡ * 
funùiÚ_Çme
)

34 
	}
}

	@script/js/JSCore.h

1 #iâdeà
__JS_CORE_H__


2 
	#__JS_CORE_H__


	)

4 
	~"SütSuµÜt.h
"

6 şas 
	cJSCÜe
 : 
public
 
k™
::
SütPrÙocŞ


8 
public
:

9 
JSCÜe
();

10 
	mvœtu®
 ~
JSCÜe
();

12 
vœtu®
 
SütTy³
 
	$g‘SütTy³
(ècÚ¡ {  
SCRIPT_TYPE_JAVASCRIPT
; }

14 
vœtu®
 
	`š™
();

15 
vœtu®
 
	`de¡roy
();

18 
vœtu®
 
	`execu‹SŒšg
(cÚ¡ * 
codes
);

19 
vœtu®
 
	`execu‹Fe
(cÚ¡ * 
f’ame
);

20 
vœtu®
 
	`execu‹FunùiÚ
(cÚ¡ * 
funùiÚ_Çme
);

22 
´iv©e
:

23 
	}
};

	@script/lua/LuaBinding.cpp

1 
	~"LuaBšdšg.h
"

2 
	~<¡dio.h
>

3 
	~"lua.hµ
"

4 
	~"LuaIÁf/LuaIÁf.h
"

5 
	~"Logg”.h
"

7 
	~"LuaFunùiÚs.h
"

8 
	~"Ref.h
"

9 
	~"Tim”.h
"

10 
	~"Bufãr.h
"

11 
	~"BufãrPoŞ.h
"

12 
	~"LuaBufãr.h
"

13 
	~"Pack‘.h
"

14 
	~"LuaPrÙocŞ.h
"

15 
	~"Cl›Á.h
"

16 
	~"S”v”.h
"

17 
	~"G—r.h
"

18 
	~"SütSuµÜt.h
"

20 
	$‹¡_bË
(
lua_S‹
* 
L
)

22 
LuaIÁf
::
LuaRef
 
tb
 = LuaIÁf::
Lua
::
pİ
<LuaIÁf::LuaRef>(
L
);

23 
	`´štf
("bËsize:%d\n", 
tb
.
	`Ën
());

24 auto& 
e
 : 
tb
)

27 
	`´štf
("%s,%d\n", 
e
.
key
<cÚ¡ 
¡d
::
¡ršg
&>().
	`c_¡r
(),ƒ.
v®ue
<>());

29 
	`´štf
("xxxx:%s\n", 
tb
.
g‘
<
¡d
::
¡ršg
>(2).
	`c_¡r
());

30 
	}
}

32 
	$»gi¡”_CommÚCÚ¡ªt
(
lua_S‹
* 
L
)

34 
LuaIÁf
::
	`LuaBšdšg
(
L
)

35 .
	`begšModuË
("kit")

36 
	`DPART
(.
	`addCÚ¡ªt
("DEBUG_MODE", 1))

37 .
	`’dModuË
();

38 
	}
}

40 
	$»gi¡”_NÜm®FunùiÚ
(
lua_S‹
* 
L
)

42 
LuaIÁf
::
	`LuaBšdšg
(
L
)

43 .
	`begšModuË
("kit")

44 .
	`addFunùiÚ
("‹¡_bË", 
‹¡_bË
)

45 .
	`addFunùiÚ
("¥l™", 
luaS¶™
)

46 .
	`’dModuË
();

47 
	}
}

49 
	$»gi¡”_CÏss_Logg”
(
lua_S‹
* 
L
)

51 
LuaIÁf
::
	`LuaBšdšg
(
L
)

52 .
	`begšModuË
("kit")

53 .
	`’dModuË
();

54 
	}
}

56 
	$»gi¡”_CÏss_Ref
(
lua_S‹
* 
L
)

58 
LuaIÁf
::
	`LuaBšdšg
(
L
)

59 .
	`begšModuË
("kit")

60 .
begšCÏss
<
k™
::
Ref
>("ref")

61 .
	`addFunùiÚ
("»š", &
k™
::
Ref
::
»š
)

62 .
	`addFunùiÚ
("»Ëa£", &
k™
::
Ref
::
»Ëa£
)

63 .
	`addFunùiÚ
("autÜ–—£", &
k™
::
Ref
::
autoR–—£
)

64 .
	`addFunùiÚ
("g‘_»ã»nû_couÁ", &
k™
::
Ref
::
g‘Reã»nûCouÁ
)

65 .
	`addFunùiÚ
("add_chd", &
k™
::
Ref
::
addChd
)

66 .
	`addFunùiÚ
("d–_chd", &
k™
::
Ref
::
d–Chd
)

67 .
	`addFunùiÚ
("ş—r_chd»n", &
k™
::
Ref
::
ş—rChd»n
)

68 .
	`addFunùiÚ
("»move_äom_·»Á", &
k™
::
Ref
::
»moveFromP¬’t
)

69 .
	`addFunùiÚ
("to_¡ršg", &
k™
::
Ref
::
toSŒšg
)

70 .
	`’dCÏss
()

71 .
	`’dModuË
();

72 
	}
}

74 
	$»gi¡”_CÏss_Tim”
(
lua_S‹
* 
L
)

76 
LuaIÁf
::
	`LuaBšdšg
(
L
)

77 .
	`begšModuË
("kit")

78 .
begšEx‹ndCÏss
<
k™
::
Tim”
, k™::
Ref
>("timer")

79 .
	`addSticFunùiÚ
("ü—‹", &
k™
::
Tim”
::
ü—‹
)

80 .
	`addFunùiÚ
("add_tim”", &
k™
::
Tim”
::
addTim”
, 
	`LUA_ARGS
(
ušt32_t
, k™::
Tim”HªdËr
, 
LuaIÁf
::
_def
<uint32_t, 0>))

81 .
	`addFunùiÚ
("d–_tim”", &
k™
::
Tim”
::
d–Tim”
)

82 .
	`’dCÏss
()

83 .
	`’dModuË
();

84 
	}
}

86 
	$»gi¡”_CÏss_Bufãr
(
lua_S‹
* 
L
)

88 
LuaIÁf
::
	`LuaBšdšg
(
L
)

89 .
	`begšModuË
("kit")

90 .
begšEx‹ndCÏss
<
LuaBufãr
, 
k™
::
Ref
>("buffer")

91 .
	`addSticFunùiÚ
("ü—‹", &
LuaBufãr
::
ü—‹
)

92 .
	`addFunùiÚ
("š™", &
LuaBufãr
::
š™
)

93 .
	`addFunùiÚ
("»£t", &
LuaBufãr
::
»£t
)

94 .
	`addFunùiÚ
("g‘_size", &
LuaBufãr
::
g‘Size
)

95 .
	`addFunùiÚ
("g‘C­ac™y", &
LuaBufãr
::
g‘C­ac™y
)

96 .
	`addFunùiÚ
("g‘_wr™‹n_size", &
LuaBufãr
::
g‘Wr™‹nSize
)

97 .
	`addFunùiÚ
("g‘_wr™abË_size", &
LuaBufãr
::
g‘Wr™abËSize
)

98 .
	`addFunùiÚ
("g‘_»adabË_size", &
LuaBufãr
::
g‘R—dabËSize
)

99 .
	`addFunùiÚ
("sk_wr™e", &
LuaBufãr
::
skWr™e
)

100 .
	`addFunùiÚ
("sk_»ad", &
LuaBufãr
::
skR—d
)

101 .
	`addFunùiÚ
("to_¡ršg", &
LuaBufãr
::
toSŒšg
)

102 .
	`addFunùiÚ
("wr™e_bufãr", &
LuaBufãr
::
wr™eBufãr
)

103 .
	`addFunùiÚ
("»ad_bufãr", &
LuaBufãr
::
»adBufãr
)

104 .
	`addFunùiÚ
("w_¡ršg", &
LuaBufãr
::
İ”©Ü
<< <const *> )

106 .
	`addFunùiÚ
("w_št8_t", &
LuaBufãr
::
İ”©Ü
<< <
št8_t
> )

107 .
	`addFunùiÚ
("r_št8_t", [](
LuaBufãr
* 
£lf
){ 
št8_t
 
t
; (*self)>>t; ;} )

108 .
	`addFunùiÚ
("w_ušt8_t", &
LuaBufãr
::
İ”©Ü
<< <
ušt8_t
> )

109 .
	`addFunùiÚ
("r_ušt8_t", [](
LuaBufãr
* 
£lf
){ 
ušt8_t
 
t
; (*self)>>t; ;} )

111 .
	`addFunùiÚ
("w_št16_t", &
LuaBufãr
::
İ”©Ü
<< <
št16_t
> )

112 .
	`addFunùiÚ
("r_št16_t", [](
LuaBufãr
* 
£lf
){ 
št16_t
 
t
; (*self)>>t; ;} )

113 .
	`addFunùiÚ
("w_ušt16_t", &
LuaBufãr
::
İ”©Ü
<< <
ušt16_t
> )

114 .
	`addFunùiÚ
("r_ušt16_t", [](
LuaBufãr
* 
£lf
){ 
ušt16_t
 
t
; (*self)>>t; ;} )

116 .
	`addFunùiÚ
("w_št32_t", &
LuaBufãr
::
İ”©Ü
<< <
št32_t
> )

117 .
	`addFunùiÚ
("r_št32_t", [](
LuaBufãr
* 
£lf
){ 
št32_t
 
t
; (*self)>>t; ;} )

118 .
	`addFunùiÚ
("w_ušt32_t", &
LuaBufãr
::
İ”©Ü
<< <
ušt32_t
> )

119 .
	`addFunùiÚ
("r_ušt32_t", [](
LuaBufãr
* 
£lf
){ 
ušt32_t
 
t
; (*self)>>t; ;} )

121 .
	`addFunùiÚ
("wr™e_fÜm©", &
LuaBufãr
::
luaWr™eFÜm©
)

122 .
	`addFunùiÚ
("»ad_fÜm©", &
LuaBufãr
::
luaR—dFÜm©
)

123 .
	`’dCÏss
()

124 .
	`’dModuË
();

125 
	}
}

127 
	$»gi¡”_CÏss_BufãrPoŞ
(
lua_S‹
* 
L
)

129 
LuaIÁf
::
	`LuaBšdšg
(
L
)

130 .
	`begšModuË
("kit")

131 .
begšEx‹ndCÏss
<
k™
::
BufãrPoŞ
, k™::
Ref
>("bufferpool")

132 .
	`addFunùiÚ
("ü—‹_bufãr", &
k™
::
BufãrPoŞ
::
ü—‹Bufãr
)

133 .
	`addFunùiÚ
("de¡roy_bufãr", &
k™
::
BufãrPoŞ
::
de¡royBufãr
)

134 .
	`addFunùiÚ
("ş—r", &
k™
::
BufãrPoŞ
::
ş—r
)

135 .
	`’dCÏss
()

136 .
	`’dModuË
();

137 
	}
}

139 
	$»gi¡”_CÏss_Pack‘
(
lua_S‹
* 
L
)

141 
LuaIÁf
::
	`LuaBšdšg
(
L
)

142 .
	`begšModuË
("kit")

143 .
begšEx‹ndCÏss
<
k™
::
Pack‘
, k™::
Ref
>("packet")

144 .
	`addSticFunùiÚ
("ü—‹", &
k™
::
Pack‘
::
ü—‹
)

145 .
	`addFunùiÚ
("š™", &
k™
::
Pack‘
::
š™
)

146 .
	`addFunùiÚ
("£t_£ed", &
k™
::
Pack‘
::
g‘S“d
)

147 .
	`addFunùiÚ
("g‘_£ed", &
k™
::
Pack‘
::
£tS“d
)

148 .
	`addFunùiÚ
("g‘_Ëngth", &
k™
::
Pack‘
::
g‘L’gth
)

149 .
	`addFunùiÚ
("£t_bufãr", &
k™
::
Pack‘
::
£tBufãr
)

150 .
	`addFunùiÚ
("g‘_bufãr", &
k™
::
Pack‘
::
g‘Bufãr
)

151 .
	`addFunùiÚ
("d–_bufãr", &
k™
::
Pack‘
::
d–Bufãr
)

152 .
	`’dCÏss
()

153 .
	`’dModuË
();

154 
	}
}

156 
	$»gi¡”_CÏss_PrÙocŞ
(
lua_S‹
* 
L
)

158 
LuaIÁf
::
	`LuaBšdšg
(
L
)

159 .
	`begšModuË
("kit")

160 .
	`addCÚ¡ªt
("INT8", 
	`tošt
(
k™
::
PTTy³
::
INT8
))

161 .
	`addCÚ¡ªt
("UINT8", 
	`tošt
(
k™
::
PTTy³
::
UINT8
))

162 .
	`addCÚ¡ªt
("INT16", 
	`tošt
(
k™
::
PTTy³
::
INT16
))

163 .
	`addCÚ¡ªt
("UINT16", 
	`tošt
(
k™
::
PTTy³
::
UINT16
))

164 .
	`addCÚ¡ªt
("INT32", 
	`tošt
(
k™
::
PTTy³
::
INT32
))

165 .
	`addCÚ¡ªt
("UINT32", 
	`tošt
(
k™
::
PTTy³
::
UINT32
))

166 .
	`addCÚ¡ªt
("INT64", 
	`tošt
(
k™
::
PTTy³
::
INT64
))

167 .
	`addCÚ¡ªt
("UINT64", 
	`tošt
(
k™
::
PTTy³
::
UINT64
))

168 .
	`addCÚ¡ªt
("VARINT", 
	`tošt
(
k™
::
PTTy³
::
VARINT
))

169 .
	`addCÚ¡ªt
("STRING", 
	`tošt
(
k™
::
PTTy³
::
STRING
))

171 .
	`addCÚ¡ªt
("ARRAY", 
	`tošt
(
k™
::
PTTy³
::
ARRAY
))

172 .
	`addCÚ¡ªt
("TABLE", 
	`tošt
(
k™
::
PTTy³
::
TABLE
))

173 .
begšEx‹ndCÏss
<
k™
::
PrÙocŞ
, k™::
Ref
>("protocolbase")

174 .
	`addFunùiÚ
("š™", &
k™
::
PrÙocŞ
::
š™
)

175 .
	`’dCÏss
()

176 .
begšEx‹ndCÏss
<
LuaPrÙocŞ
, 
k™
::
PrÙocŞ
>("protocol")

177 .
	`addSticFunùiÚ
("ü—‹", &
LuaPrÙocŞ
::
ü—‹
)

178 .
	`addFunùiÚ
("bud", &
LuaPrÙocŞ
::
budFromTabË
)

179 .
	`addFunùiÚ
("£rŸlize", &
LuaPrÙocŞ
::
£rŸlizeToTabË
)

180 .
	`addFunùiÚ
("un£rŸlize", &
LuaPrÙocŞ
::
un£rŸlizeFromTabË
)

181 .
	`’dCÏss
()

182 .
	`’dModuË
();

183 
	}
}

185 
	$»gi¡”_CÏss_T”mš®
(
lua_S‹
* 
L
)

187 
LuaIÁf
::
	`LuaBšdšg
(
L
)

188 .
	`begšModuË
("kit")

189 .
begšEx‹ndCÏss
<
k™
::
T”mš®
, k™::
Ref
>("terminal")

190 .
	`addFunùiÚ
("add_´ÙocŞ", &
k™
::
T”mš®
::
addPrÙocŞ
)

191 .
	`addFunùiÚ
("d–_´ÙocŞ", &
k™
::
T”mš®
::
d–PrÙocŞ
)

192 .
	`’dCÏss
()

193 .
	`’dModuË
();

194 
	}
}

196 
	$»gi¡”_CÏss_Cl›Á
(
lua_S‹
* 
L
)

198 
LuaIÁf
::
	`LuaBšdšg
(
L
)

199 .
	`begšModuË
("kit")

200 .
begšEx‹ndCÏss
<
k™
::
Cl›Á
, k™::
T”mš®
>("client")

201 .
	`addSticFunùiÚ
("ü—‹", &
k™
::
Cl›Á
::
ü—‹
)

202 .
	`addFunùiÚ
("¡¬tup", &
k™
::
Cl›Á
::
¡¬tup
)

203 .
	`’dCÏss
()

204 .
	`’dModuË
();

205 
	}
}

207 
	$»gi¡”_CÏss_S”v”
(
lua_S‹
* 
L
)

209 
LuaIÁf
::
	`LuaBšdšg
(
L
)

210 .
	`begšModuË
("kit")

211 .
begšEx‹ndCÏss
<
k™
::
S”v”
, k™::
T”mš®
>("server")

212 .
	`addSticFunùiÚ
("ü—‹", &
k™
::
S”v”
::
ü—‹
)

213 .
	`addFunùiÚ
("¡¬tup", &
k™
::
S”v”
::
¡¬tup
)

214 .
	`’dCÏss
()

215 .
	`’dModuË
();

216 
	}
}

218 
	$»gi¡”_CÏss_SütCÜe
(
lua_S‹
* 
L
)

220 
LuaIÁf
::
	`LuaBšdšg
(
L
)

221 .
	`begšModuË
("kit")

222 .
	`addCÚ¡ªt
("SCRIPT_TYPE_NONE", 
k™
::
SCRIPT_TYPE_NONE
)

223 .
	`addCÚ¡ªt
("SCRIPT_TYPE_JAVASCRIPT", 
k™
::
SCRIPT_TYPE_JAVASCRIPT
)

224 .
	`addCÚ¡ªt
("SCRIPT_TYPE_LUA", 
k™
::
SCRIPT_TYPE_LUA
)

225 .
	`addCÚ¡ªt
("SCRIPT_TYPE_PYTHON", 
k™
::
SCRIPT_TYPE_PYTHON
)

226 .
begšEx‹ndCÏss
<
k™
::
SütCÜe
, k™::
Ref
>("scriptcore")

227 .
	`addFunùiÚ
("g‘_süt_dœ", &
k™
::
SütCÜe
::
g‘SütDœ
)

228 .
	`addFunùiÚ
("£t_süt_dœ", &
k™
::
SütCÜe
::
£tSütDœ
)

229 .
	`addFunùiÚ
("execu‹_¡ršg", &
k™
::
SütCÜe
::
execu‹SŒšg
)

230 .
	`addFunùiÚ
("execu‹_fe", &
k™
::
SütCÜe
::
execu‹Fe
)

231 .
	`addFunùiÚ
("execu‹_funùiÚ", &
k™
::
SütCÜe
::
execu‹FunùiÚ
)

232 .
	`’dCÏss
()

233 .
	`’dModuË
();

234 
	}
}

236 
	$»gi¡”_CÏss_SütMªag”
(
lua_S‹
* 
L
)

238 
LuaIÁf
::
	`LuaBšdšg
(
L
)

239 .
	`begšModuË
("kit")

240 .
begšEx‹ndCÏss
<
k™
::
SütMªag”
, k™::
Ref
>("scriptmanager")

241 .
	`addFunùiÚ
("g‘_cÜe", &
k™
::
SütMªag”
::
g‘CÜe
)

242 .
	`addFunùiÚ
("add_cÜe", &
k™
::
SütMªag”
::
addCÜe
)

243 .
	`’dCÏss
()

244 .
	`’dModuË
();

245 
	}
}

247 
	$»gi¡”_CÏss_G—r
(
lua_S‹
* 
L
)

249 
LuaIÁf
::
	`LuaBšdšg
(
L
)

250 .
	`begšModuË
("kit")

251 .
begšEx‹ndCÏss
<
k™
::
G—r
, k™::
Ref
>("gear")

252 .
	`addSticFunùiÚ
("š¡ªû", &
k™
::
SšgËtÚ
<k™::
G—r
>::
š¡ªû
)

253 .
	`addFunùiÚ
("¡İ", &
k™
::
G—r
::
¡İ
)

254 .
	`addFunùiÚ
("g‘_äame", &
k™
::
G—r
::
g‘F¿me
)

255 .
	`addFunùiÚ
("g‘_äame_¿‹", &
k™
::
G—r
::
g‘F¿meR©e
)

256 .
	`addFunùiÚ
("g‘_äame_d–", &
k™
::
G—r
::
g‘F¿meD–
)

258 .
	`addFunùiÚ
("g‘_bufãr_poŞ", [](
k™
::
G—r
* 
£lf
è{  
g_BufPoŞMng
->
	`g‘PoŞ
(); })

259 .
	`’dCÏss
()

260 .
	`’dModuË
();

261 
	}
}

	@script/lua/LuaBinding.h

1 #iâdeà
__LUA_BINDING_H__


2 
	#__LUA_BINDING_H__


	)

4 
	glua_S‹
;

7 
»gi¡”_CommÚCÚ¡ªt
(
lua_S‹
* 
L
);

9 
»gi¡”_NÜm®FunùiÚ
(
lua_S‹
* 
L
);

12 
»gi¡”_CÏss_Logg”
(
lua_S‹
* 
L
);

15 
»gi¡”_CÏss_Ref
(
lua_S‹
* 
L
);

18 
»gi¡”_CÏss_Tim”
(
lua_S‹
* 
L
);

21 
»gi¡”_CÏss_Bufãr
(
lua_S‹
* 
L
);

22 
»gi¡”_CÏss_BufãrPoŞ
(
lua_S‹
* 
L
);

25 
»gi¡”_CÏss_Pack‘
(
lua_S‹
* 
L
);

28 
»gi¡”_CÏss_PrÙocŞ
(
lua_S‹
* 
L
);

31 
»gi¡”_CÏss_T”mš®
(
lua_S‹
* 
L
);

34 
»gi¡”_CÏss_S”v”
(
lua_S‹
* 
L
);

37 
»gi¡”_CÏss_Cl›Á
(
lua_S‹
* 
L
);

40 
»gi¡”_CÏss_SütCÜe
(
lua_S‹
* 
L
);

43 
»gi¡”_CÏss_SütMªag”
(
lua_S‹
* 
L
);

46 
»gi¡”_CÏss_G—r
(
lua_S‹
* 
L
);

	@script/lua/LuaBuffer.cpp

1 
	~"LuaBufãr.h
"

2 
	~"Bufãr.h
"

3 
	~"lua.hµ
"

4 
	~"LuaIÁf/LuaIÁf.h
"

5 
	~"Logg”.h
"

8 
št32_t
 
	gLuaBufãr
::
	$luaWr™eVeùÜ
(
lua_S‹
* 
L
)

10 
LuaIÁf
::
LuaRef
 
bË
 = LuaIÁf::
Lua
::
pİ
<LuaIÁf::LuaRef>(
L
);

11 ià(!
bË
.
	`isTabË
())

13 
	`ERR
("[LuaBuffer](luaWriteVector)…aram‚ot‡able!");

17 
	}
}

20 
št32_t
 
	gLuaBufãr
::
	$luaR—dVeùÜ
(
lua_S‹
* 
L
)

23 
	}
}

25 
št32_t
 
	gLuaBufãr
::
	$luaWr™eFÜm©
(
lua_S‹
* 
L
)

27 
št32_t
 
Çrg
 = 
	`lua_g‘tİ
Ğ
L
 );

28 ifĞ
Çrg
 < 3 ) {

29 
	`ERR
( "[Buffer] c_write_format,‚arg < 2" );

33 
size_t
 
Ën
;

34 cÚ¡ *
fmt
 = 
	`luaL_checkl¡ršg
Ğ
L
, 2, &
Ën
 );

35 ifĞ!
fmt
 ) {

36 
	`ERR
( "[Buffer] c_write_format, invalid format" );

40 ifĞ
Ën
 !ğ
	`size_t
Ğ
Çrg
-2 ) ) {

41 
	`ERR
Ğ"[Bufãr] c_wr™e_fÜm©, fÜm©: % nÙ m©ch‚¬gs: %d", 
fmt
, 
Çrg
 );

45  
size_t
 
i
 = 0; i < 
Ën
; ++i ) {

46  
fmt
[
i
] ) {

48 *
this
 << ( 
št8_t
 )
	`lua_tÚumb”
Ğ
L
, 
i
+3 );

51 *
this
 << ( 
ušt8_t
 )
	`lua_tÚumb”
Ğ
L
, 
i
+3 );

54 *
this
 << ( 
št16_t
 )
	`lua_tÚumb”
Ğ
L
, 
i
+3 );

57 *
this
 << ( 
ušt16_t
 )
	`lua_tÚumb”
Ğ
L
, 
i
+3 );

60 *
this
 << ( 
št32_t
 )
	`lua_tÚumb”
Ğ
L
, 
i
+3 );

63 *
this
 << ( 
ušt32_t
 )
	`lua_tÚumb”
Ğ
L
, 
i
+3 );

66 *
this
 << ( 
št64_t
 )
	`lua_tÚumb”
Ğ
L
, 
i
+3 );

69 *
this
 << ( 
ušt64_t
 )
	`lua_tÚumb”
Ğ
L
, 
i
+3 );

72 *
this
 << ( )
	`lua_tÚumb”
Ğ
L
, 
i
+3 );

75 *
this
 << ( )
	`lua_tÚumb”
Ğ
L
, 
i
+3 );

79 
size_t
 
Ën2
;

80 cÚ¡ * 
¡r
 = 
	`luaL_checkl¡ršg
Ğ
L
, 
i
+3, &
Ën2
 );

81 *
this
 << 
¡r
;

85 
	`ERR
Ğ"[Bufãr] c_wr™e_fÜm©, inv®id fÜm©: %c", 
fmt
[
i
] );

90 
	}
}

92 
št32_t
 
	gLuaBufãr
::
	$luaR—dFÜm©
(
lua_S‹
* 
L
)

94 
size_t
 
Ën
;

95 cÚ¡ *
fmt
 = 
	`luaL_checkl¡ršg
Ğ
L
, 2, &
Ën
 );

96 ifĞ!
fmt
 ) {

97 
	`ERR
( "[BufferNode] c_read_format, invalid format" );

101 
	`lua_check¡ack
Ğ
L
, 
Ën
 + 2 );

102  
size_t
 
i
 = 0; i < 
Ën
; ++i ) {

103  
fmt
[
i
] ) {

106 
št8_t
 
c
;

107 *
this
 >> 
c
;

108 
	`lua_pushš‹g”
Ğ
L
, 
c
 );

113 
ušt8_t
 
b
;

114 *
this
 >> 
b
;

115 
	`lua_pushš‹g”
Ğ
L
, 
b
 );

120 
št16_t
 
s
;

121 *
this
 >> 
s
;

122 
	`lua_pushš‹g”
Ğ
L
, 
s
 );

127 
ušt16_t
 
w
;

128 *
this
 >> 
w
;

129 
	`lua_pushš‹g”
Ğ
L
, 
w
 );

134 
št32_t
 
i
;

135 *
this
 >> 
i
;

136 
	`lua_pushš‹g”
Ğ
L
, 
i
 );

141 
ušt32_t
 
d
;

142 *
this
 >> 
d
;

143 
	`lua_pushš‹g”
Ğ
L
, 
d
 );

148 
št64_t
 
l
;

149 *
this
 >> 
l
;

150 
	`lua_pushš‹g”
Ğ
L
, 
l
 );

155 
ušt64_t
 
q
;

156 *
this
 >> 
q
;

157 
	`lua_pushš‹g”
Ğ
L
, 
q
 );

162 
f
;

163 *
this
 >> 
f
;

164 
	`lua_pushnumb”
Ğ
L
, 
f
 );

169 
o
;

170 *
this
 >> 
o
;

171 
	`lua_pushnumb”
Ğ
L
, 
o
 );

176 
size_t
 
Ën
;

177 
this
->
»adV¬ušt
<
size_t
>(
Ën
);

178 ià(
Ën
 <= 512)

180 
buf
[512];

181 ià(
this
->
	`»adBufãr
(
buf
, 
Ën
))

182 
	`lua_pushl¡ršg
(
L
, 
buf
, 
Ën
);

184 
	`lua_pushn
(
L
);

188 * 
buf
 = 
Ãw
 [
Ën
];

189 ià(
this
->
	`»adBufãr
(
buf
, 
Ën
))

190 
	`lua_pushl¡ršg
(
L
, 
buf
, 
Ën
);

192 
	`lua_pushn
(
L
);

197 
	`ERR
Ğ"[BufãrNode] c_»ad_fÜm©, inv®id fÜm©: %c", 
fmt
[
i
] );

201  
Ën
;

202 
	}
}

	@script/lua/LuaBuffer.h

1 #iâdeà
__LUA_BUFFER_H__


2 
	#__LUA_BUFFER_H__


	)

4 
	~"k™sys.h
"

5 
	~<Bufãr.h
>

7 
	glua_S‹
;

25 şas 
	cLuaBufãr
 : 
public
 
k™
::
Bufãr


27 
public
:

28 
	$KIT_CREATE_FUNC
(
LuaBufãr
)

29 
št32_t
 
	`luaWr™eVeùÜ
(
lua_S‹
* 
L
);

30 
št32_t
 
	`luaR—dVeùÜ
(
lua_S‹
* 
L
);

32 
št32_t
 
	`luaWr™eFÜm©
(
lua_S‹
* 
L
);

33 
št32_t
 
	`luaR—dFÜm©
(
lua_S‹
* 
L
);

	@script/lua/LuaCore.cpp

1 
	~"LuaCÜe.h
"

2 
	~"LuaBšdšg.h
"

3 
	~"lua.hµ
"

4 
	~"Logg”.h
"

6 
	~"LuaDebug.h
"

8 
	gLuaCÜe
::
	$LuaCÜe
()

9 : 
	$L
(
NULL
)

11 
	}
}

13 
LuaCÜe
::~
	$LuaCÜe
()

15 ià(
L
)

16 
	`de¡roy
();

17 
	}
}

19 
boŞ
 
	gLuaCÜe
::
	$ba£In™
()

22 
L
 = 
	`luaL_Ãw¡©e
();

23 
	`luaL_İ’libs
(
L
);

25 
	`»gi¡”_CommÚCÚ¡ªt
(
L
);

26 
	`»gi¡”_NÜm®FunùiÚ
(
L
);

27 
	`»gi¡”_CÏss_Ref
(
L
);

28 
	`»gi¡”_CÏss_Logg”
(
L
);

29 
	`»gi¡”_CÏss_Tim”
(
L
);

30 
	`»gi¡”_CÏss_Bufãr
(
L
);

31 
	`»gi¡”_CÏss_BufãrPoŞ
(
L
);

32 
	`»gi¡”_CÏss_Pack‘
(
L
);

33 
	`»gi¡”_CÏss_PrÙocŞ
(
L
);

34 
	`»gi¡”_CÏss_T”mš®
(
L
);

35 
	`»gi¡”_CÏss_Cl›Á
(
L
);

36 
	`»gi¡”_CÏss_S”v”
(
L
);

37 
	`»gi¡”_CÏss_SütCÜe
(
L
);

38 
	`»gi¡”_CÏss_SütMªag”
(
L
);

39 
	`»gi¡”_CÏss_G—r
(
L
);

41 
	`DPART
(
	`»gi¡”_debug
(
L
));

43  
Œue
;

44 
	}
}

46 
	gLuaCÜe
::
	$de¡roy
()

48 
	`lua_şo£
(
L
);

49 
	}
}

51 
	gLuaCÜe
::
	$execu‹SŒšg
(cÚ¡ * 
codes
)

53 
»t
 = 
	`luaL_lßd¡ršg
(
L
, 
codes
);

54 ià(
»t
 !ğ
LUA_OK
)

56 
	`ERR
("[LuaCÜe]Óxecu‹SŒšgèç! %s", 
codes
);

59  
	`execu‹Func
(0);

60 
	}
}

62 
	gLuaCÜe
::
	$execu‹Fe
(cÚ¡ * 
fe_Çme
)

64 
¡d
::
¡ršg
 
fuÎ_·th
 = 
·th_
 + 
fe_Çme
;

66 
»t
 = 
	`luaL_lßdfe
(
L
, 
fuÎ_·th
.
	`c_¡r
());

67 ià(
»t
 !ğ
LUA_OK
)

69 
	`ERR
("[LuaCÜe]Óxecu‹Feèç! %s", 
fe_Çme
);

73  
	`execu‹Func
(0);

74 
	}
}

76 
	gLuaCÜe
::
	$execu‹FunùiÚ
(cÚ¡ * 
funùiÚ_Çme
)

78 
	`lua_g‘glob®
(
L
, 
funùiÚ_Çme
);

79 ià(!
	`lua_isfunùiÚ
(
L
, -1))

81 
	`ERR
("[LuaCÜe]Óxecu‹FunùiÚèç! %s", 
funùiÚ_Çme
);

82 
	`lua_pİ
(
L
, 1);

85  
	`execu‹Func
(0);

86 
	}
}

88 
	gLuaCÜe
::
	$execu‹Func
(
¬g_num
)

90 
func_šdex
 = -(
¬g_num
 + 1);

91 ià(!
	`lua_isfunùiÚ
(
L
, 
func_šdex
))

93 
	`LOG
("[LUA]v®u© sck[%d] i nÙ funùiÚ", 
func_šdex
);

94 
	`lua_pİ
(
L
, 
¬g_num
 + 1);

97 
Œaûback
 = 0;

98 
	`lua_g‘glob®
(
L
, "__G__TRACKBACK__");

99 ià(!
	`lua_isfunùiÚ
(
L
, -1))

101 
	`lua_pİ
(
L
, 1);

105 
	`lua_š£¹
(
L
, 
func_šdex
 - 1);

106 
Œaûback
 = 
func_šdex
 - 1;

108 
”rÜ
 = 0;

109 
”rÜ
 = 
	`lua_pÿÎ
(
L
, 
¬g_num
, 1, 
Œaûback
);

110 ià(
”rÜ
)

112 ià(
Œaûback
 == 0)

114 
	`LOG
("[LUA ERROR] %s", 
	`lua_to¡ršg
(
L
, -1));

115 
	`lua_pİ
(
L
, 1);

119 
	`lua_pİ
(
L
, 2);

125 
»t
 = 0;

126 ià(
	`lua_i¢umb”
(
L
, -1))

128 
»t
 = ()
	`lua_toš‹g”
(
L
, -1);

130 ià(
	`lua_isboŞ—n
(
L
, -1))

132 
»t
 = ()
	`lua_toboŞ—n
(
L
, -1);

134 
	`lua_pİ
(
L
, 1);

135 ià(
Œaûback
)

137 
	`lua_pİ
(
L
, 1);

140  
»t
;

141 
	}
}

	@script/lua/LuaCore.h

1 #iâdeà
__Lua_CORE_H__


2 
	#__Lua_CORE_H__


	)

4 
	~"SütSuµÜt.h
"

5 
	~"k™sys.h
"

7 
	glua_S‹
;

9 şas 
	cLuaCÜe
 : 
public
 
k™
::
SütCÜe


11 
public
:

12 
	$KIT_CREATE_FUNC
(
LuaCÜe
)

14 
	`LuaCÜe
();

15 
vœtu®
 ~
	`LuaCÜe
();

17 
vœtu®
 
k™
::
SütTy³
 
	$g‘SütTy³
(ècÚ¡ {  
k™
::
SCRIPT_TYPE_JAVASCRIPT
; }

19 
vœtu®
 
boŞ
 
	`ba£In™
();

21 
vœtu®
 
	`de¡roy
();

24 
vœtu®
 
	`execu‹SŒšg
(cÚ¡ * 
codes
);

25 
vœtu®
 
	`execu‹Fe
(cÚ¡ * 
f’ame
);

26 
vœtu®
 
	`execu‹FunùiÚ
(cÚ¡ * 
funùiÚ_Çme
);

27 
´Ùeùed
:

28 
	`execu‹Func
(
¬g_num
);

29 
´iv©e
:

30 
lua_S‹
* 
L
;

31 
	}
};

	@script/lua/LuaDebug.cpp

1 
	~"LuaDebug.h
"

2 
	~"lua.hµ
"

3 
	~"LuaIÁf/LuaIÁf.h
"

5 
	~"DebugIÅut.h
"

8 
	$»gi¡”_debug
(
lua_S‹
* 
L
)

10 
	`»gi¡”_CÏss_DebugIÅut
(
L
);

11 
	}
}

14 
	$»gi¡”_CÏss_DebugIÅut
(
lua_S‹
* 
L
)

16 
LuaIÁf
::
	`LuaBšdšg
(
L
)

17 .
	`begšModuË
("kit")

18 .
begšEx‹ndCÏss
<
k™
::
DebugIÅut
, k™::
Ref
>("debuginput")

19 .
	`addSticFunùiÚ
("ü—‹", &
k™
::
DebugIÅut
::
ü—‹
)

20 .
	`addFunùiÚ
("£t_hªdËr", &
k™
::
DebugIÅut
::
£tHªdËr
)

21 .
	`addFunùiÚ
("add_hªdËr", &
k™
::
DebugIÅut
::
addHªdËr
)

22 .
	`’dCÏss
()

23 .
	`’dModuË
();

24 
	}
}

	@script/lua/LuaDebug.h

1 #iâdeà
__LUA_DEBUG_H__


2 
	#__LUA_DEBUG_H__


	)

5 
	glua_S‹
;

7 
»gi¡”_debug
(
lua_S‹
* 
L
);

10 
»gi¡”_CÏss_DebugIÅut
(
lua_S‹
* 
L
);

	@script/lua/LuaFunctions.cpp

1 
	~"LuaFunùiÚs.h
"

2 
	~"FunùiÚs.h
"

3 
	~"lua.hµ
"

4 
	~"Logg”.h
"

6 
št32_t
 
	$luaS¶™
(
lua_S‹
* 
L
)

8 
št32_t
 
Çrg
 = 
	`lua_g‘tİ
(
L
);

9 ià(
Çrg
 != 2)

11 
	`ERR
("(luaSplit)‚arg < 3");

14 
size_t
 
Ën
;

15 cÚ¡ * 
‹xt
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
Ën
);

16 ià(!
‹xt
)

18 
	`ERR
("(luaSplit) invalidext");

22 cÚ¡ * 
£·¿tÜ
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
Ën
);

23 ià(!
£·¿tÜ
)

25 
	`ERR
("(luaSplit) invalid separator");

29 
¡d
::
veùÜ
<¡d::
¡ršg
> 
vec
;

31 ià(
Ën
 == 1)

33 
k™
::
	`¥l™
(
¡d
::
	`¡ršg
(
‹xt
), 
vec
, 
£·¿tÜ
[0]);

37 
k™
::
	`¥l™W™hSŒšg
(
¡d
::
	`¡ršg
(
‹xt
), 
vec
, std::¡ršg(
£·¿tÜ
));

39 
Ën
 = 
vec
.
	`size
();

40 autØ
s
 : 
vec
)

42 
	`lua_pushl¡ršg
(
L
, 
s
.
	`c_¡r
(), s.
	`Ëngth
());

44  (
št32_t
)
Ën
;

45 
	}
}

	@script/lua/LuaFunctions.h

1 #iâdeà
__LUA_FUNCTIONS_H__


2 
	#__LUA_FUNCTIONS_H__


	)

4 
	~"k™sys.h
"

6 
	glua_S‹
;

8 
št32_t
 
luaS¶™
(
lua_S‹
* 
L
);

	@script/lua/LuaProtocol.cpp

1 
	~"LuaPrÙocŞ.h
"

2 
	~<¡ack
>

3 
	~"lua.hµ
"

4 
	~"LuaIÁf/LuaIÁf.h
"

5 
	~"Logg”.h
"

6 
	~"FunùiÚs.h
"

8 
usšg
 
	g±
 = 
k™
::
PTTy³
;

26 
	gLuaPrÙocŞ
::
	$LuaPrÙocŞ
()

28 
	}
}

30 
LuaPrÙocŞ
::~
	$LuaPrÙocŞ
()

32 
	`KIT_SAFE_RELEASE
(
ü—tÜ_
);

33 
	}
}

35 
boŞ
 
	gLuaPrÙocŞ
::
	$ba£In™
()

37 
	`KIT_SAFE_RELEASE
(
ü—tÜ_
);

38 
ü—tÜ_
 = 
LuaPTC»©Ü
::
	`ü—‹
(
çl£
);

39  
k™
::
PrÙocŞ
::
	`ba£In™
();

40 
	}
}

42 
	gLuaPrÙocŞ
::
	$budFromTabË
(
lua_S‹
* 
L
)

44 
LuaIÁf
::
LuaRef
 
bË
 = LuaIÁf::
Lua
::
pİ
<LuaIÁf::LuaRef>(
L
);

45 ià(!
bË
.
	`isTabË
())

47 
	`ERR
("[LuaPrÙocŞ](budFromTabËè·¿m‚Ù‡abË!…id:%d", 
pid_
);

51 ià(!
	`»gi¡”TabË
(
this
, &
bË
))

53 
	`ERR
("[LuaPrÙocŞ](budFromTabËè»gi¡”ƒ¼Ü!…id:%d", 
pid_
);

56 
	}
}

58 
boŞ
 
	gLuaPrÙocŞ
::
	$»gi¡”TabË
(
k™
::
PTTabË
* 
p
, cÚ¡ 
LuaIÁf
::
LuaRef
* 
bË
)

60 auto& 
e
 : *
bË
)

62 autØ
v
 = 
e
.
v®ue
<
LuaIÁf
::
LuaRef
>();

63 ià(!
v
.
	`isTabË
())

65 
	`ERR
("[LuaPrÙocŞ]Ôegi¡”TabËèdesønÙabË! key:%s", 
e
.
key
<cÚ¡ 
¡d
::
¡ršg
&>().
	`c_¡r
());

66  
çl£
;

68 
Ën
 = 
v
.
	`Ën
();

69 ià(
Ën
 < 2)

71 
	`ERR
("[LuaPrÙocŞ]Ôegi¡”TabËènÙabË! key:%s", 
e
.
key
<cÚ¡ 
¡d
::
¡ršg
&>().
	`c_¡r
());

72  
çl£
;

74 
¡d
::
¡ršg
 
key
 = 
v
.
g‘
<std::string>(1);

75 
k™
::
PTTy³
 
ty³
 = 
¡©ic_ÿ¡
<k™::PTTy³>(
v
.
g‘
<
ušt8_t
>(2));

76 
k™
::
PTD©a
* 
šfo
 = 
ü—tÜ_
->
	`ü—‹PTD©a
(
ty³
);

77 ià(
šfo
 =ğ
NULL
)

79 
	`ERR
("[LuaPrÙocŞ]Ôegi¡”TabËè”rÜy³! key:%s,y³:%d", 
key
.
	`c_¡r
(), 
ty³
);

80  
çl£
;

82 
šfo
->
	`£tKey
(
key
);

83 
p
->
	`addD©a
(
šfo
);

85 ià(
ty³
 =ğ
k™
::
PTTy³
::
TABLE
)

87 autØ
sub_bË
 = 
v
.
g‘
<
LuaIÁf
::
LuaRef
>(3);

88 ià(!
sub_bË
.
	`isTabË
())

90 
	`ERR
("[LuaPrÙocŞ]Ôegi¡”TabËènÙabË! key:%s", 
key
.
	`c_¡r
());

91  
çl£
;

93 ià(!
	`»gi¡”TabË
(
»š‹½»t_ÿ¡
<
k™
::
PTTabË
*>(
šfo
), &
sub_bË
))

95  
çl£
;

98 ià(
ty³
 =ğ
k™
::
PTTy³
::
ARRAY
)

100 ià(
Ën
 < 3)

102 
	`ERR
("[LuaPrÙocŞ]Ôegi¡”TabËè¬¿y‚“d 3…¬am! key:%s", 
key
.
	`c_¡r
());

103  
çl£
;

105 autØ
™em_v
 = 
v
.
g‘
<
LuaIÁf
::
LuaRef
>(3);

106 ià(
™em_v
.
	`isTabË
())

108 autØ
™em_‹m¶©e
 = 
ü—tÜ_
->
	`ü—‹PTD©a
(
k™
::
PTTy³
::
ARRAY
);

109 ià(!
	`»gi¡”TabË
(
»š‹½»t_ÿ¡
<
k™
::
PTTabË
*>(
™em_‹m¶©e
), &
™em_v
))

110  
çl£
;

111 (
»š‹½»t_ÿ¡
<
k™
::
PTA¼ay
*>(
šfo
))->
	`£tTem¶©e
(
™em_‹m¶©e
);

115 
k™
::
PTTy³
 
™em_ty³
 = 
¡©ic_ÿ¡
<k™::PTTy³>(
™em_v
.
toV®ue
<
ušt8_t
>());

116 autØ
™em_‹m¶©e
 = 
ü—tÜ_
->
	`ü—‹PTD©a
(
™em_ty³
);

117 ià(
™em_‹m¶©e
 =ğ
NULL
)

119 
	`ERR
("[LuaPrÙocŞ]Ôegi¡”TabËè”ry¸ty³! key:%s", 
key
.
	`c_¡r
());

120  
çl£
;

122 (
»š‹½»t_ÿ¡
<
k™
::
PTA¼ay
*>(
šfo
))->
	`£tTem¶©e
(
™em_‹m¶©e
);

129  
Œue
;

130 
	}
}

132 
	gLuaPrÙocŞ
::
	$un£rŸlizeFromTabË
(
lua_S‹
* 
L
)

134 
LuaIÁf
::
LuaRef
 
bË
 = LuaIÁf::
Lua
::
pİ
<LuaIÁf::LuaRef>(
L
);

135 ià(!
bË
.
	`isTabË
())

137 
	`ERR
("[LuaPrÙocŞ](£rŸlizeFromTabËè·¿m‚Ù‡abË!…id:%d", 
pid_
);

140 
ü—tÜ_
->
	`£tD©aV®ue
(
this
, &
bË
);

141 
	}
}

143 
št32_t
 
	gLuaPrÙocŞ
::
	$£rŸlizeToTabË
(
lua_S‹
* 
L
)

146 
	}
}

150 
	gLuaPTC»©Ü
::
	$LuaPTC»©Ü
()

152 
v®ue_­is_
[
k™
::
	`tošt
(
±
::
INT8
)] = &
LuaPTC»©Ü
::
unsV®ue
<
št8_t
>;

153 
v®ue_­is_
[
k™
::
	`tošt
(
±
::
UINT8
)] = &
LuaPTC»©Ü
::
unsV®ue
<
ušt8_t
>;

154 
v®ue_­is_
[
k™
::
	`tošt
(
±
::
INT16
)] = &
LuaPTC»©Ü
::
unsV®ue
<
št16_t
>;

155 
v®ue_­is_
[
k™
::
	`tošt
(
±
::
UINT16
)] = &
LuaPTC»©Ü
::
unsV®ue
<
ušt16_t
>;

156 
v®ue_­is_
[
k™
::
	`tošt
(
±
::
INT32
)] = &
LuaPTC»©Ü
::
unsV®ue
<
št32_t
>;

157 
v®ue_­is_
[
k™
::
	`tošt
(
±
::
UINT32
)] = &
LuaPTC»©Ü
::
unsV®ue
<
ušt32_t
>;

158 
v®ue_­is_
[
k™
::
	`tošt
(
±
::
INT64
)] = &
LuaPTC»©Ü
::
unsV®ue
<
št64_t
>;

159 
v®ue_­is_
[
k™
::
	`tošt
(
±
::
UINT64
)] = &
LuaPTC»©Ü
::
unsV®ue
<
ušt64_t
>;

160 
v®ue_­is_
[
k™
::
	`tošt
(
±
::
VARINT
)] = &
LuaPTC»©Ü
::
unsV®ue
<
ušt32_t
>;

161 
v®ue_­is_
[
k™
::
	`tošt
(
±
::
STRING
)] = &
LuaPTC»©Ü
::
unsV®ue
<
¡d
::
¡ršg
>;

163 
v®ue_­is_
[
k™
::
	`tošt
(
±
::
ARRAY
)] = &
LuaPTC»©Ü
::
unsA¼ay
;

164 
v®ue_­is_
[
k™
::
	`tošt
(
±
::
TABLE
)] = &
LuaPTC»©Ü
::
unsTabË
;

165 
	}
}

167 
	gLuaPTC»©Ü
::~
	$LuaPTC»©Ü
()

169 
	}
}

171 
LuaPTC»©Ü
::
	$£tD©aV®ue
(
k™
::
PTD©a
* 
d©a
, cÚ¡ 
LuaIÁf
::
LuaRef
* 
t
)

173 
±
 
ty³
 = 
d©a
->
	`g‘Ty³
();

174 
	`DCHECK
(
ty³
 !ğ
±
::
NONE
 &&y³ !ğ±::
MAX
,

175 
k™
::
	`fÜm©SŒšg
("[LuaPTC»©Ü](£tD©aV®ueèšv®idy³: %d", k™::
	`tošt
(
ty³
)).
	`c_¡r
());

176 
PTV®ueAPI
 
func
 = 
v®ue_­is_
[
k™
::
	`tošt
(
ty³
)];

177 ((
this
->*(
func
))(
d©a
, 
t
));

178 
	}
}

180 
	g‹m¶©e
<
ty³Çme
 
	gT
>

181 
	gLuaPTC»©Ü
::
	$unsV®ue
(
k™
::
PTD©a
* 
d©a
, cÚ¡ 
LuaIÁf
::
LuaRef
* 
t
)

183 
k™
::
PTV®ue
<
T
>* 
p
 = 
»š‹½»t_ÿ¡
<k™::PTV®ue<T>*>(
d©a
);

184 
p
->
	`£tV®ue
(
t
->
toV®ue
<
T
>());

185 
	}
}

187 
	gLuaPTC»©Ü
::
	$unsA¼ay
(
k™
::
PTD©a
* 
d©a
, cÚ¡ 
LuaIÁf
::
LuaRef
* 
bË
)

189 
k™
::
PTA¼ay
* 
¬¿y
 = 
»š‹½»t_ÿ¡
<k™::PTA¼ay*>(
d©a
);

190 
¬¿y
->
	`ş—r
();

191 
Ën
 = 
bË
->
	`Ën
();

192 
i
 = 1; i <ğ
Ën
; ++i)

194 autØ
»f
 = 
bË
->
	`g‘
(
i
);

195 autØ
™em
 = 
¬¿y
->
	`şÚeI‹m
();

196 
	`£tD©aV®ue
(
™em
, &
»f
);

197 
¬¿y
->
	`addD©a
(
™em
);

199 
	}
}

201 
	gLuaPTC»©Ü
::
	$unsTabË
(
k™
::
PTD©a
* 
d©a
, cÚ¡ 
LuaIÁf
::
LuaRef
* 
bË
)

203 
k™
::
PTTabË
* 
t
 = 
»š‹½»t_ÿ¡
<k™::PTTabË*>(
d©a
);

204 autØ
p
 : 
t
->
	`g‘D©as
())

206 cÚ¡ 
¡d
::
¡ršg
& 
key
 = 
p
->
	`g‘Key
();

207 ià(
bË
->
	`has
(
key
))

209 
LuaIÁf
::
LuaRef
 
subbË
 = 
bË
->
	`g‘
(
key
);

210 
	`£tD©aV®ue
(
p
, &
subbË
);

212 
p
->
	`»£tV®ue
();

215 
	}
}

	@script/lua/LuaProtocol.h

1 #iâdeà
__LUA_PROTOCOL_H__


2 
	#__LUA_PROTOCOL_H__


	)

4 
	~"PrÙocŞ.h
"

6 
	glua_S‹
;

7 
şass
 
	gLuaPTC»©Ü
;

9 
Çme¥aû
 
	gLuaIÁf
 {

10 
şass
 
	gLuaRef
;

13 şas 
	cLuaPrÙocŞ
 : 
public
 
k™
::
PrÙocŞ


15 
public
:

16 
	$KIT_CREATE_FUNC
(
LuaPrÙocŞ
)

17 
	`LuaPrÙocŞ
();

18 
vœtu®
 ~
	`LuaPrÙocŞ
();

20 
vœtu®
 
boŞ
 
	`ba£In™
();

22 
	`budFromTabË
(
lua_S‹
* 
L
);

24 
	`un£rŸlizeFromTabË
(
lua_S‹
* 
L
);

25 
št32_t
 
	`£rŸlizeToTabË
(
lua_S‹
* 
L
);

26 
´iv©e
:

27 
boŞ
 
	`»gi¡”TabË
(
k™
::
PTTabË
* 
p
, cÚ¡ 
LuaIÁf
::
LuaRef
* 
bË
);

29 
LuaPTC»©Ü
* 
ü—tÜ_
 = 
nuÎ±r
;

32 şas 
	cLuaPTC»©Ü
 : 
public
 
k™
::
PTD©aC»©Ü


34 
public
:

35 
	$KIT_CREATE_FUNC
(
LuaPTC»©Ü
)

36 
	`LuaPTC»©Ü
();

37 
vœtu®
 ~
	`LuaPTC»©Ü
();

38 
	`£tD©aV®ue
(
k™
::
PTD©a
* 
d©a
, cÚ¡ 
LuaIÁf
::
LuaRef
* 
t
);

39 
´iv©e
:

40 
‹m¶©e
<
ty³Çme
 
T
>

41 
	`unsV®ue
(
k™
::
PTD©a
* 
d©a
, cÚ¡ 
LuaIÁf
::
LuaRef
* 
t
);

42 
	`unsA¼ay
(
k™
::
PTD©a
* 
d©a
, cÚ¡ 
LuaIÁf
::
LuaRef
* 
bË
);

43 
	`unsTabË
(
k™
::
PTD©a
* 
d©a
, cÚ¡ 
LuaIÁf
::
LuaRef
* 
bË
);

45 (
	tLuaPTC»©Ü
::* 
	tPTV®ueAPI
)(
	tk™
::
	tPTD©a
*, cÚ¡ 
	tLuaIÁf
::
	tLuaRef
*);

46 
PTV®ueAPI
 
v®ue_­is_
[
	`tošt
(
k™
::
PTTy³
::
MAX
)];

	@script/lua/lua-5.3.4/src/lapi.c

7 
	#Ïpi_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡d¬g.h
>

14 
	~<¡ršg.h
>

16 
	~"lua.h
"

18 
	~"Ïpi.h
"

19 
	~"ldebug.h
"

20 
	~"ldo.h
"

21 
	~"lfunc.h
"

22 
	~"lgc.h
"

23 
	~"lmem.h
"

24 
	~"lobjeù.h
"

25 
	~"l¡©e.h
"

26 
	~"l¡ršg.h
"

27 
	~"ÉabË.h
"

28 
	~"Ém.h
"

29 
	~"lundump.h
"

30 
	~"lvm.h
"

34 cÚ¡ 
	glua_id’t
[] =

35 "$LuaV”siÚ: " 
LUA_COPYRIGHT
 " $"

36 "$LuaAuthÜs: " 
LUA_AUTHORS
 " $";

40 
	#NONVALIDVALUE
 
	`ÿ¡
(
TV®ue
 *, 
luaO_nobjeù
)

	)

43 
	#isv®id
(
o
è((oè!ğ
luaO_nobjeù
)

	)

46 
	#i¥£udo
(
i
è((iè<ğ
LUA_REGISTRYINDEX
)

	)

49 
	#isupv®ue
(
i
è((iè< 
LUA_REGISTRYINDEX
)

	)

52 
	#is¡ackšdex
(
i
, 
o
è(
	`isv®id
(oè&& !
	`i¥£udo
(i))

	)

54 
	#­i_checkv®idšdex
(
l
,
o
è
	`­i_check
Ö, 
	`isv®id
(o), "šv®id index")

	)

56 
	#­i_check¡ackšdex
(
l
, 
i
, 
o
) \

57 
	`­i_check
(
l
, 
	`is¡ackšdex
(
i
, 
o
), "šdex‚Ù iÀth¡ack")

	)

60 
TV®ue
 *
	$šdex2addr
 (
lua_S‹
 *
L
, 
idx
) {

61 
C®lInfo
 *
ci
 = 
L
->ci;

62 ià(
idx
 > 0) {

63 
TV®ue
 *
o
 = 
ci
->
func
 + 
idx
;

64 
	`­i_check
(
L
, 
idx
 <ğ
ci
->
tİ
 - (ci->
func
 + 1), "unacceptable index");

65 ià(
o
 >ğ
L
->
tİ
è 
NONVALIDVALUE
;

66  
o
;

68 ià(!
	`i¥£udo
(
idx
)) {

69 
	`­i_check
(
L
, 
idx
 !ğ0 && -idx <ğL->
tİ
 - (
ci
->
func
 + 1), "invalid index");

70  
L
->
tİ
 + 
idx
;

72 ià(
idx
 =ğ
LUA_REGISTRYINDEX
)

73  &
	`G
(
L
)->
l_»gi¡ry
;

75 
idx
 = 
LUA_REGISTRYINDEX
 - idx;

76 
	`­i_check
(
L
, 
idx
 <ğ
MAXUPVAL
 + 1, "upvalue indexoo†arge");

77 ià(
	`‰i¦cf
(
ci
->
func
))

78  
NONVALIDVALUE
;

80 
CClosu»
 *
func
 = 
	`şCv®ue
(
ci
->func);

81  (
idx
 <ğ
func
->
nupv®ues
è? &func->
upv®ue
[idx-1] : 
NONVALIDVALUE
;

84 
	}
}

91 
	$grow¡ack
 (
lua_S‹
 *
L
, *
ud
) {

92 
size
 = *(*)
ud
;

93 
	`luaD_grow¡ack
(
L
, 
size
);

94 
	}
}

97 
LUA_API
 
	$lua_check¡ack
 (
lua_S‹
 *
L
, 
n
) {

98 
»s
;

99 
C®lInfo
 *
ci
 = 
L
->ci;

100 
	`lua_lock
(
L
);

101 
	`­i_check
(
L
, 
n
 >= 0, "negative 'n'");

102 ià(
L
->
¡ack_Ï¡
 - L->
tİ
 > 
n
)

103 
»s
 = 1;

105 
šu£
 = 
	`ÿ¡_št
(
L
->
tİ
 - L->
¡ack
è+ 
EXTRA_STACK
;

106 ià(
šu£
 > 
LUAI_MAXSTACK
 - 
n
)

107 
»s
 = 0;

109 
»s
 = (
	`luaD_¿wruÅrÙeùed
(
L
, &
grow¡ack
, &
n
è=ğ
LUA_OK
);

111 ià(
»s
 && 
ci
->
tİ
 < 
L
->tİ + 
n
)

112 
ci
->
tİ
 = 
L
->tİ + 
n
;

113 
	`lua_uÆock
(
L
);

114  
»s
;

115 
	}
}

118 
LUA_API
 
	$lua_xmove
 (
lua_S‹
 *
äom
,†ua_S‹ *
to
, 
n
) {

119 
i
;

120 ià(
äom
 =ğ
to
) ;

121 
	`lua_lock
(
to
);

122 
	`­i_checkÃËms
(
äom
, 
n
);

123 
	`­i_check
(
äom
, 
	`G
(äomè=ğG(
to
), "moving‡mong independent states");

124 
	`­i_check
(
äom
, 
to
->
ci
->
tİ
 -o->tİ >ğ
n
, "stack overflow");

125 
äom
->
tİ
 -ğ
n
;

126 
i
 = 0; i < 
n
; i++) {

127 
	`£tobj2s
(
to
,o->
tİ
, 
äom
->tİ + 
i
);

128 
to
->
tİ
++;

130 
	`lua_uÆock
(
to
);

131 
	}
}

134 
LUA_API
 
lua_CFunùiÚ
 
	$lua_©·nic
 (
lua_S‹
 *
L
, 
lua_CFunùiÚ
 
·nicf
) {

135 
lua_CFunùiÚ
 
Şd
;

136 
	`lua_lock
(
L
);

137 
Şd
 = 
	`G
(
L
)->
·nic
;

138 
	`G
(
L
)->
·nic
 = 
·nicf
;

139 
	`lua_uÆock
(
L
);

140  
Şd
;

141 
	}
}

144 
LUA_API
 cÚ¡ 
lua_Numb”
 *
	$lua_v”siÚ
 (
lua_S‹
 *
L
) {

145 cÚ¡ 
lua_Numb”
 
v”siÚ
 = 
LUA_VERSION_NUM
;

146 ià(
L
 =ğ
NULL
è &
v”siÚ
;

147  
	`G
(
L
)->
v”siÚ
;

148 
	}
}

160 
LUA_API
 
	$lua_absšdex
 (
lua_S‹
 *
L
, 
idx
) {

161  (
idx
 > 0 || 
	`i¥£udo
(idx))

162 ? 
idx


163 : 
	`ÿ¡_št
(
L
->
tİ
 - L->
ci
->
func
è+ 
idx
;

164 
	}
}

167 
LUA_API
 
	$lua_g‘tİ
 (
lua_S‹
 *
L
) {

168  
	`ÿ¡_št
(
L
->
tİ
 - (L->
ci
->
func
 + 1));

169 
	}
}

172 
LUA_API
 
	$lua_£‰İ
 (
lua_S‹
 *
L
, 
idx
) {

173 
StkId
 
func
 = 
L
->
ci
->func;

174 
	`lua_lock
(
L
);

175 ià(
idx
 >= 0) {

176 
	`­i_check
(
L
, 
idx
 <ğL->
¡ack_Ï¡
 - (
func
 + 1), "newopoo†arge");

177 
L
->
tİ
 < (
func
 + 1è+ 
idx
)

178 
	`£Šv®ue
(
L
->
tİ
++);

179 
L
->
tİ
 = (
func
 + 1è+ 
idx
;

182 
	`­i_check
(
L
, -(
idx
+1è<ğ(L->
tİ
 - (
func
 + 1)), "invalid‚ewop");

183 
L
->
tİ
 +ğ
idx
+1;

185 
	`lua_uÆock
(
L
);

186 
	}
}

193 
	$»v”£
 (
lua_S‹
 *
L
, 
StkId
 
äom
, StkId 
to
) {

194 ; 
äom
 < 
to
; from++,o--) {

195 
TV®ue
 
‹mp
;

196 
	`£tobj
(
L
, &
‹mp
, 
äom
);

197 
	`£tobjs2s
(
L
, 
äom
, 
to
);

198 
	`£tobj2s
(
L
, 
to
, &
‹mp
);

200 
	}
}

207 
LUA_API
 
	$lua_rÙ©e
 (
lua_S‹
 *
L
, 
idx
, 
n
) {

208 
StkId
 
p
, 
t
, 
m
;

209 
	`lua_lock
(
L
);

210 
t
 = 
L
->
tİ
 - 1;

211 
p
 = 
	`šdex2addr
(
L
, 
idx
);

212 
	`­i_check¡ackšdex
(
L
, 
idx
, 
p
);

213 
	`­i_check
(
L
, (
n
 >ğ0 ?‚ : -nè<ğ(
t
 - 
p
 + 1), "invalid 'n'");

214 
m
 = (
n
 >ğ0 ? 
t
 -‚ : 
p
 -‚ - 1);

215 
	`»v”£
(
L
, 
p
, 
m
);

216 
	`»v”£
(
L
, 
m
 + 1, 
t
);

217 
	`»v”£
(
L
, 
p
, 
t
);

218 
	`lua_uÆock
(
L
);

219 
	}
}

222 
LUA_API
 
	$lua_cİy
 (
lua_S‹
 *
L
, 
äomidx
, 
toidx
) {

223 
TV®ue
 *
ä
, *
to
;

224 
	`lua_lock
(
L
);

225 
ä
 = 
	`šdex2addr
(
L
, 
äomidx
);

226 
to
 = 
	`šdex2addr
(
L
, 
toidx
);

227 
	`­i_checkv®idšdex
(
L
, 
to
);

228 
	`£tobj
(
L
, 
to
, 
ä
);

229 ià(
	`isupv®ue
(
toidx
))

230 
	`luaC_b¬r›r
(
L
, 
	`şCv®ue
(L->
ci
->
func
), 
ä
);

233 
	`lua_uÆock
(
L
);

234 
	}
}

237 
LUA_API
 
	$lua_pushv®ue
 (
lua_S‹
 *
L
, 
idx
) {

238 
	`lua_lock
(
L
);

239 
	`£tobj2s
(
L
, L->
tİ
, 
	`šdex2addr
(L, 
idx
));

240 
	`­i_šü_tİ
(
L
);

241 
	`lua_uÆock
(
L
);

242 
	}
}

251 
LUA_API
 
	$lua_ty³
 (
lua_S‹
 *
L
, 
idx
) {

252 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
idx
);

253  (
	`isv®id
(
o
è? 
	`‰nov
(oè: 
LUA_TNONE
);

254 
	}
}

257 
LUA_API
 cÚ¡ *
	$lua_ty³Çme
 (
lua_S‹
 *
L
, 
t
) {

258 
	`UNUSED
(
L
);

259 
	`­i_check
(
L
, 
LUA_TNONE
 <ğ
t
 && < 
LUA_NUMTAGS
, "invalidag");

260  
	`‰y³Çme
(
t
);

261 
	}
}

264 
LUA_API
 
	$lua_iscfunùiÚ
 (
lua_S‹
 *
L
, 
idx
) {

265 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
idx
);

266  (
	`‰i¦cf
(
o
è|| (
	`‰isCşosu»
(o)));

267 
	}
}

270 
LUA_API
 
	$lua_isš‹g”
 (
lua_S‹
 *
L
, 
idx
) {

271 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
idx
);

272  
	`‰isš‹g”
(
o
);

273 
	}
}

276 
LUA_API
 
	$lua_i¢umb”
 (
lua_S‹
 *
L
, 
idx
) {

277 
lua_Numb”
 
n
;

278 cÚ¡ 
TV®ue
 *
o
 = 
	`šdex2addr
(
L
, 
idx
);

279  
	`tÚumb”
(
o
, &
n
);

280 
	}
}

283 
LUA_API
 
	$lua_is¡ršg
 (
lua_S‹
 *
L
, 
idx
) {

284 cÚ¡ 
TV®ue
 *
o
 = 
	`šdex2addr
(
L
, 
idx
);

285  (
	`‰is¡ršg
(
o
è|| 
	`cvt2¡r
(o));

286 
	}
}

289 
LUA_API
 
	$lua_isu£rd©a
 (
lua_S‹
 *
L
, 
idx
) {

290 cÚ¡ 
TV®ue
 *
o
 = 
	`šdex2addr
(
L
, 
idx
);

291  (
	`‰isfuÎu£rd©a
(
o
è|| 
	`‰i¦ightu£rd©a
(o));

292 
	}
}

295 
LUA_API
 
	$lua_¿wequ®
 (
lua_S‹
 *
L
, 
šdex1
, 
šdex2
) {

296 
StkId
 
o1
 = 
	`šdex2addr
(
L
, 
šdex1
);

297 
StkId
 
o2
 = 
	`šdex2addr
(
L
, 
šdex2
);

298  (
	`isv®id
(
o1
è&& isv®id(
o2
)è? 
	`luaV_¿wequ®obj
(o1, o2) : 0;

299 
	}
}

302 
LUA_API
 
	$lua_¬™h
 (
lua_S‹
 *
L
, 
İ
) {

303 
	`lua_lock
(
L
);

304 ià(
İ
 !ğ
LUA_OPUNM
 && o°!ğ
LUA_OPBNOT
)

305 
	`­i_checkÃËms
(
L
, 2);

307 
	`­i_checkÃËms
(
L
, 1);

308 
	`£tobjs2s
(
L
, L->
tİ
, L->top - 1);

309 
	`­i_šü_tİ
(
L
);

312 
	`luaO_¬™h
(
L
, 
İ
, L->
tİ
 - 2, L->top - 1, L->top - 2);

313 
L
->
tİ
--;

314 
	`lua_uÆock
(
L
);

315 
	}
}

318 
LUA_API
 
	$lua_com·»
 (
lua_S‹
 *
L
, 
šdex1
, 
šdex2
, 
İ
) {

319 
StkId
 
o1
, 
o2
;

320 
i
 = 0;

321 
	`lua_lock
(
L
);

322 
o1
 = 
	`šdex2addr
(
L
, 
šdex1
);

323 
o2
 = 
	`šdex2addr
(
L
, 
šdex2
);

324 ià(
	`isv®id
(
o1
è&& isv®id(
o2
)) {

325 
İ
) {

326 
LUA_OPEQ
: 
i
 = 
	`luaV_equ®obj
(
L
, 
o1
, 
o2
); ;

327 
LUA_OPLT
: 
i
 = 
	`luaV_Ës¡hª
(
L
, 
o1
, 
o2
); ;

328 
LUA_OPLE
: 
i
 = 
	`luaV_Ës£qu®
(
L
, 
o1
, 
o2
); ;

329 : 
	`­i_check
(
L
, 0, "invalid option");

332 
	`lua_uÆock
(
L
);

333  
i
;

334 
	}
}

337 
LUA_API
 
size_t
 
	$lua_¡ršgtÚumb”
 (
lua_S‹
 *
L
, cÚ¡ *
s
) {

338 
size_t
 
sz
 = 
	`luaO_¡r2num
(
s
, 
L
->
tİ
);

339 ià(
sz
 != 0)

340 
	`­i_šü_tİ
(
L
);

341  
sz
;

342 
	}
}

345 
LUA_API
 
lua_Numb”
 
	$lua_tÚumb”x
 (
lua_S‹
 *
L
, 
idx
, *
pi¢um
) {

346 
lua_Numb”
 
n
;

347 cÚ¡ 
TV®ue
 *
o
 = 
	`šdex2addr
(
L
, 
idx
);

348 
i¢um
 = 
	`tÚumb”
(
o
, &
n
);

349 ià(!
i¢um
)

350 
n
 = 0;

351 ià(
pi¢um
è*pi¢um = 
i¢um
;

352  
n
;

353 
	}
}

356 
LUA_API
 
lua_IÁeg”
 
	$lua_toš‹g”x
 (
lua_S‹
 *
L
, 
idx
, *
pi¢um
) {

357 
lua_IÁeg”
 
»s
;

358 cÚ¡ 
TV®ue
 *
o
 = 
	`šdex2addr
(
L
, 
idx
);

359 
i¢um
 = 
	`toš‹g”
(
o
, &
»s
);

360 ià(!
i¢um
)

361 
»s
 = 0;

362 ià(
pi¢um
è*pi¢um = 
i¢um
;

363  
»s
;

364 
	}
}

367 
LUA_API
 
	$lua_toboŞ—n
 (
lua_S‹
 *
L
, 
idx
) {

368 cÚ¡ 
TV®ue
 *
o
 = 
	`šdex2addr
(
L
, 
idx
);

369  !
	`l_isçl£
(
o
);

370 
	}
}

373 
LUA_API
 cÚ¡ *
	$lua_tŞ¡ršg
 (
lua_S‹
 *
L
, 
idx
, 
size_t
 *
Ën
) {

374 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
idx
);

375 ià(!
	`‰is¡ršg
(
o
)) {

376 ià(!
	`cvt2¡r
(
o
)) {

377 ià(
Ën
 !ğ
NULL
) *len = 0;

378  
NULL
;

380 
	`lua_lock
(
L
);

381 
	`luaO_to¡ršg
(
L
, 
o
);

382 
	`luaC_checkGC
(
L
);

383 
o
 = 
	`šdex2addr
(
L
, 
idx
);

384 
	`lua_uÆock
(
L
);

386 ià(
Ën
 !ğ
NULL
)

387 *
Ën
 = 
	`v¦’
(
o
);

388  
	`sv®ue
(
o
);

389 
	}
}

392 
LUA_API
 
size_t
 
	$lua_¿wËn
 (
lua_S‹
 *
L
, 
idx
) {

393 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
idx
);

394 
	`‰y³
(
o
)) {

395 
LUA_TSHRSTR
:  
	`tsv®ue
(
o
)->
sh¾’
;

396 
LUA_TLNGSTR
:  
	`tsv®ue
(
o
)->
u
.
ÊgËn
;

397 
LUA_TUSERDATA
:  
	`uv®ue
(
o
)->
Ën
;

398 
LUA_TTABLE
:  
	`luaH_g‘n
(
	`hv®ue
(
o
));

401 
	}
}

404 
LUA_API
 
lua_CFunùiÚ
 
	$lua_tocfunùiÚ
 (
lua_S‹
 *
L
, 
idx
) {

405 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
idx
);

406 ià(
	`‰i¦cf
(
o
)è 
	`fv®ue
(o);

407 ià(
	`‰isCşosu»
(
o
))

408  
	`şCv®ue
(
o
)->
f
;

409  
NULL
;

410 
	}
}

413 
LUA_API
 *
	$lua_tou£rd©a
 (
lua_S‹
 *
L
, 
idx
) {

414 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
idx
);

415 
	`‰nov
(
o
)) {

416 
LUA_TUSERDATA
:  
	`g‘ud©amem
(
	`uv®ue
(
o
));

417 
LUA_TLIGHTUSERDATA
:  
	`pv®ue
(
o
);

418 :  
NULL
;

420 
	}
}

423 
LUA_API
 
lua_S‹
 *
	$lua_tÙh»ad
 (
lua_S‹
 *
L
, 
idx
) {

424 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
idx
);

425  (!
	`‰i¡h»ad
(
o
)è? 
NULL
 : 
	`thv®ue
(o);

426 
	}
}

429 
LUA_API
 cÚ¡ *
	$lua_tİoš‹r
 (
lua_S‹
 *
L
, 
idx
) {

430 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
idx
);

431 
	`‰y³
(
o
)) {

432 
LUA_TTABLE
:  
	`hv®ue
(
o
);

433 
LUA_TLCL
:  
	`şLv®ue
(
o
);

434 
LUA_TCCL
:  
	`şCv®ue
(
o
);

435 
LUA_TLCF
:  
	`ÿ¡
(*, ca¡(
size_t
, 
	`fv®ue
(
o
)));

436 
LUA_TTHREAD
:  
	`thv®ue
(
o
);

437 
LUA_TUSERDATA
:  
	`g‘ud©amem
(
	`uv®ue
(
o
));

438 
LUA_TLIGHTUSERDATA
:  
	`pv®ue
(
o
);

439 :  
NULL
;

441 
	}
}

450 
LUA_API
 
	$lua_pushn
 (
lua_S‹
 *
L
) {

451 
	`lua_lock
(
L
);

452 
	`£Šv®ue
(
L
->
tİ
);

453 
	`­i_šü_tİ
(
L
);

454 
	`lua_uÆock
(
L
);

455 
	}
}

458 
LUA_API
 
	$lua_pushnumb”
 (
lua_S‹
 *
L
, 
lua_Numb”
 
n
) {

459 
	`lua_lock
(
L
);

460 
	`£tætv®ue
(
L
->
tİ
, 
n
);

461 
	`­i_šü_tİ
(
L
);

462 
	`lua_uÆock
(
L
);

463 
	}
}

466 
LUA_API
 
	$lua_pushš‹g”
 (
lua_S‹
 *
L
, 
lua_IÁeg”
 
n
) {

467 
	`lua_lock
(
L
);

468 
	`£tiv®ue
(
L
->
tİ
, 
n
);

469 
	`­i_šü_tİ
(
L
);

470 
	`lua_uÆock
(
L
);

471 
	}
}

479 
LUA_API
 cÚ¡ *
	$lua_pushl¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
s
, 
size_t
 
Ën
) {

480 
TSŒšg
 *
ts
;

481 
	`lua_lock
(
L
);

482 
ts
 = (
Ën
 =ğ0è? 
	`luaS_Ãw
(
L
, ""è: 
	`luaS_Ãwl¡r
(L, 
s
,†en);

483 
	`£tsv®ue2s
(
L
, L->
tİ
, 
ts
);

484 
	`­i_šü_tİ
(
L
);

485 
	`luaC_checkGC
(
L
);

486 
	`lua_uÆock
(
L
);

487  
	`g‘¡r
(
ts
);

488 
	}
}

491 
LUA_API
 cÚ¡ *
	$lua_push¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
s
) {

492 
	`lua_lock
(
L
);

493 ià(
s
 =ğ
NULL
)

494 
	`£Šv®ue
(
L
->
tİ
);

496 
TSŒšg
 *
ts
;

497 
ts
 = 
	`luaS_Ãw
(
L
, 
s
);

498 
	`£tsv®ue2s
(
L
, L->
tİ
, 
ts
);

499 
s
 = 
	`g‘¡r
(
ts
);

501 
	`­i_šü_tİ
(
L
);

502 
	`luaC_checkGC
(
L
);

503 
	`lua_uÆock
(
L
);

504  
s
;

505 
	}
}

508 
LUA_API
 cÚ¡ *
	$lua_pushvf¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
,

509 
va_li¡
 
¬gp
) {

510 cÚ¡ *
»t
;

511 
	`lua_lock
(
L
);

512 
»t
 = 
	`luaO_pushvf¡ršg
(
L
, 
fmt
, 
¬gp
);

513 
	`luaC_checkGC
(
L
);

514 
	`lua_uÆock
(
L
);

515  
»t
;

516 
	}
}

519 
LUA_API
 cÚ¡ *
	$lua_pushf¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...) {

520 cÚ¡ *
»t
;

521 
va_li¡
 
¬gp
;

522 
	`lua_lock
(
L
);

523 
	`va_¡¬t
(
¬gp
, 
fmt
);

524 
»t
 = 
	`luaO_pushvf¡ršg
(
L
, 
fmt
, 
¬gp
);

525 
	`va_’d
(
¬gp
);

526 
	`luaC_checkGC
(
L
);

527 
	`lua_uÆock
(
L
);

528  
»t
;

529 
	}
}

532 
LUA_API
 
	$lua_pushcşosu»
 (
lua_S‹
 *
L
, 
lua_CFunùiÚ
 
â
, 
n
) {

533 
	`lua_lock
(
L
);

534 ià(
n
 == 0) {

535 
	`£tfv®ue
(
L
->
tİ
, 
â
);

538 
CClosu»
 *
ş
;

539 
	`­i_checkÃËms
(
L
, 
n
);

540 
	`­i_check
(
L
, 
n
 <ğ
MAXUPVAL
, "upvalue indexoo†arge");

541 
ş
 = 
	`luaF_ÃwCşosu»
(
L
, 
n
);

542 
ş
->
f
 = 
â
;

543 
L
->
tİ
 -ğ
n
;

544 
n
--) {

545 
	`£tobj2n
(
L
, &
ş
->
upv®ue
[
n
], L->
tİ
 +‚);

548 
	`£tşCv®ue
(
L
, L->
tİ
, 
ş
);

550 
	`­i_šü_tİ
(
L
);

551 
	`luaC_checkGC
(
L
);

552 
	`lua_uÆock
(
L
);

553 
	}
}

556 
LUA_API
 
	$lua_pushboŞ—n
 (
lua_S‹
 *
L
, 
b
) {

557 
	`lua_lock
(
L
);

558 
	`£tbv®ue
(
L
->
tİ
, (
b
 != 0));

559 
	`­i_šü_tİ
(
L
);

560 
	`lua_uÆock
(
L
);

561 
	}
}

564 
LUA_API
 
	$lua_pushlightu£rd©a
 (
lua_S‹
 *
L
, *
p
) {

565 
	`lua_lock
(
L
);

566 
	`£v®ue
(
L
->
tİ
, 
p
);

567 
	`­i_šü_tİ
(
L
);

568 
	`lua_uÆock
(
L
);

569 
	}
}

572 
LUA_API
 
	$lua_pushth»ad
 (
lua_S‹
 *
L
) {

573 
	`lua_lock
(
L
);

574 
	`£‰hv®ue
(
L
, L->
tİ
, L);

575 
	`­i_šü_tİ
(
L
);

576 
	`lua_uÆock
(
L
);

577  (
	`G
(
L
)->
mašth»ad
 == L);

578 
	}
}

587 
	$auxg‘¡r
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t
, cÚ¡ *
k
) {

588 cÚ¡ 
TV®ue
 *
¦Ù
;

589 
TSŒšg
 *
¡r
 = 
	`luaS_Ãw
(
L
, 
k
);

590 ià(
	`luaV_ç¡g‘
(
L
, 
t
, 
¡r
, 
¦Ù
, 
luaH_g‘¡r
)) {

591 
	`£tobj2s
(
L
, L->
tİ
, 
¦Ù
);

592 
	`­i_šü_tİ
(
L
);

595 
	`£tsv®ue2s
(
L
, L->
tİ
, 
¡r
);

596 
	`­i_šü_tİ
(
L
);

597 
	`luaV_fšishg‘
(
L
, 
t
, L->
tİ
 - 1, L->tİ - 1, 
¦Ù
);

599 
	`lua_uÆock
(
L
);

600  
	`‰nov
(
L
->
tİ
 - 1);

601 
	}
}

604 
LUA_API
 
	$lua_g‘glob®
 (
lua_S‹
 *
L
, cÚ¡ *
Çme
) {

605 
TabË
 *
»g
 = 
	`hv®ue
(&
	`G
(
L
)->
l_»gi¡ry
);

606 
	`lua_lock
(
L
);

607  
	`auxg‘¡r
(
L
, 
	`luaH_g‘št
(
»g
, 
LUA_RIDX_GLOBALS
), 
Çme
);

608 
	}
}

611 
LUA_API
 
	$lua_g‘bË
 (
lua_S‹
 *
L
, 
idx
) {

612 
StkId
 
t
;

613 
	`lua_lock
(
L
);

614 
t
 = 
	`šdex2addr
(
L
, 
idx
);

615 
	`luaV_g‘bË
(
L
, 
t
, L->
tİ
 - 1, L->top - 1);

616 
	`lua_uÆock
(
L
);

617  
	`‰nov
(
L
->
tİ
 - 1);

618 
	}
}

621 
LUA_API
 
	$lua_g‘f›ld
 (
lua_S‹
 *
L
, 
idx
, cÚ¡ *
k
) {

622 
	`lua_lock
(
L
);

623  
	`auxg‘¡r
(
L
, 
	`šdex2addr
(L, 
idx
), 
k
);

624 
	}
}

627 
LUA_API
 
	$lua_g‘i
 (
lua_S‹
 *
L
, 
idx
, 
lua_IÁeg”
 
n
) {

628 
StkId
 
t
;

629 cÚ¡ 
TV®ue
 *
¦Ù
;

630 
	`lua_lock
(
L
);

631 
t
 = 
	`šdex2addr
(
L
, 
idx
);

632 ià(
	`luaV_ç¡g‘
(
L
, 
t
, 
n
, 
¦Ù
, 
luaH_g‘št
)) {

633 
	`£tobj2s
(
L
, L->
tİ
, 
¦Ù
);

634 
	`­i_šü_tİ
(
L
);

637 
	`£tiv®ue
(
L
->
tİ
, 
n
);

638 
	`­i_šü_tİ
(
L
);

639 
	`luaV_fšishg‘
(
L
, 
t
, L->
tİ
 - 1, L->tİ - 1, 
¦Ù
);

641 
	`lua_uÆock
(
L
);

642  
	`‰nov
(
L
->
tİ
 - 1);

643 
	}
}

646 
LUA_API
 
	$lua_¿wg‘
 (
lua_S‹
 *
L
, 
idx
) {

647 
StkId
 
t
;

648 
	`lua_lock
(
L
);

649 
t
 = 
	`šdex2addr
(
L
, 
idx
);

650 
	`­i_check
(
L
, 
	`‰i¡abË
(
t
), "tableƒxpected");

651 
	`£tobj2s
(
L
, L->
tİ
 - 1, 
	`luaH_g‘
(
	`hv®ue
(
t
), L->top - 1));

652 
	`lua_uÆock
(
L
);

653  
	`‰nov
(
L
->
tİ
 - 1);

654 
	}
}

657 
LUA_API
 
	$lua_¿wg‘i
 (
lua_S‹
 *
L
, 
idx
, 
lua_IÁeg”
 
n
) {

658 
StkId
 
t
;

659 
	`lua_lock
(
L
);

660 
t
 = 
	`šdex2addr
(
L
, 
idx
);

661 
	`­i_check
(
L
, 
	`‰i¡abË
(
t
), "tableƒxpected");

662 
	`£tobj2s
(
L
, L->
tİ
, 
	`luaH_g‘št
(
	`hv®ue
(
t
), 
n
));

663 
	`­i_šü_tİ
(
L
);

664 
	`lua_uÆock
(
L
);

665  
	`‰nov
(
L
->
tİ
 - 1);

666 
	}
}

669 
LUA_API
 
	$lua_¿wg‘p
 (
lua_S‹
 *
L
, 
idx
, cÚ¡ *
p
) {

670 
StkId
 
t
;

671 
TV®ue
 
k
;

672 
	`lua_lock
(
L
);

673 
t
 = 
	`šdex2addr
(
L
, 
idx
);

674 
	`­i_check
(
L
, 
	`‰i¡abË
(
t
), "tableƒxpected");

675 
	`£v®ue
(&
k
, 
	`ÿ¡
(*, 
p
));

676 
	`£tobj2s
(
L
, L->
tİ
, 
	`luaH_g‘
(
	`hv®ue
(
t
), &
k
));

677 
	`­i_šü_tİ
(
L
);

678 
	`lua_uÆock
(
L
);

679  
	`‰nov
(
L
->
tİ
 - 1);

680 
	}
}

683 
LUA_API
 
	$lua_ü—‹bË
 (
lua_S‹
 *
L
, 
Ç¼ay
, 
Äec
) {

684 
TabË
 *
t
;

685 
	`lua_lock
(
L
);

686 
t
 = 
	`luaH_Ãw
(
L
);

687 
	`£thv®ue
(
L
, L->
tİ
, 
t
);

688 
	`­i_šü_tİ
(
L
);

689 ià(
Ç¼ay
 > 0 || 
Äec
 > 0)

690 
	`luaH_»size
(
L
, 
t
, 
Ç¼ay
, 
Äec
);

691 
	`luaC_checkGC
(
L
);

692 
	`lua_uÆock
(
L
);

693 
	}
}

696 
LUA_API
 
	$lua_g‘m‘©abË
 (
lua_S‹
 *
L
, 
objšdex
) {

697 cÚ¡ 
TV®ue
 *
obj
;

698 
TabË
 *
mt
;

699 
»s
 = 0;

700 
	`lua_lock
(
L
);

701 
obj
 = 
	`šdex2addr
(
L
, 
objšdex
);

702 
	`‰nov
(
obj
)) {

703 
LUA_TTABLE
:

704 
mt
 = 
	`hv®ue
(
obj
)->
m‘©abË
;

706 
LUA_TUSERDATA
:

707 
mt
 = 
	`uv®ue
(
obj
)->
m‘©abË
;

710 
mt
 = 
	`G
(
L
)->mt[
	`‰nov
(
obj
)];

713 ià(
mt
 !ğ
NULL
) {

714 
	`£thv®ue
(
L
, L->
tİ
, 
mt
);

715 
	`­i_šü_tİ
(
L
);

716 
»s
 = 1;

718 
	`lua_uÆock
(
L
);

719  
»s
;

720 
	}
}

723 
LUA_API
 
	$lua_g‘u£rv®ue
 (
lua_S‹
 *
L
, 
idx
) {

724 
StkId
 
o
;

725 
	`lua_lock
(
L
);

726 
o
 = 
	`šdex2addr
(
L
, 
idx
);

727 
	`­i_check
(
L
, 
	`‰isfuÎu£rd©a
(
o
), "full userdataƒxpected");

728 
	`g‘u£rv®ue
(
L
, 
	`uv®ue
(
o
), L->
tİ
);

729 
	`­i_šü_tİ
(
L
);

730 
	`lua_uÆock
(
L
);

731  
	`‰nov
(
L
->
tİ
 - 1);

732 
	}
}

742 
	$aux£t¡r
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t
, cÚ¡ *
k
) {

743 cÚ¡ 
TV®ue
 *
¦Ù
;

744 
TSŒšg
 *
¡r
 = 
	`luaS_Ãw
(
L
, 
k
);

745 
	`­i_checkÃËms
(
L
, 1);

746 ià(
	`luaV_ç¡£t
(
L
, 
t
, 
¡r
, 
¦Ù
, 
luaH_g‘¡r
, L->
tİ
 - 1))

747 
L
->
tİ
--;

749 
	`£tsv®ue2s
(
L
, L->
tİ
, 
¡r
);

750 
	`­i_šü_tİ
(
L
);

751 
	`luaV_fšish£t
(
L
, 
t
, L->
tİ
 - 1, L->tİ - 2, 
¦Ù
);

752 
L
->
tİ
 -= 2;

754 
	`lua_uÆock
(
L
);

755 
	}
}

758 
LUA_API
 
	$lua_£tglob®
 (
lua_S‹
 *
L
, cÚ¡ *
Çme
) {

759 
TabË
 *
»g
 = 
	`hv®ue
(&
	`G
(
L
)->
l_»gi¡ry
);

760 
	`lua_lock
(
L
);

761 
	`aux£t¡r
(
L
, 
	`luaH_g‘št
(
»g
, 
LUA_RIDX_GLOBALS
), 
Çme
);

762 
	}
}

765 
LUA_API
 
	$lua_£‰abË
 (
lua_S‹
 *
L
, 
idx
) {

766 
StkId
 
t
;

767 
	`lua_lock
(
L
);

768 
	`­i_checkÃËms
(
L
, 2);

769 
t
 = 
	`šdex2addr
(
L
, 
idx
);

770 
	`luaV_£‰abË
(
L
, 
t
, L->
tİ
 - 2, L->top - 1);

771 
L
->
tİ
 -= 2;

772 
	`lua_uÆock
(
L
);

773 
	}
}

776 
LUA_API
 
	$lua_£tf›ld
 (
lua_S‹
 *
L
, 
idx
, cÚ¡ *
k
) {

777 
	`lua_lock
(
L
);

778 
	`aux£t¡r
(
L
, 
	`šdex2addr
(L, 
idx
), 
k
);

779 
	}
}

782 
LUA_API
 
	$lua_£ti
 (
lua_S‹
 *
L
, 
idx
, 
lua_IÁeg”
 
n
) {

783 
StkId
 
t
;

784 cÚ¡ 
TV®ue
 *
¦Ù
;

785 
	`lua_lock
(
L
);

786 
	`­i_checkÃËms
(
L
, 1);

787 
t
 = 
	`šdex2addr
(
L
, 
idx
);

788 ià(
	`luaV_ç¡£t
(
L
, 
t
, 
n
, 
¦Ù
, 
luaH_g‘št
, L->
tİ
 - 1))

789 
L
->
tİ
--;

791 
	`£tiv®ue
(
L
->
tİ
, 
n
);

792 
	`­i_šü_tİ
(
L
);

793 
	`luaV_fšish£t
(
L
, 
t
, L->
tİ
 - 1, L->tİ - 2, 
¦Ù
);

794 
L
->
tİ
 -= 2;

796 
	`lua_uÆock
(
L
);

797 
	}
}

800 
LUA_API
 
	$lua_¿w£t
 (
lua_S‹
 *
L
, 
idx
) {

801 
StkId
 
o
;

802 
TV®ue
 *
¦Ù
;

803 
	`lua_lock
(
L
);

804 
	`­i_checkÃËms
(
L
, 2);

805 
o
 = 
	`šdex2addr
(
L
, 
idx
);

806 
	`­i_check
(
L
, 
	`‰i¡abË
(
o
), "tableƒxpected");

807 
¦Ù
 = 
	`luaH_£t
(
L
, 
	`hv®ue
(
o
), L->
tİ
 - 2);

808 
	`£tobj2t
(
L
, 
¦Ù
, L->
tİ
 - 1);

809 
	`šv®id©eTMÿche
(
	`hv®ue
(
o
));

810 
	`luaC_b¬r›rback
(
L
, 
	`hv®ue
(
o
), L->
tİ
-1);

811 
L
->
tİ
 -= 2;

812 
	`lua_uÆock
(
L
);

813 
	}
}

816 
LUA_API
 
	$lua_¿w£ti
 (
lua_S‹
 *
L
, 
idx
, 
lua_IÁeg”
 
n
) {

817 
StkId
 
o
;

818 
	`lua_lock
(
L
);

819 
	`­i_checkÃËms
(
L
, 1);

820 
o
 = 
	`šdex2addr
(
L
, 
idx
);

821 
	`­i_check
(
L
, 
	`‰i¡abË
(
o
), "tableƒxpected");

822 
	`luaH_£tšt
(
L
, 
	`hv®ue
(
o
), 
n
, L->
tİ
 - 1);

823 
	`luaC_b¬r›rback
(
L
, 
	`hv®ue
(
o
), L->
tİ
-1);

824 
L
->
tİ
--;

825 
	`lua_uÆock
(
L
);

826 
	}
}

829 
LUA_API
 
	$lua_¿w£
 (
lua_S‹
 *
L
, 
idx
, cÚ¡ *
p
) {

830 
StkId
 
o
;

831 
TV®ue
 
k
, *
¦Ù
;

832 
	`lua_lock
(
L
);

833 
	`­i_checkÃËms
(
L
, 1);

834 
o
 = 
	`šdex2addr
(
L
, 
idx
);

835 
	`­i_check
(
L
, 
	`‰i¡abË
(
o
), "tableƒxpected");

836 
	`£v®ue
(&
k
, 
	`ÿ¡
(*, 
p
));

837 
¦Ù
 = 
	`luaH_£t
(
L
, 
	`hv®ue
(
o
), &
k
);

838 
	`£tobj2t
(
L
, 
¦Ù
, L->
tİ
 - 1);

839 
	`luaC_b¬r›rback
(
L
, 
	`hv®ue
(
o
), L->
tİ
 - 1);

840 
L
->
tİ
--;

841 
	`lua_uÆock
(
L
);

842 
	}
}

845 
LUA_API
 
	$lua_£tm‘©abË
 (
lua_S‹
 *
L
, 
objšdex
) {

846 
TV®ue
 *
obj
;

847 
TabË
 *
mt
;

848 
	`lua_lock
(
L
);

849 
	`­i_checkÃËms
(
L
, 1);

850 
obj
 = 
	`šdex2addr
(
L
, 
objšdex
);

851 ià(
	`‰i¢
(
L
->
tİ
 - 1))

852 
mt
 = 
NULL
;

854 
	`­i_check
(
L
, 
	`‰i¡abË
(L->
tİ
 - 1), "tableƒxpected");

855 
mt
 = 
	`hv®ue
(
L
->
tİ
 - 1);

857 
	`‰nov
(
obj
)) {

858 
LUA_TTABLE
: {

859 
	`hv®ue
(
obj
)->
m‘©abË
 = 
mt
;

860 ià(
mt
) {

861 
	`luaC_objb¬r›r
(
L
, 
	`gcv®ue
(
obj
), 
mt
);

862 
	`luaC_checkfš®iz”
(
L
, 
	`gcv®ue
(
obj
), 
mt
);

866 
LUA_TUSERDATA
: {

867 
	`uv®ue
(
obj
)->
m‘©abË
 = 
mt
;

868 ià(
mt
) {

869 
	`luaC_objb¬r›r
(
L
, 
	`uv®ue
(
obj
), 
mt
);

870 
	`luaC_checkfš®iz”
(
L
, 
	`gcv®ue
(
obj
), 
mt
);

875 
	`G
(
L
)->
mt
[
	`‰nov
(
obj
)] = mt;

879 
L
->
tİ
--;

880 
	`lua_uÆock
(
L
);

882 
	}
}

885 
LUA_API
 
	$lua_£tu£rv®ue
 (
lua_S‹
 *
L
, 
idx
) {

886 
StkId
 
o
;

887 
	`lua_lock
(
L
);

888 
	`­i_checkÃËms
(
L
, 1);

889 
o
 = 
	`šdex2addr
(
L
, 
idx
);

890 
	`­i_check
(
L
, 
	`‰isfuÎu£rd©a
(
o
), "full userdataƒxpected");

891 
	`£tu£rv®ue
(
L
, 
	`uv®ue
(
o
), L->
tİ
 - 1);

892 
	`luaC_b¬r›r
(
L
, 
	`gcv®ue
(
o
), L->
tİ
 - 1);

893 
L
->
tİ
--;

894 
	`lua_uÆock
(
L
);

895 
	}
}

903 
	#check»suÉs
(
L
,
Ç
,
Ä
) \

904 
	`­i_check
(
L
, (
Ä
è=ğ
LUA_MULTRET
 || (L->
ci
->
tİ
 - L->tİ >ğÒrè- (
Ç
)), \

905 "»suÉ äom funùiÚ ov”æow cu¼’ˆ¡ack size")

	)

908 
LUA_API
 
	$lua_ÿÎk
 (
lua_S‹
 *
L
, 
Çrgs
, 
ÄesuÉs
,

909 
lua_KCÚ‹xt
 
ùx
, 
lua_KFunùiÚ
 
k
) {

910 
StkId
 
func
;

911 
	`lua_lock
(
L
);

912 
	`­i_check
(
L
, 
k
 =ğ
NULL
 || !
	`isLua
(L->
ci
),

914 
	`­i_checkÃËms
(
L
, 
Çrgs
+1);

915 
	`­i_check
(
L
, L->
¡©us
 =ğ
LUA_OK
, "cannot do calls on‚on-normalhread");

916 
	`check»suÉs
(
L
, 
Çrgs
, 
ÄesuÉs
);

917 
func
 = 
L
->
tİ
 - (
Çrgs
+1);

918 ià(
k
 !ğ
NULL
 && 
L
->
Ây
 == 0) {

919 
L
->
ci
->
u
.
c
.
k
 = k;

920 
L
->
ci
->
u
.
c
.
ùx
 = ctx;

921 
	`luaD_ÿÎ
(
L
, 
func
, 
ÄesuÉs
);

924 
	`luaD_ÿÎnoy›ld
(
L
, 
func
, 
ÄesuÉs
);

925 
	`adju¡»suÉs
(
L
, 
ÄesuÉs
);

926 
	`lua_uÆock
(
L
);

927 
	}
}

934 
	sC®lS
 {

935 
StkId
 
	mfunc
;

936 
	mÄesuÉs
;

940 
	$f_ÿÎ
 (
lua_S‹
 *
L
, *
ud
) {

941 
C®lS
 *
c
 = 
	`ÿ¡
(C®lS *, 
ud
);

942 
	`luaD_ÿÎnoy›ld
(
L
, 
c
->
func
, c->
ÄesuÉs
);

943 
	}
}

947 
LUA_API
 
	$lua_pÿÎk
 (
lua_S‹
 *
L
, 
Çrgs
, 
ÄesuÉs
, 
”rfunc
,

948 
lua_KCÚ‹xt
 
ùx
, 
lua_KFunùiÚ
 
k
) {

949 
C®lS
 
c
;

950 
¡©us
;

951 
±rdiff_t
 
func
;

952 
	`lua_lock
(
L
);

953 
	`­i_check
(
L
, 
k
 =ğ
NULL
 || !
	`isLua
(L->
ci
),

955 
	`­i_checkÃËms
(
L
, 
Çrgs
+1);

956 
	`­i_check
(
L
, L->
¡©us
 =ğ
LUA_OK
, "cannot do calls on‚on-normalhread");

957 
	`check»suÉs
(
L
, 
Çrgs
, 
ÄesuÉs
);

958 ià(
”rfunc
 == 0)

959 
func
 = 0;

961 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
”rfunc
);

962 
	`­i_check¡ackšdex
(
L
, 
”rfunc
, 
o
);

963 
func
 = 
	`§ve¡ack
(
L
, 
o
);

965 
c
.
func
 = 
L
->
tİ
 - (
Çrgs
+1);

966 ià(
k
 =ğ
NULL
 || 
L
->
Ây
 > 0) {

967 
c
.
ÄesuÉs
 =‚results;

968 
¡©us
 = 
	`luaD_pÿÎ
(
L
, 
f_ÿÎ
, &
c
, 
	`§ve¡ack
(L, c.
func
), func);

971 
C®lInfo
 *
ci
 = 
L
->ci;

972 
ci
->
u
.
c
.
k
 = k;

973 
ci
->
u
.
c
.
ùx
 = ctx;

975 
ci
->
exŒa
 = 
	`§ve¡ack
(
L
, 
c
.
func
);

976 
ci
->
u
.
c
.
Şd_”rfunc
 = 
L
->
”rfunc
;

977 
L
->
”rfunc
 = 
func
;

978 
	`£tßh
(
ci
->
ÿÎ¡©us
, 
L
->
®lowhook
);

979 
ci
->
ÿÎ¡©us
 |ğ
CIST_YPCALL
;

980 
	`luaD_ÿÎ
(
L
, 
c
.
func
, 
ÄesuÉs
);

981 
ci
->
ÿÎ¡©us
 &ğ~
CIST_YPCALL
;

982 
L
->
”rfunc
 = 
ci
->
u
.
c
.
Şd_”rfunc
;

983 
¡©us
 = 
LUA_OK
;

985 
	`adju¡»suÉs
(
L
, 
ÄesuÉs
);

986 
	`lua_uÆock
(
L
);

987  
¡©us
;

988 
	}
}

991 
LUA_API
 
	$lua_lßd
 (
lua_S‹
 *
L
, 
lua_R—d”
 
»ad”
, *
d©a
,

992 cÚ¡ *
chunkÇme
, cÚ¡ *
mode
) {

993 
ZIO
 
z
;

994 
¡©us
;

995 
	`lua_lock
(
L
);

996 ià(!
chunkÇme
) chunkname = "?";

997 
	`luaZ_š™
(
L
, &
z
, 
»ad”
, 
d©a
);

998 
¡©us
 = 
	`luaD_´Ùeùed·r£r
(
L
, &
z
, 
chunkÇme
, 
mode
);

999 ià(
¡©us
 =ğ
LUA_OK
) {

1000 
LClosu»
 *
f
 = 
	`şLv®ue
(
L
->
tİ
 - 1);

1001 ià(
f
->
nupv®ues
 >= 1) {

1003 
TabË
 *
»g
 = 
	`hv®ue
(&
	`G
(
L
)->
l_»gi¡ry
);

1004 cÚ¡ 
TV®ue
 *
gt
 = 
	`luaH_g‘št
(
»g
, 
LUA_RIDX_GLOBALS
);

1006 
	`£tobj
(
L
, 
f
->
upv®s
[0]->
v
, 
gt
);

1007 
	`luaC_upv®b¬r›r
(
L
, 
f
->
upv®s
[0]);

1010 
	`lua_uÆock
(
L
);

1011  
¡©us
;

1012 
	}
}

1015 
LUA_API
 
	$lua_dump
 (
lua_S‹
 *
L
, 
lua_Wr™”
 
wr™”
, *
d©a
, 
¡r
) {

1016 
¡©us
;

1017 
TV®ue
 *
o
;

1018 
	`lua_lock
(
L
);

1019 
	`­i_checkÃËms
(
L
, 1);

1020 
o
 = 
L
->
tİ
 - 1;

1021 ià(
	`isLfunùiÚ
(
o
))

1022 
¡©us
 = 
	`luaU_dump
(
L
, 
	`g‘´Ùo
(
o
), 
wr™”
, 
d©a
, 
¡r
);

1024 
¡©us
 = 1;

1025 
	`lua_uÆock
(
L
);

1026  
¡©us
;

1027 
	}
}

1030 
LUA_API
 
	$lua_¡©us
 (
lua_S‹
 *
L
) {

1031  
L
->
¡©us
;

1032 
	}
}

1039 
LUA_API
 
	$lua_gc
 (
lua_S‹
 *
L
, 
wh©
, 
d©a
) {

1040 
»s
 = 0;

1041 
glob®_S‹
 *
g
;

1042 
	`lua_lock
(
L
);

1043 
g
 = 
	`G
(
L
);

1044 
wh©
) {

1045 
LUA_GCSTOP
: {

1046 
g
->
güuÂšg
 = 0;

1049 
LUA_GCRESTART
: {

1050 
	`luaE_£tdebt
(
g
, 0);

1051 
g
->
güuÂšg
 = 1;

1054 
LUA_GCCOLLECT
: {

1055 
	`luaC_fuÎgc
(
L
, 0);

1058 
LUA_GCCOUNT
: {

1060 
»s
 = 
	`ÿ¡_št
(
	`g‘tÙ®by‹s
(
g
) >> 10);

1063 
LUA_GCCOUNTB
: {

1064 
»s
 = 
	`ÿ¡_št
(
	`g‘tÙ®by‹s
(
g
) & 0x3ff);

1067 
LUA_GCSTEP
: {

1068 
l_mem
 
debt
 = 1;

1069 
lu_by‹
 
ŞdruÂšg
 = 
g
->
güuÂšg
;

1070 
g
->
güuÂšg
 = 1;

1071 ià(
d©a
 == 0) {

1072 
	`luaE_£tdebt
(
g
, -
GCSTEPSIZE
);

1073 
	`luaC_¡•
(
L
);

1076 
debt
 = 
	`ÿ¡
(
l_mem
, 
d©a
è* 1024 + 
g
->
GCdebt
;

1077 
	`luaE_£tdebt
(
g
, 
debt
);

1078 
	`luaC_checkGC
(
L
);

1080 
g
->
güuÂšg
 = 
ŞdruÂšg
;

1081 ià(
debt
 > 0 && 
g
->
gc¡©e
 =ğ
GCS·u£
)

1082 
»s
 = 1;

1085 
LUA_GCSETPAUSE
: {

1086 
»s
 = 
g
->
gıau£
;

1087 
g
->
gıau£
 = 
d©a
;

1090 
LUA_GCSETSTEPMUL
: {

1091 
»s
 = 
g
->
gc¡•mul
;

1092 ià(
d©a
 < 40) data = 40;

1093 
g
->
gc¡•mul
 = 
d©a
;

1096 
LUA_GCISRUNNING
: {

1097 
»s
 = 
g
->
güuÂšg
;

1100 : 
»s
 = -1;

1102 
	`lua_uÆock
(
L
);

1103  
»s
;

1104 
	}
}

1113 
LUA_API
 
	$lua_”rÜ
 (
lua_S‹
 *
L
) {

1114 
	`lua_lock
(
L
);

1115 
	`­i_checkÃËms
(
L
, 1);

1116 
	`luaG_”rÜmsg
(
L
);

1119 
	}
}

1122 
LUA_API
 
	$lua_Ãxt
 (
lua_S‹
 *
L
, 
idx
) {

1123 
StkId
 
t
;

1124 
mÜe
;

1125 
	`lua_lock
(
L
);

1126 
t
 = 
	`šdex2addr
(
L
, 
idx
);

1127 
	`­i_check
(
L
, 
	`‰i¡abË
(
t
), "tableƒxpected");

1128 
mÜe
 = 
	`luaH_Ãxt
(
L
, 
	`hv®ue
(
t
), L->
tİ
 - 1);

1129 ià(
mÜe
) {

1130 
	`­i_šü_tİ
(
L
);

1133 
L
->
tİ
 -= 1;

1134 
	`lua_uÆock
(
L
);

1135  
mÜe
;

1136 
	}
}

1139 
LUA_API
 
	$lua_cÚÿt
 (
lua_S‹
 *
L
, 
n
) {

1140 
	`lua_lock
(
L
);

1141 
	`­i_checkÃËms
(
L
, 
n
);

1142 ià(
n
 >= 2) {

1143 
	`luaV_cÚÿt
(
L
, 
n
);

1145 ià(
n
 == 0) {

1146 
	`£tsv®ue2s
(
L
, L->
tİ
, 
	`luaS_Ãwl¡r
(L, "", 0));

1147 
	`­i_šü_tİ
(
L
);

1150 
	`luaC_checkGC
(
L
);

1151 
	`lua_uÆock
(
L
);

1152 
	}
}

1155 
LUA_API
 
	$lua_Ën
 (
lua_S‹
 *
L
, 
idx
) {

1156 
StkId
 
t
;

1157 
	`lua_lock
(
L
);

1158 
t
 = 
	`šdex2addr
(
L
, 
idx
);

1159 
	`luaV_objËn
(
L
, L->
tİ
, 
t
);

1160 
	`­i_šü_tİ
(
L
);

1161 
	`lua_uÆock
(
L
);

1162 
	}
}

1165 
LUA_API
 
lua_AÎoc
 
	$lua_g‘®locf
 (
lua_S‹
 *
L
, **
ud
) {

1166 
lua_AÎoc
 
f
;

1167 
	`lua_lock
(
L
);

1168 ià(
ud
è*ud = 
	`G
(
L
)->ud;

1169 
f
 = 
	`G
(
L
)->
ä—Îoc
;

1170 
	`lua_uÆock
(
L
);

1171  
f
;

1172 
	}
}

1175 
LUA_API
 
	$lua_£Îocf
 (
lua_S‹
 *
L
, 
lua_AÎoc
 
f
, *
ud
) {

1176 
	`lua_lock
(
L
);

1177 
	`G
(
L
)->
ud
 = ud;

1178 
	`G
(
L
)->
ä—Îoc
 = 
f
;

1179 
	`lua_uÆock
(
L
);

1180 
	}
}

1183 
LUA_API
 *
	$lua_Ãwu£rd©a
 (
lua_S‹
 *
L
, 
size_t
 
size
) {

1184 
Ud©a
 *
u
;

1185 
	`lua_lock
(
L
);

1186 
u
 = 
	`luaS_Ãwud©a
(
L
, 
size
);

1187 
	`£tuv®ue
(
L
, L->
tİ
, 
u
);

1188 
	`­i_šü_tİ
(
L
);

1189 
	`luaC_checkGC
(
L
);

1190 
	`lua_uÆock
(
L
);

1191  
	`g‘ud©amem
(
u
);

1192 
	}
}

1196 cÚ¡ *
	$aux_upv®ue
 (
StkId
 
fi
, 
n
, 
TV®ue
 **
v®
,

1197 
CClosu»
 **
owÃr
, 
UpV®
 **
uv
) {

1198 
	`‰y³
(
fi
)) {

1199 
LUA_TCCL
: {

1200 
CClosu»
 *
f
 = 
	`şCv®ue
(
fi
);

1201 ià(!(1 <ğ
n
 &&‚ <ğ
f
->
nupv®ues
)è 
NULL
;

1202 *
v®
 = &
f
->
upv®ue
[
n
-1];

1203 ià(
owÃr
è*owÃ¸ğ
f
;

1206 
LUA_TLCL
: {

1207 
LClosu»
 *
f
 = 
	`şLv®ue
(
fi
);

1208 
TSŒšg
 *
Çme
;

1209 
PrÙo
 *
p
 = 
f
->p;

1210 ià(!(1 <ğ
n
 &&‚ <ğ
p
->
sizeupv®ues
)è 
NULL
;

1211 *
v®
 = 
f
->
upv®s
[
n
-1]->
v
;

1212 ià(
uv
è*uv = 
f
->
upv®s
[
n
 - 1];

1213 
Çme
 = 
p
->
upv®ues
[
n
-1].name;

1214  (
Çme
 =ğ
NULL
è? "(*nØÇme)" : 
	`g‘¡r
(name);

1216 :  
NULL
;

1218 
	}
}

1221 
LUA_API
 cÚ¡ *
	$lua_g‘upv®ue
 (
lua_S‹
 *
L
, 
funcšdex
, 
n
) {

1222 cÚ¡ *
Çme
;

1223 
TV®ue
 *
v®
 = 
NULL
;

1224 
	`lua_lock
(
L
);

1225 
Çme
 = 
	`aux_upv®ue
(
	`šdex2addr
(
L
, 
funcšdex
), 
n
, &
v®
, 
NULL
, NULL);

1226 ià(
Çme
) {

1227 
	`£tobj2s
(
L
, L->
tİ
, 
v®
);

1228 
	`­i_šü_tİ
(
L
);

1230 
	`lua_uÆock
(
L
);

1231  
Çme
;

1232 
	}
}

1235 
LUA_API
 cÚ¡ *
	$lua_£tupv®ue
 (
lua_S‹
 *
L
, 
funcšdex
, 
n
) {

1236 cÚ¡ *
Çme
;

1237 
TV®ue
 *
v®
 = 
NULL
;

1238 
CClosu»
 *
owÃr
 = 
NULL
;

1239 
UpV®
 *
uv
 = 
NULL
;

1240 
StkId
 
fi
;

1241 
	`lua_lock
(
L
);

1242 
fi
 = 
	`šdex2addr
(
L
, 
funcšdex
);

1243 
	`­i_checkÃËms
(
L
, 1);

1244 
Çme
 = 
	`aux_upv®ue
(
fi
, 
n
, &
v®
, &
owÃr
, &
uv
);

1245 ià(
Çme
) {

1246 
L
->
tİ
--;

1247 
	`£tobj
(
L
, 
v®
, L->
tİ
);

1248 ià(
owÃr
è{ 
	`luaC_b¬r›r
(
L
, owÃr, L->
tİ
); }

1249 ià(
uv
è{ 
	`luaC_upv®b¬r›r
(
L
, uv); }

1251 
	`lua_uÆock
(
L
);

1252  
Çme
;

1253 
	}
}

1256 
UpV®
 **
	$g‘upv®»f
 (
lua_S‹
 *
L
, 
fidx
, 
n
, 
LClosu»
 **
pf
) {

1257 
LClosu»
 *
f
;

1258 
StkId
 
fi
 = 
	`šdex2addr
(
L
, 
fidx
);

1259 
	`­i_check
(
L
, 
	`‰isLşosu»
(
fi
), "Lua functionƒxpected");

1260 
f
 = 
	`şLv®ue
(
fi
);

1261 
	`­i_check
(
L
, (1 <ğ
n
 &&‚ <ğ
f
->
p
->
sizeupv®ues
), "invalid upvalue index");

1262 ià(
pf
è*pàğ
f
;

1263  &
f
->
upv®s
[
n
 - 1];

1264 
	}
}

1267 
LUA_API
 *
	$lua_upv®ueid
 (
lua_S‹
 *
L
, 
fidx
, 
n
) {

1268 
StkId
 
fi
 = 
	`šdex2addr
(
L
, 
fidx
);

1269 
	`‰y³
(
fi
)) {

1270 
LUA_TLCL
: {

1271  *
	`g‘upv®»f
(
L
, 
fidx
, 
n
, 
NULL
);

1273 
LUA_TCCL
: {

1274 
CClosu»
 *
f
 = 
	`şCv®ue
(
fi
);

1275 
	`­i_check
(
L
, 1 <ğ
n
 &&‚ <ğ
f
->
nupv®ues
, "invalid upvalue index");

1276  &
f
->
upv®ue
[
n
 - 1];

1279 
	`­i_check
(
L
, 0, "closureƒxpected");

1280  
NULL
;

1283 
	}
}

1286 
LUA_API
 
	$lua_upv®uejoš
 (
lua_S‹
 *
L
, 
fidx1
, 
n1
,

1287 
fidx2
, 
n2
) {

1288 
LClosu»
 *
f1
;

1289 
UpV®
 **
up1
 = 
	`g‘upv®»f
(
L
, 
fidx1
, 
n1
, &
f1
);

1290 
UpV®
 **
up2
 = 
	`g‘upv®»f
(
L
, 
fidx2
, 
n2
, 
NULL
);

1291 
	`luaC_upvdeccouÁ
(
L
, *
up1
);

1292 *
up1
 = *
up2
;

1293 (*
up1
)->
»fcouÁ
++;

1294 ià(
	`upisİ’
(*
up1
)è(*up1)->
u
.
İ’
.
touched
 = 1;

1295 
	`luaC_upv®b¬r›r
(
L
, *
up1
);

1296 
	}
}

	@script/lua/lua-5.3.4/src/lapi.h

7 #iâdeà
Ïpi_h


8 
	#Ïpi_h


	)

11 
	~"Îim™s.h
"

12 
	~"l¡©e.h
"

14 
	#­i_šü_tİ
(
L
è{L->
tİ
++; 
	`­i_check
(L, L->tİ <ğL->
ci
->top, \

15 "¡ack ov”æow");}

	)

17 
	#adju¡»suÉs
(
L
,
Äes
) \

18 { ià((
Äes
è=ğ
LUA_MULTRET
 && 
L
->
ci
->
tİ
 < L->tİèL->ci->tİ = L->tİ; }

	)

20 
	#­i_checkÃËms
(
L
,
n
è
	`­i_check
(L, (nè< (L->
tİ
 - L->
ci
->
func
), \

21 "nÙƒnoughƒËm’t šh¡ack")

	)

	@script/lua/lua-5.3.4/src/lauxlib.c

7 
	#Ïuxlib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<”ºo.h
>

14 
	~<¡d¬g.h
>

15 
	~<¡dio.h
>

16 
	~<¡dlib.h
>

17 
	~<¡ršg.h
>

25 
	~"lua.h
"

27 
	~"Ïuxlib.h
"

37 
	#LEVELS1
 10

	)

38 
	#LEVELS2
 11

	)

46 
	$fšdf›ld
 (
lua_S‹
 *
L
, 
objidx
, 
Ëv–
) {

47 ià(
Ëv–
 =ğ0 || !
	`lua_i¡abË
(
L
, -1))

49 
	`lua_pushn
(
L
);

50 
	`lua_Ãxt
(
L
, -2)) {

51 ià(
	`lua_ty³
(
L
, -2è=ğ
LUA_TSTRING
) {

52 ià(
	`lua_¿wequ®
(
L
, 
objidx
, -1)) {

53 
	`lua_pİ
(
L
, 1);

56 ià(
	`fšdf›ld
(
L
, 
objidx
, 
Ëv–
 - 1)) {

57 
	`lua_»move
(
L
, -2);

58 
	`lua_pushl™”®
(
L
, ".");

59 
	`lua_š£¹
(
L
, -2);

60 
	`lua_cÚÿt
(
L
, 3);

64 
	`lua_pİ
(
L
, 1);

67 
	}
}

73 
	$pushglob®funúame
 (
lua_S‹
 *
L
, 
lua_Debug
 *
¬
) {

74 
tİ
 = 
	`lua_g‘tİ
(
L
);

75 
	`lua_g‘šfo
(
L
, "f", 
¬
);

76 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_LOADED_TABLE
);

77 ià(
	`fšdf›ld
(
L
, 
tİ
 + 1, 2)) {

78 cÚ¡ *
Çme
 = 
	`lua_to¡ršg
(
L
, -1);

79 ià(
	`¡ºcmp
(
Çme
, "_G.", 3) == 0) {

80 
	`lua_push¡ršg
(
L
, 
Çme
 + 3);

81 
	`lua_»move
(
L
, -2);

83 
	`lua_cİy
(
L
, -1, 
tİ
 + 1);

84 
	`lua_pİ
(
L
, 2);

88 
	`lua_£‰İ
(
L
, 
tİ
);

91 
	}
}

94 
	$pushfunúame
 (
lua_S‹
 *
L
, 
lua_Debug
 *
¬
) {

95 ià(
	`pushglob®funúame
(
L
, 
¬
)) {

96 
	`lua_pushf¡ršg
(
L
, "funùiÚ '%s'", 
	`lua_to¡ršg
(L, -1));

97 
	`lua_»move
(
L
, -2);

99 ià(*
¬
->
Çmewh©
 != '\0')

100 
	`lua_pushf¡ršg
(
L
, "% '%s'", 
¬
->
Çmewh©
,‡r->
Çme
);

101 ià(*
¬
->
wh©
 == 'm')

102 
	`lua_pushl™”®
(
L
, "main chunk");

103 ià(*
¬
->
wh©
 != 'C')

104 
	`lua_pushf¡ršg
(
L
, "funùiÚ <%s:%d>", 
¬
->
shÜt_¤c
,‡r->
lšedefšed
);

106 
	`lua_pushl™”®
(
L
, "?");

107 
	}
}

110 
	$Ï¡Ëv–
 (
lua_S‹
 *
L
) {

111 
lua_Debug
 
¬
;

112 
li
 = 1, 
Ë
 = 1;

114 
	`lua_g‘¡ack
(
L
, 
Ë
, &
¬
)è{ 
li
 =†e;†e *= 2; }

116 
li
 < 
Ë
) {

117 
m
 = (
li
 + 
Ë
)/2;

118 ià(
	`lua_g‘¡ack
(
L
, 
m
, &
¬
)è
li
 = m + 1;

119 
Ë
 = 
m
;

121  
Ë
 - 1;

122 
	}
}

125 
LUALIB_API
 
	$luaL_Œaûback
 (
lua_S‹
 *
L
,†ua_S‹ *
L1
,

126 cÚ¡ *
msg
, 
Ëv–
) {

127 
lua_Debug
 
¬
;

128 
tİ
 = 
	`lua_g‘tİ
(
L
);

129 
Ï¡
 = 
	`Ï¡Ëv–
(
L1
);

130 
n1
 = (
Ï¡
 - 
Ëv–
 > 
LEVELS1
 + 
LEVELS2
) ? LEVELS1 : -1;

131 ià(
msg
)

132 
	`lua_pushf¡ršg
(
L
, "%s\n", 
msg
);

133 
	`luaL_check¡ack
(
L
, 10, 
NULL
);

134 
	`lua_pushl™”®
(
L
, "stackraceback:");

135 
	`lua_g‘¡ack
(
L1
, 
Ëv–
++, &
¬
)) {

136 ià(
n1
-- == 0) {

137 
	`lua_pushl™”®
(
L
, "\n\t...");

138 
Ëv–
 = 
Ï¡
 - 
LEVELS2
 + 1;

141 
	`lua_g‘šfo
(
L1
, "SÊt", &
¬
);

142 
	`lua_pushf¡ršg
(
L
, "\n\t%s:", 
¬
.
shÜt_¤c
);

143 ià(
¬
.
cu¼’še
 > 0)

144 
	`lua_pushf¡ršg
(
L
, "%d:", 
¬
.
cu¼’še
);

145 
	`lua_pushl™”®
(
L
, " in ");

146 
	`pushfunúame
(
L
, &
¬
);

147 ià(
¬
.
i¡aÿÎ
)

148 
	`lua_pushl™”®
(
L
, "\n\t(...tail calls...)");

149 
	`lua_cÚÿt
(
L
, 
	`lua_g‘tİ
(Lè- 
tİ
);

152 
	`lua_cÚÿt
(
L
, 
	`lua_g‘tİ
(Lè- 
tİ
);

153 
	}
}

164 
LUALIB_API
 
	$luaL_¬g”rÜ
 (
lua_S‹
 *
L
, 
¬g
, cÚ¡ *
exŒamsg
) {

165 
lua_Debug
 
¬
;

166 ià(!
	`lua_g‘¡ack
(
L
, 0, &
¬
))

167  
	`luaL_”rÜ
(
L
, "bad‡rgum’ˆ#%d (%s)", 
¬g
, 
exŒamsg
);

168 
	`lua_g‘šfo
(
L
, "n", &
¬
);

169 ià(
	`¡rcmp
(
¬
.
Çmewh©
, "method") == 0) {

170 
¬g
--;

171 ià(
¬g
 == 0)

172  
	`luaL_”rÜ
(
L
, "calling '%s' on bad self (%s)",

173 
¬
.
Çme
, 
exŒamsg
);

175 ià(
¬
.
Çme
 =ğ
NULL
)

176 
¬
.
Çme
 = (
	`pushglob®funúame
(
L
, &¬)è? 
	`lua_to¡ršg
(L, -1) : "?";

177  
	`luaL_”rÜ
(
L
, "bad‡rgument #%do '%s' (%s)",

178 
¬g
, 
¬
.
Çme
, 
exŒamsg
);

179 
	}
}

182 
	$ty³”rÜ
 (
lua_S‹
 *
L
, 
¬g
, cÚ¡ *
Šame
) {

183 cÚ¡ *
msg
;

184 cÚ¡ *
ty³¬g
;

185 ià(
	`luaL_g‘m‘af›ld
(
L
, 
¬g
, "__Çme"è=ğ
LUA_TSTRING
)

186 
ty³¬g
 = 
	`lua_to¡ršg
(
L
, -1);

187 ià(
	`lua_ty³
(
L
, 
¬g
è=ğ
LUA_TLIGHTUSERDATA
)

188 
ty³¬g
 = "light userdata";

190 
ty³¬g
 = 
	`luaL_ty³Çme
(
L
, 
¬g
);

191 
msg
 = 
	`lua_pushf¡ršg
(
L
, "% ex³ùed, gÙ %s", 
Šame
, 
ty³¬g
);

192  
	`luaL_¬g”rÜ
(
L
, 
¬g
, 
msg
);

193 
	}
}

196 
	$g_”rÜ
 (
lua_S‹
 *
L
, 
¬g
, 
g
) {

197 
	`ty³”rÜ
(
L
, 
¬g
, 
	`lua_ty³Çme
(L, 
g
));

198 
	}
}

205 
LUALIB_API
 
	$luaL_wh”e
 (
lua_S‹
 *
L
, 
Ëv–
) {

206 
lua_Debug
 
¬
;

207 ià(
	`lua_g‘¡ack
(
L
, 
Ëv–
, &
¬
)) {

208 
	`lua_g‘šfo
(
L
, "Sl", &
¬
);

209 ià(
¬
.
cu¼’še
 > 0) {

210 
	`lua_pushf¡ršg
(
L
, "%s:%d: ", 
¬
.
shÜt_¤c
,‡r.
cu¼’še
);

214 
	`lua_pushf¡ršg
(
L
, "");

215 
	}
}

223 
LUALIB_API
 
	$luaL_”rÜ
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...) {

224 
va_li¡
 
¬gp
;

225 
	`va_¡¬t
(
¬gp
, 
fmt
);

226 
	`luaL_wh”e
(
L
, 1);

227 
	`lua_pushvf¡ršg
(
L
, 
fmt
, 
¬gp
);

228 
	`va_’d
(
¬gp
);

229 
	`lua_cÚÿt
(
L
, 2);

230  
	`lua_”rÜ
(
L
);

231 
	}
}

234 
LUALIB_API
 
	$luaL_f”esuÉ
 (
lua_S‹
 *
L
, 
¡©
, cÚ¡ *
âame
) {

235 
’
 = 
”ºo
;

236 ià(
¡©
) {

237 
	`lua_pushboŞ—n
(
L
, 1);

241 
	`lua_pushn
(
L
);

242 ià(
âame
)

243 
	`lua_pushf¡ršg
(
L
, "%s: %s", 
âame
, 
	`¡»¼Ü
(
’
));

245 
	`lua_push¡ršg
(
L
, 
	`¡»¼Ü
(
’
));

246 
	`lua_pushš‹g”
(
L
, 
’
);

249 
	}
}

252 #ià!
defšed
(
l_š¥eù¡©
)

254 #ià
defšed
(
LUA_USE_POSIX
)

256 
	~<sys/wa™.h
>

261 
	#l_š¥eù¡©
(
¡©
,
wh©
) \

262 ià(
	`WIFEXITED
(
¡©
)è{ sˆğ
	`WEXITSTATUS
(stat); } \

263 ià(
	`WIFSIGNALED
(
¡©
)è{ sˆğ
	`WTERMSIG
(¡©); 
wh©
 = "sigÇl"; }

	)

267 
	#l_š¥eù¡©
(
¡©
,
wh©
è

	)

274 
LUALIB_API
 
	$luaL_exeüesuÉ
 (
lua_S‹
 *
L
, 
¡©
) {

275 cÚ¡ *
wh©
 = "exit";

276 ià(
¡©
 == -1)

277  
	`luaL_f”esuÉ
(
L
, 0, 
NULL
);

279 
	`l_š¥eù¡©
(
¡©
, 
wh©
);

280 ià(*
wh©
 =ğ'e' && 
¡©
 == 0)

281 
	`lua_pushboŞ—n
(
L
, 1);

283 
	`lua_pushn
(
L
);

284 
	`lua_push¡ršg
(
L
, 
wh©
);

285 
	`lua_pushš‹g”
(
L
, 
¡©
);

288 
	}
}

299 
LUALIB_API
 
	$luaL_Ãwm‘©abË
 (
lua_S‹
 *
L
, cÚ¡ *
Šame
) {

300 ià(
	`luaL_g‘m‘©abË
(
L
, 
Šame
è!ğ
LUA_TNIL
)

302 
	`lua_pİ
(
L
, 1);

303 
	`lua_ü—‹bË
(
L
, 0, 2);

304 
	`lua_push¡ršg
(
L
, 
Šame
);

305 
	`lua_£tf›ld
(
L
, -2, "__name");

306 
	`lua_pushv®ue
(
L
, -1);

307 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, 
Šame
);

309 
	}
}

312 
LUALIB_API
 
	$luaL_£tm‘©abË
 (
lua_S‹
 *
L
, cÚ¡ *
Šame
) {

313 
	`luaL_g‘m‘©abË
(
L
, 
Šame
);

314 
	`lua_£tm‘©abË
(
L
, -2);

315 
	}
}

318 
LUALIB_API
 *
	$luaL_‹¡ud©a
 (
lua_S‹
 *
L
, 
ud
, cÚ¡ *
Šame
) {

319 *
p
 = 
	`lua_tou£rd©a
(
L
, 
ud
);

320 ià(
p
 !ğ
NULL
) {

321 ià(
	`lua_g‘m‘©abË
(
L
, 
ud
)) {

322 
	`luaL_g‘m‘©abË
(
L
, 
Šame
);

323 ià(!
	`lua_¿wequ®
(
L
, -1, -2))

324 
p
 = 
NULL
;

325 
	`lua_pİ
(
L
, 2);

326  
p
;

329  
NULL
;

330 
	}
}

333 
LUALIB_API
 *
	$luaL_checkud©a
 (
lua_S‹
 *
L
, 
ud
, cÚ¡ *
Šame
) {

334 *
p
 = 
	`luaL_‹¡ud©a
(
L
, 
ud
, 
Šame
);

335 ià(
p
 =ğ
NULL
è
	`ty³”rÜ
(
L
, 
ud
, 
Šame
);

336  
p
;

337 
	}
}

348 
LUALIB_API
 
	$luaL_checkİtiÚ
 (
lua_S‹
 *
L
, 
¬g
, cÚ¡ *
def
,

349 cÚ¡ *cÚ¡ 
l¡
[]) {

350 cÚ¡ *
Çme
 = (
def
è? 
	`luaL_İt¡ršg
(
L
, 
¬g
, def) :

351 
	`luaL_check¡ršg
(
L
, 
¬g
);

352 
i
;

353 
i
=0; 
l¡
[i]; i++)

354 ià(
	`¡rcmp
(
l¡
[
i
], 
Çme
) == 0)

355  
i
;

356  
	`luaL_¬g”rÜ
(
L
, 
¬g
,

357 
	`lua_pushf¡ršg
(
L
, "šv®id o±iÚ '%s'", 
Çme
));

358 
	}
}

368 
LUALIB_API
 
	$luaL_check¡ack
 (
lua_S‹
 *
L
, 
¥aû
, cÚ¡ *
msg
) {

369 ià(!
	`lua_check¡ack
(
L
, 
¥aû
)) {

370 ià(
msg
)

371 
	`luaL_”rÜ
(
L
, "¡ack ov”æow (%s)", 
msg
);

373 
	`luaL_”rÜ
(
L
, "stack overflow");

375 
	}
}

378 
LUALIB_API
 
	$luaL_checkty³
 (
lua_S‹
 *
L
, 
¬g
, 
t
) {

379 ià(
	`lua_ty³
(
L
, 
¬g
è!ğ
t
)

380 
	`g_”rÜ
(
L
, 
¬g
, 
t
);

381 
	}
}

384 
LUALIB_API
 
	$luaL_checkªy
 (
lua_S‹
 *
L
, 
¬g
) {

385 ià(
	`lua_ty³
(
L
, 
¬g
è=ğ
LUA_TNONE
)

386 
	`luaL_¬g”rÜ
(
L
, 
¬g
, "valueƒxpected");

387 
	}
}

390 
LUALIB_API
 cÚ¡ *
	$luaL_checkl¡ršg
 (
lua_S‹
 *
L
, 
¬g
, 
size_t
 *
Ën
) {

391 cÚ¡ *
s
 = 
	`lua_tŞ¡ršg
(
L
, 
¬g
, 
Ën
);

392 ià(!
s
è
	`g_”rÜ
(
L
, 
¬g
, 
LUA_TSTRING
);

393  
s
;

394 
	}
}

397 
LUALIB_API
 cÚ¡ *
	$luaL_İ¡ršg
 (
lua_S‹
 *
L
, 
¬g
,

398 cÚ¡ *
def
, 
size_t
 *
Ën
) {

399 ià(
	`lua_i¢ÚeÜn
(
L
, 
¬g
)) {

400 ià(
Ën
)

401 *
Ën
 = (
def
 ? 
	`¡¾’
(def) : 0);

402  
def
;

404  
	`luaL_checkl¡ršg
(
L
, 
¬g
, 
Ën
);

405 
	}
}

408 
LUALIB_API
 
lua_Numb”
 
	$luaL_checknumb”
 (
lua_S‹
 *
L
, 
¬g
) {

409 
i¢um
;

410 
lua_Numb”
 
d
 = 
	`lua_tÚumb”x
(
L
, 
¬g
, &
i¢um
);

411 ià(!
i¢um
)

412 
	`g_”rÜ
(
L
, 
¬g
, 
LUA_TNUMBER
);

413  
d
;

414 
	}
}

417 
LUALIB_API
 
lua_Numb”
 
	$luaL_İŠumb”
 (
lua_S‹
 *
L
, 
¬g
, 
lua_Numb”
 
def
) {

418  
	`luaL_İt
(
L
, 
luaL_checknumb”
, 
¬g
, 
def
);

419 
	}
}

422 
	$š‹¼Ü
 (
lua_S‹
 *
L
, 
¬g
) {

423 ià(
	`lua_i¢umb”
(
L
, 
¬g
))

424 
	`luaL_¬g”rÜ
(
L
, 
¬g
, "number has‚o integer„epresentation");

426 
	`g_”rÜ
(
L
, 
¬g
, 
LUA_TNUMBER
);

427 
	}
}

430 
LUALIB_API
 
lua_IÁeg”
 
	$luaL_checkš‹g”
 (
lua_S‹
 *
L
, 
¬g
) {

431 
i¢um
;

432 
lua_IÁeg”
 
d
 = 
	`lua_toš‹g”x
(
L
, 
¬g
, &
i¢um
);

433 ià(!
i¢um
) {

434 
	`š‹¼Ü
(
L
, 
¬g
);

436  
d
;

437 
	}
}

440 
LUALIB_API
 
lua_IÁeg”
 
	$luaL_İtš‹g”
 (
lua_S‹
 *
L
, 
¬g
,

441 
lua_IÁeg”
 
def
) {

442  
	`luaL_İt
(
L
, 
luaL_checkš‹g”
, 
¬g
, 
def
);

443 
	}
}

455 
	sUBox
 {

456 *
	mbox
;

457 
size_t
 
	mbsize
;

458 } 
	tUBox
;

461 *
	$»sizebox
 (
lua_S‹
 *
L
, 
idx
, 
size_t
 
Ãwsize
) {

462 *
ud
;

463 
lua_AÎoc
 
®locf
 = 
	`lua_g‘®locf
(
L
, &
ud
);

464 
UBox
 *
box
 = (UBox *)
	`lua_tou£rd©a
(
L
, 
idx
);

465 *
‹mp
 = 
	`®locf
(
ud
, 
box
->box, box->
bsize
, 
Ãwsize
);

466 ià(
‹mp
 =ğ
NULL
 && 
Ãwsize
 > 0) {

467 
	`»sizebox
(
L
, 
idx
, 0);

468 
	`luaL_”rÜ
(
L
, "notƒnough memory for buffer‡llocation");

470 
box
->box = 
‹mp
;

471 
box
->
bsize
 = 
Ãwsize
;

472  
‹mp
;

473 
	}
}

476 
	$boxgc
 (
lua_S‹
 *
L
) {

477 
	`»sizebox
(
L
, 1, 0);

479 
	}
}

482 *
	$Ãwbox
 (
lua_S‹
 *
L
, 
size_t
 
Ãwsize
) {

483 
UBox
 *
box
 = (UBox *)
	`lua_Ãwu£rd©a
(
L
, (UBox));

484 
box
->box = 
NULL
;

485 
box
->
bsize
 = 0;

486 ià(
	`luaL_Ãwm‘©abË
(
L
, "LUABOX")) {

487 
	`lua_pushcfunùiÚ
(
L
, 
boxgc
);

488 
	`lua_£tf›ld
(
L
, -2, "__gc");

490 
	`lua_£tm‘©abË
(
L
, -2);

491  
	`»sizebox
(
L
, -1, 
Ãwsize
);

492 
	}
}

499 
	#buffÚ¡ack
(
B
è((B)->
b
 !ğ(B)->
š™b
)

	)

505 
LUALIB_API
 *
	$luaL_´•buffsize
 (
luaL_Bufãr
 *
B
, 
size_t
 
sz
) {

506 
lua_S‹
 *
L
 = 
B
->L;

507 ià(
B
->
size
 - B->
n
 < 
sz
) {

508 *
Ãwbuff
;

509 
size_t
 
Ãwsize
 = 
B
->
size
 * 2;

510 ià(
Ãwsize
 - 
B
->
n
 < 
sz
)

511 
Ãwsize
 = 
B
->
n
 + 
sz
;

512 ià(
Ãwsize
 < 
B
->
n
 ||‚ewsiz- B->À< 
sz
)

513 
	`luaL_”rÜ
(
L
, "bufferoo†arge");

515 ià(
	`buffÚ¡ack
(
B
))

516 
Ãwbuff
 = (*)
	`»sizebox
(
L
, -1, 
Ãwsize
);

518 
Ãwbuff
 = (*)
	`Ãwbox
(
L
, 
Ãwsize
);

519 
	`memıy
(
Ãwbuff
, 
B
->
b
, B->
n
 * ());

521 
B
->
b
 = 
Ãwbuff
;

522 
B
->
size
 = 
Ãwsize
;

524  &
B
->
b
[B->
n
];

525 
	}
}

528 
LUALIB_API
 
	$luaL_addl¡ršg
 (
luaL_Bufãr
 *
B
, cÚ¡ *
s
, 
size_t
 
l
) {

529 ià(
l
 > 0) {

530 *
b
 = 
	`luaL_´•buffsize
(
B
, 
l
);

531 
	`memıy
(
b
, 
s
, 
l
 * ());

532 
	`luaL_addsize
(
B
, 
l
);

534 
	}
}

537 
LUALIB_API
 
	$luaL_add¡ršg
 (
luaL_Bufãr
 *
B
, cÚ¡ *
s
) {

538 
	`luaL_addl¡ršg
(
B
, 
s
, 
	`¡¾’
(s));

539 
	}
}

542 
LUALIB_API
 
	$luaL_push»suÉ
 (
luaL_Bufãr
 *
B
) {

543 
lua_S‹
 *
L
 = 
B
->L;

544 
	`lua_pushl¡ršg
(
L
, 
B
->
b
, B->
n
);

545 ià(
	`buffÚ¡ack
(
B
)) {

546 
	`»sizebox
(
L
, -2, 0);

547 
	`lua_»move
(
L
, -2);

549 
	}
}

552 
LUALIB_API
 
	$luaL_push»suÉsize
 (
luaL_Bufãr
 *
B
, 
size_t
 
sz
) {

553 
	`luaL_addsize
(
B
, 
sz
);

554 
	`luaL_push»suÉ
(
B
);

555 
	}
}

558 
LUALIB_API
 
	$luaL_addv®ue
 (
luaL_Bufãr
 *
B
) {

559 
lua_S‹
 *
L
 = 
B
->L;

560 
size_t
 
l
;

561 cÚ¡ *
s
 = 
	`lua_tŞ¡ršg
(
L
, -1, &
l
);

562 ià(
	`buffÚ¡ack
(
B
))

563 
	`lua_š£¹
(
L
, -2);

564 
	`luaL_addl¡ršg
(
B
, 
s
, 
l
);

565 
	`lua_»move
(
L
, (
	`buffÚ¡ack
(
B
)) ? -2 : -1);

566 
	}
}

569 
LUALIB_API
 
	$luaL_buffš™
 (
lua_S‹
 *
L
, 
luaL_Bufãr
 *
B
) {

570 
B
->
L
 = L;

571 
B
->
b
 = B->
š™b
;

572 
B
->
n
 = 0;

573 
B
->
size
 = 
LUAL_BUFFERSIZE
;

574 
	}
}

577 
LUALIB_API
 *
	$luaL_buffš™size
 (
lua_S‹
 *
L
, 
luaL_Bufãr
 *
B
, 
size_t
 
sz
) {

578 
	`luaL_buffš™
(
L
, 
B
);

579  
	`luaL_´•buffsize
(
B
, 
sz
);

580 
	}
}

592 
	#ä“li¡
 0

	)

595 
LUALIB_API
 
	$luaL_»f
 (
lua_S‹
 *
L
, 
t
) {

596 
»f
;

597 ià(
	`lua_i¢
(
L
, -1)) {

598 
	`lua_pİ
(
L
, 1);

599  
LUA_REFNIL
;

601 
t
 = 
	`lua_absšdex
(
L
,);

602 
	`lua_¿wg‘i
(
L
, 
t
, 
ä“li¡
);

603 
»f
 = ()
	`lua_toš‹g”
(
L
, -1);

604 
	`lua_pİ
(
L
, 1);

605 ià(
»f
 != 0) {

606 
	`lua_¿wg‘i
(
L
, 
t
, 
»f
);

607 
	`lua_¿w£ti
(
L
, 
t
, 
ä“li¡
);

610 
»f
 = ()
	`lua_¿wËn
(
L
, 
t
) + 1;

611 
	`lua_¿w£ti
(
L
, 
t
, 
»f
);

612  
»f
;

613 
	}
}

616 
LUALIB_API
 
	$luaL_uÄef
 (
lua_S‹
 *
L
, 
t
, 
»f
) {

617 ià(
»f
 >= 0) {

618 
t
 = 
	`lua_absšdex
(
L
,);

619 
	`lua_¿wg‘i
(
L
, 
t
, 
ä“li¡
);

620 
	`lua_¿w£ti
(
L
, 
t
, 
»f
);

621 
	`lua_pushš‹g”
(
L
, 
»f
);

622 
	`lua_¿w£ti
(
L
, 
t
, 
ä“li¡
);

624 
	}
}

635 
	sLßdF
 {

636 
	mn
;

637 
FILE
 *
	mf
;

638 
	mbuff
[
BUFSIZ
];

639 } 
	tLßdF
;

642 cÚ¡ *
	$g‘F
 (
lua_S‹
 *
L
, *
ud
, 
size_t
 *
size
) {

643 
LßdF
 *
lf
 = (LßdF *)
ud
;

644 ()
L
;

645 ià(
lf
->
n
 > 0) {

646 *
size
 = 
lf
->
n
;

647 
lf
->
n
 = 0;

653 ià(
	`ãof
(
lf
->
f
)è 
NULL
;

654 *
size
 = 
	`ä—d
(
lf
->
buff
, 1, Öf->buff),†f->
f
);

656  
lf
->
buff
;

657 
	}
}

660 
	$”rfe
 (
lua_S‹
 *
L
, cÚ¡ *
wh©
, 
âamešdex
) {

661 cÚ¡ *
£¼
 = 
	`¡»¼Ü
(
”ºo
);

662 cÚ¡ *
f’ame
 = 
	`lua_to¡ršg
(
L
, 
âamešdex
) + 1;

663 
	`lua_pushf¡ršg
(
L
, "ÿÂÙ % %s: %s", 
wh©
, 
f’ame
, 
£¼
);

664 
	`lua_»move
(
L
, 
âamešdex
);

665  
LUA_ERRFILE
;

666 
	}
}

669 
	$skBOM
 (
LßdF
 *
lf
) {

670 cÚ¡ *
p
 = "\xEF\xBB\xBF";

671 
c
;

672 
lf
->
n
 = 0;

674 
c
 = 
	`g‘c
(
lf
->
f
);

675 ià(
c
 =ğ
EOF
 || c !ğ*(cÚ¡ *)
p
++)  c;

676 
lf
->
buff
[lf->
n
++] = 
c
;

677 } *
p
 != '\0');

678 
lf
->
n
 = 0;

679  
	`g‘c
(
lf
->
f
);

680 
	}
}

690 
	$skcomm’t
 (
LßdF
 *
lf
, *
ı
) {

691 
c
 = *
ı
 = 
	`skBOM
(
lf
);

692 ià(
c
 == '#') {

694 
c
 = 
	`g‘c
(
lf
->
f
);

695 } 
c
 !ğ
EOF
 && c != '\n');

696 *
ı
 = 
	`g‘c
(
lf
->
f
);

700 
	}
}

703 
LUALIB_API
 
	$luaL_lßdfex
 (
lua_S‹
 *
L
, cÚ¡ *
f’ame
,

704 cÚ¡ *
mode
) {

705 
LßdF
 
lf
;

706 
¡©us
, 
»ad¡©us
;

707 
c
;

708 
âamešdex
 = 
	`lua_g‘tİ
(
L
) + 1;

709 ià(
f’ame
 =ğ
NULL
) {

710 
	`lua_pushl™”®
(
L
, "=stdin");

711 
lf
.
f
 = 
¡dš
;

714 
	`lua_pushf¡ršg
(
L
, "@%s", 
f’ame
);

715 
lf
.
f
 = 
	`fİ’
(
f’ame
, "r");

716 ià(
lf
.
f
 =ğ
NULL
è 
	`”rfe
(
L
, "İ’", 
âamešdex
);

718 ià(
	`skcomm’t
(&
lf
, &
c
))

719 
lf
.
buff
[lf.
n
++] = '\n';

720 ià(
c
 =ğ
LUA_SIGNATURE
[0] && 
f’ame
) {

721 
lf
.
f
 = 
	`äeİ’
(
f’ame
, "rb",†f.f);

722 ià(
lf
.
f
 =ğ
NULL
è 
	`”rfe
(
L
, "»İ’", 
âamešdex
);

723 
	`skcomm’t
(&
lf
, &
c
);

725 ià(
c
 !ğ
EOF
)

726 
lf
.
buff
[lf.
n
++] = 
c
;

727 
¡©us
 = 
	`lua_lßd
(
L
, 
g‘F
, &
lf
, 
	`lua_to¡ršg
(L, -1), 
mode
);

728 
»ad¡©us
 = 
	`ã¼Ü
(
lf
.
f
);

729 ià(
f’ame
è
	`fşo£
(
lf
.
f
);

730 ià(
»ad¡©us
) {

731 
	`lua_£‰İ
(
L
, 
âamešdex
);

732  
	`”rfe
(
L
, "»ad", 
âamešdex
);

734 
	`lua_»move
(
L
, 
âamešdex
);

735  
¡©us
;

736 
	}
}

739 
	sLßdS
 {

740 cÚ¡ *
	ms
;

741 
size_t
 
	msize
;

742 } 
	tLßdS
;

745 cÚ¡ *
	$g‘S
 (
lua_S‹
 *
L
, *
ud
, 
size_t
 *
size
) {

746 
LßdS
 *
ls
 = (LßdS *)
ud
;

747 ()
L
;

748 ià(
ls
->
size
 =ğ0è 
NULL
;

749 *
size
 = 
ls
->size;

750 
ls
->
size
 = 0;

751  
ls
->
s
;

752 
	}
}

755 
LUALIB_API
 
	$luaL_lßdbufãrx
 (
lua_S‹
 *
L
, cÚ¡ *
buff
, 
size_t
 
size
,

756 cÚ¡ *
Çme
, cÚ¡ *
mode
) {

757 
LßdS
 
ls
;

758 
ls
.
s
 = 
buff
;

759 
ls
.
size
 = size;

760  
	`lua_lßd
(
L
, 
g‘S
, &
ls
, 
Çme
, 
mode
);

761 
	}
}

764 
LUALIB_API
 
	$luaL_lßd¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
s
) {

765  
	`luaL_lßdbufãr
(
L
, 
s
, 
	`¡¾’
(s), s);

766 
	}
}

772 
LUALIB_API
 
	$luaL_g‘m‘af›ld
 (
lua_S‹
 *
L
, 
obj
, cÚ¡ *
ev’t
) {

773 ià(!
	`lua_g‘m‘©abË
(
L
, 
obj
))

774  
LUA_TNIL
;

776 
‰
;

777 
	`lua_push¡ršg
(
L
, 
ev’t
);

778 
‰
 = 
	`lua_¿wg‘
(
L
, -2);

779 ià(
‰
 =ğ
LUA_TNIL
)

780 
	`lua_pİ
(
L
, 2);

782 
	`lua_»move
(
L
, -2);

783  
‰
;

785 
	}
}

788 
LUALIB_API
 
	$luaL_ÿÎm‘a
 (
lua_S‹
 *
L
, 
obj
, cÚ¡ *
ev’t
) {

789 
obj
 = 
	`lua_absšdex
(
L
, obj);

790 ià(
	`luaL_g‘m‘af›ld
(
L
, 
obj
, 
ev’t
è=ğ
LUA_TNIL
)

792 
	`lua_pushv®ue
(
L
, 
obj
);

793 
	`lua_ÿÎ
(
L
, 1, 1);

795 
	}
}

798 
LUALIB_API
 
lua_IÁeg”
 
	$luaL_Ën
 (
lua_S‹
 *
L
, 
idx
) {

799 
lua_IÁeg”
 
l
;

800 
i¢um
;

801 
	`lua_Ën
(
L
, 
idx
);

802 
l
 = 
	`lua_toš‹g”x
(
L
, -1, &
i¢um
);

803 ià(!
i¢um
)

804 
	`luaL_”rÜ
(
L
, "object†ength is‚ot‡n integer");

805 
	`lua_pİ
(
L
, 1);

806  
l
;

807 
	}
}

810 
LUALIB_API
 cÚ¡ *
	$luaL_tŞ¡ršg
 (
lua_S‹
 *
L
, 
idx
, 
size_t
 *
Ën
) {

811 ià(
	`luaL_ÿÎm‘a
(
L
, 
idx
, "__tostring")) {

812 ià(!
	`lua_is¡ršg
(
L
, -1))

813 
	`luaL_”rÜ
(
L
, "'__tostring' must„eturn‡ string");

816 
	`lua_ty³
(
L
, 
idx
)) {

817 
LUA_TNUMBER
: {

818 ià(
	`lua_isš‹g”
(
L
, 
idx
))

819 
	`lua_pushf¡ršg
(
L
, "%I", (
LUAI_UACINT
)
	`lua_toš‹g”
(L, 
idx
));

821 
	`lua_pushf¡ršg
(
L
, "%f", (
LUAI_UACNUMBER
)
	`lua_tÚumb”
(L, 
idx
));

824 
LUA_TSTRING
:

825 
	`lua_pushv®ue
(
L
, 
idx
);

827 
LUA_TBOOLEAN
:

828 
	`lua_push¡ršg
(
L
, (
	`lua_toboŞ—n
(L, 
idx
) ? "true" : "false"));

830 
LUA_TNIL
:

831 
	`lua_pushl™”®
(
L
, "nil");

834 
‰
 = 
	`luaL_g‘m‘af›ld
(
L
, 
idx
, "__name");

835 cÚ¡ *
kšd
 = (
‰
 =ğ
LUA_TSTRING
è? 
	`lua_to¡ršg
(
L
, -1) :

836 
	`luaL_ty³Çme
(
L
, 
idx
);

837 
	`lua_pushf¡ršg
(
L
, "%s: %p", 
kšd
, 
	`lua_tİoš‹r
(L, 
idx
));

838 ià(
‰
 !ğ
LUA_TNIL
)

839 
	`lua_»move
(
L
, -2);

844  
	`lua_tŞ¡ršg
(
L
, -1, 
Ën
);

845 
	}
}

853 #ià
defšed
(
LUA_COMPAT_MODULE
)

855 cÚ¡ *
	$luaL_fšdbË
 (
lua_S‹
 *
L
, 
idx
,

856 cÚ¡ *
âame
, 
szhšt
) {

857 cÚ¡ *
e
;

858 ià(
idx
è
	`lua_pushv®ue
(
L
, idx);

860 
e
 = 
	`¡rchr
(
âame
, '.');

861 ià(
e
 =ğ
NULL
èğ
âame
 + 
	`¡¾’
(fname);

862 
	`lua_pushl¡ršg
(
L
, 
âame
, 
e
 - fname);

863 ià(
	`lua_¿wg‘
(
L
, -2è=ğ
LUA_TNIL
) {

864 
	`lua_pİ
(
L
, 1);

865 
	`lua_ü—‹bË
(
L
, 0, (*
e
 =ğ'.' ? 1 : 
szhšt
));

866 
	`lua_pushl¡ršg
(
L
, 
âame
, 
e
 - fname);

867 
	`lua_pushv®ue
(
L
, -2);

868 
	`lua_£‰abË
(
L
, -4);

870 ià(!
	`lua_i¡abË
(
L
, -1)) {

871 
	`lua_pİ
(
L
, 2);

872  
âame
;

874 
	`lua_»move
(
L
, -2);

875 
âame
 = 
e
 + 1;

876 } *
e
 == '.');

877  
NULL
;

878 
	}
}

884 
	$libsize
 (cÚ¡ 
luaL_Reg
 *
l
) {

885 
size
 = 0;

886 ; 
l
 &&†->
Çme
;†++è
size
++;

887  
size
;

888 
	}
}

897 
LUALIB_API
 
	$luaL_pushmoduË
 (
lua_S‹
 *
L
, cÚ¡ *
modÇme
,

898 
sizehšt
) {

899 
	`luaL_fšdbË
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_LOADED_TABLE
, 1);

900 ià(
	`lua_g‘f›ld
(
L
, -1, 
modÇme
è!ğ
LUA_TTABLE
) {

901 
	`lua_pİ
(
L
, 1);

903 
	`lua_pushglob®bË
(
L
);

904 ià(
	`luaL_fšdbË
(
L
, 0, 
modÇme
, 
sizehšt
è!ğ
NULL
)

905 
	`luaL_”rÜ
(
L
, "ÇmcÚæiù fÜ moduË '%s'", 
modÇme
);

906 
	`lua_pushv®ue
(
L
, -1);

907 
	`lua_£tf›ld
(
L
, -3, 
modÇme
);

909 
	`lua_»move
(
L
, -2);

910 
	}
}

913 
LUALIB_API
 
	$luaL_İ’lib
 (
lua_S‹
 *
L
, cÚ¡ *
libÇme
,

914 cÚ¡ 
luaL_Reg
 *
l
, 
nup
) {

915 
	`luaL_checkv”siÚ
(
L
);

916 ià(
libÇme
) {

917 
	`luaL_pushmoduË
(
L
, 
libÇme
, 
	`libsize
(
l
));

918 
	`lua_š£¹
(
L
, -(
nup
 + 1));

920 ià(
l
)

921 
	`luaL_£tfuncs
(
L
, 
l
, 
nup
);

923 
	`lua_pİ
(
L
, 
nup
);

924 
	}
}

934 
LUALIB_API
 
	$luaL_£tfuncs
 (
lua_S‹
 *
L
, cÚ¡ 
luaL_Reg
 *
l
, 
nup
) {

935 
	`luaL_check¡ack
(
L
, 
nup
, "too many upvalues");

936 ; 
l
->
Çme
 !ğ
NULL
;†++) {

937 
i
;

938 
i
 = 0; i < 
nup
; i++)

939 
	`lua_pushv®ue
(
L
, -
nup
);

940 
	`lua_pushcşosu»
(
L
, 
l
->
func
, 
nup
);

941 
	`lua_£tf›ld
(
L
, -(
nup
 + 2), 
l
->
Çme
);

943 
	`lua_pİ
(
L
, 
nup
);

944 
	}
}

951 
LUALIB_API
 
	$luaL_g‘subbË
 (
lua_S‹
 *
L
, 
idx
, cÚ¡ *
âame
) {

952 ià(
	`lua_g‘f›ld
(
L
, 
idx
, 
âame
è=ğ
LUA_TTABLE
)

955 
	`lua_pİ
(
L
, 1);

956 
idx
 = 
	`lua_absšdex
(
L
, idx);

957 
	`lua_ÃwbË
(
L
);

958 
	`lua_pushv®ue
(
L
, -1);

959 
	`lua_£tf›ld
(
L
, 
idx
, 
âame
);

962 
	}
}

971 
LUALIB_API
 
	$luaL_»quœef
 (
lua_S‹
 *
L
, cÚ¡ *
modÇme
,

972 
lua_CFunùiÚ
 
İ’f
, 
glb
) {

973 
	`luaL_g‘subbË
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_LOADED_TABLE
);

974 
	`lua_g‘f›ld
(
L
, -1, 
modÇme
);

975 ià(!
	`lua_toboŞ—n
(
L
, -1)) {

976 
	`lua_pİ
(
L
, 1);

977 
	`lua_pushcfunùiÚ
(
L
, 
İ’f
);

978 
	`lua_push¡ršg
(
L
, 
modÇme
);

979 
	`lua_ÿÎ
(
L
, 1, 1);

980 
	`lua_pushv®ue
(
L
, -1);

981 
	`lua_£tf›ld
(
L
, -3, 
modÇme
);

983 
	`lua_»move
(
L
, -2);

984 ià(
glb
) {

985 
	`lua_pushv®ue
(
L
, -1);

986 
	`lua_£tglob®
(
L
, 
modÇme
);

988 
	}
}

991 
LUALIB_API
 cÚ¡ *
	$luaL_gsub
 (
lua_S‹
 *
L
, cÚ¡ *
s
, cÚ¡ *
p
,

992 cÚ¡ *
r
) {

993 cÚ¡ *
wd
;

994 
size_t
 
l
 = 
	`¡¾’
(
p
);

995 
luaL_Bufãr
 
b
;

996 
	`luaL_buffš™
(
L
, &
b
);

997 (
wd
 = 
	`¡r¡r
(
s
, 
p
)è!ğ
NULL
) {

998 
	`luaL_addl¡ršg
(&
b
, 
s
, 
wd
 - s);

999 
	`luaL_add¡ršg
(&
b
, 
r
);

1000 
s
 = 
wd
 + 
l
;

1002 
	`luaL_add¡ršg
(&
b
, 
s
);

1003 
	`luaL_push»suÉ
(&
b
);

1004  
	`lua_to¡ršg
(
L
, -1);

1005 
	}
}

1008 *
	$l_®loc
 (*
ud
, *
±r
, 
size_t
 
osize
, size_ˆ
nsize
) {

1009 ()
ud
; ()
osize
;

1010 ià(
nsize
 == 0) {

1011 
	`ä“
(
±r
);

1012  
NULL
;

1015  
	`»®loc
(
±r
, 
nsize
);

1016 
	}
}

1019 
	$·nic
 (
lua_S‹
 *
L
) {

1020 
	`lua_wr™e¡ršg”rÜ
("PANIC: unprotectedƒrror in callo Lua API (%s)\n",

1021 
	`lua_to¡ršg
(
L
, -1));

1023 
	}
}

1026 
LUALIB_API
 
lua_S‹
 *
	$luaL_Ãw¡©e
 () {

1027 
lua_S‹
 *
L
 = 
	`lua_Ãw¡©e
(
l_®loc
, 
NULL
);

1028 ià(
L
è
	`lua_©·nic
(L, &
·nic
);

1029  
L
;

1030 
	}
}

1033 
LUALIB_API
 
	$luaL_checkv”siÚ_
 (
lua_S‹
 *
L
, 
lua_Numb”
 
v”
, 
size_t
 
sz
) {

1034 cÚ¡ 
lua_Numb”
 *
v
 = 
	`lua_v”siÚ
(
L
);

1035 ià(
sz
 !ğ
LUAL_NUMSIZES
)

1036 
	`luaL_”rÜ
(
L
, "core‡nd†ibrary have incompatible‚umericypes");

1037 ià(
v
 !ğ
	`lua_v”siÚ
(
NULL
))

1038 
	`luaL_”rÜ
(
L
, "multiple Lua VMs detected");

1039 ià(*
v
 !ğ
v”
)

1040 
	`luaL_”rÜ
(
L
, "version mismatch:‡pp.‚eeds %f, Lua core…rovides %f",

1041 (
LUAI_UACNUMBER
)
v”
, (LUAI_UACNUMBER)*
v
);

1042 
	}
}

	@script/lua/lua-5.3.4/src/lauxlib.h

8 #iâdeà
Ïuxlib_h


9 
	#Ïuxlib_h


	)

12 
	~<¡ddef.h
>

13 
	~<¡dio.h
>

15 
	~"lua.h
"

20 
	#LUA_ERRFILE
 (
LUA_ERRERR
+1)

	)

24 
	#LUA_LOADED_TABLE
 "_LOADED"

	)

28 
	#LUA_PRELOAD_TABLE
 "_PRELOAD"

	)

31 
	sluaL_Reg
 {

32 cÚ¡ *
	mÇme
;

33 
lua_CFunùiÚ
 
	mfunc
;

34 } 
	tluaL_Reg
;

37 
	#LUAL_NUMSIZES
 ((
lua_IÁeg”
)*16 + (
lua_Numb”
))

	)

39 
LUALIB_API
 (
luaL_checkv”siÚ_
è(
lua_S‹
 *
L
, 
lua_Numb”
 
v”
, 
size_t
 
sz
);

40 
	#luaL_checkv”siÚ
(
L
) \

41 
	`luaL_checkv”siÚ_
(
L
, 
LUA_VERSION_NUM
, 
LUAL_NUMSIZES
)

	)

43 
LUALIB_API
 (
luaL_g‘m‘af›ld
è(
lua_S‹
 *
L
, 
obj
, cÚ¡ *
e
);

44 
LUALIB_API
 (
luaL_ÿÎm‘a
è(
lua_S‹
 *
L
, 
obj
, cÚ¡ *
e
);

45 
LUALIB_API
 cÚ¡ *(
luaL_tŞ¡ršg
è(
lua_S‹
 *
L
, 
idx
, 
size_t
 *
Ën
);

46 
LUALIB_API
 (
luaL_¬g”rÜ
è(
lua_S‹
 *
L
, 
¬g
, cÚ¡ *
exŒamsg
);

47 
LUALIB_API
 cÚ¡ *(
luaL_checkl¡ršg
è(
lua_S‹
 *
L
, 
¬g
,

48 
size_t
 *
l
);

49 
LUALIB_API
 cÚ¡ *(
luaL_İ¡ršg
è(
lua_S‹
 *
L
, 
¬g
,

50 cÚ¡ *
def
, 
size_t
 *
l
);

51 
LUALIB_API
 
	$lua_Numb”
 (
luaL_checknumb”
è(
lua_S‹
 *
L
, 
¬g
);

52 
LUALIB_API
 
	$lua_Numb”
 (
luaL_İŠumb”
è(
lua_S‹
 *
L
, 
¬g
, 
lua_Numb”
 
def
);

54 
LUALIB_API
 
	$lua_IÁeg”
 (
luaL_checkš‹g”
è(
lua_S‹
 *
L
, 
¬g
);

55 
LUALIB_API
 
	$lua_IÁeg”
 (
luaL_İtš‹g”
è(
lua_S‹
 *
L
, 
¬g
,

56 
lua_IÁeg”
 
def
);

58 
LUALIB_API
 (
luaL_check¡ack
è(
lua_S‹
 *
L
, 
sz
, cÚ¡ *
msg
);

59 
LUALIB_API
 (
luaL_checkty³
è(
lua_S‹
 *
L
, 
¬g
, 
t
);

60 
LUALIB_API
 (
luaL_checkªy
è(
lua_S‹
 *
L
, 
¬g
);

62 
LUALIB_API
 (
luaL_Ãwm‘©abË
è(
lua_S‹
 *
L
, cÚ¡ *
Šame
);

63 
LUALIB_API
 (
luaL_£tm‘©abË
è(
lua_S‹
 *
L
, cÚ¡ *
Šame
);

64 
LUALIB_API
 *(
luaL_‹¡ud©a
è(
lua_S‹
 *
L
, 
ud
, cÚ¡ *
Šame
);

65 
LUALIB_API
 *(
luaL_checkud©a
è(
lua_S‹
 *
L
, 
ud
, cÚ¡ *
Šame
);

67 
LUALIB_API
 (
luaL_wh”e
è(
lua_S‹
 *
L
, 
lvl
);

68 
LUALIB_API
 (
luaL_”rÜ
è(
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...);

70 
LUALIB_API
 (
luaL_checkİtiÚ
è(
lua_S‹
 *
L
, 
¬g
, cÚ¡ *
def
,

71 cÚ¡ *cÚ¡ 
l¡
[]);

73 
LUALIB_API
 (
luaL_f”esuÉ
è(
lua_S‹
 *
L
, 
¡©
, cÚ¡ *
âame
);

74 
LUALIB_API
 (
luaL_exeüesuÉ
è(
lua_S‹
 *
L
, 
¡©
);

77 
	#LUA_NOREF
 (-2)

	)

78 
	#LUA_REFNIL
 (-1)

	)

80 
LUALIB_API
 (
luaL_»f
è(
lua_S‹
 *
L
, 
t
);

81 
LUALIB_API
 (
luaL_uÄef
è(
lua_S‹
 *
L
, 
t
, 
»f
);

83 
LUALIB_API
 (
luaL_lßdfex
è(
lua_S‹
 *
L
, cÚ¡ *
f’ame
,

84 cÚ¡ *
mode
);

86 
	#luaL_lßdfe
(
L
,
f
è
	`luaL_lßdfex
(L,f,
NULL
)

	)

88 
LUALIB_API
 (
luaL_lßdbufãrx
è(
lua_S‹
 *
L
, cÚ¡ *
buff
, 
size_t
 
sz
,

89 cÚ¡ *
Çme
, cÚ¡ *
mode
);

90 
LUALIB_API
 (
luaL_lßd¡ršg
è(
lua_S‹
 *
L
, cÚ¡ *
s
);

92 
LUALIB_API
 
lua_S‹
 *(
luaL_Ãw¡©e
) ();

94 
LUALIB_API
 
	$lua_IÁeg”
 (
luaL_Ën
è(
lua_S‹
 *
L
, 
idx
);

96 
LUALIB_API
 cÚ¡ *(
luaL_gsub
è(
lua_S‹
 *
L
, cÚ¡ *
s
, cÚ¡ *
p
,

97 cÚ¡ *
r
);

99 
LUALIB_API
 (
luaL_£tfuncs
è(
lua_S‹
 *
L
, cÚ¡ 
luaL_Reg
 *
l
, 
nup
);

101 
LUALIB_API
 (
luaL_g‘subbË
è(
lua_S‹
 *
L
, 
idx
, cÚ¡ *
âame
);

103 
LUALIB_API
 (
luaL_Œaûback
è(
lua_S‹
 *
L
,†ua_S‹ *
L1
,

104 cÚ¡ *
msg
, 
Ëv–
);

106 
LUALIB_API
 (
luaL_»quœef
è(
lua_S‹
 *
L
, cÚ¡ *
modÇme
,

107 
lua_CFunùiÚ
 
İ’f
, 
glb
);

116 
	#luaL_ÃwlibbË
(
L
,
l
) \

117 
	`lua_ü—‹bË
(
L
, 0, (
l
)/(Ö)[0]è- 1)

	)

119 
	#luaL_Ãwlib
(
L
,
l
) \

120 (
	`luaL_checkv”siÚ
(
L
), 
	`luaL_ÃwlibbË
(L,
l
), 
	`luaL_£tfuncs
(L,l,0))

	)

122 
	#luaL_¬gcheck
(
L
, 
cÚd
,
¬g
,
exŒamsg
) \

123 (()((
cÚd
è|| 
	`luaL_¬g”rÜ
(
L
, (
¬g
), (
exŒamsg
))))

	)

124 
	#luaL_check¡ršg
(
L
,
n
è(
	`luaL_checkl¡ršg
(L, (n), 
NULL
))

	)

125 
	#luaL_İt¡ršg
(
L
,
n
,
d
è(
	`luaL_İ¡ršg
(L, (n), (d), 
NULL
))

	)

127 
	#luaL_ty³Çme
(
L
,
i
è
	`lua_ty³Çme
(L, 
	`lua_ty³
(L,(i)))

	)

129 
	#luaL_dofe
(
L
, 
â
) \

130 (
	`luaL_lßdfe
(
L
, 
â
è|| 
	`lua_pÿÎ
(L, 0, 
LUA_MULTRET
, 0))

	)

132 
	#luaL_do¡ršg
(
L
, 
s
) \

133 (
	`luaL_lßd¡ršg
(
L
, 
s
è|| 
	`lua_pÿÎ
(L, 0, 
LUA_MULTRET
, 0))

	)

135 
	#luaL_g‘m‘©abË
(
L
,
n
è(
	`lua_g‘f›ld
(L, 
LUA_REGISTRYINDEX
, (n)))

	)

137 
	#luaL_İt
(
L
,
f
,
n
,
d
è(
	`lua_i¢ÚeÜn
(L,Ò)è? (dè: 
	`f
(L,Ò)))

	)

139 
	#luaL_lßdbufãr
(
L
,
s
,
sz
,
n
è
	`luaL_lßdbufãrx
(L,s,sz,n,
NULL
)

	)

148 
	sluaL_Bufãr
 {

149 *
b
;

150 
size_t
 
size
;

151 
size_t
 
n
;

152 
lua_S‹
 *
L
;

153 
š™b
[
LUAL_BUFFERSIZE
];

154 } 
	tluaL_Bufãr
;

157 
	#luaL_addch¬
(
B
,
c
) \

158 (()((
B
)->
n
 < (B)->
size
 || 
	`luaL_´•buffsize
((B), 1)), \

159 ((
B
)->
b
[(B)->
n
++] = (
c
)))

	)

161 
	#luaL_addsize
(
B
,
s
è((B)->
n
 +ğ(s))

	)

163 
LUALIB_API
 (
luaL_buffš™
è(
lua_S‹
 *
L
, 
luaL_Bufãr
 *
B
);

164 
LUALIB_API
 *(
luaL_´•buffsize
è(
luaL_Bufãr
 *
B
, 
size_t
 
sz
);

165 
LUALIB_API
 (
luaL_addl¡ršg
è(
luaL_Bufãr
 *
B
, cÚ¡ *
s
, 
size_t
 
l
);

166 
LUALIB_API
 (
luaL_add¡ršg
è(
luaL_Bufãr
 *
B
, cÚ¡ *
s
);

167 
LUALIB_API
 (
luaL_addv®ue
è(
luaL_Bufãr
 *
B
);

168 
LUALIB_API
 (
luaL_push»suÉ
è(
luaL_Bufãr
 *
B
);

169 
LUALIB_API
 (
luaL_push»suÉsize
è(
luaL_Bufãr
 *
B
, 
size_t
 
sz
);

170 
LUALIB_API
 *(
luaL_buffš™size
è(
lua_S‹
 *
L
, 
luaL_Bufãr
 *
B
, 
size_t
 
sz
);

172 
	#luaL_´•bufãr
(
B
è
	`luaL_´•buffsize
(B, 
LUAL_BUFFERSIZE
)

	)

190 
	#LUA_FILEHANDLE
 "FILE*"

	)

193 
	sluaL_SŒ—m
 {

194 
FILE
 *
f
;

195 
lua_CFunùiÚ
 
şo£f
;

196 } 
	tluaL_SŒ—m
;

203 #ià
	`defšed
(
LUA_COMPAT_MODULE
)

205 
LUALIB_API
 (
luaL_pushmoduË
è(
lua_S‹
 *
L
, cÚ¡ *
modÇme
,

206 
sizehšt
);

207 
LUALIB_API
 (
luaL_İ’lib
è(
lua_S‹
 *
L
, cÚ¡ *
libÇme
,

208 cÚ¡ 
luaL_Reg
 *
l
, 
nup
);

210 
	#luaL_»gi¡”
(
L
,
n
,
l
è(
	`luaL_İ’lib
(L,Ò),Ö),0))

	)

222 #ià!
	`defšed
(
lua_wr™e¡ršg
)

223 
	#lua_wr™e¡ršg
(
s
,
l
è
	`fwr™e
((s), (), (l), 
¡dout
)

	)

227 #ià!
	`defšed
(
lua_wr™–še
)

228 
	#lua_wr™–še
(è(
	`lua_wr™e¡ršg
("\n", 1), 
	`fæush
(
¡dout
))

	)

232 #ià!
	`defšed
(
lua_wr™e¡ršg”rÜ
)

233 
	#lua_wr™e¡ršg”rÜ
(
s
,
p
) \

234 (
	`årštf
(
¡d”r
, (
s
), (
p
)), 
	`fæush
(¡d”r))

	)

245 #ià
	`defšed
(
LUA_COMPAT_APIINTCASTS
)

247 
	#luaL_checkunsigÃd
(
L
,
a
è((
lua_UnsigÃd
)
	`luaL_checkš‹g”
(L,a))

	)

248 
	#luaL_İtunsigÃd
(
L
,
a
,
d
) \

249 ((
lua_UnsigÃd
)
	`luaL_İtš‹g”
(
L
,
a
,(
lua_IÁeg”
)(
d
)))

	)

251 
	#luaL_checkšt
(
L
,
n
è(()
	`luaL_checkš‹g”
(L, (n)))

	)

252 
	#luaL_İtšt
(
L
,
n
,
d
è(()
	`luaL_İtš‹g”
(L, (n), (d)))

	)

254 
	#luaL_checklÚg
(
L
,
n
è(()
	`luaL_checkš‹g”
(L, (n)))

	)

255 
	#luaL_İÚg
(
L
,
n
,
d
è(()
	`luaL_İtš‹g”
(L, (n), (d)))

	)

	@script/lua/lua-5.3.4/src/lbaselib.c

7 
	#lba£lib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<ùy³.h
>

14 
	~<¡dio.h
>

15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

18 
	~"lua.h
"

20 
	~"Ïuxlib.h
"

21 
	~"lu®ib.h
"

24 
	$luaB_´št
 (
lua_S‹
 *
L
) {

25 
n
 = 
	`lua_g‘tİ
(
L
);

26 
i
;

27 
	`lua_g‘glob®
(
L
, "tostring");

28 
i
=1; i<=
n
; i++) {

29 cÚ¡ *
s
;

30 
size_t
 
l
;

31 
	`lua_pushv®ue
(
L
, -1);

32 
	`lua_pushv®ue
(
L
, 
i
);

33 
	`lua_ÿÎ
(
L
, 1, 1);

34 
s
 = 
	`lua_tŞ¡ršg
(
L
, -1, &
l
);

35 ià(
s
 =ğ
NULL
)

36  
	`luaL_”rÜ
(
L
, "'tostring' must„eturn‡ stringo 'print'");

37 ià(
i
>1è
	`lua_wr™e¡ršg
("\t", 1);

38 
	`lua_wr™e¡ršg
(
s
, 
l
);

39 
	`lua_pİ
(
L
, 1);

41 
	`lua_wr™–še
();

43 
	}
}

46 
	#SPACECHARS
 " \f\n\r\t\v"

	)

48 cÚ¡ *
	$b_¡r2št
 (cÚ¡ *
s
, 
ba£
, 
lua_IÁeg”
 *
²
) {

49 
lua_UnsigÃd
 
n
 = 0;

50 
Ãg
 = 0;

51 
s
 +ğ
	`¡r¥n
(s, 
SPACECHARS
);

52 ià(*
s
 =ğ'-'è{ s++; 
Ãg
 = 1; }

53 ià(*
s
 == '+') s++;

54 ià(!
	`i§Êum
(()*
s
))

55  
NULL
;

57 
dig™
 = (
	`isdig™
(()*
s
)) ? *s - '0'

58 : (
	`touµ”
(()*
s
) - 'A') + 10;

59 ià(
dig™
 >ğ
ba£
è 
NULL
;

60 
n
 =‚ * 
ba£
 + 
dig™
;

61 
s
++;

62 } 
	`i§Êum
(()*
s
));

63 
s
 +ğ
	`¡r¥n
(s, 
SPACECHARS
);

64 *
²
 = (
lua_IÁeg”
)((
Ãg
è? (0u - 
n
) :‚);

65  
s
;

66 
	}
}

69 
	$luaB_tÚumb”
 (
lua_S‹
 *
L
) {

70 ià(
	`lua_i¢ÚeÜn
(
L
, 2)) {

71 
	`luaL_checkªy
(
L
, 1);

72 ià(
	`lua_ty³
(
L
, 1è=ğ
LUA_TNUMBER
) {

73 
	`lua_£‰İ
(
L
, 1);

77 
size_t
 
l
;

78 cÚ¡ *
s
 = 
	`lua_tŞ¡ršg
(
L
, 1, &
l
);

79 ià(
s
 !ğ
NULL
 && 
	`lua_¡ršgtÚumb”
(
L
, sè=ğ
l
 + 1)

85 
size_t
 
l
;

86 cÚ¡ *
s
;

87 
lua_IÁeg”
 
n
 = 0;

88 
lua_IÁeg”
 
ba£
 = 
	`luaL_checkš‹g”
(
L
, 2);

89 
	`luaL_checkty³
(
L
, 1, 
LUA_TSTRING
);

90 
s
 = 
	`lua_tŞ¡ršg
(
L
, 1, &
l
);

91 
	`luaL_¬gcheck
(
L
, 2 <ğ
ba£
 && base <= 36, 2, "base out of„ange");

92 ià(
	`b_¡r2št
(
s
, ()
ba£
, &
n
è=ğ + 
l
) {

93 
	`lua_pushš‹g”
(
L
, 
n
);

97 
	`lua_pushn
(
L
);

99 
	}
}

102 
	$luaB_”rÜ
 (
lua_S‹
 *
L
) {

103 
Ëv–
 = ()
	`luaL_İtš‹g”
(
L
, 2, 1);

104 
	`lua_£‰İ
(
L
, 1);

105 ià(
	`lua_ty³
(
L
, 1è=ğ
LUA_TSTRING
 && 
Ëv–
 > 0) {

106 
	`luaL_wh”e
(
L
, 
Ëv–
);

107 
	`lua_pushv®ue
(
L
, 1);

108 
	`lua_cÚÿt
(
L
, 2);

110  
	`lua_”rÜ
(
L
);

111 
	}
}

114 
	$luaB_g‘m‘©abË
 (
lua_S‹
 *
L
) {

115 
	`luaL_checkªy
(
L
, 1);

116 ià(!
	`lua_g‘m‘©abË
(
L
, 1)) {

117 
	`lua_pushn
(
L
);

120 
	`luaL_g‘m‘af›ld
(
L
, 1, "__metatable");

122 
	}
}

125 
	$luaB_£tm‘©abË
 (
lua_S‹
 *
L
) {

126 
t
 = 
	`lua_ty³
(
L
, 2);

127 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

128 
	`luaL_¬gcheck
(
L
, 
t
 =ğ
LUA_TNIL
 || =ğ
LUA_TTABLE
, 2,

130 ià(
	`luaL_g‘m‘af›ld
(
L
, 1, "__m‘©abË"è!ğ
LUA_TNIL
)

131  
	`luaL_”rÜ
(
L
, "cannot change‡…rotected metatable");

132 
	`lua_£‰İ
(
L
, 2);

133 
	`lua_£tm‘©abË
(
L
, 1);

135 
	}
}

138 
	$luaB_¿wequ®
 (
lua_S‹
 *
L
) {

139 
	`luaL_checkªy
(
L
, 1);

140 
	`luaL_checkªy
(
L
, 2);

141 
	`lua_pushboŞ—n
(
L
, 
	`lua_¿wequ®
(L, 1, 2));

143 
	}
}

146 
	$luaB_¿wËn
 (
lua_S‹
 *
L
) {

147 
t
 = 
	`lua_ty³
(
L
, 1);

148 
	`luaL_¬gcheck
(
L
, 
t
 =ğ
LUA_TTABLE
 || =ğ
LUA_TSTRING
, 1,

150 
	`lua_pushš‹g”
(
L
, 
	`lua_¿wËn
(L, 1));

152 
	}
}

155 
	$luaB_¿wg‘
 (
lua_S‹
 *
L
) {

156 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

157 
	`luaL_checkªy
(
L
, 2);

158 
	`lua_£‰İ
(
L
, 2);

159 
	`lua_¿wg‘
(
L
, 1);

161 
	}
}

163 
	$luaB_¿w£t
 (
lua_S‹
 *
L
) {

164 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

165 
	`luaL_checkªy
(
L
, 2);

166 
	`luaL_checkªy
(
L
, 3);

167 
	`lua_£‰İ
(
L
, 3);

168 
	`lua_¿w£t
(
L
, 1);

170 
	}
}

173 
	$luaB_cŞËùg¬bage
 (
lua_S‹
 *
L
) {

174 cÚ¡ *cÚ¡ 
İts
[] = {"stop", "restart", "collect",

176 "i¤uÂšg", 
NULL
};

177 cÚ¡ 
İt¢um
[] = {
LUA_GCSTOP
, 
LUA_GCRESTART
, 
LUA_GCCOLLECT
,

178 
LUA_GCCOUNT
, 
LUA_GCSTEP
, 
LUA_GCSETPAUSE
, 
LUA_GCSETSTEPMUL
,

179 
LUA_GCISRUNNING
};

180 
o
 = 
İt¢um
[
	`luaL_checkİtiÚ
(
L
, 1, "cŞËù", 
İts
)];

181 
ex
 = ()
	`luaL_İtš‹g”
(
L
, 2, 0);

182 
»s
 = 
	`lua_gc
(
L
, 
o
, 
ex
);

183 
o
) {

184 
LUA_GCCOUNT
: {

185 
b
 = 
	`lua_gc
(
L
, 
LUA_GCCOUNTB
, 0);

186 
	`lua_pushnumb”
(
L
, (
lua_Numb”
)
»s
 + (Öua_Numb”)
b
/1024));

189 
LUA_GCSTEP
: 
LUA_GCISRUNNING
: {

190 
	`lua_pushboŞ—n
(
L
, 
»s
);

194 
	`lua_pushš‹g”
(
L
, 
»s
);

198 
	}
}

201 
	$luaB_ty³
 (
lua_S‹
 *
L
) {

202 
t
 = 
	`lua_ty³
(
L
, 1);

203 
	`luaL_¬gcheck
(
L
, 
t
 !ğ
LUA_TNONE
, 1, "valueƒxpected");

204 
	`lua_push¡ršg
(
L
, 
	`lua_ty³Çme
(L, 
t
));

206 
	}
}

209 
	$·œsm‘a
 (
lua_S‹
 *
L
, cÚ¡ *
m‘hod
, 
isz”o
,

210 
lua_CFunùiÚ
 
™”
) {

211 
	`luaL_checkªy
(
L
, 1);

212 ià(
	`luaL_g‘m‘af›ld
(
L
, 1, 
m‘hod
è=ğ
LUA_TNIL
) {

213 
	`lua_pushcfunùiÚ
(
L
, 
™”
);

214 
	`lua_pushv®ue
(
L
, 1);

215 ià(
isz”o
è
	`lua_pushš‹g”
(
L
, 0);

216 
	`lua_pushn
(
L
);

219 
	`lua_pushv®ue
(
L
, 1);

220 
	`lua_ÿÎ
(
L
, 1, 3);

223 
	}
}

226 
	$luaB_Ãxt
 (
lua_S‹
 *
L
) {

227 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

228 
	`lua_£‰İ
(
L
, 2);

229 ià(
	`lua_Ãxt
(
L
, 1))

232 
	`lua_pushn
(
L
);

235 
	}
}

238 
	$luaB_·œs
 (
lua_S‹
 *
L
) {

239  
	`·œsm‘a
(
L
, "__·œs", 0, 
luaB_Ãxt
);

240 
	}
}

246 
	$aœ§ux
 (
lua_S‹
 *
L
) {

247 
lua_IÁeg”
 
i
 = 
	`luaL_checkš‹g”
(
L
, 2) + 1;

248 
	`lua_pushš‹g”
(
L
, 
i
);

249  (
	`lua_g‘i
(
L
, 1, 
i
è=ğ
LUA_TNIL
) ? 1 : 2;

250 
	}
}

257 
	$luaB_aœs
 (
lua_S‹
 *
L
) {

258 #ià
	`defšed
(
LUA_COMPAT_IPAIRS
)

259  
	`·œsm‘a
(
L
, "__aœs", 1, 
aœ§ux
);

261 
	`luaL_checkªy
(
L
, 1);

262 
	`lua_pushcfunùiÚ
(
L
, 
aœ§ux
);

263 
	`lua_pushv®ue
(
L
, 1);

264 
	`lua_pushš‹g”
(
L
, 0);

267 
	}
}

270 
	$lßd_aux
 (
lua_S‹
 *
L
, 
¡©us
, 
’vidx
) {

271 ià(
¡©us
 =ğ
LUA_OK
) {

272 ià(
’vidx
 != 0) {

273 
	`lua_pushv®ue
(
L
, 
’vidx
);

274 ià(!
	`lua_£tupv®ue
(
L
, -2, 1))

275 
	`lua_pİ
(
L
, 1);

280 
	`lua_pushn
(
L
);

281 
	`lua_š£¹
(
L
, -2);

284 
	}
}

287 
	$luaB_lßdfe
 (
lua_S‹
 *
L
) {

288 cÚ¡ *
âame
 = 
	`luaL_İt¡ršg
(
L
, 1, 
NULL
);

289 cÚ¡ *
mode
 = 
	`luaL_İt¡ršg
(
L
, 2, 
NULL
);

290 
’v
 = (!
	`lua_i¢Úe
(
L
, 3) ? 3 : 0);

291 
¡©us
 = 
	`luaL_lßdfex
(
L
, 
âame
, 
mode
);

292  
	`lßd_aux
(
L
, 
¡©us
, 
’v
);

293 
	}
}

308 
	#RESERVEDSLOT
 5

	)

317 cÚ¡ *
	$g’”ic_»ad”
 (
lua_S‹
 *
L
, *
ud
, 
size_t
 *
size
) {

318 ()(
ud
);

319 
	`luaL_check¡ack
(
L
, 2, "too many‚ested functions");

320 
	`lua_pushv®ue
(
L
, 1);

321 
	`lua_ÿÎ
(
L
, 0, 1);

322 ià(
	`lua_i¢
(
L
, -1)) {

323 
	`lua_pİ
(
L
, 1);

324 *
size
 = 0;

325  
NULL
;

327 ià(!
	`lua_is¡ršg
(
L
, -1))

328 
	`luaL_”rÜ
(
L
, "reader function must„eturn‡ string");

329 
	`lua_»¶aû
(
L
, 
RESERVEDSLOT
);

330  
	`lua_tŞ¡ršg
(
L
, 
RESERVEDSLOT
, 
size
);

331 
	}
}

334 
	$luaB_lßd
 (
lua_S‹
 *
L
) {

335 
¡©us
;

336 
size_t
 
l
;

337 cÚ¡ *
s
 = 
	`lua_tŞ¡ršg
(
L
, 1, &
l
);

338 cÚ¡ *
mode
 = 
	`luaL_İt¡ršg
(
L
, 3, "bt");

339 
’v
 = (!
	`lua_i¢Úe
(
L
, 4) ? 4 : 0);

340 ià(
s
 !ğ
NULL
) {

341 cÚ¡ *
chunkÇme
 = 
	`luaL_İt¡ršg
(
L
, 2, 
s
);

342 
¡©us
 = 
	`luaL_lßdbufãrx
(
L
, 
s
, 
l
, 
chunkÇme
, 
mode
);

345 cÚ¡ *
chunkÇme
 = 
	`luaL_İt¡ršg
(
L
, 2, "=(load)");

346 
	`luaL_checkty³
(
L
, 1, 
LUA_TFUNCTION
);

347 
	`lua_£‰İ
(
L
, 
RESERVEDSLOT
);

348 
¡©us
 = 
	`lua_lßd
(
L
, 
g’”ic_»ad”
, 
NULL
, 
chunkÇme
, 
mode
);

350  
	`lßd_aux
(
L
, 
¡©us
, 
’v
);

351 
	}
}

356 
	$dofecÚt
 (
lua_S‹
 *
L
, 
d1
, 
lua_KCÚ‹xt
 
d2
) {

357 ()
d1
; ()
d2
;

358  
	`lua_g‘tİ
(
L
) - 1;

359 
	}
}

362 
	$luaB_dofe
 (
lua_S‹
 *
L
) {

363 cÚ¡ *
âame
 = 
	`luaL_İt¡ršg
(
L
, 1, 
NULL
);

364 
	`lua_£‰İ
(
L
, 1);

365 ià(
	`luaL_lßdfe
(
L
, 
âame
è!ğ
LUA_OK
)

366  
	`lua_”rÜ
(
L
);

367 
	`lua_ÿÎk
(
L
, 0, 
LUA_MULTRET
, 0, 
dofecÚt
);

368  
	`dofecÚt
(
L
, 0, 0);

369 
	}
}

372 
	$luaB_as£¹
 (
lua_S‹
 *
L
) {

373 ià(
	`lua_toboŞ—n
(
L
, 1))

374  
	`lua_g‘tİ
(
L
);

376 
	`luaL_checkªy
(
L
, 1);

377 
	`lua_»move
(
L
, 1);

378 
	`lua_pushl™”®
(
L
, "assertion failed!");

379 
	`lua_£‰İ
(
L
, 1);

380  
	`luaB_”rÜ
(
L
);

382 
	}
}

385 
	$luaB_£Ëù
 (
lua_S‹
 *
L
) {

386 
n
 = 
	`lua_g‘tİ
(
L
);

387 ià(
	`lua_ty³
(
L
, 1è=ğ
LUA_TSTRING
 && *
	`lua_to¡ršg
(L, 1) == '#') {

388 
	`lua_pushš‹g”
(
L
, 
n
-1);

392 
lua_IÁeg”
 
i
 = 
	`luaL_checkš‹g”
(
L
, 1);

393 ià(
i
 < 0è˜ğ
n
 + i;

394 ià(
i
 > 
n
) i =‚;

395 
	`luaL_¬gcheck
(
L
, 1 <ğ
i
, 1, "index out of„ange");

396  
n
 - ()
i
;

398 
	}
}

408 
	$fšishpÿÎ
 (
lua_S‹
 *
L
, 
¡©us
, 
lua_KCÚ‹xt
 
exŒa
) {

409 ià(
¡©us
 !ğ
LUA_OK
 && stu !ğ
LUA_YIELD
) {

410 
	`lua_pushboŞ—n
(
L
, 0);

411 
	`lua_pushv®ue
(
L
, -2);

415  
	`lua_g‘tİ
(
L
è- ()
exŒa
;

416 
	}
}

419 
	$luaB_pÿÎ
 (
lua_S‹
 *
L
) {

420 
¡©us
;

421 
	`luaL_checkªy
(
L
, 1);

422 
	`lua_pushboŞ—n
(
L
, 1);

423 
	`lua_š£¹
(
L
, 1);

424 
¡©us
 = 
	`lua_pÿÎk
(
L
, 
	`lua_g‘tİ
(Lè- 2, 
LUA_MULTRET
, 0, 0, 
fšishpÿÎ
);

425  
	`fšishpÿÎ
(
L
, 
¡©us
, 0);

426 
	}
}

434 
	$luaB_xpÿÎ
 (
lua_S‹
 *
L
) {

435 
¡©us
;

436 
n
 = 
	`lua_g‘tİ
(
L
);

437 
	`luaL_checkty³
(
L
, 2, 
LUA_TFUNCTION
);

438 
	`lua_pushboŞ—n
(
L
, 1);

439 
	`lua_pushv®ue
(
L
, 1);

440 
	`lua_rÙ©e
(
L
, 3, 2);

441 
¡©us
 = 
	`lua_pÿÎk
(
L
, 
n
 - 2, 
LUA_MULTRET
, 2, 2, 
fšishpÿÎ
);

442  
	`fšishpÿÎ
(
L
, 
¡©us
, 2);

443 
	}
}

446 
	$luaB_to¡ršg
 (
lua_S‹
 *
L
) {

447 
	`luaL_checkªy
(
L
, 1);

448 
	`luaL_tŞ¡ršg
(
L
, 1, 
NULL
);

450 
	}
}

453 cÚ¡ 
luaL_Reg
 
	gba£_funcs
[] = {

454 {"as£¹", 
luaB_as£¹
},

455 {"cŞËùg¬bage", 
luaB_cŞËùg¬bage
},

456 {"dofe", 
luaB_dofe
},

457 {"”rÜ", 
luaB_”rÜ
},

458 {"g‘m‘©abË", 
luaB_g‘m‘©abË
},

459 {"aœs", 
luaB_aœs
},

460 {"lßdfe", 
luaB_lßdfe
},

461 {"lßd", 
luaB_lßd
},

462 #ià
defšed
(
LUA_COMPAT_LOADSTRING
)

463 {"lßd¡ršg", 
luaB_lßd
},

465 {"Ãxt", 
luaB_Ãxt
},

466 {"·œs", 
luaB_·œs
},

467 {"pÿÎ", 
luaB_pÿÎ
},

468 {"´št", 
luaB_´št
},

469 {"¿wequ®", 
luaB_¿wequ®
},

470 {"¿wËn", 
luaB_¿wËn
},

471 {"¿wg‘", 
luaB_¿wg‘
},

472 {"¿w£t", 
luaB_¿w£t
},

473 {"£Ëù", 
luaB_£Ëù
},

474 {"£tm‘©abË", 
luaB_£tm‘©abË
},

475 {"tÚumb”", 
luaB_tÚumb”
},

476 {"to¡ršg", 
luaB_to¡ršg
},

477 {"ty³", 
luaB_ty³
},

478 {"xpÿÎ", 
luaB_xpÿÎ
},

480 {"_G", 
NULL
},

481 {"_VERSION", 
NULL
},

482 {
NULL
, NULL}

486 
LUAMOD_API
 
	$luaİ’_ba£
 (
lua_S‹
 *
L
) {

488 
	`lua_pushglob®bË
(
L
);

489 
	`luaL_£tfuncs
(
L
, 
ba£_funcs
, 0);

491 
	`lua_pushv®ue
(
L
, -1);

492 
	`lua_£tf›ld
(
L
, -2, "_G");

494 
	`lua_pushl™”®
(
L
, 
LUA_VERSION
);

495 
	`lua_£tf›ld
(
L
, -2, "_VERSION");

497 
	}
}

	@script/lua/lua-5.3.4/src/lbitlib.c

7 
	#lb™lib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~"lua.h
"

15 
	~"Ïuxlib.h
"

16 
	~"lu®ib.h
"

19 #ià
defšed
(
LUA_COMPAT_BITLIB
)

22 
	#pushunsigÃd
(
L
,
n
è
	`lua_pushš‹g”
(L, (
lua_IÁeg”
)Ò))

	)

23 
	#checkunsigÃd
(
L
,
i
è((
lua_UnsigÃd
)
	`luaL_checkš‹g”
(L,i))

	)

27 #ià!
defšed
(
LUA_NBITS
)

28 
	#LUA_NBITS
 32

	)

37 
	#ALLONES
 (~(((~(
lua_UnsigÃd
)0è<< (
LUA_NBITS
 - 1)è<< 1))

	)

41 
	#Œim
(
x
è((xè& 
ALLONES
)

	)

45 
	#mask
(
n
è(~((
ALLONES
 << 1è<< (Òè- 1)))

	)

49 
lua_UnsigÃd
 
	$ªdaux
 (
lua_S‹
 *
L
) {

50 
i
, 
n
 = 
	`lua_g‘tİ
(
L
);

51 
lua_UnsigÃd
 
r
 = ~(lua_Unsigned)0;

52 
i
 = 1; i <ğ
n
; i++)

53 
r
 &ğ
	`checkunsigÃd
(
L
, 
i
);

54  
	`Œim
(
r
);

55 
	}
}

58 
	$b_ªd
 (
lua_S‹
 *
L
) {

59 
lua_UnsigÃd
 
r
 = 
	`ªdaux
(
L
);

60 
	`pushunsigÃd
(
L
, 
r
);

62 
	}
}

65 
	$b_‹¡
 (
lua_S‹
 *
L
) {

66 
lua_UnsigÃd
 
r
 = 
	`ªdaux
(
L
);

67 
	`lua_pushboŞ—n
(
L
, 
r
 != 0);

69 
	}
}

72 
	$b_Ü
 (
lua_S‹
 *
L
) {

73 
i
, 
n
 = 
	`lua_g‘tİ
(
L
);

74 
lua_UnsigÃd
 
r
 = 0;

75 
i
 = 1; i <ğ
n
; i++)

76 
r
 |ğ
	`checkunsigÃd
(
L
, 
i
);

77 
	`pushunsigÃd
(
L
, 
	`Œim
(
r
));

79 
	}
}

82 
	$b_xÜ
 (
lua_S‹
 *
L
) {

83 
i
, 
n
 = 
	`lua_g‘tİ
(
L
);

84 
lua_UnsigÃd
 
r
 = 0;

85 
i
 = 1; i <ğ
n
; i++)

86 
r
 ^ğ
	`checkunsigÃd
(
L
, 
i
);

87 
	`pushunsigÃd
(
L
, 
	`Œim
(
r
));

89 
	}
}

92 
	$b_nÙ
 (
lua_S‹
 *
L
) {

93 
lua_UnsigÃd
 
r
 = ~
	`checkunsigÃd
(
L
, 1);

94 
	`pushunsigÃd
(
L
, 
	`Œim
(
r
));

96 
	}
}

99 
	$b_shiá
 (
lua_S‹
 *
L
, 
lua_UnsigÃd
 
r
, 
lua_IÁeg”
 
i
) {

100 ià(
i
 < 0) {

101 
i
 = -i;

102 
r
 = 
	`Œim
(r);

103 ià(
i
 >ğ
LUA_NBITS
è
r
 = 0;

104 
r
 >>ğ
i
;

107 ià(
i
 >ğ
LUA_NBITS
è
r
 = 0;

108 
r
 <<ğ
i
;

109 
r
 = 
	`Œim
(r);

111 
	`pushunsigÃd
(
L
, 
r
);

113 
	}
}

116 
	$b_lshiá
 (
lua_S‹
 *
L
) {

117  
	`b_shiá
(
L
, 
	`checkunsigÃd
(L, 1), 
	`luaL_checkš‹g”
(L, 2));

118 
	}
}

121 
	$b_rshiá
 (
lua_S‹
 *
L
) {

122  
	`b_shiá
(
L
, 
	`checkunsigÃd
(L, 1), -
	`luaL_checkš‹g”
(L, 2));

123 
	}
}

126 
	$b_¬shiá
 (
lua_S‹
 *
L
) {

127 
lua_UnsigÃd
 
r
 = 
	`checkunsigÃd
(
L
, 1);

128 
lua_IÁeg”
 
i
 = 
	`luaL_checkš‹g”
(
L
, 2);

129 ià(
i
 < 0 || !(
r
 & ((
lua_UnsigÃd
)1 << (
LUA_NBITS
 - 1))))

130  
	`b_shiá
(
L
, 
r
, -
i
);

132 ià(
i
 >ğ
LUA_NBITS
è
r
 = 
ALLONES
;

134 
r
 = 
	`Œim
(Ô >> 
i
è| ~Ñrim(~(
lua_UnsigÃd
)0) >> i));

135 
	`pushunsigÃd
(
L
, 
r
);

138 
	}
}

141 
	$b_rÙ
 (
lua_S‹
 *
L
, 
lua_IÁeg”
 
d
) {

142 
lua_UnsigÃd
 
r
 = 
	`checkunsigÃd
(
L
, 1);

143 
i
 = 
d
 & (
LUA_NBITS
 - 1);

144 
r
 = 
	`Œim
(r);

145 ià(
i
 != 0)

146 
r
 = (¸<< 
i
è| (¸>> (
LUA_NBITS
 - i));

147 
	`pushunsigÃd
(
L
, 
	`Œim
(
r
));

149 
	}
}

152 
	$b_ÌÙ
 (
lua_S‹
 *
L
) {

153  
	`b_rÙ
(
L
, 
	`luaL_checkš‹g”
(L, 2));

154 
	}
}

157 
	$b_¼Ù
 (
lua_S‹
 *
L
) {

158  
	`b_rÙ
(
L
, -
	`luaL_checkš‹g”
(L, 2));

159 
	}
}

168 
	$f›ld¬gs
 (
lua_S‹
 *
L
, 
çrg
, *
width
) {

169 
lua_IÁeg”
 
f
 = 
	`luaL_checkš‹g”
(
L
, 
çrg
);

170 
lua_IÁeg”
 
w
 = 
	`luaL_İtš‹g”
(
L
, 
çrg
 + 1, 1);

171 
	`luaL_¬gcheck
(
L
, 0 <ğ
f
, 
çrg
, "field cannot be‚egative");

172 
	`luaL_¬gcheck
(
L
, 0 < 
w
, 
çrg
 + 1, "width must be…ositive");

173 ià(
f
 + 
w
 > 
LUA_NBITS
)

174 
	`luaL_”rÜ
(
L
, "tryingo‡ccess‚on-existent bits");

175 *
width
 = ()
w
;

176  ()
f
;

177 
	}
}

180 
	$b_exŒaù
 (
lua_S‹
 *
L
) {

181 
w
;

182 
lua_UnsigÃd
 
r
 = 
	`Œim
(
	`checkunsigÃd
(
L
, 1));

183 
f
 = 
	`f›ld¬gs
(
L
, 2, &
w
);

184 
r
 = (¸>> 
f
è& 
	`mask
(
w
);

185 
	`pushunsigÃd
(
L
, 
r
);

187 
	}
}

190 
	$b_»¶aû
 (
lua_S‹
 *
L
) {

191 
w
;

192 
lua_UnsigÃd
 
r
 = 
	`Œim
(
	`checkunsigÃd
(
L
, 1));

193 
lua_UnsigÃd
 
v
 = 
	`Œim
(
	`checkunsigÃd
(
L
, 2));

194 
f
 = 
	`f›ld¬gs
(
L
, 3, &
w
);

195 
lua_UnsigÃd
 
m
 = 
	`mask
(
w
);

196 
r
 = (¸& ~(
m
 << 
f
)è| ((
v
 & m) << f);

197 
	`pushunsigÃd
(
L
, 
r
);

199 
	}
}

202 cÚ¡ 
luaL_Reg
 
	gb™lib
[] = {

203 {"¬shiá", 
b_¬shiá
},

204 {"bªd", 
b_ªd
},

205 {"bnÙ", 
b_nÙ
},

206 {"bÜ", 
b_Ü
},

207 {"bxÜ", 
b_xÜ
},

208 {"b‹¡", 
b_‹¡
},

209 {"exŒaù", 
b_exŒaù
},

210 {"ÌÙ©e", 
b_ÌÙ
},

211 {"lshiá", 
b_lshiá
},

212 {"»¶aû", 
b_»¶aû
},

213 {"¼Ù©e", 
b_¼Ù
},

214 {"rshiá", 
b_rshiá
},

215 {
NULL
, NULL}

220 
LUAMOD_API
 
	$luaİ’_b™32
 (
lua_S‹
 *
L
) {

221 
	`luaL_Ãwlib
(
L
, 
b™lib
);

223 
	}
}

229 
LUAMOD_API
 
	$luaİ’_b™32
 (
lua_S‹
 *
L
) {

230  
	`luaL_”rÜ
(
L
, "library 'bit32' has been deprecated");

231 
	}
}

	@script/lua/lua-5.3.4/src/lcode.c

7 
	#lcode_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<m©h.h
>

14 
	~<¡dlib.h
>

16 
	~"lua.h
"

18 
	~"lcode.h
"

19 
	~"ldebug.h
"

20 
	~"ldo.h
"

21 
	~"lgc.h
"

22 
	~"Îex.h
"

23 
	~"lmem.h
"

24 
	~"lobjeù.h
"

25 
	~"lİcodes.h
"

26 
	~"Í¬£r.h
"

27 
	~"l¡ršg.h
"

28 
	~"ÉabË.h
"

29 
	~"lvm.h
"

33 
	#MAXREGS
 255

	)

36 
	#hasjumps
(
e
è(Ó)->
t
 !ğÓ)->
f
)

	)

43 
	$tÚum”®
(cÚ¡ 
expdesc
 *
e
, 
TV®ue
 *
v
) {

44 ià(
	`hasjumps
(
e
))

46 
e
->
k
) {

47 
VKINT
:

48 ià(
v
è
	`£tiv®ue
(v, 
e
->
u
.
iv®
);

50 
VKFLT
:

51 ià(
v
è
	`£tætv®ue
(v, 
e
->
u
.
nv®
);

55 
	}
}

64 
	$luaK_n
 (
FuncS‹
 *
fs
, 
äom
, 
n
) {

65 
In¡ruùiÚ
 *
´evious
;

66 
l
 = 
äom
 + 
n
 - 1;

67 ià(
fs
->
pc
 > fs->
Ï¡rg‘
) {

68 
´evious
 = &
fs
->
f
->
code
[fs->
pc
-1];

69 ià(
	`GET_OPCODE
(*
´evious
è=ğ
OP_LOADNIL
) {

70 
päom
 = 
	`GETARG_A
(*
´evious
);

71 
¶
 = 
päom
 + 
	`GETARG_B
(*
´evious
);

72 ià((
päom
 <ğ
äom
 && from <ğ
¶
 + 1) ||

73 (
äom
 <ğ
päom
 &&…äom <ğ
l
 + 1)) {

74 ià(
päom
 < 
äom
) from =…from;

75 ià(
¶
 > 
l
)† =…l;

76 
	`SETARG_A
(*
´evious
, 
äom
);

77 
	`SETARG_B
(*
´evious
, 
l
 - 
äom
);

82 
	`luaK_codeABC
(
fs
, 
OP_LOADNIL
, 
äom
, 
n
 - 1, 0);

83 
	}
}

90 
	$g‘jump
 (
FuncS‹
 *
fs
, 
pc
) {

91 
off£t
 = 
	`GETARG_sBx
(
fs
->
f
->
code
[
pc
]);

92 ià(
off£t
 =ğ
NO_JUMP
)

93  
NO_JUMP
;

95  (
pc
+1)+
off£t
;

96 
	}
}

103 
	$fixjump
 (
FuncS‹
 *
fs
, 
pc
, 
de¡
) {

104 
In¡ruùiÚ
 *
jmp
 = &
fs
->
f
->
code
[
pc
];

105 
off£t
 = 
de¡
 - (
pc
 + 1);

106 
	`lua_as£¹
(
de¡
 !ğ
NO_JUMP
);

107 ià(
	`abs
(
off£t
è> 
MAXARG_sBx
)

108 
	`luaX_syÁax”rÜ
(
fs
->
ls
, "control structureoo†ong");

109 
	`SETARG_sBx
(*
jmp
, 
off£t
);

110 
	}
}

116 
	$luaK_cÚÿt
 (
FuncS‹
 *
fs
, *
l1
, 
l2
) {

117 ià(
l2
 =ğ
NO_JUMP
) ;

118 ià(*
l1
 =ğ
NO_JUMP
)

119 *
l1
 = 
l2
;

121 
li¡
 = *
l1
;

122 
Ãxt
;

123 (
Ãxt
 = 
	`g‘jump
(
fs
, 
li¡
)è!ğ
NO_JUMP
)

124 
li¡
 = 
Ãxt
;

125 
	`fixjump
(
fs
, 
li¡
, 
l2
);

127 
	}
}

136 
	$luaK_jump
 (
FuncS‹
 *
fs
) {

137 
jpc
 = 
fs
->jpc;

138 
j
;

139 
fs
->
jpc
 = 
NO_JUMP
;

140 
j
 = 
	`luaK_codeAsBx
(
fs
, 
OP_JMP
, 0, 
NO_JUMP
);

141 
	`luaK_cÚÿt
(
fs
, &
j
, 
jpc
);

142  
j
;

143 
	}
}

149 
	$luaK_»t
 (
FuncS‹
 *
fs
, 
fœ¡
, 
Ä‘
) {

150 
	`luaK_codeABC
(
fs
, 
OP_RETURN
, 
fœ¡
, 
Ä‘
+1, 0);

151 
	}
}

158 
	$cÚdjump
 (
FuncS‹
 *
fs
, 
OpCode
 
İ
, 
A
, 
B
, 
C
) {

159 
	`luaK_codeABC
(
fs
, 
İ
, 
A
, 
B
, 
C
);

160  
	`luaK_jump
(
fs
);

161 
	}
}

168 
	$luaK_g‘Ïb–
 (
FuncS‹
 *
fs
) {

169 
fs
->
Ï¡rg‘
 = fs->
pc
;

170  
fs
->
pc
;

171 
	}
}

179 
In¡ruùiÚ
 *
	$g‘jumpcÚŒŞ
 (
FuncS‹
 *
fs
, 
pc
) {

180 
In¡ruùiÚ
 *
pi
 = &
fs
->
f
->
code
[
pc
];

181 ià(
pc
 >ğ1 && 
	`‹¡TMode
(
	`GET_OPCODE
(*(
pi
-1))))

182  
pi
-1;

184  
pi
;

185 
	}
}

195 
	$·tch‹¡»g
 (
FuncS‹
 *
fs
, 
node
, 
»g
) {

196 
In¡ruùiÚ
 *
i
 = 
	`g‘jumpcÚŒŞ
(
fs
, 
node
);

197 ià(
	`GET_OPCODE
(*
i
è!ğ
OP_TESTSET
)

199 ià(
»g
 !ğ
NO_REG
 &&„eg !ğ
	`GETARG_B
(*
i
))

200 
	`SETARG_A
(*
i
, 
»g
);

204 *
i
 = 
	`CREATE_ABC
(
OP_TEST
, 
	`GETARG_B
(*i), 0, 
	`GETARG_C
(*i));

207 
	}
}

213 
	$»movev®ues
 (
FuncS‹
 *
fs
, 
li¡
) {

214 ; 
li¡
 !ğ
NO_JUMP
;†i¡ = 
	`g‘jump
(
fs
,†ist))

215 
	`·tch‹¡»g
(
fs
, 
li¡
, 
NO_REG
);

216 
	}
}

224 
	$·tchli¡aux
 (
FuncS‹
 *
fs
, 
li¡
, 
vrg‘
, 
»g
,

225 
drg‘
) {

226 
li¡
 !ğ
NO_JUMP
) {

227 
Ãxt
 = 
	`g‘jump
(
fs
, 
li¡
);

228 ià(
	`·tch‹¡»g
(
fs
, 
li¡
, 
»g
))

229 
	`fixjump
(
fs
, 
li¡
, 
vrg‘
);

231 
	`fixjump
(
fs
, 
li¡
, 
drg‘
);

232 
li¡
 = 
Ãxt
;

234 
	}
}

242 
	$disch¬gejpc
 (
FuncS‹
 *
fs
) {

243 
	`·tchli¡aux
(
fs
, fs->
jpc
, fs->
pc
, 
NO_REG
, fs->pc);

244 
fs
->
jpc
 = 
NO_JUMP
;

245 
	}
}

252 
	$luaK_·tchtoh”e
 (
FuncS‹
 *
fs
, 
li¡
) {

253 
	`luaK_g‘Ïb–
(
fs
);

254 
	`luaK_cÚÿt
(
fs
, &fs->
jpc
, 
li¡
);

255 
	}
}

263 
	$luaK_·tchli¡
 (
FuncS‹
 *
fs
, 
li¡
, 
rg‘
) {

264 ià(
rg‘
 =ğ
fs
->
pc
)

265 
	`luaK_·tchtoh”e
(
fs
, 
li¡
);

267 
	`lua_as£¹
(
rg‘
 < 
fs
->
pc
);

268 
	`·tchli¡aux
(
fs
, 
li¡
, 
rg‘
, 
NO_REG
,arget);

270 
	}
}

278 
	$luaK_·tchşo£
 (
FuncS‹
 *
fs
, 
li¡
, 
Ëv–
) {

279 
Ëv–
++;

280 ; 
li¡
 !ğ
NO_JUMP
;†i¡ = 
	`g‘jump
(
fs
,†ist)) {

281 
	`lua_as£¹
(
	`GET_OPCODE
(
fs
->
f
->
code
[
li¡
]è=ğ
OP_JMP
 &&

282 (
	`GETARG_A
(
fs
->
f
->
code
[
li¡
]) == 0 ||

283 
	`GETARG_A
(
fs
->
f
->
code
[
li¡
]è>ğ
Ëv–
));

284 
	`SETARG_A
(
fs
->
f
->
code
[
li¡
], 
Ëv–
);

286 
	}
}

293 
	$luaK_code
 (
FuncS‹
 *
fs
, 
In¡ruùiÚ
 
i
) {

294 
PrÙo
 *
f
 = 
fs
->f;

295 
	`disch¬gejpc
(
fs
);

297 
	`luaM_growveùÜ
(
fs
->
ls
->
L
, 
f
->
code
, fs->
pc
, f->
sizecode
, 
In¡ruùiÚ
,

298 
MAX_INT
, "opcodes");

299 
f
->
code
[
fs
->
pc
] = 
i
;

301 
	`luaM_growveùÜ
(
fs
->
ls
->
L
, 
f
->
lšešfo
, fs->
pc
, f->
siz–šešfo
, ,

302 
MAX_INT
, "opcodes");

303 
f
->
lšešfo
[
fs
->
pc
] = fs->
ls
->
Ï¡lše
;

304  
fs
->
pc
++;

305 
	}
}

312 
	$luaK_codeABC
 (
FuncS‹
 *
fs
, 
OpCode
 
o
, 
a
, 
b
, 
c
) {

313 
	`lua_as£¹
(
	`g‘OpMode
(
o
è=ğ
iABC
);

314 
	`lua_as£¹
(
	`g‘BMode
(
o
è!ğ
OpArgN
 || 
b
 == 0);

315 
	`lua_as£¹
(
	`g‘CMode
(
o
è!ğ
OpArgN
 || 
c
 == 0);

316 
	`lua_as£¹
(
a
 <ğ
MAXARG_A
 && 
b
 <ğ
MAXARG_B
 && 
c
 <ğ
MAXARG_C
);

317  
	`luaK_code
(
fs
, 
	`CREATE_ABC
(
o
, 
a
, 
b
, 
c
));

318 
	}
}

324 
	$luaK_codeABx
 (
FuncS‹
 *
fs
, 
OpCode
 
o
, 
a
, 
bc
) {

325 
	`lua_as£¹
(
	`g‘OpMode
(
o
è=ğ
iABx
 || g‘OpMode(oè=ğ
iAsBx
);

326 
	`lua_as£¹
(
	`g‘CMode
(
o
è=ğ
OpArgN
);

327 
	`lua_as£¹
(
a
 <ğ
MAXARG_A
 && 
bc
 <ğ
MAXARG_Bx
);

328  
	`luaK_code
(
fs
, 
	`CREATE_ABx
(
o
, 
a
, 
bc
));

329 
	}
}

335 
	$cod“xŒ¯rg
 (
FuncS‹
 *
fs
, 
a
) {

336 
	`lua_as£¹
(
a
 <ğ
MAXARG_Ax
);

337  
	`luaK_code
(
fs
, 
	`CREATE_Ax
(
OP_EXTRAARG
, 
a
));

338 
	}
}

346 
	$luaK_codek
 (
FuncS‹
 *
fs
, 
»g
, 
k
) {

347 ià(
k
 <ğ
MAXARG_Bx
)

348  
	`luaK_codeABx
(
fs
, 
OP_LOADK
, 
»g
, 
k
);

350 
p
 = 
	`luaK_codeABx
(
fs
, 
OP_LOADKX
, 
»g
, 0);

351 
	`cod“xŒ¯rg
(
fs
, 
k
);

352  
p
;

354 
	}
}

361 
	$luaK_check¡ack
 (
FuncS‹
 *
fs
, 
n
) {

362 
Ãw¡ack
 = 
fs
->
ä“»g
 + 
n
;

363 ià(
Ãw¡ack
 > 
fs
->
f
->
max¡acksize
) {

364 ià(
Ãw¡ack
 >ğ
MAXREGS
)

365 
	`luaX_syÁax”rÜ
(
fs
->
ls
,

367 
fs
->
f
->
max¡acksize
 = 
	`ÿ¡_by‹
(
Ãw¡ack
);

369 
	}
}

375 
	$luaK_»£rv”egs
 (
FuncS‹
 *
fs
, 
n
) {

376 
	`luaK_check¡ack
(
fs
, 
n
);

377 
fs
->
ä“»g
 +ğ
n
;

378 
	}
}

386 
	$ä“»g
 (
FuncS‹
 *
fs
, 
»g
) {

387 ià(!
	`ISK
(
»g
è&&„eg >ğ
fs
->
Çùv¬
) {

388 
fs
->
ä“»g
--;

389 
	`lua_as£¹
(
»g
 =ğ
fs
->
ä“»g
);

391 
	}
}

397 
	$ä“exp
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

398 ià(
e
->
k
 =ğ
VNONRELOC
)

399 
	`ä“»g
(
fs
, 
e
->
u
.
šfo
);

400 
	}
}

407 
	$ä“exps
 (
FuncS‹
 *
fs
, 
expdesc
 *
e1
,ƒxpdesø*
e2
) {

408 
r1
 = (
e1
->
k
 =ğ
VNONRELOC
è?ƒ1->
u
.
šfo
 : -1;

409 
r2
 = (
e2
->
k
 =ğ
VNONRELOC
è?ƒ2->
u
.
šfo
 : -1;

410 ià(
r1
 > 
r2
) {

411 
	`ä“»g
(
fs
, 
r1
);

412 
	`ä“»g
(
fs
, 
r2
);

415 
	`ä“»g
(
fs
, 
r2
);

416 
	`ä“»g
(
fs
, 
r1
);

418 
	}
}

428 
	$addk
 (
FuncS‹
 *
fs
, 
TV®ue
 *
key
, TV®u*
v
) {

429 
lua_S‹
 *
L
 = 
fs
->
ls
->L;

430 
PrÙo
 *
f
 = 
fs
->f;

431 
TV®ue
 *
idx
 = 
	`luaH_£t
(
L
, 
fs
->
ls
->
h
, 
key
);

432 
k
, 
Şdsize
;

433 ià(
	`‰isš‹g”
(
idx
)) {

434 
k
 = 
	`ÿ¡_št
(
	`iv®ue
(
idx
));

436 ià(
k
 < 
fs
->
nk
 && 
	`‰y³
(&
f
->k[k]è=ğ‰y³(
v
) &&

437 
	`luaV_¿wequ®obj
(&
f
->
k
[k], 
v
))

438  
k
;

441 
Şdsize
 = 
f
->
sizek
;

442 
k
 = 
fs
->
nk
;

445 
	`£tiv®ue
(
idx
, 
k
);

446 
	`luaM_growveùÜ
(
L
, 
f
->
k
, k, f->
sizek
, 
TV®ue
, 
MAXARG_Ax
, "constants");

447 
Şdsize
 < 
f
->
sizek
è
	`£Šv®ue
(&f->
k
[oldsize++]);

448 
	`£tobj
(
L
, &
f
->
k
[k], 
v
);

449 
fs
->
nk
++;

450 
	`luaC_b¬r›r
(
L
, 
f
, 
v
);

451  
k
;

452 
	}
}

458 
	$luaK_¡ršgK
 (
FuncS‹
 *
fs
, 
TSŒšg
 *
s
) {

459 
TV®ue
 
o
;

460 
	`£tsv®ue
(
fs
->
ls
->
L
, &
o
, 
s
);

461  
	`addk
(
fs
, &
o
, &o);

462 
	}
}

471 
	$luaK_štK
 (
FuncS‹
 *
fs
, 
lua_IÁeg”
 
n
) {

472 
TV®ue
 
k
, 
o
;

473 
	`£v®ue
(&
k
, 
	`ÿ¡
(*, ca¡(
size_t
, 
n
)));

474 
	`£tiv®ue
(&
o
, 
n
);

475  
	`addk
(
fs
, &
k
, &
o
);

476 
	}
}

481 
	$luaK_numb”K
 (
FuncS‹
 *
fs
, 
lua_Numb”
 
r
) {

482 
TV®ue
 
o
;

483 
	`£tætv®ue
(&
o
, 
r
);

484  
	`addk
(
fs
, &
o
, &o);

485 
	}
}

491 
	$boŞK
 (
FuncS‹
 *
fs
, 
b
) {

492 
TV®ue
 
o
;

493 
	`£tbv®ue
(&
o
, 
b
);

494  
	`addk
(
fs
, &
o
, &o);

495 
	}
}

501 
	$nK
 (
FuncS‹
 *
fs
) {

502 
TV®ue
 
k
, 
v
;

503 
	`£Šv®ue
(&
v
);

505 
	`£thv®ue
(
fs
->
ls
->
L
, &
k
, fs->ls->
h
);

506  
	`addk
(
fs
, &
k
, &
v
);

507 
	}
}

515 
	$luaK_£Œ‘uºs
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
, 
ÄesuÉs
) {

516 ià(
e
->
k
 =ğ
VCALL
) {

517 
	`SETARG_C
(
	`g‘š¡ruùiÚ
(
fs
, 
e
), 
ÄesuÉs
 + 1);

519 ià(
e
->
k
 =ğ
VVARARG
) {

520 
In¡ruùiÚ
 *
pc
 = &
	`g‘š¡ruùiÚ
(
fs
, 
e
);

521 
	`SETARG_B
(*
pc
, 
ÄesuÉs
 + 1);

522 
	`SETARG_A
(*
pc
, 
fs
->
ä“»g
);

523 
	`luaK_»£rv”egs
(
fs
, 1);

525 
	`lua_as£¹
(
ÄesuÉs
 =ğ
LUA_MULTRET
);

526 
	}
}

539 
	$luaK_£tÚ”‘
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

540 ià(
e
->
k
 =ğ
VCALL
) {

542 
	`lua_as£¹
(
	`GETARG_C
(
	`g‘š¡ruùiÚ
(
fs
, 
e
)) == 2);

543 
e
->
k
 = 
VNONRELOC
;

544 
e
->
u
.
šfo
 = 
	`GETARG_A
(
	`g‘š¡ruùiÚ
(
fs
,ƒ));

546 ià(
e
->
k
 =ğ
VVARARG
) {

547 
	`SETARG_B
(
	`g‘š¡ruùiÚ
(
fs
, 
e
), 2);

548 
e
->
k
 = 
VRELOCABLE
;

550 
	}
}

556 
	$luaK_disch¬gev¬s
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

557 
e
->
k
) {

558 
VLOCAL
: {

559 
e
->
k
 = 
VNONRELOC
;

562 
VUPVAL
: {

563 
e
->
u
.
šfo
 = 
	`luaK_codeABC
(
fs
, 
OP_GETUPVAL
, 0,ƒ->u.info, 0);

564 
e
->
k
 = 
VRELOCABLE
;

567 
VINDEXED
: {

568 
OpCode
 
İ
;

569 
	`ä“»g
(
fs
, 
e
->
u
.
šd
.
idx
);

570 ià(
e
->
u
.
šd
.
vt
 =ğ
VLOCAL
) {

571 
	`ä“»g
(
fs
, 
e
->
u
.
šd
.
t
);

572 
İ
 = 
OP_GETTABLE
;

575 
	`lua_as£¹
(
e
->
u
.
šd
.
vt
 =ğ
VUPVAL
);

576 
İ
 = 
OP_GETTABUP
;

578 
e
->
u
.
šfo
 = 
	`luaK_codeABC
(
fs
, 
İ
, 0,ƒ->u.
šd
.
t
,ƒ->u.šd.
idx
);

579 
e
->
k
 = 
VRELOCABLE
;

582 
VVARARG
: 
VCALL
: {

583 
	`luaK_£tÚ”‘
(
fs
, 
e
);

588 
	}
}

595 
	$disch¬ge2»g
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
, 
»g
) {

596 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

597 
e
->
k
) {

598 
VNIL
: {

599 
	`luaK_n
(
fs
, 
»g
, 1);

602 
VFALSE
: 
VTRUE
: {

603 
	`luaK_codeABC
(
fs
, 
OP_LOADBOOL
, 
»g
, 
e
->
k
 =ğ
VTRUE
, 0);

606 
VK
: {

607 
	`luaK_codek
(
fs
, 
»g
, 
e
->
u
.
šfo
);

610 
VKFLT
: {

611 
	`luaK_codek
(
fs
, 
»g
, 
	`luaK_numb”K
(fs, 
e
->
u
.
nv®
));

614 
VKINT
: {

615 
	`luaK_codek
(
fs
, 
»g
, 
	`luaK_štK
(fs, 
e
->
u
.
iv®
));

618 
VRELOCABLE
: {

619 
In¡ruùiÚ
 *
pc
 = &
	`g‘š¡ruùiÚ
(
fs
, 
e
);

620 
	`SETARG_A
(*
pc
, 
»g
);

623 
VNONRELOC
: {

624 ià(
»g
 !ğ
e
->
u
.
šfo
)

625 
	`luaK_codeABC
(
fs
, 
OP_MOVE
, 
»g
, 
e
->
u
.
šfo
, 0);

629 
	`lua_as£¹
(
e
->
k
 =ğ
VJMP
);

633 
e
->
u
.
šfo
 = 
»g
;

634 
e
->
k
 = 
VNONRELOC
;

635 
	}
}

641 
	$disch¬ge2ªy»g
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

642 ià(
e
->
k
 !ğ
VNONRELOC
) {

643 
	`luaK_»£rv”egs
(
fs
, 1);

644 
	`disch¬ge2»g
(
fs
, 
e
, fs->
ä“»g
-1);

646 
	}
}

649 
	$code_lßdboŞ
 (
FuncS‹
 *
fs
, 
A
, 
b
, 
jump
) {

650 
	`luaK_g‘Ïb–
(
fs
);

651  
	`luaK_codeABC
(
fs
, 
OP_LOADBOOL
, 
A
, 
b
, 
jump
);

652 
	}
}

659 
	$Ãed_v®ue
 (
FuncS‹
 *
fs
, 
li¡
) {

660 ; 
li¡
 !ğ
NO_JUMP
;†i¡ = 
	`g‘jump
(
fs
,†ist)) {

661 
In¡ruùiÚ
 
i
 = *
	`g‘jumpcÚŒŞ
(
fs
, 
li¡
);

662 ià(
	`GET_OPCODE
(
i
è!ğ
OP_TESTSET
)  1;

665 
	}
}

675 
	$exp2»g
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
, 
»g
) {

676 
	`disch¬ge2»g
(
fs
, 
e
, 
»g
);

677 ià(
e
->
k
 =ğ
VJMP
)

678 
	`luaK_cÚÿt
(
fs
, &
e
->
t
,ƒ->
u
.
šfo
);

679 ià(
	`hasjumps
(
e
)) {

680 
fš®
;

681 
p_f
 = 
NO_JUMP
;

682 
p_t
 = 
NO_JUMP
;

683 ià(
	`Ãed_v®ue
(
fs
, 
e
->
t
è||‚“d_v®ue(fs,ƒ->
f
)) {

684 
fj
 = (
e
->
k
 =ğ
VJMP
è? 
NO_JUMP
 : 
	`luaK_jump
(
fs
);

685 
p_f
 = 
	`code_lßdboŞ
(
fs
, 
»g
, 0, 1);

686 
p_t
 = 
	`code_lßdboŞ
(
fs
, 
»g
, 1, 0);

687 
	`luaK_·tchtoh”e
(
fs
, 
fj
);

689 
fš®
 = 
	`luaK_g‘Ïb–
(
fs
);

690 
	`·tchli¡aux
(
fs
, 
e
->
f
, 
fš®
, 
»g
, 
p_f
);

691 
	`·tchli¡aux
(
fs
, 
e
->
t
, 
fš®
, 
»g
, 
p_t
);

693 
e
->
f
 =ƒ->
t
 = 
NO_JUMP
;

694 
e
->
u
.
šfo
 = 
»g
;

695 
e
->
k
 = 
VNONRELOC
;

696 
	}
}

703 
	$luaK_exp2ÃxŒeg
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

704 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

705 
	`ä“exp
(
fs
, 
e
);

706 
	`luaK_»£rv”egs
(
fs
, 1);

707 
	`exp2»g
(
fs
, 
e
, fs->
ä“»g
 - 1);

708 
	}
}

715 
	$luaK_exp2ªy»g
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

716 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

717 ià(
e
->
k
 =ğ
VNONRELOC
) {

718 ià(!
	`hasjumps
(
e
))

719  
e
->
u
.
šfo
;

720 ià(
e
->
u
.
šfo
 >ğ
fs
->
Çùv¬
) {

721 
	`exp2»g
(
fs
, 
e
,ƒ->
u
.
šfo
);

722  
e
->
u
.
šfo
;

725 
	`luaK_exp2ÃxŒeg
(
fs
, 
e
);

726  
e
->
u
.
šfo
;

727 
	}
}

734 
	$luaK_exp2ªy»gup
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

735 ià(
e
->
k
 !ğ
VUPVAL
 || 
	`hasjumps
(e))

736 
	`luaK_exp2ªy»g
(
fs
, 
e
);

737 
	}
}

744 
	$luaK_exp2v®
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

745 ià(
	`hasjumps
(
e
))

746 
	`luaK_exp2ªy»g
(
fs
, 
e
);

748 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

749 
	}
}

758 
	$luaK_exp2RK
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

759 
	`luaK_exp2v®
(
fs
, 
e
);

760 
e
->
k
) {

761 
VTRUE
: 
e
->
u
.
šfo
 = 
	`boŞK
(
fs
, 1); 
vk
;

762 
VFALSE
: 
e
->
u
.
šfo
 = 
	`boŞK
(
fs
, 0); 
vk
;

763 
VNIL
: 
e
->
u
.
šfo
 = 
	`nK
(
fs
); 
vk
;

764 
VKINT
: 
e
->
u
.
šfo
 = 
	`luaK_štK
(
fs
,ƒ->u.
iv®
); 
vk
;

765 
VKFLT
: 
e
->
u
.
šfo
 = 
	`luaK_numb”K
(
fs
,ƒ->u.
nv®
); 
vk
;

766 
VK
:

767 
vk
:

768 
e
->
k
 = 
VK
;

769 ià(
e
->
u
.
šfo
 <ğ
MAXINDEXRK
)

770  
	`RKASK
(
e
->
u
.
šfo
);

775  
	`luaK_exp2ªy»g
(
fs
, 
e
);

776 
	}
}

782 
	$luaK_¡Üev¬
 (
FuncS‹
 *
fs
, 
expdesc
 *
v¬
,ƒxpdesø*
ex
) {

783 
v¬
->
k
) {

784 
VLOCAL
: {

785 
	`ä“exp
(
fs
, 
ex
);

786 
	`exp2»g
(
fs
, 
ex
, 
v¬
->
u
.
šfo
);

789 
VUPVAL
: {

790 
e
 = 
	`luaK_exp2ªy»g
(
fs
, 
ex
);

791 
	`luaK_codeABC
(
fs
, 
OP_SETUPVAL
, 
e
, 
v¬
->
u
.
šfo
, 0);

794 
VINDEXED
: {

795 
OpCode
 
İ
 = (
v¬
->
u
.
šd
.
vt
 =ğ
VLOCAL
è? 
OP_SETTABLE
 : 
OP_SETTABUP
;

796 
e
 = 
	`luaK_exp2RK
(
fs
, 
ex
);

797 
	`luaK_codeABC
(
fs
, 
İ
, 
v¬
->
u
.
šd
.
t
, v¬->u.šd.
idx
, 
e
);

800 : 
	`lua_as£¹
(0);

802 
	`ä“exp
(
fs
, 
ex
);

803 
	}
}

809 
	$luaK_£lf
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
,ƒxpdesø*
key
) {

810 
”eg
;

811 
	`luaK_exp2ªy»g
(
fs
, 
e
);

812 
”eg
 = 
e
->
u
.
šfo
;

813 
	`ä“exp
(
fs
, 
e
);

814 
e
->
u
.
šfo
 = 
fs
->
ä“»g
;

815 
e
->
k
 = 
VNONRELOC
;

816 
	`luaK_»£rv”egs
(
fs
, 2);

817 
	`luaK_codeABC
(
fs
, 
OP_SELF
, 
e
->
u
.
šfo
, 
”eg
, 
	`luaK_exp2RK
(fs, 
key
));

818 
	`ä“exp
(
fs
, 
key
);

819 
	}
}

825 
	$Ãg©ecÚd™iÚ
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

826 
In¡ruùiÚ
 *
pc
 = 
	`g‘jumpcÚŒŞ
(
fs
, 
e
->
u
.
šfo
);

827 
	`lua_as£¹
(
	`‹¡TMode
(
	`GET_OPCODE
(*
pc
)è&& GET_OPCODE(*pcè!ğ
OP_TESTSET
 &&

828 
	`GET_OPCODE
(*
pc
è!ğ
OP_TEST
);

829 
	`SETARG_A
(*
pc
, !(
	`GETARG_A
(*pc)));

830 
	}
}

839 
	$jumpÚcÚd
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
, 
cÚd
) {

840 ià(
e
->
k
 =ğ
VRELOCABLE
) {

841 
In¡ruùiÚ
 
›
 = 
	`g‘š¡ruùiÚ
(
fs
, 
e
);

842 ià(
	`GET_OPCODE
(
›
è=ğ
OP_NOT
) {

843 
fs
->
pc
--;

844  
	`cÚdjump
(
fs
, 
OP_TEST
, 
	`GETARG_B
(
›
), 0, !
cÚd
);

848 
	`disch¬ge2ªy»g
(
fs
, 
e
);

849 
	`ä“exp
(
fs
, 
e
);

850  
	`cÚdjump
(
fs
, 
OP_TESTSET
, 
NO_REG
, 
e
->
u
.
šfo
, 
cÚd
);

851 
	}
}

857 
	$luaK_goiárue
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

858 
pc
;

859 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

860 
e
->
k
) {

861 
VJMP
: {

862 
	`Ãg©ecÚd™iÚ
(
fs
, 
e
);

863 
pc
 = 
e
->
u
.
šfo
;

866 
VK
: 
VKFLT
: 
VKINT
: 
VTRUE
: {

867 
pc
 = 
NO_JUMP
;

871 
pc
 = 
	`jumpÚcÚd
(
fs
, 
e
, 0);

875 
	`luaK_cÚÿt
(
fs
, &
e
->
f
, 
pc
);

876 
	`luaK_·tchtoh”e
(
fs
, 
e
->
t
);

877 
e
->
t
 = 
NO_JUMP
;

878 
	}
}

884 
	$luaK_goifçl£
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

885 
pc
;

886 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

887 
e
->
k
) {

888 
VJMP
: {

889 
pc
 = 
e
->
u
.
šfo
;

892 
VNIL
: 
VFALSE
: {

893 
pc
 = 
NO_JUMP
;

897 
pc
 = 
	`jumpÚcÚd
(
fs
, 
e
, 1);

901 
	`luaK_cÚÿt
(
fs
, &
e
->
t
, 
pc
);

902 
	`luaK_·tchtoh”e
(
fs
, 
e
->
f
);

903 
e
->
f
 = 
NO_JUMP
;

904 
	}
}

910 
	$cod’Ù
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

911 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

912 
e
->
k
) {

913 
VNIL
: 
VFALSE
: {

914 
e
->
k
 = 
VTRUE
;

917 
VK
: 
VKFLT
: 
VKINT
: 
VTRUE
: {

918 
e
->
k
 = 
VFALSE
;

921 
VJMP
: {

922 
	`Ãg©ecÚd™iÚ
(
fs
, 
e
);

925 
VRELOCABLE
:

926 
VNONRELOC
: {

927 
	`disch¬ge2ªy»g
(
fs
, 
e
);

928 
	`ä“exp
(
fs
, 
e
);

929 
e
->
u
.
šfo
 = 
	`luaK_codeABC
(
fs
, 
OP_NOT
, 0,ƒ->u.info, 0);

930 
e
->
k
 = 
VRELOCABLE
;

933 : 
	`lua_as£¹
(0);

936 { 
‹mp
 = 
e
->
f
;ƒ->àğe->
t
;ƒ->t =emp; }

937 
	`»movev®ues
(
fs
, 
e
->
f
);

938 
	`»movev®ues
(
fs
, 
e
->
t
);

939 
	}
}

946 
	$luaK_šdexed
 (
FuncS‹
 *
fs
, 
expdesc
 *
t
,ƒxpdesø*
k
) {

947 
	`lua_as£¹
(!
	`hasjumps
(
t
è&& (
	`vkisš»g
Ñ->
k
è||->k =ğ
VUPVAL
));

948 
t
->
u
.
šd
.ˆğt->u.
šfo
;

949 
t
->
u
.
šd
.
idx
 = 
	`luaK_exp2RK
(
fs
, 
k
);

950 
t
->
u
.
šd
.
vt
 = (t->
k
 =ğ
VUPVAL
è? VUPVAL : 
VLOCAL
;

951 
t
->
k
 = 
VINDEXED
;

952 
	}
}

960 
	$v®idİ
 (
İ
, 
TV®ue
 *
v1
, TV®u*
v2
) {

961 
İ
) {

962 
LUA_OPBAND
: 
LUA_OPBOR
: 
LUA_OPBXOR
:

963 
LUA_OPSHL
: 
LUA_OPSHR
: 
LUA_OPBNOT
: {

964 
lua_IÁeg”
 
i
;

965  (
	`toš‹g”
(
v1
, &
i
è&&oš‹g”(
v2
, &i));

967 
LUA_OPDIV
: 
LUA_OPIDIV
: 
LUA_OPMOD
:

968  (
	`nv®ue
(
v2
) != 0);

971 
	}
}

978 
	$cÚ¡fŞdšg
 (
FuncS‹
 *
fs
, 
İ
, 
expdesc
 *
e1
,

979 cÚ¡ 
expdesc
 *
e2
) {

980 
TV®ue
 
v1
, 
v2
, 
»s
;

981 ià(!
	`tÚum”®
(
e1
, &
v1
è|| !tÚum”®(
e2
, &
v2
è|| !
	`v®idİ
(
İ
, &v1, &v2))

983 
	`luaO_¬™h
(
fs
->
ls
->
L
, 
İ
, &
v1
, &
v2
, &
»s
);

984 ià(
	`‰isš‹g”
(&
»s
)) {

985 
e1
->
k
 = 
VKINT
;

986 
e1
->
u
.
iv®
 = 
	`iv®ue
(&
»s
);

989 
lua_Numb”
 
n
 = 
	`ætv®ue
(&
»s
);

990 ià(
	`luai_numi¢ª
(
n
) ||‚ == 0)

992 
e1
->
k
 = 
VKFLT
;

993 
e1
->
u
.
nv®
 = 
n
;

996 
	}
}

1004 
	$codeuÃxpv®
 (
FuncS‹
 *
fs
, 
OpCode
 
İ
, 
expdesc
 *
e
, 
lše
) {

1005 
r
 = 
	`luaK_exp2ªy»g
(
fs
, 
e
);

1006 
	`ä“exp
(
fs
, 
e
);

1007 
e
->
u
.
šfo
 = 
	`luaK_codeABC
(
fs
, 
İ
, 0, 
r
, 0);

1008 
e
->
k
 = 
VRELOCABLE
;

1009 
	`luaK_fixlše
(
fs
, 
lše
);

1010 
	}
}

1022 
	$codebšexpv®
 (
FuncS‹
 *
fs
, 
OpCode
 
İ
,

1023 
expdesc
 *
e1
,ƒxpdesø*
e2
, 
lše
) {

1024 
rk2
 = 
	`luaK_exp2RK
(
fs
, 
e2
);

1025 
rk1
 = 
	`luaK_exp2RK
(
fs
, 
e1
);

1026 
	`ä“exps
(
fs
, 
e1
, 
e2
);

1027 
e1
->
u
.
šfo
 = 
	`luaK_codeABC
(
fs
, 
İ
, 0, 
rk1
, 
rk2
);

1028 
e1
->
k
 = 
VRELOCABLE
;

1029 
	`luaK_fixlše
(
fs
, 
lše
);

1030 
	}
}

1037 
	$codecomp
 (
FuncS‹
 *
fs
, 
BšO´
 
İr
, 
expdesc
 *
e1
,ƒxpdesø*
e2
) {

1038 
rk1
 = (
e1
->
k
 =ğ
VK
è? 
	`RKASK
Ó1->
u
.
šfo
)

1039 : 
	`check_exp
(
e1
->
k
 =ğ
VNONRELOC
,ƒ1->
u
.
šfo
);

1040 
rk2
 = 
	`luaK_exp2RK
(
fs
, 
e2
);

1041 
	`ä“exps
(
fs
, 
e1
, 
e2
);

1042 
İr
) {

1043 
OPR_NE
: {

1044 
e1
->
u
.
šfo
 = 
	`cÚdjump
(
fs
, 
OP_EQ
, 0, 
rk1
, 
rk2
);

1047 
OPR_GT
: 
OPR_GE
: {

1049 
OpCode
 
İ
 = 
	`ÿ¡
(OpCode, (
İr
 - 
OPR_NE
è+ 
OP_EQ
);

1050 
e1
->
u
.
šfo
 = 
	`cÚdjump
(
fs
, 
İ
, 1, 
rk2
, 
rk1
);

1054 
OpCode
 
İ
 = 
	`ÿ¡
(OpCode, (
İr
 - 
OPR_EQ
è+ 
OP_EQ
);

1055 
e1
->
u
.
šfo
 = 
	`cÚdjump
(
fs
, 
İ
, 1, 
rk1
, 
rk2
);

1059 
e1
->
k
 = 
VJMP
;

1060 
	}
}

1066 
	$luaK_´efix
 (
FuncS‹
 *
fs
, 
UnO´
 
İ
, 
expdesc
 *
e
, 
lše
) {

1067 cÚ¡ 
expdesc
 
ef
 = {
VKINT
, {0}, 
NO_JUMP
, NO_JUMP};

1068 
İ
) {

1069 
OPR_MINUS
: 
OPR_BNOT
:

1070 ià(
	`cÚ¡fŞdšg
(
fs
, 
İ
 + 
LUA_OPUNM
, 
e
, &
ef
))

1073 
OPR_LEN
:

1074 
	`codeuÃxpv®
(
fs
, 
	`ÿ¡
(
OpCode
, 
İ
 + 
OP_UNM
), 
e
, 
lše
);

1076 
OPR_NOT
: 
	`cod’Ù
(
fs
, 
e
); ;

1077 : 
	`lua_as£¹
(0);

1079 
	}
}

1086 
	$luaK_šfix
 (
FuncS‹
 *
fs
, 
BšO´
 
İ
, 
expdesc
 *
v
) {

1087 
İ
) {

1088 
OPR_AND
: {

1089 
	`luaK_goiárue
(
fs
, 
v
);

1092 
OPR_OR
: {

1093 
	`luaK_goifçl£
(
fs
, 
v
);

1096 
OPR_CONCAT
: {

1097 
	`luaK_exp2ÃxŒeg
(
fs
, 
v
);

1100 
OPR_ADD
: 
OPR_SUB
:

1101 
OPR_MUL
: 
OPR_DIV
: 
OPR_IDIV
:

1102 
OPR_MOD
: 
OPR_POW
:

1103 
OPR_BAND
: 
OPR_BOR
: 
OPR_BXOR
:

1104 
OPR_SHL
: 
OPR_SHR
: {

1105 ià(!
	`tÚum”®
(
v
, 
NULL
))

1106 
	`luaK_exp2RK
(
fs
, 
v
);

1111 
	`luaK_exp2RK
(
fs
, 
v
);

1115 
	}
}

1124 
	$luaK_posfix
 (
FuncS‹
 *
fs
, 
BšO´
 
İ
,

1125 
expdesc
 *
e1
,ƒxpdesø*
e2
, 
lše
) {

1126 
İ
) {

1127 
OPR_AND
: {

1128 
	`lua_as£¹
(
e1
->
t
 =ğ
NO_JUMP
);

1129 
	`luaK_disch¬gev¬s
(
fs
, 
e2
);

1130 
	`luaK_cÚÿt
(
fs
, &
e2
->
f
, 
e1
->f);

1131 *
e1
 = *
e2
;

1134 
OPR_OR
: {

1135 
	`lua_as£¹
(
e1
->
f
 =ğ
NO_JUMP
);

1136 
	`luaK_disch¬gev¬s
(
fs
, 
e2
);

1137 
	`luaK_cÚÿt
(
fs
, &
e2
->
t
, 
e1
->t);

1138 *
e1
 = *
e2
;

1141 
OPR_CONCAT
: {

1142 
	`luaK_exp2v®
(
fs
, 
e2
);

1143 ià(
e2
->
k
 =ğ
VRELOCABLE
 &&

1144 
	`GET_OPCODE
(
	`g‘š¡ruùiÚ
(
fs
, 
e2
)è=ğ
OP_CONCAT
) {

1145 
	`lua_as£¹
(
e1
->
u
.
šfo
 =ğ
	`GETARG_B
(
	`g‘š¡ruùiÚ
(
fs
, 
e2
))-1);

1146 
	`ä“exp
(
fs
, 
e1
);

1147 
	`SETARG_B
(
	`g‘š¡ruùiÚ
(
fs
, 
e2
), 
e1
->
u
.
šfo
);

1148 
e1
->
k
 = 
VRELOCABLE
;ƒ1->
u
.
šfo
 = 
e2
->u.info;

1151 
	`luaK_exp2ÃxŒeg
(
fs
, 
e2
);

1152 
	`codebšexpv®
(
fs
, 
OP_CONCAT
, 
e1
, 
e2
, 
lše
);

1156 
OPR_ADD
: 
OPR_SUB
: 
OPR_MUL
: 
OPR_DIV
:

1157 
OPR_IDIV
: 
OPR_MOD
: 
OPR_POW
:

1158 
OPR_BAND
: 
OPR_BOR
: 
OPR_BXOR
:

1159 
OPR_SHL
: 
OPR_SHR
: {

1160 ià(!
	`cÚ¡fŞdšg
(
fs
, 
İ
 + 
LUA_OPADD
, 
e1
, 
e2
))

1161 
	`codebšexpv®
(
fs
, 
	`ÿ¡
(
OpCode
, 
İ
 + 
OP_ADD
), 
e1
, 
e2
, 
lše
);

1164 
OPR_EQ
: 
OPR_LT
: 
OPR_LE
:

1165 
OPR_NE
: 
OPR_GT
: 
OPR_GE
: {

1166 
	`codecomp
(
fs
, 
İ
, 
e1
, 
e2
);

1169 : 
	`lua_as£¹
(0);

1171 
	}
}

1177 
	$luaK_fixlše
 (
FuncS‹
 *
fs
, 
lše
) {

1178 
fs
->
f
->
lšešfo
[fs->
pc
 - 1] = 
lše
;

1179 
	}
}

1189 
	$luaK_£i¡
 (
FuncS‹
 *
fs
, 
ba£
, 
ÃËms
, 
to¡Üe
) {

1190 
c
 = (
ÃËms
 - 1)/
LFIELDS_PER_FLUSH
 + 1;

1191 
b
 = (
to¡Üe
 =ğ
LUA_MULTRET
) ? 0 :ostore;

1192 
	`lua_as£¹
(
to¡Üe
 !ğ0 &&o¡Ü<ğ
LFIELDS_PER_FLUSH
);

1193 ià(
c
 <ğ
MAXARG_C
)

1194 
	`luaK_codeABC
(
fs
, 
OP_SETLIST
, 
ba£
, 
b
, 
c
);

1195 ià(
c
 <ğ
MAXARG_Ax
) {

1196 
	`luaK_codeABC
(
fs
, 
OP_SETLIST
, 
ba£
, 
b
, 0);

1197 
	`cod“xŒ¯rg
(
fs
, 
c
);

1200 
	`luaX_syÁax”rÜ
(
fs
->
ls
, "constructoroo†ong");

1201 
fs
->
ä“»g
 = 
ba£
 + 1;

1202 
	}
}

	@script/lua/lua-5.3.4/src/lcode.h

7 #iâdeà
lcode_h


8 
	#lcode_h


	)

10 
	~"Îex.h
"

11 
	~"lobjeù.h
"

12 
	~"lİcodes.h
"

13 
	~"Í¬£r.h
"

20 
	#NO_JUMP
 (-1)

	)

26 
	eBšO´
 {

27 
	mOPR_ADD
, 
	mOPR_SUB
, 
	mOPR_MUL
, 
	mOPR_MOD
, 
	mOPR_POW
,

28 
	mOPR_DIV
,

29 
	mOPR_IDIV
,

30 
	mOPR_BAND
, 
	mOPR_BOR
, 
	mOPR_BXOR
,

31 
	mOPR_SHL
, 
	mOPR_SHR
,

32 
	mOPR_CONCAT
,

33 
	mOPR_EQ
, 
	mOPR_LT
, 
	mOPR_LE
,

34 
	mOPR_NE
, 
	mOPR_GT
, 
	mOPR_GE
,

35 
	mOPR_AND
, 
	mOPR_OR
,

36 
	mOPR_NOBINOPR


37 } 
	tBšO´
;

40 
	eUnO´
 { 
	mOPR_MINUS
, 
	mOPR_BNOT
, 
	mOPR_NOT
, 
	mOPR_LEN
, 
	mOPR_NOUNOPR
 } 
	tUnO´
;

44 
	#g‘š¡ruùiÚ
(
fs
,
e
è((fs)->
f
->
code
[Ó)->
u
.
šfo
])

	)

46 
	#luaK_codeAsBx
(
fs
,
o
,
A
,
sBx
è
	`luaK_codeABx
(fs,o,A,(sBx)+
MAXARG_sBx
)

	)

48 
	#luaK_£tmuÉ»t
(
fs
,
e
è
	`luaK_£Œ‘uºs
(fs,ƒ, 
LUA_MULTRET
)

	)

50 
	#luaK_jum±o
(
fs
,
t
è
	`luaK_·tchli¡
(fs, 
	`luaK_jump
(fs),)

	)

52 
LUAI_FUNC
 
luaK_codeABx
 (
FuncS‹
 *
fs
, 
OpCode
 
o
, 
A
, 
Bx
);

53 
LUAI_FUNC
 
luaK_codeABC
 (
FuncS‹
 *
fs
, 
OpCode
 
o
, 
A
, 
B
, 
C
);

54 
LUAI_FUNC
 
luaK_codek
 (
FuncS‹
 *
fs
, 
»g
, 
k
);

55 
LUAI_FUNC
 
luaK_fixlše
 (
FuncS‹
 *
fs
, 
lše
);

56 
LUAI_FUNC
 
luaK_n
 (
FuncS‹
 *
fs
, 
äom
, 
n
);

57 
LUAI_FUNC
 
luaK_»£rv”egs
 (
FuncS‹
 *
fs
, 
n
);

58 
LUAI_FUNC
 
luaK_check¡ack
 (
FuncS‹
 *
fs
, 
n
);

59 
LUAI_FUNC
 
luaK_¡ršgK
 (
FuncS‹
 *
fs
, 
TSŒšg
 *
s
);

60 
LUAI_FUNC
 
luaK_štK
 (
FuncS‹
 *
fs
, 
lua_IÁeg”
 
n
);

61 
LUAI_FUNC
 
luaK_disch¬gev¬s
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

62 
LUAI_FUNC
 
luaK_exp2ªy»g
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

63 
LUAI_FUNC
 
luaK_exp2ªy»gup
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

64 
LUAI_FUNC
 
luaK_exp2ÃxŒeg
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

65 
LUAI_FUNC
 
luaK_exp2v®
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

66 
LUAI_FUNC
 
luaK_exp2RK
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

67 
LUAI_FUNC
 
luaK_£lf
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
,ƒxpdesø*
key
);

68 
LUAI_FUNC
 
luaK_šdexed
 (
FuncS‹
 *
fs
, 
expdesc
 *
t
,ƒxpdesø*
k
);

69 
LUAI_FUNC
 
luaK_goiárue
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

70 
LUAI_FUNC
 
luaK_goifçl£
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

71 
LUAI_FUNC
 
luaK_¡Üev¬
 (
FuncS‹
 *
fs
, 
expdesc
 *
v¬
,ƒxpdesø*
e
);

72 
LUAI_FUNC
 
luaK_£Œ‘uºs
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
, 
ÄesuÉs
);

73 
LUAI_FUNC
 
luaK_£tÚ”‘
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

74 
LUAI_FUNC
 
luaK_jump
 (
FuncS‹
 *
fs
);

75 
LUAI_FUNC
 
luaK_»t
 (
FuncS‹
 *
fs
, 
fœ¡
, 
Ä‘
);

76 
LUAI_FUNC
 
luaK_·tchli¡
 (
FuncS‹
 *
fs
, 
li¡
, 
rg‘
);

77 
LUAI_FUNC
 
luaK_·tchtoh”e
 (
FuncS‹
 *
fs
, 
li¡
);

78 
LUAI_FUNC
 
luaK_·tchşo£
 (
FuncS‹
 *
fs
, 
li¡
, 
Ëv–
);

79 
LUAI_FUNC
 
luaK_cÚÿt
 (
FuncS‹
 *
fs
, *
l1
, 
l2
);

80 
LUAI_FUNC
 
luaK_g‘Ïb–
 (
FuncS‹
 *
fs
);

81 
LUAI_FUNC
 
luaK_´efix
 (
FuncS‹
 *
fs
, 
UnO´
 
İ
, 
expdesc
 *
v
, 
lše
);

82 
LUAI_FUNC
 
luaK_šfix
 (
FuncS‹
 *
fs
, 
BšO´
 
İ
, 
expdesc
 *
v
);

83 
LUAI_FUNC
 
luaK_posfix
 (
FuncS‹
 *
fs
, 
BšO´
 
İ
, 
expdesc
 *
v1
,

84 
expdesc
 *
v2
, 
lše
);

85 
LUAI_FUNC
 
luaK_£i¡
 (
FuncS‹
 *
fs
, 
ba£
, 
ÃËms
, 
to¡Üe
);

	@script/lua/lua-5.3.4/src/lcorolib.c

7 
	#lcÜŞib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<¡dlib.h
>

15 
	~"lua.h
"

17 
	~"Ïuxlib.h
"

18 
	~"lu®ib.h
"

21 
lua_S‹
 *
	$g‘co
 (
lua_S‹
 *
L
) {

22 
lua_S‹
 *
co
 = 
	`lua_tÙh»ad
(
L
, 1);

23 
	`luaL_¬gcheck
(
L
, 
co
, 1, "threadƒxpected");

24  
co
;

25 
	}
}

28 
	$aux»sume
 (
lua_S‹
 *
L
,†ua_S‹ *
co
, 
Çrg
) {

29 
¡©us
;

30 ià(!
	`lua_check¡ack
(
co
, 
Çrg
)) {

31 
	`lua_pushl™”®
(
L
, "too many‡rgumentso„esume");

34 ià(
	`lua_¡©us
(
co
è=ğ
LUA_OK
 && 
	`lua_g‘tİ
(co) == 0) {

35 
	`lua_pushl™”®
(
L
, "cannot„esume dead coroutine");

38 
	`lua_xmove
(
L
, 
co
, 
Çrg
);

39 
¡©us
 = 
	`lua_»sume
(
co
, 
L
, 
Çrg
);

40 ià(
¡©us
 =ğ
LUA_OK
 || stu =ğ
LUA_YIELD
) {

41 
Äes
 = 
	`lua_g‘tİ
(
co
);

42 ià(!
	`lua_check¡ack
(
L
, 
Äes
 + 1)) {

43 
	`lua_pİ
(
co
, 
Äes
);

44 
	`lua_pushl™”®
(
L
, "too many„esultso„esume");

47 
	`lua_xmove
(
co
, 
L
, 
Äes
);

48  
Äes
;

51 
	`lua_xmove
(
co
, 
L
, 1);

54 
	}
}

57 
	$luaB_cÜesume
 (
lua_S‹
 *
L
) {

58 
lua_S‹
 *
co
 = 
	`g‘co
(
L
);

59 
r
;

60 
r
 = 
	`aux»sume
(
L
, 
co
, 
	`lua_g‘tİ
(L) - 1);

61 ià(
r
 < 0) {

62 
	`lua_pushboŞ—n
(
L
, 0);

63 
	`lua_š£¹
(
L
, -2);

67 
	`lua_pushboŞ—n
(
L
, 1);

68 
	`lua_š£¹
(
L
, -(
r
 + 1));

69  
r
 + 1;

71 
	}
}

74 
	$luaB_auxw¿p
 (
lua_S‹
 *
L
) {

75 
lua_S‹
 *
co
 = 
	`lua_tÙh»ad
(
L
, 
	`lua_upv®uešdex
(1));

76 
r
 = 
	`aux»sume
(
L
, 
co
, 
	`lua_g‘tİ
(L));

77 ià(
r
 < 0) {

78 ià(
	`lua_ty³
(
L
, -1è=ğ
LUA_TSTRING
) {

79 
	`luaL_wh”e
(
L
, 1);

80 
	`lua_š£¹
(
L
, -2);

81 
	`lua_cÚÿt
(
L
, 2);

83  
	`lua_”rÜ
(
L
);

85  
r
;

86 
	}
}

89 
	$luaB_coü—‹
 (
lua_S‹
 *
L
) {

90 
lua_S‹
 *
NL
;

91 
	`luaL_checkty³
(
L
, 1, 
LUA_TFUNCTION
);

92 
NL
 = 
	`lua_Ãwth»ad
(
L
);

93 
	`lua_pushv®ue
(
L
, 1);

94 
	`lua_xmove
(
L
, 
NL
, 1);

96 
	}
}

99 
	$luaB_cow¿p
 (
lua_S‹
 *
L
) {

100 
	`luaB_coü—‹
(
L
);

101 
	`lua_pushcşosu»
(
L
, 
luaB_auxw¿p
, 1);

103 
	}
}

106 
	$luaB_y›ld
 (
lua_S‹
 *
L
) {

107  
	`lua_y›ld
(
L
, 
	`lua_g‘tİ
(L));

108 
	}
}

111 
	$luaB_co¡©us
 (
lua_S‹
 *
L
) {

112 
lua_S‹
 *
co
 = 
	`g‘co
(
L
);

113 ià(
L
 =ğ
co
è
	`lua_pushl™”®
(L, "running");

115 
	`lua_¡©us
(
co
)) {

116 
LUA_YIELD
:

117 
	`lua_pushl™”®
(
L
, "suspended");

119 
LUA_OK
: {

120 
lua_Debug
 
¬
;

121 ià(
	`lua_g‘¡ack
(
co
, 0, &
¬
) > 0)

122 
	`lua_pushl™”®
(
L
, "normal");

123 ià(
	`lua_g‘tİ
(
co
) == 0)

124 
	`lua_pushl™”®
(
L
, "dead");

126 
	`lua_pushl™”®
(
L
, "suspended");

130 
	`lua_pushl™”®
(
L
, "dead");

135 
	}
}

138 
	$luaB_y›ldabË
 (
lua_S‹
 *
L
) {

139 
	`lua_pushboŞ—n
(
L
, 
	`lua_isy›ldabË
(L));

141 
	}
}

144 
	$luaB_cÜuÂšg
 (
lua_S‹
 *
L
) {

145 
ismaš
 = 
	`lua_pushth»ad
(
L
);

146 
	`lua_pushboŞ—n
(
L
, 
ismaš
);

148 
	}
}

151 cÚ¡ 
luaL_Reg
 
	gco_funcs
[] = {

152 {"ü—‹", 
luaB_coü—‹
},

153 {"»sume", 
luaB_cÜesume
},

154 {"ruÂšg", 
luaB_cÜuÂšg
},

155 {"¡©us", 
luaB_co¡©us
},

156 {"w¿p", 
luaB_cow¿p
},

157 {"y›ld", 
luaB_y›ld
},

158 {"isy›ldabË", 
luaB_y›ldabË
},

159 {
NULL
, NULL}

164 
LUAMOD_API
 
	$luaİ’_cÜoutše
 (
lua_S‹
 *
L
) {

165 
	`luaL_Ãwlib
(
L
, 
co_funcs
);

167 
	}
}

	@script/lua/lua-5.3.4/src/lctype.c

7 
	#lùy³_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~"lùy³.h
"

15 #ià!
LUA_USE_CTYPE


17 
	~<lim™s.h
>

19 
LUAI_DDEF
 cÚ¡ 
lu_by‹
 
	gluai_ùy³_
[
UCHAR_MAX
 + 2] = {

	@script/lua/lua-5.3.4/src/lctype.h

7 #iâdeà
lùy³_h


8 
	#lùy³_h


	)

10 
	~"lua.h
"

19 #ià!
defšed
(
LUA_USE_CTYPE
)

23 
	#LUA_USE_CTYPE
 0

	)

26 
	#LUA_USE_CTYPE
 1

	)

32 #ià!
LUA_USE_CTYPE


34 
	~<lim™s.h
>

36 
	~"Îim™s.h
"

39 
	#ALPHABIT
 0

	)

40 
	#DIGITBIT
 1

	)

41 
	#PRINTBIT
 2

	)

42 
	#SPACEBIT
 3

	)

43 
	#XDIGITBIT
 4

	)

46 
	#MASK
(
B
è(1 << (B))

	)

52 
	#‹¡´İ
(
c
,
p
è(
luai_ùy³_
[(c)+1] & (p))

	)

57 
	#li¦®pha
(
c
è
	`‹¡´İ
(c, 
	`MASK
(
ALPHABIT
))

	)

58 
	#li¦®num
(
c
è
	`‹¡´İ
(c, (
	`MASK
(
ALPHABIT
è| MASK(
DIGITBIT
)))

	)

59 
	#lisdig™
(
c
è
	`‹¡´İ
(c, 
	`MASK
(
DIGITBIT
))

	)

60 
	#lis¥aû
(
c
è
	`‹¡´İ
(c, 
	`MASK
(
SPACEBIT
))

	)

61 
	#li¥ršt
(
c
è
	`‹¡´İ
(c, 
	`MASK
(
PRINTBIT
))

	)

62 
	#lisxdig™
(
c
è
	`‹¡´İ
(c, 
	`MASK
(
XDIGITBIT
))

	)

67 
	#ÉŞow”
(
c
è((cè| ('A' ^ 'a'))

	)

71 
LUAI_DDEC
 cÚ¡ 
lu_by‹
 
	gluai_ùy³_
[
UCHAR_MAX
 + 2];

80 
	~<ùy³.h
>

83 
	#li¦®pha
(
c
è(
	`i§Íha
(cè|| (cè=ğ'_')

	)

84 
	#li¦®num
(
c
è(
	`i§Êum
(cè|| (cè=ğ'_')

	)

85 
	#lisdig™
(
c
è(
	`isdig™
(c))

	)

86 
	#lis¥aû
(
c
è(
	`is¥aû
(c))

	)

87 
	#li¥ršt
(
c
è(
	`i¥ršt
(c))

	)

88 
	#lisxdig™
(
c
è(
	`isxdig™
(c))

	)

90 
	#ÉŞow”
(
c
è(
	`tŞow”
(c))

	)

	@script/lua/lua-5.3.4/src/ldblib.c

7 
	#ldblib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<¡dio.h
>

14 
	~<¡dlib.h
>

15 
	~<¡ršg.h
>

17 
	~"lua.h
"

19 
	~"Ïuxlib.h
"

20 
	~"lu®ib.h
"

27 cÚ¡ 
	gHOOKKEY
 = 0;

35 
	$check¡ack
 (
lua_S‹
 *
L
,†ua_S‹ *
L1
, 
n
) {

36 ià(
L
 !ğ
L1
 && !
	`lua_check¡ack
(L1, 
n
))

37 
	`luaL_”rÜ
(
L
, "stack overflow");

38 
	}
}

41 
	$db_g‘»gi¡ry
 (
lua_S‹
 *
L
) {

42 
	`lua_pushv®ue
(
L
, 
LUA_REGISTRYINDEX
);

44 
	}
}

47 
	$db_g‘m‘©abË
 (
lua_S‹
 *
L
) {

48 
	`luaL_checkªy
(
L
, 1);

49 ià(!
	`lua_g‘m‘©abË
(
L
, 1)) {

50 
	`lua_pushn
(
L
);

53 
	}
}

56 
	$db_£tm‘©abË
 (
lua_S‹
 *
L
) {

57 
t
 = 
	`lua_ty³
(
L
, 2);

58 
	`luaL_¬gcheck
(
L
, 
t
 =ğ
LUA_TNIL
 || =ğ
LUA_TTABLE
, 2,

60 
	`lua_£‰İ
(
L
, 2);

61 
	`lua_£tm‘©abË
(
L
, 1);

63 
	}
}

66 
	$db_g‘u£rv®ue
 (
lua_S‹
 *
L
) {

67 ià(
	`lua_ty³
(
L
, 1è!ğ
LUA_TUSERDATA
)

68 
	`lua_pushn
(
L
);

70 
	`lua_g‘u£rv®ue
(
L
, 1);

72 
	}
}

75 
	$db_£tu£rv®ue
 (
lua_S‹
 *
L
) {

76 
	`luaL_checkty³
(
L
, 1, 
LUA_TUSERDATA
);

77 
	`luaL_checkªy
(
L
, 2);

78 
	`lua_£‰İ
(
L
, 2);

79 
	`lua_£tu£rv®ue
(
L
, 1);

81 
	}
}

90 
lua_S‹
 *
	$g‘th»ad
 (
lua_S‹
 *
L
, *
¬g
) {

91 ià(
	`lua_i¡h»ad
(
L
, 1)) {

92 *
¬g
 = 1;

93  
	`lua_tÙh»ad
(
L
, 1);

96 *
¬g
 = 0;

97  
L
;

99 
	}
}

107 
	$£‰abss
 (
lua_S‹
 *
L
, cÚ¡ *
k
, cÚ¡ *
v
) {

108 
	`lua_push¡ršg
(
L
, 
v
);

109 
	`lua_£tf›ld
(
L
, -2, 
k
);

110 
	}
}

112 
	$£‰absi
 (
lua_S‹
 *
L
, cÚ¡ *
k
, 
v
) {

113 
	`lua_pushš‹g”
(
L
, 
v
);

114 
	`lua_£tf›ld
(
L
, -2, 
k
);

115 
	}
}

117 
	$£‰absb
 (
lua_S‹
 *
L
, cÚ¡ *
k
, 
v
) {

118 
	`lua_pushboŞ—n
(
L
, 
v
);

119 
	`lua_£tf›ld
(
L
, -2, 
k
);

120 
	}
}

130 
	$Œ—t¡ackİtiÚ
 (
lua_S‹
 *
L
,†ua_S‹ *
L1
, cÚ¡ *
âame
) {

131 ià(
L
 =ğ
L1
)

132 
	`lua_rÙ©e
(
L
, -2, 1);

134 
	`lua_xmove
(
L1
, 
L
, 1);

135 
	`lua_£tf›ld
(
L
, -2, 
âame
);

136 
	}
}

145 
	$db_g‘šfo
 (
lua_S‹
 *
L
) {

146 
lua_Debug
 
¬
;

147 
¬g
;

148 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

149 cÚ¡ *
İtiÚs
 = 
	`luaL_İt¡ršg
(
L
, 
¬g
+2, "flnStu");

150 
	`check¡ack
(
L
, 
L1
, 3);

151 ià(
	`lua_isfunùiÚ
(
L
, 
¬g
 + 1)) {

152 
İtiÚs
 = 
	`lua_pushf¡ršg
(
L
, ">%s", options);

153 
	`lua_pushv®ue
(
L
, 
¬g
 + 1);

154 
	`lua_xmove
(
L
, 
L1
, 1);

157 ià(!
	`lua_g‘¡ack
(
L1
, ()
	`luaL_checkš‹g”
(
L
, 
¬g
 + 1), &
¬
)) {

158 
	`lua_pushn
(
L
);

162 ià(!
	`lua_g‘šfo
(
L1
, 
İtiÚs
, &
¬
))

163  
	`luaL_¬g”rÜ
(
L
, 
¬g
+2, "invalid option");

164 
	`lua_ÃwbË
(
L
);

165 ià(
	`¡rchr
(
İtiÚs
, 'S')) {

166 
	`£‰abss
(
L
, "sourû", 
¬
.
sourû
);

167 
	`£‰abss
(
L
, "shÜt_¤c", 
¬
.
shÜt_¤c
);

168 
	`£‰absi
(
L
, "lšedefšed", 
¬
.
lšedefšed
);

169 
	`£‰absi
(
L
, "Ï¡lšedefšed", 
¬
.
Ï¡lšedefšed
);

170 
	`£‰abss
(
L
, "wh©", 
¬
.
wh©
);

172 ià(
	`¡rchr
(
İtiÚs
, 'l'))

173 
	`£‰absi
(
L
, "cu¼’še", 
¬
.
cu¼’še
);

174 ià(
	`¡rchr
(
İtiÚs
, 'u')) {

175 
	`£‰absi
(
L
, "nups", 
¬
.
nups
);

176 
	`£‰absi
(
L
, "Å¬ams", 
¬
.
Å¬ams
);

177 
	`£‰absb
(
L
, "isv¬¬g", 
¬
.
isv¬¬g
);

179 ià(
	`¡rchr
(
İtiÚs
, 'n')) {

180 
	`£‰abss
(
L
, "Çme", 
¬
.
Çme
);

181 
	`£‰abss
(
L
, "Çmewh©", 
¬
.
Çmewh©
);

183 ià(
	`¡rchr
(
İtiÚs
, 't'))

184 
	`£‰absb
(
L
, "i¡aÿÎ", 
¬
.
i¡aÿÎ
);

185 ià(
	`¡rchr
(
İtiÚs
, 'L'))

186 
	`Œ—t¡ackİtiÚ
(
L
, 
L1
, "activelines");

187 ià(
	`¡rchr
(
İtiÚs
, 'f'))

188 
	`Œ—t¡ackİtiÚ
(
L
, 
L1
, "func");

190 
	}
}

193 
	$db_g‘loÿl
 (
lua_S‹
 *
L
) {

194 
¬g
;

195 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

196 
lua_Debug
 
¬
;

197 cÚ¡ *
Çme
;

198 
nv¬
 = ()
	`luaL_checkš‹g”
(
L
, 
¬g
 + 2);

199 ià(
	`lua_isfunùiÚ
(
L
, 
¬g
 + 1)) {

200 
	`lua_pushv®ue
(
L
, 
¬g
 + 1);

201 
	`lua_push¡ršg
(
L
, 
	`lua_g‘loÿl
(L, 
NULL
, 
nv¬
));

205 
Ëv–
 = ()
	`luaL_checkš‹g”
(
L
, 
¬g
 + 1);

206 ià(!
	`lua_g‘¡ack
(
L1
, 
Ëv–
, &
¬
))

207  
	`luaL_¬g”rÜ
(
L
, 
¬g
+1, "level out of„ange");

208 
	`check¡ack
(
L
, 
L1
, 1);

209 
Çme
 = 
	`lua_g‘loÿl
(
L1
, &
¬
, 
nv¬
);

210 ià(
Çme
) {

211 
	`lua_xmove
(
L1
, 
L
, 1);

212 
	`lua_push¡ršg
(
L
, 
Çme
);

213 
	`lua_rÙ©e
(
L
, -2, 1);

217 
	`lua_pushn
(
L
);

221 
	}
}

224 
	$db_£oÿl
 (
lua_S‹
 *
L
) {

225 
¬g
;

226 cÚ¡ *
Çme
;

227 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

228 
lua_Debug
 
¬
;

229 
Ëv–
 = ()
	`luaL_checkš‹g”
(
L
, 
¬g
 + 1);

230 
nv¬
 = ()
	`luaL_checkš‹g”
(
L
, 
¬g
 + 2);

231 ià(!
	`lua_g‘¡ack
(
L1
, 
Ëv–
, &
¬
))

232  
	`luaL_¬g”rÜ
(
L
, 
¬g
+1, "level out of„ange");

233 
	`luaL_checkªy
(
L
, 
¬g
+3);

234 
	`lua_£‰İ
(
L
, 
¬g
+3);

235 
	`check¡ack
(
L
, 
L1
, 1);

236 
	`lua_xmove
(
L
, 
L1
, 1);

237 
Çme
 = 
	`lua_£oÿl
(
L1
, &
¬
, 
nv¬
);

238 ià(
Çme
 =ğ
NULL
)

239 
	`lua_pİ
(
L1
, 1);

240 
	`lua_push¡ršg
(
L
, 
Çme
);

242 
	}
}

248 
	$auxupv®ue
 (
lua_S‹
 *
L
, 
g‘
) {

249 cÚ¡ *
Çme
;

250 
n
 = ()
	`luaL_checkš‹g”
(
L
, 2);

251 
	`luaL_checkty³
(
L
, 1, 
LUA_TFUNCTION
);

252 
Çme
 = 
g‘
 ? 
	`lua_g‘upv®ue
(
L
, 1, 
n
è: 
	`lua_£tupv®ue
(L, 1,‚);

253 ià(
Çme
 =ğ
NULL
)  0;

254 
	`lua_push¡ršg
(
L
, 
Çme
);

255 
	`lua_š£¹
(
L
, -(
g‘
+1));

256  
g‘
 + 1;

257 
	}
}

260 
	$db_g‘upv®ue
 (
lua_S‹
 *
L
) {

261  
	`auxupv®ue
(
L
, 1);

262 
	}
}

265 
	$db_£tupv®ue
 (
lua_S‹
 *
L
) {

266 
	`luaL_checkªy
(
L
, 3);

267  
	`auxupv®ue
(
L
, 0);

268 
	}
}

275 
	$checkupv®
 (
lua_S‹
 *
L
, 
¬gf
, 
¬gnup
) {

276 
nup
 = ()
	`luaL_checkš‹g”
(
L
, 
¬gnup
);

277 
	`luaL_checkty³
(
L
, 
¬gf
, 
LUA_TFUNCTION
);

278 
	`luaL_¬gcheck
(
L
, (
	`lua_g‘upv®ue
(L, 
¬gf
, 
nup
è!ğ
NULL
), 
¬gnup
,

280  
nup
;

281 
	}
}

284 
	$db_upv®ueid
 (
lua_S‹
 *
L
) {

285 
n
 = 
	`checkupv®
(
L
, 1, 2);

286 
	`lua_pushlightu£rd©a
(
L
, 
	`lua_upv®ueid
(L, 1, 
n
));

288 
	}
}

291 
	$db_upv®uejoš
 (
lua_S‹
 *
L
) {

292 
n1
 = 
	`checkupv®
(
L
, 1, 2);

293 
n2
 = 
	`checkupv®
(
L
, 3, 4);

294 
	`luaL_¬gcheck
(
L
, !
	`lua_iscfunùiÚ
(L, 1), 1, "Lua functionƒxpected");

295 
	`luaL_¬gcheck
(
L
, !
	`lua_iscfunùiÚ
(L, 3), 3, "Lua functionƒxpected");

296 
	`lua_upv®uejoš
(
L
, 1, 
n1
, 3, 
n2
);

298 
	}
}

305 
	$hookf
 (
lua_S‹
 *
L
, 
lua_Debug
 *
¬
) {

306 cÚ¡ *cÚ¡ 
hookÇmes
[] =

308 
	`lua_¿wg‘p
(
L
, 
LUA_REGISTRYINDEX
, &
HOOKKEY
);

309 
	`lua_pushth»ad
(
L
);

310 ià(
	`lua_¿wg‘
(
L
, -2è=ğ
LUA_TFUNCTION
) {

311 
	`lua_push¡ršg
(
L
, 
hookÇmes
[()
¬
->
ev’t
]);

312 ià(
¬
->
cu¼’še
 >= 0)

313 
	`lua_pushš‹g”
(
L
, 
¬
->
cu¼’še
);

314 
	`lua_pushn
(
L
);

315 
	`lua_as£¹
(
	`lua_g‘šfo
(
L
, "lS", 
¬
));

316 
	`lua_ÿÎ
(
L
, 2, 0);

318 
	}
}

324 
	$makemask
 (cÚ¡ *
smask
, 
couÁ
) {

325 
mask
 = 0;

326 ià(
	`¡rchr
(
smask
, 'c')è
mask
 |ğ
LUA_MASKCALL
;

327 ià(
	`¡rchr
(
smask
, 'r')è
mask
 |ğ
LUA_MASKRET
;

328 ià(
	`¡rchr
(
smask
, 'l')è
mask
 |ğ
LUA_MASKLINE
;

329 ià(
couÁ
 > 0è
mask
 |ğ
LUA_MASKCOUNT
;

330  
mask
;

331 
	}
}

337 *
	$unmakemask
 (
mask
, *
smask
) {

338 
i
 = 0;

339 ià(
mask
 & 
LUA_MASKCALL
è
smask
[
i
++] = 'c';

340 ià(
mask
 & 
LUA_MASKRET
è
smask
[
i
++] = 'r';

341 ià(
mask
 & 
LUA_MASKLINE
è
smask
[
i
++] = 'l';

342 
smask
[
i
] = '\0';

343  
smask
;

344 
	}
}

347 
	$db_£thook
 (
lua_S‹
 *
L
) {

348 
¬g
, 
mask
, 
couÁ
;

349 
lua_Hook
 
func
;

350 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

351 ià(
	`lua_i¢ÚeÜn
(
L
, 
¬g
+1)) {

352 
	`lua_£‰İ
(
L
, 
¬g
+1);

353 
func
 = 
NULL
; 
mask
 = 0; 
couÁ
 = 0;

356 cÚ¡ *
smask
 = 
	`luaL_check¡ršg
(
L
, 
¬g
+2);

357 
	`luaL_checkty³
(
L
, 
¬g
+1, 
LUA_TFUNCTION
);

358 
couÁ
 = ()
	`luaL_İtš‹g”
(
L
, 
¬g
 + 3, 0);

359 
func
 = 
hookf
; 
mask
 = 
	`makemask
(
smask
, 
couÁ
);

361 ià(
	`lua_¿wg‘p
(
L
, 
LUA_REGISTRYINDEX
, &
HOOKKEY
è=ğ
LUA_TNIL
) {

362 
	`lua_ü—‹bË
(
L
, 0, 2);

363 
	`lua_pushv®ue
(
L
, -1);

364 
	`lua_¿w£
(
L
, 
LUA_REGISTRYINDEX
, &
HOOKKEY
);

365 
	`lua_push¡ršg
(
L
, "k");

366 
	`lua_£tf›ld
(
L
, -2, "__mode");

367 
	`lua_pushv®ue
(
L
, -1);

368 
	`lua_£tm‘©abË
(
L
, -2);

370 
	`check¡ack
(
L
, 
L1
, 1);

371 
	`lua_pushth»ad
(
L1
); 
	`lua_xmove
(L1, 
L
, 1);

372 
	`lua_pushv®ue
(
L
, 
¬g
 + 1);

373 
	`lua_¿w£t
(
L
, -3);

374 
	`lua_£thook
(
L1
, 
func
, 
mask
, 
couÁ
);

376 
	}
}

379 
	$db_g‘hook
 (
lua_S‹
 *
L
) {

380 
¬g
;

381 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

382 
buff
[5];

383 
mask
 = 
	`lua_g‘hookmask
(
L1
);

384 
lua_Hook
 
hook
 = 
	`lua_g‘hook
(
L1
);

385 ià(
hook
 =ğ
NULL
)

386 
	`lua_pushn
(
L
);

387 ià(
hook
 !ğ
hookf
)

388 
	`lua_pushl™”®
(
L
, "external hook");

390 
	`lua_¿wg‘p
(
L
, 
LUA_REGISTRYINDEX
, &
HOOKKEY
);

391 
	`check¡ack
(
L
, 
L1
, 1);

392 
	`lua_pushth»ad
(
L1
); 
	`lua_xmove
(L1, 
L
, 1);

393 
	`lua_¿wg‘
(
L
, -2);

394 
	`lua_»move
(
L
, -2);

396 
	`lua_push¡ršg
(
L
, 
	`unmakemask
(
mask
, 
buff
));

397 
	`lua_pushš‹g”
(
L
, 
	`lua_g‘hookcouÁ
(
L1
));

399 
	}
}

402 
	$db_debug
 (
lua_S‹
 *
L
) {

404 
bufãr
[250];

405 
	`lua_wr™e¡ršg”rÜ
("%s", "lua_debug> ");

406 ià(
	`fg‘s
(
bufãr
, (bufãr), 
¡dš
) == 0 ||

407 
	`¡rcmp
(
bufãr
, "cont\n") == 0)

409 ià(
	`luaL_lßdbufãr
(
L
, 
bufãr
, 
	`¡¾’
(buffer), "=(debug command)") ||

410 
	`lua_pÿÎ
(
L
, 0, 0, 0))

411 
	`lua_wr™e¡ršg”rÜ
("%s\n", 
	`lua_to¡ršg
(
L
, -1));

412 
	`lua_£‰İ
(
L
, 0);

414 
	}
}

417 
	$db_Œaûback
 (
lua_S‹
 *
L
) {

418 
¬g
;

419 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

420 cÚ¡ *
msg
 = 
	`lua_to¡ršg
(
L
, 
¬g
 + 1);

421 ià(
msg
 =ğ
NULL
 && !
	`lua_i¢ÚeÜn
(
L
, 
¬g
 + 1))

422 
	`lua_pushv®ue
(
L
, 
¬g
 + 1);

424 
Ëv–
 = ()
	`luaL_İtš‹g”
(
L
, 
¬g
 + 2, (L =ğ
L1
) ? 1 : 0);

425 
	`luaL_Œaûback
(
L
, 
L1
, 
msg
, 
Ëv–
);

428 
	}
}

431 cÚ¡ 
luaL_Reg
 
	gdblib
[] = {

432 {"debug", 
db_debug
},

433 {"g‘u£rv®ue", 
db_g‘u£rv®ue
},

434 {"g‘hook", 
db_g‘hook
},

435 {"g‘šfo", 
db_g‘šfo
},

436 {"g‘loÿl", 
db_g‘loÿl
},

437 {"g‘»gi¡ry", 
db_g‘»gi¡ry
},

438 {"g‘m‘©abË", 
db_g‘m‘©abË
},

439 {"g‘upv®ue", 
db_g‘upv®ue
},

440 {"upv®uejoš", 
db_upv®uejoš
},

441 {"upv®ueid", 
db_upv®ueid
},

442 {"£tu£rv®ue", 
db_£tu£rv®ue
},

443 {"£thook", 
db_£thook
},

444 {"£oÿl", 
db_£oÿl
},

445 {"£tm‘©abË", 
db_£tm‘©abË
},

446 {"£tupv®ue", 
db_£tupv®ue
},

447 {"Œaûback", 
db_Œaûback
},

448 {
NULL
, NULL}

452 
LUAMOD_API
 
	$luaİ’_debug
 (
lua_S‹
 *
L
) {

453 
	`luaL_Ãwlib
(
L
, 
dblib
);

455 
	}
}

	@script/lua/lua-5.3.4/src/ldebug.c

7 
	#ldebug_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡d¬g.h
>

14 
	~<¡ddef.h
>

15 
	~<¡ršg.h
>

17 
	~"lua.h
"

19 
	~"Ïpi.h
"

20 
	~"lcode.h
"

21 
	~"ldebug.h
"

22 
	~"ldo.h
"

23 
	~"lfunc.h
"

24 
	~"lobjeù.h
"

25 
	~"lİcodes.h
"

26 
	~"l¡©e.h
"

27 
	~"l¡ršg.h
"

28 
	~"ÉabË.h
"

29 
	~"Ém.h
"

30 
	~"lvm.h
"

34 
	#noLuaClosu»
(
f
è((fè=ğ
NULL
 || (f)->
c
.
‰
 =ğ
LUA_TCCL
)

	)

38 
	#ci_func
(
ci
è(
	`şLv®ue
((ci)->
func
))

	)

41 cÚ¡ *
funúameäomcode
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
,

42 cÚ¡ **
Çme
);

45 
	$cu¼’c
 (
C®lInfo
 *
ci
) {

46 
	`lua_as£¹
(
	`isLua
(
ci
));

47  
	`pcR–
(
ci
->
u
.
l
.
§vedpc
, 
	`ci_func
(ci)->
p
);

48 
	}
}

51 
	$cu¼’še
 (
C®lInfo
 *
ci
) {

52  
	`g‘funşše
(
	`ci_func
(
ci
)->
p
, 
	`cu¼’c
(ci));

53 
	}
}

62 
	$sw­exŒa
 (
lua_S‹
 *
L
) {

63 ià(
L
->
¡©us
 =ğ
LUA_YIELD
) {

64 
C®lInfo
 *
ci
 = 
L
->ci;

65 
StkId
 
‹mp
 = 
ci
->
func
;

66 
ci
->
func
 = 
	`»¡Üe¡ack
(
L
, ci->
exŒa
);

67 
ci
->
exŒa
 = 
	`§ve¡ack
(
L
, 
‹mp
);

69 
	}
}

81 
LUA_API
 
	$lua_£thook
 (
lua_S‹
 *
L
, 
lua_Hook
 
func
, 
mask
, 
couÁ
) {

82 ià(
func
 =ğ
NULL
 || 
mask
 == 0) {

83 
mask
 = 0;

84 
func
 = 
NULL
;

86 ià(
	`isLua
(
L
->
ci
))

87 
L
->
Şdpc
 = L->
ci
->
u
.
l
.
§vedpc
;

88 
L
->
hook
 = 
func
;

89 
L
->
ba£hookcouÁ
 = 
couÁ
;

90 
	`»£thookcouÁ
(
L
);

91 
L
->
hookmask
 = 
	`ÿ¡_by‹
(
mask
);

92 
	}
}

95 
LUA_API
 
lua_Hook
 
	$lua_g‘hook
 (
lua_S‹
 *
L
) {

96  
L
->
hook
;

97 
	}
}

100 
LUA_API
 
	$lua_g‘hookmask
 (
lua_S‹
 *
L
) {

101  
L
->
hookmask
;

102 
	}
}

105 
LUA_API
 
	$lua_g‘hookcouÁ
 (
lua_S‹
 *
L
) {

106  
L
->
ba£hookcouÁ
;

107 
	}
}

110 
LUA_API
 
	$lua_g‘¡ack
 (
lua_S‹
 *
L
, 
Ëv–
, 
lua_Debug
 *
¬
) {

111 
¡©us
;

112 
C®lInfo
 *
ci
;

113 ià(
Ëv–
 < 0)  0;

114 
	`lua_lock
(
L
);

115 
ci
 = 
L
->ci; 
Ëv–
 > 0 && c˜!ğ&L->
ba£_ci
; c˜ğci->
´evious
)

116 
Ëv–
--;

117 ià(
Ëv–
 =ğ0 && 
ci
 !ğ&
L
->
ba£_ci
) {

118 
¡©us
 = 1;

119 
¬
->
i_ci
 = 
ci
;

121 
¡©us
 = 0;

122 
	`lua_uÆock
(
L
);

123  
¡©us
;

124 
	}
}

127 cÚ¡ *
	$upv®Çme
 (
PrÙo
 *
p
, 
uv
) {

128 
TSŒšg
 *
s
 = 
	`check_exp
(
uv
 < 
p
->
sizeupv®ues
,…->
upv®ues
[uv].
Çme
);

129 ià(
s
 =ğ
NULL
)  "?";

130  
	`g‘¡r
(
s
);

131 
	}
}

134 cÚ¡ *
	$fšdv¬¬g
 (
C®lInfo
 *
ci
, 
n
, 
StkId
 *
pos
) {

135 
Å¬ams
 = 
	`şLv®ue
(
ci
->
func
)->
p
->
num·¿ms
;

136 ià(
n
 >ğ
	`ÿ¡_št
(
ci
->
u
.
l
.
ba£
 - ci->
func
è- 
Å¬ams
)

137  
NULL
;

139 *
pos
 = 
ci
->
func
 + 
Å¬ams
 + 
n
;

142 
	}
}

145 cÚ¡ *
	$fšdloÿl
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
, 
n
,

146 
StkId
 *
pos
) {

147 cÚ¡ *
Çme
 = 
NULL
;

148 
StkId
 
ba£
;

149 ià(
	`isLua
(
ci
)) {

150 ià(
n
 < 0)

151  
	`fšdv¬¬g
(
ci
, -
n
, 
pos
);

153 
ba£
 = 
ci
->
u
.
l
.base;

154 
Çme
 = 
	`luaF_g‘loÿÊame
(
	`ci_func
(
ci
)->
p
, 
n
, 
	`cu¼’c
(ci));

158 
ba£
 = 
ci
->
func
 + 1;

159 ià(
Çme
 =ğ
NULL
) {

160 
StkId
 
lim™
 = (
ci
 =ğ
L
->ciè? L->
tİ
 : ci->
Ãxt
->
func
;

161 ià(
lim™
 - 
ba£
 >ğ
n
 &&‚ > 0)

162 
Çme
 = "(*temporary)";

164  
NULL
;

166 *
pos
 = 
ba£
 + (
n
 - 1);

167  
Çme
;

168 
	}
}

171 
LUA_API
 cÚ¡ *
	$lua_g‘loÿl
 (
lua_S‹
 *
L
, cÚ¡ 
lua_Debug
 *
¬
, 
n
) {

172 cÚ¡ *
Çme
;

173 
	`lua_lock
(
L
);

174 
	`sw­exŒa
(
L
);

175 ià(
¬
 =ğ
NULL
) {

176 ià(!
	`isLfunùiÚ
(
L
->
tİ
 - 1))

177 
Çme
 = 
NULL
;

179 
Çme
 = 
	`luaF_g‘loÿÊame
(
	`şLv®ue
(
L
->
tİ
 - 1)->
p
, 
n
, 0);

182 
StkId
 
pos
 = 
NULL
;

183 
Çme
 = 
	`fšdloÿl
(
L
, 
¬
->
i_ci
, 
n
, &
pos
);

184 ià(
Çme
) {

185 
	`£tobj2s
(
L
, L->
tİ
, 
pos
);

186 
	`­i_šü_tİ
(
L
);

189 
	`sw­exŒa
(
L
);

190 
	`lua_uÆock
(
L
);

191  
Çme
;

192 
	}
}

195 
LUA_API
 cÚ¡ *
	$lua_£oÿl
 (
lua_S‹
 *
L
, cÚ¡ 
lua_Debug
 *
¬
, 
n
) {

196 
StkId
 
pos
 = 
NULL
;

197 cÚ¡ *
Çme
;

198 
	`lua_lock
(
L
);

199 
	`sw­exŒa
(
L
);

200 
Çme
 = 
	`fšdloÿl
(
L
, 
¬
->
i_ci
, 
n
, &
pos
);

201 ià(
Çme
) {

202 
	`£tobjs2s
(
L
, 
pos
, L->
tİ
 - 1);

203 
L
->
tİ
--;

205 
	`sw­exŒa
(
L
);

206 
	`lua_uÆock
(
L
);

207  
Çme
;

208 
	}
}

211 
	$funcšfo
 (
lua_Debug
 *
¬
, 
Closu»
 *
ş
) {

212 ià(
	`noLuaClosu»
(
ş
)) {

213 
¬
->
sourû
 = "=[C]";

214 
¬
->
lšedefšed
 = -1;

215 
¬
->
Ï¡lšedefšed
 = -1;

216 
¬
->
wh©
 = "C";

219 
PrÙo
 *
p
 = 
ş
->
l
.p;

220 
¬
->
sourû
 = 
p
->sourû ? 
	`g‘¡r
(p->source) : "=?";

221 
¬
->
lšedefšed
 = 
p
->linedefined;

222 
¬
->
Ï¡lšedefšed
 = 
p
->lastlinedefined;

223 
¬
->
wh©
 = (¬->
lšedefšed
 == 0) ? "main" : "Lua";

225 
	`luaO_chunkid
(
¬
->
shÜt_¤c
,‡r->
sourû
, 
LUA_IDSIZE
);

226 
	}
}

229 
	$cŞËùv®idlšes
 (
lua_S‹
 *
L
, 
Closu»
 *
f
) {

230 ià(
	`noLuaClosu»
(
f
)) {

231 
	`£Šv®ue
(
L
->
tİ
);

232 
	`­i_šü_tİ
(
L
);

235 
i
;

236 
TV®ue
 
v
;

237 *
lšešfo
 = 
f
->
l
.
p
->lineinfo;

238 
TabË
 *
t
 = 
	`luaH_Ãw
(
L
);

239 
	`£thv®ue
(
L
, L->
tİ
, 
t
);

240 
	`­i_šü_tİ
(
L
);

241 
	`£tbv®ue
(&
v
, 1);

242 
i
 = 0; i < 
f
->
l
.
p
->
siz–šešfo
; i++)

243 
	`luaH_£tšt
(
L
, 
t
, 
lšešfo
[
i
], &
v
);

245 
	}
}

248 cÚ¡ *
	$g‘funúame
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
, cÚ¡ **
Çme
) {

249 ià(
ci
 =ğ
NULL
)

250  
NULL
;

251 ià(
ci
->
ÿÎ¡©us
 & 
CIST_FIN
) {

252 *
Çme
 = "__gc";

256 ià(!(
ci
->
ÿÎ¡©us
 & 
CIST_TAIL
è&& 
	`isLua
(ci->
´evious
))

257  
	`funúameäomcode
(
L
, 
ci
->
´evious
, 
Çme
);

258  
NULL
;

259 
	}
}

262 
	$auxg‘šfo
 (
lua_S‹
 *
L
, cÚ¡ *
wh©
, 
lua_Debug
 *
¬
,

263 
Closu»
 *
f
, 
C®lInfo
 *
ci
) {

264 
¡©us
 = 1;

265 ; *
wh©
; what++) {

266 *
wh©
) {

268 
	`funcšfo
(
¬
, 
f
);

272 
¬
->
cu¼’še
 = (
ci
 && 
	`isLua
(ci)è? 
	`cu¼’še
(ci) : -1;

276 
¬
->
nups
 = (
f
 =ğ
NULL
è? 0 : f->
c
.
nupv®ues
;

277 ià(
	`noLuaClosu»
(
f
)) {

278 
¬
->
isv¬¬g
 = 1;

279 
¬
->
Å¬ams
 = 0;

282 
¬
->
isv¬¬g
 = 
f
->
l
.
p
->
is_v¬¬g
;

283 
¬
->
Å¬ams
 = 
f
->
l
.
p
->
num·¿ms
;

288 
¬
->
i¡aÿÎ
 = (
ci
è? ci->
ÿÎ¡©us
 & 
CIST_TAIL
 : 0;

292 
¬
->
Çmewh©
 = 
	`g‘funúame
(
L
, 
ci
, &¬->
Çme
);

293 ià(
¬
->
Çmewh©
 =ğ
NULL
) {

294 
¬
->
Çmewh©
 = "";

295 
¬
->
Çme
 = 
NULL
;

302 : 
¡©us
 = 0;

305  
¡©us
;

306 
	}
}

309 
LUA_API
 
	$lua_g‘šfo
 (
lua_S‹
 *
L
, cÚ¡ *
wh©
, 
lua_Debug
 *
¬
) {

310 
¡©us
;

311 
Closu»
 *
ş
;

312 
C®lInfo
 *
ci
;

313 
StkId
 
func
;

314 
	`lua_lock
(
L
);

315 
	`sw­exŒa
(
L
);

316 ià(*
wh©
 == '>') {

317 
ci
 = 
NULL
;

318 
func
 = 
L
->
tİ
 - 1;

319 
	`­i_check
(
L
, 
	`‰isfunùiÚ
(
func
), "functionƒxpected");

320 
wh©
++;

321 
L
->
tİ
--;

324 
ci
 = 
¬
->
i_ci
;

325 
func
 = 
ci
->func;

326 
	`lua_as£¹
(
	`‰isfunùiÚ
(
ci
->
func
));

328 
ş
 = 
	`‰isşosu»
(
func
è? 
	`şv®ue
(funcè: 
NULL
;

329 
¡©us
 = 
	`auxg‘šfo
(
L
, 
wh©
, 
¬
, 
ş
, 
ci
);

330 ià(
	`¡rchr
(
wh©
, 'f')) {

331 
	`£tobjs2s
(
L
, L->
tİ
, 
func
);

332 
	`­i_šü_tİ
(
L
);

334 
	`sw­exŒa
(
L
);

335 ià(
	`¡rchr
(
wh©
, 'L'))

336 
	`cŞËùv®idlšes
(
L
, 
ş
);

337 
	`lua_uÆock
(
L
);

338  
¡©us
;

339 
	}
}

348 cÚ¡ *
g‘objÇme
 (
PrÙo
 *
p
, 
Ï¡pc
, 
»g
,

349 cÚ¡ **
Çme
);

355 
	$kÇme
 (
PrÙo
 *
p
, 
pc
, 
c
, cÚ¡ **
Çme
) {

356 ià(
	`ISK
(
c
)) {

357 
TV®ue
 *
kv®ue
 = &
p
->
k
[
	`INDEXK
(
c
)];

358 ià(
	`‰is¡ršg
(
kv®ue
)) {

359 *
Çme
 = 
	`sv®ue
(
kv®ue
);

365 cÚ¡ *
wh©
 = 
	`g‘objÇme
(
p
, 
pc
, 
c
, 
Çme
);

366 ià(
wh©
 && *what == 'c') {

371 *
Çme
 = "?";

372 
	}
}

375 
	$f‹½c
 (
pc
, 
jm±¬g‘
) {

376 ià(
pc
 < 
jm±¬g‘
)

378  
pc
;

379 
	}
}

385 
	$fšd£Œeg
 (
PrÙo
 *
p
, 
Ï¡pc
, 
»g
) {

386 
pc
;

387 
£Œeg
 = -1;

388 
jm±¬g‘
 = 0;

389 
pc
 = 0;…ø< 
Ï¡pc
;…c++) {

390 
In¡ruùiÚ
 
i
 = 
p
->
code
[
pc
];

391 
OpCode
 
İ
 = 
	`GET_OPCODE
(
i
);

392 
a
 = 
	`GETARG_A
(
i
);

393 
İ
) {

394 
OP_LOADNIL
: {

395 
b
 = 
	`GETARG_B
(
i
);

396 ià(
a
 <ğ
»g
 &&„eg <ğ¨+ 
b
)

397 
£Œeg
 = 
	`f‹½c
(
pc
, 
jm±¬g‘
);

400 
OP_TFORCALL
: {

401 ià(
»g
 >ğ
a
 + 2)

402 
£Œeg
 = 
	`f‹½c
(
pc
, 
jm±¬g‘
);

405 
OP_CALL
:

406 
OP_TAILCALL
: {

407 ià(
»g
 >ğ
a
)

408 
£Œeg
 = 
	`f‹½c
(
pc
, 
jm±¬g‘
);

411 
OP_JMP
: {

412 
b
 = 
	`GETARG_sBx
(
i
);

413 
de¡
 = 
pc
 + 1 + 
b
;

415 ià(
pc
 < 
de¡
 && de¡ <ğ
Ï¡pc
) {

416 ià(
de¡
 > 
jm±¬g‘
)

417 
jm±¬g‘
 = 
de¡
;

422 ià(
	`‹¡AMode
(
İ
è&& 
»g
 =ğ
a
)

423 
£Œeg
 = 
	`f‹½c
(
pc
, 
jm±¬g‘
);

427  
£Œeg
;

428 
	}
}

431 cÚ¡ *
	$g‘objÇme
 (
PrÙo
 *
p
, 
Ï¡pc
, 
»g
,

432 cÚ¡ **
Çme
) {

433 
pc
;

434 *
Çme
 = 
	`luaF_g‘loÿÊame
(
p
, 
»g
 + 1, 
Ï¡pc
);

435 ià(*
Çme
)

438 
pc
 = 
	`fšd£Œeg
(
p
, 
Ï¡pc
, 
»g
);

439 ià(
pc
 != -1) {

440 
In¡ruùiÚ
 
i
 = 
p
->
code
[
pc
];

441 
OpCode
 
İ
 = 
	`GET_OPCODE
(
i
);

442 
İ
) {

443 
OP_MOVE
: {

444 
b
 = 
	`GETARG_B
(
i
);

445 ià(
b
 < 
	`GETARG_A
(
i
))

446  
	`g‘objÇme
(
p
, 
pc
, 
b
, 
Çme
);

449 
OP_GETTABUP
:

450 
OP_GETTABLE
: {

451 
k
 = 
	`GETARG_C
(
i
);

452 
t
 = 
	`GETARG_B
(
i
);

453 cÚ¡ *
vn
 = (
İ
 =ğ
OP_GETTABLE
)

454 ? 
	`luaF_g‘loÿÊame
(
p
, 
t
 + 1, 
pc
)

455 : 
	`upv®Çme
(
p
, 
t
);

456 
	`kÇme
(
p
, 
pc
, 
k
, 
Çme
);

457  (
vn
 && 
	`¡rcmp
(vn, 
LUA_ENV
) == 0) ? "global" : "field";

459 
OP_GETUPVAL
: {

460 *
Çme
 = 
	`upv®Çme
(
p
, 
	`GETARG_B
(
i
));

463 
OP_LOADK
:

464 
OP_LOADKX
: {

465 
b
 = (
İ
 =ğ
OP_LOADK
è? 
	`GETARG_Bx
(
i
)

466 : 
	`GETARG_Ax
(
p
->
code
[
pc
 + 1]);

467 ià(
	`‰is¡ršg
(&
p
->
k
[
b
])) {

468 *
Çme
 = 
	`sv®ue
(&
p
->
k
[
b
]);

473 
OP_SELF
: {

474 
k
 = 
	`GETARG_C
(
i
);

475 
	`kÇme
(
p
, 
pc
, 
k
, 
Çme
);

481  
NULL
;

482 
	}
}

491 cÚ¡ *
	$funúameäomcode
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
,

492 cÚ¡ **
Çme
) {

493 
TMS
 
tm
 = (TMS)0;

494 
PrÙo
 *
p
 = 
	`ci_func
(
ci
)->p;

495 
pc
 = 
	`cu¼’c
(
ci
);

496 
In¡ruùiÚ
 
i
 = 
p
->
code
[
pc
];

497 ià(
ci
->
ÿÎ¡©us
 & 
CIST_HOOKED
) {

498 *
Çme
 = "?";

501 
	`GET_OPCODE
(
i
)) {

502 
OP_CALL
:

503 
OP_TAILCALL
:

504  
	`g‘objÇme
(
p
, 
pc
, 
	`GETARG_A
(
i
), 
Çme
);

505 
OP_TFORCALL
: {

506 *
Çme
 = "for iterator";

510 
OP_SELF
: 
OP_GETTABUP
: 
OP_GETTABLE
:

511 
tm
 = 
TM_INDEX
;

513 
OP_SETTABUP
: 
OP_SETTABLE
:

514 
tm
 = 
TM_NEWINDEX
;

516 
OP_ADD
: 
OP_SUB
: 
OP_MUL
: 
OP_MOD
:

517 
OP_POW
: 
OP_DIV
: 
OP_IDIV
: 
OP_BAND
:

518 
OP_BOR
: 
OP_BXOR
: 
OP_SHL
: 
OP_SHR
: {

519 
off£t
 = 
	`ÿ¡_št
(
	`GET_OPCODE
(
i
)è- ca¡_št(
OP_ADD
);

520 
tm
 = 
	`ÿ¡
(
TMS
, 
off£t
 + 
	`ÿ¡_št
(
TM_ADD
));

523 
OP_UNM
: 
tm
 = 
TM_UNM
; ;

524 
OP_BNOT
: 
tm
 = 
TM_BNOT
; ;

525 
OP_LEN
: 
tm
 = 
TM_LEN
; ;

526 
OP_CONCAT
: 
tm
 = 
TM_CONCAT
; ;

527 
OP_EQ
: 
tm
 = 
TM_EQ
; ;

528 
OP_LT
: 
tm
 = 
TM_LT
; ;

529 
OP_LE
: 
tm
 = 
TM_LE
; ;

531  
NULL
;

533 *
Çme
 = 
	`g‘¡r
(
	`G
(
L
)->
tmÇme
[
tm
]);

535 
	}
}

546 
	$isš¡ack
 (
C®lInfo
 *
ci
, cÚ¡ 
TV®ue
 *
o
) {

547 
±rdiff_t
 
i
 = 
o
 - 
ci
->
u
.
l
.
ba£
;

548  (0 <ğ
i
 && i < (
ci
->
tİ
 - ci->
u
.
l
.
ba£
è&& ci->u.l.ba£ + i =ğ
o
);

549 
	}
}

557 cÚ¡ *
	$g‘upv®Çme
 (
C®lInfo
 *
ci
, cÚ¡ 
TV®ue
 *
o
,

558 cÚ¡ **
Çme
) {

559 
LClosu»
 *
c
 = 
	`ci_func
(
ci
);

560 
i
;

561 
i
 = 0; i < 
c
->
nupv®ues
; i++) {

562 ià(
c
->
upv®s
[
i
]->
v
 =ğ
o
) {

563 *
Çme
 = 
	`upv®Çme
(
c
->
p
, 
i
);

567  
NULL
;

568 
	}
}

571 cÚ¡ *
	$v¬šfo
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
o
) {

572 cÚ¡ *
Çme
 = 
NULL
;

573 
C®lInfo
 *
ci
 = 
L
->ci;

574 cÚ¡ *
kšd
 = 
NULL
;

575 ià(
	`isLua
(
ci
)) {

576 
kšd
 = 
	`g‘upv®Çme
(
ci
, 
o
, &
Çme
);

577 ià(!
kšd
 && 
	`isš¡ack
(
ci
, 
o
))

578 
kšd
 = 
	`g‘objÇme
(
	`ci_func
(
ci
)->
p
, 
	`cu¼’c
(ci),

579 
	`ÿ¡_št
(
o
 - 
ci
->
u
.
l
.
ba£
), &
Çme
);

581  (
kšd
è? 
	`luaO_pushf¡ršg
(
L
, " (% '%s')", kšd, 
Çme
) : "";

582 
	}
}

585 
l_nÜ‘
 
	$luaG_ty³”rÜ
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
o
, cÚ¡ *
İ
) {

586 cÚ¡ *
t
 = 
	`luaT_objty³Çme
(
L
, 
o
);

587 
	`luaG_ruÃ¼Ü
(
L
, "©‹m±Ø% ¨% v®ue%s", 
İ
, 
t
, 
	`v¬šfo
(L, 
o
));

588 
	}
}

591 
l_nÜ‘
 
	$luaG_cÚÿ‹¼Ü
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
) {

592 ià(
	`‰is¡ršg
(
p1
è|| 
	`cvt2¡r
Õ1)èp1 = 
p2
;

593 
	`luaG_ty³”rÜ
(
L
, 
p1
, "concatenate");

594 
	}
}

597 
l_nÜ‘
 
	$luaG_İš‹¼Ü
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
,

598 cÚ¡ 
TV®ue
 *
p2
, cÚ¡ *
msg
) {

599 
lua_Numb”
 
‹mp
;

600 ià(!
	`tÚumb”
(
p1
, &
‹mp
))

601 
p2
 = 
p1
;

602 
	`luaG_ty³”rÜ
(
L
, 
p2
, 
msg
);

603 
	}
}

609 
l_nÜ‘
 
	$luaG_toš‹¼Ü
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
) {

610 
lua_IÁeg”
 
‹mp
;

611 ià(!
	`toš‹g”
(
p1
, &
‹mp
))

612 
p2
 = 
p1
;

613 
	`luaG_ruÃ¼Ü
(
L
, "numb”% ha nØš‹g”„•»£Á©iÚ", 
	`v¬šfo
(L, 
p2
));

614 
	}
}

617 
l_nÜ‘
 
	$luaG_Üd””rÜ
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
) {

618 cÚ¡ *
t1
 = 
	`luaT_objty³Çme
(
L
, 
p1
);

619 cÚ¡ *
t2
 = 
	`luaT_objty³Çme
(
L
, 
p2
);

620 ià(
	`¡rcmp
(
t1
, 
t2
) == 0)

621 
	`luaG_ruÃ¼Ü
(
L
, "©‹m±Øcom·»wØ% v®ues", 
t1
);

623 
	`luaG_ruÃ¼Ü
(
L
, "©‹m±Øcom·» % w™h %s", 
t1
, 
t2
);

624 
	}
}

628 cÚ¡ *
	$luaG_addšfo
 (
lua_S‹
 *
L
, cÚ¡ *
msg
, 
TSŒšg
 *
¤c
,

629 
lše
) {

630 
buff
[
LUA_IDSIZE
];

631 ià(
¤c
)

632 
	`luaO_chunkid
(
buff
, 
	`g‘¡r
(
¤c
), 
LUA_IDSIZE
);

634 
buff
[0] = '?'; buff[1] = '\0';

636  
	`luaO_pushf¡ršg
(
L
, "%s:%d: %s", 
buff
, 
lše
, 
msg
);

637 
	}
}

640 
l_nÜ‘
 
	$luaG_”rÜmsg
 (
lua_S‹
 *
L
) {

641 ià(
L
->
”rfunc
 != 0) {

642 
StkId
 
”rfunc
 = 
	`»¡Üe¡ack
(
L
, L->errfunc);

643 
	`£tobjs2s
(
L
, L->
tİ
, L->top - 1);

644 
	`£tobjs2s
(
L
, L->
tİ
 - 1, 
”rfunc
);

645 
L
->
tİ
++;

646 
	`luaD_ÿÎnoy›ld
(
L
, L->
tİ
 - 2, 1);

648 
	`luaD_throw
(
L
, 
LUA_ERRRUN
);

649 
	}
}

652 
l_nÜ‘
 
	$luaG_ruÃ¼Ü
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...) {

653 
C®lInfo
 *
ci
 = 
L
->ci;

654 cÚ¡ *
msg
;

655 
va_li¡
 
¬gp
;

656 
	`va_¡¬t
(
¬gp
, 
fmt
);

657 
msg
 = 
	`luaO_pushvf¡ršg
(
L
, 
fmt
, 
¬gp
);

658 
	`va_’d
(
¬gp
);

659 ià(
	`isLua
(
ci
))

660 
	`luaG_addšfo
(
L
, 
msg
, 
	`ci_func
(
ci
)->
p
->
sourû
, 
	`cu¼’še
(ci));

661 
	`luaG_”rÜmsg
(
L
);

662 
	}
}

665 
	$luaG_Œaûexec
 (
lua_S‹
 *
L
) {

666 
C®lInfo
 *
ci
 = 
L
->ci;

667 
lu_by‹
 
mask
 = 
L
->
hookmask
;

668 
couÁhook
 = (--
L
->
hookcouÁ
 =ğ0 && (
mask
 & 
LUA_MASKCOUNT
));

669 ià(
couÁhook
)

670 
	`»£thookcouÁ
(
L
);

671 ià(!(
mask
 & 
LUA_MASKLINE
))

673 ià(
ci
->
ÿÎ¡©us
 & 
CIST_HOOKYIELD
) {

674 
ci
->
ÿÎ¡©us
 &ğ~
CIST_HOOKYIELD
;

677 ià(
couÁhook
)

678 
	`luaD_hook
(
L
, 
LUA_HOOKCOUNT
, -1);

679 ià(
mask
 & 
LUA_MASKLINE
) {

680 
PrÙo
 *
p
 = 
	`ci_func
(
ci
)->p;

681 
Åc
 = 
	`pcR–
(
ci
->
u
.
l
.
§vedpc
, 
p
);

682 
Ãwlše
 = 
	`g‘funşše
(
p
, 
Åc
);

683 ià(
Åc
 == 0 ||

684 
ci
->
u
.
l
.
§vedpc
 <ğ
L
->
Şdpc
 ||

685 
Ãwlše
 !ğ
	`g‘funşše
(
p
, 
	`pcR–
(
L
->
Şdpc
,…)))

686 
	`luaD_hook
(
L
, 
LUA_HOOKLINE
, 
Ãwlše
);

688 
L
->
Şdpc
 = 
ci
->
u
.
l
.
§vedpc
;

689 ià(
L
->
¡©us
 =ğ
LUA_YIELD
) {

690 ià(
couÁhook
)

691 
L
->
hookcouÁ
 = 1;

692 
ci
->
u
.
l
.
§vedpc
--;

693 
ci
->
ÿÎ¡©us
 |ğ
CIST_HOOKYIELD
;

694 
ci
->
func
 = 
L
->
tİ
 - 1;

695 
	`luaD_throw
(
L
, 
LUA_YIELD
);

697 
	}
}

	@script/lua/lua-5.3.4/src/ldebug.h

7 #iâdeà
ldebug_h


8 
	#ldebug_h


	)

11 
	~"l¡©e.h
"

14 
	#pcR–
(
pc
, 
p
è(
	`ÿ¡
(, (pcè- (p)->
code
è- 1)

	)

16 
	#g‘funşše
(
f
,
pc
è(((f)->
lšešfo
è? (f)->lšešfo[pc] : -1)

	)

18 
	#»£thookcouÁ
(
L
è(L->
hookcouÁ
 = L->
ba£hookcouÁ
)

	)

21 
LUAI_FUNC
 
l_nÜ‘
 
luaG_ty³”rÜ
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
o
,

22 cÚ¡ *
İÇme
);

23 
LUAI_FUNC
 
l_nÜ‘
 
luaG_cÚÿ‹¼Ü
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
,

24 cÚ¡ 
TV®ue
 *
p2
);

25 
LUAI_FUNC
 
l_nÜ‘
 
luaG_İš‹¼Ü
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
,

26 cÚ¡ 
TV®ue
 *
p2
,

27 cÚ¡ *
msg
);

28 
LUAI_FUNC
 
l_nÜ‘
 
luaG_toš‹¼Ü
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
,

29 cÚ¡ 
TV®ue
 *
p2
);

30 
LUAI_FUNC
 
l_nÜ‘
 
luaG_Üd””rÜ
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
,

31 cÚ¡ 
TV®ue
 *
p2
);

32 
LUAI_FUNC
 
l_nÜ‘
 
luaG_ruÃ¼Ü
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...);

33 
LUAI_FUNC
 cÚ¡ *
luaG_addšfo
 (
lua_S‹
 *
L
, cÚ¡ *
msg
,

34 
TSŒšg
 *
¤c
, 
lše
);

35 
LUAI_FUNC
 
l_nÜ‘
 
luaG_”rÜmsg
 (
lua_S‹
 *
L
);

36 
LUAI_FUNC
 
luaG_Œaûexec
 (
lua_S‹
 *
L
);

	@script/lua/lua-5.3.4/src/ldo.c

7 
	#ldo_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<£tjmp.h
>

14 
	~<¡dlib.h
>

15 
	~<¡ršg.h
>

17 
	~"lua.h
"

19 
	~"Ïpi.h
"

20 
	~"ldebug.h
"

21 
	~"ldo.h
"

22 
	~"lfunc.h
"

23 
	~"lgc.h
"

24 
	~"lmem.h
"

25 
	~"lobjeù.h
"

26 
	~"lİcodes.h
"

27 
	~"Í¬£r.h
"

28 
	~"l¡©e.h
"

29 
	~"l¡ršg.h
"

30 
	~"ÉabË.h
"

31 
	~"Ém.h
"

32 
	~"lundump.h
"

33 
	~"lvm.h
"

34 
	~"lzio.h
"

38 
	#”rÜ¡©us
(
s
è((sè> 
LUA_YIELD
)

	)

53 #ià!
defšed
(
LUAI_THROW
)

55 #ià
defšed
(
__ılu¥lus
è&& !defšed(
LUA_USE_LONGJMP
)

58 
	#LUAI_THROW
(
L
,
c
è
	`throw
(c)

	)

59 
	#LUAI_TRY
(
L
,
c
,
a
) \

60 
Œy
 { 
a
 } 
	`ÿtch
(...è{ ià((
c
)->
¡©us
 =ğ0è(c)->¡©u ğ-1; }

	)

61 
	#luai_jmpbuf
 

	)

63 #–ià
defšed
(
LUA_USE_POSIX
)

66 
	#LUAI_THROW
(
L
,
c
è
	`_lÚgjmp
((c)->
b
, 1)

	)

67 
	#LUAI_TRY
(
L
,
c
,
a
èià(
	`_£tjmp
((c)->
b
è=ğ0è{‡ }

	)

68 
	#luai_jmpbuf
 
jmp_buf


	)

73 
	#LUAI_THROW
(
L
,
c
è
	`lÚgjmp
((c)->
b
, 1)

	)

74 
	#LUAI_TRY
(
L
,
c
,
a
èià(
	`£tjmp
((c)->
b
è=ğ0è{‡ }

	)

75 
	#luai_jmpbuf
 
jmp_buf


	)

84 
	slua_lÚgjmp
 {

85 
lua_lÚgjmp
 *
	m´evious
;

86 
luai_jmpbuf
 
	mb
;

87 vŞ©
	m¡©us
;

91 
	$£‹¼Üobj
 (
lua_S‹
 *
L
, 
”rcode
, 
StkId
 
Şdtİ
) {

92 
”rcode
) {

93 
LUA_ERRMEM
: {

94 
	`£tsv®ue2s
(
L
, 
Şdtİ
, 
	`G
(L)->
mem”rmsg
);

97 
LUA_ERRERR
: {

98 
	`£tsv®ue2s
(
L
, 
Şdtİ
, 
	`luaS_Ãwl™”®
(L, "error inƒrror handling"));

102 
	`£tobjs2s
(
L
, 
Şdtİ
, L->
tİ
 - 1);

106 
L
->
tİ
 = 
Şdtİ
 + 1;

107 
	}
}

110 
l_nÜ‘
 
	$luaD_throw
 (
lua_S‹
 *
L
, 
”rcode
) {

111 ià(
L
->
”rÜJmp
) {

112 
L
->
”rÜJmp
->
¡©us
 = 
”rcode
;

113 
	`LUAI_THROW
(
L
, L->
”rÜJmp
);

116 
glob®_S‹
 *
g
 = 
	`G
(
L
);

117 
L
->
¡©us
 = 
	`ÿ¡_by‹
(
”rcode
);

118 ià(
g
->
mašth»ad
->
”rÜJmp
) {

119 
	`£tobjs2s
(
L
, 
g
->
mašth»ad
->
tİ
++, L->top - 1);

120 
	`luaD_throw
(
g
->
mašth»ad
, 
”rcode
);

123 ià(
g
->
·nic
) {

124 
	`£‹¼Üobj
(
L
, 
”rcode
, L->
tİ
);

125 ià(
L
->
ci
->
tİ
 < L->top)

126 
L
->
ci
->
tİ
 = L->top;

127 
	`lua_uÆock
(
L
);

128 
g
->
	`·nic
(
L
);

130 
	`abÜt
();

133 
	}
}

136 
	$luaD_¿wruÅrÙeùed
 (
lua_S‹
 *
L
, 
Pfunc
 
f
, *
ud
) {

137 
ŞdnCÿÎs
 = 
L
->
nCÿÎs
;

138 
lua_lÚgjmp
 
lj
;

139 
lj
.
¡©us
 = 
LUA_OK
;

140 
lj
.
´evious
 = 
L
->
”rÜJmp
;

141 
L
->
”rÜJmp
 = &
lj
;

142 
	`LUAI_TRY
(
L
, &
lj
,

143 (*
f
)(
L
, 
ud
);

145 
L
->
”rÜJmp
 = 
lj
.
´evious
;

146 
L
->
nCÿÎs
 = 
ŞdnCÿÎs
;

147  
lj
.
¡©us
;

148 
	}
}

158 
	$cÜ»ù¡ack
 (
lua_S‹
 *
L
, 
TV®ue
 *
Şd¡ack
) {

159 
C®lInfo
 *
ci
;

160 
UpV®
 *
up
;

161 
L
->
tİ
 = (L->tİ - 
Şd¡ack
è+ L->
¡ack
;

162 
up
 = 
L
->
İ’upv®
; u°!ğ
NULL
; u°ğup->
u
.
İ’
.
Ãxt
)

163 
up
->
v
 = (up->v - 
Şd¡ack
è+ 
L
->
¡ack
;

164 
ci
 = 
L
->ci; c˜!ğ
NULL
; c˜ğci->
´evious
) {

165 
ci
->
tİ
 = (ci->tİ - 
Şd¡ack
è+ 
L
->
¡ack
;

166 
ci
->
func
 = (ci->funø- 
Şd¡ack
è+ 
L
->
¡ack
;

167 ià(
	`isLua
(
ci
))

168 
ci
->
u
.
l
.
ba£
 = (ci->u.l.ba£ - 
Şd¡ack
è+ 
L
->
¡ack
;

170 
	}
}

174 
	#ERRORSTACKSIZE
 (
LUAI_MAXSTACK
 + 200)

	)

177 
	$luaD_»®loc¡ack
 (
lua_S‹
 *
L
, 
Ãwsize
) {

178 
TV®ue
 *
Şd¡ack
 = 
L
->
¡ack
;

179 
lim
 = 
L
->
¡acksize
;

180 
	`lua_as£¹
(
Ãwsize
 <ğ
LUAI_MAXSTACK
 ||‚ewsiz=ğ
ERRORSTACKSIZE
);

181 
	`lua_as£¹
(
L
->
¡ack_Ï¡
 - L->
¡ack
 =ğL->
¡acksize
 - 
EXTRA_STACK
);

182 
	`luaM_»®locveùÜ
(
L
, L->
¡ack
, L->
¡acksize
, 
Ãwsize
, 
TV®ue
);

183 ; 
lim
 < 
Ãwsize
;†im++)

184 
	`£Šv®ue
(
L
->
¡ack
 + 
lim
);

185 
L
->
¡acksize
 = 
Ãwsize
;

186 
L
->
¡ack_Ï¡
 = L->
¡ack
 + 
Ãwsize
 - 
EXTRA_STACK
;

187 
	`cÜ»ù¡ack
(
L
, 
Şd¡ack
);

188 
	}
}

191 
	$luaD_grow¡ack
 (
lua_S‹
 *
L
, 
n
) {

192 
size
 = 
L
->
¡acksize
;

193 ià(
size
 > 
LUAI_MAXSTACK
)

194 
	`luaD_throw
(
L
, 
LUA_ERRERR
);

196 
Ãeded
 = 
	`ÿ¡_št
(
L
->
tİ
 - L->
¡ack
è+ 
n
 + 
EXTRA_STACK
;

197 
Ãwsize
 = 2 * 
size
;

198 ià(
Ãwsize
 > 
LUAI_MAXSTACK
)‚ewsize = LUAI_MAXSTACK;

199 ià(
Ãwsize
 < 
Ãeded
)‚ewsize =‚eeded;

200 ià(
Ãwsize
 > 
LUAI_MAXSTACK
) {

201 
	`luaD_»®loc¡ack
(
L
, 
ERRORSTACKSIZE
);

202 
	`luaG_ruÃ¼Ü
(
L
, "stack overflow");

205 
	`luaD_»®loc¡ack
(
L
, 
Ãwsize
);

207 
	}
}

210 
	$¡ackšu£
 (
lua_S‹
 *
L
) {

211 
C®lInfo
 *
ci
;

212 
StkId
 
lim
 = 
L
->
tİ
;

213 
ci
 = 
L
->ci; c˜!ğ
NULL
; c˜ğci->
´evious
) {

214 ià(
lim
 < 
ci
->
tİ
)†im = ci->top;

216 
	`lua_as£¹
(
lim
 <ğ
L
->
¡ack_Ï¡
);

217  
	`ÿ¡_št
(
lim
 - 
L
->
¡ack
) + 1;

218 
	}
}

221 
	$luaD_shršk¡ack
 (
lua_S‹
 *
L
) {

222 
šu£
 = 
	`¡ackšu£
(
L
);

223 
goodsize
 = 
šu£
 + (šu£ / 8è+ 2*
EXTRA_STACK
;

224 ià(
goodsize
 > 
LUAI_MAXSTACK
)

225 
goodsize
 = 
LUAI_MAXSTACK
;

226 ià(
L
->
¡acksize
 > 
LUAI_MAXSTACK
)

227 
	`luaE_ä“CI
(
L
);

229 
	`luaE_shrškCI
(
L
);

232 ià(
šu£
 <ğ(
LUAI_MAXSTACK
 - 
EXTRA_STACK
) &&

233 
goodsize
 < 
L
->
¡acksize
)

234 
	`luaD_»®loc¡ack
(
L
, 
goodsize
);

236 
	`cÚdmove¡ack
(
L
,{},{});

237 
	}
}

240 
	$luaD_šùİ
 (
lua_S‹
 *
L
) {

241 
	`luaD_check¡ack
(
L
, 1);

242 
L
->
tİ
++;

243 
	}
}

253 
	$luaD_hook
 (
lua_S‹
 *
L
, 
ev’t
, 
lše
) {

254 
lua_Hook
 
hook
 = 
L
->hook;

255 ià(
hook
 && 
L
->
®lowhook
) {

256 
C®lInfo
 *
ci
 = 
L
->ci;

257 
±rdiff_t
 
tİ
 = 
	`§ve¡ack
(
L
, L->top);

258 
±rdiff_t
 
ci_tİ
 = 
	`§ve¡ack
(
L
, 
ci
->
tİ
);

259 
lua_Debug
 
¬
;

260 
¬
.
ev’t
 =ƒvent;

261 
¬
.
cu¼’še
 = 
lše
;

262 
¬
.
i_ci
 = 
ci
;

263 
	`luaD_check¡ack
(
L
, 
LUA_MINSTACK
);

264 
ci
->
tİ
 = 
L
->tİ + 
LUA_MINSTACK
;

265 
	`lua_as£¹
(
ci
->
tİ
 <ğ
L
->
¡ack_Ï¡
);

266 
L
->
®lowhook
 = 0;

267 
ci
->
ÿÎ¡©us
 |ğ
CIST_HOOKED
;

268 
	`lua_uÆock
(
L
);

269 (*
hook
)(
L
, &
¬
);

270 
	`lua_lock
(
L
);

271 
	`lua_as£¹
(!
L
->
®lowhook
);

272 
L
->
®lowhook
 = 1;

273 
ci
->
tİ
 = 
	`»¡Üe¡ack
(
L
, 
ci_tİ
);

274 
L
->
tİ
 = 
	`»¡Üe¡ack
(L,op);

275 
ci
->
ÿÎ¡©us
 &ğ~
CIST_HOOKED
;

277 
	}
}

280 
	$ÿÎhook
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
) {

281 
hook
 = 
LUA_HOOKCALL
;

282 
ci
->
u
.
l
.
§vedpc
++;

283 ià(
	`isLua
(
ci
->
´evious
) &&

284 
	`GET_OPCODE
(*(
ci
->
´evious
->
u
.
l
.
§vedpc
 - 1)è=ğ
OP_TAILCALL
) {

285 
ci
->
ÿÎ¡©us
 |ğ
CIST_TAIL
;

286 
hook
 = 
LUA_HOOKTAILCALL
;

288 
	`luaD_hook
(
L
, 
hook
, -1);

289 
ci
->
u
.
l
.
§vedpc
--;

290 
	}
}

293 
StkId
 
	$adju¡_v¬¬gs
 (
lua_S‹
 *
L
, 
PrÙo
 *
p
, 
aùu®
) {

294 
i
;

295 
nfix¬gs
 = 
p
->
num·¿ms
;

296 
StkId
 
ba£
, 
fixed
;

298 
fixed
 = 
L
->
tİ
 - 
aùu®
;

299 
ba£
 = 
L
->
tİ
;

300 
i
 = 0; i < 
nfix¬gs
 && i < 
aùu®
; i++) {

301 
	`£tobjs2s
(
L
, L->
tİ
++, 
fixed
 + 
i
);

302 
	`£Šv®ue
(
fixed
 + 
i
);

304 ; 
i
 < 
nfix¬gs
; i++)

305 
	`£Šv®ue
(
L
->
tİ
++);

306  
ba£
;

307 
	}
}

315 
	$ŒyfuncTM
 (
lua_S‹
 *
L
, 
StkId
 
func
) {

316 cÚ¡ 
TV®ue
 *
tm
 = 
	`luaT_g‘tmbyobj
(
L
, 
func
, 
TM_CALL
);

317 
StkId
 
p
;

318 ià(!
	`‰isfunùiÚ
(
tm
))

319 
	`luaG_ty³”rÜ
(
L
, 
func
, "call");

321 
p
 = 
L
->
tİ
;… > 
func
;…--)

322 
	`£tobjs2s
(
L
, 
p
,…-1);

323 
L
->
tİ
++;

324 
	`£tobj2s
(
L
, 
func
, 
tm
);

325 
	}
}

334 
	$mov”esuÉs
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
fœ¡ResuÉ
, 
StkId
 
»s
,

335 
Äes
, 
wª‹d
) {

336 
wª‹d
) {

339 ià(
Äes
 == 0)

340 
fœ¡ResuÉ
 = 
luaO_nobjeù
;

341 
	`£tobjs2s
(
L
, 
»s
, 
fœ¡ResuÉ
);

344 
LUA_MULTRET
: {

345 
i
;

346 
i
 = 0; i < 
Äes
; i++)

347 
	`£tobjs2s
(
L
, 
»s
 + 
i
, 
fœ¡ResuÉ
 + i);

348 
L
->
tİ
 = 
»s
 + 
Äes
;

352 
i
;

353 ià(
wª‹d
 <ğ
Äes
) {

354 
i
 = 0; i < 
wª‹d
; i++)

355 
	`£tobjs2s
(
L
, 
»s
 + 
i
, 
fœ¡ResuÉ
 + i);

358 
i
 = 0; i < 
Äes
; i++)

359 
	`£tobjs2s
(
L
, 
»s
 + 
i
, 
fœ¡ResuÉ
 + i);

360 ; 
i
 < 
wª‹d
; i++)

361 
	`£Šv®ue
(
»s
 + 
i
);

366 
L
->
tİ
 = 
»s
 + 
wª‹d
;

368 
	}
}

376 
	$luaD_posÿÎ
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
, 
StkId
 
fœ¡ResuÉ
, 
Äes
) {

377 
StkId
 
»s
;

378 
wª‹d
 = 
ci
->
ÄesuÉs
;

379 ià(
L
->
hookmask
 & (
LUA_MASKRET
 | 
LUA_MASKLINE
)) {

380 ià(
L
->
hookmask
 & 
LUA_MASKRET
) {

381 
±rdiff_t
 
ä
 = 
	`§ve¡ack
(
L
, 
fœ¡ResuÉ
);

382 
	`luaD_hook
(
L
, 
LUA_HOOKRET
, -1);

383 
fœ¡ResuÉ
 = 
	`»¡Üe¡ack
(
L
, 
ä
);

385 
L
->
Şdpc
 = 
ci
->
´evious
->
u
.
l
.
§vedpc
;

387 
»s
 = 
ci
->
func
;

388 
L
->
ci
 = ci->
´evious
;

390  
	`mov”esuÉs
(
L
, 
fœ¡ResuÉ
, 
»s
, 
Äes
, 
wª‹d
);

391 
	}
}

395 
	#Ãxt_ci
(
L
è(L->
ci
 = (L->ci->
Ãxt
 ? L->ci->Ãxˆ: 
	`luaE_ex‹ndCI
(L)))

	)

399 
	#check¡ackp
(
L
,
n
,
p
) \

400 
	`luaD_check¡ackaux
(
L
, 
n
, \

401 
±rdiff_t
 
t__
 = 
	`§ve¡ack
(
L
, 
p
); \

402 
	`luaC_checkGC
(
L
), \

403 
p
 = 
	`»¡Üe¡ack
(
L
, 
t__
)è

	)

413 
	$luaD_´eÿÎ
 (
lua_S‹
 *
L
, 
StkId
 
func
, 
ÄesuÉs
) {

414 
lua_CFunùiÚ
 
f
;

415 
C®lInfo
 *
ci
;

416 
	`‰y³
(
func
)) {

417 
LUA_TCCL
:

418 
f
 = 
	`şCv®ue
(
func
)->f;

419 
Cfunc
;

420 
LUA_TLCF
:

421 
f
 = 
	`fv®ue
(
func
);

422 
Cfunc
: {

423 
n
;

424 
	`check¡ackp
(
L
, 
LUA_MINSTACK
, 
func
);

425 
ci
 = 
	`Ãxt_ci
(
L
);

426 
ci
->
ÄesuÉs
 =‚results;

427 
ci
->
func
 = func;

428 
ci
->
tİ
 = 
L
->tİ + 
LUA_MINSTACK
;

429 
	`lua_as£¹
(
ci
->
tİ
 <ğ
L
->
¡ack_Ï¡
);

430 
ci
->
ÿÎ¡©us
 = 0;

431 ià(
L
->
hookmask
 & 
LUA_MASKCALL
)

432 
	`luaD_hook
(
L
, 
LUA_HOOKCALL
, -1);

433 
	`lua_uÆock
(
L
);

434 
n
 = (*
f
)(
L
);

435 
	`lua_lock
(
L
);

436 
	`­i_checkÃËms
(
L
, 
n
);

437 
	`luaD_posÿÎ
(
L
, 
ci
, L->
tİ
 - 
n
,‚);

440 
LUA_TLCL
: {

441 
StkId
 
ba£
;

442 
PrÙo
 *
p
 = 
	`şLv®ue
(
func
)->p;

443 
n
 = 
	`ÿ¡_št
(
L
->
tİ
 - 
func
) - 1;

444 
fsize
 = 
p
->
max¡acksize
;

445 
	`check¡ackp
(
L
, 
fsize
, 
func
);

446 ià(
p
->
is_v¬¬g
)

447 
ba£
 = 
	`adju¡_v¬¬gs
(
L
, 
p
, 
n
);

449 ; 
n
 < 
p
->
num·¿ms
;‚++)

450 
	`£Šv®ue
(
L
->
tİ
++);

451 
ba£
 = 
func
 + 1;

453 
ci
 = 
	`Ãxt_ci
(
L
);

454 
ci
->
ÄesuÉs
 =‚results;

455 
ci
->
func
 = func;

456 
ci
->
u
.
l
.
ba£
 = base;

457 
L
->
tİ
 = 
ci
->tİ = 
ba£
 + 
fsize
;

458 
	`lua_as£¹
(
ci
->
tİ
 <ğ
L
->
¡ack_Ï¡
);

459 
ci
->
u
.
l
.
§vedpc
 = 
p
->
code
;

460 
ci
->
ÿÎ¡©us
 = 
CIST_LUA
;

461 ià(
L
->
hookmask
 & 
LUA_MASKCALL
)

462 
	`ÿÎhook
(
L
, 
ci
);

466 
	`check¡ackp
(
L
, 1, 
func
);

467 
	`ŒyfuncTM
(
L
, 
func
);

468  
	`luaD_´eÿÎ
(
L
, 
func
, 
ÄesuÉs
);

471 
	}
}

481 
	$¡ack”rÜ
 (
lua_S‹
 *
L
) {

482 ià(
L
->
nCÿÎs
 =ğ
LUAI_MAXCCALLS
)

483 
	`luaG_ruÃ¼Ü
(
L
, "C stack overflow");

484 ià(
L
->
nCÿÎs
 >ğ(
LUAI_MAXCCALLS
 + (LUAI_MAXCCALLS>>3)))

485 
	`luaD_throw
(
L
, 
LUA_ERRERR
);

486 
	}
}

495 
	$luaD_ÿÎ
 (
lua_S‹
 *
L
, 
StkId
 
func
, 
nResuÉs
) {

496 ià(++
L
->
nCÿÎs
 >ğ
LUAI_MAXCCALLS
)

497 
	`¡ack”rÜ
(
L
);

498 ià(!
	`luaD_´eÿÎ
(
L
, 
func
, 
nResuÉs
))

499 
	`luaV_execu‹
(
L
);

500 
L
->
nCÿÎs
--;

501 
	}
}

507 
	$luaD_ÿÎnoy›ld
 (
lua_S‹
 *
L
, 
StkId
 
func
, 
nResuÉs
) {

508 
L
->
Ây
++;

509 
	`luaD_ÿÎ
(
L
, 
func
, 
nResuÉs
);

510 
L
->
Ây
--;

511 
	}
}

518 
	$fšishCÿÎ
 (
lua_S‹
 *
L
, 
¡©us
) {

519 
C®lInfo
 *
ci
 = 
L
->ci;

520 
n
;

522 
	`lua_as£¹
(
ci
->
u
.
c
.
k
 !ğ
NULL
 && 
L
->
Ây
 == 0);

524 
	`lua_as£¹
((
ci
->
ÿÎ¡©us
 & 
CIST_YPCALL
è|| 
¡©us
 =ğ
LUA_YIELD
);

525 ià(
ci
->
ÿÎ¡©us
 & 
CIST_YPCALL
) {

526 
ci
->
ÿÎ¡©us
 &ğ~
CIST_YPCALL
;

527 
L
->
”rfunc
 = 
ci
->
u
.
c
.
Şd_”rfunc
;

531 
	`adju¡»suÉs
(
L
, 
ci
->
ÄesuÉs
);

532 
	`lua_uÆock
(
L
);

533 
n
 = (*
ci
->
u
.
c
.
k
)(
L
, 
¡©us
, ci->u.c.
ùx
);

534 
	`lua_lock
(
L
);

535 
	`­i_checkÃËms
(
L
, 
n
);

536 
	`luaD_posÿÎ
(
L
, 
ci
, L->
tİ
 - 
n
,‚);

537 
	}
}

548 
	$uÄŞl
 (
lua_S‹
 *
L
, *
ud
) {

549 ià(
ud
 !ğ
NULL
)

550 
	`fšishCÿÎ
(
L
, *(*)
ud
);

551 
L
->
ci
 !ğ&L->
ba£_ci
) {

552 ià(!
	`isLua
(
L
->
ci
))

553 
	`fšishCÿÎ
(
L
, 
LUA_YIELD
);

555 
	`luaV_fšishOp
(
L
);

556 
	`luaV_execu‹
(
L
);

559 
	}
}

566 
C®lInfo
 *
	$fšdpÿÎ
 (
lua_S‹
 *
L
) {

567 
C®lInfo
 *
ci
;

568 
ci
 = 
L
->ci; c˜!ğ
NULL
; c˜ğci->
´evious
) {

569 ià(
ci
->
ÿÎ¡©us
 & 
CIST_YPCALL
)

570  
ci
;

572  
NULL
;

573 
	}
}

581 
	$»cov”
 (
lua_S‹
 *
L
, 
¡©us
) {

582 
StkId
 
Şdtİ
;

583 
C®lInfo
 *
ci
 = 
	`fšdpÿÎ
(
L
);

584 ià(
ci
 =ğ
NULL
)  0;

586 
Şdtİ
 = 
	`»¡Üe¡ack
(
L
, 
ci
->
exŒa
);

587 
	`luaF_şo£
(
L
, 
Şdtİ
);

588 
	`£‹¼Üobj
(
L
, 
¡©us
, 
Şdtİ
);

589 
L
->
ci
 = ci;

590 
L
->
®lowhook
 = 
	`g‘ßh
(
ci
->
ÿÎ¡©us
);

591 
L
->
Ây
 = 0;

592 
	`luaD_shršk¡ack
(
L
);

593 
L
->
”rfunc
 = 
ci
->
u
.
c
.
Şd_”rfunc
;

595 
	}
}

603 
	$»sume_”rÜ
 (
lua_S‹
 *
L
, cÚ¡ *
msg
, 
Çrg
) {

604 
L
->
tİ
 -ğ
Çrg
;

605 
	`£tsv®ue2s
(
L
, L->
tİ
, 
	`luaS_Ãw
(L, 
msg
));

606 
	`­i_šü_tİ
(
L
);

607 
	`lua_uÆock
(
L
);

608  
LUA_ERRRUN
;

609 
	}
}

619 
	$»sume
 (
lua_S‹
 *
L
, *
ud
) {

620 
n
 = *(
	`ÿ¡
(*, 
ud
));

621 
StkId
 
fœ¡Arg
 = 
L
->
tİ
 - 
n
;

622 
C®lInfo
 *
ci
 = 
L
->ci;

623 ià(
L
->
¡©us
 =ğ
LUA_OK
) {

624 ià(!
	`luaD_´eÿÎ
(
L
, 
fœ¡Arg
 - 1, 
LUA_MULTRET
))

625 
	`luaV_execu‹
(
L
);

628 
	`lua_as£¹
(
L
->
¡©us
 =ğ
LUA_YIELD
);

629 
L
->
¡©us
 = 
LUA_OK
;

630 
ci
->
func
 = 
	`»¡Üe¡ack
(
L
, ci->
exŒa
);

631 ià(
	`isLua
(
ci
))

632 
	`luaV_execu‹
(
L
);

634 ià(
ci
->
u
.
c
.
k
 !ğ
NULL
) {

635 
	`lua_uÆock
(
L
);

636 
n
 = (*
ci
->
u
.
c
.
k
)(
L
, 
LUA_YIELD
, ci->u.c.
ùx
);

637 
	`lua_lock
(
L
);

638 
	`­i_checkÃËms
(
L
, 
n
);

639 
fœ¡Arg
 = 
L
->
tİ
 - 
n
;

641 
	`luaD_posÿÎ
(
L
, 
ci
, 
fœ¡Arg
, 
n
);

643 
	`uÄŞl
(
L
, 
NULL
);

645 
	}
}

648 
LUA_API
 
	$lua_»sume
 (
lua_S‹
 *
L
,†ua_S‹ *
äom
, 
Çrgs
) {

649 
¡©us
;

650 
ŞdÂy
 = 
L
->
Ây
;

651 
	`lua_lock
(
L
);

652 ià(
L
->
¡©us
 =ğ
LUA_OK
) {

653 ià(
L
->
ci
 !ğ&L->
ba£_ci
)

654  
	`»sume_”rÜ
(
L
, "ÿÂÙ„esumnÚ-su¥’ded cÜoutše", 
Çrgs
);

656 ià(
L
->
¡©us
 !ğ
LUA_YIELD
)

657  
	`»sume_”rÜ
(
L
, "ÿÂÙ„esumd—d cÜoutše", 
Çrgs
);

658 
L
->
nCÿÎs
 = (
äom
) ? from->nCcalls + 1 : 1;

659 ià(
L
->
nCÿÎs
 >ğ
LUAI_MAXCCALLS
)

660  
	`»sume_”rÜ
(
L
, "C sck ov”æow", 
Çrgs
);

661 
	`luai_u£r¡©”esume
(
L
, 
Çrgs
);

662 
L
->
Ây
 = 0;

663 
	`­i_checkÃËms
(
L
, (L->
¡©us
 =ğ
LUA_OK
è? 
Çrgs
 + 1 :‚args);

664 
¡©us
 = 
	`luaD_¿wruÅrÙeùed
(
L
, 
»sume
, &
Çrgs
);

665 ià(
¡©us
 == -1)

666 
¡©us
 = 
LUA_ERRRUN
;

668 
	`”rÜ¡©us
(
¡©us
è&& 
	`»cov”
(
L
, status)) {

670 
¡©us
 = 
	`luaD_¿wruÅrÙeùed
(
L
, 
uÄŞl
, &status);

672 ià(
	`”rÜ¡©us
(
¡©us
)) {

673 
L
->
¡©us
 = 
	`ÿ¡_by‹
(status);

674 
	`£‹¼Üobj
(
L
, 
¡©us
, L->
tİ
);

675 
L
->
ci
->
tİ
 = L->top;

677 
	`lua_as£¹
(
¡©us
 =ğ
L
->status);

679 
L
->
Ây
 = 
ŞdÂy
;

680 
L
->
nCÿÎs
--;

681 
	`lua_as£¹
(
L
->
nCÿÎs
 =ğ((
äom
) ? from->nCcalls : 0));

682 
	`lua_uÆock
(
L
);

683  
¡©us
;

684 
	}
}

687 
LUA_API
 
	$lua_isy›ldabË
 (
lua_S‹
 *
L
) {

688  (
L
->
Ây
 == 0);

689 
	}
}

692 
LUA_API
 
	$lua_y›ldk
 (
lua_S‹
 *
L
, 
ÄesuÉs
, 
lua_KCÚ‹xt
 
ùx
,

693 
lua_KFunùiÚ
 
k
) {

694 
C®lInfo
 *
ci
 = 
L
->ci;

695 
	`luai_u£r¡©ey›ld
(
L
, 
ÄesuÉs
);

696 
	`lua_lock
(
L
);

697 
	`­i_checkÃËms
(
L
, 
ÄesuÉs
);

698 ià(
L
->
Ây
 > 0) {

699 ià(
L
 !ğ
	`G
(L)->
mašth»ad
)

700 
	`luaG_ruÃ¼Ü
(
L
, "attempto yield‡cross‡ C-call boundary");

702 
	`luaG_ruÃ¼Ü
(
L
, "attempto yield from outside‡ coroutine");

704 
L
->
¡©us
 = 
LUA_YIELD
;

705 
ci
->
exŒa
 = 
	`§ve¡ack
(
L
, ci->
func
);

706 ià(
	`isLua
(
ci
)) {

707 
	`­i_check
(
L
, 
k
 =ğ
NULL
, "hooks cannot continue‡fter yielding");

710 ià((
ci
->
u
.
c
.
k
 = kè!ğ
NULL
)

711 
ci
->
u
.
c
.
ùx
 = ctx;

712 
ci
->
func
 = 
L
->
tİ
 - 
ÄesuÉs
 - 1;

713 
	`luaD_throw
(
L
, 
LUA_YIELD
);

715 
	`lua_as£¹
(
ci
->
ÿÎ¡©us
 & 
CIST_HOOKED
);

716 
	`lua_uÆock
(
L
);

718 
	}
}

721 
	$luaD_pÿÎ
 (
lua_S‹
 *
L
, 
Pfunc
 
func
, *
u
,

722 
±rdiff_t
 
Şd_tİ
,…Œdiff_ˆ
ef
) {

723 
¡©us
;

724 
C®lInfo
 *
Şd_ci
 = 
L
->
ci
;

725 
lu_by‹
 
Şd_®lowhooks
 = 
L
->
®lowhook
;

726 
Şd_Ây
 = 
L
->
Ây
;

727 
±rdiff_t
 
Şd_”rfunc
 = 
L
->
”rfunc
;

728 
L
->
”rfunc
 = 
ef
;

729 
¡©us
 = 
	`luaD_¿wruÅrÙeùed
(
L
, 
func
, 
u
);

730 ià(
¡©us
 !ğ
LUA_OK
) {

731 
StkId
 
Şdtİ
 = 
	`»¡Üe¡ack
(
L
, 
Şd_tİ
);

732 
	`luaF_şo£
(
L
, 
Şdtİ
);

733 
	`£‹¼Üobj
(
L
, 
¡©us
, 
Şdtİ
);

734 
L
->
ci
 = 
Şd_ci
;

735 
L
->
®lowhook
 = 
Şd_®lowhooks
;

736 
L
->
Ây
 = 
Şd_Ây
;

737 
	`luaD_shršk¡ack
(
L
);

739 
L
->
”rfunc
 = 
Şd_”rfunc
;

740  
¡©us
;

741 
	}
}

748 
	sSP¬£r
 {

749 
ZIO
 *
	mz
;

750 
Mbufãr
 
	mbuff
;

751 
Dynd©a
 
	mdyd
;

752 cÚ¡ *
	mmode
;

753 cÚ¡ *
	mÇme
;

757 
	$checkmode
 (
lua_S‹
 *
L
, cÚ¡ *
mode
, cÚ¡ *
x
) {

758 ià(
mode
 && 
	`¡rchr
(mode, 
x
[0]è=ğ
NULL
) {

759 
	`luaO_pushf¡ršg
(
L
,

760 "©‹m±Ølßd‡ % chunk (modi '%s')", 
x
, 
mode
);

761 
	`luaD_throw
(
L
, 
LUA_ERRSYNTAX
);

763 
	}
}

766 
	$f_·r£r
 (
lua_S‹
 *
L
, *
ud
) {

767 
LClosu»
 *
ş
;

768 
SP¬£r
 *
p
 = 
	`ÿ¡
(SP¬£¸*, 
ud
);

769 
c
 = 
	`zg‘c
(
p
->
z
);

770 ià(
c
 =ğ
LUA_SIGNATURE
[0]) {

771 
	`checkmode
(
L
, 
p
->
mode
, "binary");

772 
ş
 = 
	`luaU_undump
(
L
, 
p
->
z
,…->
Çme
);

775 
	`checkmode
(
L
, 
p
->
mode
, "text");

776 
ş
 = 
	`luaY_·r£r
(
L
, 
p
->
z
, &p->
buff
, &p->
dyd
,…->
Çme
, 
c
);

778 
	`lua_as£¹
(
ş
->
nupv®ues
 =ğş->
p
->
sizeupv®ues
);

779 
	`luaF_š™upv®s
(
L
, 
ş
);

780 
	}
}

783 
	$luaD_´Ùeùed·r£r
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, cÚ¡ *
Çme
,

784 cÚ¡ *
mode
) {

785 
SP¬£r
 
p
;

786 
¡©us
;

787 
L
->
Ây
++;

788 
p
.
z
 = z;….
Çme
 =‚ame;….
mode
 = mode;

789 
p
.
dyd
.
aùv¬
.
¬r
 = 
NULL
;….dyd.aùv¬.
size
 = 0;

790 
p
.
dyd
.
gt
.
¬r
 = 
NULL
;….dyd.gt.
size
 = 0;

791 
p
.
dyd
.
Ïb–
.
¬r
 = 
NULL
;….dyd.Ïb–.
size
 = 0;

792 
	`luaZ_š™bufãr
(
L
, &
p
.
buff
);

793 
¡©us
 = 
	`luaD_pÿÎ
(
L
, 
f_·r£r
, &
p
, 
	`§ve¡ack
(L, L->
tİ
), L->
”rfunc
);

794 
	`luaZ_ä“bufãr
(
L
, &
p
.
buff
);

795 
	`luaM_ä“¬¿y
(
L
, 
p
.
dyd
.
aùv¬
.
¬r
,….dyd.aùv¬.
size
);

796 
	`luaM_ä“¬¿y
(
L
, 
p
.
dyd
.
gt
.
¬r
,….dyd.gt.
size
);

797 
	`luaM_ä“¬¿y
(
L
, 
p
.
dyd
.
Ïb–
.
¬r
,….dyd.Ïb–.
size
);

798 
L
->
Ây
--;

799  
¡©us
;

800 
	}
}

	@script/lua/lua-5.3.4/src/ldo.h

7 #iâdeà
ldo_h


8 
	#ldo_h


	)

11 
	~"lobjeù.h
"

12 
	~"l¡©e.h
"

13 
	~"lzio.h
"

23 
	#luaD_check¡ackaux
(
L
,
n
,
´e
,
pos
) \

24 ià(
L
->
¡ack_Ï¡
 - L->
tİ
 <ğ(
n
)) \

25 { 
´e
; 
	`luaD_grow¡ack
(
L
, 
n
); 
pos
; } { 
	`cÚdmove¡ack
(L,´e,pos); }

	)

28 
	#luaD_check¡ack
(
L
,
n
è
	`luaD_check¡ackaux
(L,n,()0,()0)

	)

32 
	#§ve¡ack
(
L
,
p
è((*)Õè- (*)L->
¡ack
)

	)

33 
	#»¡Üe¡ack
(
L
,
n
è((
TV®ue
 *)((*)L->
¡ack
 + (n)))

	)

37 (*
	tPfunc
è(
	tlua_S‹
 *
	tL
, *
	tud
);

39 
LUAI_FUNC
 
	`luaD_´Ùeùed·r£r
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, cÚ¡ *
Çme
,

40 cÚ¡ *
mode
);

41 
LUAI_FUNC
 
	`luaD_hook
 (
lua_S‹
 *
L
, 
ev’t
, 
lše
);

42 
LUAI_FUNC
 
	`luaD_´eÿÎ
 (
lua_S‹
 *
L
, 
StkId
 
func
, 
ÄesuÉs
);

43 
LUAI_FUNC
 
	`luaD_ÿÎ
 (
lua_S‹
 *
L
, 
StkId
 
func
, 
nResuÉs
);

44 
LUAI_FUNC
 
	`luaD_ÿÎnoy›ld
 (
lua_S‹
 *
L
, 
StkId
 
func
, 
nResuÉs
);

45 
LUAI_FUNC
 
	`luaD_pÿÎ
 (
lua_S‹
 *
L
, 
Pfunc
 
func
, *
u
,

46 
±rdiff_t
 
Şdtİ
,…Œdiff_ˆ
ef
);

47 
LUAI_FUNC
 
	`luaD_posÿÎ
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
, 
StkId
 
fœ¡ResuÉ
,

48 
Äes
);

49 
LUAI_FUNC
 
	`luaD_»®loc¡ack
 (
lua_S‹
 *
L
, 
Ãwsize
);

50 
LUAI_FUNC
 
	`luaD_grow¡ack
 (
lua_S‹
 *
L
, 
n
);

51 
LUAI_FUNC
 
	`luaD_shršk¡ack
 (
lua_S‹
 *
L
);

52 
LUAI_FUNC
 
	`luaD_šùİ
 (
lua_S‹
 *
L
);

54 
LUAI_FUNC
 
l_nÜ‘
 
	`luaD_throw
 (
lua_S‹
 *
L
, 
”rcode
);

55 
LUAI_FUNC
 
	`luaD_¿wruÅrÙeùed
 (
lua_S‹
 *
L
, 
Pfunc
 
f
, *
ud
);

	@script/lua/lua-5.3.4/src/ldump.c

7 
	#ldump_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ddef.h
>

15 
	~"lua.h
"

17 
	~"lobjeù.h
"

18 
	~"l¡©e.h
"

19 
	~"lundump.h
"

23 
lua_S‹
 *
	mL
;

24 
lua_Wr™”
 
	mwr™”
;

25 *
	md©a
;

26 
	m¡r
;

27 
	m¡©us
;

28 } 
	tDumpS‹
;

35 
	#DumpVeùÜ
(
v
,
n
,
D
è
	`DumpBlock
(v,Ò)*((v)[0]),D)

	)

37 
	#DumpL™”®
(
s
,
D
è
	`DumpBlock
(s, (sè- (), D)

	)

40 
	$DumpBlock
 (cÚ¡ *
b
, 
size_t
 
size
, 
DumpS‹
 *
D
) {

41 ià(
D
->
¡©us
 =ğ0 && 
size
 > 0) {

42 
	`lua_uÆock
(
D
->
L
);

43 
D
->
¡©us
 = (*D->
wr™”
)(D->
L
, 
b
, 
size
, D->
d©a
);

44 
	`lua_lock
(
D
->
L
);

46 
	}
}

49 
	#DumpV¬
(
x
,
D
è
	`DumpVeùÜ
(&x,1,D)

	)

52 
	$DumpBy‹
 (
y
, 
DumpS‹
 *
D
) {

53 
lu_by‹
 
x
 = (lu_by‹)
y
;

54 
	`DumpV¬
(
x
, 
D
);

55 
	}
}

58 
	$DumpIÁ
 (
x
, 
DumpS‹
 *
D
) {

59 
	`DumpV¬
(
x
, 
D
);

60 
	}
}

63 
	$DumpNumb”
 (
lua_Numb”
 
x
, 
DumpS‹
 *
D
) {

64 
	`DumpV¬
(
x
, 
D
);

65 
	}
}

68 
	$DumpIÁeg”
 (
lua_IÁeg”
 
x
, 
DumpS‹
 *
D
) {

69 
	`DumpV¬
(
x
, 
D
);

70 
	}
}

73 
	$DumpSŒšg
 (cÚ¡ 
TSŒšg
 *
s
, 
DumpS‹
 *
D
) {

74 ià(
s
 =ğ
NULL
)

75 
	`DumpBy‹
(0, 
D
);

77 
size_t
 
size
 = 
	`ts¦’
(
s
) + 1;

78 cÚ¡ *
¡r
 = 
	`g‘¡r
(
s
);

79 ià(
size
 < 0xFF)

80 
	`DumpBy‹
(
	`ÿ¡_št
(
size
), 
D
);

82 
	`DumpBy‹
(0xFF, 
D
);

83 
	`DumpV¬
(
size
, 
D
);

85 
	`DumpVeùÜ
(
¡r
, 
size
 - 1, 
D
);

87 
	}
}

90 
	$DumpCode
 (cÚ¡ 
PrÙo
 *
f
, 
DumpS‹
 *
D
) {

91 
	`DumpIÁ
(
f
->
sizecode
, 
D
);

92 
	`DumpVeùÜ
(
f
->
code
, f->
sizecode
, 
D
);

93 
	}
}

96 
DumpFunùiÚ
(cÚ¡ 
PrÙo
 *
f
, 
TSŒšg
 *
psourû
, 
DumpS‹
 *
D
);

98 
	$DumpCÚ¡ªts
 (cÚ¡ 
PrÙo
 *
f
, 
DumpS‹
 *
D
) {

99 
i
;

100 
n
 = 
f
->
sizek
;

101 
	`DumpIÁ
(
n
, 
D
);

102 
i
 = 0; i < 
n
; i++) {

103 cÚ¡ 
TV®ue
 *
o
 = &
f
->
k
[
i
];

104 
	`DumpBy‹
(
	`‰y³
(
o
), 
D
);

105 
	`‰y³
(
o
)) {

106 
LUA_TNIL
:

108 
LUA_TBOOLEAN
:

109 
	`DumpBy‹
(
	`bv®ue
(
o
), 
D
);

111 
LUA_TNUMFLT
:

112 
	`DumpNumb”
(
	`ætv®ue
(
o
), 
D
);

114 
LUA_TNUMINT
:

115 
	`DumpIÁeg”
(
	`iv®ue
(
o
), 
D
);

117 
LUA_TSHRSTR
:

118 
LUA_TLNGSTR
:

119 
	`DumpSŒšg
(
	`tsv®ue
(
o
), 
D
);

122 
	`lua_as£¹
(0);

125 
	}
}

128 
	$DumpPrÙos
 (cÚ¡ 
PrÙo
 *
f
, 
DumpS‹
 *
D
) {

129 
i
;

130 
n
 = 
f
->
siz•
;

131 
	`DumpIÁ
(
n
, 
D
);

132 
i
 = 0; i < 
n
; i++)

133 
	`DumpFunùiÚ
(
f
->
p
[
i
], f->
sourû
, 
D
);

134 
	}
}

137 
	$DumpUpv®ues
 (cÚ¡ 
PrÙo
 *
f
, 
DumpS‹
 *
D
) {

138 
i
, 
n
 = 
f
->
sizeupv®ues
;

139 
	`DumpIÁ
(
n
, 
D
);

140 
i
 = 0; i < 
n
; i++) {

141 
	`DumpBy‹
(
f
->
upv®ues
[
i
].
š¡ack
, 
D
);

142 
	`DumpBy‹
(
f
->
upv®ues
[
i
].
idx
, 
D
);

144 
	}
}

147 
	$DumpDebug
 (cÚ¡ 
PrÙo
 *
f
, 
DumpS‹
 *
D
) {

148 
i
, 
n
;

149 
n
 = (
D
->
¡r
è? 0 : 
f
->
siz–šešfo
;

150 
	`DumpIÁ
(
n
, 
D
);

151 
	`DumpVeùÜ
(
f
->
lšešfo
, 
n
, 
D
);

152 
n
 = (
D
->
¡r
è? 0 : 
f
->
siz–ocv¬s
;

153 
	`DumpIÁ
(
n
, 
D
);

154 
i
 = 0; i < 
n
; i++) {

155 
	`DumpSŒšg
(
f
->
locv¬s
[
i
].
v¬Çme
, 
D
);

156 
	`DumpIÁ
(
f
->
locv¬s
[
i
].
¡¬c
, 
D
);

157 
	`DumpIÁ
(
f
->
locv¬s
[
i
].
’dpc
, 
D
);

159 
n
 = (
D
->
¡r
è? 0 : 
f
->
sizeupv®ues
;

160 
	`DumpIÁ
(
n
, 
D
);

161 
i
 = 0; i < 
n
; i++)

162 
	`DumpSŒšg
(
f
->
upv®ues
[
i
].
Çme
, 
D
);

163 
	}
}

166 
	$DumpFunùiÚ
 (cÚ¡ 
PrÙo
 *
f
, 
TSŒšg
 *
psourû
, 
DumpS‹
 *
D
) {

167 ià(
D
->
¡r
 || 
f
->
sourû
 =ğ
psourû
)

168 
	`DumpSŒšg
(
NULL
, 
D
);

170 
	`DumpSŒšg
(
f
->
sourû
, 
D
);

171 
	`DumpIÁ
(
f
->
lšedefšed
, 
D
);

172 
	`DumpIÁ
(
f
->
Ï¡lšedefšed
, 
D
);

173 
	`DumpBy‹
(
f
->
num·¿ms
, 
D
);

174 
	`DumpBy‹
(
f
->
is_v¬¬g
, 
D
);

175 
	`DumpBy‹
(
f
->
max¡acksize
, 
D
);

176 
	`DumpCode
(
f
, 
D
);

177 
	`DumpCÚ¡ªts
(
f
, 
D
);

178 
	`DumpUpv®ues
(
f
, 
D
);

179 
	`DumpPrÙos
(
f
, 
D
);

180 
	`DumpDebug
(
f
, 
D
);

181 
	}
}

184 
	$DumpH—d”
 (
DumpS‹
 *
D
) {

185 
	`DumpL™”®
(
LUA_SIGNATURE
, 
D
);

186 
	`DumpBy‹
(
LUAC_VERSION
, 
D
);

187 
	`DumpBy‹
(
LUAC_FORMAT
, 
D
);

188 
	`DumpL™”®
(
LUAC_DATA
, 
D
);

189 
	`DumpBy‹
((), 
D
);

190 
	`DumpBy‹
((
size_t
), 
D
);

191 
	`DumpBy‹
((
In¡ruùiÚ
), 
D
);

192 
	`DumpBy‹
((
lua_IÁeg”
), 
D
);

193 
	`DumpBy‹
((
lua_Numb”
), 
D
);

194 
	`DumpIÁeg”
(
LUAC_INT
, 
D
);

195 
	`DumpNumb”
(
LUAC_NUM
, 
D
);

196 
	}
}

202 
	$luaU_dump
(
lua_S‹
 *
L
, cÚ¡ 
PrÙo
 *
f
, 
lua_Wr™”
 
w
, *
d©a
,

203 
¡r
) {

204 
DumpS‹
 
D
;

205 
D
.
L
 = L;

206 
D
.
wr™”
 = 
w
;

207 
D
.
d©a
 = data;

208 
D
.
¡r
 = strip;

209 
D
.
¡©us
 = 0;

210 
	`DumpH—d”
(&
D
);

211 
	`DumpBy‹
(
f
->
sizeupv®ues
, &
D
);

212 
	`DumpFunùiÚ
(
f
, 
NULL
, &
D
);

213  
D
.
¡©us
;

214 
	}
}

	@script/lua/lua-5.3.4/src/lfunc.c

7 
	#lfunc_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ddef.h
>

15 
	~"lua.h
"

17 
	~"lfunc.h
"

18 
	~"lgc.h
"

19 
	~"lmem.h
"

20 
	~"lobjeù.h
"

21 
	~"l¡©e.h
"

25 
CClosu»
 *
	$luaF_ÃwCşosu»
 (
lua_S‹
 *
L
, 
n
) {

26 
GCObjeù
 *
o
 = 
	`luaC_Ãwobj
(
L
, 
LUA_TCCL
, 
	`sizeCşosu»
(
n
));

27 
CClosu»
 *
c
 = 
	`gco2cş
(
o
);

28 
c
->
nupv®ues
 = 
	`ÿ¡_by‹
(
n
);

29  
c
;

30 
	}
}

33 
LClosu»
 *
	$luaF_ÃwLşosu»
 (
lua_S‹
 *
L
, 
n
) {

34 
GCObjeù
 *
o
 = 
	`luaC_Ãwobj
(
L
, 
LUA_TLCL
, 
	`sizeLşosu»
(
n
));

35 
LClosu»
 *
c
 = 
	`gco2lş
(
o
);

36 
c
->
p
 = 
NULL
;

37 
c
->
nupv®ues
 = 
	`ÿ¡_by‹
(
n
);

38 
n
--è
c
->
upv®s
[n] = 
NULL
;

39  
c
;

40 
	}
}

45 
	$luaF_š™upv®s
 (
lua_S‹
 *
L
, 
LClosu»
 *
ş
) {

46 
i
;

47 
i
 = 0; i < 
ş
->
nupv®ues
; i++) {

48 
UpV®
 *
uv
 = 
	`luaM_Ãw
(
L
, UpVal);

49 
uv
->
»fcouÁ
 = 1;

50 
uv
->
v
 = &uv->
u
.
v®ue
;

51 
	`£Šv®ue
(
uv
->
v
);

52 
ş
->
upv®s
[
i
] = 
uv
;

54 
	}
}

57 
UpV®
 *
	$luaF_fšdupv®
 (
lua_S‹
 *
L
, 
StkId
 
Ëv–
) {

58 
UpV®
 **
µ
 = &
L
->
İ’upv®
;

59 
UpV®
 *
p
;

60 
UpV®
 *
uv
;

61 
	`lua_as£¹
(
	`isštwups
(
L
è|| L->
İ’upv®
 =ğ
NULL
);

62 *
µ
 !ğ
NULL
 && (
p
 = *µ)->
v
 >ğ
Ëv–
) {

63 
	`lua_as£¹
(
	`upisİ’
(
p
));

64 ià(
p
->
v
 =ğ
Ëv–
)

65  
p
;

66 
µ
 = &
p
->
u
.
İ’
.
Ãxt
;

69 
uv
 = 
	`luaM_Ãw
(
L
, 
UpV®
);

70 
uv
->
»fcouÁ
 = 0;

71 
uv
->
u
.
İ’
.
Ãxt
 = *
µ
;

72 
uv
->
u
.
İ’
.
touched
 = 1;

73 *
µ
 = 
uv
;

74 
uv
->
v
 = 
Ëv–
;

75 ià(!
	`isštwups
(
L
)) {

76 
L
->
twups
 = 
	`G
(L)->twups;

77 
	`G
(
L
)->
twups
 = L;

79  
uv
;

80 
	}
}

83 
	$luaF_şo£
 (
lua_S‹
 *
L
, 
StkId
 
Ëv–
) {

84 
UpV®
 *
uv
;

85 
L
->
İ’upv®
 !ğ
NULL
 && (
uv
 = L->İ’upv®)->
v
 >ğ
Ëv–
) {

86 
	`lua_as£¹
(
	`upisİ’
(
uv
));

87 
L
->
İ’upv®
 = 
uv
->
u
.
İ’
.
Ãxt
;

88 ià(
uv
->
»fcouÁ
 == 0)

89 
	`luaM_ä“
(
L
, 
uv
);

91 
	`£tobj
(
L
, &
uv
->
u
.
v®ue
, uv->
v
);

92 
uv
->
v
 = &uv->
u
.
v®ue
;

93 
	`luaC_upv®b¬r›r
(
L
, 
uv
);

96 
	}
}

99 
PrÙo
 *
	$luaF_Ãw´Ùo
 (
lua_S‹
 *
L
) {

100 
GCObjeù
 *
o
 = 
	`luaC_Ãwobj
(
L
, 
LUA_TPROTO
, (
PrÙo
));

101 
PrÙo
 *
f
 = 
	`gco2p
(
o
);

102 
f
->
k
 = 
NULL
;

103 
f
->
sizek
 = 0;

104 
f
->
p
 = 
NULL
;

105 
f
->
siz•
 = 0;

106 
f
->
code
 = 
NULL
;

107 
f
->
ÿche
 = 
NULL
;

108 
f
->
sizecode
 = 0;

109 
f
->
lšešfo
 = 
NULL
;

110 
f
->
siz–šešfo
 = 0;

111 
f
->
upv®ues
 = 
NULL
;

112 
f
->
sizeupv®ues
 = 0;

113 
f
->
num·¿ms
 = 0;

114 
f
->
is_v¬¬g
 = 0;

115 
f
->
max¡acksize
 = 0;

116 
f
->
locv¬s
 = 
NULL
;

117 
f
->
siz–ocv¬s
 = 0;

118 
f
->
lšedefšed
 = 0;

119 
f
->
Ï¡lšedefšed
 = 0;

120 
f
->
sourû
 = 
NULL
;

121  
f
;

122 
	}
}

125 
	$luaF_ä“´Ùo
 (
lua_S‹
 *
L
, 
PrÙo
 *
f
) {

126 
	`luaM_ä“¬¿y
(
L
, 
f
->
code
, f->
sizecode
);

127 
	`luaM_ä“¬¿y
(
L
, 
f
->
p
, f->
siz•
);

128 
	`luaM_ä“¬¿y
(
L
, 
f
->
k
, f->
sizek
);

129 
	`luaM_ä“¬¿y
(
L
, 
f
->
lšešfo
, f->
siz–šešfo
);

130 
	`luaM_ä“¬¿y
(
L
, 
f
->
locv¬s
, f->
siz–ocv¬s
);

131 
	`luaM_ä“¬¿y
(
L
, 
f
->
upv®ues
, f->
sizeupv®ues
);

132 
	`luaM_ä“
(
L
, 
f
);

133 
	}
}

140 cÚ¡ *
	$luaF_g‘loÿÊame
 (cÚ¡ 
PrÙo
 *
f
, 
loÿl_numb”
, 
pc
) {

141 
i
;

142 
i
 = 0; i<
f
->
siz–ocv¬s
 && f->
locv¬s
[i].
¡¬c
 <ğ
pc
; i++) {

143 ià(
pc
 < 
f
->
locv¬s
[
i
].
’dpc
) {

144 
loÿl_numb”
--;

145 ià(
loÿl_numb”
 == 0)

146  
	`g‘¡r
(
f
->
locv¬s
[
i
].
v¬Çme
);

149  
NULL
;

150 
	}
}

	@script/lua/lua-5.3.4/src/lfunc.h

7 #iâdeà
lfunc_h


8 
	#lfunc_h


	)

11 
	~"lobjeù.h
"

14 
	#sizeCşosu»
(
n
è(
	`ÿ¡
(, (
CClosu»
)) + \

15 
	`ÿ¡
(, (
TV®ue
)*((
n
)-1)))

	)

17 
	#sizeLşosu»
(
n
è(
	`ÿ¡
(, (
LClosu»
)) + \

18 
	`ÿ¡
(, (
TV®ue
 *)*((
n
)-1)))

	)

22 
	#isštwups
(
L
è(L->
twups
 !ğL)

	)

29 
	#MAXUPVAL
 255

	)

35 
	sUpV®
 {

36 
TV®ue
 *
	mv
;

37 
lu_mem
 
	m»fcouÁ
;

40 
UpV®
 *
	mÃxt
;

41 
	mtouched
;

42 } 
	mİ’
;

43 
TV®ue
 
	mv®ue
;

44 } 
	mu
;

47 
	#upisİ’
(
up
è((up)->
v
 !ğ&(up)->
u
.
v®ue
)

	)

50 
LUAI_FUNC
 
PrÙo
 *
luaF_Ãw´Ùo
 (
lua_S‹
 *
L
);

51 
LUAI_FUNC
 
CClosu»
 *
luaF_ÃwCşosu»
 (
lua_S‹
 *
L
, 
ÃËms
);

52 
LUAI_FUNC
 
LClosu»
 *
luaF_ÃwLşosu»
 (
lua_S‹
 *
L
, 
ÃËms
);

53 
LUAI_FUNC
 
luaF_š™upv®s
 (
lua_S‹
 *
L
, 
LClosu»
 *
ş
);

54 
LUAI_FUNC
 
UpV®
 *
luaF_fšdupv®
 (
lua_S‹
 *
L
, 
StkId
 
Ëv–
);

55 
LUAI_FUNC
 
luaF_şo£
 (
lua_S‹
 *
L
, 
StkId
 
Ëv–
);

56 
LUAI_FUNC
 
luaF_ä“´Ùo
 (
lua_S‹
 *
L
, 
PrÙo
 *
f
);

57 
LUAI_FUNC
 cÚ¡ *
luaF_g‘loÿÊame
 (cÚ¡ 
PrÙo
 *
func
, 
loÿl_numb”
,

58 
pc
);

	@script/lua/lua-5.3.4/src/lgc.c

7 
	#lgc_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ršg.h
>

15 
	~"lua.h
"

17 
	~"ldebug.h
"

18 
	~"ldo.h
"

19 
	~"lfunc.h
"

20 
	~"lgc.h
"

21 
	~"lmem.h
"

22 
	~"lobjeù.h
"

23 
	~"l¡©e.h
"

24 
	~"l¡ršg.h
"

25 
	~"ÉabË.h
"

26 
	~"Ém.h
"

33 
	#GCSšsid—tomic
 (
GCS·u£
 + 1)

	)

39 
	#GCSWEEPCOST
 (((
TSŒšg
è+ 4è/ 4)

	)

42 
	#GCSWEEPMAX
 (
	`ÿ¡_št
((
GCSTEPSIZE
 / 
GCSWEEPCOST
è/ 4))

	)

45 
	#GCFINALIZECOST
 
GCSWEEPCOST


	)

52 
	#STEPMULADJ
 200

	)

59 
	#PAUSEADJ
 100

	)

66 
	#maskcŞÜs
 (~(
	`b™mask
(
BLACKBIT
è| 
WHITEBITS
))

	)

67 
	#makewh™e
(
g
,
x
) \

68 (
x
->
m¬ked
 = 
	`ÿ¡_by‹
((x->m¬ked & 
maskcŞÜs
è| 
	`luaC_wh™e
(
g
)))

	)

70 
	#wh™e2g¿y
(
x
è
	`»£tb™s
(x->
m¬ked
, 
WHITEBITS
)

	)

71 
	#bÏck2g¿y
(
x
è
	`»£tb™
(x->
m¬ked
, 
BLACKBIT
)

	)

74 
	#v®iswh™e
(
x
è(
	`iscŞËùabË
(xè&& 
	`iswh™e
(
	`gcv®ue
(x)))

	)

76 
	#checkd—dkey
(
n
è
	`lua_as£¹
(!
	`‰isd—dkey
(
	`gkey
Ò)è|| 
	`‰i¢
(
	`gv®
Ò)))

	)

79 
	#checkcÚsi¡’cy
(
obj
) \

80 
	`lua_lÚgas£¹
(!
	`iscŞËùabË
(
obj
è|| 
	`righ‰t
(obj))

	)

83 
	#m¬kv®ue
(
g
,
o
è{ 
	`checkcÚsi¡’cy
(o); \

84 ià(
	`v®iswh™e
(
o
)è
	`»®lym¬kobjeù
(
g
,
	`gcv®ue
(o)); }

	)

86 
	#m¬kobjeù
(
g
,
t
è{ ià(
	`iswh™e
Ñ)è
	`»®lym¬kobjeù
(g, 
	`obj2gco
Ñ)); }

	)

92 
	#m¬kobjeùN
(
g
,
t
è{ iàÑè
	`m¬kobjeù
(g,t); }

	)

94 
»®lym¬kobjeù
 (
glob®_S‹
 *
g
, 
GCObjeù
 *
o
);

107 
	#gnod–a¡
(
h
è
	`gnode
(h, 
	`ÿ¡
(
size_t
, 
	`siz’ode
(h)))

	)

113 
	#lškgşi¡
(
o
,
p
è((o)->
gşi¡
 = (p), (pèğ
	`obj2gco
(o))

	)

125 
	$»mov“Áry
 (
Node
 *
n
) {

126 
	`lua_as£¹
(
	`‰i¢
(
	`gv®
(
n
)));

127 ià(
	`v®iswh™e
(
	`gkey
(
n
)))

128 
	`£td—dv®ue
(
	`wgkey
(
n
));

129 
	}
}

139 
	$isş—»d
 (
glob®_S‹
 *
g
, cÚ¡ 
TV®ue
 *
o
) {

140 ià(!
	`iscŞËùabË
(
o
))  0;

141 ià(
	`‰is¡ršg
(
o
)) {

142 
	`m¬kobjeù
(
g
, 
	`tsv®ue
(
o
));

145  
	`iswh™e
(
	`gcv®ue
(
o
));

146 
	}
}

155 
	$luaC_b¬r›r_
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
, GCObjeù *
v
) {

156 
glob®_S‹
 *
g
 = 
	`G
(
L
);

157 
	`lua_as£¹
(
	`isbÏck
(
o
è&& 
	`iswh™e
(
v
è&& !
	`isd—d
(
g
, v) && !isdead(g, o));

158 ià(
	`k“pšv¬ŸÁ
(
g
))

159 
	`»®lym¬kobjeù
(
g
, 
v
);

161 
	`lua_as£¹
(
	`issw“µha£
(
g
));

162 
	`makewh™e
(
g
, 
o
);

164 
	}
}

171 
	$luaC_b¬r›rback_
 (
lua_S‹
 *
L
, 
TabË
 *
t
) {

172 
glob®_S‹
 *
g
 = 
	`G
(
L
);

173 
	`lua_as£¹
(
	`isbÏck
(
t
è&& !
	`isd—d
(
g
,));

174 
	`bÏck2g¿y
(
t
);

175 
	`lškgşi¡
(
t
, 
g
->
g¿yagaš
);

176 
	}
}

185 
	$luaC_upv®b¬r›r_
 (
lua_S‹
 *
L
, 
UpV®
 *
uv
) {

186 
glob®_S‹
 *
g
 = 
	`G
(
L
);

187 
GCObjeù
 *
o
 = 
	`gcv®ue
(
uv
->
v
);

188 
	`lua_as£¹
(!
	`upisİ’
(
uv
));

189 ià(
	`k“pšv¬ŸÁ
(
g
))

190 
	`m¬kobjeù
(
g
, 
o
);

191 
	}
}

194 
	$luaC_fix
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
) {

195 
glob®_S‹
 *
g
 = 
	`G
(
L
);

196 
	`lua_as£¹
(
g
->
®lgc
 =ğ
o
);

197 
	`wh™e2g¿y
(
o
);

198 
g
->
®lgc
 = 
o
->
Ãxt
;

199 
o
->
Ãxt
 = 
g
->
fixedgc
;

200 
g
->
fixedgc
 = 
o
;

201 
	}
}

208 
GCObjeù
 *
	$luaC_Ãwobj
 (
lua_S‹
 *
L
, 
‰
, 
size_t
 
sz
) {

209 
glob®_S‹
 *
g
 = 
	`G
(
L
);

210 
GCObjeù
 *
o
 = 
	`ÿ¡
(GCObjeù *, 
	`luaM_Ãwobjeù
(
L
, 
	`nov¬ŸÁ
(
‰
), 
sz
));

211 
o
->
m¬ked
 = 
	`luaC_wh™e
(
g
);

212 
o
->
‰
 =t;

213 
o
->
Ãxt
 = 
g
->
®lgc
;

214 
g
->
®lgc
 = 
o
;

215  
o
;

216 
	}
}

235 
	$»®lym¬kobjeù
 (
glob®_S‹
 *
g
, 
GCObjeù
 *
o
) {

236 
»’Œy
:

237 
	`wh™e2g¿y
(
o
);

238 
o
->
‰
) {

239 
LUA_TSHRSTR
: {

240 
	`g¿y2bÏck
(
o
);

241 
g
->
GCmemŒav
 +ğ
	`siz–¡ršg
(
	`gco2ts
(
o
)->
sh¾’
);

244 
LUA_TLNGSTR
: {

245 
	`g¿y2bÏck
(
o
);

246 
g
->
GCmemŒav
 +ğ
	`siz–¡ršg
(
	`gco2ts
(
o
)->
u
.
ÊgËn
);

249 
LUA_TUSERDATA
: {

250 
TV®ue
 
uv®ue
;

251 
	`m¬kobjeùN
(
g
, 
	`gco2u
(
o
)->
m‘©abË
);

252 
	`g¿y2bÏck
(
o
);

253 
g
->
GCmemŒav
 +ğ
	`sizeud©a
(
	`gco2u
(
o
));

254 
	`g‘u£rv®ue
(
g
->
mašth»ad
, 
	`gco2u
(
o
), &
uv®ue
);

255 ià(
	`v®iswh™e
(&
uv®ue
)) {

256 
o
 = 
	`gcv®ue
(&
uv®ue
);

257 
»’Œy
;

261 
LUA_TLCL
: {

262 
	`lškgşi¡
(
	`gco2lş
(
o
), 
g
->
g¿y
);

265 
LUA_TCCL
: {

266 
	`lškgşi¡
(
	`gco2cş
(
o
), 
g
->
g¿y
);

269 
LUA_TTABLE
: {

270 
	`lškgşi¡
(
	`gco2t
(
o
), 
g
->
g¿y
);

273 
LUA_TTHREAD
: {

274 
	`lškgşi¡
(
	`gco2th
(
o
), 
g
->
g¿y
);

277 
LUA_TPROTO
: {

278 
	`lškgşi¡
(
	`gco2p
(
o
), 
g
->
g¿y
);

281 : 
	`lua_as£¹
(0); ;

283 
	}
}

289 
	$m¬kmt
 (
glob®_S‹
 *
g
) {

290 
i
;

291 
i
=0; i < 
LUA_NUMTAGS
; i++)

292 
	`m¬kobjeùN
(
g
, g->
mt
[
i
]);

293 
	}
}

299 
	$m¬kbešgâz
 (
glob®_S‹
 *
g
) {

300 
GCObjeù
 *
o
;

301 
o
 = 
g
->
tobeâz
; o !ğ
NULL
; o = o->
Ãxt
)

302 
	`m¬kobjeù
(
g
, 
o
);

303 
	}
}

312 
	$»m¬kupv®s
 (
glob®_S‹
 *
g
) {

313 
lua_S‹
 *
th»ad
;

314 
lua_S‹
 **
p
 = &
g
->
twups
;

315 (
th»ad
 = *
p
è!ğ
NULL
) {

316 
	`lua_as£¹
(!
	`isbÏck
(
th»ad
));

317 ià(
	`isg¿y
(
th»ad
è&&h»ad->
İ’upv®
 !ğ
NULL
)

318 
p
 = &
th»ad
->
twups
;

320 
UpV®
 *
uv
;

321 *
p
 = 
th»ad
->
twups
;

322 
th»ad
->
twups
 =hread;

323 
uv
 = 
th»ad
->
İ’upv®
; uv !ğ
NULL
; uv = uv->
u
.
İ’
.
Ãxt
) {

324 ià(
uv
->
u
.
İ’
.
touched
) {

325 
	`m¬kv®ue
(
g
, 
uv
->
v
);

326 
uv
->
u
.
İ’
.
touched
 = 0;

331 
	}
}

337 
	$»¡¬tcŞËùiÚ
 (
glob®_S‹
 *
g
) {

338 
g
->
g¿y
 = g->
g¿yagaš
 = 
NULL
;

339 
g
->
w—k
 = g->
®lw—k
 = g->
•hem”Ú
 = 
NULL
;

340 
	`m¬kobjeù
(
g
, g->
mašth»ad
);

341 
	`m¬kv®ue
(
g
, &g->
l_»gi¡ry
);

342 
	`m¬kmt
(
g
);

343 
	`m¬kbešgâz
(
g
);

344 
	}
}

361 
	$Œav”£w—kv®ue
 (
glob®_S‹
 *
g
, 
TabË
 *
h
) {

362 
Node
 *
n
, *
lim™
 = 
	`gnod–a¡
(
h
);

365 
hasş—rs
 = (
h
->
siz—¼ay
 > 0);

366 
n
 = 
	`gnode
(
h
, 0);‚ < 
lim™
;‚++) {

367 
	`checkd—dkey
(
n
);

368 ià(
	`‰i¢
(
	`gv®
(
n
)))

369 
	`»mov“Áry
(
n
);

371 
	`lua_as£¹
(!
	`‰i¢
(
	`gkey
(
n
)));

372 
	`m¬kv®ue
(
g
, 
	`gkey
(
n
));

373 ià(!
hasş—rs
 && 
	`isş—»d
(
g
, 
	`gv®
(
n
)))

374 
hasş—rs
 = 1;

377 ià(
g
->
gc¡©e
 =ğ
GCS´İag©e
)

378 
	`lškgşi¡
(
h
, 
g
->
g¿yagaš
);

379 ià(
hasş—rs
)

380 
	`lškgşi¡
(
h
, 
g
->
w—k
);

381 
	}
}

394 
	$Œav”£•hem”Ú
 (
glob®_S‹
 *
g
, 
TabË
 *
h
) {

395 
m¬ked
 = 0;

396 
hasş—rs
 = 0;

397 
hasww
 = 0;

398 
Node
 *
n
, *
lim™
 = 
	`gnod–a¡
(
h
);

399 
i
;

401 
i
 = 0; i < 
h
->
siz—¼ay
; i++) {

402 ià(
	`v®iswh™e
(&
h
->
¬¿y
[
i
])) {

403 
m¬ked
 = 1;

404 
	`»®lym¬kobjeù
(
g
, 
	`gcv®ue
(&
h
->
¬¿y
[
i
]));

408 
n
 = 
	`gnode
(
h
, 0);‚ < 
lim™
;‚++) {

409 
	`checkd—dkey
(
n
);

410 ià(
	`‰i¢
(
	`gv®
(
n
)))

411 
	`»mov“Áry
(
n
);

412 ià(
	`isş—»d
(
g
, 
	`gkey
(
n
))) {

413 
hasş—rs
 = 1;

414 ià(
	`v®iswh™e
(
	`gv®
(
n
)))

415 
hasww
 = 1;

417 ià(
	`v®iswh™e
(
	`gv®
(
n
))) {

418 
m¬ked
 = 1;

419 
	`»®lym¬kobjeù
(
g
, 
	`gcv®ue
(
	`gv®
(
n
)));

423 ià(
g
->
gc¡©e
 =ğ
GCS´İag©e
)

424 
	`lškgşi¡
(
h
, 
g
->
g¿yagaš
);

425 ià(
hasww
)

426 
	`lškgşi¡
(
h
, 
g
->
•hem”Ú
);

427 ià(
hasş—rs
)

428 
	`lškgşi¡
(
h
, 
g
->
®lw—k
);

429  
m¬ked
;

430 
	}
}

433 
	$Œav”£¡rÚgbË
 (
glob®_S‹
 *
g
, 
TabË
 *
h
) {

434 
Node
 *
n
, *
lim™
 = 
	`gnod–a¡
(
h
);

435 
i
;

436 
i
 = 0; i < 
h
->
siz—¼ay
; i++)

437 
	`m¬kv®ue
(
g
, &
h
->
¬¿y
[
i
]);

438 
n
 = 
	`gnode
(
h
, 0);‚ < 
lim™
;‚++) {

439 
	`checkd—dkey
(
n
);

440 ià(
	`‰i¢
(
	`gv®
(
n
)))

441 
	`»mov“Áry
(
n
);

443 
	`lua_as£¹
(!
	`‰i¢
(
	`gkey
(
n
)));

444 
	`m¬kv®ue
(
g
, 
	`gkey
(
n
));

445 
	`m¬kv®ue
(
g
, 
	`gv®
(
n
));

448 
	}
}

451 
lu_mem
 
	$Œav”£bË
 (
glob®_S‹
 *
g
, 
TabË
 *
h
) {

452 cÚ¡ *
w—kkey
, *
w—kv®ue
;

453 cÚ¡ 
TV®ue
 *
mode
 = 
	`gç¡tm
(
g
, 
h
->
m‘©abË
, 
TM_MODE
);

454 
	`m¬kobjeùN
(
g
, 
h
->
m‘©abË
);

455 ià(
mode
 && 
	`‰is¡ršg
(mode) &&

456 ((
w—kkey
 = 
	`¡rchr
(
	`sv®ue
(
mode
), 'k')),

457 (
w—kv®ue
 = 
	`¡rchr
(
	`sv®ue
(
mode
), 'v')),

458 (
w—kkey
 || 
w—kv®ue
))) {

459 
	`bÏck2g¿y
(
h
);

460 ià(!
w—kkey
)

461 
	`Œav”£w—kv®ue
(
g
, 
h
);

462 ià(!
w—kv®ue
)

463 
	`Œav”£•hem”Ú
(
g
, 
h
);

465 
	`lškgşi¡
(
h
, 
g
->
®lw—k
);

468 
	`Œav”£¡rÚgbË
(
g
, 
h
);

469  (
TabË
è+ (
TV®ue
è* 
h
->
siz—¼ay
 +

470 (
Node
è* 
	`ÿ¡
(
size_t
, 
	`®locsiz’ode
(
h
));

471 
	}
}

479 
	$Œav”£´Ùo
 (
glob®_S‹
 *
g
, 
PrÙo
 *
f
) {

480 
i
;

481 ià(
f
->
ÿche
 && 
	`iswh™e
(f->cache))

482 
f
->
ÿche
 = 
NULL
;

483 
	`m¬kobjeùN
(
g
, 
f
->
sourû
);

484 
i
 = 0; i < 
f
->
sizek
; i++)

485 
	`m¬kv®ue
(
g
, &
f
->
k
[
i
]);

486 
i
 = 0; i < 
f
->
sizeupv®ues
; i++)

487 
	`m¬kobjeùN
(
g
, 
f
->
upv®ues
[
i
].
Çme
);

488 
i
 = 0; i < 
f
->
siz•
; i++)

489 
	`m¬kobjeùN
(
g
, 
f
->
p
[
i
]);

490 
i
 = 0; i < 
f
->
siz–ocv¬s
; i++)

491 
	`m¬kobjeùN
(
g
, 
f
->
locv¬s
[
i
].
v¬Çme
);

492  (
PrÙo
è+ (
In¡ruùiÚ
è* 
f
->
sizecode
 +

493 (
PrÙo
 *è* 
f
->
siz•
 +

494 (
TV®ue
è* 
f
->
sizek
 +

495 (è* 
f
->
siz–šešfo
 +

496 (
LocV¬
è* 
f
->
siz–ocv¬s
 +

497 (
Upv®desc
è* 
f
->
sizeupv®ues
;

498 
	}
}

501 
lu_mem
 
	$Œav”£Cşosu»
 (
glob®_S‹
 *
g
, 
CClosu»
 *
ş
) {

502 
i
;

503 
i
 = 0; i < 
ş
->
nupv®ues
; i++)

504 
	`m¬kv®ue
(
g
, &
ş
->
upv®ue
[
i
]);

505  
	`sizeCşosu»
(
ş
->
nupv®ues
);

506 
	}
}

514 
lu_mem
 
	$Œav”£Lşosu»
 (
glob®_S‹
 *
g
, 
LClosu»
 *
ş
) {

515 
i
;

516 
	`m¬kobjeùN
(
g
, 
ş
->
p
);

517 
i
 = 0; i < 
ş
->
nupv®ues
; i++) {

518 
UpV®
 *
uv
 = 
ş
->
upv®s
[
i
];

519 ià(
uv
 !ğ
NULL
) {

520 ià(
	`upisİ’
(
uv
è&& 
g
->
gc¡©e
 !ğ
GCSšsid—tomic
)

521 
uv
->
u
.
İ’
.
touched
 = 1;

523 
	`m¬kv®ue
(
g
, 
uv
->
v
);

526  
	`sizeLşosu»
(
ş
->
nupv®ues
);

527 
	}
}

530 
lu_mem
 
	$Œav”£th»ad
 (
glob®_S‹
 *
g
, 
lua_S‹
 *
th
) {

531 
StkId
 
o
 = 
th
->
¡ack
;

532 ià(
o
 =ğ
NULL
)

534 
	`lua_as£¹
(
g
->
gc¡©e
 =ğ
GCSšsid—tomic
 ||

535 
th
->
İ’upv®
 =ğ
NULL
 || 
	`isštwups
(th));

536 ; 
o
 < 
th
->
tİ
; o++)

537 
	`m¬kv®ue
(
g
, 
o
);

538 ià(
g
->
gc¡©e
 =ğ
GCSšsid—tomic
) {

539 
StkId
 
lim
 = 
th
->
¡ack
 +h->
¡acksize
;

540 ; 
o
 < 
lim
; o++)

541 
	`£Šv®ue
(
o
);

543 ià(!
	`isštwups
(
th
è&&h->
İ’upv®
 !ğ
NULL
) {

544 
th
->
twups
 = 
g
->twups;

545 
g
->
twups
 = 
th
;

548 ià(
g
->
gckšd
 !ğ
KGC_EMERGENCY
)

549 
	`luaD_shršk¡ack
(
th
);

550  ((
lua_S‹
è+ (
TV®ue
è* 
th
->
¡acksize
 +

551 (
C®lInfo
è* 
th
->
nci
);

552 
	}
}

559 
	$´İag©em¬k
 (
glob®_S‹
 *
g
) {

560 
lu_mem
 
size
;

561 
GCObjeù
 *
o
 = 
g
->
g¿y
;

562 
	`lua_as£¹
(
	`isg¿y
(
o
));

563 
	`g¿y2bÏck
(
o
);

564 
o
->
‰
) {

565 
LUA_TTABLE
: {

566 
TabË
 *
h
 = 
	`gco2t
(
o
);

567 
g
->
g¿y
 = 
h
->
gşi¡
;

568 
size
 = 
	`Œav”£bË
(
g
, 
h
);

571 
LUA_TLCL
: {

572 
LClosu»
 *
ş
 = 
	`gco2lş
(
o
);

573 
g
->
g¿y
 = 
ş
->
gşi¡
;

574 
size
 = 
	`Œav”£Lşosu»
(
g
, 
ş
);

577 
LUA_TCCL
: {

578 
CClosu»
 *
ş
 = 
	`gco2cş
(
o
);

579 
g
->
g¿y
 = 
ş
->
gşi¡
;

580 
size
 = 
	`Œav”£Cşosu»
(
g
, 
ş
);

583 
LUA_TTHREAD
: {

584 
lua_S‹
 *
th
 = 
	`gco2th
(
o
);

585 
g
->
g¿y
 = 
th
->
gşi¡
;

586 
	`lškgşi¡
(
th
, 
g
->
g¿yagaš
);

587 
	`bÏck2g¿y
(
o
);

588 
size
 = 
	`Œav”£th»ad
(
g
, 
th
);

591 
LUA_TPROTO
: {

592 
PrÙo
 *
p
 = 
	`gco2p
(
o
);

593 
g
->
g¿y
 = 
p
->
gşi¡
;

594 
size
 = 
	`Œav”£´Ùo
(
g
, 
p
);

597 : 
	`lua_as£¹
(0); ;

599 
g
->
GCmemŒav
 +ğ
size
;

600 
	}
}

603 
	$´İag©—Î
 (
glob®_S‹
 *
g
) {

604 
g
->
g¿y
è
	`´İag©em¬k
(g);

605 
	}
}

608 
	$cÚv”g“phem”Ús
 (
glob®_S‹
 *
g
) {

609 
chªged
;

611 
GCObjeù
 *
w
;

612 
GCObjeù
 *
Ãxt
 = 
g
->
•hem”Ú
;

613 
g
->
•hem”Ú
 = 
NULL
;

614 
chªged
 = 0;

615 (
w
 = 
Ãxt
è!ğ
NULL
) {

616 
Ãxt
 = 
	`gco2t
(
w
)->
gşi¡
;

617 ià(
	`Œav”£•hem”Ú
(
g
, 
	`gco2t
(
w
))) {

618 
	`´İag©—Î
(
g
);

619 
chªged
 = 1;

622 } 
chªged
);

623 
	}
}

639 
	$ş—rkeys
 (
glob®_S‹
 *
g
, 
GCObjeù
 *
l
, GCObjeù *
f
) {

640 ; 
l
 !ğ
f
;† = 
	`gco2t
Ö)->
gşi¡
) {

641 
TabË
 *
h
 = 
	`gco2t
(
l
);

642 
Node
 *
n
, *
lim™
 = 
	`gnod–a¡
(
h
);

643 
n
 = 
	`gnode
(
h
, 0);‚ < 
lim™
;‚++) {

644 ià(!
	`‰i¢
(
	`gv®
(
n
)è&& (
	`isş—»d
(
g
, 
	`gkey
(n)))) {

645 
	`£Šv®ue
(
	`gv®
(
n
));

646 
	`»mov“Áry
(
n
);

650 
	}
}

657 
	$ş—rv®ues
 (
glob®_S‹
 *
g
, 
GCObjeù
 *
l
, GCObjeù *
f
) {

658 ; 
l
 !ğ
f
;† = 
	`gco2t
Ö)->
gşi¡
) {

659 
TabË
 *
h
 = 
	`gco2t
(
l
);

660 
Node
 *
n
, *
lim™
 = 
	`gnod–a¡
(
h
);

661 
i
;

662 
i
 = 0; i < 
h
->
siz—¼ay
; i++) {

663 
TV®ue
 *
o
 = &
h
->
¬¿y
[
i
];

664 ià(
	`isş—»d
(
g
, 
o
))

665 
	`£Šv®ue
(
o
);

667 
n
 = 
	`gnode
(
h
, 0);‚ < 
lim™
;‚++) {

668 ià(!
	`‰i¢
(
	`gv®
(
n
)è&& 
	`isş—»d
(
g
, gval(n))) {

669 
	`£Šv®ue
(
	`gv®
(
n
));

670 
	`»mov“Áry
(
n
);

674 
	}
}

677 
	$luaC_upvdeccouÁ
 (
lua_S‹
 *
L
, 
UpV®
 *
uv
) {

678 
	`lua_as£¹
(
uv
->
»fcouÁ
 > 0);

679 
uv
->
»fcouÁ
--;

680 ià(
uv
->
»fcouÁ
 =ğ0 && !
	`upisİ’
(uv))

681 
	`luaM_ä“
(
L
, 
uv
);

682 
	}
}

685 
	$ä“Lşosu»
 (
lua_S‹
 *
L
, 
LClosu»
 *
ş
) {

686 
i
;

687 
i
 = 0; i < 
ş
->
nupv®ues
; i++) {

688 
UpV®
 *
uv
 = 
ş
->
upv®s
[
i
];

689 ià(
uv
)

690 
	`luaC_upvdeccouÁ
(
L
, 
uv
);

692 
	`luaM_ä“mem
(
L
, 
ş
, 
	`sizeLşosu»
(ş->
nupv®ues
));

693 
	}
}

696 
	$ä“obj
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
) {

697 
o
->
‰
) {

698 
LUA_TPROTO
: 
	`luaF_ä“´Ùo
(
L
, 
	`gco2p
(
o
)); ;

699 
LUA_TLCL
: {

700 
	`ä“Lşosu»
(
L
, 
	`gco2lş
(
o
));

703 
LUA_TCCL
: {

704 
	`luaM_ä“mem
(
L
, 
o
, 
	`sizeCşosu»
(
	`gco2cş
(o)->
nupv®ues
));

707 
LUA_TTABLE
: 
	`luaH_ä“
(
L
, 
	`gco2t
(
o
)); ;

708 
LUA_TTHREAD
: 
	`luaE_ä“th»ad
(
L
, 
	`gco2th
(
o
)); ;

709 
LUA_TUSERDATA
: 
	`luaM_ä“mem
(
L
, 
o
, 
	`sizeud©a
(
	`gco2u
(o))); ;

710 
LUA_TSHRSTR
:

711 
	`luaS_»move
(
L
, 
	`gco2ts
(
o
));

712 
	`luaM_ä“mem
(
L
, 
o
, 
	`siz–¡ršg
(
	`gco2ts
(o)->
sh¾’
));

714 
LUA_TLNGSTR
: {

715 
	`luaM_ä“mem
(
L
, 
o
, 
	`siz–¡ršg
(
	`gco2ts
(o)->
u
.
ÊgËn
));

718 : 
	`lua_as£¹
(0);

720 
	}
}

723 
	#sw“pwhŞ–i¡
(
L
,
p
è
	`sw“¶i¡
(L,p,
MAX_LUMEM
)

	)

724 
GCObjeù
 **
sw“¶i¡
 (
lua_S‹
 *
L
, GCObjeù **
p
, 
lu_mem
 
couÁ
);

734 
GCObjeù
 **
	$sw“¶i¡
 (
lua_S‹
 *
L
, 
GCObjeù
 **
p
, 
lu_mem
 
couÁ
) {

735 
glob®_S‹
 *
g
 = 
	`G
(
L
);

736 
ow
 = 
	`Ùh”wh™e
(
g
);

737 
wh™e
 = 
	`luaC_wh™e
(
g
);

738 *
p
 !ğ
NULL
 && 
couÁ
-- > 0) {

739 
GCObjeù
 *
cu¼
 = *
p
;

740 
m¬ked
 = 
cu¼
->marked;

741 ià(
	`isd—dm
(
ow
, 
m¬ked
)) {

742 *
p
 = 
cu¼
->
Ãxt
;

743 
	`ä“obj
(
L
, 
cu¼
);

746 
cu¼
->
m¬ked
 = 
	`ÿ¡_by‹
((m¬ked & 
maskcŞÜs
è| 
wh™e
);

747 
p
 = &
cu¼
->
Ãxt
;

750  (*
p
 =ğ
NULL
) ? NULL :…;

751 
	}
}

757 
GCObjeù
 **
	$sw“±Şive
 (
lua_S‹
 *
L
, 
GCObjeù
 **
p
) {

758 
GCObjeù
 **
Şd
 = 
p
;

760 
p
 = 
	`sw“¶i¡
(
L
,…, 1);

761 } 
p
 =ğ
Şd
);

762  
p
;

763 
	}
}

777 
	$checkSizes
 (
lua_S‹
 *
L
, 
glob®_S‹
 *
g
) {

778 ià(
g
->
gckšd
 !ğ
KGC_EMERGENCY
) {

779 
l_mem
 
Şddebt
 = 
g
->
GCdebt
;

780 ià(
g
->
¡¹
.
nu£
 < g->¡¹.
size
 / 4)

781 
	`luaS_»size
(
L
, 
g
->
¡¹
.
size
 / 2);

782 
g
->
GCe¡im©e
 +ğg->
GCdebt
 - 
Şddebt
;

784 
	}
}

787 
GCObjeù
 *
	$ud©a2fš®ize
 (
glob®_S‹
 *
g
) {

788 
GCObjeù
 *
o
 = 
g
->
tobeâz
;

789 
	`lua_as£¹
(
	`tofš®ize
(
o
));

790 
g
->
tobeâz
 = 
o
->
Ãxt
;

791 
o
->
Ãxt
 = 
g
->
®lgc
;

792 
g
->
®lgc
 = 
o
;

793 
	`»£tb™
(
o
->
m¬ked
, 
FINALIZEDBIT
);

794 ià(
	`issw“µha£
(
g
))

795 
	`makewh™e
(
g
, 
o
);

796  
o
;

797 
	}
}

800 
	$dÙheÿÎ
 (
lua_S‹
 *
L
, *
ud
) {

801 
	`UNUSED
(
ud
);

802 
	`luaD_ÿÎnoy›ld
(
L
, L->
tİ
 - 2, 0);

803 
	}
}

806 
	$GCTM
 (
lua_S‹
 *
L
, 
´İag©“¼Üs
) {

807 
glob®_S‹
 *
g
 = 
	`G
(
L
);

808 cÚ¡ 
TV®ue
 *
tm
;

809 
TV®ue
 
v
;

810 
	`£tgcov®ue
(
L
, &
v
, 
	`ud©a2fš®ize
(
g
));

811 
tm
 = 
	`luaT_g‘tmbyobj
(
L
, &
v
, 
TM_GC
);

812 ià(
tm
 !ğ
NULL
 && 
	`‰isfunùiÚ
(tm)) {

813 
¡©us
;

814 
lu_by‹
 
Şdah
 = 
L
->
®lowhook
;

815 
ruÂšg
 = 
g
->
güuÂšg
;

816 
L
->
®lowhook
 = 0;

817 
g
->
güuÂšg
 = 0;

818 
	`£tobj2s
(
L
, L->
tİ
, 
tm
);

819 
	`£tobj2s
(
L
, L->
tİ
 + 1, &
v
);

820 
L
->
tİ
 += 2;

821 
L
->
ci
->
ÿÎ¡©us
 |ğ
CIST_FIN
;

822 
¡©us
 = 
	`luaD_pÿÎ
(
L
, 
dÙheÿÎ
, 
NULL
, 
	`§ve¡ack
(L, L->
tİ
 - 2), 0);

823 
L
->
ci
->
ÿÎ¡©us
 &ğ~
CIST_FIN
;

824 
L
->
®lowhook
 = 
Şdah
;

825 
g
->
güuÂšg
 = 
ruÂšg
;

826 ià(
¡©us
 !ğ
LUA_OK
 && 
´İag©“¼Üs
) {

827 ià(
¡©us
 =ğ
LUA_ERRRUN
) {

828 cÚ¡ *
msg
 = (
	`‰is¡ršg
(
L
->
tİ
 - 1))

829 ? 
	`sv®ue
(
L
->
tİ
 - 1)

831 
	`luaO_pushf¡ršg
(
L
, "”rÜ iÀ__gøm‘am‘hod (%s)", 
msg
);

832 
¡©us
 = 
LUA_ERRGCMM
;

834 
	`luaD_throw
(
L
, 
¡©us
);

837 
	}
}

843 
	$ruÇãwfš®iz”s
 (
lua_S‹
 *
L
) {

844 
glob®_S‹
 *
g
 = 
	`G
(
L
);

845 
i
;

846 
	`lua_as£¹
(!
g
->
tobeâz
 || g->
gcfšnum
 > 0);

847 
i
 = 0; 
g
->
tobeâz
 && i < g->
gcfšnum
; i++)

848 
	`GCTM
(
L
, 1);

849 
g
->
gcfšnum
 = (!g->
tobeâz
) ? 0

850 : 
g
->
gcfšnum
 * 2;

851  
i
;

852 
	}
}

858 
	$ÿÎ®Í’dšgfš®iz”s
 (
lua_S‹
 *
L
) {

859 
glob®_S‹
 *
g
 = 
	`G
(
L
);

860 
g
->
tobeâz
)

861 
	`GCTM
(
L
, 0);

862 
	}
}

868 
GCObjeù
 **
	$fšdÏ¡
 (
GCObjeù
 **
p
) {

869 *
p
 !ğ
NULL
)

870 
p
 = &(*p)->
Ãxt
;

871  
p
;

872 
	}
}

879 
	$£·¿‹tobeâz
 (
glob®_S‹
 *
g
, 
®l
) {

880 
GCObjeù
 *
cu¼
;

881 
GCObjeù
 **
p
 = &
g
->
fšobj
;

882 
GCObjeù
 **
Ï¡Ãxt
 = 
	`fšdÏ¡
(&
g
->
tobeâz
);

883 (
cu¼
 = *
p
è!ğ
NULL
) {

884 
	`lua_as£¹
(
	`tofš®ize
(
cu¼
));

885 ià(!(
	`iswh™e
(
cu¼
è|| 
®l
))

886 
p
 = &
cu¼
->
Ãxt
;

888 *
p
 = 
cu¼
->
Ãxt
;

889 
cu¼
->
Ãxt
 = *
Ï¡Ãxt
;

890 *
Ï¡Ãxt
 = 
cu¼
;

891 
Ï¡Ãxt
 = &
cu¼
->
Ãxt
;

894 
	}
}

901 
	$luaC_checkfš®iz”
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
, 
TabË
 *
mt
) {

902 
glob®_S‹
 *
g
 = 
	`G
(
L
);

903 ià(
	`tofš®ize
(
o
) ||

904 
	`gç¡tm
(
g
, 
mt
, 
TM_GC
è=ğ
NULL
)

907 
GCObjeù
 **
p
;

908 ià(
	`issw“µha£
(
g
)) {

909 
	`makewh™e
(
g
, 
o
);

910 ià(
g
->
sw“pgc
 =ğ&
o
->
Ãxt
)

911 
g
->
sw“pgc
 = 
	`sw“±Şive
(
L
, g->sweepgc);

914 
p
 = &
g
->
®lgc
; *°!ğ
o
;… = &(*p)->
Ãxt
) { }

915 *
p
 = 
o
->
Ãxt
;

916 
o
->
Ãxt
 = 
g
->
fšobj
;

917 
g
->
fšobj
 = 
o
;

918 
	`l_£tb™
(
o
->
m¬ked
, 
FINALIZEDBIT
);

920 
	}
}

939 
	$£au£
 (
glob®_S‹
 *
g
) {

940 
l_mem
 
th»shŞd
, 
debt
;

941 
l_mem
 
e¡im©e
 = 
g
->
GCe¡im©e
 / 
PAUSEADJ
;

942 
	`lua_as£¹
(
e¡im©e
 > 0);

943 
th»shŞd
 = (
g
->
gıau£
 < 
MAX_LMEM
 / 
e¡im©e
)

944 ? 
e¡im©e
 * 
g
->
gıau£


945 : 
MAX_LMEM
;

946 
debt
 = 
	`g‘tÙ®by‹s
(
g
è- 
th»shŞd
;

947 
	`luaE_£tdebt
(
g
, 
debt
);

948 
	}
}

958 
	$’‹rsw“p
 (
lua_S‹
 *
L
) {

959 
glob®_S‹
 *
g
 = 
	`G
(
L
);

960 
g
->
gc¡©e
 = 
GCSsw·Îgc
;

961 
	`lua_as£¹
(
g
->
sw“pgc
 =ğ
NULL
);

962 
g
->
sw“pgc
 = 
	`sw“¶i¡
(
L
, &g->
®lgc
, 1);

963 
	}
}

966 
	$luaC_ä“®lobjeùs
 (
lua_S‹
 *
L
) {

967 
glob®_S‹
 *
g
 = 
	`G
(
L
);

968 
	`£·¿‹tobeâz
(
g
, 1);

969 
	`lua_as£¹
(
g
->
fšobj
 =ğ
NULL
);

970 
	`ÿÎ®Í’dšgfš®iz”s
(
L
);

971 
	`lua_as£¹
(
g
->
tobeâz
 =ğ
NULL
);

972 
g
->
cu¼’twh™e
 = 
WHITEBITS
;

973 
g
->
gckšd
 = 
KGC_NORMAL
;

974 
	`sw“pwhŞ–i¡
(
L
, &
g
->
fšobj
);

975 
	`sw“pwhŞ–i¡
(
L
, &
g
->
®lgc
);

976 
	`sw“pwhŞ–i¡
(
L
, &
g
->
fixedgc
);

977 
	`lua_as£¹
(
g
->
¡¹
.
nu£
 == 0);

978 
	}
}

981 
l_mem
 
	$©omic
 (
lua_S‹
 *
L
) {

982 
glob®_S‹
 *
g
 = 
	`G
(
L
);

983 
l_mem
 
wÜk
;

984 
GCObjeù
 *
Üigw—k
, *
Üig®l
;

985 
GCObjeù
 *
g¿yagaš
 = 
g
->grayagain;

986 
	`lua_as£¹
(
g
->
•hem”Ú
 =ğ
NULL
 && g->
w—k
 == NULL);

987 
	`lua_as£¹
(!
	`iswh™e
(
g
->
mašth»ad
));

988 
g
->
gc¡©e
 = 
GCSšsid—tomic
;

989 
g
->
GCmemŒav
 = 0;

990 
	`m¬kobjeù
(
g
, 
L
);

992 
	`m¬kv®ue
(
g
, &g->
l_»gi¡ry
);

993 
	`m¬kmt
(
g
);

995 
	`»m¬kupv®s
(
g
);

996 
	`´İag©—Î
(
g
);

997 
wÜk
 = 
g
->
GCmemŒav
;

998 
g
->
g¿y
 = 
g¿yagaš
;

999 
	`´İag©—Î
(
g
);

1000 
g
->
GCmemŒav
 = 0;

1001 
	`cÚv”g“phem”Ús
(
g
);

1004 
	`ş—rv®ues
(
g
, g->
w—k
, 
NULL
);

1005 
	`ş—rv®ues
(
g
, g->
®lw—k
, 
NULL
);

1006 
Üigw—k
 = 
g
->
w—k
; 
Üig®l
 = g->
®lw—k
;

1007 
wÜk
 +ğ
g
->
GCmemŒav
;

1008 
	`£·¿‹tobeâz
(
g
, 0);

1009 
g
->
gcfšnum
 = 1;

1010 
	`m¬kbešgâz
(
g
);

1011 
	`´İag©—Î
(
g
);

1012 
g
->
GCmemŒav
 = 0;

1013 
	`cÚv”g“phem”Ús
(
g
);

1016 
	`ş—rkeys
(
g
, g->
•hem”Ú
, 
NULL
);

1017 
	`ş—rkeys
(
g
, g->
®lw—k
, 
NULL
);

1019 
	`ş—rv®ues
(
g
, g->
w—k
, 
Üigw—k
);

1020 
	`ş—rv®ues
(
g
, g->
®lw—k
, 
Üig®l
);

1021 
	`luaS_ş—rÿche
(
g
);

1022 
g
->
cu¼’twh™e
 = 
	`ÿ¡_by‹
(
	`Ùh”wh™e
(g));

1023 
wÜk
 +ğ
g
->
GCmemŒav
;

1024  
wÜk
;

1025 
	}
}

1028 
lu_mem
 
	$sw“p¡•
 (
lua_S‹
 *
L
, 
glob®_S‹
 *
g
,

1029 
Ãxt¡©e
, 
GCObjeù
 **
Ãxi¡
) {

1030 ià(
g
->
sw“pgc
) {

1031 
l_mem
 
Şddebt
 = 
g
->
GCdebt
;

1032 
g
->
sw“pgc
 = 
	`sw“¶i¡
(
L
, g->sw“pgc, 
GCSWEEPMAX
);

1033 
g
->
GCe¡im©e
 +ğg->
GCdebt
 - 
Şddebt
;

1034 ià(
g
->
sw“pgc
)

1035  (
GCSWEEPMAX
 * 
GCSWEEPCOST
);

1038 
g
->
gc¡©e
 = 
Ãxt¡©e
;

1039 
g
->
sw“pgc
 = 
Ãxi¡
;

1041 
	}
}

1044 
lu_mem
 
	$sšgË¡•
 (
lua_S‹
 *
L
) {

1045 
glob®_S‹
 *
g
 = 
	`G
(
L
);

1046 
g
->
gc¡©e
) {

1047 
GCS·u£
: {

1048 
g
->
GCmemŒav
 = g->
¡¹
.
size
 * (
GCObjeù
*);

1049 
	`»¡¬tcŞËùiÚ
(
g
);

1050 
g
->
gc¡©e
 = 
GCS´İag©e
;

1051  
g
->
GCmemŒav
;

1053 
GCS´İag©e
: {

1054 
g
->
GCmemŒav
 = 0;

1055 
	`lua_as£¹
(
g
->
g¿y
);

1056 
	`´İag©em¬k
(
g
);

1057 ià(
g
->
g¿y
 =ğ
NULL
)

1058 
g
->
gc¡©e
 = 
GCS©omic
;

1059  
g
->
GCmemŒav
;

1061 
GCS©omic
: {

1062 
lu_mem
 
wÜk
;

1063 
	`´İag©—Î
(
g
);

1064 
wÜk
 = 
	`©omic
(
L
);

1065 
	`’‹rsw“p
(
L
);

1066 
g
->
GCe¡im©e
 = 
	`g‘tÙ®by‹s
(g); ;

1067  
wÜk
;

1069 
GCSsw·Îgc
: {

1070  
	`sw“p¡•
(
L
, 
g
, 
GCSswpfšobj
, &g->
fšobj
);

1072 
GCSswpfšobj
: {

1073  
	`sw“p¡•
(
L
, 
g
, 
GCSsw±obeâz
, &g->
tobeâz
);

1075 
GCSsw±obeâz
: {

1076  
	`sw“p¡•
(
L
, 
g
, 
GCSsw³nd
, 
NULL
);

1078 
GCSsw³nd
: {

1079 
	`makewh™e
(
g
, g->
mašth»ad
);

1080 
	`checkSizes
(
L
, 
g
);

1081 
g
->
gc¡©e
 = 
GCSÿÎfš
;

1084 
GCSÿÎfš
: {

1085 ià(
g
->
tobeâz
 && g->
gckšd
 !ğ
KGC_EMERGENCY
) {

1086 
n
 = 
	`ruÇãwfš®iz”s
(
L
);

1087  (
n
 * 
GCFINALIZECOST
);

1090 
g
->
gc¡©e
 = 
GCS·u£
;

1094 : 
	`lua_as£¹
(0);  0;

1096 
	}
}

1103 
	$luaC_ruÁ¡©e
 (
lua_S‹
 *
L
, 
¡©esmask
) {

1104 
glob®_S‹
 *
g
 = 
	`G
(
L
);

1105 !
	`‹¡b™
(
¡©esmask
, 
g
->
gc¡©e
))

1106 
	`sšgË¡•
(
L
);

1107 
	}
}

1114 
l_mem
 
	$g‘debt
 (
glob®_S‹
 *
g
) {

1115 
l_mem
 
debt
 = 
g
->
GCdebt
;

1116 
¡•mul
 = 
g
->
gc¡•mul
;

1117 ià(
debt
 <= 0)  0;

1119 
debt
 = (debˆ/ 
STEPMULADJ
) + 1;

1120 
debt
 = (debˆ< 
MAX_LMEM
 / 
¡•mul
) ? debt * stepmul : MAX_LMEM;

1121  
debt
;

1123 
	}
}

1128 
	$luaC_¡•
 (
lua_S‹
 *
L
) {

1129 
glob®_S‹
 *
g
 = 
	`G
(
L
);

1130 
l_mem
 
debt
 = 
	`g‘debt
(
g
);

1131 ià(!
g
->
güuÂšg
) {

1132 
	`luaE_£tdebt
(
g
, -
GCSTEPSIZE
 * 10);

1136 
lu_mem
 
wÜk
 = 
	`sšgË¡•
(
L
);

1137 
debt
 -ğ
wÜk
;

1138 } 
debt
 > -
GCSTEPSIZE
 && 
g
->
gc¡©e
 !ğ
GCS·u£
);

1139 ià(
g
->
gc¡©e
 =ğ
GCS·u£
)

1140 
	`£au£
(
g
);

1142 
debt
 = (debˆ/ 
g
->
gc¡•mul
è* 
STEPMULADJ
;

1143 
	`luaE_£tdebt
(
g
, 
debt
);

1144 
	`ruÇãwfš®iz”s
(
L
);

1146 
	}
}

1158 
	$luaC_fuÎgc
 (
lua_S‹
 *
L
, 
i£m”g’cy
) {

1159 
glob®_S‹
 *
g
 = 
	`G
(
L
);

1160 
	`lua_as£¹
(
g
->
gckšd
 =ğ
KGC_NORMAL
);

1161 ià(
i£m”g’cy
è
g
->
gckšd
 = 
KGC_EMERGENCY
;

1162 ià(
	`k“pšv¬ŸÁ
(
g
)) {

1163 
	`’‹rsw“p
(
L
);

1166 
	`luaC_ruÁ¡©e
(
L
, 
	`b™mask
(
GCS·u£
));

1167 
	`luaC_ruÁ¡©e
(
L
, ~
	`b™mask
(
GCS·u£
));

1168 
	`luaC_ruÁ¡©e
(
L
, 
	`b™mask
(
GCSÿÎfš
));

1170 
	`lua_as£¹
(
g
->
GCe¡im©e
 =ğ
	`g‘tÙ®by‹s
(g));

1171 
	`luaC_ruÁ¡©e
(
L
, 
	`b™mask
(
GCS·u£
));

1172 
g
->
gckšd
 = 
KGC_NORMAL
;

1173 
	`£au£
(
g
);

1174 
	}
}

	@script/lua/lua-5.3.4/src/lgc.h

7 #iâdeà
lgc_h


8 
	#lgc_h


	)

11 
	~"lobjeù.h
"

12 
	~"l¡©e.h
"

30 #ià!
defšed
(
GCSTEPSIZE
)

32 
	#GCSTEPSIZE
 (
	`ÿ¡_št
(100 * (
TSŒšg
)))

	)

39 
	#GCS´İag©e
 0

	)

40 
	#GCS©omic
 1

	)

41 
	#GCSsw·Îgc
 2

	)

42 
	#GCSswpfšobj
 3

	)

43 
	#GCSsw±obeâz
 4

	)

44 
	#GCSsw³nd
 5

	)

45 
	#GCSÿÎfš
 6

	)

46 
	#GCS·u£
 7

	)

49 
	#issw“µha£
(
g
) \

50 (
GCSsw·Îgc
 <ğ(
g
)->
gc¡©e
 && (g)->gc¡©<ğ
GCSsw³nd
)

	)

61 
	#k“pšv¬ŸÁ
(
g
è((g)->
gc¡©e
 <ğ
GCS©omic
)

	)

67 
	#»£tb™s
(
x
,
m
è((xè&ğ
	`ÿ¡
(
lu_by‹
, ~(m)))

	)

68 
	#£tb™s
(
x
,
m
è((xè|ğ(m))

	)

69 
	#‹¡b™s
(
x
,
m
è((xè& (m))

	)

70 
	#b™mask
(
b
è(1<<(b))

	)

71 
	#b™2mask
(
b1
,
b2
è(
	`b™mask
(b1è| b™mask(b2))

	)

72 
	#l_£tb™
(
x
,
b
è
	`£tb™s
(x, 
	`b™mask
(b))

	)

73 
	#»£tb™
(
x
,
b
è
	`»£tb™s
(x, 
	`b™mask
(b))

	)

74 
	#‹¡b™
(
x
,
b
è
	`‹¡b™s
(x, 
	`b™mask
(b))

	)

78 
	#WHITE0BIT
 0

	)

79 
	#WHITE1BIT
 1

	)

80 
	#BLACKBIT
 2

	)

81 
	#FINALIZEDBIT
 3

	)

84 
	#WHITEBITS
 
	`b™2mask
(
WHITE0BIT
, 
WHITE1BIT
)

	)

87 
	#iswh™e
(
x
è
	`‹¡b™s
((x)->
m¬ked
, 
WHITEBITS
)

	)

88 
	#isbÏck
(
x
è
	`‹¡b™
((x)->
m¬ked
, 
BLACKBIT
)

	)

89 
	#isg¿y
(
x
) \

90 (!
	`‹¡b™s
((
x
)->
m¬ked
, 
WHITEBITS
 | 
	`b™mask
(
BLACKBIT
)))

	)

92 
	#tofš®ize
(
x
è
	`‹¡b™
((x)->
m¬ked
, 
FINALIZEDBIT
)

	)

94 
	#Ùh”wh™e
(
g
è((g)->
cu¼’twh™e
 ^ 
WHITEBITS
)

	)

95 
	#isd—dm
(
ow
,
m
è(!(((mè^ 
WHITEBITS
è& (ow)))

	)

96 
	#isd—d
(
g
,
v
è
	`isd—dm
(
	`Ùh”wh™e
(g), (v)->
m¬ked
)

	)

98 
	#chªgewh™e
(
x
è((x)->
m¬ked
 ^ğ
WHITEBITS
)

	)

99 
	#g¿y2bÏck
(
x
è
	`l_£tb™
((x)->
m¬ked
, 
BLACKBIT
)

	)

101 
	#luaC_wh™e
(
g
è
	`ÿ¡
(
lu_by‹
, (g)->
cu¼’twh™e
 & 
WHITEBITS
)

	)

110 
	#luaC_cÚdGC
(
L
,
´e
,
pos
) \

111 { ià(
	`G
(
L
)->
GCdebt
 > 0è{ 
´e
; 
	`luaC_¡•
(L); 
pos
;}; \

112 
	`cÚdchªgemem
(
L
,
´e
,
pos
); }

	)

115 
	#luaC_checkGC
(
L
è
	`luaC_cÚdGC
(L,()0,()0)

	)

118 
	#luaC_b¬r›r
(
L
,
p
,
v
) ( \

119 (
	`iscŞËùabË
(
v
è&& 
	`isbÏck
(
p
è&& 
	`iswh™e
(
	`gcv®ue
(v))) ? \

120 
	`luaC_b¬r›r_
(
L
,
	`obj2gco
(
p
),
	`gcv®ue
(
v
)è: 
	`ÿ¡_void
(0))

	)

122 
	#luaC_b¬r›rback
(
L
,
p
,
v
) ( \

123 (
	`iscŞËùabË
(
v
è&& 
	`isbÏck
(
p
è&& 
	`iswh™e
(
	`gcv®ue
(v))) ? \

124 
	`luaC_b¬r›rback_
(
L
,
p
è: 
	`ÿ¡_void
(0))

	)

126 
	#luaC_objb¬r›r
(
L
,
p
,
o
) ( \

127 (
	`isbÏck
(
p
è&& 
	`iswh™e
(
o
)) ? \

128 
	`luaC_b¬r›r_
(
L
,
	`obj2gco
(
p
),obj2gco(
o
)è: 
	`ÿ¡_void
(0))

	)

130 
	#luaC_upv®b¬r›r
(
L
,
uv
) ( \

131 (
	`iscŞËùabË
((
uv
)->
v
è&& !
	`upisİ’
(uv)) ? \

132 
	`luaC_upv®b¬r›r_
(
L
,
uv
è: 
	`ÿ¡_void
(0))

	)

134 
LUAI_FUNC
 
luaC_fix
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
);

135 
LUAI_FUNC
 
luaC_ä“®lobjeùs
 (
lua_S‹
 *
L
);

136 
LUAI_FUNC
 
luaC_¡•
 (
lua_S‹
 *
L
);

137 
LUAI_FUNC
 
luaC_ruÁ¡©e
 (
lua_S‹
 *
L
, 
¡©esmask
);

138 
LUAI_FUNC
 
luaC_fuÎgc
 (
lua_S‹
 *
L
, 
i£m”g’cy
);

139 
LUAI_FUNC
 
GCObjeù
 *
luaC_Ãwobj
 (
lua_S‹
 *
L
, 
‰
, 
size_t
 
sz
);

140 
LUAI_FUNC
 
luaC_b¬r›r_
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
, GCObjeù *
v
);

141 
LUAI_FUNC
 
luaC_b¬r›rback_
 (
lua_S‹
 *
L
, 
TabË
 *
o
);

142 
LUAI_FUNC
 
luaC_upv®b¬r›r_
 (
lua_S‹
 *
L
, 
UpV®
 *
uv
);

143 
LUAI_FUNC
 
luaC_checkfš®iz”
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
, 
TabË
 *
mt
);

144 
LUAI_FUNC
 
luaC_upvdeccouÁ
 (
lua_S‹
 *
L
, 
UpV®
 *
uv
);

	@script/lua/lua-5.3.4/src/linit.c

8 
	#lš™_c


	)

9 
	#LUA_LIB


	)

27 
	~"Í»fix.h
"

30 
	~<¡ddef.h
>

32 
	~"lua.h
"

34 
	~"lu®ib.h
"

35 
	~"Ïuxlib.h
"

42 cÚ¡ 
luaL_Reg
 
	glßdedlibs
[] = {

43 {"_G", 
luaİ’_ba£
},

44 {
LUA_LOADLIBNAME
, 
luaİ’_·ckage
},

45 {
LUA_COLIBNAME
, 
luaİ’_cÜoutše
},

46 {
LUA_TABLIBNAME
, 
luaİ’_bË
},

47 {
LUA_IOLIBNAME
, 
luaİ’_io
},

48 {
LUA_OSLIBNAME
, 
luaİ’_os
},

49 {
LUA_STRLIBNAME
, 
luaİ’_¡ršg
},

50 {
LUA_MATHLIBNAME
, 
luaİ’_m©h
},

51 {
LUA_UTF8LIBNAME
, 
luaİ’_utf8
},

52 {
LUA_DBLIBNAME
, 
luaİ’_debug
},

53 #ià
defšed
(
LUA_COMPAT_BITLIB
)

54 {
LUA_BITLIBNAME
, 
luaİ’_b™32
},

56 {
NULL
, NULL}

60 
LUALIB_API
 
	$luaL_İ’libs
 (
lua_S‹
 *
L
) {

61 cÚ¡ 
luaL_Reg
 *
lib
;

63 
lib
 = 
lßdedlibs
;†ib->
func
;†ib++) {

64 
	`luaL_»quœef
(
L
, 
lib
->
Çme
,†ib->
func
, 1);

65 
	`lua_pİ
(
L
, 1);

67 
	}
}

	@script/lua/lua-5.3.4/src/liolib.c

7 
	#liŞib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<ùy³.h
>

14 
	~<”ºo.h
>

15 
	~<loÿË.h
>

16 
	~<¡dio.h
>

17 
	~<¡dlib.h
>

18 
	~<¡ršg.h
>

20 
	~"lua.h
"

22 
	~"Ïuxlib.h
"

23 
	~"lu®ib.h
"

32 #ià!
defšed
(
l_checkmode
)

35 #ià!
defšed
(
L_MODEEXT
)

36 
	#L_MODEEXT
 "b"

	)

40 
	$l_checkmode
 (cÚ¡ *
mode
) {

41  (*
mode
 !ğ'\0' && 
	`¡rchr
("rwa", *(mode++)è!ğ
NULL
 &&

42 (*
mode
 != '+' || (++mode, 1)) &&

43 (
	`¡r¥n
(
mode
, 
L_MODEEXT
è=ğ
	`¡¾’
(mode)));

44 
	}
}

55 #ià!
defšed
(
l_pİ’
)

57 #ià
defšed
(
LUA_USE_POSIX
)

59 
	#l_pİ’
(
L
,
c
,
m
è(
	`fæush
(
NULL
), 
	`pİ’
(c,m))

	)

60 
	#l_pşo£
(
L
,
fe
è(
	`pşo£
(fe))

	)

62 #–ià
defšed
(
LUA_USE_WINDOWS
)

64 
	#l_pİ’
(
L
,
c
,
m
è(
	`_pİ’
(c,m))

	)

65 
	#l_pşo£
(
L
,
fe
è(
	`_pşo£
(fe))

	)

70 
	#l_pİ’
(
L
,
c
,
m
) \

71 (()(()
c
, 
m
), \

72 
	`luaL_”rÜ
(
L
, "'popen'‚ot supported"), \

73 (
FILE
*)0)

	)

74 
	#l_pşo£
(
L
,
fe
è(()L, ()fe, -1)

	)

83 #ià!
defšed
(
l_g‘c
)

85 #ià
defšed
(
LUA_USE_POSIX
)

86 
	#l_g‘c
(
f
è
	`g‘c_uÆocked
(f)

	)

87 
	#l_lockfe
(
f
è
	`æockfe
(f)

	)

88 
	#l_uÆockfe
(
f
è
	`fuÆockfe
(f)

	)

90 
	#l_g‘c
(
f
è
	`g‘c
(f)

	)

91 
	#l_lockfe
(
f
è(()0)

	)

92 
	#l_uÆockfe
(
f
è(()0)

	)

104 #ià!
defšed
(
l_f£ek
)

106 #ià
defšed
(
LUA_USE_POSIX
)

108 
	~<sys/ty³s.h
>

110 
	#l_f£ek
(
f
,
o
,
w
è
	`f£eko
(f,o,w)

	)

111 
	#l_á–l
(
f
è
	`á–lo
(f)

	)

112 
	#l_£eknum
 
off_t


	)

114 #–ià
defšed
(
LUA_USE_WINDOWS
è&& !defšed(
_CRTIMP_TYPEINFO
) \

115 && 
defšed
(
_MSC_VER
è&& (
	g_MSC_VER
 >= 1400)

118 
	#l_f£ek
(
f
,
o
,
w
è
	`_f£eki64
(f,o,w)

	)

119 
	#l_á–l
(
f
è
	`_á–li64
(f)

	)

120 
	#l_£eknum
 
__št64


	)

125 
	#l_f£ek
(
f
,
o
,
w
è
	`f£ek
(f,o,w)

	)

126 
	#l_á–l
(
f
è
	`á–l
(f)

	)

127 
	#l_£eknum
 

	)

136 
	#IO_PREFIX
 "_IO_"

	)

137 
	#IOPREF_LEN
 ((
IO_PREFIX
)/(è- 1)

	)

138 
	#IO_INPUT
 (
IO_PREFIX
 "šput")

	)

139 
	#IO_OUTPUT
 (
IO_PREFIX
 "ouut")

	)

142 
luaL_SŒ—m
 
	tLSŒ—m
;

145 
	#tŞ¡»am
(
L
è((
LSŒ—m
 *)
	`luaL_checkud©a
(L, 1, 
LUA_FILEHANDLE
))

	)

147 
	#isşo£d
(
p
è(Õ)->
şo£f
 =ğ
NULL
)

	)

150 
	$io_ty³
 (
lua_S‹
 *
L
) {

151 
LSŒ—m
 *
p
;

152 
	`luaL_checkªy
(
L
, 1);

153 
p
 = (
LSŒ—m
 *)
	`luaL_‹¡ud©a
(
L
, 1, 
LUA_FILEHANDLE
);

154 ià(
p
 =ğ
NULL
)

155 
	`lua_pushn
(
L
);

156 ià(
	`isşo£d
(
p
))

157 
	`lua_pushl™”®
(
L
, "closed file");

159 
	`lua_pushl™”®
(
L
, "file");

161 
	}
}

164 
	$f_to¡ršg
 (
lua_S‹
 *
L
) {

165 
LSŒ—m
 *
p
 = 
	`tŞ¡»am
(
L
);

166 ià(
	`isşo£d
(
p
))

167 
	`lua_pushl™”®
(
L
, "file (closed)");

169 
	`lua_pushf¡ršg
(
L
, "f(%p)", 
p
->
f
);

171 
	}
}

174 
FILE
 *
	$tofe
 (
lua_S‹
 *
L
) {

175 
LSŒ—m
 *
p
 = 
	`tŞ¡»am
(
L
);

176 ià(
	`isşo£d
(
p
))

177 
	`luaL_”rÜ
(
L
, "attempto use‡ closed file");

178 
	`lua_as£¹
(
p
->
f
);

179  
p
->
f
;

180 
	}
}

188 
LSŒ—m
 *
	$Ãw´efe
 (
lua_S‹
 *
L
) {

189 
LSŒ—m
 *
p
 = (LSŒ—m *)
	`lua_Ãwu£rd©a
(
L
, (LStream));

190 
p
->
şo£f
 = 
NULL
;

191 
	`luaL_£tm‘©abË
(
L
, 
LUA_FILEHANDLE
);

192  
p
;

193 
	}
}

201 
	$aux_şo£
 (
lua_S‹
 *
L
) {

202 
LSŒ—m
 *
p
 = 
	`tŞ¡»am
(
L
);

203 vŞ©
lua_CFunùiÚ
 
cf
 = 
p
->
şo£f
;

204 
p
->
şo£f
 = 
NULL
;

205  (*
cf
)(
L
);

206 
	}
}

209 
	$io_şo£
 (
lua_S‹
 *
L
) {

210 ià(
	`lua_i¢Úe
(
L
, 1))

211 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
IO_OUTPUT
);

212 
	`tofe
(
L
);

213  
	`aux_şo£
(
L
);

214 
	}
}

217 
	$f_gc
 (
lua_S‹
 *
L
) {

218 
LSŒ—m
 *
p
 = 
	`tŞ¡»am
(
L
);

219 ià(!
	`isşo£d
(
p
è&&…->
f
 !ğ
NULL
)

220 
	`aux_şo£
(
L
);

222 
	}
}

228 
	$io_fşo£
 (
lua_S‹
 *
L
) {

229 
LSŒ—m
 *
p
 = 
	`tŞ¡»am
(
L
);

230 
»s
 = 
	`fşo£
(
p
->
f
);

231  
	`luaL_f”esuÉ
(
L
, (
»s
 =ğ0), 
NULL
);

232 
	}
}

235 
LSŒ—m
 *
	$Ãwfe
 (
lua_S‹
 *
L
) {

236 
LSŒ—m
 *
p
 = 
	`Ãw´efe
(
L
);

237 
p
->
f
 = 
NULL
;

238 
p
->
şo£f
 = &
io_fşo£
;

239  
p
;

240 
	}
}

243 
	$İ’check
 (
lua_S‹
 *
L
, cÚ¡ *
âame
, cÚ¡ *
mode
) {

244 
LSŒ—m
 *
p
 = 
	`Ãwfe
(
L
);

245 
p
->
f
 = 
	`fİ’
(
âame
, 
mode
);

246 ià(
p
->
f
 =ğ
NULL
)

247 
	`luaL_”rÜ
(
L
, "ÿÂÙ o³Àf'%s' (%s)", 
âame
, 
	`¡»¼Ü
(
”ºo
));

248 
	}
}

251 
	$io_İ’
 (
lua_S‹
 *
L
) {

252 cÚ¡ *
f’ame
 = 
	`luaL_check¡ršg
(
L
, 1);

253 cÚ¡ *
mode
 = 
	`luaL_İt¡ršg
(
L
, 2, "r");

254 
LSŒ—m
 *
p
 = 
	`Ãwfe
(
L
);

255 cÚ¡ *
md
 = 
mode
;

256 
	`luaL_¬gcheck
(
L
, 
	`l_checkmode
(
md
), 2, "invalid mode");

257 
p
->
f
 = 
	`fİ’
(
f’ame
, 
mode
);

258  (
p
->
f
 =ğ
NULL
è? 
	`luaL_f”esuÉ
(
L
, 0, 
f’ame
) : 1;

259 
	}
}

265 
	$io_pşo£
 (
lua_S‹
 *
L
) {

266 
LSŒ—m
 *
p
 = 
	`tŞ¡»am
(
L
);

267  
	`luaL_exeüesuÉ
(
L
, 
	`l_pşo£
(L, 
p
->
f
));

268 
	}
}

271 
	$io_pİ’
 (
lua_S‹
 *
L
) {

272 cÚ¡ *
f’ame
 = 
	`luaL_check¡ršg
(
L
, 1);

273 cÚ¡ *
mode
 = 
	`luaL_İt¡ršg
(
L
, 2, "r");

274 
LSŒ—m
 *
p
 = 
	`Ãw´efe
(
L
);

275 
p
->
f
 = 
	`l_pİ’
(
L
, 
f’ame
, 
mode
);

276 
p
->
şo£f
 = &
io_pşo£
;

277  (
p
->
f
 =ğ
NULL
è? 
	`luaL_f”esuÉ
(
L
, 0, 
f’ame
) : 1;

278 
	}
}

281 
	$io_tmpfe
 (
lua_S‹
 *
L
) {

282 
LSŒ—m
 *
p
 = 
	`Ãwfe
(
L
);

283 
p
->
f
 = 
	`tmpfe
();

284  (
p
->
f
 =ğ
NULL
è? 
	`luaL_f”esuÉ
(
L
, 0, NULL) : 1;

285 
	}
}

288 
FILE
 *
	$g‘iofe
 (
lua_S‹
 *
L
, cÚ¡ *
fšdex
) {

289 
LSŒ—m
 *
p
;

290 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
fšdex
);

291 
p
 = (
LSŒ—m
 *)
	`lua_tou£rd©a
(
L
, -1);

292 ià(
	`isşo£d
(
p
))

293 
	`luaL_”rÜ
(
L
, "¡ªd¬d % fi şo£d", 
fšdex
 + 
IOPREF_LEN
);

294  
p
->
f
;

295 
	}
}

298 
	$g_iofe
 (
lua_S‹
 *
L
, cÚ¡ *
f
, cÚ¡ *
mode
) {

299 ià(!
	`lua_i¢ÚeÜn
(
L
, 1)) {

300 cÚ¡ *
f’ame
 = 
	`lua_to¡ršg
(
L
, 1);

301 ià(
f’ame
)

302 
	`İ’check
(
L
, 
f’ame
, 
mode
);

304 
	`tofe
(
L
);

305 
	`lua_pushv®ue
(
L
, 1);

307 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, 
f
);

310 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
f
);

312 
	}
}

315 
	$io_šput
 (
lua_S‹
 *
L
) {

316  
	`g_iofe
(
L
, 
IO_INPUT
, "r");

317 
	}
}

320 
	$io_ouut
 (
lua_S‹
 *
L
) {

321  
	`g_iofe
(
L
, 
IO_OUTPUT
, "w");

322 
	}
}

325 
io_»adlše
 (
lua_S‹
 *
L
);

332 
	#MAXARGLINE
 250

	)

334 
	$aux_lšes
 (
lua_S‹
 *
L
, 
toşo£
) {

335 
n
 = 
	`lua_g‘tİ
(
L
) - 1;

336 
	`luaL_¬gcheck
(
L
, 
n
 <ğ
MAXARGLINE
, MAXARGLINE + 2, "too many‡rguments");

337 
	`lua_pushš‹g”
(
L
, 
n
);

338 
	`lua_pushboŞ—n
(
L
, 
toşo£
);

339 
	`lua_rÙ©e
(
L
, 2, 2);

340 
	`lua_pushcşosu»
(
L
, 
io_»adlše
, 3 + 
n
);

341 
	}
}

344 
	$f_lšes
 (
lua_S‹
 *
L
) {

345 
	`tofe
(
L
);

346 
	`aux_lšes
(
L
, 0);

348 
	}
}

351 
	$io_lšes
 (
lua_S‹
 *
L
) {

352 
toşo£
;

353 ià(
	`lua_i¢Úe
(
L
, 1)è
	`lua_pushn
(L);

354 ià(
	`lua_i¢
(
L
, 1)) {

355 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
IO_INPUT
);

356 
	`lua_»¶aû
(
L
, 1);

357 
	`tofe
(
L
);

358 
toşo£
 = 0;

361 cÚ¡ *
f’ame
 = 
	`luaL_check¡ršg
(
L
, 1);

362 
	`İ’check
(
L
, 
f’ame
, "r");

363 
	`lua_»¶aû
(
L
, 1);

364 
toşo£
 = 1;

366 
	`aux_lšes
(
L
, 
toşo£
);

368 
	}
}

379 #ià!
defšed
 (
L_MAXLENNUM
)

380 
	#L_MAXLENNUM
 200

	)

386 
FILE
 *
	mf
;

387 
	mc
;

388 
	mn
;

389 
	mbuff
[
L_MAXLENNUM
 + 1];

390 } 
	tRN
;

396 
	$Ãxtc
 (
RN
 *
º
) {

397 ià(
º
->
n
 >ğ
L_MAXLENNUM
) {

398 
º
->
buff
[0] = '\0';

402 
º
->
buff
[º->
n
++] =„n->
c
;

403 
º
->
c
 = 
	`l_g‘c
Ôn->
f
);

406 
	}
}

412 
	$‹¡2
 (
RN
 *
º
, cÚ¡ *
£t
) {

413 ià(
º
->
c
 =ğ
£t
[0] ||„n->c == set[1])

414  
	`Ãxtc
(
º
);

416 
	}
}

422 
	$»addig™s
 (
RN
 *
º
, 
hex
) {

423 
couÁ
 = 0;

424 (
hex
 ? 
	`isxdig™
(
º
->
c
è: 
	`isdig™
Ôn->c)è&& 
	`Ãxtc
(rn))

425 
couÁ
++;

426  
couÁ
;

427 
	}
}

435 
	$»ad_numb”
 (
lua_S‹
 *
L
, 
FILE
 *
f
) {

436 
RN
 
º
;

437 
couÁ
 = 0;

438 
hex
 = 0;

439 
deı
[2];

440 
º
.
f
 = f;„n.
n
 = 0;

441 
deı
[0] = 
	`lua_g‘loÿËdeıošt
();

442 
deı
[1] = '.';

443 
	`l_lockfe
(
º
.
f
);

444 dØ{ 
º
.
c
 = 
	`l_g‘c
Ôn.
f
); } 
	`is¥aû
(rn.c));

445 
	`‹¡2
(&
º
, "-+");

446 ià(
	`‹¡2
(&
º
, "00")) {

447 ià(
	`‹¡2
(&
º
, "xX")è
hex
 = 1;

448 
couÁ
 = 1;

450 
couÁ
 +ğ
	`»addig™s
(&
º
, 
hex
);

451 ià(
	`‹¡2
(&
º
, 
deı
))

452 
couÁ
 +ğ
	`»addig™s
(&
º
, 
hex
);

453 ià(
couÁ
 > 0 && 
	`‹¡2
(&
º
, (
hex
 ? "pP" : "eE"))) {

454 
	`‹¡2
(&
º
, "-+");

455 
	`»addig™s
(&
º
, 0);

457 
	`ung‘c
(
º
.
c
,„n.
f
);

458 
	`l_uÆockfe
(
º
.
f
);

459 
º
.
buff
[º.
n
] = '\0';

460 ià(
	`lua_¡ršgtÚumb”
(
L
, 
º
.
buff
))

463 
	`lua_pushn
(
L
);

466 
	}
}

469 
	$‹¡_eof
 (
lua_S‹
 *
L
, 
FILE
 *
f
) {

470 
c
 = 
	`g‘c
(
f
);

471 
	`ung‘c
(
c
, 
f
);

472 
	`lua_pushl™”®
(
L
, "");

473  (
c
 !ğ
EOF
);

474 
	}
}

477 
	$»ad_lše
 (
lua_S‹
 *
L
, 
FILE
 *
f
, 
chİ
) {

478 
luaL_Bufãr
 
b
;

479 
c
 = '\0';

480 
	`luaL_buffš™
(
L
, &
b
);

481 
c
 !ğ
EOF
 && c != '\n') {

482 *
buff
 = 
	`luaL_´•bufãr
(&
b
);

483 
i
 = 0;

484 
	`l_lockfe
(
f
);

485 
i
 < 
LUAL_BUFFERSIZE
 && (
c
 = 
	`l_g‘c
(
f
)è!ğ
EOF
 && c != '\n')

486 
buff
[
i
++] = 
c
;

487 
	`l_uÆockfe
(
f
);

488 
	`luaL_addsize
(&
b
, 
i
);

490 ià(!
chİ
 && 
c
 == '\n')

491 
	`luaL_addch¬
(&
b
, 
c
);

492 
	`luaL_push»suÉ
(&
b
);

494  (
c
 =ğ'\n' || 
	`lua_¿wËn
(
L
, -1) > 0);

495 
	}
}

498 
	$»ad_®l
 (
lua_S‹
 *
L
, 
FILE
 *
f
) {

499 
size_t
 
Ä
;

500 
luaL_Bufãr
 
b
;

501 
	`luaL_buffš™
(
L
, &
b
);

503 *
p
 = 
	`luaL_´•bufãr
(&
b
);

504 
Ä
 = 
	`ä—d
(
p
, (), 
LUAL_BUFFERSIZE
, 
f
);

505 
	`luaL_addsize
(&
b
, 
Ä
);

506 } 
Ä
 =ğ
LUAL_BUFFERSIZE
);

507 
	`luaL_push»suÉ
(&
b
);

508 
	}
}

511 
	$»ad_ch¬s
 (
lua_S‹
 *
L
, 
FILE
 *
f
, 
size_t
 
n
) {

512 
size_t
 
Ä
;

513 *
p
;

514 
luaL_Bufãr
 
b
;

515 
	`luaL_buffš™
(
L
, &
b
);

516 
p
 = 
	`luaL_´•buffsize
(&
b
, 
n
);

517 
Ä
 = 
	`ä—d
(
p
, (), 
n
, 
f
);

518 
	`luaL_addsize
(&
b
, 
Ä
);

519 
	`luaL_push»suÉ
(&
b
);

520  (
Ä
 > 0);

521 
	}
}

524 
	$g_»ad
 (
lua_S‹
 *
L
, 
FILE
 *
f
, 
fœ¡
) {

525 
Çrgs
 = 
	`lua_g‘tİ
(
L
) - 1;

526 
sucûss
;

527 
n
;

528 
	`ş—»¼
(
f
);

529 ià(
Çrgs
 == 0) {

530 
sucûss
 = 
	`»ad_lše
(
L
, 
f
, 1);

531 
n
 = 
fœ¡
+1;

534 
	`luaL_check¡ack
(
L
, 
Çrgs
+
LUA_MINSTACK
, "too many‡rguments");

535 
sucûss
 = 1;

536 
n
 = 
fœ¡
; 
Çrgs
-- && 
sucûss
;‚++) {

537 ià(
	`lua_ty³
(
L
, 
n
è=ğ
LUA_TNUMBER
) {

538 
size_t
 
l
 = (size_t)
	`luaL_checkš‹g”
(
L
, 
n
);

539 
sucûss
 = (
l
 =ğ0è? 
	`‹¡_eof
(
L
, 
f
è: 
	`»ad_ch¬s
(L, f,†);

542 cÚ¡ *
p
 = 
	`luaL_check¡ršg
(
L
, 
n
);

543 ià(*
p
 == '*')…++;

544 *
p
) {

546 
sucûss
 = 
	`»ad_numb”
(
L
, 
f
);

549 
sucûss
 = 
	`»ad_lše
(
L
, 
f
, 1);

552 
sucûss
 = 
	`»ad_lše
(
L
, 
f
, 0);

555 
	`»ad_®l
(
L
, 
f
);

556 
sucûss
 = 1;

559  
	`luaL_¬g”rÜ
(
L
, 
n
, "invalid format");

564 ià(
	`ã¼Ü
(
f
))

565  
	`luaL_f”esuÉ
(
L
, 0, 
NULL
);

566 ià(!
sucûss
) {

567 
	`lua_pİ
(
L
, 1);

568 
	`lua_pushn
(
L
);

570  
n
 - 
fœ¡
;

571 
	}
}

574 
	$io_»ad
 (
lua_S‹
 *
L
) {

575  
	`g_»ad
(
L
, 
	`g‘iofe
(L, 
IO_INPUT
), 1);

576 
	}
}

579 
	$f_»ad
 (
lua_S‹
 *
L
) {

580  
	`g_»ad
(
L
, 
	`tofe
(L), 2);

581 
	}
}

584 
	$io_»adlše
 (
lua_S‹
 *
L
) {

585 
LSŒ—m
 *
p
 = (LSŒ—m *)
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

586 
i
;

587 
n
 = ()
	`lua_toš‹g”
(
L
, 
	`lua_upv®uešdex
(2));

588 ià(
	`isşo£d
(
p
))

589  
	`luaL_”rÜ
(
L
, "file is‡lready closed");

590 
	`lua_£‰İ
(
L
 , 1);

591 
	`luaL_check¡ack
(
L
, 
n
, "too many‡rguments");

592 
i
 = 1; i <ğ
n
; i++)

593 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(3 + 
i
));

594 
n
 = 
	`g_»ad
(
L
, 
p
->
f
, 2);

595 
	`lua_as£¹
(
n
 > 0);

596 ià(
	`lua_toboŞ—n
(
L
, -
n
))

597  
n
;

599 ià(
n
 > 1) {

601  
	`luaL_”rÜ
(
L
, "%s", 
	`lua_to¡ršg
(L, -
n
 + 1));

603 ià(
	`lua_toboŞ—n
(
L
, 
	`lua_upv®uešdex
(3))) {

604 
	`lua_£‰İ
(
L
, 0);

605 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(1));

606 
	`aux_şo£
(
L
);

610 
	}
}

615 
	$g_wr™e
 (
lua_S‹
 *
L
, 
FILE
 *
f
, 
¬g
) {

616 
Çrgs
 = 
	`lua_g‘tİ
(
L
è- 
¬g
;

617 
¡©us
 = 1;

618 ; 
Çrgs
--; 
¬g
++) {

619 ià(
	`lua_ty³
(
L
, 
¬g
è=ğ
LUA_TNUMBER
) {

621 
Ën
 = 
	`lua_isš‹g”
(
L
, 
¬g
)

622 ? 
	`årštf
(
f
, 
LUA_INTEGER_FMT
,

623 (
LUAI_UACINT
)
	`lua_toš‹g”
(
L
, 
¬g
))

624 : 
	`årštf
(
f
, 
LUA_NUMBER_FMT
,

625 (
LUAI_UACNUMBER
)
	`lua_tÚumb”
(
L
, 
¬g
));

626 
¡©us
 = stu && (
Ën
 > 0);

629 
size_t
 
l
;

630 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 
¬g
, &
l
);

631 
¡©us
 = stu && (
	`fwr™e
(
s
, (), 
l
, 
f
) ==†);

634 ià(
¡©us
)  1;

635  
	`luaL_f”esuÉ
(
L
, 
¡©us
, 
NULL
);

636 
	}
}

639 
	$io_wr™e
 (
lua_S‹
 *
L
) {

640  
	`g_wr™e
(
L
, 
	`g‘iofe
(L, 
IO_OUTPUT
), 1);

641 
	}
}

644 
	$f_wr™e
 (
lua_S‹
 *
L
) {

645 
FILE
 *
f
 = 
	`tofe
(
L
);

646 
	`lua_pushv®ue
(
L
, 1);

647  
	`g_wr™e
(
L
, 
f
, 2);

648 
	}
}

651 
	$f_£ek
 (
lua_S‹
 *
L
) {

652 cÚ¡ 
mode
[] = {
SEEK_SET
, 
SEEK_CUR
, 
SEEK_END
};

653 cÚ¡ *cÚ¡ 
mod’ames
[] = {"£t", "cur", "’d", 
NULL
};

654 
FILE
 *
f
 = 
	`tofe
(
L
);

655 
İ
 = 
	`luaL_checkİtiÚ
(
L
, 2, "cur", 
mod’ames
);

656 
lua_IÁeg”
 
p3
 = 
	`luaL_İtš‹g”
(
L
, 3, 0);

657 
l_£eknum
 
off£t
 = (l_£eknum)
p3
;

658 
	`luaL_¬gcheck
(
L
, (
lua_IÁeg”
)
off£t
 =ğ
p3
, 3,

660 
İ
 = 
	`l_f£ek
(
f
, 
off£t
, 
mode
[op]);

661 ià(
İ
)

662  
	`luaL_f”esuÉ
(
L
, 0, 
NULL
);

664 
	`lua_pushš‹g”
(
L
, (
lua_IÁeg”
)
	`l_á–l
(
f
));

667 
	}
}

670 
	$f_£tvbuf
 (
lua_S‹
 *
L
) {

671 cÚ¡ 
mode
[] = {
_IONBF
, 
_IOFBF
, 
_IOLBF
};

672 cÚ¡ *cÚ¡ 
mod’ames
[] = {"no", "fuÎ", "lše", 
NULL
};

673 
FILE
 *
f
 = 
	`tofe
(
L
);

674 
İ
 = 
	`luaL_checkİtiÚ
(
L
, 2, 
NULL
, 
mod’ames
);

675 
lua_IÁeg”
 
sz
 = 
	`luaL_İtš‹g”
(
L
, 3, 
LUAL_BUFFERSIZE
);

676 
»s
 = 
	`£tvbuf
(
f
, 
NULL
, 
mode
[
İ
], (
size_t
)
sz
);

677  
	`luaL_f”esuÉ
(
L
, 
»s
 =ğ0, 
NULL
);

678 
	}
}

682 
	$io_æush
 (
lua_S‹
 *
L
) {

683  
	`luaL_f”esuÉ
(
L
, 
	`fæush
(
	`g‘iofe
(L, 
IO_OUTPUT
)è=ğ0, 
NULL
);

684 
	}
}

687 
	$f_æush
 (
lua_S‹
 *
L
) {

688  
	`luaL_f”esuÉ
(
L
, 
	`fæush
(
	`tofe
(L)è=ğ0, 
NULL
);

689 
	}
}

695 cÚ¡ 
luaL_Reg
 
	giŞib
[] = {

696 {"şo£", 
io_şo£
},

697 {"æush", 
io_æush
},

698 {"šput", 
io_šput
},

699 {"lšes", 
io_lšes
},

700 {"İ’", 
io_İ’
},

701 {"ouut", 
io_ouut
},

702 {"pİ’", 
io_pİ’
},

703 {"»ad", 
io_»ad
},

704 {"tmpfe", 
io_tmpfe
},

705 {"ty³", 
io_ty³
},

706 {"wr™e", 
io_wr™e
},

707 {
NULL
, NULL}

714 cÚ¡ 
luaL_Reg
 
	gæib
[] = {

715 {"şo£", 
io_şo£
},

716 {"æush", 
f_æush
},

717 {"lšes", 
f_lšes
},

718 {"»ad", 
f_»ad
},

719 {"£ek", 
f_£ek
},

720 {"£tvbuf", 
f_£tvbuf
},

721 {"wr™e", 
f_wr™e
},

722 {"__gc", 
f_gc
},

723 {"__to¡ršg", 
f_to¡ršg
},

724 {
NULL
, NULL}

728 
	$ü—‹m‘a
 (
lua_S‹
 *
L
) {

729 
	`luaL_Ãwm‘©abË
(
L
, 
LUA_FILEHANDLE
);

730 
	`lua_pushv®ue
(
L
, -1);

731 
	`lua_£tf›ld
(
L
, -2, "__index");

732 
	`luaL_£tfuncs
(
L
, 
æib
, 0);

733 
	`lua_pİ
(
L
, 1);

734 
	}
}

740 
	$io_noşo£
 (
lua_S‹
 *
L
) {

741 
LSŒ—m
 *
p
 = 
	`tŞ¡»am
(
L
);

742 
p
->
şo£f
 = &
io_noşo£
;

743 
	`lua_pushn
(
L
);

744 
	`lua_pushl™”®
(
L
, "cannot close standard file");

746 
	}
}

749 
	$ü—‹¡dfe
 (
lua_S‹
 *
L
, 
FILE
 *
f
, cÚ¡ *
k
,

750 cÚ¡ *
âame
) {

751 
LSŒ—m
 *
p
 = 
	`Ãw´efe
(
L
);

752 
p
->
f
 = f;

753 
p
->
şo£f
 = &
io_noşo£
;

754 ià(
k
 !ğ
NULL
) {

755 
	`lua_pushv®ue
(
L
, -1);

756 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, 
k
);

758 
	`lua_£tf›ld
(
L
, -2, 
âame
);

759 
	}
}

762 
LUAMOD_API
 
	$luaİ’_io
 (
lua_S‹
 *
L
) {

763 
	`luaL_Ãwlib
(
L
, 
iŞib
);

764 
	`ü—‹m‘a
(
L
);

766 
	`ü—‹¡dfe
(
L
, 
¡dš
, 
IO_INPUT
, "stdin");

767 
	`ü—‹¡dfe
(
L
, 
¡dout
, 
IO_OUTPUT
, "stdout");

768 
	`ü—‹¡dfe
(
L
, 
¡d”r
, 
NULL
, "stderr");

770 
	}
}

	@script/lua/lua-5.3.4/src/llex.c

7 
	#Îex_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<loÿË.h
>

14 
	~<¡ršg.h
>

16 
	~"lua.h
"

18 
	~"lùy³.h
"

19 
	~"ldebug.h
"

20 
	~"ldo.h
"

21 
	~"lgc.h
"

22 
	~"Îex.h
"

23 
	~"lobjeù.h
"

24 
	~"Í¬£r.h
"

25 
	~"l¡©e.h
"

26 
	~"l¡ršg.h
"

27 
	~"ÉabË.h
"

28 
	~"lzio.h
"

32 
	#Ãxt
(
ls
èÖs->
cu¼’t
 = 
	`zg‘c
Ös->
z
))

	)

36 
	#cu¼IsNewlše
(
ls
èÖs->
cu¼’t
 =ğ'\n' ||†s->cu¼’ˆ=ğ'\r')

	)

40 cÚ¡ *cÚ¡ 
	gluaX_tok’s
 [] = {

51 
	#§ve_ªd_Ãxt
(
ls
è(
	`§ve
Ös,†s->
cu¼’t
), 
	`Ãxt
Ös))

	)

54 
l_nÜ‘
 
Ëx”rÜ
 (
LexS‹
 *
ls
, cÚ¡ *
msg
, 
tok’
);

57 
	$§ve
 (
LexS‹
 *
ls
, 
c
) {

58 
Mbufãr
 *
b
 = 
ls
->
buff
;

59 ià(
	`luaZ_bufæ’
(
b
è+ 1 > 
	`luaZ_sizebufãr
(b)) {

60 
size_t
 
Ãwsize
;

61 ià(
	`luaZ_sizebufãr
(
b
è>ğ
MAX_SIZE
/2)

62 
	`Ëx”rÜ
(
ls
, "lexicalƒlementoo†ong", 0);

63 
Ãwsize
 = 
	`luaZ_sizebufãr
(
b
) * 2;

64 
	`luaZ_»sizebufãr
(
ls
->
L
, 
b
, 
Ãwsize
);

66 
b
->
bufãr
[
	`luaZ_bufæ’
(b)++] = 
	`ÿ¡
(, 
c
);

67 
	}
}

70 
	$luaX_š™
 (
lua_S‹
 *
L
) {

71 
i
;

72 
TSŒšg
 *
e
 = 
	`luaS_Ãwl™”®
(
L
, 
LUA_ENV
);

73 
	`luaC_fix
(
L
, 
	`obj2gco
(
e
));

74 
i
=0; i<
NUM_RESERVED
; i++) {

75 
TSŒšg
 *
ts
 = 
	`luaS_Ãw
(
L
, 
luaX_tok’s
[
i
]);

76 
	`luaC_fix
(
L
, 
	`obj2gco
(
ts
));

77 
ts
->
exŒa
 = 
	`ÿ¡_by‹
(
i
+1);

79 
	}
}

82 cÚ¡ *
	$luaX_tok’2¡r
 (
LexS‹
 *
ls
, 
tok’
) {

83 ià(
tok’
 < 
FIRST_RESERVED
) {

84 
	`lua_as£¹
(
tok’
 =ğ
	`ÿ¡_uch¬
(token));

85  
	`luaO_pushf¡ršg
(
ls
->
L
, "'%c'", 
tok’
);

88 cÚ¡ *
s
 = 
luaX_tok’s
[
tok’
 - 
FIRST_RESERVED
];

89 ià(
tok’
 < 
TK_EOS
)

90  
	`luaO_pushf¡ršg
(
ls
->
L
, "'%s'", 
s
);

92  
s
;

94 
	}
}

97 cÚ¡ *
	$txtTok’
 (
LexS‹
 *
ls
, 
tok’
) {

98 
tok’
) {

99 
TK_NAME
: 
TK_STRING
:

100 
TK_FLT
: 
TK_INT
:

101 
	`§ve
(
ls
, '\0');

102  
	`luaO_pushf¡ršg
(
ls
->
L
, "'%s'", 
	`luaZ_bufãr
Ös->
buff
));

104  
	`luaX_tok’2¡r
(
ls
, 
tok’
);

106 
	}
}

109 
l_nÜ‘
 
	$Ëx”rÜ
 (
LexS‹
 *
ls
, cÚ¡ *
msg
, 
tok’
) {

110 
msg
 = 
	`luaG_addšfo
(
ls
->
L
, msg,†s->
sourû
,†s->
lš’umb”
);

111 ià(
tok’
)

112 
	`luaO_pushf¡ršg
(
ls
->
L
, "% Ã¬ %s", 
msg
, 
	`txtTok’
Ös, 
tok’
));

113 
	`luaD_throw
(
ls
->
L
, 
LUA_ERRSYNTAX
);

114 
	}
}

117 
l_nÜ‘
 
	$luaX_syÁax”rÜ
 (
LexS‹
 *
ls
, cÚ¡ *
msg
) {

118 
	`Ëx”rÜ
(
ls
, 
msg
,†s->
t
.
tok’
);

119 
	}
}

127 
TSŒšg
 *
	$luaX_Ãw¡ršg
 (
LexS‹
 *
ls
, cÚ¡ *
¡r
, 
size_t
 
l
) {

128 
lua_S‹
 *
L
 = 
ls
->L;

129 
TV®ue
 *
o
;

130 
TSŒšg
 *
ts
 = 
	`luaS_Ãwl¡r
(
L
, 
¡r
, 
l
);

131 
	`£tsv®ue2s
(
L
, L->
tİ
++, 
ts
);

132 
o
 = 
	`luaH_£t
(
L
, 
ls
->
h
, L->
tİ
 - 1);

133 ià(
	`‰i¢
(
o
)) {

136 
	`£tbv®ue
(
o
, 1);

137 
	`luaC_checkGC
(
L
);

140 
ts
 = 
	`tsv®ue
(
	`keyäomv®
(
o
));

142 
L
->
tİ
--;

143  
ts
;

144 
	}
}

151 
	$šşš’umb”
 (
LexS‹
 *
ls
) {

152 
Şd
 = 
ls
->
cu¼’t
;

153 
	`lua_as£¹
(
	`cu¼IsNewlše
(
ls
));

154 
	`Ãxt
(
ls
);

155 ià(
	`cu¼IsNewlše
(
ls
è&&†s->
cu¼’t
 !ğ
Şd
)

156 
	`Ãxt
(
ls
);

157 ià(++
ls
->
lš’umb”
 >ğ
MAX_INT
)

158 
	`Ëx”rÜ
(
ls
, "chunk hasoo many†ines", 0);

159 
	}
}

162 
	$luaX_£tšput
 (
lua_S‹
 *
L
, 
LexS‹
 *
ls
, 
ZIO
 *
z
, 
TSŒšg
 *
sourû
,

163 
fœ¡ch¬
) {

164 
ls
->
t
.
tok’
 = 0;

165 
ls
->
L
 = L;

166 
ls
->
cu¼’t
 = 
fœ¡ch¬
;

167 
ls
->
lookah—d
.
tok’
 = 
TK_EOS
;

168 
ls
->
z
 = z;

169 
ls
->
fs
 = 
NULL
;

170 
ls
->
lš’umb”
 = 1;

171 
ls
->
Ï¡lše
 = 1;

172 
ls
->
sourû
 = source;

173 
ls
->
’vn
 = 
	`luaS_Ãwl™”®
(
L
, 
LUA_ENV
);

174 
	`luaZ_»sizebufãr
(
ls
->
L
,†s->
buff
, 
LUA_MINBUFFER
);

175 
	}
}

186 
	$check_Ãxt1
 (
LexS‹
 *
ls
, 
c
) {

187 ià(
ls
->
cu¼’t
 =ğ
c
) {

188 
	`Ãxt
(
ls
);

192 
	}
}

199 
	$check_Ãxt2
 (
LexS‹
 *
ls
, cÚ¡ *
£t
) {

200 
	`lua_as£¹
(
£t
[2] == '\0');

201 ià(
ls
->
cu¼’t
 =ğ
£t
[0] ||†s->current == set[1]) {

202 
	`§ve_ªd_Ãxt
(
ls
);

206 
	}
}

214 
	$»ad_num”®
 (
LexS‹
 *
ls
, 
SemInfo
 *
£mšfo
) {

215 
TV®ue
 
obj
;

216 cÚ¡ *
expo
 = "Ee";

217 
fœ¡
 = 
ls
->
cu¼’t
;

218 
	`lua_as£¹
(
	`lisdig™
(
ls
->
cu¼’t
));

219 
	`§ve_ªd_Ãxt
(
ls
);

220 ià(
fœ¡
 =ğ'0' && 
	`check_Ãxt2
(
ls
, "xX"))

221 
expo
 = "Pp";

223 ià(
	`check_Ãxt2
(
ls
, 
expo
))

224 
	`check_Ãxt2
(
ls
, "-+");

225 ià(
	`lisxdig™
(
ls
->
cu¼’t
))

226 
	`§ve_ªd_Ãxt
(
ls
);

227 ià(
ls
->
cu¼’t
 == '.')

228 
	`§ve_ªd_Ãxt
(
ls
);

231 
	`§ve
(
ls
, '\0');

232 ià(
	`luaO_¡r2num
(
	`luaZ_bufãr
(
ls
->
buff
), &
obj
) == 0)

233 
	`Ëx”rÜ
(
ls
, "m®fÜmed‚umb”", 
TK_FLT
);

234 ià(
	`‰isš‹g”
(&
obj
)) {

235 
£mšfo
->
i
 = 
	`iv®ue
(&
obj
);

236  
TK_INT
;

239 
	`lua_as£¹
(
	`‰isæßt
(&
obj
));

240 
£mšfo
->
r
 = 
	`ætv®ue
(&
obj
);

241  
TK_FLT
;

243 
	}
}

251 
	$sk_£p
 (
LexS‹
 *
ls
) {

252 
couÁ
 = 0;

253 
s
 = 
ls
->
cu¼’t
;

254 
	`lua_as£¹
(
s
 == '[' || s == ']');

255 
	`§ve_ªd_Ãxt
(
ls
);

256 
ls
->
cu¼’t
 == '=') {

257 
	`§ve_ªd_Ãxt
(
ls
);

258 
couÁ
++;

260  (
ls
->
cu¼’t
 =ğ
s
è? 
couÁ
 : (-count) - 1;

261 
	}
}

264 
	$»ad_lÚg_¡ršg
 (
LexS‹
 *
ls
, 
SemInfo
 *
£mšfo
, 
£p
) {

265 
lše
 = 
ls
->
lš’umb”
;

266 
	`§ve_ªd_Ãxt
(
ls
);

267 ià(
	`cu¼IsNewlše
(
ls
))

268 
	`šşš’umb”
(
ls
);

270 
ls
->
cu¼’t
) {

271 
EOZ
: {

272 cÚ¡ *
wh©
 = (
£mšfo
 ? "string" : "comment");

273 cÚ¡ *
msg
 = 
	`luaO_pushf¡ršg
(
ls
->
L
,

274 "unfšished†Úg % (¡¬tšg‡ˆlš%d)", 
wh©
, 
lše
);

275 
	`Ëx”rÜ
(
ls
, 
msg
, 
TK_EOS
);

279 ià(
	`sk_£p
(
ls
è=ğ
£p
) {

280 
	`§ve_ªd_Ãxt
(
ls
);

281 
’dloİ
;

286 
	`§ve
(
ls
, '\n');

287 
	`šşš’umb”
(
ls
);

288 ià(!
£mšfo
è
	`luaZ_»£tbufãr
(
ls
->
buff
);

292 ià(
£mšfo
è
	`§ve_ªd_Ãxt
(
ls
);

293 
	`Ãxt
(
ls
);

296 } 
’dloİ
:

297 ià(
£mšfo
)

298 
£mšfo
->
ts
 = 
	`luaX_Ãw¡ršg
(
ls
, 
	`luaZ_bufãr
Ös->
buff
è+ (2 + 
£p
),

299 
	`luaZ_bufæ’
(
ls
->
buff
è- 2*(2 + 
£p
));

300 
	}
}

303 
	$esccheck
 (
LexS‹
 *
ls
, 
c
, cÚ¡ *
msg
) {

304 ià(!
c
) {

305 ià(
ls
->
cu¼’t
 !ğ
EOZ
)

306 
	`§ve_ªd_Ãxt
(
ls
);

307 
	`Ëx”rÜ
(
ls
, 
msg
, 
TK_STRING
);

309 
	}
}

312 
	$g‘hexa
 (
LexS‹
 *
ls
) {

313 
	`§ve_ªd_Ãxt
(
ls
);

314 
	`esccheck
 (
ls
, 
	`lisxdig™
Ös->
cu¼’t
), "hexadecimal digitƒxpected");

315  
	`luaO_hexav®ue
(
ls
->
cu¼’t
);

316 
	}
}

319 
	$»adhex«sc
 (
LexS‹
 *
ls
) {

320 
r
 = 
	`g‘hexa
(
ls
);

321 
r
 = (¸<< 4è+ 
	`g‘hexa
(
ls
);

322 
	`luaZ_bufäemove
(
ls
->
buff
, 2);

323  
r
;

324 
	}
}

327 
	$»adutf8esc
 (
LexS‹
 *
ls
) {

328 
r
;

329 
i
 = 4;

330 
	`§ve_ªd_Ãxt
(
ls
);

331 
	`esccheck
(
ls
,†s->
cu¼’t
 == '{', "missing '{'");

332 
r
 = 
	`g‘hexa
(
ls
);

333 (
	`§ve_ªd_Ãxt
(
ls
), 
	`lisxdig™
Ös->
cu¼’t
))) {

334 
i
++;

335 
r
 = (¸<< 4è+ 
	`luaO_hexav®ue
(
ls
->
cu¼’t
);

336 
	`esccheck
(
ls
, 
r
 <= 0x10FFFF, "UTF-8 valueoo†arge");

338 
	`esccheck
(
ls
,†s->
cu¼’t
 == '}', "missing '}'");

339 
	`Ãxt
(
ls
);

340 
	`luaZ_bufäemove
(
ls
->
buff
, 
i
);

341  
r
;

342 
	}
}

345 
	$utf8esc
 (
LexS‹
 *
ls
) {

346 
buff
[
UTF8BUFFSZ
];

347 
n
 = 
	`luaO_utf8esc
(
buff
, 
	`»adutf8esc
(
ls
));

348 ; 
n
 > 0;‚--)

349 
	`§ve
(
ls
, 
buff
[
UTF8BUFFSZ
 - 
n
]);

350 
	}
}

353 
	$»addeûsc
 (
LexS‹
 *
ls
) {

354 
i
;

355 
r
 = 0;

356 
i
 = 0; i < 3 && 
	`lisdig™
(
ls
->
cu¼’t
); i++) {

357 
r
 = 10*¸+ 
ls
->
cu¼’t
 - '0';

358 
	`§ve_ªd_Ãxt
(
ls
);

360 
	`esccheck
(
ls
, 
r
 <ğ
UCHAR_MAX
, "decimalƒscapeoo†arge");

361 
	`luaZ_bufäemove
(
ls
->
buff
, 
i
);

362  
r
;

363 
	}
}

366 
	$»ad_¡ršg
 (
LexS‹
 *
ls
, 
d–
, 
SemInfo
 *
£mšfo
) {

367 
	`§ve_ªd_Ãxt
(
ls
);

368 
ls
->
cu¼’t
 !ğ
d–
) {

369 
ls
->
cu¼’t
) {

370 
EOZ
:

371 
	`Ëx”rÜ
(
ls
, "unfšished sŒšg", 
TK_EOS
);

375 
	`Ëx”rÜ
(
ls
, "unfšished sŒšg", 
TK_STRING
);

378 
c
;

379 
	`§ve_ªd_Ãxt
(
ls
);

380 
ls
->
cu¼’t
) {

381 'a': 
c
 = '\a'; 
»ad_§ve
;

382 'b': 
c
 = '\b'; 
»ad_§ve
;

383 'f': 
c
 = '\f'; 
»ad_§ve
;

384 'n': 
c
 = '\n'; 
»ad_§ve
;

385 'r': 
c
 = '\r'; 
»ad_§ve
;

386 't': 
c
 = '\t'; 
»ad_§ve
;

387 'v': 
c
 = '\v'; 
»ad_§ve
;

388 'x': 
c
 = 
	`»adhex«sc
(
ls
); 
»ad_§ve
;

389 'u': 
	`utf8esc
(
ls
); 
no_§ve
;

391 
	`šşš’umb”
(
ls
); 
c
 = '\n'; 
Úly_§ve
;

393 
c
 = 
ls
->
cu¼’t
; 
»ad_§ve
;

394 
EOZ
: 
no_§ve
;

396 
	`luaZ_bufäemove
(
ls
->
buff
, 1);

397 
	`Ãxt
(
ls
);

398 
	`lis¥aû
(
ls
->
cu¼’t
)) {

399 ià(
	`cu¼IsNewlše
(
ls
)è
	`šşš’umb”
(ls);

400 
	`Ãxt
(
ls
);

402 
no_§ve
;

405 
	`esccheck
(
ls
, 
	`lisdig™
Ös->
cu¼’t
), "invalidƒscape sequence");

406 
c
 = 
	`»addeûsc
(
ls
);

407 
Úly_§ve
;

410 
»ad_§ve
:

411 
	`Ãxt
(
ls
);

413 
Úly_§ve
:

414 
	`luaZ_bufäemove
(
ls
->
buff
, 1);

415 
	`§ve
(
ls
, 
c
);

417 
no_§ve
: ;

420 
	`§ve_ªd_Ãxt
(
ls
);

423 
	`§ve_ªd_Ãxt
(
ls
);

424 
£mšfo
->
ts
 = 
	`luaX_Ãw¡ršg
(
ls
, 
	`luaZ_bufãr
Ös->
buff
) + 1,

425 
	`luaZ_bufæ’
(
ls
->
buff
) - 2);

426 
	}
}

429 
	$Îex
 (
LexS‹
 *
ls
, 
SemInfo
 *
£mšfo
) {

430 
	`luaZ_»£tbufãr
(
ls
->
buff
);

432 
ls
->
cu¼’t
) {

434 
	`šşš’umb”
(
ls
);

438 
	`Ãxt
(
ls
);

442 
	`Ãxt
(
ls
);

443 ià(
ls
->
cu¼’t
 != '-')  '-';

445 
	`Ãxt
(
ls
);

446 ià(
ls
->
cu¼’t
 == '[') {

447 
£p
 = 
	`sk_£p
(
ls
);

448 
	`luaZ_»£tbufãr
(
ls
->
buff
);

449 ià(
£p
 >= 0) {

450 
	`»ad_lÚg_¡ršg
(
ls
, 
NULL
, 
£p
);

451 
	`luaZ_»£tbufãr
(
ls
->
buff
);

456 !
	`cu¼IsNewlše
(
ls
è&&†s->
cu¼’t
 !ğ
EOZ
)

457 
	`Ãxt
(
ls
);

461 
£p
 = 
	`sk_£p
(
ls
);

462 ià(
£p
 >= 0) {

463 
	`»ad_lÚg_¡ršg
(
ls
, 
£mšfo
, 
£p
);

464  
TK_STRING
;

466 ià(
£p
 != -1)

467 
	`Ëx”rÜ
(
ls
, "šv®id†Úg sŒšg d–im™”", 
TK_STRING
);

471 
	`Ãxt
(
ls
);

472 ià(
	`check_Ãxt1
(
ls
, '=')è 
TK_EQ
;

476 
	`Ãxt
(
ls
);

477 ià(
	`check_Ãxt1
(
ls
, '=')è 
TK_LE
;

478 ià(
	`check_Ãxt1
(
ls
, '<')è 
TK_SHL
;

482 
	`Ãxt
(
ls
);

483 ià(
	`check_Ãxt1
(
ls
, '=')è 
TK_GE
;

484 ià(
	`check_Ãxt1
(
ls
, '>')è 
TK_SHR
;

488 
	`Ãxt
(
ls
);

489 ià(
	`check_Ãxt1
(
ls
, '/')è 
TK_IDIV
;

493 
	`Ãxt
(
ls
);

494 ià(
	`check_Ãxt1
(
ls
, '=')è 
TK_NE
;

498 
	`Ãxt
(
ls
);

499 ià(
	`check_Ãxt1
(
ls
, ':')è 
TK_DBCOLON
;

503 
	`»ad_¡ršg
(
ls
,†s->
cu¼’t
, 
£mšfo
);

504  
TK_STRING
;

507 
	`§ve_ªd_Ãxt
(
ls
);

508 ià(
	`check_Ãxt1
(
ls
, '.')) {

509 ià(
	`check_Ãxt1
(
ls
, '.'))

510  
TK_DOTS
;

511  
TK_CONCAT
;

513 ià(!
	`lisdig™
(
ls
->
cu¼’t
))  '.';

514  
	`»ad_num”®
(
ls
, 
£mšfo
);

518  
	`»ad_num”®
(
ls
, 
£mšfo
);

520 
EOZ
: {

521  
TK_EOS
;

524 ià(
	`li¦®pha
(
ls
->
cu¼’t
)) {

525 
TSŒšg
 *
ts
;

527 
	`§ve_ªd_Ãxt
(
ls
);

528 } 
	`li¦®num
(
ls
->
cu¼’t
));

529 
ts
 = 
	`luaX_Ãw¡ršg
(
ls
, 
	`luaZ_bufãr
Ös->
buff
),

530 
	`luaZ_bufæ’
(
ls
->
buff
));

531 
£mšfo
->
ts
 =s;

532 ià(
	`i¤e£rved
(
ts
))

533  
ts
->
exŒa
 - 1 + 
FIRST_RESERVED
;

535  
TK_NAME
;

539 
c
 = 
ls
->
cu¼’t
;

540 
	`Ãxt
(
ls
);

541  
c
;

546 
	}
}

549 
	$luaX_Ãxt
 (
LexS‹
 *
ls
) {

550 
ls
->
Ï¡lše
 =†s->
lš’umb”
;

551 ià(
ls
->
lookah—d
.
tok’
 !ğ
TK_EOS
) {

552 
ls
->
t
 =†s->
lookah—d
;

553 
ls
->
lookah—d
.
tok’
 = 
TK_EOS
;

556 
ls
->
t
.
tok’
 = 
	`Îex
Ös, &ls->t.
£mšfo
);

557 
	}
}

560 
	$luaX_lookah—d
 (
LexS‹
 *
ls
) {

561 
	`lua_as£¹
(
ls
->
lookah—d
.
tok’
 =ğ
TK_EOS
);

562 
ls
->
lookah—d
.
tok’
 = 
	`Îex
Ös, &ls->lookah—d.
£mšfo
);

563  
ls
->
lookah—d
.
tok’
;

564 
	}
}

	@script/lua/lua-5.3.4/src/llex.h

7 #iâdeà
Îex_h


8 
	#Îex_h


	)

10 
	~"lobjeù.h
"

11 
	~"lzio.h
"

14 
	#FIRST_RESERVED
 257

	)

17 #ià!
defšed
(
LUA_ENV
)

18 
	#LUA_ENV
 "_ENV"

	)

26 
	eRESERVED
 {

28 
	mTK_AND
 = 
FIRST_RESERVED
, 
	mTK_BREAK
,

29 
	mTK_DO
, 
	mTK_ELSE
, 
	mTK_ELSEIF
, 
	mTK_END
, 
	mTK_FALSE
, 
	mTK_FOR
, 
	mTK_FUNCTION
,

30 
	mTK_GOTO
, 
	mTK_IF
, 
	mTK_IN
, 
	mTK_LOCAL
, 
	mTK_NIL
, 
	mTK_NOT
, 
	mTK_OR
, 
	mTK_REPEAT
,

31 
	mTK_RETURN
, 
	mTK_THEN
, 
	mTK_TRUE
, 
	mTK_UNTIL
, 
	mTK_WHILE
,

33 
	mTK_IDIV
, 
	mTK_CONCAT
, 
	mTK_DOTS
, 
	mTK_EQ
, 
	mTK_GE
, 
	mTK_LE
, 
	mTK_NE
,

34 
	mTK_SHL
, 
	mTK_SHR
,

35 
	mTK_DBCOLON
, 
	mTK_EOS
,

36 
	mTK_FLT
, 
	mTK_INT
, 
	mTK_NAME
, 
	mTK_STRING


40 
	#NUM_RESERVED
 (
	`ÿ¡
(, 
TK_WHILE
-
FIRST_RESERVED
+1))

	)

44 
lua_Numb”
 
	mr
;

45 
lua_IÁeg”
 
	mi
;

46 
TSŒšg
 *
	mts
;

47 } 
	tSemInfo
;

50 
	sTok’
 {

51 
	mtok’
;

52 
SemInfo
 
	m£mšfo
;

53 } 
	tTok’
;

58 
	sLexS‹
 {

59 
	mcu¼’t
;

60 
	mlš’umb”
;

61 
	mÏ¡lše
;

62 
Tok’
 
	mt
;

63 
Tok’
 
	mlookah—d
;

64 
FuncS‹
 *
	mfs
;

65 
lua_S‹
 *
	mL
;

66 
ZIO
 *
	mz
;

67 
Mbufãr
 *
	mbuff
;

68 
TabË
 *
	mh
;

69 
Dynd©a
 *
	mdyd
;

70 
TSŒšg
 *
	msourû
;

71 
TSŒšg
 *
	m’vn
;

72 } 
	tLexS‹
;

75 
LUAI_FUNC
 
luaX_š™
 (
lua_S‹
 *
L
);

76 
LUAI_FUNC
 
luaX_£tšput
 (
lua_S‹
 *
L
, 
LexS‹
 *
ls
, 
ZIO
 *
z
,

77 
TSŒšg
 *
sourû
, 
fœ¡ch¬
);

78 
LUAI_FUNC
 
TSŒšg
 *
luaX_Ãw¡ršg
 (
LexS‹
 *
ls
, cÚ¡ *
¡r
, 
size_t
 
l
);

79 
LUAI_FUNC
 
luaX_Ãxt
 (
LexS‹
 *
ls
);

80 
LUAI_FUNC
 
luaX_lookah—d
 (
LexS‹
 *
ls
);

81 
LUAI_FUNC
 
l_nÜ‘
 
luaX_syÁax”rÜ
 (
LexS‹
 *
ls
, cÚ¡ *
s
);

82 
LUAI_FUNC
 cÚ¡ *
luaX_tok’2¡r
 (
LexS‹
 *
ls
, 
tok’
);

	@script/lua/lua-5.3.4/src/llimits.h

7 #iâdeà
Îim™s_h


8 
	#Îim™s_h


	)

11 
	~<lim™s.h
>

12 
	~<¡ddef.h
>

15 
	~"lua.h
"

22 #ià
defšed
(
LUAI_MEM
)

23 
LUAI_UMEM
 
	tlu_mem
;

24 
LUAI_MEM
 
	tl_mem
;

25 #–ià
LUAI_BITSINT
 >= 32

26 
size_t
 
	tlu_mem
;

27 
±rdiff_t
 
	tl_mem
;

29 
	tlu_mem
;

30 
	tl_mem
;

35 
	tlu_by‹
;

39 
	#MAX_SIZET
 ((
size_t
)(~(size_t)0))

	)

42 
	#MAX_SIZE
 ((
size_t
è< (
lua_IÁeg”
è? 
MAX_SIZET
 \

43 : (
size_t
)(
LUA_MAXINTEGER
))

	)

46 
	#MAX_LUMEM
 ((
lu_mem
)(~Öu_mem)0))

	)

48 
	#MAX_LMEM
 ((
l_mem
)(
MAX_LUMEM
 >> 1))

	)

51 
	#MAX_INT
 
INT_MAX


	)

59 
	#pošt2ušt
(
p
è(()((
size_t
)Õè& 
UINT_MAX
))

	)

64 #ià
defšed
(
LUAI_USER_ALIGNMENT_T
)

65 
LUAI_USER_ALIGNMENT_T
 
	tL_Umax®ign
;

68 
lua_Numb”
 
	mn
;

69 
	mu
;

70 *
	ms
;

71 
lua_IÁeg”
 
	mi
;

72 
	ml
;

73 } 
	tL_Umax®ign
;

79 
LUAI_UACNUMBER
 
	tl_uacNumb”
;

80 
LUAI_UACINT
 
	tl_uacIÁ
;

84 #ià
defšed
(
lua_as£¹
)

85 
	#check_exp
(
c
,
e
è(
	`lua_as£¹
(c), (e))

	)

87 
	#lua_lÚgas£¹
(
c
è((cè? ()0 : 
	`lua_as£¹
(0))

	)

89 
	#lua_as£¹
(
c
è(()0)

	)

90 
	#check_exp
(
c
,
e
èÓ)

	)

91 
	#lua_lÚgas£¹
(
c
è(()0)

	)

97 #ià!
defšed
(
luai_­icheck
)

98 
	#luai_­icheck
(
l
,
e
è
	`lua_as£¹
Ó)

	)

101 
	#­i_check
(
l
,
e
,
msg
è
	`luai_­icheck
Ö,Óè&& msg)

	)

105 #ià!
defšed
(
UNUSED
)

106 
	#UNUSED
(
x
è(()(x))

	)

111 
	#ÿ¡
(
t
, 
exp
è(Ñ)Óxp))

	)

113 
	#ÿ¡_void
(
i
è
	`ÿ¡
(, (i))

	)

114 
	#ÿ¡_by‹
(
i
è
	`ÿ¡
(
lu_by‹
, (i))

	)

115 
	#ÿ¡_num
(
i
è
	`ÿ¡
(
lua_Numb”
, (i))

	)

116 
	#ÿ¡_št
(
i
è
	`ÿ¡
(, (i))

	)

117 
	#ÿ¡_uch¬
(
i
è
	`ÿ¡
(, (i))

	)

121 #ià!
defšed
(
l_ÿ¡S2U
)

122 
	#l_ÿ¡S2U
(
i
è((
lua_UnsigÃd
)(i))

	)

130 #ià!
defšed
(
l_ÿ¡U2S
)

131 
	#l_ÿ¡U2S
(
i
è((
lua_IÁeg”
)(i))

	)

138 #ià
defšed
(
__GNUC__
)

139 
	#l_nÜ‘
 
	`__©Œibu‹__
((
nÜ‘uº
))

	)

140 #–ià
defšed
(
_MSC_VER
) && _MSC_VER >= 1200

141 
	#l_nÜ‘
 
	`__deş¥ec
(
nÜ‘uº
)

	)

143 
	#l_nÜ‘
 

	)

152 #ià!
defšed
(
LUAI_MAXCCALLS
)

153 
	#LUAI_MAXCCALLS
 200

	)

162 #ià
LUAI_BITSINT
 >= 32

163 
	tIn¡ruùiÚ
;

165 
	tIn¡ruùiÚ
;

176 #ià!
defšed
(
LUAI_MAXSHORTLEN
)

177 
	#LUAI_MAXSHORTLEN
 40

	)

187 #ià!
defšed
(
MINSTRTABSIZE
)

188 
	#MINSTRTABSIZE
 128

	)

197 #ià!
defšed
(
STRCACHE_N
)

198 
	#STRCACHE_N
 53

	)

199 
	#STRCACHE_M
 2

	)

204 #ià!
defšed
(
LUA_MINBUFFER
)

205 
	#LUA_MINBUFFER
 32

	)

213 #ià!
defšed
(
lua_lock
)

214 
	#lua_lock
(
L
è((è0)

	)

215 
	#lua_uÆock
(
L
è((è0)

	)

222 #ià!
defšed
(
luai_th»ady›ld
)

223 
	#luai_th»ady›ld
(
L
è{
	`lua_uÆock
(L); 
	`lua_lock
(L);}

	)

232 #ià!
defšed
(
luai_u£r¡©eİ’
)

233 
	#luai_u£r¡©eİ’
(
L
è(()L)

	)

236 #ià!
defšed
(
luai_u£r¡©eşo£
)

237 
	#luai_u£r¡©eşo£
(
L
è(()L)

	)

240 #ià!
defšed
(
luai_u£r¡©‘h»ad
)

241 
	#luai_u£r¡©‘h»ad
(
L
,
L1
è(()L)

	)

244 #ià!
defšed
(
luai_u£r¡©eä“
)

245 
	#luai_u£r¡©eä“
(
L
,
L1
è(()L)

	)

248 #ià!
defšed
(
luai_u£r¡©”esume
)

249 
	#luai_u£r¡©”esume
(
L
,
n
è(()L)

	)

252 #ià!
defšed
(
luai_u£r¡©ey›ld
)

253 
	#luai_u£r¡©ey›ld
(
L
,
n
è(()L)

	)

263 #ià!
defšed
(
luai_numidiv
)

264 
	#luai_numidiv
(
L
,
a
,
b
è(()L, 
	`l_æoÜ
(
	`luai_numdiv
(L,a,b)))

	)

268 #ià!
defšed
(
luai_numdiv
)

269 
	#luai_numdiv
(
L
,
a
,
b
è(×)/(b))

	)

279 #ià!
defšed
(
luai_nummod
)

280 
	#luai_nummod
(
L
,
a
,
b
,
m
) \

281 { (
m
èğ
	`l_m©hİ
(
fmod
)(
a
,
b
); ià((m)*(bè< 0è(mè+ğ(b); }

	)

285 #ià!
defšed
(
luai_numpow
)

286 
	#luai_numpow
(
L
,
a
,
b
è(()L, 
	`l_m©hİ
(
pow
)×,b))

	)

290 #ià!
defšed
(
luai_numadd
)

291 
	#luai_numadd
(
L
,
a
,
b
è(×)+(b))

	)

292 
	#luai_numsub
(
L
,
a
,
b
è(×)-(b))

	)

293 
	#luai_nummul
(
L
,
a
,
b
è(×)*(b))

	)

294 
	#luai_numunm
(
L
,
a
è(-×))

	)

295 
	#luai_numeq
(
a
,
b
è(×)==(b))

	)

296 
	#luai_numÉ
(
a
,
b
è(×)<(b))

	)

297 
	#luai_numË
(
a
,
b
è(×)<=(b))

	)

298 
	#luai_numi¢ª
(
a
è(!
	`luai_numeq
(×), (a)))

	)

308 #ià!
defšed
(
HARDSTACKTESTS
)

309 
	#cÚdmove¡ack
(
L
,
´e
,
pos
è(()0)

	)

312 
	#cÚdmove¡ack
(
L
,
´e
,
pos
) \

313 { 
sz_
 = (
L
)->
¡acksize
; 
´e
; 
	`luaD_»®loc¡ack
((L), sz_); 
pos
; }

	)

316 #ià!
defšed
(
HARDMEMTESTS
)

317 
	#cÚdchªgemem
(
L
,
´e
,
pos
è(()0)

	)

319 
	#cÚdchªgemem
(
L
,
´e
,
pos
) \

320 { ià(
	`G
(
L
)->
güuÂšg
è{ 
´e
; 
	`luaC_fuÎgc
(L, 0); 
pos
; } }

	)

	@script/lua/lua-5.3.4/src/lmathlib.c

7 
	#lm©hlib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<¡dlib.h
>

14 
	~<m©h.h
>

16 
	~"lua.h
"

18 
	~"Ïuxlib.h
"

19 
	~"lu®ib.h
"

22 #undeà
PI


23 
	#PI
 (
	`l_m©hİ
(3.141592653589793238462643383279502884))

	)

26 #ià!
defšed
(
l_¿nd
)

27 #ià
defšed
(
LUA_USE_POSIX
)

28 
	#l_¿nd
(è
	`¿ndom
()

	)

29 
	#l_¤ªd
(
x
è
	`¤ªdom
(x)

	)

30 
	#L_RANDMAX
 2147483647

	)

32 
	#l_¿nd
(è
	`¿nd
()

	)

33 
	#l_¤ªd
(
x
è
	`¤ªd
(x)

	)

34 
	#L_RANDMAX
 
RAND_MAX


	)

39 
	$m©h_abs
 (
lua_S‹
 *
L
) {

40 ià(
	`lua_isš‹g”
(
L
, 1)) {

41 
lua_IÁeg”
 
n
 = 
	`lua_toš‹g”
(
L
, 1);

42 ià(
n
 < 0èÀğ(
lua_IÁeg”
)(0u - (
lua_UnsigÃd
)n);

43 
	`lua_pushš‹g”
(
L
, 
n
);

46 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
çbs
)(
	`luaL_checknumb”
(L, 1)));

48 
	}
}

50 
	$m©h_sš
 (
lua_S‹
 *
L
) {

51 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
sš
)(
	`luaL_checknumb”
(L, 1)));

53 
	}
}

55 
	$m©h_cos
 (
lua_S‹
 *
L
) {

56 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
cos
)(
	`luaL_checknumb”
(L, 1)));

58 
	}
}

60 
	$m©h_n
 (
lua_S‹
 *
L
) {

61 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
n
)(
	`luaL_checknumb”
(L, 1)));

63 
	}
}

65 
	$m©h_asš
 (
lua_S‹
 *
L
) {

66 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
asš
)(
	`luaL_checknumb”
(L, 1)));

68 
	}
}

70 
	$m©h_acos
 (
lua_S‹
 *
L
) {

71 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
acos
)(
	`luaL_checknumb”
(L, 1)));

73 
	}
}

75 
	$m©h_©ª
 (
lua_S‹
 *
L
) {

76 
lua_Numb”
 
y
 = 
	`luaL_checknumb”
(
L
, 1);

77 
lua_Numb”
 
x
 = 
	`luaL_İŠumb”
(
L
, 2, 1);

78 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
©ª2
)(
y
, 
x
));

80 
	}
}

83 
	$m©h_tošt
 (
lua_S‹
 *
L
) {

84 
v®id
;

85 
lua_IÁeg”
 
n
 = 
	`lua_toš‹g”x
(
L
, 1, &
v®id
);

86 ià(
v®id
)

87 
	`lua_pushš‹g”
(
L
, 
n
);

89 
	`luaL_checkªy
(
L
, 1);

90 
	`lua_pushn
(
L
);

93 
	}
}

96 
	$pushnumšt
 (
lua_S‹
 *
L
, 
lua_Numb”
 
d
) {

97 
lua_IÁeg”
 
n
;

98 ià(
	`lua_numb”toš‹g”
(
d
, &
n
))

99 
	`lua_pushš‹g”
(
L
, 
n
);

101 
	`lua_pushnumb”
(
L
, 
d
);

102 
	}
}

105 
	$m©h_æoÜ
 (
lua_S‹
 *
L
) {

106 ià(
	`lua_isš‹g”
(
L
, 1))

107 
	`lua_£‰İ
(
L
, 1);

109 
lua_Numb”
 
d
 = 
	`l_m©hİ
(
æoÜ
)(
	`luaL_checknumb”
(
L
, 1));

110 
	`pushnumšt
(
L
, 
d
);

113 
	}
}

116 
	$m©h_û
 (
lua_S‹
 *
L
) {

117 ià(
	`lua_isš‹g”
(
L
, 1))

118 
	`lua_£‰İ
(
L
, 1);

120 
lua_Numb”
 
d
 = 
	`l_m©hİ
(
û
)(
	`luaL_checknumb”
(
L
, 1));

121 
	`pushnumšt
(
L
, 
d
);

124 
	}
}

127 
	$m©h_fmod
 (
lua_S‹
 *
L
) {

128 ià(
	`lua_isš‹g”
(
L
, 1) &&†ua_isinteger(L, 2)) {

129 
lua_IÁeg”
 
d
 = 
	`lua_toš‹g”
(
L
, 2);

130 ià((
lua_UnsigÃd
)
d
 + 1u <= 1u) {

131 
	`luaL_¬gcheck
(
L
, 
d
 != 0, 2, "zero");

132 
	`lua_pushš‹g”
(
L
, 0);

135 
	`lua_pushš‹g”
(
L
, 
	`lua_toš‹g”
(L, 1è% 
d
);

138 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
fmod
)(
	`luaL_checknumb”
(L, 1),

139 
	`luaL_checknumb”
(
L
, 2)));

141 
	}
}

149 
	$m©h_modf
 (
lua_S‹
 *
L
) {

150 ià(
	`lua_isš‹g”
(
L
 ,1)) {

151 
	`lua_£‰İ
(
L
, 1);

152 
	`lua_pushnumb”
(
L
, 0);

155 
lua_Numb”
 
n
 = 
	`luaL_checknumb”
(
L
, 1);

157 
lua_Numb”
 

 = (
n
 < 0è? 
	`l_m©hİ
(
û
)Òè:†_m©hİ(
æoÜ
)(n);

158 
	`pushnumšt
(
L
, 

);

160 
	`lua_pushnumb”
(
L
, (
n
 =ğ

è? 
	`l_m©hİ
(0.0) : (n - ip));

163 
	}
}

166 
	$m©h_sq¹
 (
lua_S‹
 *
L
) {

167 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
sq¹
)(
	`luaL_checknumb”
(L, 1)));

169 
	}
}

172 
	$m©h_uÉ
 (
lua_S‹
 *
L
) {

173 
lua_IÁeg”
 
a
 = 
	`luaL_checkš‹g”
(
L
, 1);

174 
lua_IÁeg”
 
b
 = 
	`luaL_checkš‹g”
(
L
, 2);

175 
	`lua_pushboŞ—n
(
L
, (
lua_UnsigÃd
)
a
 < (lua_UnsigÃd)
b
);

177 
	}
}

179 
	$m©h_log
 (
lua_S‹
 *
L
) {

180 
lua_Numb”
 
x
 = 
	`luaL_checknumb”
(
L
, 1);

181 
lua_Numb”
 
»s
;

182 ià(
	`lua_i¢ÚeÜn
(
L
, 2))

183 
»s
 = 
	`l_m©hİ
(
log
)(
x
);

185 
lua_Numb”
 
ba£
 = 
	`luaL_checknumb”
(
L
, 2);

186 #ià!
	`defšed
(
LUA_USE_C89
)

187 ià(
ba£
 =ğ
	`l_m©hİ
(2.0))

188 
»s
 = 
	`l_m©hİ
(
log2
)(
x
); 

190 ià(
ba£
 =ğ
	`l_m©hİ
(10.0))

191 
»s
 = 
	`l_m©hİ
(
log10
)(
x
);

193 
»s
 = 
	`l_m©hİ
(
log
)(
x
)/l_m©hİÖog)(
ba£
);

195 
	`lua_pushnumb”
(
L
, 
»s
);

197 
	}
}

199 
	$m©h_exp
 (
lua_S‹
 *
L
) {

200 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
exp
)(
	`luaL_checknumb”
(L, 1)));

202 
	}
}

204 
	$m©h_deg
 (
lua_S‹
 *
L
) {

205 
	`lua_pushnumb”
(
L
, 
	`luaL_checknumb”
(L, 1è* (
	`l_m©hİ
(180.0è/ 
PI
));

207 
	}
}

209 
	$m©h_¿d
 (
lua_S‹
 *
L
) {

210 
	`lua_pushnumb”
(
L
, 
	`luaL_checknumb”
(L, 1è* (
PI
 / 
	`l_m©hİ
(180.0)));

212 
	}
}

215 
	$m©h_mš
 (
lua_S‹
 *
L
) {

216 
n
 = 
	`lua_g‘tİ
(
L
);

217 
imš
 = 1;

218 
i
;

219 
	`luaL_¬gcheck
(
L
, 
n
 >= 1, 1, "valueƒxpected");

220 
i
 = 2; i <ğ
n
; i++) {

221 ià(
	`lua_com·»
(
L
, 
i
, 
imš
, 
LUA_OPLT
))

222 
imš
 = 
i
;

224 
	`lua_pushv®ue
(
L
, 
imš
);

226 
	}
}

229 
	$m©h_max
 (
lua_S‹
 *
L
) {

230 
n
 = 
	`lua_g‘tİ
(
L
);

231 
imax
 = 1;

232 
i
;

233 
	`luaL_¬gcheck
(
L
, 
n
 >= 1, 1, "valueƒxpected");

234 
i
 = 2; i <ğ
n
; i++) {

235 ià(
	`lua_com·»
(
L
, 
imax
, 
i
, 
LUA_OPLT
))

236 
imax
 = 
i
;

238 
	`lua_pushv®ue
(
L
, 
imax
);

240 
	}
}

247 
	$m©h_¿ndom
 (
lua_S‹
 *
L
) {

248 
lua_IÁeg”
 
low
, 
up
;

249 
r
 = ()
	`l_¿nd
(è* (1.0 / (()
L_RANDMAX
 + 1.0));

250 
	`lua_g‘tİ
(
L
)) {

252 
	`lua_pushnumb”
(
L
, (
lua_Numb”
)
r
);

256 
low
 = 1;

257 
up
 = 
	`luaL_checkš‹g”
(
L
, 1);

261 
low
 = 
	`luaL_checkš‹g”
(
L
, 1);

262 
up
 = 
	`luaL_checkš‹g”
(
L
, 2);

265 :  
	`luaL_”rÜ
(
L
, "wrong‚umber of‡rguments");

268 
	`luaL_¬gcheck
(
L
, 
low
 <ğ
up
, 1, "interval isƒmpty");

269 
	`luaL_¬gcheck
(
L
, 
low
 >ğ0 || 
up
 <ğ
LUA_MAXINTEGER
 +†ow, 1,

271 
r
 *ğ()(
up
 - 
low
) + 1.0;

272 
	`lua_pushš‹g”
(
L
, (
lua_IÁeg”
)
r
 + 
low
);

274 
	}
}

277 
	$m©h_¿ndom£ed
 (
lua_S‹
 *
L
) {

278 
	`l_¤ªd
(()(
lua_IÁeg”
)
	`luaL_checknumb”
(
L
, 1));

279 ()
	`l_¿nd
();

281 
	}
}

284 
	$m©h_ty³
 (
lua_S‹
 *
L
) {

285 ià(
	`lua_ty³
(
L
, 1è=ğ
LUA_TNUMBER
) {

286 ià(
	`lua_isš‹g”
(
L
, 1))

287 
	`lua_pushl™”®
(
L
, "integer");

289 
	`lua_pushl™”®
(
L
, "float");

292 
	`luaL_checkªy
(
L
, 1);

293 
	`lua_pushn
(
L
);

296 
	}
}

304 #ià
defšed
(
LUA_COMPAT_MATHLIB
)

306 
	$m©h_cosh
 (
lua_S‹
 *
L
) {

307 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
cosh
)(
	`luaL_checknumb”
(L, 1)));

309 
	}
}

311 
	$m©h_sšh
 (
lua_S‹
 *
L
) {

312 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
sšh
)(
	`luaL_checknumb”
(L, 1)));

314 
	}
}

316 
	$m©h_nh
 (
lua_S‹
 *
L
) {

317 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
nh
)(
	`luaL_checknumb”
(L, 1)));

319 
	}
}

321 
	$m©h_pow
 (
lua_S‹
 *
L
) {

322 
lua_Numb”
 
x
 = 
	`luaL_checknumb”
(
L
, 1);

323 
lua_Numb”
 
y
 = 
	`luaL_checknumb”
(
L
, 2);

324 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
pow
)(
x
, 
y
));

326 
	}
}

328 
	$m©h_äexp
 (
lua_S‹
 *
L
) {

329 
e
;

330 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
äexp
)(
	`luaL_checknumb”
(L, 1), &
e
));

331 
	`lua_pushš‹g”
(
L
, 
e
);

333 
	}
}

335 
	$m©h_ldexp
 (
lua_S‹
 *
L
) {

336 
lua_Numb”
 
x
 = 
	`luaL_checknumb”
(
L
, 1);

337 
•
 = ()
	`luaL_checkš‹g”
(
L
, 2);

338 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
ldexp
)(
x
, 
•
));

340 
	}
}

342 
	$m©h_log10
 (
lua_S‹
 *
L
) {

343 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
log10
)(
	`luaL_checknumb”
(L, 1)));

345 
	}
}

352 cÚ¡ 
luaL_Reg
 
	gm©hlib
[] = {

353 {"abs", 
m©h_abs
},

354 {"acos", 
m©h_acos
},

355 {"asš", 
m©h_asš
},

356 {"©ª", 
m©h_©ª
},

357 {"û", 
m©h_û
},

358 {"cos", 
m©h_cos
},

359 {"deg", 
m©h_deg
},

360 {"exp", 
m©h_exp
},

361 {"toš‹g”", 
m©h_tošt
},

362 {"æoÜ", 
m©h_æoÜ
},

363 {"fmod", 
m©h_fmod
},

364 {"uÉ", 
m©h_uÉ
},

365 {"log", 
m©h_log
},

366 {"max", 
m©h_max
},

367 {"mš", 
m©h_mš
},

368 {"modf", 
m©h_modf
},

369 {"¿d", 
m©h_¿d
},

370 {"¿ndom", 
m©h_¿ndom
},

371 {"¿ndom£ed", 
m©h_¿ndom£ed
},

372 {"sš", 
m©h_sš
},

373 {"sq¹", 
m©h_sq¹
},

374 {"n", 
m©h_n
},

375 {"ty³", 
m©h_ty³
},

376 #ià
defšed
(
LUA_COMPAT_MATHLIB
)

377 {"©ª2", 
m©h_©ª
},

378 {"cosh", 
m©h_cosh
},

379 {"sšh", 
m©h_sšh
},

380 {"nh", 
m©h_nh
},

381 {"pow", 
m©h_pow
},

382 {"äexp", 
m©h_äexp
},

383 {"ldexp", 
m©h_ldexp
},

384 {"log10", 
m©h_log10
},

387 {"pi", 
NULL
},

388 {"huge", 
NULL
},

389 {"maxš‹g”", 
NULL
},

390 {"mšš‹g”", 
NULL
},

391 {
NULL
, NULL}

398 
LUAMOD_API
 
	$luaİ’_m©h
 (
lua_S‹
 *
L
) {

399 
	`luaL_Ãwlib
(
L
, 
m©hlib
);

400 
	`lua_pushnumb”
(
L
, 
PI
);

401 
	`lua_£tf›ld
(
L
, -2, "pi");

402 
	`lua_pushnumb”
(
L
, (
lua_Numb”
)
HUGE_VAL
);

403 
	`lua_£tf›ld
(
L
, -2, "huge");

404 
	`lua_pushš‹g”
(
L
, 
LUA_MAXINTEGER
);

405 
	`lua_£tf›ld
(
L
, -2, "maxinteger");

406 
	`lua_pushš‹g”
(
L
, 
LUA_MININTEGER
);

407 
	`lua_£tf›ld
(
L
, -2, "mininteger");

409 
	}
}

	@script/lua/lua-5.3.4/src/lmem.c

7 
	#lmem_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ddef.h
>

15 
	~"lua.h
"

17 
	~"ldebug.h
"

18 
	~"ldo.h
"

19 
	~"lgc.h
"

20 
	~"lmem.h
"

21 
	~"lobjeù.h
"

22 
	~"l¡©e.h
"

45 
	#MINSIZEARRAY
 4

	)

48 *
	$luaM_growaux_
 (
lua_S‹
 *
L
, *
block
, *
size
, 
size_t
 
size_–ems
,

49 
lim™
, cÚ¡ *
wh©
) {

50 *
Ãwblock
;

51 
Ãwsize
;

52 ià(*
size
 >ğ
lim™
/2) {

53 ià(*
size
 >ğ
lim™
)

54 
	`luaG_ruÃ¼Ü
(
L
, "toØmªy % Öim™ i %d)", 
wh©
, 
lim™
);

55 
Ãwsize
 = 
lim™
;

58 
Ãwsize
 = (*
size
)*2;

59 ià(
Ãwsize
 < 
MINSIZEARRAY
)

60 
Ãwsize
 = 
MINSIZEARRAY
;

62 
Ãwblock
 = 
	`luaM_»®locv
(
L
, 
block
, *
size
, 
Ãwsize
, 
size_–ems
);

63 *
size
 = 
Ãwsize
;

64  
Ãwblock
;

65 
	}
}

68 
l_nÜ‘
 
	$luaM_toobig
 (
lua_S‹
 *
L
) {

69 
	`luaG_ruÃ¼Ü
(
L
, "memory‡llocationƒrror: blockoo big");

70 
	}
}

77 *
	$luaM_»®loc_
 (
lua_S‹
 *
L
, *
block
, 
size_t
 
osize
, size_ˆ
nsize
) {

78 *
Ãwblock
;

79 
glob®_S‹
 *
g
 = 
	`G
(
L
);

80 
size_t
 
»®osize
 = (
block
è? 
osize
 : 0;

81 
	`lua_as£¹
((
»®osize
 =ğ0è=ğ(
block
 =ğ
NULL
));

82 #ià
	`defšed
(
HARDMEMTESTS
)

83 ià(
nsize
 > 
»®osize
 && 
g
->
güuÂšg
)

84 
	`luaC_fuÎgc
(
L
, 1);

86 
Ãwblock
 = (*
g
->
ä—Îoc
)(g->
ud
, 
block
, 
osize
, 
nsize
);

87 ià(
Ãwblock
 =ğ
NULL
 && 
nsize
 > 0) {

88 
	`lua_as£¹
(
nsize
 > 
»®osize
);

89 ià(
g
->
v”siÚ
) {

90 
	`luaC_fuÎgc
(
L
, 1);

91 
Ãwblock
 = (*
g
->
ä—Îoc
)(g->
ud
, 
block
, 
osize
, 
nsize
);

93 ià(
Ãwblock
 =ğ
NULL
)

94 
	`luaD_throw
(
L
, 
LUA_ERRMEM
);

96 
	`lua_as£¹
((
nsize
 =ğ0è=ğ(
Ãwblock
 =ğ
NULL
));

97 
g
->
GCdebt
 = (g->GCdebˆ+ 
nsize
è- 
»®osize
;

98  
Ãwblock
;

99 
	}
}

	@script/lua/lua-5.3.4/src/lmem.h

7 #iâdeà
lmem_h


8 
	#lmem_h


	)

11 
	~<¡ddef.h
>

13 
	~"Îim™s.h
"

14 
	~"lua.h
"

30 
	#luaM_»®locv
(
L
,
b
,
Ú
,
n
,
e
) \

31 ((((
n
è>ğ(
size_t
è&& 
	`ÿ¡
(size_t, (n)è+ 1 > 
MAX_SIZET
/(
e
)) \

32 ? 
	`luaM_toobig
(
L
è: 
	`ÿ¡_void
(0)) , \

33 
	`luaM_»®loc_
(
L
, (
b
), (
Ú
)*(
e
), (
n
)*Ó)))

	)

38 
	#luaM_»®locvch¬
(
L
,
b
,
Ú
,
n
) \

39 
	`ÿ¡
(*, 
	`luaM_»®loc_
(
L
, (
b
), (
Ú
)*(), (
n
)*()))

	)

41 
	#luaM_ä“mem
(
L
, 
b
, 
s
è
	`luaM_»®loc_
(L, (b), (s), 0)

	)

42 
	#luaM_ä“
(
L
, 
b
è
	`luaM_»®loc_
(L, (b), (*(b)), 0)

	)

43 
	#luaM_ä“¬¿y
(
L
, 
b
, 
n
è
	`luaM_»®loc_
(L, (b), (n)*(*(b)), 0)

	)

45 
	#luaM_m®loc
(
L
,
s
è
	`luaM_»®loc_
(L, 
NULL
, 0, (s))

	)

46 
	#luaM_Ãw
(
L
,
t
è
	`ÿ¡
Ñ *, 
	`luaM_m®loc
(L, Ñ)))

	)

47 
	#luaM_ÃwveùÜ
(
L
,
n
,
t
) \

48 
	`ÿ¡
(
t
 *, 
	`luaM_»®locv
(
L
, 
NULL
, 0, 
n
, Ñ)))

	)

50 
	#luaM_Ãwobjeù
(
L
,
g
,
s
è
	`luaM_»®loc_
(L, 
NULL
,ag, (s))

	)

52 
	#luaM_growveùÜ
(
L
,
v
,
ÃËms
,
size
,
t
,
lim™
,
e
) \

53 ià((
ÃËms
)+1 > (
size
)) \

54 ((
v
)=
	`ÿ¡
(
t
 *, 
	`luaM_growaux_
(
L
,v,&(
size
),Ñ),
lim™
,
e
)))

	)

56 
	#luaM_»®locveùÜ
(
L
, 
v
,
Şdn
,
n
,
t
) \

57 ((
v
)=
	`ÿ¡
(
t
 *, 
	`luaM_»®locv
(
L
, v, 
Şdn
, 
n
, Ñ))))

	)

59 
LUAI_FUNC
 
l_nÜ‘
 
luaM_toobig
 (
lua_S‹
 *
L
);

62 
LUAI_FUNC
 *
luaM_»®loc_
 (
lua_S‹
 *
L
, *
block
, 
size_t
 
Şdsize
,

63 
size_t
 
size
);

64 
LUAI_FUNC
 *
luaM_growaux_
 (
lua_S‹
 *
L
, *
block
, *
size
,

65 
size_t
 
size_–em
, 
lim™
,

66 cÚ¡ *
wh©
);

	@script/lua/lua-5.3.4/src/loadlib.c

11 
	#lßdlib_c


	)

12 
	#LUA_LIB


	)

14 
	~"Í»fix.h
"

17 
	~<¡dio.h
>

18 
	~<¡dlib.h
>

19 
	~<¡ršg.h
>

21 
	~"lua.h
"

23 
	~"Ïuxlib.h
"

24 
	~"lu®ib.h
"

31 #ià!
defšed
 (
LUA_IGMARK
)

32 
	#LUA_IGMARK
 "-"

	)

42 #ià!
defšed
(
LUA_CSUBSEP
)

43 
	#LUA_CSUBSEP
 
LUA_DIRSEP


	)

46 #ià!
defšed
(
LUA_LSUBSEP
)

47 
	#LUA_LSUBSEP
 
LUA_DIRSEP


	)

52 
	#LUA_POF
 "luaİ’_"

	)

55 
	#LUA_OFSEP
 "_"

	)

62 cÚ¡ 
	gCLIBS
 = 0;

64 
	#LIB_FAIL
 "İ’"

	)

67 
	#£rogdœ
(
L
è(()0)

	)

77 
lsys_uÆßdlib
 (*
lib
);

85 *
lsys_lßd
 (
lua_S‹
 *
L
, cÚ¡ *
·th
, 
£eglb
);

92 
lua_CFunùiÚ
 
lsys_sym
 (
lua_S‹
 *
L
, *
lib
, cÚ¡ *
sym
);

97 #ià
defšed
(
LUA_USE_DLOPEN
)

107 
	~<dlfú.h
>

114 #ià
defšed
(
__GNUC__
)

115 
	#ÿ¡_func
(
p
è(
	`__ex‹nsiÚ__
 (
lua_CFunùiÚ
)Õ))

	)

117 
	#ÿ¡_func
(
p
è((
lua_CFunùiÚ
)Õ))

	)

121 
	$lsys_uÆßdlib
 (*
lib
) {

122 
	`dlşo£
(
lib
);

123 
	}
}

126 *
	$lsys_lßd
 (
lua_S‹
 *
L
, cÚ¡ *
·th
, 
£eglb
) {

127 *
lib
 = 
	`dlİ’
(
·th
, 
RTLD_NOW
 | (
£eglb
 ? 
RTLD_GLOBAL
 : 
RTLD_LOCAL
));

128 ià(
lib
 =ğ
NULL
è
	`lua_push¡ršg
(
L
, 
	`dË¼Ü
());

129  
lib
;

130 
	}
}

133 
lua_CFunùiÚ
 
	$lsys_sym
 (
lua_S‹
 *
L
, *
lib
, cÚ¡ *
sym
) {

134 
lua_CFunùiÚ
 
f
 = 
	`ÿ¡_func
(
	`dlsym
(
lib
, 
sym
));

135 ià(
f
 =ğ
NULL
è
	`lua_push¡ršg
(
L
, 
	`dË¼Ü
());

136  
f
;

137 
	}
}

143 #–ià
defšed
(
LUA_DL_DLL
)

150 
	~<wšdows.h
>

156 #ià!
defšed
(
LUA_LLE_FLAGS
)

157 
	#LUA_LLE_FLAGS
 0

	)

161 #undeà
£rogdœ


168 
	$£rogdœ
 (
lua_S‹
 *
L
) {

169 
buff
[
MAX_PATH
 + 1];

170 *
lb
;

171 
DWORD
 
nsize
 = (
buff
)/();

172 
DWORD
 
n
 = 
	`G‘ModuËFeNameA
(
NULL
, 
buff
, 
nsize
);

173 ià(
n
 =ğ0 ||‚ =ğ
nsize
 || (
lb
 = 
	`¡¼chr
(
buff
, '\\')è=ğ
NULL
)

174 
	`luaL_”rÜ
(
L
, "unableo get ModuleFileName");

176 *
lb
 = '\0';

177 
	`luaL_gsub
(
L
, 
	`lua_to¡ršg
(L, -1), 
LUA_EXEC_DIR
, 
buff
);

178 
	`lua_»move
(
L
, -2);

180 
	}
}

185 
	$push”rÜ
 (
lua_S‹
 *
L
) {

186 
”rÜ
 = 
	`G‘La¡E¼Ü
();

187 
bufãr
[128];

188 ià(
	`FÜm©Mes§geA
(
FORMAT_MESSAGE_IGNORE_INSERTS
 | 
FORMAT_MESSAGE_FROM_SYSTEM
,

189 
NULL
, 
”rÜ
, 0, 
bufãr
, (buffer)/(), NULL))

190 
	`lua_push¡ršg
(
L
, 
bufãr
);

192 
	`lua_pushf¡ršg
(
L
, "sy¡emƒ¼Ü %d\n", 
”rÜ
);

193 
	}
}

195 
	$lsys_uÆßdlib
 (*
lib
) {

196 
	`F»eLib¿ry
((
HMODULE
)
lib
);

197 
	}
}

200 *
	$lsys_lßd
 (
lua_S‹
 *
L
, cÚ¡ *
·th
, 
£eglb
) {

201 
HMODULE
 
lib
 = 
	`LßdLib¿ryExA
(
·th
, 
NULL
, 
LUA_LLE_FLAGS
);

202 ()(
£eglb
);

203 ià(
lib
 =ğ
NULL
è
	`push”rÜ
(
L
);

204  
lib
;

205 
	}
}

208 
lua_CFunùiÚ
 
	$lsys_sym
 (
lua_S‹
 *
L
, *
lib
, cÚ¡ *
sym
) {

209 
lua_CFunùiÚ
 
f
 = (lua_CFunùiÚ)
	`G‘ProcAdd»ss
((
HMODULE
)
lib
, 
sym
);

210 ià(
f
 =ğ
NULL
è
	`push”rÜ
(
L
);

211  
f
;

212 
	}
}

224 #undeà
LIB_FAIL


225 
	#LIB_FAIL
 "ab£Á"

	)

228 
	#DLMSG
 "dyÇmiølib¿r› nÙƒÇbËd; check you¸Lu¨š¡®ÏtiÚ"

	)

231 
	$lsys_uÆßdlib
 (*
lib
) {

232 ()(
lib
);

233 
	}
}

236 *
	$lsys_lßd
 (
lua_S‹
 *
L
, cÚ¡ *
·th
, 
£eglb
) {

237 ()(
·th
); ()(
£eglb
);

238 
	`lua_pushl™”®
(
L
, 
DLMSG
);

239  
NULL
;

240 
	}
}

243 
lua_CFunùiÚ
 
	$lsys_sym
 (
lua_S‹
 *
L
, *
lib
, cÚ¡ *
sym
) {

244 ()(
lib
); ()(
sym
);

245 
	`lua_pushl™”®
(
L
, 
DLMSG
);

246  
NULL
;

247 
	}
}

263 #ià!
defšed
(
LUA_PATH_VAR
)

264 
	#LUA_PATH_VAR
 "LUA_PATH"

	)

267 #ià!
defšed
(
LUA_CPATH_VAR
)

268 
	#LUA_CPATH_VAR
 "LUA_CPATH"

	)

272 
	#AUXMARK
 "\1"

	)

278 
	$nÛnv
 (
lua_S‹
 *
L
) {

279 
b
;

280 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, "LUA_NOENV");

281 
b
 = 
	`lua_toboŞ—n
(
L
, -1);

282 
	`lua_pİ
(
L
, 1);

283  
b
;

284 
	}
}

290 
	$£©h
 (
lua_S‹
 *
L
, cÚ¡ *
f›ldÇme
,

291 cÚ¡ *
’vÇme
,

292 cÚ¡ *
dá
) {

293 cÚ¡ *
nv”
 = 
	`lua_pushf¡ršg
(
L
, "%s%s", 
’vÇme
, 
LUA_VERSUFFIX
);

294 cÚ¡ *
·th
 = 
	`g‘’v
(
nv”
);

295 ià(
·th
 =ğ
NULL
)

296 
·th
 = 
	`g‘’v
(
’vÇme
);

297 ià(
·th
 =ğ
NULL
 || 
	`nÛnv
(
L
))

298 
	`lua_push¡ršg
(
L
, 
dá
);

301 
·th
 = 
	`luaL_gsub
(
L
,…©h, 
LUA_PATH_SEP
 LUA_PATH_SEP,

302 
LUA_PATH_SEP
 
AUXMARK
 LUA_PATH_SEP);

303 
	`luaL_gsub
(
L
, 
·th
, 
AUXMARK
, 
dá
);

304 
	`lua_»move
(
L
, -2);

306 
	`£rogdœ
(
L
);

307 
	`lua_£tf›ld
(
L
, -3, 
f›ldÇme
);

308 
	`lua_pİ
(
L
, 1);

309 
	}
}

317 *
	$checkşib
 (
lua_S‹
 *
L
, cÚ¡ *
·th
) {

318 *
¶ib
;

319 
	`lua_¿wg‘p
(
L
, 
LUA_REGISTRYINDEX
, &
CLIBS
);

320 
	`lua_g‘f›ld
(
L
, -1, 
·th
);

321 
¶ib
 = 
	`lua_tou£rd©a
(
L
, -1);

322 
	`lua_pİ
(
L
, 2);

323  
¶ib
;

324 
	}
}

331 
	$addtoşib
 (
lua_S‹
 *
L
, cÚ¡ *
·th
, *
¶ib
) {

332 
	`lua_¿wg‘p
(
L
, 
LUA_REGISTRYINDEX
, &
CLIBS
);

333 
	`lua_pushlightu£rd©a
(
L
, 
¶ib
);

334 
	`lua_pushv®ue
(
L
, -1);

335 
	`lua_£tf›ld
(
L
, -3, 
·th
);

336 
	`lua_¿w£ti
(
L
, -2, 
	`luaL_Ën
(L, -2) + 1);

337 
	`lua_pİ
(
L
, 1);

338 
	}
}

345 
	$gùm
 (
lua_S‹
 *
L
) {

346 
lua_IÁeg”
 
n
 = 
	`luaL_Ën
(
L
, 1);

347 ; 
n
 >= 1;‚--) {

348 
	`lua_¿wg‘i
(
L
, 1, 
n
);

349 
	`lsys_uÆßdlib
(
	`lua_tou£rd©a
(
L
, -1));

350 
	`lua_pİ
(
L
, 1);

353 
	}
}

358 
	#ERRLIB
 1

	)

359 
	#ERRFUNC
 2

	)

372 
	$lookfÜfunc
 (
lua_S‹
 *
L
, cÚ¡ *
·th
, cÚ¡ *
sym
) {

373 *
»g
 = 
	`checkşib
(
L
, 
·th
);

374 ià(
»g
 =ğ
NULL
) {

375 
»g
 = 
	`lsys_lßd
(
L
, 
·th
, *
sym
 == '*');

376 ià(
»g
 =ğ
NULL
è 
ERRLIB
;

377 
	`addtoşib
(
L
, 
·th
, 
»g
);

379 ià(*
sym
 == '*') {

380 
	`lua_pushboŞ—n
(
L
, 1);

384 
lua_CFunùiÚ
 
f
 = 
	`lsys_sym
(
L
, 
»g
, 
sym
);

385 ià(
f
 =ğ
NULL
)

386  
ERRFUNC
;

387 
	`lua_pushcfunùiÚ
(
L
, 
f
);

390 
	}
}

393 
	$Î_lßdlib
 (
lua_S‹
 *
L
) {

394 cÚ¡ *
·th
 = 
	`luaL_check¡ršg
(
L
, 1);

395 cÚ¡ *
š™
 = 
	`luaL_check¡ršg
(
L
, 2);

396 
¡©
 = 
	`lookfÜfunc
(
L
, 
·th
, 
š™
);

397 ià(
¡©
 == 0)

400 
	`lua_pushn
(
L
);

401 
	`lua_š£¹
(
L
, -2);

402 
	`lua_push¡ršg
(
L
, (
¡©
 =ğ
ERRLIB
è? 
LIB_FAIL
 : "init");

405 
	}
}

416 
	$»adabË
 (cÚ¡ *
f’ame
) {

417 
FILE
 *
f
 = 
	`fİ’
(
f’ame
, "r");

418 ià(
f
 =ğ
NULL
)  0;

419 
	`fşo£
(
f
);

421 
	}
}

424 cÚ¡ *
	$pushÃx‰em¶©e
 (
lua_S‹
 *
L
, cÚ¡ *
·th
) {

425 cÚ¡ *
l
;

426 *
·th
 =ğ*
LUA_PATH_SEP
)…ath++;

427 ià(*
·th
 =ğ'\0'è 
NULL
;

428 
l
 = 
	`¡rchr
(
·th
, *
LUA_PATH_SEP
);

429 ià(
l
 =ğ
NULL
èÈğ
·th
 + 
	`¡¾’
(path);

430 
	`lua_pushl¡ršg
(
L
, 
·th
, 
l
 -…ath);

431  
l
;

432 
	}
}

435 cÚ¡ *
	$£¬ch·th
 (
lua_S‹
 *
L
, cÚ¡ *
Çme
,

436 cÚ¡ *
·th
,

437 cÚ¡ *
£p
,

438 cÚ¡ *
dœ£p
) {

439 
luaL_Bufãr
 
msg
;

440 
	`luaL_buffš™
(
L
, &
msg
);

441 ià(*
£p
 != '\0')

442 
Çme
 = 
	`luaL_gsub
(
L
,‚ame, 
£p
, 
dœ£p
);

443 (
·th
 = 
	`pushÃx‰em¶©e
(
L
,…©h)è!ğ
NULL
) {

444 cÚ¡ *
f’ame
 = 
	`luaL_gsub
(
L
, 
	`lua_to¡ršg
(L, -1),

445 
LUA_PATH_MARK
, 
Çme
);

446 
	`lua_»move
(
L
, -2);

447 ià(
	`»adabË
(
f’ame
))

448  
f’ame
;

449 
	`lua_pushf¡ršg
(
L
, "\n\ŠØf'%s'", 
f’ame
);

450 
	`lua_»move
(
L
, -2);

451 
	`luaL_addv®ue
(&
msg
);

453 
	`luaL_push»suÉ
(&
msg
);

454  
NULL
;

455 
	}
}

458 
	$Î_£¬ch·th
 (
lua_S‹
 *
L
) {

459 cÚ¡ *
f
 = 
	`£¬ch·th
(
L
, 
	`luaL_check¡ršg
(L, 1),

460 
	`luaL_check¡ršg
(
L
, 2),

461 
	`luaL_İt¡ršg
(
L
, 3, "."),

462 
	`luaL_İt¡ršg
(
L
, 4, 
LUA_DIRSEP
));

463 ià(
f
 !ğ
NULL
)  1;

465 
	`lua_pushn
(
L
);

466 
	`lua_š£¹
(
L
, -2);

469 
	}
}

472 cÚ¡ *
	$fšdfe
 (
lua_S‹
 *
L
, cÚ¡ *
Çme
,

473 cÚ¡ *
²ame
,

474 cÚ¡ *
dœ£p
) {

475 cÚ¡ *
·th
;

476 
	`lua_g‘f›ld
(
L
, 
	`lua_upv®uešdex
(1), 
²ame
);

477 
·th
 = 
	`lua_to¡ršg
(
L
, -1);

478 ià(
·th
 =ğ
NULL
)

479 
	`luaL_”rÜ
(
L
, "'·ckage.%s' mu¡ b¨¡ršg", 
²ame
);

480  
	`£¬ch·th
(
L
, 
Çme
, 
·th
, ".", 
dœ£p
);

481 
	}
}

484 
	$checklßd
 (
lua_S‹
 *
L
, 
¡©
, cÚ¡ *
f’ame
) {

485 ià(
¡©
) {

486 
	`lua_push¡ršg
(
L
, 
f’ame
);

490  
	`luaL_”rÜ
(
L
, "error†oading module '%s' from file '%s':\n\t%s",

491 
	`lua_to¡ršg
(
L
, 1), 
f’ame
,†ua_tostring(L, -1));

492 
	}
}

495 
	$£¬ch”_Lua
 (
lua_S‹
 *
L
) {

496 cÚ¡ *
f’ame
;

497 cÚ¡ *
Çme
 = 
	`luaL_check¡ršg
(
L
, 1);

498 
f’ame
 = 
	`fšdfe
(
L
, 
Çme
, "·th", 
LUA_LSUBSEP
);

499 ià(
f’ame
 =ğ
NULL
)  1;

500  
	`checklßd
(
L
, (
	`luaL_lßdfe
(L, 
f’ame
è=ğ
LUA_OK
), filename);

501 
	}
}

512 
	$lßdfunc
 (
lua_S‹
 *
L
, cÚ¡ *
f’ame
, cÚ¡ *
modÇme
) {

513 cÚ¡ *
İ’func
;

514 cÚ¡ *
m¬k
;

515 
modÇme
 = 
	`luaL_gsub
(
L
, modÇme, ".", 
LUA_OFSEP
);

516 
m¬k
 = 
	`¡rchr
(
modÇme
, *
LUA_IGMARK
);

517 ià(
m¬k
) {

518 
¡©
;

519 
İ’func
 = 
	`lua_pushl¡ršg
(
L
, 
modÇme
, 
m¬k
 - modname);

520 
İ’func
 = 
	`lua_pushf¡ršg
(
L
, 
LUA_POF
"%s", openfunc);

521 
¡©
 = 
	`lookfÜfunc
(
L
, 
f’ame
, 
İ’func
);

522 ià(
¡©
 !ğ
ERRFUNC
)  stat;

523 
modÇme
 = 
m¬k
 + 1;

525 
İ’func
 = 
	`lua_pushf¡ršg
(
L
, 
LUA_POF
"%s", 
modÇme
);

526  
	`lookfÜfunc
(
L
, 
f’ame
, 
İ’func
);

527 
	}
}

530 
	$£¬ch”_C
 (
lua_S‹
 *
L
) {

531 cÚ¡ *
Çme
 = 
	`luaL_check¡ršg
(
L
, 1);

532 cÚ¡ *
f’ame
 = 
	`fšdfe
(
L
, 
Çme
, "ı©h", 
LUA_CSUBSEP
);

533 ià(
f’ame
 =ğ
NULL
)  1;

534  
	`checklßd
(
L
, (
	`lßdfunc
(L, 
f’ame
, 
Çme
) == 0), filename);

535 
	}
}

538 
	$£¬ch”_CroÙ
 (
lua_S‹
 *
L
) {

539 cÚ¡ *
f’ame
;

540 cÚ¡ *
Çme
 = 
	`luaL_check¡ršg
(
L
, 1);

541 cÚ¡ *
p
 = 
	`¡rchr
(
Çme
, '.');

542 
¡©
;

543 ià(
p
 =ğ
NULL
)  0;

544 
	`lua_pushl¡ršg
(
L
, 
Çme
, 
p
 -‚ame);

545 
f’ame
 = 
	`fšdfe
(
L
, 
	`lua_to¡ršg
(L, -1), "ı©h", 
LUA_CSUBSEP
);

546 ià(
f’ame
 =ğ
NULL
)  1;

547 ià((
¡©
 = 
	`lßdfunc
(
L
, 
f’ame
, 
Çme
)) != 0) {

548 ià(
¡©
 !ğ
ERRFUNC
)

549  
	`checklßd
(
L
, 0, 
f’ame
);

551 
	`lua_pushf¡ršg
(
L
, "\n\ŠØmoduË '%s' iÀf'%s'", 
Çme
, 
f’ame
);

555 
	`lua_push¡ršg
(
L
, 
f’ame
);

557 
	}
}

560 
	$£¬ch”_´–ßd
 (
lua_S‹
 *
L
) {

561 cÚ¡ *
Çme
 = 
	`luaL_check¡ršg
(
L
, 1);

562 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_PRELOAD_TABLE
);

563 ià(
	`lua_g‘f›ld
(
L
, -1, 
Çme
è=ğ
LUA_TNIL
)

564 
	`lua_pushf¡ršg
(
L
, "\n\ŠØf›ld…ackage.´–ßd['%s']", 
Çme
);

566 
	}
}

569 
	$fšdlßd”
 (
lua_S‹
 *
L
, cÚ¡ *
Çme
) {

570 
i
;

571 
luaL_Bufãr
 
msg
;

572 
	`luaL_buffš™
(
L
, &
msg
);

574 ià(
	`lua_g‘f›ld
(
L
, 
	`lua_upv®uešdex
(1), "£¬ch”s"è!ğ
LUA_TTABLE
)

575 
	`luaL_”rÜ
(
L
, "'package.searchers' must be‡able");

577 
i
 = 1; ; i++) {

578 ià(
	`lua_¿wg‘i
(
L
, 3, 
i
è=ğ
LUA_TNIL
) {

579 
	`lua_pİ
(
L
, 1);

580 
	`luaL_push»suÉ
(&
msg
);

581 
	`luaL_”rÜ
(
L
, "moduË '%s'‚Ù found:%s", 
Çme
, 
	`lua_to¡ršg
(L, -1));

583 
	`lua_push¡ršg
(
L
, 
Çme
);

584 
	`lua_ÿÎ
(
L
, 1, 2);

585 ià(
	`lua_isfunùiÚ
(
L
, -2))

587 ià(
	`lua_is¡ršg
(
L
, -2)) {

588 
	`lua_pİ
(
L
, 1);

589 
	`luaL_addv®ue
(&
msg
);

592 
	`lua_pİ
(
L
, 2);

594 
	}
}

597 
	$Î_»quœe
 (
lua_S‹
 *
L
) {

598 cÚ¡ *
Çme
 = 
	`luaL_check¡ršg
(
L
, 1);

599 
	`lua_£‰İ
(
L
, 1);

600 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_LOADED_TABLE
);

601 
	`lua_g‘f›ld
(
L
, 2, 
Çme
);

602 ià(
	`lua_toboŞ—n
(
L
, -1))

605 
	`lua_pİ
(
L
, 1);

606 
	`fšdlßd”
(
L
, 
Çme
);

607 
	`lua_push¡ršg
(
L
, 
Çme
);

608 
	`lua_š£¹
(
L
, -2);

609 
	`lua_ÿÎ
(
L
, 2, 1);

610 ià(!
	`lua_i¢
(
L
, -1))

611 
	`lua_£tf›ld
(
L
, 2, 
Çme
);

612 ià(
	`lua_g‘f›ld
(
L
, 2, 
Çme
è=ğ
LUA_TNIL
) {

613 
	`lua_pushboŞ—n
(
L
, 1);

614 
	`lua_pushv®ue
(
L
, -1);

615 
	`lua_£tf›ld
(
L
, 2, 
Çme
);

618 
	}
}

629 #ià
defšed
(
LUA_COMPAT_MODULE
)

634 
	$£t_’v
 (
lua_S‹
 *
L
) {

635 
lua_Debug
 
¬
;

636 ià(
	`lua_g‘¡ack
(
L
, 1, &
¬
) == 0 ||

637 
	`lua_g‘šfo
(
L
, "f", &
¬
) == 0 ||

638 
	`lua_iscfunùiÚ
(
L
, -1))

639 
	`luaL_”rÜ
(
L
, "'module'‚ot called from‡ Lua function");

640 
	`lua_pushv®ue
(
L
, -2);

641 
	`lua_£tupv®ue
(
L
, -2, 1);

642 
	`lua_pİ
(
L
, 1);

643 
	}
}

646 
	$doİtiÚs
 (
lua_S‹
 *
L
, 
n
) {

647 
i
;

648 
i
 = 2; i <ğ
n
; i++) {

649 ià(
	`lua_isfunùiÚ
(
L
, 
i
)) {

650 
	`lua_pushv®ue
(
L
, 
i
);

651 
	`lua_pushv®ue
(
L
, -2);

652 
	`lua_ÿÎ
(
L
, 1, 0);

655 
	}
}

658 
	$modš™
 (
lua_S‹
 *
L
, cÚ¡ *
modÇme
) {

659 cÚ¡ *
dÙ
;

660 
	`lua_pushv®ue
(
L
, -1);

661 
	`lua_£tf›ld
(
L
, -2, "_M");

662 
	`lua_push¡ršg
(
L
, 
modÇme
);

663 
	`lua_£tf›ld
(
L
, -2, "_NAME");

664 
dÙ
 = 
	`¡¼chr
(
modÇme
, '.');

665 ià(
dÙ
 =ğ
NULL
èdÙ = 
modÇme
;

666 
dÙ
++;

668 
	`lua_pushl¡ršg
(
L
, 
modÇme
, 
dÙ
 - modname);

669 
	`lua_£tf›ld
(
L
, -2, "_PACKAGE");

670 
	}
}

673 
	$Î_moduË
 (
lua_S‹
 *
L
) {

674 cÚ¡ *
modÇme
 = 
	`luaL_check¡ršg
(
L
, 1);

675 
Ï¡¬g
 = 
	`lua_g‘tİ
(
L
);

676 
	`luaL_pushmoduË
(
L
, 
modÇme
, 1);

678 ià(
	`lua_g‘f›ld
(
L
, -1, "_NAME"è!ğ
LUA_TNIL
)

679 
	`lua_pİ
(
L
, 1);

681 
	`lua_pİ
(
L
, 1);

682 
	`modš™
(
L
, 
modÇme
);

684 
	`lua_pushv®ue
(
L
, -1);

685 
	`£t_’v
(
L
);

686 
	`doİtiÚs
(
L
, 
Ï¡¬g
);

688 
	}
}

691 
	$Î_£—Î
 (
lua_S‹
 *
L
) {

692 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

693 ià(!
	`lua_g‘m‘©abË
(
L
, 1)) {

694 
	`lua_ü—‹bË
(
L
, 0, 1);

695 
	`lua_pushv®ue
(
L
, -1);

696 
	`lua_£tm‘©abË
(
L
, 1);

698 
	`lua_pushglob®bË
(
L
);

699 
	`lua_£tf›ld
(
L
, -2, "__index");

701 
	}
}

708 cÚ¡ 
luaL_Reg
 
	gpk_funcs
[] = {

709 {"lßdlib", 
Î_lßdlib
},

710 {"£¬ch·th", 
Î_£¬ch·th
},

711 #ià
defšed
(
LUA_COMPAT_MODULE
)

712 {"£—Î", 
Î_£—Î
},

715 {"´–ßd", 
NULL
},

716 {"ı©h", 
NULL
},

717 {"·th", 
NULL
},

718 {"£¬ch”s", 
NULL
},

719 {"lßded", 
NULL
},

720 {
NULL
, NULL}

724 cÚ¡ 
luaL_Reg
 
	gÎ_funcs
[] = {

725 #ià
defšed
(
LUA_COMPAT_MODULE
)

726 {"moduË", 
Î_moduË
},

728 {"»quœe", 
Î_»quœe
},

729 {
NULL
, NULL}

733 
	$ü—‹£¬ch”¡abË
 (
lua_S‹
 *
L
) {

734 cÚ¡ 
lua_CFunùiÚ
 
£¬ch”s
[] =

735 {
£¬ch”_´–ßd
, 
£¬ch”_Lua
, 
£¬ch”_C
, 
£¬ch”_CroÙ
, 
NULL
};

736 
i
;

738 
	`lua_ü—‹bË
(
L
, (
£¬ch”s
)/(searchers[0]) - 1, 0);

740 
i
=0; 
£¬ch”s
[i] !ğ
NULL
; i++) {

741 
	`lua_pushv®ue
(
L
, -2);

742 
	`lua_pushcşosu»
(
L
, 
£¬ch”s
[
i
], 1);

743 
	`lua_¿w£ti
(
L
, -2, 
i
+1);

745 #ià
	`defšed
(
LUA_COMPAT_LOADERS
)

746 
	`lua_pushv®ue
(
L
, -1);

747 
	`lua_£tf›ld
(
L
, -3, "loaders");

749 
	`lua_£tf›ld
(
L
, -2, "searchers");

750 
	}
}

757 
	$ü—‹şib¡abË
 (
lua_S‹
 *
L
) {

758 
	`lua_ÃwbË
(
L
);

759 
	`lua_ü—‹bË
(
L
, 0, 1);

760 
	`lua_pushcfunùiÚ
(
L
, 
gùm
);

761 
	`lua_£tf›ld
(
L
, -2, "__gc");

762 
	`lua_£tm‘©abË
(
L
, -2);

763 
	`lua_¿w£
(
L
, 
LUA_REGISTRYINDEX
, &
CLIBS
);

764 
	}
}

767 
LUAMOD_API
 
	$luaİ’_·ckage
 (
lua_S‹
 *
L
) {

768 
	`ü—‹şib¡abË
(
L
);

769 
	`luaL_Ãwlib
(
L
, 
pk_funcs
);

770 
	`ü—‹£¬ch”¡abË
(
L
);

772 
	`£©h
(
L
, "·th", 
LUA_PATH_VAR
, 
LUA_PATH_DEFAULT
);

773 
	`£©h
(
L
, "ı©h", 
LUA_CPATH_VAR
, 
LUA_CPATH_DEFAULT
);

775 
	`lua_pushl™”®
(
L
, 
LUA_DIRSEP
 "\n" 
LUA_PATH_SEP
 "\n" 
LUA_PATH_MARK
 "\n"

776 
LUA_EXEC_DIR
 "\n" 
LUA_IGMARK
 "\n");

777 
	`lua_£tf›ld
(
L
, -2, "config");

779 
	`luaL_g‘subbË
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_LOADED_TABLE
);

780 
	`lua_£tf›ld
(
L
, -2, "loaded");

782 
	`luaL_g‘subbË
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_PRELOAD_TABLE
);

783 
	`lua_£tf›ld
(
L
, -2, "preload");

784 
	`lua_pushglob®bË
(
L
);

785 
	`lua_pushv®ue
(
L
, -2);

786 
	`luaL_£tfuncs
(
L
, 
Î_funcs
, 1);

787 
	`lua_pİ
(
L
, 1);

789 
	}
}

	@script/lua/lua-5.3.4/src/lobject.c

7 
	#lobjeù_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<loÿË.h
>

14 
	~<m©h.h
>

15 
	~<¡d¬g.h
>

16 
	~<¡dio.h
>

17 
	~<¡dlib.h
>

18 
	~<¡ršg.h
>

20 
	~"lua.h
"

22 
	~"lùy³.h
"

23 
	~"ldebug.h
"

24 
	~"ldo.h
"

25 
	~"lmem.h
"

26 
	~"lobjeù.h
"

27 
	~"l¡©e.h
"

28 
	~"l¡ršg.h
"

29 
	~"lvm.h
"

33 
LUAI_DDEF
 cÚ¡ 
TV®ue
 
	gluaO_nobjeù_
 = {
NILCONSTANT
};

41 
	$luaO_št2fb
 (
x
) {

42 
e
 = 0;

43 ià(
x
 < 8)  x;

44 
x
 >= (8 << 4)) {

45 
x
 = (x + 0xf) >> 4;

46 
e
 += 4;

48 
x
 >= (8 << 1)) {

49 
x
 = (x + 1) >> 1;

50 
e
++;

52  ((
e
+1è<< 3è| (
	`ÿ¡_št
(
x
) - 8);

53 
	}
}

57 
	$luaO_fb2št
 (
x
) {

58  (
x
 < 8) ? x : ((x & 7) + 8) << ((x >> 3) - 1);

59 
	}
}

65 
	$luaO_ûlog2
 (
x
) {

66 cÚ¡ 
lu_by‹
 
log_2
[256] = {

76 
l
 = 0;

77 
x
--;

78 
x
 >ğ256è{ 
l
 += 8; x >>= 8; }

79  
l
 + 
log_2
[
x
];

80 
	}
}

83 
lua_IÁeg”
 
	$šr™h
 (
lua_S‹
 *
L
, 
İ
, 
lua_IÁeg”
 
v1
,

84 
lua_IÁeg”
 
v2
) {

85 
İ
) {

86 
LUA_OPADD
:  
	`štİ
(+, 
v1
, 
v2
);

87 
LUA_OPSUB
: 
	`štİ
(-, 
v1
, 
v2
);

88 
LUA_OPMUL
: 
	`štİ
(*, 
v1
, 
v2
);

89 
LUA_OPMOD
:  
	`luaV_mod
(
L
, 
v1
, 
v2
);

90 
LUA_OPIDIV
:  
	`luaV_div
(
L
, 
v1
, 
v2
);

91 
LUA_OPBAND
:  
	`štİ
(&, 
v1
, 
v2
);

92 
LUA_OPBOR
:  
	`štİ
(|, 
v1
, 
v2
);

93 
LUA_OPBXOR
:  
	`štİ
(^, 
v1
, 
v2
);

94 
LUA_OPSHL
:  
	`luaV_shiál
(
v1
, 
v2
);

95 
LUA_OPSHR
:  
	`luaV_shiál
(
v1
, -
v2
);

96 
LUA_OPUNM
:  
	`štİ
(-, 0, 
v1
);

97 
LUA_OPBNOT
:  
	`štİ
(^, ~
	`l_ÿ¡S2U
(0), 
v1
);

98 : 
	`lua_as£¹
(0);  0;

100 
	}
}

103 
lua_Numb”
 
	$num¬™h
 (
lua_S‹
 *
L
, 
İ
, 
lua_Numb”
 
v1
,

104 
lua_Numb”
 
v2
) {

105 
İ
) {

106 
LUA_OPADD
:  
	`luai_numadd
(
L
, 
v1
, 
v2
);

107 
LUA_OPSUB
:  
	`luai_numsub
(
L
, 
v1
, 
v2
);

108 
LUA_OPMUL
:  
	`luai_nummul
(
L
, 
v1
, 
v2
);

109 
LUA_OPDIV
:  
	`luai_numdiv
(
L
, 
v1
, 
v2
);

110 
LUA_OPPOW
:  
	`luai_numpow
(
L
, 
v1
, 
v2
);

111 
LUA_OPIDIV
:  
	`luai_numidiv
(
L
, 
v1
, 
v2
);

112 
LUA_OPUNM
:  
	`luai_numunm
(
L
, 
v1
);

113 
LUA_OPMOD
: {

114 
lua_Numb”
 
m
;

115 
	`luai_nummod
(
L
, 
v1
, 
v2
, 
m
);

116  
m
;

118 : 
	`lua_as£¹
(0);  0;

120 
	}
}

123 
	$luaO_¬™h
 (
lua_S‹
 *
L
, 
İ
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
,

124 
TV®ue
 *
»s
) {

125 
İ
) {

126 
LUA_OPBAND
: 
LUA_OPBOR
: 
LUA_OPBXOR
:

127 
LUA_OPSHL
: 
LUA_OPSHR
:

128 
LUA_OPBNOT
: {

129 
lua_IÁeg”
 
i1
;†ua_IÁeg” 
i2
;

130 ià(
	`toš‹g”
(
p1
, &
i1
è&&oš‹g”(
p2
, &
i2
)) {

131 
	`£tiv®ue
(
»s
, 
	`šr™h
(
L
, 
İ
, 
i1
, 
i2
));

136 
LUA_OPDIV
: 
LUA_OPPOW
: {

137 
lua_Numb”
 
n1
;†ua_Numb” 
n2
;

138 ià(
	`tÚumb”
(
p1
, &
n1
è&&Úumb”(
p2
, &
n2
)) {

139 
	`£tætv®ue
(
»s
, 
	`num¬™h
(
L
, 
İ
, 
n1
, 
n2
));

145 
lua_Numb”
 
n1
;†ua_Numb” 
n2
;

146 ià(
	`‰isš‹g”
(
p1
è&&tisš‹g”(
p2
)) {

147 
	`£tiv®ue
(
»s
, 
	`šr™h
(
L
, 
İ
, 
	`iv®ue
(
p1
), iv®ue(
p2
)));

150 ià(
	`tÚumb”
(
p1
, &
n1
è&&Úumb”(
p2
, &
n2
)) {

151 
	`£tætv®ue
(
»s
, 
	`num¬™h
(
L
, 
İ
, 
n1
, 
n2
));

158 
	`lua_as£¹
(
L
 !ğ
NULL
);

159 
	`luaT_ŒybšTM
(
L
, 
p1
, 
p2
, 
»s
, 
	`ÿ¡
(
TMS
, (
İ
 - 
LUA_OPADD
è+ 
TM_ADD
));

160 
	}
}

163 
	$luaO_hexav®ue
 (
c
) {

164 ià(
	`lisdig™
(
c
))  c - '0';

165  (
	`ÉŞow”
(
c
) - 'a') + 10;

166 
	}
}

169 
	$i¢eg
 (cÚ¡ **
s
) {

170 ià(**
s
 == '-') { (*s)++;  1; }

171 ià(**
s
 == '+') (*s)++;

173 
	}
}

183 #ià!
defšed
(
lua_¡rx2numb”
)

187 
	#MAXSIGDIG
 30

	)

193 
lua_Numb”
 
	$lua_¡rx2numb”
 (cÚ¡ *
s
, **
’d±r
) {

194 
dÙ
 = 
	`lua_g‘loÿËdeıošt
();

195 
lua_Numb”
 
r
 = 0.0;

196 
sigdig
 = 0;

197 
nosigdig
 = 0;

198 
e
 = 0;

199 
Ãg
;

200 
hasdÙ
 = 0;

201 *
’d±r
 = 
	`ÿ¡
(*, 
s
);

202 
	`lis¥aû
(
	`ÿ¡_uch¬
(*
s
))) s++;

203 
Ãg
 = 
	`i¢eg
(&
s
);

204 ià(!(*
s
 == '0' && (*(s + 1) == 'x' || *(s + 1) == 'X')))

206 
s
 += 2; ; s++) {

207 ià(*
s
 =ğ
dÙ
) {

208 ià(
hasdÙ
) ;

209 
hasdÙ
 = 1;

211 ià(
	`lisxdig™
(
	`ÿ¡_uch¬
(*
s
))) {

212 ià(
sigdig
 =ğ0 && *
s
 == '0')

213 
nosigdig
++;

214 ià(++
sigdig
 <ğ
MAXSIGDIG
)

215 
r
 = (¸* 
	`ÿ¡_num
(16.0)è+ 
	`luaO_hexav®ue
(*
s
);

216 
e
++;

217 ià(
hasdÙ
è
e
--;

221 ià(
nosigdig
 + 
sigdig
 == 0)

223 *
’d±r
 = 
	`ÿ¡
(*, 
s
);

224 
e
 *= 4;

225 ià(*
s
 == 'p' || *s == 'P') {

226 
exp1
 = 0;

227 
Ãg1
;

228 
s
++;

229 
Ãg1
 = 
	`i¢eg
(&
s
);

230 ià(!
	`lisdig™
(
	`ÿ¡_uch¬
(*
s
)))

232 
	`lisdig™
(
	`ÿ¡_uch¬
(*
s
)))

233 
exp1
 =ƒxp1 * 10 + *(
s
++) - '0';

234 ià(
Ãg1
è
exp1
 = -exp1;

235 
e
 +ğ
exp1
;

236 *
’d±r
 = 
	`ÿ¡
(*, 
s
);

238 ià(
Ãg
è
r
 = -r;

239  
	`l_m©hİ
(
ldexp
)(
r
, 
e
);

240 
	}
}

247 #ià!
defšed
 (
L_MAXLENNUM
)

248 
	#L_MAXLENNUM
 200

	)

251 cÚ¡ *
	$l_¡r2dloc
 (cÚ¡ *
s
, 
lua_Numb”
 *
»suÉ
, 
mode
) {

252 *
’d±r
;

253 *
»suÉ
 = (
mode
 =ğ'x'è? 
	`lua_¡rx2numb”
(
s
, &
’d±r
)

254 : 
	`lua_¡r2numb”
(
s
, &
’d±r
);

255 ià(
’d±r
 =ğ
s
è 
NULL
;

256 
	`lis¥aû
(
	`ÿ¡_uch¬
(*
’d±r
)))ƒndptr++;

257  (*
’d±r
 =ğ'\0'è?ƒnd±¸: 
NULL
;

258 
	}
}

274 cÚ¡ *
	$l_¡r2d
 (cÚ¡ *
s
, 
lua_Numb”
 *
»suÉ
) {

275 cÚ¡ *
’d±r
;

276 cÚ¡ *
pmode
 = 
	`¡½brk
(
s
, ".xXnN");

277 
mode
 = 
pmode
 ? 
	`ÉŞow”
(
	`ÿ¡_uch¬
(*pmode)) : 0;

278 ià(
mode
 == 'n')

279  
NULL
;

280 
’d±r
 = 
	`l_¡r2dloc
(
s
, 
»suÉ
, 
mode
);

281 ià(
’d±r
 =ğ
NULL
) {

282 
buff
[
L_MAXLENNUM
 + 1];

283 cÚ¡ *
pdÙ
 = 
	`¡rchr
(
s
, '.');

284 ià(
	`¡¾’
(
s
è> 
L_MAXLENNUM
 || 
pdÙ
 =ğ
NULL
)

285  
NULL
;

286 
	`¡rıy
(
buff
, 
s
);

287 
buff
[
pdÙ
 - 
s
] = 
	`lua_g‘loÿËdeıošt
();

288 
’d±r
 = 
	`l_¡r2dloc
(
buff
, 
»suÉ
, 
mode
);

289 ià(
’d±r
 !ğ
NULL
)

290 
’d±r
 = 
s
 + (’d±¸- 
buff
);

292  
’d±r
;

293 
	}
}

296 
	#MAXBY10
 
	`ÿ¡
(
lua_UnsigÃd
, 
LUA_MAXINTEGER
 / 10)

	)

297 
	#MAXLASTD
 
	`ÿ¡_št
(
LUA_MAXINTEGER
 % 10)

	)

299 cÚ¡ *
	$l_¡r2št
 (cÚ¡ *
s
, 
lua_IÁeg”
 *
»suÉ
) {

300 
lua_UnsigÃd
 
a
 = 0;

301 
em±y
 = 1;

302 
Ãg
;

303 
	`lis¥aû
(
	`ÿ¡_uch¬
(*
s
))) s++;

304 
Ãg
 = 
	`i¢eg
(&
s
);

305 ià(
s
[0] == '0' &&

306 (
s
[1] == 'x' || s[1] == 'X')) {

307 
s
 += 2;

308 ; 
	`lisxdig™
(
	`ÿ¡_uch¬
(*
s
)); s++) {

309 
a
 =‡ * 16 + 
	`luaO_hexav®ue
(*
s
);

310 
em±y
 = 0;

314 ; 
	`lisdig™
(
	`ÿ¡_uch¬
(*
s
)); s++) {

315 
d
 = *
s
 - '0';

316 ià(
a
 >ğ
MAXBY10
 && (¨> MAXBY10 || 
d
 > 
MAXLASTD
 + 
Ãg
))

317  
NULL
;

318 
a
 =‡ * 10 + 
d
;

319 
em±y
 = 0;

322 
	`lis¥aû
(
	`ÿ¡_uch¬
(*
s
))) s++;

323 ià(
em±y
 || *
s
 !ğ'\0'è 
NULL
;

325 *
»suÉ
 = 
	`l_ÿ¡U2S
((
Ãg
è? 0u - 
a
 :‡);

326  
s
;

328 
	}
}

331 
size_t
 
	$luaO_¡r2num
 (cÚ¡ *
s
, 
TV®ue
 *
o
) {

332 
lua_IÁeg”
 
i
; 
lua_Numb”
 
n
;

333 cÚ¡ *
e
;

334 ià((
e
 = 
	`l_¡r2št
(
s
, &
i
)è!ğ
NULL
) {

335 
	`£tiv®ue
(
o
, 
i
);

337 ià((
e
 = 
	`l_¡r2d
(
s
, &
n
)è!ğ
NULL
) {

338 
	`£tætv®ue
(
o
, 
n
);

342  (
e
 - 
s
) + 1;

343 
	}
}

346 
	$luaO_utf8esc
 (*
buff
, 
x
) {

347 
n
 = 1;

348 
	`lua_as£¹
(
x
 <= 0x10FFFF);

349 ià(
x
 < 0x80)

350 
buff
[
UTF8BUFFSZ
 - 1] = 
	`ÿ¡
(, 
x
);

352 
mfb
 = 0x3f;

354 
buff
[
UTF8BUFFSZ
 - (
n
++)] = 
	`ÿ¡
(, 0x80 | (
x
 & 0x3f));

355 
x
 >>= 6;

356 
mfb
 >>= 1;

357 } 
x
 > 
mfb
);

358 
buff
[
UTF8BUFFSZ
 - 
n
] = 
	`ÿ¡
(, (~
mfb
 << 1è| 
x
);

360  
n
;

361 
	}
}

365 
	#MAXNUMBER2STR
 50

	)

371 
	$luaO_to¡ršg
 (
lua_S‹
 *
L
, 
StkId
 
obj
) {

372 
buff
[
MAXNUMBER2STR
];

373 
size_t
 
Ën
;

374 
	`lua_as£¹
(
	`‰i¢umb”
(
obj
));

375 ià(
	`‰isš‹g”
(
obj
))

376 
Ën
 = 
	`lua_š‹g”2¡r
(
buff
, (buff), 
	`iv®ue
(
obj
));

378 
Ën
 = 
	`lua_numb”2¡r
(
buff
, (buff), 
	`ætv®ue
(
obj
));

379 #ià!
	`defšed
(
LUA_COMPAT_FLOATSTRING
)

380 ià(
buff
[
	`¡r¥n
(buff, "-0123456789")] == '\0') {

381 
buff
[
Ën
++] = 
	`lua_g‘loÿËdeıošt
();

382 
buff
[
Ën
++] = '0';

386 
	`£tsv®ue2s
(
L
, 
obj
, 
	`luaS_Ãwl¡r
(L, 
buff
, 
Ën
));

387 
	}
}

390 
	$push¡r
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
, 
size_t
 
l
) {

391 
	`£tsv®ue2s
(
L
, L->
tİ
, 
	`luaS_Ãwl¡r
(L, 
¡r
, 
l
));

392 
	`luaD_šùİ
(
L
);

393 
	}
}

400 cÚ¡ *
	$luaO_pushvf¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, 
va_li¡
 
¬gp
) {

401 
n
 = 0;

403 cÚ¡ *
e
 = 
	`¡rchr
(
fmt
, '%');

404 ià(
e
 =ğ
NULL
) ;

405 
	`push¡r
(
L
, 
fmt
, 
e
 - fmt);

406 *(
e
+1)) {

408 cÚ¡ *
s
 = 
	`va_¬g
(
¬gp
, *);

409 ià(
s
 =ğ
NULL
) s = "(null)";

410 
	`push¡r
(
L
, 
s
, 
	`¡¾’
(s));

414 
buff
 = 
	`ÿ¡
(, 
	`va_¬g
(
¬gp
, ));

415 ià(
	`li¥ršt
(
	`ÿ¡_uch¬
(
buff
)))

416 
	`push¡r
(
L
, &
buff
, 1);

418 
	`luaO_pushf¡ršg
(
L
, "<\\%d>", 
	`ÿ¡_uch¬
(
buff
));

422 
	`£tiv®ue
(
L
->
tİ
, 
	`va_¬g
(
¬gp
, ));

423 
tİ2¡r
;

426 
	`£tiv®ue
(
L
->
tİ
, 
	`ÿ¡
(
lua_IÁeg”
, 
	`va_¬g
(
¬gp
, 
l_uacIÁ
)));

427 
tİ2¡r
;

430 
	`£tætv®ue
(
L
->
tİ
, 
	`ÿ¡_num
(
	`va_¬g
(
¬gp
, 
l_uacNumb”
)));

431 
tİ2¡r
:

432 
	`luaD_šùİ
(
L
);

433 
	`luaO_to¡ršg
(
L
, L->
tİ
 - 1);

437 
buff
[4*(*) + 8];

438 
l
 = 
	`l_¥rštf
(
buff
, (buff), "%p", 
	`va_¬g
(
¬gp
, *));

439 
	`push¡r
(
L
, 
buff
, 
l
);

443 
buff
[
UTF8BUFFSZ
];

444 
l
 = 
	`luaO_utf8esc
(
buff
, 
	`ÿ¡
(, 
	`va_¬g
(
¬gp
, )));

445 
	`push¡r
(
L
, 
buff
 + 
UTF8BUFFSZ
 - 
l
,†);

449 
	`push¡r
(
L
, "%", 1);

453 
	`luaG_ruÃ¼Ü
(
L
, "invalid option '%%%c'o 'lua_pushfstring'",

454 *(
e
 + 1));

457 
n
 += 2;

458 
fmt
 = 
e
+2;

460 
	`luaD_check¡ack
(
L
, 1);

461 
	`push¡r
(
L
, 
fmt
, 
	`¡¾’
(fmt));

462 ià(
n
 > 0è
	`luaV_cÚÿt
(
L
,‚ + 1);

463  
	`sv®ue
(
L
->
tİ
 - 1);

464 
	}
}

467 cÚ¡ *
	$luaO_pushf¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...) {

468 cÚ¡ *
msg
;

469 
va_li¡
 
¬gp
;

470 
	`va_¡¬t
(
¬gp
, 
fmt
);

471 
msg
 = 
	`luaO_pushvf¡ršg
(
L
, 
fmt
, 
¬gp
);

472 
	`va_’d
(
¬gp
);

473  
msg
;

474 
	}
}

478 
	#LL
(
x
è((x)/(è- 1)

	)

480 
	#RETS
 "..."

	)

481 
	#PRE
 "[¡ršg \""

	)

482 
	#POS
 "\"]"

	)

484 
	#add¡r
(
a
,
b
,
l
èĞ
	`memıy
×,b,Öè* ()),‡ +ğÖè)

	)

486 
	$luaO_chunkid
 (*
out
, cÚ¡ *
sourû
, 
size_t
 
bufæ’
) {

487 
size_t
 
l
 = 
	`¡¾’
(
sourû
);

488 ià(*
sourû
 == '=') {

489 ià(
l
 <ğ
bufæ’
)

490 
	`memıy
(
out
, 
sourû
 + 1, 
l
 * ());

492 
	`add¡r
(
out
, 
sourû
 + 1, 
bufæ’
 - 1);

493 *
out
 = '\0';

496 ià(*
sourû
 == '@') {

497 ià(
l
 <ğ
bufæ’
)

498 
	`memıy
(
out
, 
sourû
 + 1, 
l
 * ());

500 
	`add¡r
(
out
, 
RETS
, 
	`LL
(RETS));

501 
bufæ’
 -ğ
	`LL
(
RETS
);

502 
	`memıy
(
out
, 
sourû
 + 1 + 
l
 - 
bufæ’
, bufflen * ());

506 cÚ¡ *
Æ
 = 
	`¡rchr
(
sourû
, '\n');

507 
	`add¡r
(
out
, 
PRE
, 
	`LL
(PRE));

508 
bufæ’
 -ğ
	`LL
(
PRE
 
RETS
 
POS
) + 1;

509 ià(
l
 < 
bufæ’
 && 
Æ
 =ğ
NULL
) {

510 
	`add¡r
(
out
, 
sourû
, 
l
);

513 ià(
Æ
 !ğ
NULL
è
l
 =‚È- 
sourû
;

514 ià(
l
 > 
bufæ’
)† = bufflen;

515 
	`add¡r
(
out
, 
sourû
, 
l
);

516 
	`add¡r
(
out
, 
RETS
, 
	`LL
(RETS));

518 
	`memıy
(
out
, 
POS
, (
	`LL
(POS) + 1) * ());

520 
	}
}

	@script/lua/lua-5.3.4/src/lobject.h

8 #iâdeà
lobjeù_h


9 
	#lobjeù_h


	)

12 
	~<¡d¬g.h
>

15 
	~"Îim™s.h
"

16 
	~"lua.h
"

22 
	#LUA_TPROTO
 
LUA_NUMTAGS


	)

23 
	#LUA_TDEADKEY
 (
LUA_NUMTAGS
+1è

	)

28 
	#LUA_TOTALTAGS
 (
LUA_TPROTO
 + 2)

	)

47 
	#LUA_TLCL
 (
LUA_TFUNCTION
 | (0 << 4)è

	)

48 
	#LUA_TLCF
 (
LUA_TFUNCTION
 | (1 << 4)è

	)

49 
	#LUA_TCCL
 (
LUA_TFUNCTION
 | (2 << 4)è

	)

53 
	#LUA_TSHRSTR
 (
LUA_TSTRING
 | (0 << 4)è

	)

54 
	#LUA_TLNGSTR
 (
LUA_TSTRING
 | (1 << 4)è

	)

58 
	#LUA_TNUMFLT
 (
LUA_TNUMBER
 | (0 << 4)è

	)

59 
	#LUA_TNUMINT
 (
LUA_TNUMBER
 | (1 << 4)è

	)

63 
	#BIT_ISCOLLECTABLE
 (1 << 6)

	)

66 
	#ùb
(
t
è(Ñè| 
BIT_ISCOLLECTABLE
)

	)

72 
GCObjeù
 
	tGCObjeù
;

79 
	#CommÚH—d”
 
GCObjeù
 *
Ãxt
; 
lu_by‹
 
‰
;†u_by‹ 
m¬ked


	)

85 
	sGCObjeù
 {

86 
	mCommÚH—d”
;

100 
	uV®ue
 {

101 
GCObjeù
 *
	mgc
;

102 *
	mp
;

103 
	mb
;

104 
lua_CFunùiÚ
 
	mf
;

105 
lua_IÁeg”
 
	mi
;

106 
lua_Numb”
 
	mn
;

107 } 
	tV®ue
;

110 
	#TV®uef›lds
 
V®ue
 
v®ue_
; 
‰_


	)

113 
	slua_TV®ue
 {

114 
	mTV®uef›lds
;

115 } 
	tTV®ue
;

120 
	#NILCONSTANT
 {
NULL
}, 
LUA_TNIL


	)

123 
	#v®_
(
o
è((o)->
v®ue_
)

	)

127 
	#¹ty³
(
o
è((o)->
‰_
)

	)

130 
	#nov¬ŸÁ
(
x
è((xè& 0x0F)

	)

133 
	#‰y³
(
o
è(
	`¹ty³
(oè& 0x3F)

	)

136 
	#‰nov
(
o
è(
	`nov¬ŸÁ
(
	`¹ty³
(o)))

	)

140 
	#checkg
(
o
,
t
è(
	`¹ty³
(oè=ğÑ))

	)

141 
	#checkty³
(
o
,
t
è(
	`‰nov
(oè=ğÑ))

	)

142 
	#‰i¢umb”
(
o
è
	`checkty³
((o), 
LUA_TNUMBER
)

	)

143 
	#‰isæßt
(
o
è
	`checkg
((o), 
LUA_TNUMFLT
)

	)

144 
	#‰isš‹g”
(
o
è
	`checkg
((o), 
LUA_TNUMINT
)

	)

145 
	#‰i¢
(
o
è
	`checkg
((o), 
LUA_TNIL
)

	)

146 
	#‰isboŞ—n
(
o
è
	`checkg
((o), 
LUA_TBOOLEAN
)

	)

147 
	#‰i¦ightu£rd©a
(
o
è
	`checkg
((o), 
LUA_TLIGHTUSERDATA
)

	)

148 
	#‰is¡ršg
(
o
è
	`checkty³
((o), 
LUA_TSTRING
)

	)

149 
	#‰isshr¡ršg
(
o
è
	`checkg
((o), 
	`ùb
(
LUA_TSHRSTR
))

	)

150 
	#‰i¦ng¡ršg
(
o
è
	`checkg
((o), 
	`ùb
(
LUA_TLNGSTR
))

	)

151 
	#‰i¡abË
(
o
è
	`checkg
((o), 
	`ùb
(
LUA_TTABLE
))

	)

152 
	#‰isfunùiÚ
(
o
è
	`checkty³
(o, 
LUA_TFUNCTION
)

	)

153 
	#‰isşosu»
(
o
è((
	`¹ty³
(oè& 0x1Fè=ğ
LUA_TFUNCTION
)

	)

154 
	#‰isCşosu»
(
o
è
	`checkg
((o), 
	`ùb
(
LUA_TCCL
))

	)

155 
	#‰isLşosu»
(
o
è
	`checkg
((o), 
	`ùb
(
LUA_TLCL
))

	)

156 
	#‰i¦cf
(
o
è
	`checkg
((o), 
LUA_TLCF
)

	)

157 
	#‰isfuÎu£rd©a
(
o
è
	`checkg
((o), 
	`ùb
(
LUA_TUSERDATA
))

	)

158 
	#‰i¡h»ad
(
o
è
	`checkg
((o), 
	`ùb
(
LUA_TTHREAD
))

	)

159 
	#‰isd—dkey
(
o
è
	`checkg
((o), 
LUA_TDEADKEY
)

	)

163 
	#iv®ue
(
o
è
	`check_exp
(
	`‰isš‹g”
(o), 
	`v®_
(o).
i
)

	)

164 
	#ætv®ue
(
o
è
	`check_exp
(
	`‰isæßt
(o), 
	`v®_
(o).
n
)

	)

165 
	#nv®ue
(
o
è
	`check_exp
(
	`‰i¢umb”
(o), \

166 (
	`‰isš‹g”
(
o
è? 
	`ÿ¡_num
(
	`iv®ue
(o)è: 
	`ætv®ue
(o)))

	)

167 
	#gcv®ue
(
o
è
	`check_exp
(
	`iscŞËùabË
(o), 
	`v®_
(o).
gc
)

	)

168 
	#pv®ue
(
o
è
	`check_exp
(
	`‰i¦ightu£rd©a
(o), 
	`v®_
(o).
p
)

	)

169 
	#tsv®ue
(
o
è
	`check_exp
(
	`‰is¡ršg
(o), 
	`gco2ts
(
	`v®_
(o).
gc
))

	)

170 
	#uv®ue
(
o
è
	`check_exp
(
	`‰isfuÎu£rd©a
(o), 
	`gco2u
(
	`v®_
(o).
gc
))

	)

171 
	#şv®ue
(
o
è
	`check_exp
(
	`‰isşosu»
(o), 
	`gco2ş
(
	`v®_
(o).
gc
))

	)

172 
	#şLv®ue
(
o
è
	`check_exp
(
	`‰isLşosu»
(o), 
	`gco2lş
(
	`v®_
(o).
gc
))

	)

173 
	#şCv®ue
(
o
è
	`check_exp
(
	`‰isCşosu»
(o), 
	`gco2cş
(
	`v®_
(o).
gc
))

	)

174 
	#fv®ue
(
o
è
	`check_exp
(
	`‰i¦cf
(o), 
	`v®_
(o).
f
)

	)

175 
	#hv®ue
(
o
è
	`check_exp
(
	`‰i¡abË
(o), 
	`gco2t
(
	`v®_
(o).
gc
))

	)

176 
	#bv®ue
(
o
è
	`check_exp
(
	`‰isboŞ—n
(o), 
	`v®_
(o).
b
)

	)

177 
	#thv®ue
(
o
è
	`check_exp
(
	`‰i¡h»ad
(o), 
	`gco2th
(
	`v®_
(o).
gc
))

	)

179 
	#d—dv®ue
(
o
è
	`check_exp
(
	`‰isd—dkey
(o), 
	`ÿ¡
(*, 
	`v®_
(o).
gc
))

	)

181 
	#l_isçl£
(
o
è(
	`‰i¢
(oè|| (
	`‰isboŞ—n
(oè&& 
	`bv®ue
(oè=ğ0))

	)

184 
	#iscŞËùabË
(
o
è(
	`¹ty³
(oè& 
BIT_ISCOLLECTABLE
)

	)

188 
	#righ‰t
(
obj
è(
	`‰y³
(objè=ğ
	`gcv®ue
(obj)->
‰
)

	)

190 
	#checkliv’ess
(
L
,
obj
) \

191 
	`lua_lÚgas£¹
(!
	`iscŞËùabË
(
obj
) || \

192 (
	`righ‰t
(
obj
è&& (
L
 =ğ
NULL
 || !
	`isd—d
(
	`G
(L),
	`gcv®ue
(obj)))))

	)

196 
	#£‰t_
(
o
,
t
è((o)->
‰_
=Ñ))

	)

198 
	#£tætv®ue
(
obj
,
x
) \

199 { 
TV®ue
 *
io
=(
obj
); 
	`v®_
(io).
n
=(
x
); 
	`£‰t_
(io, 
LUA_TNUMFLT
); }

	)

201 
	#chgætv®ue
(
obj
,
x
) \

202 { 
TV®ue
 *
io
=(
obj
); 
	`lua_as£¹
(
	`‰isæßt
(io)); 
	`v®_
(io).
n
=(
x
); }

	)

204 
	#£tiv®ue
(
obj
,
x
) \

205 { 
TV®ue
 *
io
=(
obj
); 
	`v®_
(io).
i
=(
x
); 
	`£‰t_
(io, 
LUA_TNUMINT
); }

	)

207 
	#chgiv®ue
(
obj
,
x
) \

208 { 
TV®ue
 *
io
=(
obj
); 
	`lua_as£¹
(
	`‰isš‹g”
(io)); 
	`v®_
(io).
i
=(
x
); }

	)

210 
	#£Šv®ue
(
obj
è
	`£‰t_
(obj, 
LUA_TNIL
)

	)

212 
	#£tfv®ue
(
obj
,
x
) \

213 { 
TV®ue
 *
io
=(
obj
); 
	`v®_
(io).
f
=(
x
); 
	`£‰t_
(io, 
LUA_TLCF
); }

	)

215 
	#£v®ue
(
obj
,
x
) \

216 { 
TV®ue
 *
io
=(
obj
); 
	`v®_
(io).
p
=(
x
); 
	`£‰t_
(io, 
LUA_TLIGHTUSERDATA
); }

	)

218 
	#£tbv®ue
(
obj
,
x
) \

219 { 
TV®ue
 *
io
=(
obj
); 
	`v®_
(io).
b
=(
x
); 
	`£‰t_
(io, 
LUA_TBOOLEAN
); }

	)

221 
	#£tgcov®ue
(
L
,
obj
,
x
) \

222 { 
TV®ue
 *
io
 = (
obj
); 
GCObjeù
 *
i_g
=(
x
); \

223 
	`v®_
(
io
).
gc
 = 
i_g
; 
	`£‰t_
(io, 
	`ùb
(i_g->
‰
)); }

	)

225 
	#£tsv®ue
(
L
,
obj
,
x
) \

226 { 
TV®ue
 *
io
 = (
obj
); 
TSŒšg
 *
x_
 = (
x
); \

227 
	`v®_
(
io
).
gc
 = 
	`obj2gco
(
x_
); 
	`£‰t_
(io, 
	`ùb
(x_->
‰
)); \

228 
	`checkliv’ess
(
L
,
io
); }

	)

230 
	#£tuv®ue
(
L
,
obj
,
x
) \

231 { 
TV®ue
 *
io
 = (
obj
); 
Ud©a
 *
x_
 = (
x
); \

232 
	`v®_
(
io
).
gc
 = 
	`obj2gco
(
x_
); 
	`£‰t_
(io, 
	`ùb
(
LUA_TUSERDATA
)); \

233 
	`checkliv’ess
(
L
,
io
); }

	)

235 
	#£‰hv®ue
(
L
,
obj
,
x
) \

236 { 
TV®ue
 *
io
 = (
obj
); 
lua_S‹
 *
x_
 = (
x
); \

237 
	`v®_
(
io
).
gc
 = 
	`obj2gco
(
x_
); 
	`£‰t_
(io, 
	`ùb
(
LUA_TTHREAD
)); \

238 
	`checkliv’ess
(
L
,
io
); }

	)

240 
	#£tşLv®ue
(
L
,
obj
,
x
) \

241 { 
TV®ue
 *
io
 = (
obj
); 
LClosu»
 *
x_
 = (
x
); \

242 
	`v®_
(
io
).
gc
 = 
	`obj2gco
(
x_
); 
	`£‰t_
(io, 
	`ùb
(
LUA_TLCL
)); \

243 
	`checkliv’ess
(
L
,
io
); }

	)

245 
	#£tşCv®ue
(
L
,
obj
,
x
) \

246 { 
TV®ue
 *
io
 = (
obj
); 
CClosu»
 *
x_
 = (
x
); \

247 
	`v®_
(
io
).
gc
 = 
	`obj2gco
(
x_
); 
	`£‰t_
(io, 
	`ùb
(
LUA_TCCL
)); \

248 
	`checkliv’ess
(
L
,
io
); }

	)

250 
	#£thv®ue
(
L
,
obj
,
x
) \

251 { 
TV®ue
 *
io
 = (
obj
); 
TabË
 *
x_
 = (
x
); \

252 
	`v®_
(
io
).
gc
 = 
	`obj2gco
(
x_
); 
	`£‰t_
(io, 
	`ùb
(
LUA_TTABLE
)); \

253 
	`checkliv’ess
(
L
,
io
); }

	)

255 
	#£td—dv®ue
(
obj
è
	`£‰t_
(obj, 
LUA_TDEADKEY
)

	)

259 
	#£tobj
(
L
,
obj1
,
obj2
) \

260 { 
TV®ue
 *
io1
=(
obj1
); *io1 = *(
obj2
); \

261 ()
L
; 
	`checkliv’ess
(L,
io1
); }

	)

269 
	#£tobjs2s
 
£tobj


	)

271 
	#£tobj2s
 
£tobj


	)

272 
	#£tsv®ue2s
 
£tsv®ue


	)

273 
	#£thv®ue2s
 
£thv®ue


	)

274 
	#£tv®ue2s
 
£tv®ue


	)

276 
	#£tobjt2t
 
£tobj


	)

278 
	#£tobj2n
 
£tobj


	)

279 
	#£tsv®ue2n
 
£tsv®ue


	)

282 
	#£tobj2t
(
L
,
o1
,
o2
è(()L, *(o1)=*(o2), 
	`checkliv’ess
(L,(o1)))

	)

294 
TV®ue
 *
	tStkId
;

303 
	sTSŒšg
 {

304 
	mCommÚH—d”
;

305 
lu_by‹
 
	mexŒa
;

306 
lu_by‹
 
	msh¾’
;

307 
	mhash
;

309 
size_t
 
	mÊgËn
;

310 
TSŒšg
 *
	mhÃxt
;

311 } 
	mu
;

312 } 
	tTSŒšg
;

318 
	uUTSŒšg
 {

319 
L_Umax®ign
 
	mdummy
;

320 
TSŒšg
 
	mtsv
;

321 } 
	tUTSŒšg
;

328 
	#g‘¡r
(
ts
) \

329 
	`check_exp
(((
ts
)->
exŒa
), 
	`ÿ¡
(*, (ts)è+ (
UTSŒšg
))

	)

333 
	#sv®ue
(
o
è
	`g‘¡r
(
	`tsv®ue
(o))

	)

336 
	#ts¦’
(
s
è((s)->
‰
 =ğ
LUA_TSHRSTR
 ? (s)->
sh¾’
 : (s)->
u
.
ÊgËn
)

	)

339 
	#v¦’
(
o
è
	`ts¦’
(
	`tsv®ue
(o))

	)

346 
	sUd©a
 {

347 
	mCommÚH—d”
;

348 
lu_by‹
 
	m‰uv_
;

349 
TabË
 *
	mm‘©abË
;

350 
size_t
 
	mËn
;

351 
V®ue
 
	mu£r_
;

352 } 
	tUd©a
;

358 
	uUUd©a
 {

359 
L_Umax®ign
 
	mdummy
;

360 
Ud©a
 
	muv
;

361 } 
	tUUd©a
;

368 
	#g‘ud©amem
(
u
) \

369 
	`check_exp
(((
u
)->
‰uv_
), (
	`ÿ¡
(*, (u)è+ (
UUd©a
)))

	)

371 
	#£tu£rv®ue
(
L
,
u
,
o
) \

372 { cÚ¡ 
TV®ue
 *
io
=(
o
); 
Ud©a
 *
iu
 = (
u
); \

373 
iu
->
u£r_
 = 
io
->
v®ue_
; iu->
‰uv_
 = 
	`¹ty³
(io); \

374 
	`checkliv’ess
(
L
,
io
); }

	)

377 
	#g‘u£rv®ue
(
L
,
u
,
o
) \

378 { 
TV®ue
 *
io
=(
o
); cÚ¡ 
Ud©a
 *
iu
 = (
u
); \

379 
io
->
v®ue_
 = 
iu
->
u£r_
; 
	`£‰t_
(io, iu->
‰uv_
); \

380 
	`checkliv’ess
(
L
,
io
); }

	)

386 
	sUpv®desc
 {

387 
TSŒšg
 *
	mÇme
;

388 
lu_by‹
 
	mš¡ack
;

389 
lu_by‹
 
	midx
;

390 } 
	tUpv®desc
;

397 
	sLocV¬
 {

398 
TSŒšg
 *
	mv¬Çme
;

399 
	m¡¬c
;

400 
	m’dpc
;

401 } 
	tLocV¬
;

407 
	sPrÙo
 {

408 
	mCommÚH—d”
;

409 
lu_by‹
 
	mnum·¿ms
;

410 
lu_by‹
 
	mis_v¬¬g
;

411 
lu_by‹
 
	mmax¡acksize
;

412 
	msizeupv®ues
;

413 
	msizek
;

414 
	msizecode
;

415 
	msiz–šešfo
;

416 
	msiz•
;

417 
	msiz–ocv¬s
;

418 
	mlšedefšed
;

419 
	mÏ¡lšedefšed
;

420 
TV®ue
 *
	mk
;

421 
In¡ruùiÚ
 *
	mcode
;

422 
PrÙo
 **
	mp
;

423 *
	mlšešfo
;

424 
LocV¬
 *
	mlocv¬s
;

425 
Upv®desc
 *
	mupv®ues
;

426 
LClosu»
 *
	mÿche
;

427 
TSŒšg
 *
	msourû
;

428 
GCObjeù
 *
	mgşi¡
;

429 } 
	tPrÙo
;

436 
UpV®
 
	tUpV®
;

443 
	#Closu»H—d”
 \

444 
CommÚH—d”
; 
lu_by‹
 
nupv®ues
; 
GCObjeù
 *
gşi¡


	)

446 
	sCClosu»
 {

447 
	mClosu»H—d”
;

448 
lua_CFunùiÚ
 
	mf
;

449 
TV®ue
 
	mupv®ue
[1];

450 } 
	tCClosu»
;

453 
	sLClosu»
 {

454 
	mClosu»H—d”
;

455 
PrÙo
 *
	mp
;

456 
UpV®
 *
	mupv®s
[1];

457 } 
	tLClosu»
;

460 
	uClosu»
 {

461 
CClosu»
 
	mc
;

462 
LClosu»
 
	ml
;

463 } 
	tClosu»
;

466 
	#isLfunùiÚ
(
o
è
	`‰isLşosu»
(o)

	)

468 
	#g‘´Ùo
(
o
è(
	`şLv®ue
(o)->
p
)

	)

475 
	uTKey
 {

477 
	mTV®uef›lds
;

478 
	mÃxt
;

479 } 
	mnk
;

480 
TV®ue
 
	mtvk
;

481 } 
	tTKey
;

485 
	#£Šodekey
(
L
,
key
,
obj
) \

486 { 
TKey
 *
k_
=(
key
); cÚ¡ 
TV®ue
 *
io_
=(
obj
); \

487 
k_
->
nk
.
v®ue_
 = 
io_
->v®ue_; k_->nk.
‰_
 = io_->tt_; \

488 ()
L
; 
	`checkliv’ess
(L,
io_
); }

	)

491 
	sNode
 {

492 
TV®ue
 
	mi_v®
;

493 
TKey
 
	mi_key
;

494 } 
	tNode
;

497 
	sTabË
 {

498 
	mCommÚH—d”
;

499 
lu_by‹
 
	mæags
;

500 
lu_by‹
 
	mlsiz’ode
;

501 
	msiz—¼ay
;

502 
TV®ue
 *
	m¬¿y
;

503 
Node
 *
	mnode
;

504 
Node
 *
	mÏ¡ä“
;

505 
TabË
 *
	mm‘©abË
;

506 
GCObjeù
 *
	mgşi¡
;

507 } 
	tTabË
;

514 
	#lmod
(
s
,
size
) \

515 (
	`check_exp
((
size
&(size-1))==0, (
	`ÿ¡
(, (
s
è& ((size)-1)))))

	)

518 
	#twÙo
(
x
è(1<<(x))

	)

519 
	#siz’ode
(
t
è(
	`twÙo
(Ñ)->
lsiz’ode
))

	)

525 
	#luaO_nobjeù
 (&
luaO_nobjeù_
)

	)

528 
LUAI_DDEC
 cÚ¡ 
TV®ue
 
	gluaO_nobjeù_
;

531 
	#UTF8BUFFSZ
 8

	)

533 
LUAI_FUNC
 
luaO_št2fb
 (
x
);

534 
LUAI_FUNC
 
luaO_fb2št
 (
x
);

535 
LUAI_FUNC
 
luaO_utf8esc
 (*
buff
, 
x
);

536 
LUAI_FUNC
 
luaO_ûlog2
 (
x
);

537 
LUAI_FUNC
 
luaO_¬™h
 (
lua_S‹
 *
L
, 
İ
, cÚ¡ 
TV®ue
 *
p1
,

538 cÚ¡ 
TV®ue
 *
p2
, TV®u*
»s
);

539 
LUAI_FUNC
 
size_t
 
luaO_¡r2num
 (cÚ¡ *
s
, 
TV®ue
 *
o
);

540 
LUAI_FUNC
 
luaO_hexav®ue
 (
c
);

541 
LUAI_FUNC
 
luaO_to¡ršg
 (
lua_S‹
 *
L
, 
StkId
 
obj
);

542 
LUAI_FUNC
 cÚ¡ *
luaO_pushvf¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
,

543 
va_li¡
 
¬gp
);

544 
LUAI_FUNC
 cÚ¡ *
luaO_pushf¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...);

545 
LUAI_FUNC
 
luaO_chunkid
 (*
out
, cÚ¡ *
sourû
, 
size_t
 
Ën
);

	@script/lua/lua-5.3.4/src/lopcodes.c

7 
	#lİcodes_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ddef.h
>

15 
	~"lİcodes.h
"

20 
LUAI_DDEF
 cÚ¡ *cÚ¡ 
	gluaP_İÇmes
[
NUM_OPCODES
+1] = {

68 
NULL


72 
	#İmode
(
t
,
a
,
b
,
c
,
m
è((Ñ)<<7è| (×)<<6è| ((b)<<4è| ((c)<<2è| (m))

	)

74 
LUAI_DDEF
 cÚ¡ 
lu_by‹
 
	gluaP_İmodes
[
NUM_OPCODES
] = {

76 
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iABC
)

77 ,
İmode
(0, 1, 
OpArgK
, 
OpArgN
, 
iABx
)

78 ,
İmode
(0, 1, 
OpArgN
, OpArgN, 
iABx
)

79 ,
İmode
(0, 1, 
OpArgU
, OpArgU, 
iABC
)

80 ,
İmode
(0, 1, 
OpArgU
, 
OpArgN
, 
iABC
)

81 ,
İmode
(0, 1, 
OpArgU
, 
OpArgN
, 
iABC
)

82 ,
İmode
(0, 1, 
OpArgU
, 
OpArgK
, 
iABC
)

83 ,
İmode
(0, 1, 
OpArgR
, 
OpArgK
, 
iABC
)

84 ,
İmode
(0, 0, 
OpArgK
, OpArgK, 
iABC
)

85 ,
İmode
(0, 0, 
OpArgU
, 
OpArgN
, 
iABC
)

86 ,
İmode
(0, 0, 
OpArgK
, OpArgK, 
iABC
)

87 ,
İmode
(0, 1, 
OpArgU
, OpArgU, 
iABC
)

88 ,
İmode
(0, 1, 
OpArgR
, 
OpArgK
, 
iABC
)

89 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

90 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

91 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

92 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

93 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

94 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

95 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

96 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

97 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

98 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

99 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

100 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

101 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iABC
)

102 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iABC
)

103 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iABC
)

104 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iABC
)

105 ,
İmode
(0, 1, 
OpArgR
, OpArgR, 
iABC
)

106 ,
İmode
(0, 0, 
OpArgR
, 
OpArgN
, 
iAsBx
)

107 ,
İmode
(1, 0, 
OpArgK
, OpArgK, 
iABC
)

108 ,
İmode
(1, 0, 
OpArgK
, OpArgK, 
iABC
)

109 ,
İmode
(1, 0, 
OpArgK
, OpArgK, 
iABC
)

110 ,
İmode
(1, 0, 
OpArgN
, 
OpArgU
, 
iABC
)

111 ,
İmode
(1, 1, 
OpArgR
, 
OpArgU
, 
iABC
)

112 ,
İmode
(0, 1, 
OpArgU
, OpArgU, 
iABC
)

113 ,
İmode
(0, 1, 
OpArgU
, OpArgU, 
iABC
)

114 ,
İmode
(0, 0, 
OpArgU
, 
OpArgN
, 
iABC
)

115 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iAsBx
)

116 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iAsBx
)

117 ,
İmode
(0, 0, 
OpArgN
, 
OpArgU
, 
iABC
)

118 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iAsBx
)

119 ,
İmode
(0, 0, 
OpArgU
, OpArgU, 
iABC
)

120 ,
İmode
(0, 1, 
OpArgU
, 
OpArgN
, 
iABx
)

121 ,
İmode
(0, 1, 
OpArgU
, 
OpArgN
, 
iABC
)

122 ,
İmode
(0, 0, 
OpArgU
, OpArgU, 
iAx
)

	@script/lua/lua-5.3.4/src/lopcodes.h

7 #iâdeà
lİcodes_h


8 
	#lİcodes_h


	)

10 
	~"Îim™s.h
"

32 
	eOpMode
 {
	miABC
, 
	miABx
, 
	miAsBx
, 
	miAx
};

38 
	#SIZE_C
 9

	)

39 
	#SIZE_B
 9

	)

40 
	#SIZE_Bx
 (
SIZE_C
 + 
SIZE_B
)

	)

41 
	#SIZE_A
 8

	)

42 
	#SIZE_Ax
 (
SIZE_C
 + 
SIZE_B
 + 
SIZE_A
)

	)

44 
	#SIZE_OP
 6

	)

46 
	#POS_OP
 0

	)

47 
	#POS_A
 (
POS_OP
 + 
SIZE_OP
)

	)

48 
	#POS_C
 (
POS_A
 + 
SIZE_A
)

	)

49 
	#POS_B
 (
POS_C
 + 
SIZE_C
)

	)

50 
	#POS_Bx
 
POS_C


	)

51 
	#POS_Ax
 
POS_A


	)

59 #ià
SIZE_Bx
 < 
LUAI_BITSINT
-1

60 
	#MAXARG_Bx
 ((1<<
SIZE_Bx
)-1)

	)

61 
	#MAXARG_sBx
 (
MAXARG_Bx
>>1è

	)

63 
	#MAXARG_Bx
 
MAX_INT


	)

64 
	#MAXARG_sBx
 
MAX_INT


	)

67 #ià
SIZE_Ax
 < 
LUAI_BITSINT
-1

68 
	#MAXARG_Ax
 ((1<<
SIZE_Ax
)-1)

	)

70 
	#MAXARG_Ax
 
MAX_INT


	)

74 
	#MAXARG_A
 ((1<<
SIZE_A
)-1)

	)

75 
	#MAXARG_B
 ((1<<
SIZE_B
)-1)

	)

76 
	#MAXARG_C
 ((1<<
SIZE_C
)-1)

	)

80 
	#MASK1
(
n
,
p
è((~((~(
In¡ruùiÚ
)0)<<Ò)))<<Õ))

	)

83 
	#MASK0
(
n
,
p
è(~
	`MASK1
Ò,p))

	)

89 
	#GET_OPCODE
(
i
è(
	`ÿ¡
(
OpCode
, ((i)>>
POS_OP
è& 
	`MASK1
(
SIZE_OP
,0)))

	)

90 
	#SET_OPCODE
(
i
,
o
è((ièğ(((i)&
	`MASK0
(
SIZE_OP
,
POS_OP
)) | \

91 ((
	`ÿ¡
(
In¡ruùiÚ
, 
o
)<<
POS_OP
)&
	`MASK1
(
SIZE_OP
,POS_OP))))

	)

93 
	#g‘¬g
(
i
,
pos
,
size
è(
	`ÿ¡
(, ((i)>>posè& 
	`MASK1
(size,0)))

	)

94 
	#£rg
(
i
,
v
,
pos
,
size
è((ièğ(((i)&
	`MASK0
(size,pos)) | \

95 ((
	`ÿ¡
(
In¡ruùiÚ
, 
v
)<<
pos
)&
	`MASK1
(
size
,pos))))

	)

97 
	#GETARG_A
(
i
è
	`g‘¬g
(i, 
POS_A
, 
SIZE_A
)

	)

98 
	#SETARG_A
(
i
,
v
è
	`£rg
(i, v, 
POS_A
, 
SIZE_A
)

	)

100 
	#GETARG_B
(
i
è
	`g‘¬g
(i, 
POS_B
, 
SIZE_B
)

	)

101 
	#SETARG_B
(
i
,
v
è
	`£rg
(i, v, 
POS_B
, 
SIZE_B
)

	)

103 
	#GETARG_C
(
i
è
	`g‘¬g
(i, 
POS_C
, 
SIZE_C
)

	)

104 
	#SETARG_C
(
i
,
v
è
	`£rg
(i, v, 
POS_C
, 
SIZE_C
)

	)

106 
	#GETARG_Bx
(
i
è
	`g‘¬g
(i, 
POS_Bx
, 
SIZE_Bx
)

	)

107 
	#SETARG_Bx
(
i
,
v
è
	`£rg
(i, v, 
POS_Bx
, 
SIZE_Bx
)

	)

109 
	#GETARG_Ax
(
i
è
	`g‘¬g
(i, 
POS_Ax
, 
SIZE_Ax
)

	)

110 
	#SETARG_Ax
(
i
,
v
è
	`£rg
(i, v, 
POS_Ax
, 
SIZE_Ax
)

	)

112 
	#GETARG_sBx
(
i
è(
	`GETARG_Bx
(i)-
MAXARG_sBx
)

	)

113 
	#SETARG_sBx
(
i
,
b
è
	`SETARG_Bx
((i),
	`ÿ¡
(, (b)+
MAXARG_sBx
))

	)

116 
	#CREATE_ABC
(
o
,
a
,
b
,
c
è((
	`ÿ¡
(
In¡ruùiÚ
, o)<<
POS_OP
) \

117 | (
	`ÿ¡
(
In¡ruùiÚ
, 
a
)<<
POS_A
) \

118 | (
	`ÿ¡
(
In¡ruùiÚ
, 
b
)<<
POS_B
) \

119 | (
	`ÿ¡
(
In¡ruùiÚ
, 
c
)<<
POS_C
))

	)

121 
	#CREATE_ABx
(
o
,
a
,
bc
è((
	`ÿ¡
(
In¡ruùiÚ
, o)<<
POS_OP
) \

122 | (
	`ÿ¡
(
In¡ruùiÚ
, 
a
)<<
POS_A
) \

123 | (
	`ÿ¡
(
In¡ruùiÚ
, 
bc
)<<
POS_Bx
))

	)

125 
	#CREATE_Ax
(
o
,
a
è((
	`ÿ¡
(
In¡ruùiÚ
, o)<<
POS_OP
) \

126 | (
	`ÿ¡
(
In¡ruùiÚ
, 
a
)<<
POS_Ax
))

	)

134 
	#BITRK
 (1 << (
SIZE_B
 - 1))

	)

137 
	#ISK
(
x
è((xè& 
BITRK
)

	)

140 
	#INDEXK
(
r
è(()Ôè& ~
BITRK
)

	)

142 #ià!
defšed
(
MAXINDEXRK
)

143 
	#MAXINDEXRK
 (
BITRK
 - 1)

	)

147 
	#RKASK
(
x
è((xè| 
BITRK
)

	)

153 
	#NO_REG
 
MAXARG_A


	)

171 
	mOP_MOVE
,

172 
	mOP_LOADK
,

173 
	mOP_LOADKX
,

174 
	mOP_LOADBOOL
,

175 
	mOP_LOADNIL
,

176 
	mOP_GETUPVAL
,

178 
	mOP_GETTABUP
,

179 
	mOP_GETTABLE
,

181 
	mOP_SETTABUP
,

182 
	mOP_SETUPVAL
,

183 
	mOP_SETTABLE
,

185 
	mOP_NEWTABLE
,

187 
	mOP_SELF
,

189 
	mOP_ADD
,

190 
	mOP_SUB
,

191 
	mOP_MUL
,

192 
	mOP_MOD
,

193 
	mOP_POW
,

194 
	mOP_DIV
,

195 
	mOP_IDIV
,

196 
	mOP_BAND
,

197 
	mOP_BOR
,

198 
	mOP_BXOR
,

199 
	mOP_SHL
,

200 
	mOP_SHR
,

201 
	mOP_UNM
,

202 
	mOP_BNOT
,

203 
	mOP_NOT
,

204 
	mOP_LEN
,

206 
	mOP_CONCAT
,

208 
	mOP_JMP
,

209 
	mOP_EQ
,

210 
	mOP_LT
,

211 
	mOP_LE
,

213 
	mOP_TEST
,

214 
	mOP_TESTSET
,

216 
	mOP_CALL
,

217 
	mOP_TAILCALL
,

218 
	mOP_RETURN
,

220 
	mOP_FORLOOP
,

222 
	mOP_FORPREP
,

224 
	mOP_TFORCALL
,

225 
	mOP_TFORLOOP
,

227 
	mOP_SETLIST
,

229 
	mOP_CLOSURE
,

231 
	mOP_VARARG
,

233 
	mOP_EXTRAARG


234 } 
	tOpCode
;

237 
	#NUM_OPCODES
 (
	`ÿ¡
(, 
OP_EXTRAARG
è+ 1)

	)

274 
	eOpArgMask
 {

275 
	mOpArgN
,

276 
	mOpArgU
,

277 
	mOpArgR
,

278 
	mOpArgK


281 
LUAI_DDEC
 cÚ¡ 
lu_by‹
 
	gluaP_İmodes
[
NUM_OPCODES
];

283 
	#g‘OpMode
(
m
è(
	`ÿ¡
(
OpMode
, 
luaP_İmodes
[m] & 3))

	)

284 
	#g‘BMode
(
m
è(
	`ÿ¡
(
OpArgMask
, (
luaP_İmodes
[m] >> 4è& 3))

	)

285 
	#g‘CMode
(
m
è(
	`ÿ¡
(
OpArgMask
, (
luaP_İmodes
[m] >> 2è& 3))

	)

286 
	#‹¡AMode
(
m
è(
luaP_İmodes
[m] & (1 << 6))

	)

287 
	#‹¡TMode
(
m
è(
luaP_İmodes
[m] & (1 << 7))

	)

290 
LUAI_DDEC
 cÚ¡ *cÚ¡ 
	gluaP_İÇmes
[
NUM_OPCODES
+1];

294 
	#LFIELDS_PER_FLUSH
 50

	)

	@script/lua/lua-5.3.4/src/loslib.c

7 
	#lo¦ib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<”ºo.h
>

14 
	~<loÿË.h
>

15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

17 
	~<time.h
>

19 
	~"lua.h
"

21 
	~"Ïuxlib.h
"

22 
	~"lu®ib.h
"

31 #ià!
defšed
(
LUA_STRFTIMEOPTIONS
)

34 
	#L_STRFTIMEC89
 "aAbBcdHIjmMpSUwWxXyYZ%"

	)

37 
	#L_STRFTIMEC99
 "aAbBcCdDeFgGhHIjmMnprRStTuUVwWxXyYzZ%" \

38 "||" "EcECExEXEyEY" "OdOeOHOIOmOMOSOuOUOVOwOWOy"

	)

41 
	#L_STRFTIMEWIN
 "aAbBcdHIjmMpSUwWxXyYzZ%" \

42 "||" "#c#x#d#H#I#j#m#M#S#U#w#W#y#Y"

	)

44 #ià
defšed
(
LUA_USE_WINDOWS
)

45 
	#LUA_STRFTIMEOPTIONS
 
L_STRFTIMEWIN


	)

46 #–ià
defšed
(
LUA_USE_C89
)

47 
	#LUA_STRFTIMEOPTIONS
 
L_STRFTIMEC89


	)

49 
	#LUA_STRFTIMEOPTIONS
 
L_STRFTIMEC99


	)

62 #ià!
defšed
(
l_time_t
)

66 
	#l_tim‘
 
lua_IÁeg”


	)

67 
	#l_pushtime
(
L
,
t
è
	`lua_pushš‹g”
(L,(
lua_IÁeg”
)Ñ))

	)

69 
time_t
 
	$l_checktime
 (
lua_S‹
 *
L
, 
¬g
) {

70 
lua_IÁeg”
 
t
 = 
	`luaL_checkš‹g”
(
L
, 
¬g
);

71 
	`luaL_¬gcheck
(
L
, (
time_t
)
t
 =ğt, 
¬g
, "time out-of-bounds");

72  (
time_t
)
t
;

73 
	}
}

78 #ià!
defšed
(
l_gmtime
)

84 #ià
defšed
(
LUA_USE_POSIX
)

86 
	#l_gmtime
(
t
,
r
è
	`gmtime_r
Ñ,r)

	)

87 
	#l_loÿÉime
(
t
,
r
è
	`loÿÉime_r
Ñ,r)

	)

92 
	#l_gmtime
(
t
,
r
è(()Ô)->
tm_£c
, 
	`gmtime
Ñ))

	)

93 
	#l_loÿÉime
(
t
,
r
è(()Ô)->
tm_£c
, 
	`loÿÉime
Ñ))

	)

109 #ià!
defšed
(
lua_tm²am
)

111 #ià
defšed
(
LUA_USE_POSIX
)

113 
	~<uni¡d.h
>

115 
	#LUA_TMPNAMBUFSIZE
 32

	)

117 #ià!
defšed
(
LUA_TMPNAMTEMPLATE
)

118 
	#LUA_TMPNAMTEMPLATE
 "/tmp/lua_XXXXXX"

	)

121 
	#lua_tm²am
(
b
,
e
) { \

122 
	`¡rıy
(
b
, 
LUA_TMPNAMTEMPLATE
); \

123 
e
 = 
	`mk¡emp
(
b
); \

124 ià(
e
 !ğ-1è
	`şo£
(e); \

125 
e
 = (=ğ-1); }

	)

130 
	#LUA_TMPNAMBUFSIZE
 
L_tm²am


	)

131 
	#lua_tm²am
(
b
,
e
è{ƒ = (
	`tm²am
(bè=ğ
NULL
); }

	)

141 
	$os_execu‹
 (
lua_S‹
 *
L
) {

142 cÚ¡ *
cmd
 = 
	`luaL_İt¡ršg
(
L
, 1, 
NULL
);

143 
¡©
 = 
	`sy¡em
(
cmd
);

144 ià(
cmd
 !ğ
NULL
)

145  
	`luaL_exeüesuÉ
(
L
, 
¡©
);

147 
	`lua_pushboŞ—n
(
L
, 
¡©
);

150 
	}
}

153 
	$os_»move
 (
lua_S‹
 *
L
) {

154 cÚ¡ *
f’ame
 = 
	`luaL_check¡ršg
(
L
, 1);

155  
	`luaL_f”esuÉ
(
L
, 
	`»move
(
f’ame
) == 0, filename);

156 
	}
}

159 
	$os_»Çme
 (
lua_S‹
 *
L
) {

160 cÚ¡ *
äomÇme
 = 
	`luaL_check¡ršg
(
L
, 1);

161 cÚ¡ *
tÚame
 = 
	`luaL_check¡ršg
(
L
, 2);

162  
	`luaL_f”esuÉ
(
L
, 
	`»Çme
(
äomÇme
, 
tÚame
è=ğ0, 
NULL
);

163 
	}
}

166 
	$os_tm²ame
 (
lua_S‹
 *
L
) {

167 
buff
[
LUA_TMPNAMBUFSIZE
];

168 
”r
;

169 
	`lua_tm²am
(
buff
, 
”r
);

170 ià(
”r
)

171  
	`luaL_”rÜ
(
L
, "unableo generate‡ unique filename");

172 
	`lua_push¡ršg
(
L
, 
buff
);

174 
	}
}

177 
	$os_g‘’v
 (
lua_S‹
 *
L
) {

178 
	`lua_push¡ršg
(
L
, 
	`g‘’v
(
	`luaL_check¡ršg
(L, 1)));

180 
	}
}

183 
	$os_şock
 (
lua_S‹
 *
L
) {

184 
	`lua_pushnumb”
(
L
, ((
lua_Numb”
)
	`şock
())/Öua_Numb”)
CLOCKS_PER_SEC
);

186 
	}
}

197 
	$£tf›ld
 (
lua_S‹
 *
L
, cÚ¡ *
key
, 
v®ue
) {

198 
	`lua_pushš‹g”
(
L
, 
v®ue
);

199 
	`lua_£tf›ld
(
L
, -2, 
key
);

200 
	}
}

202 
	$£tboŞf›ld
 (
lua_S‹
 *
L
, cÚ¡ *
key
, 
v®ue
) {

203 ià(
v®ue
 < 0)

205 
	`lua_pushboŞ—n
(
L
, 
v®ue
);

206 
	`lua_£tf›ld
(
L
, -2, 
key
);

207 
	}
}

213 
	$£Îf›lds
 (
lua_S‹
 *
L
, 
tm
 *
¡m
) {

214 
	`£tf›ld
(
L
, "£c", 
¡m
->
tm_£c
);

215 
	`£tf›ld
(
L
, "mš", 
¡m
->
tm_mš
);

216 
	`£tf›ld
(
L
, "hour", 
¡m
->
tm_hour
);

217 
	`£tf›ld
(
L
, "day", 
¡m
->
tm_mday
);

218 
	`£tf›ld
(
L
, "mÚth", 
¡m
->
tm_mÚ
 + 1);

219 
	`£tf›ld
(
L
, "y—r", 
¡m
->
tm_y—r
 + 1900);

220 
	`£tf›ld
(
L
, "wday", 
¡m
->
tm_wday
 + 1);

221 
	`£tf›ld
(
L
, "yday", 
¡m
->
tm_yday
 + 1);

222 
	`£tboŞf›ld
(
L
, "isd¡", 
¡m
->
tm_isd¡
);

223 
	}
}

226 
	$g‘boŞf›ld
 (
lua_S‹
 *
L
, cÚ¡ *
key
) {

227 
»s
;

228 
»s
 = (
	`lua_g‘f›ld
(
L
, -1, 
key
è=ğ
LUA_TNIL
è? -1 : 
	`lua_toboŞ—n
(L, -1);

229 
	`lua_pİ
(
L
, 1);

230  
»s
;

231 
	}
}

235 #ià!
defšed
(
L_MAXDATEFIELD
)

236 
	#L_MAXDATEFIELD
 (
INT_MAX
 / 2)

	)

239 
	$g‘f›ld
 (
lua_S‹
 *
L
, cÚ¡ *
key
, 
d
, 
d–
) {

240 
i¢um
;

241 
t
 = 
	`lua_g‘f›ld
(
L
, -1, 
key
);

242 
lua_IÁeg”
 
»s
 = 
	`lua_toš‹g”x
(
L
, -1, &
i¢um
);

243 ià(!
i¢um
) {

244 ià(
t
 !ğ
LUA_TNIL
)

245  
	`luaL_”rÜ
(
L
, "f›ld '%s' i nÙ‡Àš‹g”", 
key
);

246 ià(
d
 < 0)

247  
	`luaL_”rÜ
(
L
, "f›ld '%s' missšg iÀd©bË", 
key
);

248 
»s
 = 
d
;

251 ià(!(-
L_MAXDATEFIELD
 <ğ
»s
 &&„es <= L_MAXDATEFIELD))

252  
	`luaL_”rÜ
(
L
, "f›ld '%s' i out-of-bound", 
key
);

253 
»s
 -ğ
d–
;

255 
	`lua_pİ
(
L
, 1);

256  ()
»s
;

257 
	}
}

260 cÚ¡ *
	$checkİtiÚ
 (
lua_S‹
 *
L
, cÚ¡ *
cÚv
,

261 
±rdiff_t
 
cÚvËn
, *
buff
) {

262 cÚ¡ *
İtiÚ
 = 
LUA_STRFTIMEOPTIONS
;

263 
İËn
 = 1;

264 ; *
İtiÚ
 !ğ'\0' && 
İËn
 <ğ
cÚvËn
; option += oplen) {

265 ià(*
İtiÚ
 == '|')

266 
İËn
++;

267 ià(
	`memcmp
(
cÚv
, 
İtiÚ
, 
İËn
) == 0) {

268 
	`memıy
(
buff
, 
cÚv
, 
İËn
);

269 
buff
[
İËn
] = '\0';

270  
cÚv
 + 
İËn
;

273 
	`luaL_¬g”rÜ
(
L
, 1,

274 
	`lua_pushf¡ršg
(
L
, "šv®id cÚv”siÚ s³cif›¸'%%%s'", 
cÚv
));

275  
cÚv
;

276 
	}
}

280 
	#SIZETIMEFMT
 250

	)

283 
	$os_d©e
 (
lua_S‹
 *
L
) {

284 
size_t
 
¦’
;

285 cÚ¡ *
s
 = 
	`luaL_İ¡ršg
(
L
, 1, "%c", &
¦’
);

286 
time_t
 
t
 = 
	`luaL_İt
(
L
, 
l_checktime
, 2, 
	`time
(
NULL
));

287 cÚ¡ *
£
 = 
s
 + 
¦’
;

288 
tm
 
tmr
, *
¡m
;

289 ià(*
s
 == '!') {

290 
¡m
 = 
	`l_gmtime
(&
t
, &
tmr
);

291 
s
++;

294 
¡m
 = 
	`l_loÿÉime
(&
t
, &
tmr
);

295 ià(
¡m
 =ğ
NULL
)

296 
	`luaL_”rÜ
(
L
, "time„esult cannot be„epresented inhis installation");

297 ià(
	`¡rcmp
(
s
, "*t") == 0) {

298 
	`lua_ü—‹bË
(
L
, 0, 9);

299 
	`£Îf›lds
(
L
, 
¡m
);

302 
cc
[4];

303 
luaL_Bufãr
 
b
;

304 
cc
[0] = '%';

305 
	`luaL_buffš™
(
L
, &
b
);

306 
s
 < 
£
) {

307 ià(*
s
 != '%')

308 
	`luaL_addch¬
(&
b
, *
s
++);

310 
size_t
 
»¦’
;

311 *
buff
 = 
	`luaL_´•buffsize
(&
b
, 
SIZETIMEFMT
);

312 
s
++;

313 
s
 = 
	`checkİtiÚ
(
L
, s, 
£
 - s, 
cc
 + 1);

314 
»¦’
 = 
	`¡ráime
(
buff
, 
SIZETIMEFMT
, 
cc
, 
¡m
);

315 
	`luaL_addsize
(&
b
, 
»¦’
);

318 
	`luaL_push»suÉ
(&
b
);

321 
	}
}

324 
	$os_time
 (
lua_S‹
 *
L
) {

325 
time_t
 
t
;

326 ià(
	`lua_i¢ÚeÜn
(
L
, 1))

327 
t
 = 
	`time
(
NULL
);

329 
tm
 
ts
;

330 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

331 
	`lua_£‰İ
(
L
, 1);

332 
ts
.
tm_£c
 = 
	`g‘f›ld
(
L
, "sec", 0, 0);

333 
ts
.
tm_mš
 = 
	`g‘f›ld
(
L
, "min", 0, 0);

334 
ts
.
tm_hour
 = 
	`g‘f›ld
(
L
, "hour", 12, 0);

335 
ts
.
tm_mday
 = 
	`g‘f›ld
(
L
, "day", -1, 0);

336 
ts
.
tm_mÚ
 = 
	`g‘f›ld
(
L
, "month", -1, 1);

337 
ts
.
tm_y—r
 = 
	`g‘f›ld
(
L
, "year", -1, 1900);

338 
ts
.
tm_isd¡
 = 
	`g‘boŞf›ld
(
L
, "isdst");

339 
t
 = 
	`mktime
(&
ts
);

340 
	`£Îf›lds
(
L
, &
ts
);

342 ià(
t
 !ğ(
time_t
)(
l_tim‘
)t || == (time_t)(-1))

343 
	`luaL_”rÜ
(
L
, "time„esult cannot be„epresented inhis installation");

344 
	`l_pushtime
(
L
, 
t
);

346 
	}
}

349 
	$os_difáime
 (
lua_S‹
 *
L
) {

350 
time_t
 
t1
 = 
	`l_checktime
(
L
, 1);

351 
time_t
 
t2
 = 
	`l_checktime
(
L
, 2);

352 
	`lua_pushnumb”
(
L
, (
lua_Numb”
)
	`difáime
(
t1
, 
t2
));

354 
	}
}

359 
	$os_£oÿË
 (
lua_S‹
 *
L
) {

360 cÚ¡ 
ÿt
[] = {
LC_ALL
, 
LC_COLLATE
, 
LC_CTYPE
, 
LC_MONETARY
,

361 
LC_NUMERIC
, 
LC_TIME
};

362 cÚ¡ *cÚ¡ 
ÿŠames
[] = {"all", "collate", "ctype", "monetary",

363 "num”ic", "time", 
NULL
};

364 cÚ¡ *
l
 = 
	`luaL_İt¡ršg
(
L
, 1, 
NULL
);

365 
İ
 = 
	`luaL_checkİtiÚ
(
L
, 2, "®l", 
ÿŠames
);

366 
	`lua_push¡ršg
(
L
, 
	`£oÿË
(
ÿt
[
İ
], 
l
));

368 
	}
}

371 
	$os_ex™
 (
lua_S‹
 *
L
) {

372 
¡©us
;

373 ià(
	`lua_isboŞ—n
(
L
, 1))

374 
¡©us
 = (
	`lua_toboŞ—n
(
L
, 1è? 
EXIT_SUCCESS
 : 
EXIT_FAILURE
);

376 
¡©us
 = ()
	`luaL_İtš‹g”
(
L
, 1, 
EXIT_SUCCESS
);

377 ià(
	`lua_toboŞ—n
(
L
, 2))

378 
	`lua_şo£
(
L
);

379 ià(
L
è
	`ex™
(
¡©us
);

381 
	}
}

384 cÚ¡ 
luaL_Reg
 
	gsy¦ib
[] = {

385 {"şock", 
os_şock
},

386 {"d©e", 
os_d©e
},

387 {"difáime", 
os_difáime
},

388 {"execu‹", 
os_execu‹
},

389 {"ex™", 
os_ex™
},

390 {"g‘’v", 
os_g‘’v
},

391 {"»move", 
os_»move
},

392 {"»Çme", 
os_»Çme
},

393 {"£oÿË", 
os_£oÿË
},

394 {"time", 
os_time
},

395 {"tm²ame", 
os_tm²ame
},

396 {
NULL
, NULL}

403 
LUAMOD_API
 
	$luaİ’_os
 (
lua_S‹
 *
L
) {

404 
	`luaL_Ãwlib
(
L
, 
sy¦ib
);

406 
	}
}

	@script/lua/lua-5.3.4/src/lparser.c

7 
	#Í¬£r_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ršg.h
>

15 
	~"lua.h
"

17 
	~"lcode.h
"

18 
	~"ldebug.h
"

19 
	~"ldo.h
"

20 
	~"lfunc.h
"

21 
	~"Îex.h
"

22 
	~"lmem.h
"

23 
	~"lobjeù.h
"

24 
	~"lİcodes.h
"

25 
	~"Í¬£r.h
"

26 
	~"l¡©e.h
"

27 
	~"l¡ršg.h
"

28 
	~"ÉabË.h
"

34 
	#MAXVARS
 200

	)

37 
	#hasmuÉ»t
(
k
è((kè=ğ
VCALL
 || (kè=ğ
VVARARG
)

	)

42 
	#eq¡r
(
a
,
b
è(×è=ğ(b))

	)

48 
	sBlockCÁ
 {

49 
BlockCÁ
 *
	m´evious
;

50 
	mfœ¡Ïb–
;

51 
	mfœ¡gÙo
;

52 
lu_by‹
 
	mÇùv¬
;

53 
lu_by‹
 
	mupv®
;

54 
lu_by‹
 
	mi¦oİ
;

55 } 
	tBlockCÁ
;

62 
¡©em’t
 (
LexS‹
 *
ls
);

63 
ex´
 (
LexS‹
 *
ls
, 
expdesc
 *
v
);

67 
l_nÜ‘
 
	$£m”rÜ
 (
LexS‹
 *
ls
, cÚ¡ *
msg
) {

68 
ls
->
t
.
tok’
 = 0;

69 
	`luaX_syÁax”rÜ
(
ls
, 
msg
);

70 
	}
}

73 
l_nÜ‘
 
	$”rÜ_ex³ùed
 (
LexS‹
 *
ls
, 
tok’
) {

74 
	`luaX_syÁax”rÜ
(
ls
,

75 
	`luaO_pushf¡ršg
(
ls
->
L
, "% ex³ùed", 
	`luaX_tok’2¡r
Ös, 
tok’
)));

76 
	}
}

79 
l_nÜ‘
 
	$”rÜlim™
 (
FuncS‹
 *
fs
, 
lim™
, cÚ¡ *
wh©
) {

80 
lua_S‹
 *
L
 = 
fs
->
ls
->L;

81 cÚ¡ *
msg
;

82 
lše
 = 
fs
->
f
->
lšedefšed
;

83 cÚ¡ *
wh”e
 = (
lše
 == 0)

85 : 
	`luaO_pushf¡ršg
(
L
, "funùiÚ‡ˆlš%d", 
lše
);

86 
msg
 = 
	`luaO_pushf¡ršg
(
L
, "too many %s (limit is %d) in %s",

87 
wh©
, 
lim™
, 
wh”e
);

88 
	`luaX_syÁax”rÜ
(
fs
->
ls
, 
msg
);

89 
	}
}

92 
	$checklim™
 (
FuncS‹
 *
fs
, 
v
, 
l
, cÚ¡ *
wh©
) {

93 ià(
v
 > 
l
è
	`”rÜlim™
(
fs
,†, 
wh©
);

94 
	}
}

97 
	$‹¡Ãxt
 (
LexS‹
 *
ls
, 
c
) {

98 ià(
ls
->
t
.
tok’
 =ğ
c
) {

99 
	`luaX_Ãxt
(
ls
);

103 
	}
}

106 
	$check
 (
LexS‹
 *
ls
, 
c
) {

107 ià(
ls
->
t
.
tok’
 !ğ
c
)

108 
	`”rÜ_ex³ùed
(
ls
, 
c
);

109 
	}
}

112 
	$checkÃxt
 (
LexS‹
 *
ls
, 
c
) {

113 
	`check
(
ls
, 
c
);

114 
	`luaX_Ãxt
(
ls
);

115 
	}
}

118 
	#check_cÚd™iÚ
(
ls
,
c
,
msg
è{ ià(!(c)è
	`luaX_syÁax”rÜ
Ös, msg); }

	)

122 
	$check_m©ch
 (
LexS‹
 *
ls
, 
wh©
, 
who
, 
wh”e
) {

123 ià(!
	`‹¡Ãxt
(
ls
, 
wh©
)) {

124 ià(
wh”e
 =ğ
ls
->
lš’umb”
)

125 
	`”rÜ_ex³ùed
(
ls
, 
wh©
);

127 
	`luaX_syÁax”rÜ
(
ls
, 
	`luaO_pushf¡ršg
Ös->
L
,

129 
	`luaX_tok’2¡r
(
ls
, 
wh©
),†uaX_tok’2¡rÖs, 
who
), 
wh”e
));

132 
	}
}

135 
TSŒšg
 *
	$¡r_checkÇme
 (
LexS‹
 *
ls
) {

136 
TSŒšg
 *
ts
;

137 
	`check
(
ls
, 
TK_NAME
);

138 
ts
 = 
ls
->
t
.
£mšfo
.ts;

139 
	`luaX_Ãxt
(
ls
);

140  
ts
;

141 
	}
}

144 
	$š™_exp
 (
expdesc
 *
e
, 
expkšd
 
k
, 
i
) {

145 
e
->
f
 =ƒ->
t
 = 
NO_JUMP
;

146 
e
->
k
 = k;

147 
e
->
u
.
šfo
 = 
i
;

148 
	}
}

151 
	$code¡ršg
 (
LexS‹
 *
ls
, 
expdesc
 *
e
, 
TSŒšg
 *
s
) {

152 
	`š™_exp
(
e
, 
VK
, 
	`luaK_¡ršgK
(
ls
->
fs
, 
s
));

153 
	}
}

156 
	$checkÇme
 (
LexS‹
 *
ls
, 
expdesc
 *
e
) {

157 
	`code¡ršg
(
ls
, 
e
, 
	`¡r_checkÇme
(ls));

158 
	}
}

161 
	$»gi¡”loÿlv¬
 (
LexS‹
 *
ls
, 
TSŒšg
 *
v¬Çme
) {

162 
FuncS‹
 *
fs
 = 
ls
->fs;

163 
PrÙo
 *
f
 = 
fs
->f;

164 
Şdsize
 = 
f
->
siz–ocv¬s
;

165 
	`luaM_growveùÜ
(
ls
->
L
, 
f
->
locv¬s
, 
fs
->
Æocv¬s
, f->
siz–ocv¬s
,

166 
LocV¬
, 
SHRT_MAX
, "local variables");

167 
Şdsize
 < 
f
->
siz–ocv¬s
)

168 
f
->
locv¬s
[
Şdsize
++].
v¬Çme
 = 
NULL
;

169 
f
->
locv¬s
[
fs
->
Æocv¬s
].
v¬Çme
 = varname;

170 
	`luaC_objb¬r›r
(
ls
->
L
, 
f
, 
v¬Çme
);

171  
fs
->
Æocv¬s
++;

172 
	}
}

175 
	$Ãw_loÿlv¬
 (
LexS‹
 *
ls
, 
TSŒšg
 *
Çme
) {

176 
FuncS‹
 *
fs
 = 
ls
->fs;

177 
Dynd©a
 *
dyd
 = 
ls
->dyd;

178 
»g
 = 
	`»gi¡”loÿlv¬
(
ls
, 
Çme
);

179 
	`checklim™
(
fs
, 
dyd
->
aùv¬
.
n
 + 1 - fs->
fœ¡loÿl
,

180 
MAXVARS
, "local variables");

181 
	`luaM_growveùÜ
(
ls
->
L
, 
dyd
->
aùv¬
.
¬r
, dyd->aùv¬.
n
 + 1,

182 
dyd
->
aùv¬
.
size
, 
V¬desc
, 
MAX_INT
, "local variables");

183 
dyd
->
aùv¬
.
¬r
[dyd->aùv¬.
n
++].
idx
 = 
	`ÿ¡
(, 
»g
);

184 
	}
}

187 
	$Ãw_loÿlv¬l™”®_
 (
LexS‹
 *
ls
, cÚ¡ *
Çme
, 
size_t
 
sz
) {

188 
	`Ãw_loÿlv¬
(
ls
, 
	`luaX_Ãw¡ršg
Ös, 
Çme
, 
sz
));

189 
	}
}

191 
	#Ãw_loÿlv¬l™”®
(
ls
,
v
) \

192 
	`Ãw_loÿlv¬l™”®_
(
ls
, "" 
v
, ((v)/())-1)

	)

195 
LocV¬
 *
	$g‘locv¬
 (
FuncS‹
 *
fs
, 
i
) {

196 
idx
 = 
fs
->
ls
->
dyd
->
aùv¬
.
¬r
[fs->
fœ¡loÿl
 + 
i
].idx;

197 
	`lua_as£¹
(
idx
 < 
fs
->
Æocv¬s
);

198  &
fs
->
f
->
locv¬s
[
idx
];

199 
	}
}

202 
	$adju¡loÿlv¬s
 (
LexS‹
 *
ls
, 
nv¬s
) {

203 
FuncS‹
 *
fs
 = 
ls
->fs;

204 
fs
->
Çùv¬
 = 
	`ÿ¡_by‹
(fs->Çùv¬ + 
nv¬s
);

205 ; 
nv¬s
;‚vars--) {

206 
	`g‘locv¬
(
fs
, fs->
Çùv¬
 - 
nv¬s
)->
¡¬c
 = fs->
pc
;

208 
	}
}

211 
	$»movev¬s
 (
FuncS‹
 *
fs
, 
tŞev–
) {

212 
fs
->
ls
->
dyd
->
aùv¬
.
n
 -ğ(fs->
Çùv¬
 - 
tŞev–
);

213 
fs
->
Çùv¬
 > 
tŞev–
)

214 
	`g‘locv¬
(
fs
, --fs->
Çùv¬
)->
’dpc
 = fs->
pc
;

215 
	}
}

218 
	$£¬chupv®ue
 (
FuncS‹
 *
fs
, 
TSŒšg
 *
Çme
) {

219 
i
;

220 
Upv®desc
 *
up
 = 
fs
->
f
->
upv®ues
;

221 
i
 = 0; i < 
fs
->
nups
; i++) {

222 ià(
	`eq¡r
(
up
[
i
].
Çme
,‚ame))  i;

225 
	}
}

228 
	$Ãwupv®ue
 (
FuncS‹
 *
fs
, 
TSŒšg
 *
Çme
, 
expdesc
 *
v
) {

229 
PrÙo
 *
f
 = 
fs
->f;

230 
Şdsize
 = 
f
->
sizeupv®ues
;

231 
	`checklim™
(
fs
, fs->
nups
 + 1, 
MAXUPVAL
, "upvalues");

232 
	`luaM_growveùÜ
(
fs
->
ls
->
L
, 
f
->
upv®ues
, fs->
nups
, f->
sizeupv®ues
,

233 
Upv®desc
, 
MAXUPVAL
, "upvalues");

234 
Şdsize
 < 
f
->
sizeupv®ues
)

235 
f
->
upv®ues
[
Şdsize
++].
Çme
 = 
NULL
;

236 
f
->
upv®ues
[
fs
->
nups
].
š¡ack
 = (
v
->
k
 =ğ
VLOCAL
);

237 
f
->
upv®ues
[
fs
->
nups
].
idx
 = 
	`ÿ¡_by‹
(
v
->
u
.
šfo
);

238 
f
->
upv®ues
[
fs
->
nups
].
Çme
 =‚ame;

239 
	`luaC_objb¬r›r
(
fs
->
ls
->
L
, 
f
, 
Çme
);

240  
fs
->
nups
++;

241 
	}
}

244 
	$£¬chv¬
 (
FuncS‹
 *
fs
, 
TSŒšg
 *
n
) {

245 
i
;

246 
i
 = 
	`ÿ¡_št
(
fs
->
Çùv¬
) - 1; i >= 0; i--) {

247 ià(
	`eq¡r
(
n
, 
	`g‘locv¬
(
fs
, 
i
)->
v¬Çme
))

248  
i
;

251 
	}
}

258 
	$m¬kupv®
 (
FuncS‹
 *
fs
, 
Ëv–
) {

259 
BlockCÁ
 *
bl
 = 
fs
->bl;

260 
bl
->
Çùv¬
 > 
Ëv–
)

261 
bl
 = bl->
´evious
;

262 
bl
->
upv®
 = 1;

263 
	}
}

270 
	$sšgËv¬aux
 (
FuncS‹
 *
fs
, 
TSŒšg
 *
n
, 
expdesc
 *
v¬
, 
ba£
) {

271 ià(
fs
 =ğ
NULL
)

272 
	`š™_exp
(
v¬
, 
VVOID
, 0);

274 
v
 = 
	`£¬chv¬
(
fs
, 
n
);

275 ià(
v
 >= 0) {

276 
	`š™_exp
(
v¬
, 
VLOCAL
, 
v
);

277 ià(!
ba£
)

278 
	`m¬kupv®
(
fs
, 
v
);

281 
idx
 = 
	`£¬chupv®ue
(
fs
, 
n
);

282 ià(
idx
 < 0) {

283 
	`sšgËv¬aux
(
fs
->
´ev
, 
n
, 
v¬
, 0);

284 ià(
v¬
->
k
 =ğ
VVOID
)

287 
idx
 = 
	`Ãwupv®ue
(
fs
, 
n
, 
v¬
);

289 
	`š™_exp
(
v¬
, 
VUPVAL
, 
idx
);

292 
	}
}

295 
	$sšgËv¬
 (
LexS‹
 *
ls
, 
expdesc
 *
v¬
) {

296 
TSŒšg
 *
v¬Çme
 = 
	`¡r_checkÇme
(
ls
);

297 
FuncS‹
 *
fs
 = 
ls
->fs;

298 
	`sšgËv¬aux
(
fs
, 
v¬Çme
, 
v¬
, 1);

299 ià(
v¬
->
k
 =ğ
VVOID
) {

300 
expdesc
 
key
;

301 
	`sšgËv¬aux
(
fs
, 
ls
->
’vn
, 
v¬
, 1);

302 
	`lua_as£¹
(
v¬
->
k
 !ğ
VVOID
);

303 
	`code¡ršg
(
ls
, &
key
, 
v¬Çme
);

304 
	`luaK_šdexed
(
fs
, 
v¬
, &
key
);

306 
	}
}

309 
	$adju¡_assign
 (
LexS‹
 *
ls
, 
nv¬s
, 
Ãxps
, 
expdesc
 *
e
) {

310 
FuncS‹
 *
fs
 = 
ls
->fs;

311 
exŒa
 = 
nv¬s
 - 
Ãxps
;

312 ià(
	`hasmuÉ»t
(
e
->
k
)) {

313 
exŒa
++;

314 ià(
exŒa
 < 0)ƒxtra = 0;

315 
	`luaK_£Œ‘uºs
(
fs
, 
e
, 
exŒa
);

316 ià(
exŒa
 > 1è
	`luaK_»£rv”egs
(
fs
,ƒxtra-1);

319 ià(
e
->
k
 !ğ
VVOID
è
	`luaK_exp2ÃxŒeg
(
fs
,ƒ);

320 ià(
exŒa
 > 0) {

321 
»g
 = 
fs
->
ä“»g
;

322 
	`luaK_»£rv”egs
(
fs
, 
exŒa
);

323 
	`luaK_n
(
fs
, 
»g
, 
exŒa
);

326 ià(
Ãxps
 > 
nv¬s
)

327 
ls
->
fs
->
ä“»g
 -ğ
Ãxps
 - 
nv¬s
;

328 
	}
}

331 
	$’‹¾ev–
 (
LexS‹
 *
ls
) {

332 
lua_S‹
 *
L
 = 
ls
->L;

333 ++
L
->
nCÿÎs
;

334 
	`checklim™
(
ls
->
fs
, 
L
->
nCÿÎs
, 
LUAI_MAXCCALLS
, "C†evels");

335 
	}
}

338 
	#Ëav–ev–
(
ls
è(Ös)->
L
->
nCÿÎs
--)

	)

341 
	$şo£gÙo
 (
LexS‹
 *
ls
, 
g
, 
Lab–desc
 *
Ïb–
) {

342 
i
;

343 
FuncS‹
 *
fs
 = 
ls
->fs;

344 
Lab–li¡
 *
gl
 = &
ls
->
dyd
->
gt
;

345 
Lab–desc
 *
gt
 = &
gl
->
¬r
[
g
];

346 
	`lua_as£¹
(
	`eq¡r
(
gt
->
Çme
, 
Ïb–
->name));

347 ià(
gt
->
Çùv¬
 < 
Ïb–
->nactvar) {

348 
TSŒšg
 *
vÇme
 = 
	`g‘locv¬
(
fs
, 
gt
->
Çùv¬
)->
v¬Çme
;

349 cÚ¡ *
msg
 = 
	`luaO_pushf¡ršg
(
ls
->
L
,

351 
	`g‘¡r
(
gt
->
Çme
), gt->
lše
, g‘¡r(
vÇme
));

352 
	`£m”rÜ
(
ls
, 
msg
);

354 
	`luaK_·tchli¡
(
fs
, 
gt
->
pc
, 
Ïb–
->pc);

356 
i
 = 
g
; i < 
gl
->
n
 - 1; i++)

357 
gl
->
¬r
[
i
] = gl->arr[i + 1];

358 
gl
->
n
--;

359 
	}
}

365 
	$fšdÏb–
 (
LexS‹
 *
ls
, 
g
) {

366 
i
;

367 
BlockCÁ
 *
bl
 = 
ls
->
fs
->bl;

368 
Dynd©a
 *
dyd
 = 
ls
->dyd;

369 
Lab–desc
 *
gt
 = &
dyd
->gt.
¬r
[
g
];

371 
i
 = 
bl
->
fœ¡Ïb–
; i < 
dyd
->
Ïb–
.
n
; i++) {

372 
Lab–desc
 *
lb
 = &
dyd
->
Ïb–
.
¬r
[
i
];

373 ià(
	`eq¡r
(
lb
->
Çme
, 
gt
->name)) {

374 ià(
gt
->
Çùv¬
 > 
lb
->nactvar &&

375 (
bl
->
upv®
 || 
dyd
->
Ïb–
.
n
 > bl->
fœ¡Ïb–
))

376 
	`luaK_·tchşo£
(
ls
->
fs
, 
gt
->
pc
, 
lb
->
Çùv¬
);

377 
	`şo£gÙo
(
ls
, 
g
, 
lb
);

382 
	}
}

385 
	$ÃwÏb–’Œy
 (
LexS‹
 *
ls
, 
Lab–li¡
 *
l
, 
TSŒšg
 *
Çme
,

386 
lše
, 
pc
) {

387 
n
 = 
l
->n;

388 
	`luaM_growveùÜ
(
ls
->
L
, 
l
->
¬r
, 
n
,†->
size
,

389 
Lab–desc
, 
SHRT_MAX
, "labels/gotos");

390 
l
->
¬r
[
n
].
Çme
 =‚ame;

391 
l
->
¬r
[
n
].
lše
 =†ine;

392 
l
->
¬r
[
n
].
Çùv¬
 = 
ls
->
fs
->nactvar;

393 
l
->
¬r
[
n
].
pc
 =…c;

394 
l
->
n
 =‚ + 1;

395  
n
;

396 
	}
}

403 
	$fšdgÙos
 (
LexS‹
 *
ls
, 
Lab–desc
 *
lb
) {

404 
Lab–li¡
 *
gl
 = &
ls
->
dyd
->
gt
;

405 
i
 = 
ls
->
fs
->
bl
->
fœ¡gÙo
;

406 
i
 < 
gl
->
n
) {

407 ià(
	`eq¡r
(
gl
->
¬r
[
i
].
Çme
, 
lb
->name))

408 
	`şo£gÙo
(
ls
, 
i
, 
lb
);

410 
i
++;

412 
	}
}

421 
	$movegÙosout
 (
FuncS‹
 *
fs
, 
BlockCÁ
 *
bl
) {

422 
i
 = 
bl
->
fœ¡gÙo
;

423 
Lab–li¡
 *
gl
 = &
fs
->
ls
->
dyd
->
gt
;

426 
i
 < 
gl
->
n
) {

427 
Lab–desc
 *
gt
 = &
gl
->
¬r
[
i
];

428 ià(
gt
->
Çùv¬
 > 
bl
->nactvar) {

429 ià(
bl
->
upv®
)

430 
	`luaK_·tchşo£
(
fs
, 
gt
->
pc
, 
bl
->
Çùv¬
);

431 
gt
->
Çùv¬
 = 
bl
->nactvar;

433 ià(!
	`fšdÏb–
(
fs
->
ls
, 
i
))

434 
i
++;

436 
	}
}

439 
	$’‹rblock
 (
FuncS‹
 *
fs
, 
BlockCÁ
 *
bl
, 
lu_by‹
 
i¦oİ
) {

440 
bl
->
i¦oİ
 = isloop;

441 
bl
->
Çùv¬
 = 
fs
->nactvar;

442 
bl
->
fœ¡Ïb–
 = 
fs
->
ls
->
dyd
->
Ïb–
.
n
;

443 
bl
->
fœ¡gÙo
 = 
fs
->
ls
->
dyd
->
gt
.
n
;

444 
bl
->
upv®
 = 0;

445 
bl
->
´evious
 = 
fs
->bl;

446 
fs
->
bl
 = bl;

447 
	`lua_as£¹
(
fs
->
ä“»g
 =ğfs->
Çùv¬
);

448 
	}
}

454 
	$b»akÏb–
 (
LexS‹
 *
ls
) {

455 
TSŒšg
 *
n
 = 
	`luaS_Ãw
(
ls
->
L
, "break");

456 
l
 = 
	`ÃwÏb–’Œy
(
ls
, &ls->
dyd
->
Ïb–
, 
n
, 0,†s->
fs
->
pc
);

457 
	`fšdgÙos
(
ls
, &ls->
dyd
->
Ïb–
.
¬r
[
l
]);

458 
	}
}

464 
l_nÜ‘
 
	$undefgÙo
 (
LexS‹
 *
ls
, 
Lab–desc
 *
gt
) {

465 cÚ¡ *
msg
 = 
	`i¤e£rved
(
gt
->
Çme
)

468 
msg
 = 
	`luaO_pushf¡ršg
(
ls
->
L
, msg, 
	`g‘¡r
(
gt
->
Çme
), gt->
lše
);

469 
	`£m”rÜ
(
ls
, 
msg
);

470 
	}
}

473 
	$Ëaveblock
 (
FuncS‹
 *
fs
) {

474 
BlockCÁ
 *
bl
 = 
fs
->bl;

475 
LexS‹
 *
ls
 = 
fs
->ls;

476 ià(
bl
->
´evious
 && bl->
upv®
) {

478 
j
 = 
	`luaK_jump
(
fs
);

479 
	`luaK_·tchşo£
(
fs
, 
j
, 
bl
->
Çùv¬
);

480 
	`luaK_·tchtoh”e
(
fs
, 
j
);

482 ià(
bl
->
i¦oİ
)

483 
	`b»akÏb–
(
ls
);

484 
fs
->
bl
 = bl->
´evious
;

485 
	`»movev¬s
(
fs
, 
bl
->
Çùv¬
);

486 
	`lua_as£¹
(
bl
->
Çùv¬
 =ğ
fs
->nactvar);

487 
fs
->
ä“»g
 = fs->
Çùv¬
;

488 
ls
->
dyd
->
Ïb–
.
n
 = 
bl
->
fœ¡Ïb–
;

489 ià(
bl
->
´evious
)

490 
	`movegÙosout
(
fs
, 
bl
);

491 ià(
bl
->
fœ¡gÙo
 < 
ls
->
dyd
->
gt
.
n
)

492 
	`undefgÙo
(
ls
, &ls->
dyd
->
gt
.
¬r
[
bl
->
fœ¡gÙo
]);

493 
	}
}

499 
PrÙo
 *
	$add´ÙÙy³
 (
LexS‹
 *
ls
) {

500 
PrÙo
 *
şp
;

501 
lua_S‹
 *
L
 = 
ls
->L;

502 
FuncS‹
 *
fs
 = 
ls
->fs;

503 
PrÙo
 *
f
 = 
fs
->f;

504 ià(
fs
->
Å
 >ğ
f
->
siz•
) {

505 
Şdsize
 = 
f
->
siz•
;

506 
	`luaM_growveùÜ
(
L
, 
f
->
p
, 
fs
->
Å
, f->
siz•
, 
PrÙo
 *, 
MAXARG_Bx
, "functions");

507 
Şdsize
 < 
f
->
siz•
)

508 
f
->
p
[
Şdsize
++] = 
NULL
;

510 
f
->
p
[
fs
->
Å
++] = 
şp
 = 
	`luaF_Ãw´Ùo
(
L
);

511 
	`luaC_objb¬r›r
(
L
, 
f
, 
şp
);

512  
şp
;

513 
	}
}

522 
	$codeşosu»
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

523 
FuncS‹
 *
fs
 = 
ls
->fs->
´ev
;

524 
	`š™_exp
(
v
, 
VRELOCABLE
, 
	`luaK_codeABx
(
fs
, 
OP_CLOSURE
, 0, fs->
Å
 - 1));

525 
	`luaK_exp2ÃxŒeg
(
fs
, 
v
);

526 
	}
}

529 
	$İ’_func
 (
LexS‹
 *
ls
, 
FuncS‹
 *
fs
, 
BlockCÁ
 *
bl
) {

530 
PrÙo
 *
f
;

531 
fs
->
´ev
 = 
ls
->fs;

532 
fs
->
ls
 =†s;

533 
ls
->
fs
 = fs;

534 
fs
->
pc
 = 0;

535 
fs
->
Ï¡rg‘
 = 0;

536 
fs
->
jpc
 = 
NO_JUMP
;

537 
fs
->
ä“»g
 = 0;

538 
fs
->
nk
 = 0;

539 
fs
->
Å
 = 0;

540 
fs
->
nups
 = 0;

541 
fs
->
Æocv¬s
 = 0;

542 
fs
->
Çùv¬
 = 0;

543 
fs
->
fœ¡loÿl
 = 
ls
->
dyd
->
aùv¬
.
n
;

544 
fs
->
bl
 = 
NULL
;

545 
f
 = 
fs
->f;

546 
f
->
sourû
 = 
ls
->source;

547 
f
->
max¡acksize
 = 2;

548 
	`’‹rblock
(
fs
, 
bl
, 0);

549 
	}
}

552 
	$şo£_func
 (
LexS‹
 *
ls
) {

553 
lua_S‹
 *
L
 = 
ls
->L;

554 
FuncS‹
 *
fs
 = 
ls
->fs;

555 
PrÙo
 *
f
 = 
fs
->f;

556 
	`luaK_»t
(
fs
, 0, 0);

557 
	`Ëaveblock
(
fs
);

558 
	`luaM_»®locveùÜ
(
L
, 
f
->
code
, f->
sizecode
, 
fs
->
pc
, 
In¡ruùiÚ
);

559 
f
->
sizecode
 = 
fs
->
pc
;

560 
	`luaM_»®locveùÜ
(
L
, 
f
->
lšešfo
, f->
siz–šešfo
, 
fs
->
pc
, );

561 
f
->
siz–šešfo
 = 
fs
->
pc
;

562 
	`luaM_»®locveùÜ
(
L
, 
f
->
k
, f->
sizek
, 
fs
->
nk
, 
TV®ue
);

563 
f
->
sizek
 = 
fs
->
nk
;

564 
	`luaM_»®locveùÜ
(
L
, 
f
->
p
, f->
siz•
, 
fs
->
Å
, 
PrÙo
 *);

565 
f
->
siz•
 = 
fs
->
Å
;

566 
	`luaM_»®locveùÜ
(
L
, 
f
->
locv¬s
, f->
siz–ocv¬s
, 
fs
->
Æocv¬s
, 
LocV¬
);

567 
f
->
siz–ocv¬s
 = 
fs
->
Æocv¬s
;

568 
	`luaM_»®locveùÜ
(
L
, 
f
->
upv®ues
, f->
sizeupv®ues
, 
fs
->
nups
, 
Upv®desc
);

569 
f
->
sizeupv®ues
 = 
fs
->
nups
;

570 
	`lua_as£¹
(
fs
->
bl
 =ğ
NULL
);

571 
ls
->
fs
 = fs->
´ev
;

572 
	`luaC_checkGC
(
L
);

573 
	}
}

587 
	$block_fŞlow
 (
LexS‹
 *
ls
, 
w™huÁ
) {

588 
ls
->
t
.
tok’
) {

589 
TK_ELSE
: 
TK_ELSEIF
:

590 
TK_END
: 
TK_EOS
:

592 
TK_UNTIL
:  
w™huÁ
;

595 
	}
}

598 
	$¡©li¡
 (
LexS‹
 *
ls
) {

600 !
	`block_fŞlow
(
ls
, 1)) {

601 ià(
ls
->
t
.
tok’
 =ğ
TK_RETURN
) {

602 
	`¡©em’t
(
ls
);

605 
	`¡©em’t
(
ls
);

607 
	}
}

610 
	$f›ld£l
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

612 
FuncS‹
 *
fs
 = 
ls
->fs;

613 
expdesc
 
key
;

614 
	`luaK_exp2ªy»gup
(
fs
, 
v
);

615 
	`luaX_Ãxt
(
ls
);

616 
	`checkÇme
(
ls
, &
key
);

617 
	`luaK_šdexed
(
fs
, 
v
, &
key
);

618 
	}
}

621 
	$yšdex
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

623 
	`luaX_Ãxt
(
ls
);

624 
	`ex´
(
ls
, 
v
);

625 
	`luaK_exp2v®
(
ls
->
fs
, 
v
);

626 
	`checkÃxt
(
ls
, ']');

627 
	}
}

637 
	sCÚsCÚŒŞ
 {

638 
expdesc
 
	mv
;

639 
expdesc
 *
	mt
;

640 
	mnh
;

641 
	mÇ
;

642 
	mto¡Üe
;

646 
	$»cf›ld
 (
LexS‹
 *
ls
, 
CÚsCÚŒŞ
 *
cc
) {

648 
FuncS‹
 *
fs
 = 
ls
->fs;

649 
»g
 = 
ls
->
fs
->
ä“»g
;

650 
expdesc
 
key
, 
v®
;

651 
rkkey
;

652 ià(
ls
->
t
.
tok’
 =ğ
TK_NAME
) {

653 
	`checklim™
(
fs
, 
cc
->
nh
, 
MAX_INT
, "items in‡ constructor");

654 
	`checkÇme
(
ls
, &
key
);

657 
	`yšdex
(
ls
, &
key
);

658 
cc
->
nh
++;

659 
	`checkÃxt
(
ls
, '=');

660 
rkkey
 = 
	`luaK_exp2RK
(
fs
, &
key
);

661 
	`ex´
(
ls
, &
v®
);

662 
	`luaK_codeABC
(
fs
, 
OP_SETTABLE
, 
cc
->
t
->
u
.
šfo
, 
rkkey
, 
	`luaK_exp2RK
(fs, &
v®
));

663 
fs
->
ä“»g
 = 
»g
;

664 
	}
}

667 
	$şo£li¡f›ld
 (
FuncS‹
 *
fs
, 
CÚsCÚŒŞ
 *
cc
) {

668 ià(
cc
->
v
.
k
 =ğ
VVOID
) ;

669 
	`luaK_exp2ÃxŒeg
(
fs
, &
cc
->
v
);

670 
cc
->
v
.
k
 = 
VVOID
;

671 ià(
cc
->
to¡Üe
 =ğ
LFIELDS_PER_FLUSH
) {

672 
	`luaK_£i¡
(
fs
, 
cc
->
t
->
u
.
šfo
, cc->
Ç
, cc->
to¡Üe
);

673 
cc
->
to¡Üe
 = 0;

675 
	}
}

678 
	$Ï¡li¡f›ld
 (
FuncS‹
 *
fs
, 
CÚsCÚŒŞ
 *
cc
) {

679 ià(
cc
->
to¡Üe
 == 0) ;

680 ià(
	`hasmuÉ»t
(
cc
->
v
.
k
)) {

681 
	`luaK_£tmuÉ»t
(
fs
, &
cc
->
v
);

682 
	`luaK_£i¡
(
fs
, 
cc
->
t
->
u
.
šfo
, cc->
Ç
, 
LUA_MULTRET
);

683 
cc
->
Ç
--;

686 ià(
cc
->
v
.
k
 !ğ
VVOID
)

687 
	`luaK_exp2ÃxŒeg
(
fs
, &
cc
->
v
);

688 
	`luaK_£i¡
(
fs
, 
cc
->
t
->
u
.
šfo
, cc->
Ç
, cc->
to¡Üe
);

690 
	}
}

693 
	$li¡f›ld
 (
LexS‹
 *
ls
, 
CÚsCÚŒŞ
 *
cc
) {

695 
	`ex´
(
ls
, &
cc
->
v
);

696 
	`checklim™
(
ls
->
fs
, 
cc
->
Ç
, 
MAX_INT
, "items in‡ constructor");

697 
cc
->
Ç
++;

698 
cc
->
to¡Üe
++;

699 
	}
}

702 
	$f›ld
 (
LexS‹
 *
ls
, 
CÚsCÚŒŞ
 *
cc
) {

704 
ls
->
t
.
tok’
) {

705 
TK_NAME
: {

706 ià(
	`luaX_lookah—d
(
ls
) != '=')

707 
	`li¡f›ld
(
ls
, 
cc
);

709 
	`»cf›ld
(
ls
, 
cc
);

713 
	`»cf›ld
(
ls
, 
cc
);

717 
	`li¡f›ld
(
ls
, 
cc
);

721 
	}
}

724 
	$cÚ¡ruùÜ
 (
LexS‹
 *
ls
, 
expdesc
 *
t
) {

727 
FuncS‹
 *
fs
 = 
ls
->fs;

728 
lše
 = 
ls
->
lš’umb”
;

729 
pc
 = 
	`luaK_codeABC
(
fs
, 
OP_NEWTABLE
, 0, 0, 0);

730 
CÚsCÚŒŞ
 
cc
;

731 
cc
.
Ç
 = cc.
nh
 = cc.
to¡Üe
 = 0;

732 
cc
.
t
 =;

733 
	`š™_exp
(
t
, 
VRELOCABLE
, 
pc
);

734 
	`š™_exp
(&
cc
.
v
, 
VVOID
, 0);

735 
	`luaK_exp2ÃxŒeg
(
ls
->
fs
, 
t
);

736 
	`checkÃxt
(
ls
, '{');

738 
	`lua_as£¹
(
cc
.
v
.
k
 =ğ
VVOID
 || cc.
to¡Üe
 > 0);

739 ià(
ls
->
t
.
tok’
 == '}') ;

740 
	`şo£li¡f›ld
(
fs
, &
cc
);

741 
	`f›ld
(
ls
, &
cc
);

742 } 
	`‹¡Ãxt
(
ls
, ',') ||estnext(ls, ';'));

743 
	`check_m©ch
(
ls
, '}', '{', 
lše
);

744 
	`Ï¡li¡f›ld
(
fs
, &
cc
);

745 
	`SETARG_B
(
fs
->
f
->
code
[
pc
], 
	`luaO_št2fb
(
cc
.
Ç
));

746 
	`SETARG_C
(
fs
->
f
->
code
[
pc
], 
	`luaO_št2fb
(
cc
.
nh
));

747 
	}
}

753 
	$·¾i¡
 (
LexS‹
 *
ls
) {

755 
FuncS‹
 *
fs
 = 
ls
->fs;

756 
PrÙo
 *
f
 = 
fs
->f;

757 
Å¬ams
 = 0;

758 
f
->
is_v¬¬g
 = 0;

759 ià(
ls
->
t
.
tok’
 != ')') {

761 
ls
->
t
.
tok’
) {

762 
TK_NAME
: {

763 
	`Ãw_loÿlv¬
(
ls
, 
	`¡r_checkÇme
(ls));

764 
Å¬ams
++;

767 
TK_DOTS
: {

768 
	`luaX_Ãxt
(
ls
);

769 
f
->
is_v¬¬g
 = 1;

772 : 
	`luaX_syÁax”rÜ
(
ls
, "<name> or '...'ƒxpected");

774 } !
f
->
is_v¬¬g
 && 
	`‹¡Ãxt
(
ls
, ','));

776 
	`adju¡loÿlv¬s
(
ls
, 
Å¬ams
);

777 
f
->
num·¿ms
 = 
	`ÿ¡_by‹
(
fs
->
Çùv¬
);

778 
	`luaK_»£rv”egs
(
fs
, fs->
Çùv¬
);

779 
	}
}

782 
	$body
 (
LexS‹
 *
ls
, 
expdesc
 *
e
, 
ism‘hod
, 
lše
) {

784 
FuncS‹
 
Ãw_fs
;

785 
BlockCÁ
 
bl
;

786 
Ãw_fs
.
f
 = 
	`add´ÙÙy³
(
ls
);

787 
Ãw_fs
.
f
->
lšedefšed
 = 
lše
;

788 
	`İ’_func
(
ls
, &
Ãw_fs
, &
bl
);

789 
	`checkÃxt
(
ls
, '(');

790 ià(
ism‘hod
) {

791 
	`Ãw_loÿlv¬l™”®
(
ls
, "self");

792 
	`adju¡loÿlv¬s
(
ls
, 1);

794 
	`·¾i¡
(
ls
);

795 
	`checkÃxt
(
ls
, ')');

796 
	`¡©li¡
(
ls
);

797 
Ãw_fs
.
f
->
Ï¡lšedefšed
 = 
ls
->
lš’umb”
;

798 
	`check_m©ch
(
ls
, 
TK_END
, 
TK_FUNCTION
, 
lše
);

799 
	`codeşosu»
(
ls
, 
e
);

800 
	`şo£_func
(
ls
);

801 
	}
}

804 
	$ex¶i¡
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

806 
n
 = 1;

807 
	`ex´
(
ls
, 
v
);

808 
	`‹¡Ãxt
(
ls
, ',')) {

809 
	`luaK_exp2ÃxŒeg
(
ls
->
fs
, 
v
);

810 
	`ex´
(
ls
, 
v
);

811 
n
++;

813  
n
;

814 
	}
}

817 
	$funÿrgs
 (
LexS‹
 *
ls
, 
expdesc
 *
f
, 
lše
) {

818 
FuncS‹
 *
fs
 = 
ls
->fs;

819 
expdesc
 
¬gs
;

820 
ba£
, 
Å¬ams
;

821 
ls
->
t
.
tok’
) {

823 
	`luaX_Ãxt
(
ls
);

824 ià(
ls
->
t
.
tok’
 == ')')

825 
¬gs
.
k
 = 
VVOID
;

827 
	`ex¶i¡
(
ls
, &
¬gs
);

828 
	`luaK_£tmuÉ»t
(
fs
, &
¬gs
);

830 
	`check_m©ch
(
ls
, ')', '(', 
lše
);

834 
	`cÚ¡ruùÜ
(
ls
, &
¬gs
);

837 
TK_STRING
: {

838 
	`code¡ršg
(
ls
, &
¬gs
,†s->
t
.
£mšfo
.
ts
);

839 
	`luaX_Ãxt
(
ls
);

843 
	`luaX_syÁax”rÜ
(
ls
, "function‡rgumentsƒxpected");

846 
	`lua_as£¹
(
f
->
k
 =ğ
VNONRELOC
);

847 
ba£
 = 
f
->
u
.
šfo
;

848 ià(
	`hasmuÉ»t
(
¬gs
.
k
))

849 
Å¬ams
 = 
LUA_MULTRET
;

851 ià(
¬gs
.
k
 !ğ
VVOID
)

852 
	`luaK_exp2ÃxŒeg
(
fs
, &
¬gs
);

853 
Å¬ams
 = 
fs
->
ä“»g
 - (
ba£
+1);

855 
	`š™_exp
(
f
, 
VCALL
, 
	`luaK_codeABC
(
fs
, 
OP_CALL
, 
ba£
, 
Å¬ams
+1, 2));

856 
	`luaK_fixlše
(
fs
, 
lše
);

857 
fs
->
ä“»g
 = 
ba£
+1;

859 
	}
}

871 
	$´im¬yexp
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

873 
ls
->
t
.
tok’
) {

875 
lše
 = 
ls
->
lš’umb”
;

876 
	`luaX_Ãxt
(
ls
);

877 
	`ex´
(
ls
, 
v
);

878 
	`check_m©ch
(
ls
, ')', '(', 
lše
);

879 
	`luaK_disch¬gev¬s
(
ls
->
fs
, 
v
);

882 
TK_NAME
: {

883 
	`sšgËv¬
(
ls
, 
v
);

887 
	`luaX_syÁax”rÜ
(
ls
, "unexpected symbol");

890 
	}
}

893 
	$suffixedexp
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

896 
FuncS‹
 *
fs
 = 
ls
->fs;

897 
lše
 = 
ls
->
lš’umb”
;

898 
	`´im¬yexp
(
ls
, 
v
);

900 
ls
->
t
.
tok’
) {

902 
	`f›ld£l
(
ls
, 
v
);

906 
expdesc
 
key
;

907 
	`luaK_exp2ªy»gup
(
fs
, 
v
);

908 
	`yšdex
(
ls
, &
key
);

909 
	`luaK_šdexed
(
fs
, 
v
, &
key
);

913 
expdesc
 
key
;

914 
	`luaX_Ãxt
(
ls
);

915 
	`checkÇme
(
ls
, &
key
);

916 
	`luaK_£lf
(
fs
, 
v
, &
key
);

917 
	`funÿrgs
(
ls
, 
v
, 
lše
);

920 '(': 
TK_STRING
: '{': {

921 
	`luaK_exp2ÃxŒeg
(
fs
, 
v
);

922 
	`funÿrgs
(
ls
, 
v
, 
lše
);

928 
	}
}

931 
	$sim¶“xp
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

934 
ls
->
t
.
tok’
) {

935 
TK_FLT
: {

936 
	`š™_exp
(
v
, 
VKFLT
, 0);

937 
v
->
u
.
nv®
 = 
ls
->
t
.
£mšfo
.
r
;

940 
TK_INT
: {

941 
	`š™_exp
(
v
, 
VKINT
, 0);

942 
v
->
u
.
iv®
 = 
ls
->
t
.
£mšfo
.
i
;

945 
TK_STRING
: {

946 
	`code¡ršg
(
ls
, 
v
,†s->
t
.
£mšfo
.
ts
);

949 
TK_NIL
: {

950 
	`š™_exp
(
v
, 
VNIL
, 0);

953 
TK_TRUE
: {

954 
	`š™_exp
(
v
, 
VTRUE
, 0);

957 
TK_FALSE
: {

958 
	`š™_exp
(
v
, 
VFALSE
, 0);

961 
TK_DOTS
: {

962 
FuncS‹
 *
fs
 = 
ls
->fs;

963 
	`check_cÚd™iÚ
(
ls
, 
fs
->
f
->
is_v¬¬g
,

965 
	`š™_exp
(
v
, 
VVARARG
, 
	`luaK_codeABC
(
fs
, 
OP_VARARG
, 0, 1, 0));

969 
	`cÚ¡ruùÜ
(
ls
, 
v
);

972 
TK_FUNCTION
: {

973 
	`luaX_Ãxt
(
ls
);

974 
	`body
(
ls
, 
v
, 0,†s->
lš’umb”
);

978 
	`suffixedexp
(
ls
, 
v
);

982 
	`luaX_Ãxt
(
ls
);

983 
	}
}

986 
UnO´
 
	$g‘unİr
 (
İ
) {

987 
İ
) {

988 
TK_NOT
:  
OPR_NOT
;

989 '-':  
OPR_MINUS
;

990 '~':  
OPR_BNOT
;

991 '#':  
OPR_LEN
;

992 :  
OPR_NOUNOPR
;

994 
	}
}

997 
BšO´
 
	$g‘bšİr
 (
İ
) {

998 
İ
) {

999 '+':  
OPR_ADD
;

1000 '-':  
OPR_SUB
;

1001 '*':  
OPR_MUL
;

1002 '%':  
OPR_MOD
;

1003 '^':  
OPR_POW
;

1004 '/':  
OPR_DIV
;

1005 
TK_IDIV
:  
OPR_IDIV
;

1006 '&':  
OPR_BAND
;

1007 '|':  
OPR_BOR
;

1008 '~':  
OPR_BXOR
;

1009 
TK_SHL
:  
OPR_SHL
;

1010 
TK_SHR
:  
OPR_SHR
;

1011 
TK_CONCAT
:  
OPR_CONCAT
;

1012 
TK_NE
:  
OPR_NE
;

1013 
TK_EQ
:  
OPR_EQ
;

1014 '<':  
OPR_LT
;

1015 
TK_LE
:  
OPR_LE
;

1016 '>':  
OPR_GT
;

1017 
TK_GE
:  
OPR_GE
;

1018 
TK_AND
:  
OPR_AND
;

1019 
TK_OR
:  
OPR_OR
;

1020 :  
OPR_NOBINOPR
;

1022 
	}
}

1026 
lu_by‹
 
	mËá
;

1027 
lu_by‹
 
	mright
;

1028 } 
	g´iÜ™y
[] = {

1041 
	#UNARY_PRIORITY
 12

	)

1048 
BšO´
 
	$subex´
 (
LexS‹
 *
ls
, 
expdesc
 *
v
, 
lim™
) {

1049 
BšO´
 
İ
;

1050 
UnO´
 
uİ
;

1051 
	`’‹¾ev–
(
ls
);

1052 
uİ
 = 
	`g‘unİr
(
ls
->
t
.
tok’
);

1053 ià(
uİ
 !ğ
OPR_NOUNOPR
) {

1054 
lše
 = 
ls
->
lš’umb”
;

1055 
	`luaX_Ãxt
(
ls
);

1056 
	`subex´
(
ls
, 
v
, 
UNARY_PRIORITY
);

1057 
	`luaK_´efix
(
ls
->
fs
, 
uİ
, 
v
, 
lše
);

1059 
	`sim¶“xp
(
ls
, 
v
);

1061 
İ
 = 
	`g‘bšİr
(
ls
->
t
.
tok’
);

1062 
İ
 !ğ
OPR_NOBINOPR
 && 
´iÜ™y
[İ].
Ëá
 > 
lim™
) {

1063 
expdesc
 
v2
;

1064 
BšO´
 
Ãxtİ
;

1065 
lše
 = 
ls
->
lš’umb”
;

1066 
	`luaX_Ãxt
(
ls
);

1067 
	`luaK_šfix
(
ls
->
fs
, 
İ
, 
v
);

1069 
Ãxtİ
 = 
	`subex´
(
ls
, &
v2
, 
´iÜ™y
[
İ
].
right
);

1070 
	`luaK_posfix
(
ls
->
fs
, 
İ
, 
v
, &
v2
, 
lše
);

1071 
İ
 = 
Ãxtİ
;

1073 
	`Ëav–ev–
(
ls
);

1074  
İ
;

1075 
	}
}

1078 
	$ex´
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

1079 
	`subex´
(
ls
, 
v
, 0);

1080 
	}
}

1093 
	$block
 (
LexS‹
 *
ls
) {

1095 
FuncS‹
 *
fs
 = 
ls
->fs;

1096 
BlockCÁ
 
bl
;

1097 
	`’‹rblock
(
fs
, &
bl
, 0);

1098 
	`¡©li¡
(
ls
);

1099 
	`Ëaveblock
(
fs
);

1100 
	}
}

1107 
	sLHS_assign
 {

1108 
LHS_assign
 *
	m´ev
;

1109 
expdesc
 
	mv
;

1119 
	$check_cÚæiù
 (
LexS‹
 *
ls
, 
LHS_assign
 *
lh
, 
expdesc
 *
v
) {

1120 
FuncS‹
 *
fs
 = 
ls
->fs;

1121 
exŒa
 = 
fs
->
ä“»g
;

1122 
cÚæiù
 = 0;

1123 ; 
lh
;†h =†h->
´ev
) {

1124 ià(
lh
->
v
.
k
 =ğ
VINDEXED
) {

1126 ià(
lh
->
v
.
u
.
šd
.
vt
 =ğv->
k
 &&†h->v.u.šd.
t
 =ğv->u.
šfo
) {

1127 
cÚæiù
 = 1;

1128 
lh
->
v
.
u
.
šd
.
vt
 = 
VLOCAL
;

1129 
lh
->
v
.
u
.
šd
.
t
 = 
exŒa
;

1132 ià(
v
->
k
 =ğ
VLOCAL
 && 
lh
->v.
u
.
šd
.
idx
 =ğv->u.
šfo
) {

1133 
cÚæiù
 = 1;

1134 
lh
->
v
.
u
.
šd
.
idx
 = 
exŒa
;

1138 ià(
cÚæiù
) {

1140 
OpCode
 
İ
 = (
v
->
k
 =ğ
VLOCAL
è? 
OP_MOVE
 : 
OP_GETUPVAL
;

1141 
	`luaK_codeABC
(
fs
, 
İ
, 
exŒa
, 
v
->
u
.
šfo
, 0);

1142 
	`luaK_»£rv”egs
(
fs
, 1);

1144 
	}
}

1147 
	$assignm’t
 (
LexS‹
 *
ls
, 
LHS_assign
 *
lh
, 
nv¬s
) {

1148 
expdesc
 
e
;

1149 
	`check_cÚd™iÚ
(
ls
, 
	`vkisv¬
(
lh
->
v
.
k
), "syntaxƒrror");

1150 ià(
	`‹¡Ãxt
(
ls
, ',')) {

1151 
LHS_assign
 
nv
;

1152 
nv
.
´ev
 = 
lh
;

1153 
	`suffixedexp
(
ls
, &
nv
.
v
);

1154 ià(
nv
.
v
.
k
 !ğ
VINDEXED
)

1155 
	`check_cÚæiù
(
ls
, 
lh
, &
nv
.
v
);

1156 
	`checklim™
(
ls
->
fs
, 
nv¬s
 +†s->
L
->
nCÿÎs
, 
LUAI_MAXCCALLS
,

1158 
	`assignm’t
(
ls
, &
nv
, 
nv¬s
+1);

1161 
Ãxps
;

1162 
	`checkÃxt
(
ls
, '=');

1163 
Ãxps
 = 
	`ex¶i¡
(
ls
, &
e
);

1164 ià(
Ãxps
 !ğ
nv¬s
)

1165 
	`adju¡_assign
(
ls
, 
nv¬s
, 
Ãxps
, &
e
);

1167 
	`luaK_£tÚ”‘
(
ls
->
fs
, &
e
);

1168 
	`luaK_¡Üev¬
(
ls
->
fs
, &
lh
->
v
, &
e
);

1172 
	`š™_exp
(&
e
, 
VNONRELOC
, 
ls
->
fs
->
ä“»g
-1);

1173 
	`luaK_¡Üev¬
(
ls
->
fs
, &
lh
->
v
, &
e
);

1174 
	}
}

1177 
	$cÚd
 (
LexS‹
 *
ls
) {

1179 
expdesc
 
v
;

1180 
	`ex´
(
ls
, &
v
);

1181 ià(
v
.
k
 =ğ
VNIL
èv.k = 
VFALSE
;

1182 
	`luaK_goiárue
(
ls
->
fs
, &
v
);

1183  
v
.
f
;

1184 
	}
}

1187 
	$gÙo¡©
 (
LexS‹
 *
ls
, 
pc
) {

1188 
lše
 = 
ls
->
lš’umb”
;

1189 
TSŒšg
 *
Ïb–
;

1190 
g
;

1191 ià(
	`‹¡Ãxt
(
ls
, 
TK_GOTO
))

1192 
Ïb–
 = 
	`¡r_checkÇme
(
ls
);

1194 
	`luaX_Ãxt
(
ls
);

1195 
Ïb–
 = 
	`luaS_Ãw
(
ls
->
L
, "break");

1197 
g
 = 
	`ÃwÏb–’Œy
(
ls
, &ls->
dyd
->
gt
, 
Ïb–
, 
lše
, 
pc
);

1198 
	`fšdÏb–
(
ls
, 
g
);

1199 
	}
}

1203 
	$check»³©ed
 (
FuncS‹
 *
fs
, 
Lab–li¡
 *
Î
, 
TSŒšg
 *
Ïb–
) {

1204 
i
;

1205 
i
 = 
fs
->
bl
->
fœ¡Ïb–
; i < 
Î
->
n
; i++) {

1206 ià(
	`eq¡r
(
Ïb–
, 
Î
->
¬r
[
i
].
Çme
)) {

1207 cÚ¡ *
msg
 = 
	`luaO_pushf¡ršg
(
fs
->
ls
->
L
,

1209 
	`g‘¡r
(
Ïb–
), 
Î
->
¬r
[
i
].
lše
);

1210 
	`£m”rÜ
(
fs
->
ls
, 
msg
);

1213 
	}
}

1217 
	$sknoİ¡©
 (
LexS‹
 *
ls
) {

1218 
ls
->
t
.
tok’
 =ğ';' ||†s->t.tok’ =ğ
TK_DBCOLON
)

1219 
	`¡©em’t
(
ls
);

1220 
	}
}

1223 
	$Ïb–¡©
 (
LexS‹
 *
ls
, 
TSŒšg
 *
Ïb–
, 
lše
) {

1225 
FuncS‹
 *
fs
 = 
ls
->fs;

1226 
Lab–li¡
 *
Î
 = &
ls
->
dyd
->
Ïb–
;

1227 
l
;

1228 
	`check»³©ed
(
fs
, 
Î
, 
Ïb–
);

1229 
	`checkÃxt
(
ls
, 
TK_DBCOLON
);

1231 
l
 = 
	`ÃwÏb–’Œy
(
ls
, 
Î
, 
Ïb–
, 
lše
, 
	`luaK_g‘Ïb–
(
fs
));

1232 
	`sknoİ¡©
(
ls
);

1233 ià(
	`block_fŞlow
(
ls
, 0)) {

1235 
Î
->
¬r
[
l
].
Çùv¬
 = 
fs
->
bl
->nactvar;

1237 
	`fšdgÙos
(
ls
, &
Î
->
¬r
[
l
]);

1238 
	}
}

1241 
	$whe¡©
 (
LexS‹
 *
ls
, 
lše
) {

1243 
FuncS‹
 *
fs
 = 
ls
->fs;

1244 
wheš™
;

1245 
cÚdex™
;

1246 
BlockCÁ
 
bl
;

1247 
	`luaX_Ãxt
(
ls
);

1248 
wheš™
 = 
	`luaK_g‘Ïb–
(
fs
);

1249 
cÚdex™
 = 
	`cÚd
(
ls
);

1250 
	`’‹rblock
(
fs
, &
bl
, 1);

1251 
	`checkÃxt
(
ls
, 
TK_DO
);

1252 
	`block
(
ls
);

1253 
	`luaK_jum±o
(
fs
, 
wheš™
);

1254 
	`check_m©ch
(
ls
, 
TK_END
, 
TK_WHILE
, 
lše
);

1255 
	`Ëaveblock
(
fs
);

1256 
	`luaK_·tchtoh”e
(
fs
, 
cÚdex™
);

1257 
	}
}

1260 
	$»³©¡©
 (
LexS‹
 *
ls
, 
lše
) {

1262 
cÚdex™
;

1263 
FuncS‹
 *
fs
 = 
ls
->fs;

1264 
»³©_š™
 = 
	`luaK_g‘Ïb–
(
fs
);

1265 
BlockCÁ
 
bl1
, 
bl2
;

1266 
	`’‹rblock
(
fs
, &
bl1
, 1);

1267 
	`’‹rblock
(
fs
, &
bl2
, 0);

1268 
	`luaX_Ãxt
(
ls
);

1269 
	`¡©li¡
(
ls
);

1270 
	`check_m©ch
(
ls
, 
TK_UNTIL
, 
TK_REPEAT
, 
lše
);

1271 
cÚdex™
 = 
	`cÚd
(
ls
);

1272 ià(
bl2
.
upv®
)

1273 
	`luaK_·tchşo£
(
fs
, 
cÚdex™
, 
bl2
.
Çùv¬
);

1274 
	`Ëaveblock
(
fs
);

1275 
	`luaK_·tchli¡
(
fs
, 
cÚdex™
, 
»³©_š™
);

1276 
	`Ëaveblock
(
fs
);

1277 
	}
}

1280 
	$exp1
 (
LexS‹
 *
ls
) {

1281 
expdesc
 
e
;

1282 
»g
;

1283 
	`ex´
(
ls
, &
e
);

1284 
	`luaK_exp2ÃxŒeg
(
ls
->
fs
, &
e
);

1285 
	`lua_as£¹
(
e
.
k
 =ğ
VNONRELOC
);

1286 
»g
 = 
e
.
u
.
šfo
;

1287  
»g
;

1288 
	}
}

1291 
	$fÜbody
 (
LexS‹
 *
ls
, 
ba£
, 
lše
, 
nv¬s
, 
i¢um
) {

1293 
BlockCÁ
 
bl
;

1294 
FuncS‹
 *
fs
 = 
ls
->fs;

1295 
´•
, 
’dfÜ
;

1296 
	`adju¡loÿlv¬s
(
ls
, 3);

1297 
	`checkÃxt
(
ls
, 
TK_DO
);

1298 
´•
 = 
i¢um
 ? 
	`luaK_codeAsBx
(
fs
, 
OP_FORPREP
, 
ba£
, 
NO_JUMP
è: 
	`luaK_jump
(fs);

1299 
	`’‹rblock
(
fs
, &
bl
, 0);

1300 
	`adju¡loÿlv¬s
(
ls
, 
nv¬s
);

1301 
	`luaK_»£rv”egs
(
fs
, 
nv¬s
);

1302 
	`block
(
ls
);

1303 
	`Ëaveblock
(
fs
);

1304 
	`luaK_·tchtoh”e
(
fs
, 
´•
);

1305 ià(
i¢um
)

1306 
’dfÜ
 = 
	`luaK_codeAsBx
(
fs
, 
OP_FORLOOP
, 
ba£
, 
NO_JUMP
);

1308 
	`luaK_codeABC
(
fs
, 
OP_TFORCALL
, 
ba£
, 0, 
nv¬s
);

1309 
	`luaK_fixlše
(
fs
, 
lše
);

1310 
’dfÜ
 = 
	`luaK_codeAsBx
(
fs
, 
OP_TFORLOOP
, 
ba£
 + 2, 
NO_JUMP
);

1312 
	`luaK_·tchli¡
(
fs
, 
’dfÜ
, 
´•
 + 1);

1313 
	`luaK_fixlše
(
fs
, 
lše
);

1314 
	}
}

1317 
	$fÜnum
 (
LexS‹
 *
ls
, 
TSŒšg
 *
v¬Çme
, 
lše
) {

1319 
FuncS‹
 *
fs
 = 
ls
->fs;

1320 
ba£
 = 
fs
->
ä“»g
;

1321 
	`Ãw_loÿlv¬l™”®
(
ls
, "(for index)");

1322 
	`Ãw_loÿlv¬l™”®
(
ls
, "(for†imit)");

1323 
	`Ãw_loÿlv¬l™”®
(
ls
, "(for step)");

1324 
	`Ãw_loÿlv¬
(
ls
, 
v¬Çme
);

1325 
	`checkÃxt
(
ls
, '=');

1326 
	`exp1
(
ls
);

1327 
	`checkÃxt
(
ls
, ',');

1328 
	`exp1
(
ls
);

1329 ià(
	`‹¡Ãxt
(
ls
, ','))

1330 
	`exp1
(
ls
);

1332 
	`luaK_codek
(
fs
, fs->
ä“»g
, 
	`luaK_štK
(fs, 1));

1333 
	`luaK_»£rv”egs
(
fs
, 1);

1335 
	`fÜbody
(
ls
, 
ba£
, 
lše
, 1, 1);

1336 
	}
}

1339 
	$fÜli¡
 (
LexS‹
 *
ls
, 
TSŒšg
 *
šdexÇme
) {

1341 
FuncS‹
 *
fs
 = 
ls
->fs;

1342 
expdesc
 
e
;

1343 
nv¬s
 = 4;

1344 
lše
;

1345 
ba£
 = 
fs
->
ä“»g
;

1347 
	`Ãw_loÿlv¬l™”®
(
ls
, "(for generator)");

1348 
	`Ãw_loÿlv¬l™”®
(
ls
, "(for state)");

1349 
	`Ãw_loÿlv¬l™”®
(
ls
, "(for control)");

1351 
	`Ãw_loÿlv¬
(
ls
, 
šdexÇme
);

1352 
	`‹¡Ãxt
(
ls
, ',')) {

1353 
	`Ãw_loÿlv¬
(
ls
, 
	`¡r_checkÇme
(ls));

1354 
nv¬s
++;

1356 
	`checkÃxt
(
ls
, 
TK_IN
);

1357 
lše
 = 
ls
->
lš’umb”
;

1358 
	`adju¡_assign
(
ls
, 3, 
	`ex¶i¡
Ös, &
e
), &e);

1359 
	`luaK_check¡ack
(
fs
, 3);

1360 
	`fÜbody
(
ls
, 
ba£
, 
lše
, 
nv¬s
 - 3, 0);

1361 
	}
}

1364 
	$fÜ¡©
 (
LexS‹
 *
ls
, 
lše
) {

1366 
FuncS‹
 *
fs
 = 
ls
->fs;

1367 
TSŒšg
 *
v¬Çme
;

1368 
BlockCÁ
 
bl
;

1369 
	`’‹rblock
(
fs
, &
bl
, 1);

1370 
	`luaX_Ãxt
(
ls
);

1371 
v¬Çme
 = 
	`¡r_checkÇme
(
ls
);

1372 
ls
->
t
.
tok’
) {

1373 '=': 
	`fÜnum
(
ls
, 
v¬Çme
, 
lše
); ;

1374 ',': 
TK_IN
: 
	`fÜli¡
(
ls
, 
v¬Çme
); ;

1375 : 
	`luaX_syÁax”rÜ
(
ls
, "'=' or 'in'ƒxpected");

1377 
	`check_m©ch
(
ls
, 
TK_END
, 
TK_FOR
, 
lše
);

1378 
	`Ëaveblock
(
fs
);

1379 
	}
}

1382 
	$‹¡_th’_block
 (
LexS‹
 *
ls
, *
esÿ³li¡
) {

1384 
BlockCÁ
 
bl
;

1385 
FuncS‹
 *
fs
 = 
ls
->fs;

1386 
expdesc
 
v
;

1387 
jf
;

1388 
	`luaX_Ãxt
(
ls
);

1389 
	`ex´
(
ls
, &
v
);

1390 
	`checkÃxt
(
ls
, 
TK_THEN
);

1391 ià(
ls
->
t
.
tok’
 =ğ
TK_GOTO
 ||†s->t.tok’ =ğ
TK_BREAK
) {

1392 
	`luaK_goifçl£
(
ls
->
fs
, &
v
);

1393 
	`’‹rblock
(
fs
, &
bl
, 0);

1394 
	`gÙo¡©
(
ls
, 
v
.
t
);

1395 
	`sknoİ¡©
(
ls
);

1396 ià(
	`block_fŞlow
(
ls
, 0)) {

1397 
	`Ëaveblock
(
fs
);

1401 
jf
 = 
	`luaK_jump
(
fs
);

1404 
	`luaK_goiárue
(
ls
->
fs
, &
v
);

1405 
	`’‹rblock
(
fs
, &
bl
, 0);

1406 
jf
 = 
v
.
f
;

1408 
	`¡©li¡
(
ls
);

1409 
	`Ëaveblock
(
fs
);

1410 ià(
ls
->
t
.
tok’
 =ğ
TK_ELSE
 ||

1411 
ls
->
t
.
tok’
 =ğ
TK_ELSEIF
)

1412 
	`luaK_cÚÿt
(
fs
, 
esÿ³li¡
, 
	`luaK_jump
(fs));

1413 
	`luaK_·tchtoh”e
(
fs
, 
jf
);

1414 
	}
}

1417 
	$if¡©
 (
LexS‹
 *
ls
, 
lše
) {

1419 
FuncS‹
 *
fs
 = 
ls
->fs;

1420 
esÿ³li¡
 = 
NO_JUMP
;

1421 
	`‹¡_th’_block
(
ls
, &
esÿ³li¡
);

1422 
ls
->
t
.
tok’
 =ğ
TK_ELSEIF
)

1423 
	`‹¡_th’_block
(
ls
, &
esÿ³li¡
);

1424 ià(
	`‹¡Ãxt
(
ls
, 
TK_ELSE
))

1425 
	`block
(
ls
);

1426 
	`check_m©ch
(
ls
, 
TK_END
, 
TK_IF
, 
lše
);

1427 
	`luaK_·tchtoh”e
(
fs
, 
esÿ³li¡
);

1428 
	}
}

1431 
	$loÿlfunc
 (
LexS‹
 *
ls
) {

1432 
expdesc
 
b
;

1433 
FuncS‹
 *
fs
 = 
ls
->fs;

1434 
	`Ãw_loÿlv¬
(
ls
, 
	`¡r_checkÇme
(ls));

1435 
	`adju¡loÿlv¬s
(
ls
, 1);

1436 
	`body
(
ls
, &
b
, 0,†s->
lš’umb”
);

1438 
	`g‘locv¬
(
fs
, 
b
.
u
.
šfo
)->
¡¬c
 = fs->
pc
;

1439 
	}
}

1442 
	$loÿl¡©
 (
LexS‹
 *
ls
) {

1444 
nv¬s
 = 0;

1445 
Ãxps
;

1446 
expdesc
 
e
;

1448 
	`Ãw_loÿlv¬
(
ls
, 
	`¡r_checkÇme
(ls));

1449 
nv¬s
++;

1450 } 
	`‹¡Ãxt
(
ls
, ','));

1451 ià(
	`‹¡Ãxt
(
ls
, '='))

1452 
Ãxps
 = 
	`ex¶i¡
(
ls
, &
e
);

1454 
e
.
k
 = 
VVOID
;

1455 
Ãxps
 = 0;

1457 
	`adju¡_assign
(
ls
, 
nv¬s
, 
Ãxps
, &
e
);

1458 
	`adju¡loÿlv¬s
(
ls
, 
nv¬s
);

1459 
	}
}

1462 
	$funúame
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

1464 
ism‘hod
 = 0;

1465 
	`sšgËv¬
(
ls
, 
v
);

1466 
ls
->
t
.
tok’
 == '.')

1467 
	`f›ld£l
(
ls
, 
v
);

1468 ià(
ls
->
t
.
tok’
 == ':') {

1469 
ism‘hod
 = 1;

1470 
	`f›ld£l
(
ls
, 
v
);

1472  
ism‘hod
;

1473 
	}
}

1476 
	$func¡©
 (
LexS‹
 *
ls
, 
lše
) {

1478 
ism‘hod
;

1479 
expdesc
 
v
, 
b
;

1480 
	`luaX_Ãxt
(
ls
);

1481 
ism‘hod
 = 
	`funúame
(
ls
, &
v
);

1482 
	`body
(
ls
, &
b
, 
ism‘hod
, 
lše
);

1483 
	`luaK_¡Üev¬
(
ls
->
fs
, &
v
, &
b
);

1484 
	`luaK_fixlše
(
ls
->
fs
, 
lše
);

1485 
	}
}

1488 
	$ex´¡©
 (
LexS‹
 *
ls
) {

1490 
FuncS‹
 *
fs
 = 
ls
->fs;

1491 
LHS_assign
 
v
;

1492 
	`suffixedexp
(
ls
, &
v
.v);

1493 ià(
ls
->
t
.
tok’
 == '=' ||†s->t.token == ',') {

1494 
v
.
´ev
 = 
NULL
;

1495 
	`assignm’t
(
ls
, &
v
, 1);

1498 
	`check_cÚd™iÚ
(
ls
, 
v
.v.
k
 =ğ
VCALL
, "syntaxƒrror");

1499 
	`SETARG_C
(
	`g‘š¡ruùiÚ
(
fs
, &
v
.v), 1);

1501 
	}
}

1504 
	$»t¡©
 (
LexS‹
 *
ls
) {

1506 
FuncS‹
 *
fs
 = 
ls
->fs;

1507 
expdesc
 
e
;

1508 
fœ¡
, 
Ä‘
;

1509 ià(
	`block_fŞlow
(
ls
, 1è||†s->
t
.
tok’
 == ';')

1510 
fœ¡
 = 
Ä‘
 = 0;

1512 
Ä‘
 = 
	`ex¶i¡
(
ls
, &
e
);

1513 ià(
	`hasmuÉ»t
(
e
.
k
)) {

1514 
	`luaK_£tmuÉ»t
(
fs
, &
e
);

1515 ià(
e
.
k
 =ğ
VCALL
 && 
Ä‘
 == 1) {

1516 
	`SET_OPCODE
(
	`g‘š¡ruùiÚ
(
fs
,&
e
), 
OP_TAILCALL
);

1517 
	`lua_as£¹
(
	`GETARG_A
(
	`g‘š¡ruùiÚ
(
fs
,&
e
)è=ğfs->
Çùv¬
);

1519 
fœ¡
 = 
fs
->
Çùv¬
;

1520 
Ä‘
 = 
LUA_MULTRET
;

1523 ià(
Ä‘
 == 1)

1524 
fœ¡
 = 
	`luaK_exp2ªy»g
(
fs
, &
e
);

1526 
	`luaK_exp2ÃxŒeg
(
fs
, &
e
);

1527 
fœ¡
 = 
fs
->
Çùv¬
;

1528 
	`lua_as£¹
(
Ä‘
 =ğ
fs
->
ä“»g
 - 
fœ¡
);

1532 
	`luaK_»t
(
fs
, 
fœ¡
, 
Ä‘
);

1533 
	`‹¡Ãxt
(
ls
, ';');

1534 
	}
}

1537 
	$¡©em’t
 (
LexS‹
 *
ls
) {

1538 
lše
 = 
ls
->
lš’umb”
;

1539 
	`’‹¾ev–
(
ls
);

1540 
ls
->
t
.
tok’
) {

1542 
	`luaX_Ãxt
(
ls
);

1545 
TK_IF
: {

1546 
	`if¡©
(
ls
, 
lše
);

1549 
TK_WHILE
: {

1550 
	`whe¡©
(
ls
, 
lše
);

1553 
TK_DO
: {

1554 
	`luaX_Ãxt
(
ls
);

1555 
	`block
(
ls
);

1556 
	`check_m©ch
(
ls
, 
TK_END
, 
TK_DO
, 
lše
);

1559 
TK_FOR
: {

1560 
	`fÜ¡©
(
ls
, 
lše
);

1563 
TK_REPEAT
: {

1564 
	`»³©¡©
(
ls
, 
lše
);

1567 
TK_FUNCTION
: {

1568 
	`func¡©
(
ls
, 
lše
);

1571 
TK_LOCAL
: {

1572 
	`luaX_Ãxt
(
ls
);

1573 ià(
	`‹¡Ãxt
(
ls
, 
TK_FUNCTION
))

1574 
	`loÿlfunc
(
ls
);

1576 
	`loÿl¡©
(
ls
);

1579 
TK_DBCOLON
: {

1580 
	`luaX_Ãxt
(
ls
);

1581 
	`Ïb–¡©
(
ls
, 
	`¡r_checkÇme
Ös), 
lše
);

1584 
TK_RETURN
: {

1585 
	`luaX_Ãxt
(
ls
);

1586 
	`»t¡©
(
ls
);

1589 
TK_BREAK
:

1590 
TK_GOTO
: {

1591 
	`gÙo¡©
(
ls
, 
	`luaK_jump
Ös->
fs
));

1595 
	`ex´¡©
(
ls
);

1599 
	`lua_as£¹
(
ls
->
fs
->
f
->
max¡acksize
 >ğls->fs->
ä“»g
 &&

1600 
ls
->
fs
->
ä“»g
 >ğls->fs->
Çùv¬
);

1601 
ls
->
fs
->
ä“»g
 =†s->fs->
Çùv¬
;

1602 
	`Ëav–ev–
(
ls
);

1603 
	}
}

1612 
	$mašfunc
 (
LexS‹
 *
ls
, 
FuncS‹
 *
fs
) {

1613 
BlockCÁ
 
bl
;

1614 
expdesc
 
v
;

1615 
	`İ’_func
(
ls
, 
fs
, &
bl
);

1616 
fs
->
f
->
is_v¬¬g
 = 1;

1617 
	`š™_exp
(&
v
, 
VLOCAL
, 0);

1618 
	`Ãwupv®ue
(
fs
, 
ls
->
’vn
, &
v
);

1619 
	`luaX_Ãxt
(
ls
);

1620 
	`¡©li¡
(
ls
);

1621 
	`check
(
ls
, 
TK_EOS
);

1622 
	`şo£_func
(
ls
);

1623 
	}
}

1626 
LClosu»
 *
	$luaY_·r£r
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, 
Mbufãr
 *
buff
,

1627 
Dynd©a
 *
dyd
, cÚ¡ *
Çme
, 
fœ¡ch¬
) {

1628 
LexS‹
 
Ëx¡©e
;

1629 
FuncS‹
 
func¡©e
;

1630 
LClosu»
 *
ş
 = 
	`luaF_ÃwLşosu»
(
L
, 1);

1631 
	`£tşLv®ue
(
L
, L->
tİ
, 
ş
);

1632 
	`luaD_šùİ
(
L
);

1633 
Ëx¡©e
.
h
 = 
	`luaH_Ãw
(
L
);

1634 
	`£thv®ue
(
L
, L->
tİ
, 
Ëx¡©e
.
h
);

1635 
	`luaD_šùİ
(
L
);

1636 
func¡©e
.
f
 = 
ş
->
p
 = 
	`luaF_Ãw´Ùo
(
L
);

1637 
func¡©e
.
f
->
sourû
 = 
	`luaS_Ãw
(
L
, 
Çme
);

1638 
	`lua_as£¹
(
	`iswh™e
(
func¡©e
.
f
));

1639 
Ëx¡©e
.
buff
 = buff;

1640 
Ëx¡©e
.
dyd
 = dyd;

1641 
dyd
->
aùv¬
.
n
 = dyd->
gt
.Àğdyd->
Ïb–
.n = 0;

1642 
	`luaX_£tšput
(
L
, &
Ëx¡©e
, 
z
, 
func¡©e
.
f
->
sourû
, 
fœ¡ch¬
);

1643 
	`mašfunc
(&
Ëx¡©e
, &
func¡©e
);

1644 
	`lua_as£¹
(!
func¡©e
.
´ev
 && func¡©e.
nups
 =ğ1 && !
Ëx¡©e
.
fs
);

1646 
	`lua_as£¹
(
dyd
->
aùv¬
.
n
 =ğ0 && dyd->
gt
.À=ğ0 && dyd->
Ïb–
.n == 0);

1647 
L
->
tİ
--;

1648  
ş
;

1649 
	}
}

	@script/lua/lua-5.3.4/src/lparser.h

7 #iâdeà
Í¬£r_h


8 
	#Í¬£r_h


	)

10 
	~"Îim™s.h
"

11 
	~"lobjeù.h
"

12 
	~"lzio.h
"

26 
	mVVOID
,

28 
	mVNIL
,

29 
	mVTRUE
,

30 
	mVFALSE
,

31 
	mVK
,

32 
	mVKFLT
,

33 
	mVKINT
,

34 
	mVNONRELOC
,

36 
	mVLOCAL
,

37 
	mVUPVAL
,

38 
	mVINDEXED
,

42 
	mVJMP
,

44 
	mVRELOCABLE
,

46 
	mVCALL
,

47 
	mVVARARG


48 } 
	texpkšd
;

51 
	#vkisv¬
(
k
è(
VLOCAL
 <ğ(kè&& (kè<ğ
VINDEXED
)

	)

52 
	#vkisš»g
(
k
è((kè=ğ
VNONRELOC
 || (kè=ğ
VLOCAL
)

	)

54 
	sexpdesc
 {

55 
expkšd
 
	mk
;

57 
lua_IÁeg”
 
	miv®
;

58 
lua_Numb”
 
	mnv®
;

59 
	mšfo
;

61 
	midx
;

62 
lu_by‹
 
	mt
;

63 
lu_by‹
 
	mvt
;

64 } 
	mšd
;

65 } 
	mu
;

66 
	mt
;

67 
	mf
;

68 } 
	texpdesc
;

72 
	sV¬desc
 {

73 
	midx
;

74 } 
	tV¬desc
;

78 
	sLab–desc
 {

79 
TSŒšg
 *
	mÇme
;

80 
	mpc
;

81 
	mlše
;

82 
lu_by‹
 
	mÇùv¬
;

83 } 
	tLab–desc
;

87 
	sLab–li¡
 {

88 
Lab–desc
 *
	m¬r
;

89 
	mn
;

90 
	msize
;

91 } 
	tLab–li¡
;

95 
	sDynd©a
 {

97 
V¬desc
 *
	m¬r
;

98 
	mn
;

99 
	msize
;

100 } 
	maùv¬
;

101 
Lab–li¡
 
	mgt
;

102 
Lab–li¡
 
	mÏb–
;

103 } 
	tDynd©a
;

107 
	gBlockCÁ
;

111 
	sFuncS‹
 {

112 
PrÙo
 *
	mf
;

113 
FuncS‹
 *
	m´ev
;

114 
LexS‹
 *
	mls
;

115 
BlockCÁ
 *
	mbl
;

116 
	mpc
;

117 
	mÏ¡rg‘
;

118 
	mjpc
;

119 
	mnk
;

120 
	mÅ
;

121 
	mfœ¡loÿl
;

122 
	mÆocv¬s
;

123 
lu_by‹
 
	mÇùv¬
;

124 
lu_by‹
 
	mnups
;

125 
lu_by‹
 
	mä“»g
;

126 } 
	tFuncS‹
;

129 
LUAI_FUNC
 
LClosu»
 *
luaY_·r£r
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, 
Mbufãr
 *
buff
,

130 
Dynd©a
 *
dyd
, cÚ¡ *
Çme
, 
fœ¡ch¬
);

	@script/lua/lua-5.3.4/src/lprefix.h

7 #iâdeà
Í»fix_h


8 
	#Í»fix_h


	)

14 #ià!
defšed
(
LUA_USE_C89
)

16 #ià!
defšed
(
_XOPEN_SOURCE
)

17 
	#_XOPEN_SOURCE
 600

	)

18 #–ià
_XOPEN_SOURCE
 == 0

19 #undeà
_XOPEN_SOURCE


25 #ià!
defšed
(
LUA_32BITS
è&& !defšed(
_FILE_OFFSET_BITS
)

26 
	#_LARGEFILE_SOURCE
 1

	)

27 
	#_FILE_OFFSET_BITS
 64

	)

36 #ià
defšed
(
_WIN32
)

38 #ià!
defšed
(
_CRT_SECURE_NO_WARNINGS
)

39 
	#_CRT_SECURE_NO_WARNINGS


	)

	@script/lua/lua-5.3.4/src/lstate.c

7 
	#l¡©e_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ddef.h
>

14 
	~<¡ršg.h
>

16 
	~"lua.h
"

18 
	~"Ïpi.h
"

19 
	~"ldebug.h
"

20 
	~"ldo.h
"

21 
	~"lfunc.h
"

22 
	~"lgc.h
"

23 
	~"Îex.h
"

24 
	~"lmem.h
"

25 
	~"l¡©e.h
"

26 
	~"l¡ršg.h
"

27 
	~"ÉabË.h
"

28 
	~"Ém.h
"

31 #ià!
defšed
(
LUAI_GCPAUSE
)

32 
	#LUAI_GCPAUSE
 200

	)

35 #ià!
defšed
(
LUAI_GCMUL
)

36 
	#LUAI_GCMUL
 200

	)

44 #ià!
defšed
(
luai_make£ed
)

45 
	~<time.h
>

46 
	#luai_make£ed
(è
	`ÿ¡
(, 
	`time
(
NULL
))

	)

54 
	sLX
 {

55 
lu_by‹
 
	mexŒa_
[
LUA_EXTRASPACE
];

56 
lua_S‹
 
	ml
;

57 } 
	tLX
;

63 
	sLG
 {

64 
LX
 
	ml
;

65 
glob®_S‹
 
	mg
;

66 } 
	tLG
;

70 
	#äom¡©e
(
L
è(
	`ÿ¡
(
LX
 *, ca¡(
lu_by‹
 *, (L)è- 
	`off£tof
(LX, 
l
)))

	)

77 
	#addbuff
(
b
,
p
,
e
) \

78 { 
size_t
 
t
 = 
	`ÿ¡
(size_t, 
e
); \

79 
	`memıy
(
b
 + 
p
, &
t
, Ñ));… +ğÑ); }

	)

81 
	$make£ed
 (
lua_S‹
 *
L
) {

82 
buff
[4 * (
size_t
)];

83 
h
 = 
	`luai_make£ed
();

84 
p
 = 0;

85 
	`addbuff
(
buff
, 
p
, 
L
);

86 
	`addbuff
(
buff
, 
p
, &
h
);

87 
	`addbuff
(
buff
, 
p
, 
luaO_nobjeù
);

88 
	`addbuff
(
buff
, 
p
, &
lua_Ãw¡©e
);

89 
	`lua_as£¹
(
p
 =ğ(
buff
));

90  
	`luaS_hash
(
buff
, 
p
, 
h
);

91 
	}
}

98 
	$luaE_£tdebt
 (
glob®_S‹
 *
g
, 
l_mem
 
debt
) {

99 
l_mem
 
tb
 = 
	`g‘tÙ®by‹s
(
g
);

100 
	`lua_as£¹
(
tb
 > 0);

101 ià(
debt
 < 
tb
 - 
MAX_LMEM
)

102 
debt
 = 
tb
 - 
MAX_LMEM
;

103 
g
->
tÙ®by‹s
 = 
tb
 - 
debt
;

104 
g
->
GCdebt
 = 
debt
;

105 
	}
}

108 
C®lInfo
 *
	$luaE_ex‹ndCI
 (
lua_S‹
 *
L
) {

109 
C®lInfo
 *
ci
 = 
	`luaM_Ãw
(
L
, CallInfo);

110 
	`lua_as£¹
(
L
->
ci
->
Ãxt
 =ğ
NULL
);

111 
L
->
ci
->
Ãxt
 = ci;

112 
ci
->
´evious
 = 
L
->ci;

113 
ci
->
Ãxt
 = 
NULL
;

114 
L
->
nci
++;

115  
ci
;

116 
	}
}

122 
	$luaE_ä“CI
 (
lua_S‹
 *
L
) {

123 
C®lInfo
 *
ci
 = 
L
->ci;

124 
C®lInfo
 *
Ãxt
 = 
ci
->next;

125 
ci
->
Ãxt
 = 
NULL
;

126 (
ci
 = 
Ãxt
è!ğ
NULL
) {

127 
Ãxt
 = 
ci
->next;

128 
	`luaM_ä“
(
L
, 
ci
);

129 
L
->
nci
--;

131 
	}
}

137 
	$luaE_shrškCI
 (
lua_S‹
 *
L
) {

138 
C®lInfo
 *
ci
 = 
L
->ci;

139 
C®lInfo
 *
Ãxt2
;

141 
ci
->
Ãxt
 !ğ
NULL
 && (
Ãxt2
 = ci->next->next) != NULL) {

142 
	`luaM_ä“
(
L
, 
ci
->
Ãxt
);

143 
L
->
nci
--;

144 
ci
->
Ãxt
 = 
Ãxt2
;

145 
Ãxt2
->
´evious
 = 
ci
;

146 
ci
 = 
Ãxt2
;

148 
	}
}

151 
	$¡ack_š™
 (
lua_S‹
 *
L1
,†ua_S‹ *
L
) {

152 
i
; 
C®lInfo
 *
ci
;

154 
L1
->
¡ack
 = 
	`luaM_ÃwveùÜ
(
L
, 
BASIC_STACK_SIZE
, 
TV®ue
);

155 
L1
->
¡acksize
 = 
BASIC_STACK_SIZE
;

156 
i
 = 0; i < 
BASIC_STACK_SIZE
; i++)

157 
	`£Šv®ue
(
L1
->
¡ack
 + 
i
);

158 
L1
->
tİ
 = L1->
¡ack
;

159 
L1
->
¡ack_Ï¡
 = L1->
¡ack
 + L1->
¡acksize
 - 
EXTRA_STACK
;

161 
ci
 = &
L1
->
ba£_ci
;

162 
ci
->
Ãxt
 = ci->
´evious
 = 
NULL
;

163 
ci
->
ÿÎ¡©us
 = 0;

164 
ci
->
func
 = 
L1
->
tİ
;

165 
	`£Šv®ue
(
L1
->
tİ
++);

166 
ci
->
tİ
 = 
L1
->tİ + 
LUA_MINSTACK
;

167 
L1
->
ci
 = ci;

168 
	}
}

171 
	$ä“¡ack
 (
lua_S‹
 *
L
) {

172 ià(
L
->
¡ack
 =ğ
NULL
)

174 
L
->
ci
 = &L->
ba£_ci
;

175 
	`luaE_ä“CI
(
L
);

176 
	`lua_as£¹
(
L
->
nci
 == 0);

177 
	`luaM_ä“¬¿y
(
L
, L->
¡ack
, L->
¡acksize
);

178 
	}
}

184 
	$š™_»gi¡ry
 (
lua_S‹
 *
L
, 
glob®_S‹
 *
g
) {

185 
TV®ue
 
‹mp
;

187 
TabË
 *
»gi¡ry
 = 
	`luaH_Ãw
(
L
);

188 
	`£thv®ue
(
L
, &
g
->
l_»gi¡ry
, 
»gi¡ry
);

189 
	`luaH_»size
(
L
, 
»gi¡ry
, 
LUA_RIDX_LAST
, 0);

191 
	`£‰hv®ue
(
L
, &
‹mp
, L);

192 
	`luaH_£tšt
(
L
, 
»gi¡ry
, 
LUA_RIDX_MAINTHREAD
, &
‹mp
);

194 
	`£thv®ue
(
L
, &
‹mp
, 
	`luaH_Ãw
(L));

195 
	`luaH_£tšt
(
L
, 
»gi¡ry
, 
LUA_RIDX_GLOBALS
, &
‹mp
);

196 
	}
}

203 
	$f_luaİ’
 (
lua_S‹
 *
L
, *
ud
) {

204 
glob®_S‹
 *
g
 = 
	`G
(
L
);

205 
	`UNUSED
(
ud
);

206 
	`¡ack_š™
(
L
, L);

207 
	`š™_»gi¡ry
(
L
, 
g
);

208 
	`luaS_š™
(
L
);

209 
	`luaT_š™
(
L
);

210 
	`luaX_š™
(
L
);

211 
g
->
güuÂšg
 = 1;

212 
g
->
v”siÚ
 = 
	`lua_v”siÚ
(
NULL
);

213 
	`luai_u£r¡©eİ’
(
L
);

214 
	}
}

221 
	$´eš™_th»ad
 (
lua_S‹
 *
L
, 
glob®_S‹
 *
g
) {

222 
	`G
(
L
èğ
g
;

223 
L
->
¡ack
 = 
NULL
;

224 
L
->
ci
 = 
NULL
;

225 
L
->
nci
 = 0;

226 
L
->
¡acksize
 = 0;

227 
L
->
twups
 = L;

228 
L
->
”rÜJmp
 = 
NULL
;

229 
L
->
nCÿÎs
 = 0;

230 
L
->
hook
 = 
NULL
;

231 
L
->
hookmask
 = 0;

232 
L
->
ba£hookcouÁ
 = 0;

233 
L
->
®lowhook
 = 1;

234 
	`»£thookcouÁ
(
L
);

235 
L
->
İ’upv®
 = 
NULL
;

236 
L
->
Ây
 = 1;

237 
L
->
¡©us
 = 
LUA_OK
;

238 
L
->
”rfunc
 = 0;

239 
	}
}

242 
	$şo£_¡©e
 (
lua_S‹
 *
L
) {

243 
glob®_S‹
 *
g
 = 
	`G
(
L
);

244 
	`luaF_şo£
(
L
, L->
¡ack
);

245 
	`luaC_ä“®lobjeùs
(
L
);

246 ià(
g
->
v”siÚ
)

247 
	`luai_u£r¡©eşo£
(
L
);

248 
	`luaM_ä“¬¿y
(
L
, 
	`G
(L)->
¡¹
.
hash
, G(L)->¡¹.
size
);

249 
	`ä“¡ack
(
L
);

250 
	`lua_as£¹
(
	`g‘tÙ®by‹s
(
g
è=ğ(
LG
));

251 (*
g
->
ä—Îoc
)(g->
ud
, 
	`äom¡©e
(
L
), (
LG
), 0);

252 
	}
}

255 
LUA_API
 
lua_S‹
 *
	$lua_Ãwth»ad
 (
lua_S‹
 *
L
) {

256 
glob®_S‹
 *
g
 = 
	`G
(
L
);

257 
lua_S‹
 *
L1
;

258 
	`lua_lock
(
L
);

259 
	`luaC_checkGC
(
L
);

261 
L1
 = &
	`ÿ¡
(
LX
 *, 
	`luaM_Ãwobjeù
(
L
, 
LUA_TTHREAD
, (LX)))->
l
;

262 
L1
->
m¬ked
 = 
	`luaC_wh™e
(
g
);

263 
L1
->
‰
 = 
LUA_TTHREAD
;

265 
L1
->
Ãxt
 = 
g
->
®lgc
;

266 
g
->
®lgc
 = 
	`obj2gco
(
L1
);

268 
	`£‰hv®ue
(
L
, L->
tİ
, 
L1
);

269 
	`­i_šü_tİ
(
L
);

270 
	`´eš™_th»ad
(
L1
, 
g
);

271 
L1
->
hookmask
 = 
L
->hookmask;

272 
L1
->
ba£hookcouÁ
 = 
L
->basehookcount;

273 
L1
->
hook
 = 
L
->hook;

274 
	`»£thookcouÁ
(
L1
);

276 
	`memıy
(
	`lua_g‘exŒa¥aû
(
L1
),†ua_g‘exŒa¥aû(
g
->
mašth»ad
),

277 
LUA_EXTRASPACE
);

278 
	`luai_u£r¡©‘h»ad
(
L
, 
L1
);

279 
	`¡ack_š™
(
L1
, 
L
);

280 
	`lua_uÆock
(
L
);

281  
L1
;

282 
	}
}

285 
	$luaE_ä“th»ad
 (
lua_S‹
 *
L
,†ua_S‹ *
L1
) {

286 
LX
 *
l
 = 
	`äom¡©e
(
L1
);

287 
	`luaF_şo£
(
L1
, L1->
¡ack
);

288 
	`lua_as£¹
(
L1
->
İ’upv®
 =ğ
NULL
);

289 
	`luai_u£r¡©eä“
(
L
, 
L1
);

290 
	`ä“¡ack
(
L1
);

291 
	`luaM_ä“
(
L
, 
l
);

292 
	}
}

295 
LUA_API
 
lua_S‹
 *
	$lua_Ãw¡©e
 (
lua_AÎoc
 
f
, *
ud
) {

296 
i
;

297 
lua_S‹
 *
L
;

298 
glob®_S‹
 *
g
;

299 
LG
 *
l
 = 
	`ÿ¡
(LG *, (*
f
)(
ud
, 
NULL
, 
LUA_TTHREAD
, (LG)));

300 ià(
l
 =ğ
NULL
)  NULL;

301 
L
 = &
l
->l.l;

302 
g
 = &
l
->g;

303 
L
->
Ãxt
 = 
NULL
;

304 
L
->
‰
 = 
LUA_TTHREAD
;

305 
g
->
cu¼’twh™e
 = 
	`b™mask
(
WHITE0BIT
);

306 
L
->
m¬ked
 = 
	`luaC_wh™e
(
g
);

307 
	`´eš™_th»ad
(
L
, 
g
);

308 
g
->
ä—Îoc
 = 
f
;

309 
g
->
ud
 = ud;

310 
g
->
mašth»ad
 = 
L
;

311 
g
->
£ed
 = 
	`make£ed
(
L
);

312 
g
->
güuÂšg
 = 0;

313 
g
->
GCe¡im©e
 = 0;

314 
g
->
¡¹
.
size
 = g->¡¹.
nu£
 = 0;

315 
g
->
¡¹
.
hash
 = 
NULL
;

316 
	`£Šv®ue
(&
g
->
l_»gi¡ry
);

317 
g
->
·nic
 = 
NULL
;

318 
g
->
v”siÚ
 = 
NULL
;

319 
g
->
gc¡©e
 = 
GCS·u£
;

320 
g
->
gckšd
 = 
KGC_NORMAL
;

321 
g
->
®lgc
 = g->
fšobj
 = g->
tobeâz
 = g->
fixedgc
 = 
NULL
;

322 
g
->
sw“pgc
 = 
NULL
;

323 
g
->
g¿y
 = g->
g¿yagaš
 = 
NULL
;

324 
g
->
w—k
 = g->
•hem”Ú
 = g->
®lw—k
 = 
NULL
;

325 
g
->
twups
 = 
NULL
;

326 
g
->
tÙ®by‹s
 = (
LG
);

327 
g
->
GCdebt
 = 0;

328 
g
->
gcfšnum
 = 0;

329 
g
->
gıau£
 = 
LUAI_GCPAUSE
;

330 
g
->
gc¡•mul
 = 
LUAI_GCMUL
;

331 
i
=0; i < 
LUA_NUMTAGS
; i++è
g
->
mt
[i] = 
NULL
;

332 ià(
	`luaD_¿wruÅrÙeùed
(
L
, 
f_luaİ’
, 
NULL
è!ğ
LUA_OK
) {

334 
	`şo£_¡©e
(
L
);

335 
L
 = 
NULL
;

337  
L
;

338 
	}
}

341 
LUA_API
 
	$lua_şo£
 (
lua_S‹
 *
L
) {

342 
L
 = 
	`G
(L)->
mašth»ad
;

343 
	`lua_lock
(
L
);

344 
	`şo£_¡©e
(
L
);

345 
	}
}

	@script/lua/lua-5.3.4/src/lstate.h

7 #iâdeà
l¡©e_h


8 
	#l¡©e_h


	)

10 
	~"lua.h
"

12 
	~"lobjeù.h
"

13 
	~"Ém.h
"

14 
	~"lzio.h
"

33 
	glua_lÚgjmp
;

40 #ià!
defšed
(
l_sigÇlT
)

41 
	~<sigÇl.h
>

42 
	#l_sigÇlT
 
sig_©omic_t


	)

47 
	#EXTRA_STACK
 5

	)

50 
	#BASIC_STACK_SIZE
 (2*
LUA_MINSTACK
)

	)

54 
	#KGC_NORMAL
 0

	)

55 
	#KGC_EMERGENCY
 1

	)

58 
	s¡ršgbË
 {

59 
TSŒšg
 **
	mhash
;

60 
	mnu£
;

61 
	msize
;

62 } 
	t¡ršgbË
;

74 
	sC®lInfo
 {

75 
StkId
 
	mfunc
;

76 
StkId
 
	mtİ
;

77 
C®lInfo
 *
	m´evious
, *
	mÃxt
;

80 
StkId
 
	mba£
;

81 cÚ¡ 
In¡ruùiÚ
 *
	m§vedpc
;

82 } 
	ml
;

84 
lua_KFunùiÚ
 
	mk
;

85 
±rdiff_t
 
	mŞd_”rfunc
;

86 
lua_KCÚ‹xt
 
	mùx
;

87 } 
	mc
;

88 } 
	mu
;

89 
±rdiff_t
 
	mexŒa
;

90 
	mÄesuÉs
;

91 
	mÿÎ¡©us
;

92 } 
	tC®lInfo
;

98 
	#CIST_OAH
 (1<<0è

	)

99 
	#CIST_LUA
 (1<<1è

	)

100 
	#CIST_HOOKED
 (1<<2è

	)

101 
	#CIST_FRESH
 (1<<3è

	)

103 
	#CIST_YPCALL
 (1<<4è

	)

104 
	#CIST_TAIL
 (1<<5è

	)

105 
	#CIST_HOOKYIELD
 (1<<6è

	)

106 
	#CIST_LEQ
 (1<<7è

	)

107 
	#CIST_FIN
 (1<<8è

	)

109 
	#isLua
(
ci
è((ci)->
ÿÎ¡©us
 & 
CIST_LUA
)

	)

112 
	#£tßh
(
¡
,
v
è((¡èğ((¡è& ~
CIST_OAH
è| (v))

	)

113 
	#g‘ßh
(
¡
è((¡è& 
CIST_OAH
)

	)

119 
	sglob®_S‹
 {

120 
lua_AÎoc
 
	mä—Îoc
;

121 *
	mud
;

122 
l_mem
 
	mtÙ®by‹s
;

123 
l_mem
 
	mGCdebt
;

124 
lu_mem
 
	mGCmemŒav
;

125 
lu_mem
 
	mGCe¡im©e
;

126 
¡ršgbË
 
	m¡¹
;

127 
TV®ue
 
	ml_»gi¡ry
;

128 
	m£ed
;

129 
lu_by‹
 
	mcu¼’twh™e
;

130 
lu_by‹
 
	mgc¡©e
;

131 
lu_by‹
 
	mgckšd
;

132 
lu_by‹
 
	mgüuÂšg
;

133 
GCObjeù
 *
	m®lgc
;

134 
GCObjeù
 **
	msw“pgc
;

135 
GCObjeù
 *
	mfšobj
;

136 
GCObjeù
 *
	mg¿y
;

137 
GCObjeù
 *
	mg¿yagaš
;

138 
GCObjeù
 *
	mw—k
;

139 
GCObjeù
 *
	m•hem”Ú
;

140 
GCObjeù
 *
	m®lw—k
;

141 
GCObjeù
 *
	mtobeâz
;

142 
GCObjeù
 *
	mfixedgc
;

143 
lua_S‹
 *
	mtwups
;

144 
	mgcfšnum
;

145 
	mgıau£
;

146 
	mgc¡•mul
;

147 
lua_CFunùiÚ
 
	m·nic
;

148 
lua_S‹
 *
	mmašth»ad
;

149 cÚ¡ 
lua_Numb”
 *
	mv”siÚ
;

150 
TSŒšg
 *
	mmem”rmsg
;

151 
TSŒšg
 *
	mtmÇme
[
TM_N
];

152 
TabË
 *
	mmt
[
LUA_NUMTAGS
];

153 
TSŒšg
 *
	m¡rÿche
[
STRCACHE_N
][
STRCACHE_M
];

154 } 
	tglob®_S‹
;

160 
	slua_S‹
 {

161 
	mCommÚH—d”
;

162 
	mnci
;

163 
lu_by‹
 
	m¡©us
;

164 
StkId
 
	mtİ
;

165 
glob®_S‹
 *
	ml_G
;

166 
C®lInfo
 *
	mci
;

167 cÚ¡ 
In¡ruùiÚ
 *
	mŞdpc
;

168 
StkId
 
	m¡ack_Ï¡
;

169 
StkId
 
	m¡ack
;

170 
UpV®
 *
	mİ’upv®
;

171 
GCObjeù
 *
	mgşi¡
;

172 
lua_S‹
 *
	mtwups
;

173 
lua_lÚgjmp
 *
	m”rÜJmp
;

174 
C®lInfo
 
	mba£_ci
;

175 vŞ©
lua_Hook
 
	mhook
;

176 
±rdiff_t
 
	m”rfunc
;

177 
	m¡acksize
;

178 
	mba£hookcouÁ
;

179 
	mhookcouÁ
;

180 
	mÂy
;

181 
	mnCÿÎs
;

182 
l_sigÇlT
 
	mhookmask
;

183 
lu_by‹
 
	m®lowhook
;

187 
	#G
(
L
è(L->
l_G
)

	)

193 
	uGCUniÚ
 {

194 
GCObjeù
 
	mgc
;

195 
TSŒšg
 
	mts
;

196 
Ud©a
 
	mu
;

197 
Closu»
 
	mş
;

198 
TabË
 
	mh
;

199 
PrÙo
 
	mp
;

200 
lua_S‹
 
	mth
;

204 
	#ÿ¡_u
(
o
è
	`ÿ¡
(
GCUniÚ
 *, (o))

	)

207 
	#gco2ts
(
o
) \

208 
	`check_exp
(
	`nov¬ŸÁ
((
o
)->
‰
è=ğ
LUA_TSTRING
, &((
	`ÿ¡_u
(o))->
ts
))

	)

209 
	#gco2u
(
o
è
	`check_exp
((o)->
‰
 =ğ
LUA_TUSERDATA
, &((
	`ÿ¡_u
(o))->
u
))

	)

210 
	#gco2lş
(
o
è
	`check_exp
((o)->
‰
 =ğ
LUA_TLCL
, &((
	`ÿ¡_u
(o))->
ş
.
l
))

	)

211 
	#gco2cş
(
o
è
	`check_exp
((o)->
‰
 =ğ
LUA_TCCL
, &((
	`ÿ¡_u
(o))->
ş
.
c
))

	)

212 
	#gco2ş
(
o
) \

213 
	`check_exp
(
	`nov¬ŸÁ
((
o
)->
‰
è=ğ
LUA_TFUNCTION
, &((
	`ÿ¡_u
(o))->
ş
))

	)

214 
	#gco2t
(
o
è
	`check_exp
((o)->
‰
 =ğ
LUA_TTABLE
, &((
	`ÿ¡_u
(o))->
h
))

	)

215 
	#gco2p
(
o
è
	`check_exp
((o)->
‰
 =ğ
LUA_TPROTO
, &((
	`ÿ¡_u
(o))->
p
))

	)

216 
	#gco2th
(
o
è
	`check_exp
((o)->
‰
 =ğ
LUA_TTHREAD
, &((
	`ÿ¡_u
(o))->
th
))

	)

220 
	#obj2gco
(
v
) \

221 
	`check_exp
(
	`nov¬ŸÁ
((
v
)->
‰
è< 
LUA_TDEADKEY
, (&(
	`ÿ¡_u
(v)->
gc
)))

	)

225 
	#g‘tÙ®by‹s
(
g
è
	`ÿ¡
(
lu_mem
, (g)->
tÙ®by‹s
 + (g)->
GCdebt
)

	)

227 
LUAI_FUNC
 
luaE_£tdebt
 (
glob®_S‹
 *
g
, 
l_mem
 
debt
);

228 
LUAI_FUNC
 
luaE_ä“th»ad
 (
lua_S‹
 *
L
,†ua_S‹ *
L1
);

229 
LUAI_FUNC
 
C®lInfo
 *
luaE_ex‹ndCI
 (
lua_S‹
 *
L
);

230 
LUAI_FUNC
 
luaE_ä“CI
 (
lua_S‹
 *
L
);

231 
LUAI_FUNC
 
luaE_shrškCI
 (
lua_S‹
 *
L
);

	@script/lua/lua-5.3.4/src/lstring.c

7 
	#l¡ršg_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ršg.h
>

15 
	~"lua.h
"

17 
	~"ldebug.h
"

18 
	~"ldo.h
"

19 
	~"lmem.h
"

20 
	~"lobjeù.h
"

21 
	~"l¡©e.h
"

22 
	~"l¡ršg.h
"

25 
	#MEMERRMSG
 "nÙƒnough memÜy"

	)

32 #ià!
defšed
(
LUAI_HASHLIMIT
)

33 
	#LUAI_HASHLIMIT
 5

	)

40 
	$luaS_eqÊg¡r
 (
TSŒšg
 *
a
, TSŒšg *
b
) {

41 
size_t
 
Ën
 = 
a
->
u
.
ÊgËn
;

42 
	`lua_as£¹
(
a
->
‰
 =ğ
LUA_TLNGSTR
 && 
b
->tt == LUA_TLNGSTR);

43  (
a
 =ğ
b
) ||

44 ((
Ën
 =ğ
b
->
u
.
ÊgËn
) &&

45 (
	`memcmp
(
	`g‘¡r
(
a
), g‘¡r(
b
), 
Ën
) == 0));

46 
	}
}

49 
	$luaS_hash
 (cÚ¡ *
¡r
, 
size_t
 
l
, 
£ed
) {

50 
h
 = 
£ed
 ^ 
	`ÿ¡
(, 
l
);

51 
size_t
 
¡•
 = (
l
 >> 
LUAI_HASHLIMIT
) + 1;

52 ; 
l
 >ğ
¡•
;† -= step)

53 
h
 ^ğ((h<<5è+ (h>>2è+ 
	`ÿ¡_by‹
(
¡r
[
l
 - 1]));

54  
h
;

55 
	}
}

58 
	$luaS_hashlÚg¡r
 (
TSŒšg
 *
ts
) {

59 
	`lua_as£¹
(
ts
->
‰
 =ğ
LUA_TLNGSTR
);

60 ià(
ts
->
exŒa
 == 0) {

61 
ts
->
hash
 = 
	`luaS_hash
(
	`g‘¡r
Ñs),s->
u
.
ÊgËn
,s->hash);

62 
ts
->
exŒa
 = 1;

64  
ts
->
hash
;

65 
	}
}

71 
	$luaS_»size
 (
lua_S‹
 *
L
, 
Ãwsize
) {

72 
i
;

73 
¡ršgbË
 *
tb
 = &
	`G
(
L
)->
¡¹
;

74 ià(
Ãwsize
 > 
tb
->
size
) {

75 
	`luaM_»®locveùÜ
(
L
, 
tb
->
hash
,b->
size
, 
Ãwsize
, 
TSŒšg
 *);

76 
i
 = 
tb
->
size
; i < 
Ãwsize
; i++)

77 
tb
->
hash
[
i
] = 
NULL
;

79 
i
 = 0; i < 
tb
->
size
; i++) {

80 
TSŒšg
 *
p
 = 
tb
->
hash
[
i
];

81 
tb
->
hash
[
i
] = 
NULL
;

82 
p
) {

83 
TSŒšg
 *
hÃxt
 = 
p
->
u
.hnext;

84 
h
 = 
	`lmod
(
p
->
hash
, 
Ãwsize
);

85 
p
->
u
.
hÃxt
 = 
tb
->
hash
[
h
];

86 
tb
->
hash
[
h
] = 
p
;

87 
p
 = 
hÃxt
;

90 ià(
Ãwsize
 < 
tb
->
size
) {

92 
	`lua_as£¹
(
tb
->
hash
[
Ãwsize
] =ğ
NULL
 &&b->hash[tb->
size
 - 1] == NULL);

93 
	`luaM_»®locveùÜ
(
L
, 
tb
->
hash
,b->
size
, 
Ãwsize
, 
TSŒšg
 *);

95 
tb
->
size
 = 
Ãwsize
;

96 
	}
}

103 
	$luaS_ş—rÿche
 (
glob®_S‹
 *
g
) {

104 
i
, 
j
;

105 
i
 = 0; i < 
STRCACHE_N
; i++)

106 
j
 = 0; j < 
STRCACHE_M
; j++) {

107 ià(
	`iswh™e
(
g
->
¡rÿche
[
i
][
j
]))

108 
g
->
¡rÿche
[
i
][
j
] = g->
mem”rmsg
;

110 
	}
}

116 
	$luaS_š™
 (
lua_S‹
 *
L
) {

117 
glob®_S‹
 *
g
 = 
	`G
(
L
);

118 
i
, 
j
;

119 
	`luaS_»size
(
L
, 
MINSTRTABSIZE
);

121 
g
->
mem”rmsg
 = 
	`luaS_Ãwl™”®
(
L
, 
MEMERRMSG
);

122 
	`luaC_fix
(
L
, 
	`obj2gco
(
g
->
mem”rmsg
));

123 
i
 = 0; i < 
STRCACHE_N
; i++)

124 
j
 = 0; j < 
STRCACHE_M
; j++)

125 
g
->
¡rÿche
[
i
][
j
] = g->
mem”rmsg
;

126 
	}
}

133 
TSŒšg
 *
	$ü—‹¡robj
 (
lua_S‹
 *
L
, 
size_t
 
l
, 
g
, 
h
) {

134 
TSŒšg
 *
ts
;

135 
GCObjeù
 *
o
;

136 
size_t
 
tÙ®size
;

137 
tÙ®size
 = 
	`siz–¡ršg
(
l
);

138 
o
 = 
	`luaC_Ãwobj
(
L
, 
g
, 
tÙ®size
);

139 
ts
 = 
	`gco2ts
(
o
);

140 
ts
->
hash
 = 
h
;

141 
ts
->
exŒa
 = 0;

142 
	`g‘¡r
(
ts
)[
l
] = '\0';

143  
ts
;

144 
	}
}

147 
TSŒšg
 *
	$luaS_ü—‹Êg¡robj
 (
lua_S‹
 *
L
, 
size_t
 
l
) {

148 
TSŒšg
 *
ts
 = 
	`ü—‹¡robj
(
L
, 
l
, 
LUA_TLNGSTR
, 
	`G
(L)->
£ed
);

149 
ts
->
u
.
ÊgËn
 = 
l
;

150  
ts
;

151 
	}
}

154 
	$luaS_»move
 (
lua_S‹
 *
L
, 
TSŒšg
 *
ts
) {

155 
¡ršgbË
 *
tb
 = &
	`G
(
L
)->
¡¹
;

156 
TSŒšg
 **
p
 = &
tb
->
hash
[
	`lmod
(
ts
->hash,b->
size
)];

157 *
p
 !ğ
ts
)

158 
p
 = &(*p)->
u
.
hÃxt
;

159 *
p
 = (*p)->
u
.
hÃxt
;

160 
tb
->
nu£
--;

161 
	}
}

167 
TSŒšg
 *
	$š‹ºshr¡r
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
, 
size_t
 
l
) {

168 
TSŒšg
 *
ts
;

169 
glob®_S‹
 *
g
 = 
	`G
(
L
);

170 
h
 = 
	`luaS_hash
(
¡r
, 
l
, 
g
->
£ed
);

171 
TSŒšg
 **
li¡
 = &
g
->
¡¹
.
hash
[
	`lmod
(
h
, g->¡¹.
size
)];

172 
	`lua_as£¹
(
¡r
 !ğ
NULL
);

173 
ts
 = *
li¡
; !ğ
NULL
; ğts->
u
.
hÃxt
) {

174 ià(
l
 =ğ
ts
->
sh¾’
 &&

175 (
	`memcmp
(
¡r
, 
	`g‘¡r
(
ts
), 
l
 * ()) == 0)) {

177 ià(
	`isd—d
(
g
, 
ts
))

178 
	`chªgewh™e
(
ts
);

179  
ts
;

182 ià(
g
->
¡¹
.
nu£
 >ğg->¡¹.
size
 && g->¡¹.siz<ğ
MAX_INT
/2) {

183 
	`luaS_»size
(
L
, 
g
->
¡¹
.
size
 * 2);

184 
li¡
 = &
g
->
¡¹
.
hash
[
	`lmod
(
h
, g->¡¹.
size
)];

186 
ts
 = 
	`ü—‹¡robj
(
L
, 
l
, 
LUA_TSHRSTR
, 
h
);

187 
	`memıy
(
	`g‘¡r
(
ts
), 
¡r
, 
l
 * ());

188 
ts
->
sh¾’
 = 
	`ÿ¡_by‹
(
l
);

189 
ts
->
u
.
hÃxt
 = *
li¡
;

190 *
li¡
 = 
ts
;

191 
g
->
¡¹
.
nu£
++;

192  
ts
;

193 
	}
}

199 
TSŒšg
 *
	$luaS_Ãwl¡r
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
, 
size_t
 
l
) {

200 ià(
l
 <ğ
LUAI_MAXSHORTLEN
)

201  
	`š‹ºshr¡r
(
L
, 
¡r
, 
l
);

203 
TSŒšg
 *
ts
;

204 ià(
l
 >ğ(
MAX_SIZE
 - (
TSŒšg
))/())

205 
	`luaM_toobig
(
L
);

206 
ts
 = 
	`luaS_ü—‹Êg¡robj
(
L
, 
l
);

207 
	`memıy
(
	`g‘¡r
(
ts
), 
¡r
, 
l
 * ());

208  
ts
;

210 
	}
}

219 
TSŒšg
 *
	$luaS_Ãw
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
) {

220 
i
 = 
	`pošt2ušt
(
¡r
è% 
STRCACHE_N
;

221 
j
;

222 
TSŒšg
 **
p
 = 
	`G
(
L
)->
¡rÿche
[
i
];

223 
j
 = 0; j < 
STRCACHE_M
; j++) {

224 ià(
	`¡rcmp
(
¡r
, 
	`g‘¡r
(
p
[
j
])) == 0)

225  
p
[
j
];

228 
j
 = 
STRCACHE_M
 - 1; j > 0; j--)

229 
p
[
j
] =…[j - 1];

231 
p
[0] = 
	`luaS_Ãwl¡r
(
L
, 
¡r
, 
	`¡¾’
(str));

232  
p
[0];

233 
	}
}

236 
Ud©a
 *
	$luaS_Ãwud©a
 (
lua_S‹
 *
L
, 
size_t
 
s
) {

237 
Ud©a
 *
u
;

238 
GCObjeù
 *
o
;

239 ià(
s
 > 
MAX_SIZE
 - (
Ud©a
))

240 
	`luaM_toobig
(
L
);

241 
o
 = 
	`luaC_Ãwobj
(
L
, 
LUA_TUSERDATA
, 
	`siz–ud©a
(
s
));

242 
u
 = 
	`gco2u
(
o
);

243 
u
->
Ën
 = 
s
;

244 
u
->
m‘©abË
 = 
NULL
;

245 
	`£tu£rv®ue
(
L
, 
u
, 
luaO_nobjeù
);

246  
u
;

247 
	}
}

	@script/lua/lua-5.3.4/src/lstring.h

7 #iâdeà
l¡ršg_h


8 
	#l¡ršg_h


	)

10 
	~"lgc.h
"

11 
	~"lobjeù.h
"

12 
	~"l¡©e.h
"

15 
	#siz–¡ršg
(
l
è((
UTSŒšg
è+ (Öè+ 1è* ())

	)

17 
	#siz–ud©a
(
l
è((
UUd©a
è+ (l))

	)

18 
	#sizeud©a
(
u
è
	`siz–ud©a
((u)->
Ën
)

	)

20 
	#luaS_Ãwl™”®
(
L
, 
s
è(
	`luaS_Ãwl¡r
(L, "" s, \

21 ((
s
)/())-1))

	)

27 
	#i¤e£rved
(
s
è((s)->
‰
 =ğ
LUA_TSHRSTR
 && (s)->
exŒa
 > 0)

	)

33 
	#eqshr¡r
(
a
,
b
è
	`check_exp
(×)->
‰
 =ğ
LUA_TSHRSTR
, (aè=ğ(b))

	)

36 
LUAI_FUNC
 
luaS_hash
 (cÚ¡ *
¡r
, 
size_t
 
l
, 
£ed
);

37 
LUAI_FUNC
 
luaS_hashlÚg¡r
 (
TSŒšg
 *
ts
);

38 
LUAI_FUNC
 
luaS_eqÊg¡r
 (
TSŒšg
 *
a
, TSŒšg *
b
);

39 
LUAI_FUNC
 
luaS_»size
 (
lua_S‹
 *
L
, 
Ãwsize
);

40 
LUAI_FUNC
 
luaS_ş—rÿche
 (
glob®_S‹
 *
g
);

41 
LUAI_FUNC
 
luaS_š™
 (
lua_S‹
 *
L
);

42 
LUAI_FUNC
 
luaS_»move
 (
lua_S‹
 *
L
, 
TSŒšg
 *
ts
);

43 
LUAI_FUNC
 
Ud©a
 *
luaS_Ãwud©a
 (
lua_S‹
 *
L
, 
size_t
 
s
);

44 
LUAI_FUNC
 
TSŒšg
 *
luaS_Ãwl¡r
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
, 
size_t
 
l
);

45 
LUAI_FUNC
 
TSŒšg
 *
luaS_Ãw
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
);

46 
LUAI_FUNC
 
TSŒšg
 *
luaS_ü—‹Êg¡robj
 (
lua_S‹
 *
L
, 
size_t
 
l
);

	@script/lua/lua-5.3.4/src/lstrlib.c

7 
	#l¡¾ib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<ùy³.h
>

14 
	~<æßt.h
>

15 
	~<lim™s.h
>

16 
	~<loÿË.h
>

17 
	~<¡ddef.h
>

18 
	~<¡dio.h
>

19 
	~<¡dlib.h
>

20 
	~<¡ršg.h
>

22 
	~"lua.h
"

24 
	~"Ïuxlib.h
"

25 
	~"lu®ib.h
"

33 #ià!
defšed
(
LUA_MAXCAPTURES
)

34 
	#LUA_MAXCAPTURES
 32

	)

39 
	#uch¬
(
c
è(()(c))

	)

46 
	#MAX_SIZET
 ((
size_t
)(~(size_t)0))

	)

48 
	#MAXSIZE
 \

49 ((
size_t
è< (è? 
MAX_SIZET
 : (size_t)(
INT_MAX
))

	)

54 
	$¡r_Ën
 (
lua_S‹
 *
L
) {

55 
size_t
 
l
;

56 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

57 
	`lua_pushš‹g”
(
L
, (
lua_IÁeg”
)
l
);

59 
	}
}

63 
lua_IÁeg”
 
	$po¤–©
 (
lua_IÁeg”
 
pos
, 
size_t
 
Ën
) {

64 ià(
pos
 >= 0) …os;

65 ià(0u - (
size_t
)
pos
 > 
Ën
)  0;

66  (
lua_IÁeg”
)
Ën
 + 
pos
 + 1;

67 
	}
}

70 
	$¡r_sub
 (
lua_S‹
 *
L
) {

71 
size_t
 
l
;

72 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

73 
lua_IÁeg”
 
¡¬t
 = 
	`po¤–©
(
	`luaL_checkš‹g”
(
L
, 2), 
l
);

74 
lua_IÁeg”
 
’d
 = 
	`po¤–©
(
	`luaL_İtš‹g”
(
L
, 3, -1), 
l
);

75 ià(
¡¬t
 < 1) start = 1;

76 ià(
’d
 > (
lua_IÁeg”
)
l
)ƒnd =†;

77 ià(
¡¬t
 <ğ
’d
)

78 
	`lua_pushl¡ršg
(
L
, 
s
 + 
¡¬t
 - 1, (
size_t
)(
’d
 - start) + 1);

79 
	`lua_pushl™”®
(
L
, "");

81 
	}
}

84 
	$¡r_»v”£
 (
lua_S‹
 *
L
) {

85 
size_t
 
l
, 
i
;

86 
luaL_Bufãr
 
b
;

87 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

88 *
p
 = 
	`luaL_buffš™size
(
L
, &
b
, 
l
);

89 
i
 = 0; i < 
l
; i++)

90 
p
[
i
] = 
s
[
l
 - i - 1];

91 
	`luaL_push»suÉsize
(&
b
, 
l
);

93 
	}
}

96 
	$¡r_low”
 (
lua_S‹
 *
L
) {

97 
size_t
 
l
;

98 
size_t
 
i
;

99 
luaL_Bufãr
 
b
;

100 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

101 *
p
 = 
	`luaL_buffš™size
(
L
, &
b
, 
l
);

102 
i
=0; i<
l
; i++)

103 
p
[
i
] = 
	`tŞow”
(
	`uch¬
(
s
[i]));

104 
	`luaL_push»suÉsize
(&
b
, 
l
);

106 
	}
}

109 
	$¡r_uµ”
 (
lua_S‹
 *
L
) {

110 
size_t
 
l
;

111 
size_t
 
i
;

112 
luaL_Bufãr
 
b
;

113 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

114 *
p
 = 
	`luaL_buffš™size
(
L
, &
b
, 
l
);

115 
i
=0; i<
l
; i++)

116 
p
[
i
] = 
	`touµ”
(
	`uch¬
(
s
[i]));

117 
	`luaL_push»suÉsize
(&
b
, 
l
);

119 
	}
}

122 
	$¡r_»p
 (
lua_S‹
 *
L
) {

123 
size_t
 
l
, 
l£p
;

124 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

125 
lua_IÁeg”
 
n
 = 
	`luaL_checkš‹g”
(
L
, 2);

126 cÚ¡ *
£p
 = 
	`luaL_İ¡ršg
(
L
, 3, "", &
l£p
);

127 ià(
n
 <ğ0è
	`lua_pushl™”®
(
L
, "");

128 ià(
l
 + 
l£p
 <† ||† +†£°> 
MAXSIZE
 / 
n
)

129  
	`luaL_”rÜ
(
L
, "resulting stringoo†arge");

131 
size_t
 
tÙ®Ën
 = (size_t)
n
 * 
l
 + (size_t)Ò - 1è* 
l£p
;

132 
luaL_Bufãr
 
b
;

133 *
p
 = 
	`luaL_buffš™size
(
L
, &
b
, 
tÙ®Ën
);

134 
n
-- > 1) {

135 
	`memıy
(
p
, 
s
, 
l
 * ());… +=†;

136 ià(
l£p
 > 0) {

137 
	`memıy
(
p
, 
£p
, 
l£p
 * ());

138 
p
 +ğ
l£p
;

141 
	`memıy
(
p
, 
s
, 
l
 * ());

142 
	`luaL_push»suÉsize
(&
b
, 
tÙ®Ën
);

145 
	}
}

148 
	$¡r_by‹
 (
lua_S‹
 *
L
) {

149 
size_t
 
l
;

150 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

151 
lua_IÁeg”
 
posi
 = 
	`po¤–©
(
	`luaL_İtš‹g”
(
L
, 2, 1), 
l
);

152 
lua_IÁeg”
 
po£
 = 
	`po¤–©
(
	`luaL_İtš‹g”
(
L
, 3, 
posi
), 
l
);

153 
n
, 
i
;

154 ià(
posi
 < 1)…osi = 1;

155 ià(
po£
 > (
lua_IÁeg”
)
l
)…ose =†;

156 ià(
posi
 > 
po£
)  0;

157 ià(
po£
 - 
posi
 >ğ
INT_MAX
)

158  
	`luaL_”rÜ
(
L
, "string sliceoo†ong");

159 
n
 = ()(
po£
 - 
posi
) + 1;

160 
	`luaL_check¡ack
(
L
, 
n
, "string sliceoo†ong");

161 
i
=0; i<
n
; i++)

162 
	`lua_pushš‹g”
(
L
, 
	`uch¬
(
s
[
posi
+
i
-1]));

163  
n
;

164 
	}
}

167 
	$¡r_ch¬
 (
lua_S‹
 *
L
) {

168 
n
 = 
	`lua_g‘tİ
(
L
);

169 
i
;

170 
luaL_Bufãr
 
b
;

171 *
p
 = 
	`luaL_buffš™size
(
L
, &
b
, 
n
);

172 
i
=1; i<=
n
; i++) {

173 
lua_IÁeg”
 
c
 = 
	`luaL_checkš‹g”
(
L
, 
i
);

174 
	`luaL_¬gcheck
(
L
, 
	`uch¬
(
c
è=ğc, 
i
, "value out of„ange");

175 
p
[
i
 - 1] = 
	`uch¬
(
c
);

177 
	`luaL_push»suÉsize
(&
b
, 
n
);

179 
	}
}

182 
	$wr™”
 (
lua_S‹
 *
L
, cÚ¡ *
b
, 
size_t
 
size
, *
B
) {

183 ()
L
;

184 
	`luaL_addl¡ršg
((
luaL_Bufãr
 *è
B
, (cÚ¡ *)
b
, 
size
);

186 
	}
}

189 
	$¡r_dump
 (
lua_S‹
 *
L
) {

190 
luaL_Bufãr
 
b
;

191 
¡r
 = 
	`lua_toboŞ—n
(
L
, 2);

192 
	`luaL_checkty³
(
L
, 1, 
LUA_TFUNCTION
);

193 
	`lua_£‰İ
(
L
, 1);

194 
	`luaL_buffš™
(
L
,&
b
);

195 ià(
	`lua_dump
(
L
, 
wr™”
, &
b
, 
¡r
) != 0)

196  
	`luaL_”rÜ
(
L
, "unableo dump given function");

197 
	`luaL_push»suÉ
(&
b
);

199 
	}
}

210 
	#CAP_UNFINISHED
 (-1)

	)

211 
	#CAP_POSITION
 (-2)

	)

214 
	sM©chS‹
 {

215 cÚ¡ *
	m¤c_š™
;

216 cÚ¡ *
	m¤c_’d
;

217 cÚ¡ *
	mp_’d
;

218 
lua_S‹
 *
	mL
;

219 
	mm©chd•th
;

220 
	mËv–
;

222 cÚ¡ *
	mš™
;

223 
±rdiff_t
 
	mËn
;

224 } 
	mÿ±u»
[
LUA_MAXCAPTURES
];

225 } 
	tM©chS‹
;

229 cÚ¡ *
m©ch
 (
M©chS‹
 *
ms
, cÚ¡ *
s
, cÚ¡ *
p
);

233 #ià!
defšed
(
MAXCCALLS
)

234 
	#MAXCCALLS
 200

	)

238 
	#L_ESC
 '%'

	)

239 
	#SPECIALS
 "^$*+?.([%-"

	)

242 
	$check_ÿ±u»
 (
M©chS‹
 *
ms
, 
l
) {

243 
l
 -= '1';

244 ià(
l
 < 0 ||† >ğ
ms
->
Ëv–
 || ms->
ÿ±u»
[l].
Ën
 =ğ
CAP_UNFINISHED
)

245  
	`luaL_”rÜ
(
ms
->
L
, "šv®id c­tu» index %%%d", 
l
 + 1);

246  
l
;

247 
	}
}

250 
	$ÿ±u»_to_şo£
 (
M©chS‹
 *
ms
) {

251 
Ëv–
 = 
ms
->level;

252 
Ëv–
--;†evel>=0;†evel--)

253 ià(
ms
->
ÿ±u»
[
Ëv–
].
Ën
 =ğ
CAP_UNFINISHED
) †evel;

254  
	`luaL_”rÜ
(
ms
->
L
, "invalid…attern capture");

255 
	}
}

258 cÚ¡ *
	$şas£nd
 (
M©chS‹
 *
ms
, cÚ¡ *
p
) {

259 *
p
++) {

260 
L_ESC
: {

261 ià(
p
 =ğ
ms
->
p_’d
)

262 
	`luaL_”rÜ
(
ms
->
L
, "malformed…attern (ends with '%%')");

263  
p
+1;

266 ià(*
p
 == '^')…++;

268 ià(
p
 =ğ
ms
->
p_’d
)

269 
	`luaL_”rÜ
(
ms
->
L
, "malformed…attern (missing ']')");

270 ià(*(
p
++è=ğ
L_ESC
 &&… < 
ms
->
p_’d
)

271 
p
++;

272 } *
p
 != ']');

273  
p
+1;

276  
p
;

279 
	}
}

282 
	$m©ch_şass
 (
c
, 
ş
) {

283 
»s
;

284 
	`tŞow”
(
ş
)) {

285 'a' : 
»s
 = 
	`i§Íha
(
c
); ;

286 'c' : 
»s
 = 
	`isúŒl
(
c
); ;

287 'd' : 
»s
 = 
	`isdig™
(
c
); ;

288 'g' : 
»s
 = 
	`isg¿ph
(
c
); ;

289 'l' : 
»s
 = 
	`i¦ow”
(
c
); ;

290 'p' : 
»s
 = 
	`i¥unù
(
c
); ;

291 's' : 
»s
 = 
	`is¥aû
(
c
); ;

292 'u' : 
»s
 = 
	`isuµ”
(
c
); ;

293 'w' : 
»s
 = 
	`i§Êum
(
c
); ;

294 'x' : 
»s
 = 
	`isxdig™
(
c
); ;

295 'z' : 
»s
 = (
c
 == 0); ;

296 :  (
ş
 =ğ
c
);

298  (
	`i¦ow”
(
ş
è? 
»s
 : !res);

299 
	}
}

302 
	$m©chb¿ck‘şass
 (
c
, cÚ¡ *
p
, cÚ¡ *
ec
) {

303 
sig
 = 1;

304 ià(*(
p
+1) == '^') {

305 
sig
 = 0;

306 
p
++;

308 ++
p
 < 
ec
) {

309 ià(*
p
 =ğ
L_ESC
) {

310 
p
++;

311 ià(
	`m©ch_şass
(
c
, 
	`uch¬
(*
p
)))

312  
sig
;

314 ià((*(
p
+1è=ğ'-'è&& (p+2 < 
ec
)) {

315 
p
+=2;

316 ià(
	`uch¬
(*(
p
-2)è<ğ
c
 && c <= uchar(*p))

317  
sig
;

319 ià(
	`uch¬
(*
p
è=ğ
c
è 
sig
;

321  !
sig
;

322 
	}
}

325 
	$sšgËm©ch
 (
M©chS‹
 *
ms
, cÚ¡ *
s
, cÚ¡ *
p
,

326 cÚ¡ *
•
) {

327 ià(
s
 >ğ
ms
->
¤c_’d
)

330 
c
 = 
	`uch¬
(*
s
);

331 *
p
) {

333 
L_ESC
:  
	`m©ch_şass
(
c
, 
	`uch¬
(*(
p
+1)));

334 '[':  
	`m©chb¿ck‘şass
(
c
, 
p
, 
•
-1);

335 :  (
	`uch¬
(*
p
è=ğ
c
);

338 
	}
}

341 cÚ¡ *
	$m©chb®ªû
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

342 cÚ¡ *
p
) {

343 ià(
p
 >ğ
ms
->
p_’d
 - 1)

344 
	`luaL_”rÜ
(
ms
->
L
, "malformed…attern (missing‡rgumentso '%%b')");

345 ià(*
s
 !ğ*
p
è 
NULL
;

347 
b
 = *
p
;

348 
e
 = *(
p
+1);

349 
cÚt
 = 1;

350 ++
s
 < 
ms
->
¤c_’d
) {

351 ià(*
s
 =ğ
e
) {

352 ià(--
cÚt
 =ğ0è 
s
+1;

354 ià(*
s
 =ğ
b
è
cÚt
++;

357  
NULL
;

358 
	}
}

361 cÚ¡ *
	$max_ex·nd
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

362 cÚ¡ *
p
, cÚ¡ *
•
) {

363 
±rdiff_t
 
i
 = 0;

364 
	`sšgËm©ch
(
ms
, 
s
 + 
i
, 
p
, 
•
))

365 
i
++;

367 
i
>=0) {

368 cÚ¡ *
»s
 = 
	`m©ch
(
ms
, (
s
+
i
), 
•
+1);

369 ià(
»s
) „es;

370 
i
--;

372  
NULL
;

373 
	}
}

376 cÚ¡ *
	$mš_ex·nd
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

377 cÚ¡ *
p
, cÚ¡ *
•
) {

379 cÚ¡ *
»s
 = 
	`m©ch
(
ms
, 
s
, 
•
+1);

380 ià(
»s
 !ğ
NULL
)

381  
»s
;

382 ià(
	`sšgËm©ch
(
ms
, 
s
, 
p
, 
•
))

383 
s
++;

384  
NULL
;

386 
	}
}

389 cÚ¡ *
	$¡¬t_ÿ±u»
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

390 cÚ¡ *
p
, 
wh©
) {

391 cÚ¡ *
»s
;

392 
Ëv–
 = 
ms
->level;

393 ià(
Ëv–
 >ğ
LUA_MAXCAPTURES
è
	`luaL_”rÜ
(
ms
->
L
, "too many captures");

394 
ms
->
ÿ±u»
[
Ëv–
].
š™
 = 
s
;

395 
ms
->
ÿ±u»
[
Ëv–
].
Ën
 = 
wh©
;

396 
ms
->
Ëv–
 =†evel+1;

397 ià((
»s
=
	`m©ch
(
ms
, 
s
, 
p
)è=ğ
NULL
)

398 
ms
->
Ëv–
--;

399  
»s
;

400 
	}
}

403 cÚ¡ *
	$’d_ÿ±u»
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

404 cÚ¡ *
p
) {

405 
l
 = 
	`ÿ±u»_to_şo£
(
ms
);

406 cÚ¡ *
»s
;

407 
ms
->
ÿ±u»
[
l
].
Ën
 = 
s
 - ms->ÿ±u»[l].
š™
;

408 ià((
»s
 = 
	`m©ch
(
ms
, 
s
, 
p
)è=ğ
NULL
)

409 
ms
->
ÿ±u»
[
l
].
Ën
 = 
CAP_UNFINISHED
;

410  
»s
;

411 
	}
}

414 cÚ¡ *
	$m©ch_ÿ±u»
 (
M©chS‹
 *
ms
, cÚ¡ *
s
, 
l
) {

415 
size_t
 
Ën
;

416 
l
 = 
	`check_ÿ±u»
(
ms
,†);

417 
Ën
 = 
ms
->
ÿ±u»
[
l
].len;

418 ià((
size_t
)(
ms
->
¤c_’d
-
s
è>ğ
Ën
 &&

419 
	`memcmp
(
ms
->
ÿ±u»
[
l
].
š™
, 
s
, 
Ën
) == 0)

420  
s
+
Ën
;

421  
NULL
;

422 
	}
}

425 cÚ¡ *
	$m©ch
 (
M©chS‹
 *
ms
, cÚ¡ *
s
, cÚ¡ *
p
) {

426 ià(
ms
->
m©chd•th
-- == 0)

427 
	`luaL_”rÜ
(
ms
->
L
, "patternoo complex");

428 
š™
:

429 ià(
p
 !ğ
ms
->
p_’d
) {

430 *
p
) {

432 ià(*(
p
 + 1) == ')')

433 
s
 = 
	`¡¬t_ÿ±u»
(
ms
, s, 
p
 + 2, 
CAP_POSITION
);

435 
s
 = 
	`¡¬t_ÿ±u»
(
ms
, s, 
p
 + 1, 
CAP_UNFINISHED
);

439 
s
 = 
	`’d_ÿ±u»
(
ms
, s, 
p
 + 1);

443 ià((
p
 + 1è!ğ
ms
->
p_’d
)

444 
dæt
;

445 
s
 = ( =ğ
ms
->
¤c_’d
è? s : 
NULL
;

448 
L_ESC
: {

449 *(
p
 + 1)) {

451 
s
 = 
	`m©chb®ªû
(
ms
, s, 
p
 + 2);

452 ià(
s
 !ğ
NULL
) {

453 
p
 +ğ4; 
š™
;

458 cÚ¡ *
•
; 
´evious
;

459 
p
 += 2;

460 ià(*
p
 != '[')

461 
	`luaL_”rÜ
(
ms
->
L
, "missing '['‡fter '%%f' in…attern");

462 
•
 = 
	`şas£nd
(
ms
, 
p
);

463 
´evious
 = (
s
 =ğ
ms
->
¤c_š™
) ? '\0' : *(s - 1);

464 ià(!
	`m©chb¿ck‘şass
(
	`uch¬
(
´evious
), 
p
, 
•
 - 1) &&

465 
	`m©chb¿ck‘şass
(
	`uch¬
(*
s
), 
p
, 
•
 - 1)) {

466 
p
 = 
•
; 
š™
;

468 
s
 = 
NULL
;

474 
s
 = 
	`m©ch_ÿ±u»
(
ms
, s, 
	`uch¬
(*(
p
 + 1)));

475 ià(
s
 !ğ
NULL
) {

476 
p
 +ğ2; 
š™
;

480 : 
dæt
;

484 : 
dæt
: {

485 cÚ¡ *
•
 = 
	`şas£nd
(
ms
, 
p
);

487 ià(!
	`sšgËm©ch
(
ms
, 
s
, 
p
, 
•
)) {

488 ià(*
•
 == '*' || *ep == '?' || *ep == '-') {

489 
p
 = 
•
 + 1; 
š™
;

492 
s
 = 
NULL
;

495 *
•
) {

497 cÚ¡ *
»s
;

498 ià((
»s
 = 
	`m©ch
(
ms
, 
s
 + 1, 
•
 + 1)è!ğ
NULL
)

499 
s
 = 
»s
;

501 
p
 = 
•
 + 1; 
š™
;

506 
s
++;

509 
s
 = 
	`max_ex·nd
(
ms
, s, 
p
, 
•
);

512 
s
 = 
	`mš_ex·nd
(
ms
, s, 
p
, 
•
);

515 
s
++; 
p
 = 
•
; 
š™
;

522 
ms
->
m©chd•th
++;

523  
s
;

524 
	}
}

528 cÚ¡ *
	$lmemfšd
 (cÚ¡ *
s1
, 
size_t
 
l1
,

529 cÚ¡ *
s2
, 
size_t
 
l2
) {

530 ià(
l2
 =ğ0è 
s1
;

531 ià(
l2
 > 
l1
è 
NULL
;

533 cÚ¡ *
š™
;

534 
l2
--;

535 
l1
 =†1-
l2
;

536 
l1
 > 0 && (
š™
 = (cÚ¡ *)
	`memchr
(
s1
, *
s2
,†1)è!ğ
NULL
) {

537 
š™
++;

538 ià(
	`memcmp
(
š™
, 
s2
+1, 
l2
) == 0)

539  
š™
-1;

541 
l1
 -ğ
š™
-
s1
;

542 
s1
 = 
š™
;

545  
NULL
;

547 
	}
}

550 
	$push_Úeÿ±u»
 (
M©chS‹
 *
ms
, 
i
, cÚ¡ *
s
,

551 cÚ¡ *
e
) {

552 ià(
i
 >ğ
ms
->
Ëv–
) {

553 ià(
i
 == 0)

554 
	`lua_pushl¡ršg
(
ms
->
L
, 
s
, 
e
 - s);

556 
	`luaL_”rÜ
(
ms
->
L
, "šv®id c­tu» index %%%d", 
i
 + 1);

559 
±rdiff_t
 
l
 = 
ms
->
ÿ±u»
[
i
].
Ën
;

560 ià(
l
 =ğ
CAP_UNFINISHED
è
	`luaL_”rÜ
(
ms
->
L
, "unfinished capture");

561 ià(
l
 =ğ
CAP_POSITION
)

562 
	`lua_pushš‹g”
(
ms
->
L
, (ms->
ÿ±u»
[
i
].
š™
 - ms->
¤c_š™
) + 1);

564 
	`lua_pushl¡ršg
(
ms
->
L
, ms->
ÿ±u»
[
i
].
š™
, 
l
);

566 
	}
}

569 
	$push_ÿ±u»s
 (
M©chS‹
 *
ms
, cÚ¡ *
s
, cÚ¡ *
e
) {

570 
i
;

571 
Æev–s
 = (
ms
->
Ëv–
 =ğ0 && 
s
) ? 1 : ms->level;

572 
	`luaL_check¡ack
(
ms
->
L
, 
Æev–s
, "too many captures");

573 
i
 = 0; i < 
Æev–s
; i++)

574 
	`push_Úeÿ±u»
(
ms
, 
i
, 
s
, 
e
);

575  
Æev–s
;

576 
	}
}

580 
	$no¥ecŸls
 (cÚ¡ *
p
, 
size_t
 
l
) {

581 
size_t
 
u±o
 = 0;

583 ià(
	`¡½brk
(
p
 + 
u±o
, 
SPECIALS
))

585 
u±o
 +ğ
	`¡¾’
(
p
 + upto) + 1;

586 } 
u±o
 <ğ
l
);

588 
	}
}

591 
	$´•¡©e
 (
M©chS‹
 *
ms
, 
lua_S‹
 *
L
,

592 cÚ¡ *
s
, 
size_t
 
ls
, cÚ¡ *
p
, size_ˆ
Í
) {

593 
ms
->
L
 = L;

594 
ms
->
m©chd•th
 = 
MAXCCALLS
;

595 
ms
->
¤c_š™
 = 
s
;

596 
ms
->
¤c_’d
 = 
s
 + 
ls
;

597 
ms
->
p_’d
 = 
p
 + 
Í
;

598 
	}
}

601 
	$»´•¡©e
 (
M©chS‹
 *
ms
) {

602 
ms
->
Ëv–
 = 0;

603 
	`lua_as£¹
(
ms
->
m©chd•th
 =ğ
MAXCCALLS
);

604 
	}
}

607 
	$¡r_fšd_aux
 (
lua_S‹
 *
L
, 
fšd
) {

608 
size_t
 
ls
, 
Í
;

609 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
ls
);

610 cÚ¡ *
p
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
Í
);

611 
lua_IÁeg”
 
š™
 = 
	`po¤–©
(
	`luaL_İtš‹g”
(
L
, 3, 1), 
ls
);

612 ià(
š™
 < 1) init = 1;

613 ià(
š™
 > (
lua_IÁeg”
)
ls
 + 1) {

614 
	`lua_pushn
(
L
);

618 ià(
fšd
 && (
	`lua_toboŞ—n
(
L
, 4è|| 
	`no¥ecŸls
(
p
, 
Í
))) {

620 cÚ¡ *
s2
 = 
	`lmemfšd
(
s
 + 
š™
 - 1, 
ls
 - (
size_t
)š™ + 1, 
p
, 
Í
);

621 ià(
s2
) {

622 
	`lua_pushš‹g”
(
L
, (
s2
 - 
s
) + 1);

623 
	`lua_pushš‹g”
(
L
, (
s2
 - 
s
è+ 
Í
);

628 
M©chS‹
 
ms
;

629 cÚ¡ *
s1
 = 
s
 + 
š™
 - 1;

630 
ªchÜ
 = (*
p
 == '^');

631 ià(
ªchÜ
) {

632 
p
++; 
Í
--;

634 
	`´•¡©e
(&
ms
, 
L
, 
s
, 
ls
, 
p
, 
Í
);

636 cÚ¡ *
»s
;

637 
	`»´•¡©e
(&
ms
);

638 ià((
»s
=
	`m©ch
(&
ms
, 
s1
, 
p
)è!ğ
NULL
) {

639 ià(
fšd
) {

640 
	`lua_pushš‹g”
(
L
, (
s1
 - 
s
) + 1);

641 
	`lua_pushš‹g”
(
L
, 
»s
 - 
s
);

642  
	`push_ÿ±u»s
(&
ms
, 
NULL
, 0) + 2;

645  
	`push_ÿ±u»s
(&
ms
, 
s1
, 
»s
);

647 } 
s1
++ < 
ms
.
¤c_’d
 && !
ªchÜ
);

649 
	`lua_pushn
(
L
);

651 
	}
}

654 
	$¡r_fšd
 (
lua_S‹
 *
L
) {

655  
	`¡r_fšd_aux
(
L
, 1);

656 
	}
}

659 
	$¡r_m©ch
 (
lua_S‹
 *
L
) {

660  
	`¡r_fšd_aux
(
L
, 0);

661 
	}
}

665 
	sGM©chS‹
 {

666 cÚ¡ *
	m¤c
;

667 cÚ¡ *
	mp
;

668 cÚ¡ *
	mÏ¡m©ch
;

669 
M©chS‹
 
	mms
;

670 } 
	tGM©chS‹
;

673 
	$gm©ch_aux
 (
lua_S‹
 *
L
) {

674 
GM©chS‹
 *
gm
 = (GM©chS‹ *)
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(3));

675 cÚ¡ *
¤c
;

676 
gm
->
ms
.
L
 = L;

677 
¤c
 = 
gm
->¤c; srø<ğgm->
ms
.
¤c_’d
; src++) {

678 cÚ¡ *
e
;

679 
	`»´•¡©e
(&
gm
->
ms
);

680 ià((
e
 = 
	`m©ch
(&
gm
->
ms
, 
¤c
, gm->
p
)è!ğ
NULL
 &&ƒ !ğgm->
Ï¡m©ch
) {

681 
gm
->
¤c
 = gm->
Ï¡m©ch
 = 
e
;

682  
	`push_ÿ±u»s
(&
gm
->
ms
, 
¤c
, 
e
);

686 
	}
}

689 
	$gm©ch
 (
lua_S‹
 *
L
) {

690 
size_t
 
ls
, 
Í
;

691 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
ls
);

692 cÚ¡ *
p
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
Í
);

693 
GM©chS‹
 *
gm
;

694 
	`lua_£‰İ
(
L
, 2);

695 
gm
 = (
GM©chS‹
 *)
	`lua_Ãwu£rd©a
(
L
, (GMatchState));

696 
	`´•¡©e
(&
gm
->
ms
, 
L
, 
s
, 
ls
, 
p
, 
Í
);

697 
gm
->
¤c
 = 
s
; gm->
p
 =…; gm->
Ï¡m©ch
 = 
NULL
;

698 
	`lua_pushcşosu»
(
L
, 
gm©ch_aux
, 3);

700 
	}
}

703 
	$add_s
 (
M©chS‹
 *
ms
, 
luaL_Bufãr
 *
b
, cÚ¡ *
s
,

704 cÚ¡ *
e
) {

705 
size_t
 
l
, 
i
;

706 
lua_S‹
 *
L
 = 
ms
->L;

707 cÚ¡ *
Ãws
 = 
	`lua_tŞ¡ršg
(
L
, 3, &
l
);

708 
i
 = 0; i < 
l
; i++) {

709 ià(
Ãws
[
i
] !ğ
L_ESC
)

710 
	`luaL_addch¬
(
b
, 
Ãws
[
i
]);

712 
i
++;

713 ià(!
	`isdig™
(
	`uch¬
(
Ãws
[
i
]))) {

714 ià(
Ãws
[
i
] !ğ
L_ESC
)

715 
	`luaL_”rÜ
(
L
, "šv®id u£ oà'%c' iÀ»¶aûm’ˆ¡ršg", 
L_ESC
);

716 
	`luaL_addch¬
(
b
, 
Ãws
[
i
]);

718 ià(
Ãws
[
i
] == '0')

719 
	`luaL_addl¡ršg
(
b
, 
s
, 
e
 - s);

721 
	`push_Úeÿ±u»
(
ms
, 
Ãws
[
i
] - '1', 
s
, 
e
);

722 
	`luaL_tŞ¡ršg
(
L
, -1, 
NULL
);

723 
	`lua_»move
(
L
, -2);

724 
	`luaL_addv®ue
(
b
);

728 
	}
}

731 
	$add_v®ue
 (
M©chS‹
 *
ms
, 
luaL_Bufãr
 *
b
, cÚ¡ *
s
,

732 cÚ¡ *
e
, 
Œ
) {

733 
lua_S‹
 *
L
 = 
ms
->L;

734 
Œ
) {

735 
LUA_TFUNCTION
: {

736 
n
;

737 
	`lua_pushv®ue
(
L
, 3);

738 
n
 = 
	`push_ÿ±u»s
(
ms
, 
s
, 
e
);

739 
	`lua_ÿÎ
(
L
, 
n
, 1);

742 
LUA_TTABLE
: {

743 
	`push_Úeÿ±u»
(
ms
, 0, 
s
, 
e
);

744 
	`lua_g‘bË
(
L
, 3);

748 
	`add_s
(
ms
, 
b
, 
s
, 
e
);

752 ià(!
	`lua_toboŞ—n
(
L
, -1)) {

753 
	`lua_pİ
(
L
, 1);

754 
	`lua_pushl¡ršg
(
L
, 
s
, 
e
 - s);

756 ià(!
	`lua_is¡ršg
(
L
, -1))

757 
	`luaL_”rÜ
(
L
, "šv®id„•Ïûm’ˆv®u× %s)", 
	`luaL_ty³Çme
(L, -1));

758 
	`luaL_addv®ue
(
b
);

759 
	}
}

762 
	$¡r_gsub
 (
lua_S‹
 *
L
) {

763 
size_t
 
¤ş
, 
Í
;

764 cÚ¡ *
¤c
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
¤ş
);

765 cÚ¡ *
p
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
Í
);

766 cÚ¡ *
Ï¡m©ch
 = 
NULL
;

767 
Œ
 = 
	`lua_ty³
(
L
, 3);

768 
lua_IÁeg”
 
max_s
 = 
	`luaL_İtš‹g”
(
L
, 4, 
¤ş
 + 1);

769 
ªchÜ
 = (*
p
 == '^');

770 
lua_IÁeg”
 
n
 = 0;

771 
M©chS‹
 
ms
;

772 
luaL_Bufãr
 
b
;

773 
	`luaL_¬gcheck
(
L
, 
Œ
 =ğ
LUA_TNUMBER
 ||¸=ğ
LUA_TSTRING
 ||

774 
Œ
 =ğ
LUA_TFUNCTION
 ||¸=ğ
LUA_TTABLE
, 3,

776 
	`luaL_buffš™
(
L
, &
b
);

777 ià(
ªchÜ
) {

778 
p
++; 
Í
--;

780 
	`´•¡©e
(&
ms
, 
L
, 
¤c
, 
¤ş
, 
p
, 
Í
);

781 
n
 < 
max_s
) {

782 cÚ¡ *
e
;

783 
	`»´•¡©e
(&
ms
);

784 ià((
e
 = 
	`m©ch
(&
ms
, 
¤c
, 
p
)è!ğ
NULL
 &&ƒ !ğ
Ï¡m©ch
) {

785 
n
++;

786 
	`add_v®ue
(&
ms
, &
b
, 
¤c
, 
e
, 
Œ
);

787 
¤c
 = 
Ï¡m©ch
 = 
e
;

789 ià(
¤c
 < 
ms
.
¤c_’d
)

790 
	`luaL_addch¬
(&
b
, *
¤c
++);

792 ià(
ªchÜ
) ;

794 
	`luaL_addl¡ršg
(&
b
, 
¤c
, 
ms
.
¤c_’d
-src);

795 
	`luaL_push»suÉ
(&
b
);

796 
	`lua_pushš‹g”
(
L
, 
n
);

798 
	}
}

810 #ià!
defšed
(
lua_numb”2¡rx
)

816 
	~<m©h.h
>

818 
	#SIZELENMOD
 ((
LUA_NUMBER_FRMLEN
)/())

	)

827 
	#L_NBFD
 ((
	`l_m©hlim
(
MANT_DIG
è- 1)%4 + 1)

	)

833 
lua_Numb”
 
	$adddig™
 (*
buff
, 
n
, 
lua_Numb”
 
x
) {

834 
lua_Numb”
 
dd
 = 
	`l_m©hİ
(
æoÜ
)(
x
);

835 
d
 = ()
dd
;

836 
buff
[
n
] = (
d
 < 10 ? d + '0' : d - 10 + 'a');

837  
x
 - 
dd
;

838 
	}
}

841 
	$num2¡¿ux
 (*
buff
, 
sz
, 
lua_Numb”
 
x
) {

843 ià(
x
 !ğx || x =ğ(
lua_Numb”
)
HUGE_VAL
 || x == -(lua_Number)HUGE_VAL)

844  
	`l_¥rštf
(
buff
, 
sz
, 
LUA_NUMBER_FMT
, (
LUAI_UACNUMBER
)
x
);

845 ià(
x
 == 0) {

847  
	`l_¥rštf
(
buff
, 
sz
, 
LUA_NUMBER_FMT
 "x0p+0", (
LUAI_UACNUMBER
)
x
);

850 
e
;

851 
lua_Numb”
 
m
 = 
	`l_m©hİ
(
äexp
)(
x
, &
e
);

852 
n
 = 0;

853 ià(
m
 < 0) {

854 
buff
[
n
++] = '-';

855 
m
 = -m;

857 
buff
[
n
++] = '0'; buff[n++] = 'x';

858 
m
 = 
	`adddig™
(
buff
, 
n
++, m * (1 << 
L_NBFD
));

859 
e
 -ğ
L_NBFD
;

860 ià(
m
 > 0) {

861 
buff
[
n
++] = 
	`lua_g‘loÿËdeıošt
();

863 
m
 = 
	`adddig™
(
buff
, 
n
++, m * 16);

864 } 
m
 > 0);

866 
n
 +ğ
	`l_¥rštf
(
buff
 +‚, 
sz
 -‚, "p%+d", 
e
);

867 
	`lua_as£¹
(
n
 < 
sz
);

868  
n
;

870 
	}
}

873 
	$lua_numb”2¡rx
 (
lua_S‹
 *
L
, *
buff
, 
sz
,

874 cÚ¡ *
fmt
, 
lua_Numb”
 
x
) {

875 
n
 = 
	`num2¡¿ux
(
buff
, 
sz
, 
x
);

876 ià(
fmt
[
SIZELENMOD
] == 'A') {

877 
i
;

878 
i
 = 0; i < 
n
; i++)

879 
buff
[
i
] = 
	`touµ”
(
	`uch¬
(buff[i]));

881 ià(
fmt
[
SIZELENMOD
] != 'a')

882 
	`luaL_”rÜ
(
L
, "modifiers for format '%%a'/'%%A'‚ot implemented");

883  
n
;

884 
	}
}

896 
	#MAX_ITEM
 (120 + 
	`l_m©hlim
(
MAX_10_EXP
))

	)

900 
	#FLAGS
 "-+ #0"

	)

905 
	#MAX_FORMAT
 32

	)

908 
	$addquÙed
 (
luaL_Bufãr
 *
b
, cÚ¡ *
s
, 
size_t
 
Ën
) {

909 
	`luaL_addch¬
(
b
, '"');

910 
Ën
--) {

911 ià(*
s
 == '"' || *s == '\\' || *s == '\n') {

912 
	`luaL_addch¬
(
b
, '\\');

913 
	`luaL_addch¬
(
b
, *
s
);

915 ià(
	`isúŒl
(
	`uch¬
(*
s
))) {

916 
buff
[10];

917 ià(!
	`isdig™
(
	`uch¬
(*(
s
+1))))

918 
	`l_¥rštf
(
buff
, (buff), "\\%d", ()
	`uch¬
(*
s
));

920 
	`l_¥rštf
(
buff
, (buff), "\\%03d", ()
	`uch¬
(*
s
));

921 
	`luaL_add¡ršg
(
b
, 
buff
);

924 
	`luaL_addch¬
(
b
, *
s
);

925 
s
++;

927 
	`luaL_addch¬
(
b
, '"');

928 
	}
}

934 
	$checkdp
 (*
buff
, 
nb
) {

935 ià(
	`memchr
(
buff
, '.', 
nb
è=ğ
NULL
) {

936 
pošt
 = 
	`lua_g‘loÿËdeıošt
();

937 *
µošt
 = (*)
	`memchr
(
buff
, 
pošt
, 
nb
);

938 ià(
µošt
) *ppoint = '.';

940 
	}
}

943 
	$addl™”®
 (
lua_S‹
 *
L
, 
luaL_Bufãr
 *
b
, 
¬g
) {

944 
	`lua_ty³
(
L
, 
¬g
)) {

945 
LUA_TSTRING
: {

946 
size_t
 
Ën
;

947 cÚ¡ *
s
 = 
	`lua_tŞ¡ršg
(
L
, 
¬g
, &
Ën
);

948 
	`addquÙed
(
b
, 
s
, 
Ën
);

951 
LUA_TNUMBER
: {

952 *
buff
 = 
	`luaL_´•buffsize
(
b
, 
MAX_ITEM
);

953 
nb
;

954 ià(!
	`lua_isš‹g”
(
L
, 
¬g
)) {

955 
lua_Numb”
 
n
 = 
	`lua_tÚumb”
(
L
, 
¬g
);

956 
nb
 = 
	`lua_numb”2¡rx
(
L
, 
buff
, 
MAX_ITEM
, "%" 
LUA_NUMBER_FRMLEN
 "a", 
n
);

957 
	`checkdp
(
buff
, 
nb
);

960 
lua_IÁeg”
 
n
 = 
	`lua_toš‹g”
(
L
, 
¬g
);

961 cÚ¡ *
fÜm©
 = (
n
 =ğ
LUA_MININTEGER
)

962 ? "0x%" 
LUA_INTEGER_FRMLEN
 "x"

963 : 
LUA_INTEGER_FMT
;

964 
nb
 = 
	`l_¥rštf
(
buff
, 
MAX_ITEM
, 
fÜm©
, (
LUAI_UACINT
)
n
);

966 
	`luaL_addsize
(
b
, 
nb
);

969 
LUA_TNIL
: 
LUA_TBOOLEAN
: {

970 
	`luaL_tŞ¡ršg
(
L
, 
¬g
, 
NULL
);

971 
	`luaL_addv®ue
(
b
);

975 
	`luaL_¬g”rÜ
(
L
, 
¬g
, "value has‚o†iteral form");

978 
	}
}

981 cÚ¡ *
	$sÿnfÜm©
 (
lua_S‹
 *
L
, cÚ¡ *
¡rämt
, *
fÜm
) {

982 cÚ¡ *
p
 = 
¡rämt
;

983 *
p
 !ğ'\0' && 
	`¡rchr
(
FLAGS
, *pè!ğ
NULL
)…++;

984 ià((
size_t
)(
p
 - 
¡rämt
è>ğ(
FLAGS
)/())

985 
	`luaL_”rÜ
(
L
, "invalid format (repeated flags)");

986 ià(
	`isdig™
(
	`uch¬
(*
p
)))…++;

987 ià(
	`isdig™
(
	`uch¬
(*
p
)))…++;

988 ià(*
p
 == '.') {

989 
p
++;

990 ià(
	`isdig™
(
	`uch¬
(*
p
)))…++;

991 ià(
	`isdig™
(
	`uch¬
(*
p
)))…++;

993 ià(
	`isdig™
(
	`uch¬
(*
p
)))

994 
	`luaL_”rÜ
(
L
, "invalid format (width or…recisionoo†ong)");

995 *(
fÜm
++) = '%';

996 
	`memıy
(
fÜm
, 
¡rämt
, ((
p
 - strfrmt) + 1) * ());

997 
fÜm
 +ğ(
p
 - 
¡rämt
) + 1;

998 *
fÜm
 = '\0';

999  
p
;

1000 
	}
}

1006 
	$addËnmod
 (*
fÜm
, cÚ¡ *
Ënmod
) {

1007 
size_t
 
l
 = 
	`¡¾’
(
fÜm
);

1008 
size_t
 
lm
 = 
	`¡¾’
(
Ënmod
);

1009 
¥ec
 = 
fÜm
[
l
 - 1];

1010 
	`¡rıy
(
fÜm
 + 
l
 - 1, 
Ënmod
);

1011 
fÜm
[
l
 + 
lm
 - 1] = 
¥ec
;

1012 
fÜm
[
l
 + 
lm
] = '\0';

1013 
	}
}

1016 
	$¡r_fÜm©
 (
lua_S‹
 *
L
) {

1017 
tİ
 = 
	`lua_g‘tİ
(
L
);

1018 
¬g
 = 1;

1019 
size_t
 
sæ
;

1020 cÚ¡ *
¡rämt
 = 
	`luaL_checkl¡ršg
(
L
, 
¬g
, &
sæ
);

1021 cÚ¡ *
¡rämt_’d
 = 
¡rämt
+
sæ
;

1022 
luaL_Bufãr
 
b
;

1023 
	`luaL_buffš™
(
L
, &
b
);

1024 
¡rämt
 < 
¡rämt_’d
) {

1025 ià(*
¡rämt
 !ğ
L_ESC
)

1026 
	`luaL_addch¬
(&
b
, *
¡rämt
++);

1027 ià(*++
¡rämt
 =ğ
L_ESC
)

1028 
	`luaL_addch¬
(&
b
, *
¡rämt
++);

1030 
fÜm
[
MAX_FORMAT
];

1031 *
buff
 = 
	`luaL_´•buffsize
(&
b
, 
MAX_ITEM
);

1032 
nb
 = 0;

1033 ià(++
¬g
 > 
tİ
)

1034 
	`luaL_¬g”rÜ
(
L
, 
¬g
, "no value");

1035 
¡rämt
 = 
	`sÿnfÜm©
(
L
, sŒämt, 
fÜm
);

1036 *
¡rämt
++) {

1038 
nb
 = 
	`l_¥rštf
(
buff
, 
MAX_ITEM
, 
fÜm
, ()
	`luaL_checkš‹g”
(
L
, 
¬g
));

1043 
lua_IÁeg”
 
n
 = 
	`luaL_checkš‹g”
(
L
, 
¬g
);

1044 
	`addËnmod
(
fÜm
, 
LUA_INTEGER_FRMLEN
);

1045 
nb
 = 
	`l_¥rštf
(
buff
, 
MAX_ITEM
, 
fÜm
, (
LUAI_UACINT
)
n
);

1049 
	`addËnmod
(
fÜm
, 
LUA_NUMBER_FRMLEN
);

1050 
nb
 = 
	`lua_numb”2¡rx
(
L
, 
buff
, 
MAX_ITEM
, 
fÜm
,

1051 
	`luaL_checknumb”
(
L
, 
¬g
));

1055 
lua_Numb”
 
n
 = 
	`luaL_checknumb”
(
L
, 
¬g
);

1056 
	`addËnmod
(
fÜm
, 
LUA_NUMBER_FRMLEN
);

1057 
nb
 = 
	`l_¥rštf
(
buff
, 
MAX_ITEM
, 
fÜm
, (
LUAI_UACNUMBER
)
n
);

1061 
	`addl™”®
(
L
, &
b
, 
¬g
);

1065 
size_t
 
l
;

1066 cÚ¡ *
s
 = 
	`luaL_tŞ¡ršg
(
L
, 
¬g
, &
l
);

1067 ià(
fÜm
[2] == '\0')

1068 
	`luaL_addv®ue
(&
b
);

1070 
	`luaL_¬gcheck
(
L
, 
l
 =ğ
	`¡¾’
(
s
), 
¬g
, "string contains zeros");

1071 ià(!
	`¡rchr
(
fÜm
, '.'è&& 
l
 >= 100) {

1073 
	`luaL_addv®ue
(&
b
);

1076 
nb
 = 
	`l_¥rštf
(
buff
, 
MAX_ITEM
, 
fÜm
, 
s
);

1077 
	`lua_pİ
(
L
, 1);

1083  
	`luaL_”rÜ
(
L
, "invalid option '%%%c'o 'format'",

1084 *(
¡rämt
 - 1));

1087 
	`lua_as£¹
(
nb
 < 
MAX_ITEM
);

1088 
	`luaL_addsize
(&
b
, 
nb
);

1091 
	`luaL_push»suÉ
(&
b
);

1093 
	}
}

1106 #ià!
defšed
(
LUAL_PACKPADBYTE
)

1107 
	#LUAL_PACKPADBYTE
 0x00

	)

1111 
	#MAXINTSIZE
 16

	)

1114 
	#NB
 
CHAR_BIT


	)

1117 
	#MC
 ((1 << 
NB
è- 1)

	)

1120 
	#SZINT
 (()(
lua_IÁeg”
))

	)

1125 
	mdummy
;

1126 
	ml™e
;

1127 } 
	gÇtiv“ndŸn
 = {1};

1131 
	scD
 {

1132 
	mc
;

1133 uniÚ { 
	md
; *
	mp
; 
lua_IÁeg”
 
	mi
; 
lua_Numb”
 
	mn
; } 
	mu
;

1136 
	#MAXALIGN
 (
	`off£tof
(
cD
, 
u
))

	)

1142 
	uFty³s
 {

1143 
	mf
;

1144 
	md
;

1145 
lua_Numb”
 
	mn
;

1146 
	mbuff
[5 * (
lua_Numb”
)];

1147 } 
	tFty³s
;

1153 
	sH—d”
 {

1154 
lua_S‹
 *
	mL
;

1155 
	mi¦™e
;

1156 
	mmax®ign
;

1157 } 
	tH—d”
;

1163 
	eKO±iÚ
 {

1164 
	mKšt
,

1165 
	mKušt
,

1166 
	mKæßt
,

1167 
	mKch¬
,

1168 
	mK¡ršg
,

1169 
	mKz¡r
,

1170 
	mK·ddšg
,

1171 
	mK·dd®ign
,

1172 
	mKnİ


1173 } 
	tKO±iÚ
;

1180 
	$dig™
 (
c
è{  '0' <ğø&& c <ğ'9'; 
	}
}

1182 
	$g‘num
 (cÚ¡ **
fmt
, 
df
) {

1183 ià(!
	`dig™
(**
fmt
))

1184  
df
;

1186 
a
 = 0;

1188 
a
 =‡*10 + (*((*
fmt
)++) - '0');

1189 } 
	`dig™
(**
fmt
è&& 
a
 <ğ(()
MAXSIZE
 - 9)/10);

1190  
a
;

1192 
	}
}

1199 
	$g‘numlim™
 (
H—d”
 *
h
, cÚ¡ **
fmt
, 
df
) {

1200 
sz
 = 
	`g‘num
(
fmt
, 
df
);

1201 ià(
sz
 > 
MAXINTSIZE
 || sz <= 0)

1202 
	`luaL_”rÜ
(
h
->
L
, "integral size (%d) out of†imits [1,%d]",

1203 
sz
, 
MAXINTSIZE
);

1204  
sz
;

1205 
	}
}

1211 
	$š™h—d”
 (
lua_S‹
 *
L
, 
H—d”
 *
h
) {

1212 
h
->
L
 = L;

1213 
h
->
i¦™e
 = 
Çtiv“ndŸn
.
l™e
;

1214 
h
->
max®ign
 = 1;

1215 
	}
}

1221 
KO±iÚ
 
	$g‘İtiÚ
 (
H—d”
 *
h
, cÚ¡ **
fmt
, *
size
) {

1222 
İt
 = *((*
fmt
)++);

1223 *
size
 = 0;

1224 
İt
) {

1225 'b': *
size
 = ();  
Kšt
;

1226 'B': *
size
 = ();  
Kušt
;

1227 'h': *
size
 = ();  
Kšt
;

1228 'H': *
size
 = ();  
Kušt
;

1229 'l': *
size
 = ();  
Kšt
;

1230 'L': *
size
 = ();  
Kušt
;

1231 'j': *
size
 = (
lua_IÁeg”
);  
Kšt
;

1232 'J': *
size
 = (
lua_IÁeg”
);  
Kušt
;

1233 'T': *
size
 = (
size_t
);  
Kušt
;

1234 'f': *
size
 = ();  
Kæßt
;

1235 'd': *
size
 = ();  
Kæßt
;

1236 'n': *
size
 = (
lua_Numb”
);  
Kæßt
;

1237 'i': *
size
 = 
	`g‘numlim™
(
h
, 
fmt
, ());  
Kšt
;

1238 'I': *
size
 = 
	`g‘numlim™
(
h
, 
fmt
, ());  
Kušt
;

1239 's': *
size
 = 
	`g‘numlim™
(
h
, 
fmt
, (
size_t
));  
K¡ršg
;

1241 *
size
 = 
	`g‘num
(
fmt
, -1);

1242 ià(*
size
 == -1)

1243 
	`luaL_”rÜ
(
h
->
L
, "missing size for format option 'c'");

1244  
Kch¬
;

1245 'z':  
Kz¡r
;

1246 'x': *
size
 = 1;  
K·ddšg
;

1247 'X':  
K·dd®ign
;

1249 '<': 
h
->
i¦™e
 = 1; ;

1250 '>': 
h
->
i¦™e
 = 0; ;

1251 '=': 
h
->
i¦™e
 = 
Çtiv“ndŸn
.
l™e
; ;

1252 '!': 
h
->
max®ign
 = 
	`g‘numlim™
(h, 
fmt
, 
MAXALIGN
); ;

1253 : 
	`luaL_”rÜ
(
h
->
L
, "šv®id fÜm© o±iÚ '%c'", 
İt
);

1255  
Knİ
;

1256 
	}
}

1268 
KO±iÚ
 
	$g‘d‘as
 (
H—d”
 *
h
, 
size_t
 
tÙ®size
,

1269 cÚ¡ **
fmt
, *
psize
, *
Áßlign
) {

1270 
KO±iÚ
 
İt
 = 
	`g‘İtiÚ
(
h
, 
fmt
, 
psize
);

1271 
®ign
 = *
psize
;

1272 ià(
İt
 =ğ
K·dd®ign
) {

1273 ià(**
fmt
 =ğ'\0' || 
	`g‘İtiÚ
(
h
, fmt, &
®ign
è=ğ
Kch¬
 ||‡lign == 0)

1274 
	`luaL_¬g”rÜ
(
h
->
L
, 1, "invalid‚ext option for option 'X'");

1276 ià(
®ign
 <ğ1 || 
İt
 =ğ
Kch¬
)

1277 *
Áßlign
 = 0;

1279 ià(
®ign
 > 
h
->
max®ign
)

1280 
®ign
 = 
h
->
max®ign
;

1281 ià((
®ign
 & (align - 1)) != 0)

1282 
	`luaL_¬g”rÜ
(
h
->
L
, 1, "format‡sks for‡lignment‚ot…ower of 2");

1283 *
Áßlign
 = (
®ign
 - ()(
tÙ®size
 & (align - 1))) & (align - 1);

1285  
İt
;

1286 
	}
}

1295 
	$·ckšt
 (
luaL_Bufãr
 *
b
, 
lua_UnsigÃd
 
n
,

1296 
i¦™e
, 
size
, 
Ãg
) {

1297 *
buff
 = 
	`luaL_´•buffsize
(
b
, 
size
);

1298 
i
;

1299 
buff
[
i¦™e
 ? 0 : 
size
 - 1] = ()(
n
 & 
MC
);

1300 
i
 = 1; i < 
size
; i++) {

1301 
n
 >>ğ
NB
;

1302 
buff
[
i¦™e
 ? 
i
 : 
size
 - 1 - i] = ()(
n
 & 
MC
);

1304 ià(
Ãg
 && 
size
 > 
SZINT
) {

1305 
i
 = 
SZINT
; i < 
size
; i++)

1306 
buff
[
i¦™e
 ? 
i
 : 
size
 - 1 - i] = ()
MC
;

1308 
	`luaL_addsize
(
b
, 
size
);

1309 
	}
}

1316 
	$cİyw™h’dŸn
 (vŞ©*
de¡
, vŞ©cÚ¡ *
¤c
,

1317 
size
, 
i¦™e
) {

1318 ià(
i¦™e
 =ğ
Çtiv“ndŸn
.
l™e
) {

1319 
size
-- != 0)

1320 *(
de¡
++èğ*(
¤c
++);

1323 
de¡
 +ğ
size
 - 1;

1324 
size
-- != 0)

1325 *(
de¡
--èğ*(
¤c
++);

1327 
	}
}

1330 
	$¡r_·ck
 (
lua_S‹
 *
L
) {

1331 
luaL_Bufãr
 
b
;

1332 
H—d”
 
h
;

1333 cÚ¡ *
fmt
 = 
	`luaL_check¡ršg
(
L
, 1);

1334 
¬g
 = 1;

1335 
size_t
 
tÙ®size
 = 0;

1336 
	`š™h—d”
(
L
, &
h
);

1337 
	`lua_pushn
(
L
);

1338 
	`luaL_buffš™
(
L
, &
b
);

1339 *
fmt
 != '\0') {

1340 
size
, 
Áßlign
;

1341 
KO±iÚ
 
İt
 = 
	`g‘d‘as
(&
h
, 
tÙ®size
, &
fmt
, &
size
, &
Áßlign
);

1342 
tÙ®size
 +ğ
Áßlign
 + 
size
;

1343 
Áßlign
-- > 0)

1344 
	`luaL_addch¬
(&
b
, 
LUAL_PACKPADBYTE
);

1345 
¬g
++;

1346 
İt
) {

1347 
Kšt
: {

1348 
lua_IÁeg”
 
n
 = 
	`luaL_checkš‹g”
(
L
, 
¬g
);

1349 ià(
size
 < 
SZINT
) {

1350 
lua_IÁeg”
 
lim
 = (lua_IÁeg”)1 << ((
size
 * 
NB
) - 1);

1351 
	`luaL_¬gcheck
(
L
, -
lim
 <ğ
n
 &&‚ <†im, 
¬g
, "integer overflow");

1353 
	`·ckšt
(&
b
, (
lua_UnsigÃd
)
n
, 
h
.
i¦™e
, 
size
, (n < 0));

1356 
Kušt
: {

1357 
lua_IÁeg”
 
n
 = 
	`luaL_checkš‹g”
(
L
, 
¬g
);

1358 ià(
size
 < 
SZINT
)

1359 
	`luaL_¬gcheck
(
L
, (
lua_UnsigÃd
)
n
 < (Öua_UnsigÃd)1 << (
size
 * 
NB
)),

1360 
¬g
, "unsigned overflow");

1361 
	`·ckšt
(&
b
, (
lua_UnsigÃd
)
n
, 
h
.
i¦™e
, 
size
, 0);

1364 
Kæßt
: {

1365 vŞ©
Fty³s
 
u
;

1366 *
buff
 = 
	`luaL_´•buffsize
(&
b
, 
size
);

1367 
lua_Numb”
 
n
 = 
	`luaL_checknumb”
(
L
, 
¬g
);

1368 ià(
size
 =ğ(
u
.
f
)èu.àğ()
n
;

1369 ià(
size
 =ğ(
u
.
d
)èu.d = ()
n
;

1370 
u
.
n
 =‚;

1372 
	`cİyw™h’dŸn
(
buff
, 
u
.buff, 
size
, 
h
.
i¦™e
);

1373 
	`luaL_addsize
(&
b
, 
size
);

1376 
Kch¬
: {

1377 
size_t
 
Ën
;

1378 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 
¬g
, &
Ën
);

1379 
	`luaL_¬gcheck
(
L
, 
Ën
 <ğ(
size_t
)
size
, 
¬g
,

1381 
	`luaL_addl¡ršg
(&
b
, 
s
, 
Ën
);

1382 
Ën
++ < (
size_t
)
size
)

1383 
	`luaL_addch¬
(&
b
, 
LUAL_PACKPADBYTE
);

1386 
K¡ršg
: {

1387 
size_t
 
Ën
;

1388 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 
¬g
, &
Ën
);

1389 
	`luaL_¬gcheck
(
L
, 
size
 >ğ()(
size_t
) ||

1390 
Ën
 < ((
size_t
)1 << (
size
 * 
NB
)),

1391 
¬g
, "string†ength does‚ot fit in given size");

1392 
	`·ckšt
(&
b
, (
lua_UnsigÃd
)
Ën
, 
h
.
i¦™e
, 
size
, 0);

1393 
	`luaL_addl¡ršg
(&
b
, 
s
, 
Ën
);

1394 
tÙ®size
 +ğ
Ën
;

1397 
Kz¡r
: {

1398 
size_t
 
Ën
;

1399 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 
¬g
, &
Ën
);

1400 
	`luaL_¬gcheck
(
L
, 
	`¡¾’
(
s
è=ğ
Ën
, 
¬g
, "string contains zeros");

1401 
	`luaL_addl¡ršg
(&
b
, 
s
, 
Ën
);

1402 
	`luaL_addch¬
(&
b
, '\0');

1403 
tÙ®size
 +ğ
Ën
 + 1;

1406 
K·ddšg
: 
	`luaL_addch¬
(&
b
, 
LUAL_PACKPADBYTE
);

1407 
K·dd®ign
: 
Knİ
:

1408 
¬g
--;

1412 
	`luaL_push»suÉ
(&
b
);

1414 
	}
}

1417 
	$¡r_·cksize
 (
lua_S‹
 *
L
) {

1418 
H—d”
 
h
;

1419 cÚ¡ *
fmt
 = 
	`luaL_check¡ršg
(
L
, 1);

1420 
size_t
 
tÙ®size
 = 0;

1421 
	`š™h—d”
(
L
, &
h
);

1422 *
fmt
 != '\0') {

1423 
size
, 
Áßlign
;

1424 
KO±iÚ
 
İt
 = 
	`g‘d‘as
(&
h
, 
tÙ®size
, &
fmt
, &
size
, &
Áßlign
);

1425 
size
 +ğ
Áßlign
;

1426 
	`luaL_¬gcheck
(
L
, 
tÙ®size
 <ğ
MAXSIZE
 - 
size
, 1,

1428 
tÙ®size
 +ğ
size
;

1429 
İt
) {

1430 
K¡ršg
:

1431 
Kz¡r
:

1432 
	`luaL_¬g”rÜ
(
L
, 1, "variable-length format");

1437 
	`lua_pushš‹g”
(
L
, (
lua_IÁeg”
)
tÙ®size
);

1439 
	}
}

1450 
lua_IÁeg”
 
	$uÅackšt
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
,

1451 
i¦™e
, 
size
, 
issigÃd
) {

1452 
lua_UnsigÃd
 
»s
 = 0;

1453 
i
;

1454 
lim™
 = (
size
 <ğ
SZINT
) ? size : SZINT;

1455 
i
 = 
lim™
 - 1; i >= 0; i--) {

1456 
»s
 <<ğ
NB
;

1457 
»s
 |ğ(
lua_UnsigÃd
)()
¡r
[
i¦™e
 ? 
i
 : 
size
 - 1 - i];

1459 ià(
size
 < 
SZINT
) {

1460 ià(
issigÃd
) {

1461 
lua_UnsigÃd
 
mask
 = (lua_UnsigÃd)1 << (
size
*
NB
 - 1);

1462 
»s
 = (Ôe ^ 
mask
) - mask);

1465 ià(
size
 > 
SZINT
) {

1466 
mask
 = (!
issigÃd
 || (
lua_IÁeg”
)
»s
 >ğ0è? 0 : 
MC
;

1467 
i
 = 
lim™
; i < 
size
; i++) {

1468 ià(()
¡r
[
i¦™e
 ? 
i
 : 
size
 - 1 - i] !ğ
mask
)

1469 
	`luaL_”rÜ
(
L
, "%d-by‹ iÁeg” dÛ nÙ f™ iÁØLu¨IÁeg”", 
size
);

1472  (
lua_IÁeg”
)
»s
;

1473 
	}
}

1476 
	$¡r_uÅack
 (
lua_S‹
 *
L
) {

1477 
H—d”
 
h
;

1478 cÚ¡ *
fmt
 = 
	`luaL_check¡ršg
(
L
, 1);

1479 
size_t
 
ld
;

1480 cÚ¡ *
d©a
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
ld
);

1481 
size_t
 
pos
 = (size_t)
	`po¤–©
(
	`luaL_İtš‹g”
(
L
, 3, 1), 
ld
) - 1;

1482 
n
 = 0;

1483 
	`luaL_¬gcheck
(
L
, 
pos
 <ğ
ld
, 3, "initial…osition out of string");

1484 
	`š™h—d”
(
L
, &
h
);

1485 *
fmt
 != '\0') {

1486 
size
, 
Áßlign
;

1487 
KO±iÚ
 
İt
 = 
	`g‘d‘as
(&
h
, 
pos
, &
fmt
, &
size
, &
Áßlign
);

1488 ià((
size_t
)
Áßlign
 + 
size
 > ~
pos
 ||…o +‚tßligÀ+ siz> 
ld
)

1489 
	`luaL_¬g”rÜ
(
L
, 2, "data stringoo short");

1490 
pos
 +ğ
Áßlign
;

1492 
	`luaL_check¡ack
(
L
, 2, "too many„esults");

1493 
n
++;

1494 
İt
) {

1495 
Kšt
:

1496 
Kušt
: {

1497 
lua_IÁeg”
 
»s
 = 
	`uÅackšt
(
L
, 
d©a
 + 
pos
, 
h
.
i¦™e
, 
size
,

1498 (
İt
 =ğ
Kšt
));

1499 
	`lua_pushš‹g”
(
L
, 
»s
);

1502 
Kæßt
: {

1503 vŞ©
Fty³s
 
u
;

1504 
lua_Numb”
 
num
;

1505 
	`cİyw™h’dŸn
(
u
.
buff
, 
d©a
 + 
pos
, 
size
, 
h
.
i¦™e
);

1506 ià(
size
 =ğ(
u
.
f
)è
num
 = (
lua_Numb”
)u.f;

1507 ià(
size
 =ğ(
u
.
d
)è
num
 = (
lua_Numb”
)u.d;

1508 
num
 = 
u
.
n
;

1509 
	`lua_pushnumb”
(
L
, 
num
);

1512 
Kch¬
: {

1513 
	`lua_pushl¡ršg
(
L
, 
d©a
 + 
pos
, 
size
);

1516 
K¡ršg
: {

1517 
size_t
 
Ën
 = (size_t)
	`uÅackšt
(
L
, 
d©a
 + 
pos
, 
h
.
i¦™e
, 
size
, 0);

1518 
	`luaL_¬gcheck
(
L
, 
pos
 + 
Ën
 + 
size
 <ğ
ld
, 2, "data stringoo short");

1519 
	`lua_pushl¡ršg
(
L
, 
d©a
 + 
pos
 + 
size
, 
Ën
);

1520 
pos
 +ğ
Ën
;

1523 
Kz¡r
: {

1524 
size_t
 
Ën
 = ()
	`¡¾’
(
d©a
 + 
pos
);

1525 
	`lua_pushl¡ršg
(
L
, 
d©a
 + 
pos
, 
Ën
);

1526 
pos
 +ğ
Ën
 + 1;

1529 
K·dd®ign
: 
K·ddšg
: 
Knİ
:

1530 
n
--;

1533 
pos
 +ğ
size
;

1535 
	`lua_pushš‹g”
(
L
, 
pos
 + 1);

1536  
n
 + 1;

1537 
	}
}

1542 cÚ¡ 
luaL_Reg
 
	g¡¾ib
[] = {

1543 {"by‹", 
¡r_by‹
},

1544 {"ch¬", 
¡r_ch¬
},

1545 {"dump", 
¡r_dump
},

1546 {"fšd", 
¡r_fšd
},

1547 {"fÜm©", 
¡r_fÜm©
},

1548 {"gm©ch", 
gm©ch
},

1549 {"gsub", 
¡r_gsub
},

1550 {"Ën", 
¡r_Ën
},

1551 {"low”", 
¡r_low”
},

1552 {"m©ch", 
¡r_m©ch
},

1553 {"»p", 
¡r_»p
},

1554 {"»v”£", 
¡r_»v”£
},

1555 {"sub", 
¡r_sub
},

1556 {"uµ”", 
¡r_uµ”
},

1557 {"·ck", 
¡r_·ck
},

1558 {"·cksize", 
¡r_·cksize
},

1559 {"uÅack", 
¡r_uÅack
},

1560 {
NULL
, NULL}

1564 
	$ü—‹m‘©abË
 (
lua_S‹
 *
L
) {

1565 
	`lua_ü—‹bË
(
L
, 0, 1);

1566 
	`lua_pushl™”®
(
L
, "");

1567 
	`lua_pushv®ue
(
L
, -2);

1568 
	`lua_£tm‘©abË
(
L
, -2);

1569 
	`lua_pİ
(
L
, 1);

1570 
	`lua_pushv®ue
(
L
, -2);

1571 
	`lua_£tf›ld
(
L
, -2, "__index");

1572 
	`lua_pİ
(
L
, 1);

1573 
	}
}

1579 
LUAMOD_API
 
	$luaİ’_¡ršg
 (
lua_S‹
 *
L
) {

1580 
	`luaL_Ãwlib
(
L
, 
¡¾ib
);

1581 
	`ü—‹m‘©abË
(
L
);

1583 
	}
}

	@script/lua/lua-5.3.4/src/ltable.c

7 
	#ÉabË_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

26 
	~<m©h.h
>

27 
	~<lim™s.h
>

29 
	~"lua.h
"

31 
	~"ldebug.h
"

32 
	~"ldo.h
"

33 
	~"lgc.h
"

34 
	~"lmem.h
"

35 
	~"lobjeù.h
"

36 
	~"l¡©e.h
"

37 
	~"l¡ršg.h
"

38 
	~"ÉabË.h
"

39 
	~"lvm.h
"

46 
	#MAXABITS
 
	`ÿ¡_št
((è* 
CHAR_BIT
 - 1)

	)

47 
	#MAXASIZE
 (1u << 
MAXABITS
)

	)

55 
	#MAXHBITS
 (
MAXABITS
 - 1)

	)

58 
	#hashpow2
(
t
,
n
è(
	`gnode
Ñ, 
	`lmod
(Ò), 
	`siz’ode
Ñ))))

	)

60 
	#hash¡r
(
t
,
¡r
è
	`hashpow2
Ñ, (¡r)->
hash
)

	)

61 
	#hashboŞ—n
(
t
,
p
è
	`hashpow2
Ñ,…)

	)

62 
	#hashšt
(
t
,
i
è
	`hashpow2
Ñ, i)

	)

69 
	#hashmod
(
t
,
n
è(
	`gnode
Ñ, (Òè% ((
	`siz’ode
Ñ)-1)|1))))

	)

72 
	#hashpoš‹r
(
t
,
p
è
	`hashmod
Ñ, 
	`pošt2ušt
Õ))

	)

75 
	#dummynode
 (&
dummynode_
)

	)

77 cÚ¡ 
Node
 
	gdummynode_
 = {

78 {
NILCONSTANT
},

79 {{
NILCONSTANT
, 0}}

96 #ià!
defšed
(
l_hashæßt
)

97 
	$l_hashæßt
 (
lua_Numb”
 
n
) {

98 
i
;

99 
lua_IÁeg”
 
ni
;

100 
n
 = 
	`l_m©hİ
(
äexp
)Ò, &
i
è* -
	`ÿ¡_num
(
INT_MIN
);

101 ià(!
	`lua_numb”toš‹g”
(
n
, &
ni
)) {

102 
	`lua_as£¹
(
	`luai_numi¢ª
(
n
è|| 
	`l_m©hİ
(
çbs
)Òè=ğ
	`ÿ¡_num
(
HUGE_VAL
));

106 
u
 = 
	`ÿ¡
(, 
i
è+ ca¡(, 
ni
);

107  
	`ÿ¡_št
(
u
 <ğ
	`ÿ¡
(, 
INT_MAX
) ? u : ~u);

109 
	}
}

117 
Node
 *
	$mašpos™iÚ
 (cÚ¡ 
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
) {

118 
	`‰y³
(
key
)) {

119 
LUA_TNUMINT
:

120  
	`hashšt
(
t
, 
	`iv®ue
(
key
));

121 
LUA_TNUMFLT
:

122  
	`hashmod
(
t
, 
	`l_hashæßt
(
	`ætv®ue
(
key
)));

123 
LUA_TSHRSTR
:

124  
	`hash¡r
(
t
, 
	`tsv®ue
(
key
));

125 
LUA_TLNGSTR
:

126  
	`hashpow2
(
t
, 
	`luaS_hashlÚg¡r
(
	`tsv®ue
(
key
)));

127 
LUA_TBOOLEAN
:

128  
	`hashboŞ—n
(
t
, 
	`bv®ue
(
key
));

129 
LUA_TLIGHTUSERDATA
:

130  
	`hashpoš‹r
(
t
, 
	`pv®ue
(
key
));

131 
LUA_TLCF
:

132  
	`hashpoš‹r
(
t
, 
	`fv®ue
(
key
));

134 
	`lua_as£¹
(!
	`‰isd—dkey
(
key
));

135  
	`hashpoš‹r
(
t
, 
	`gcv®ue
(
key
));

137 
	}
}

144 
	$¬¿yšdex
 (cÚ¡ 
TV®ue
 *
key
) {

145 ià(
	`‰isš‹g”
(
key
)) {

146 
lua_IÁeg”
 
k
 = 
	`iv®ue
(
key
);

147 ià(0 < 
k
 && (
lua_UnsigÃd
)k <ğ
MAXASIZE
)

148  
	`ÿ¡
(, 
k
);

151 
	}
}

159 
	$fšdšdex
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
StkId
 
key
) {

160 
i
;

161 ià(
	`‰i¢
(
key
))  0;

162 
i
 = 
	`¬¿yšdex
(
key
);

163 ià(
i
 !ğ0 && i <ğ
t
->
siz—¼ay
)

164  
i
;

166 
nx
;

167 
Node
 *
n
 = 
	`mašpos™iÚ
(
t
, 
key
);

170 ià(
	`luaV_¿wequ®obj
(
	`gkey
(
n
), 
key
) ||

171 (
	`‰isd—dkey
(
	`gkey
(
n
)è&& 
	`iscŞËùabË
(
key
) &&

172 
	`d—dv®ue
(
	`gkey
(
n
)è=ğ
	`gcv®ue
(
key
))) {

173 
i
 = 
	`ÿ¡_št
(
n
 - 
	`gnode
(
t
, 0));

175  (
i
 + 1è+ 
t
->
siz—¼ay
;

177 
nx
 = 
	`gÃxt
(
n
);

178 ià(
nx
 == 0)

179 
	`luaG_ruÃ¼Ü
(
L
, "invalid keyo 'next'");

180 
n
 +ğ
nx
;

183 
	}
}

186 
	$luaH_Ãxt
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
StkId
 
key
) {

187 
i
 = 
	`fšdšdex
(
L
, 
t
, 
key
);

188 ; 
i
 < 
t
->
siz—¼ay
; i++) {

189 ià(!
	`‰i¢
(&
t
->
¬¿y
[
i
])) {

190 
	`£tiv®ue
(
key
, 
i
 + 1);

191 
	`£tobj2s
(
L
, 
key
+1, &
t
->
¬¿y
[
i
]);

195 
i
 -ğ
t
->
siz—¼ay
; 
	`ÿ¡_št
(iè< 
	`siz’ode
(t); i++) {

196 ià(!
	`‰i¢
(
	`gv®
(
	`gnode
(
t
, 
i
)))) {

197 
	`£tobj2s
(
L
, 
key
, 
	`gkey
(
	`gnode
(
t
, 
i
)));

198 
	`£tobj2s
(
L
, 
key
+1, 
	`gv®
(
	`gnode
(
t
, 
i
)));

203 
	}
}

219 
	$compu‹sizes
 (
nums
[], *
²a
) {

220 
i
;

221 
twÙoi
;

222 
a
 = 0;

223 
Ç
 = 0;

224 
İtim®
 = 0;

226 
i
 = 0, 
twÙoi
 = 1; *
²a
 >wotoi / 2; i++,wotoi *= 2) {

227 ià(
nums
[
i
] > 0) {

228 
a
 +ğ
nums
[
i
];

229 ià(
a
 > 
twÙoi
/2) {

230 
İtim®
 = 
twÙoi
;

231 
Ç
 = 
a
;

235 
	`lua_as£¹
((
İtim®
 =ğ0 || o±im® / 2 < 
Ç
) &&‚a <= optimal);

236 *
²a
 = 
Ç
;

237  
İtim®
;

238 
	}
}

241 
	$couÁšt
 (cÚ¡ 
TV®ue
 *
key
, *
nums
) {

242 
k
 = 
	`¬¿yšdex
(
key
);

243 ià(
k
 != 0) {

244 
nums
[
	`luaO_ûlog2
(
k
)]++;

249 
	}
}

257 
	$numu£¬¿y
 (cÚ¡ 
TabË
 *
t
, *
nums
) {

258 
lg
;

259 
‰lg
;

260 
au£
 = 0;

261 
i
 = 1;

263 
lg
 = 0, 
‰lg
 = 1;†g <ğ
MAXABITS
;†g++,tlg *= 2) {

264 
lc
 = 0;

265 
lim
 = 
‰lg
;

266 ià(
lim
 > 
t
->
siz—¼ay
) {

267 
lim
 = 
t
->
siz—¼ay
;

268 ià(
i
 > 
lim
)

272 ; 
i
 <ğ
lim
; i++) {

273 ià(!
	`‰i¢
(&
t
->
¬¿y
[
i
-1]))

274 
lc
++;

276 
nums
[
lg
] +ğ
lc
;

277 
au£
 +ğ
lc
;

279  
au£
;

280 
	}
}

283 
	$numu£hash
 (cÚ¡ 
TabË
 *
t
, *
nums
, *
²a
) {

284 
tÙ®u£
 = 0;

285 
au£
 = 0;

286 
i
 = 
	`siz’ode
(
t
);

287 
i
--) {

288 
Node
 *
n
 = &
t
->
node
[
i
];

289 ià(!
	`‰i¢
(
	`gv®
(
n
))) {

290 
au£
 +ğ
	`couÁšt
(
	`gkey
(
n
), 
nums
);

291 
tÙ®u£
++;

294 *
²a
 +ğ
au£
;

295  
tÙ®u£
;

296 
	}
}

299 
	$£¼ayveùÜ
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
size
) {

300 
i
;

301 
	`luaM_»®locveùÜ
(
L
, 
t
->
¬¿y
,->
siz—¼ay
, 
size
, 
TV®ue
);

302 
i
=
t
->
siz—¼ay
; i<
size
; i++)

303 
	`£Šv®ue
(&
t
->
¬¿y
[
i
]);

304 
t
->
siz—¼ay
 = 
size
;

305 
	}
}

308 
	$£ŠodeveùÜ
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
size
) {

309 ià(
size
 == 0) {

310 
t
->
node
 = 
	`ÿ¡
(
Node
 *, 
dummynode
);

311 
t
->
lsiz’ode
 = 0;

312 
t
->
Ï¡ä“
 = 
NULL
;

315 
i
;

316 
lsize
 = 
	`luaO_ûlog2
(
size
);

317 ià(
lsize
 > 
MAXHBITS
)

318 
	`luaG_ruÃ¼Ü
(
L
, "table overflow");

319 
size
 = 
	`twÙo
(
lsize
);

320 
t
->
node
 = 
	`luaM_ÃwveùÜ
(
L
, 
size
, 
Node
);

321 
i
 = 0; i < ()
size
; i++) {

322 
Node
 *
n
 = 
	`gnode
(
t
, 
i
);

323 
	`gÃxt
(
n
) = 0;

324 
	`£Šv®ue
(
	`wgkey
(
n
));

325 
	`£Šv®ue
(
	`gv®
(
n
));

327 
t
->
lsiz’ode
 = 
	`ÿ¡_by‹
(
lsize
);

328 
t
->
Ï¡ä“
 = 
	`gnode
Ñ, 
size
);

330 
	}
}

333 
	$luaH_»size
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
Çsize
,

334 
nhsize
) {

335 
i
;

336 
j
;

337 
Şdasize
 = 
t
->
siz—¼ay
;

338 
Şdhsize
 = 
	`®locsiz’ode
(
t
);

339 
Node
 *
nŞd
 = 
t
->
node
;

340 ià(
Çsize
 > 
Şdasize
)

341 
	`£¼ayveùÜ
(
L
, 
t
, 
Çsize
);

343 
	`£ŠodeveùÜ
(
L
, 
t
, 
nhsize
);

344 ià(
Çsize
 < 
Şdasize
) {

345 
t
->
siz—¼ay
 = 
Çsize
;

347 
i
=
Çsize
; i<
Şdasize
; i++) {

348 ià(!
	`‰i¢
(&
t
->
¬¿y
[
i
]))

349 
	`luaH_£tšt
(
L
, 
t
, 
i
 + 1, &t->
¬¿y
[i]);

352 
	`luaM_»®locveùÜ
(
L
, 
t
->
¬¿y
, 
Şdasize
, 
Çsize
, 
TV®ue
);

355 
j
 = 
Şdhsize
 - 1; j >= 0; j--) {

356 
Node
 *
Şd
 = 
nŞd
 + 
j
;

357 ià(!
	`‰i¢
(
	`gv®
(
Şd
))) {

360 
	`£tobjt2t
(
L
, 
	`luaH_£t
(L, 
t
, 
	`gkey
(
Şd
)), 
	`gv®
(old));

363 ià(
Şdhsize
 > 0)

364 
	`luaM_ä“¬¿y
(
L
, 
nŞd
, 
	`ÿ¡
(
size_t
, 
Şdhsize
));

365 
	}
}

368 
	$luaH_»siz—¼ay
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
Çsize
) {

369 
nsize
 = 
	`®locsiz’ode
(
t
);

370 
	`luaH_»size
(
L
, 
t
, 
Çsize
, 
nsize
);

371 
	}
}

376 
	$»hash
 (
lua_S‹
 *
L
, 
TabË
 *
t
, cÚ¡ 
TV®ue
 *
ek
) {

377 
asize
;

378 
Ç
;

379 
nums
[
MAXABITS
 + 1];

380 
i
;

381 
tÙ®u£
;

382 
i
 = 0; i <ğ
MAXABITS
; i++è
nums
[i] = 0;

383 
Ç
 = 
	`numu£¬¿y
(
t
, 
nums
);

384 
tÙ®u£
 = 
Ç
;

385 
tÙ®u£
 +ğ
	`numu£hash
(
t
, 
nums
, &
Ç
);

387 
Ç
 +ğ
	`couÁšt
(
ek
, 
nums
);

388 
tÙ®u£
++;

390 
asize
 = 
	`compu‹sizes
(
nums
, &
Ç
);

392 
	`luaH_»size
(
L
, 
t
, 
asize
, 
tÙ®u£
 - 
Ç
);

393 
	}
}

402 
TabË
 *
	$luaH_Ãw
 (
lua_S‹
 *
L
) {

403 
GCObjeù
 *
o
 = 
	`luaC_Ãwobj
(
L
, 
LUA_TTABLE
, (
TabË
));

404 
TabË
 *
t
 = 
	`gco2t
(
o
);

405 
t
->
m‘©abË
 = 
NULL
;

406 
t
->
æags
 = 
	`ÿ¡_by‹
(~0);

407 
t
->
¬¿y
 = 
NULL
;

408 
t
->
siz—¼ay
 = 0;

409 
	`£ŠodeveùÜ
(
L
, 
t
, 0);

410  
t
;

411 
	}
}

414 
	$luaH_ä“
 (
lua_S‹
 *
L
, 
TabË
 *
t
) {

415 ià(!
	`isdummy
(
t
))

416 
	`luaM_ä“¬¿y
(
L
, 
t
->
node
, 
	`ÿ¡
(
size_t
, 
	`siz’ode
(t)));

417 
	`luaM_ä“¬¿y
(
L
, 
t
->
¬¿y
,->
siz—¼ay
);

418 
	`luaM_ä“
(
L
, 
t
);

419 
	}
}

422 
Node
 *
	$g‘ä“pos
 (
TabË
 *
t
) {

423 ià(!
	`isdummy
(
t
)) {

424 
t
->
Ï¡ä“
 >->
node
) {

425 
t
->
Ï¡ä“
--;

426 ià(
	`‰i¢
(
	`gkey
(
t
->
Ï¡ä“
)))

427  
t
->
Ï¡ä“
;

430  
NULL
;

431 
	}
}

442 
TV®ue
 *
	$luaH_Ãwkey
 (
lua_S‹
 *
L
, 
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
) {

443 
Node
 *
mp
;

444 
TV®ue
 
aux
;

445 ià(
	`‰i¢
(
key
)è
	`luaG_ruÃ¼Ü
(
L
, "table index is‚il");

446 ià(
	`‰isæßt
(
key
)) {

447 
lua_IÁeg”
 
k
;

448 ià(
	`luaV_toš‹g”
(
key
, &
k
, 0)) {

449 
	`£tiv®ue
(&
aux
, 
k
);

450 
key
 = &
aux
;

452 ià(
	`luai_numi¢ª
(
	`ætv®ue
(
key
)))

453 
	`luaG_ruÃ¼Ü
(
L
, "table index is NaN");

455 
mp
 = 
	`mašpos™iÚ
(
t
, 
key
);

456 ià(!
	`‰i¢
(
	`gv®
(
mp
)è|| 
	`isdummy
(
t
)) {

457 
Node
 *
Ùh”n
;

458 
Node
 *
f
 = 
	`g‘ä“pos
(
t
);

459 ià(
f
 =ğ
NULL
) {

460 
	`»hash
(
L
, 
t
, 
key
);

462  
	`luaH_£t
(
L
, 
t
, 
key
);

464 
	`lua_as£¹
(!
	`isdummy
(
t
));

465 
Ùh”n
 = 
	`mašpos™iÚ
(
t
, 
	`gkey
(
mp
));

466 ià(
Ùh”n
 !ğ
mp
) {

468 
Ùh”n
 + 
	`gÃxt
(Ùh”nè!ğ
mp
)

469 
Ùh”n
 +ğ
	`gÃxt
(othern);

470 
	`gÃxt
(
Ùh”n
èğ
	`ÿ¡_št
(
f
 - othern);

471 *
f
 = *
mp
;

472 ià(
	`gÃxt
(
mp
) != 0) {

473 
	`gÃxt
(
f
è+ğ
	`ÿ¡_št
(
mp
 - f);

474 
	`gÃxt
(
mp
) = 0;

476 
	`£Šv®ue
(
	`gv®
(
mp
));

480 ià(
	`gÃxt
(
mp
) != 0)

481 
	`gÃxt
(
f
èğ
	`ÿ¡_št
((
mp
 + gnext(mp)) - f);

482 
	`lua_as£¹
(
	`gÃxt
(
f
) == 0);

483 
	`gÃxt
(
mp
èğ
	`ÿ¡_št
(
f
 - mp);

484 
mp
 = 
f
;

487 
	`£Šodekey
(
L
, &
mp
->
i_key
, 
key
);

488 
	`luaC_b¬r›rback
(
L
, 
t
, 
key
);

489 
	`lua_as£¹
(
	`‰i¢
(
	`gv®
(
mp
)));

490  
	`gv®
(
mp
);

491 
	}
}

497 cÚ¡ 
TV®ue
 *
	$luaH_g‘št
 (
TabË
 *
t
, 
lua_IÁeg”
 
key
) {

499 ià(
	`l_ÿ¡S2U
(
key
è- 1 < 
t
->
siz—¼ay
)

500  &
t
->
¬¿y
[
key
 - 1];

502 
Node
 *
n
 = 
	`hashšt
(
t
, 
key
);

504 ià(
	`‰isš‹g”
(
	`gkey
(
n
)è&& 
	`iv®ue
(gkeyÒ)è=ğ
key
)

505  
	`gv®
(
n
);

507 
nx
 = 
	`gÃxt
(
n
);

508 ià(
nx
 == 0) ;

509 
n
 +ğ
nx
;

512  
luaO_nobjeù
;

514 
	}
}

520 cÚ¡ 
TV®ue
 *
	$luaH_g‘shÜt¡r
 (
TabË
 *
t
, 
TSŒšg
 *
key
) {

521 
Node
 *
n
 = 
	`hash¡r
(
t
, 
key
);

522 
	`lua_as£¹
(
key
->
‰
 =ğ
LUA_TSHRSTR
);

524 cÚ¡ 
TV®ue
 *
k
 = 
	`gkey
(
n
);

525 ià(
	`‰isshr¡ršg
(
k
è&& 
	`eqshr¡r
(
	`tsv®ue
(k), 
key
))

526  
	`gv®
(
n
);

528 
nx
 = 
	`gÃxt
(
n
);

529 ià(
nx
 == 0)

530  
luaO_nobjeù
;

531 
n
 +ğ
nx
;

534 
	}
}

541 cÚ¡ 
TV®ue
 *
	$g‘g’”ic
 (
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
) {

542 
Node
 *
n
 = 
	`mašpos™iÚ
(
t
, 
key
);

544 ià(
	`luaV_¿wequ®obj
(
	`gkey
(
n
), 
key
))

545  
	`gv®
(
n
);

547 
nx
 = 
	`gÃxt
(
n
);

548 ià(
nx
 == 0)

549  
luaO_nobjeù
;

550 
n
 +ğ
nx
;

553 
	}
}

556 cÚ¡ 
TV®ue
 *
	$luaH_g‘¡r
 (
TabË
 *
t
, 
TSŒšg
 *
key
) {

557 ià(
key
->
‰
 =ğ
LUA_TSHRSTR
)

558  
	`luaH_g‘shÜt¡r
(
t
, 
key
);

560 
TV®ue
 
ko
;

561 
	`£tsv®ue
(
	`ÿ¡
(
lua_S‹
 *, 
NULL
), &
ko
, 
key
);

562  
	`g‘g’”ic
(
t
, &
ko
);

564 
	}
}

570 cÚ¡ 
TV®ue
 *
	$luaH_g‘
 (
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
) {

571 
	`‰y³
(
key
)) {

572 
LUA_TSHRSTR
:  
	`luaH_g‘shÜt¡r
(
t
, 
	`tsv®ue
(
key
));

573 
LUA_TNUMINT
:  
	`luaH_g‘št
(
t
, 
	`iv®ue
(
key
));

574 
LUA_TNIL
:  
luaO_nobjeù
;

575 
LUA_TNUMFLT
: {

576 
lua_IÁeg”
 
k
;

577 ià(
	`luaV_toš‹g”
(
key
, &
k
, 0))

578  
	`luaH_g‘št
(
t
, 
k
);

582  
	`g‘g’”ic
(
t
, 
key
);

584 
	}
}

591 
TV®ue
 *
	$luaH_£t
 (
lua_S‹
 *
L
, 
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
) {

592 cÚ¡ 
TV®ue
 *
p
 = 
	`luaH_g‘
(
t
, 
key
);

593 ià(
p
 !ğ
luaO_nobjeù
)

594  
	`ÿ¡
(
TV®ue
 *, 
p
);

595  
	`luaH_Ãwkey
(
L
, 
t
, 
key
);

596 
	}
}

599 
	$luaH_£tšt
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
lua_IÁeg”
 
key
, 
TV®ue
 *
v®ue
) {

600 cÚ¡ 
TV®ue
 *
p
 = 
	`luaH_g‘št
(
t
, 
key
);

601 
TV®ue
 *
ûÎ
;

602 ià(
p
 !ğ
luaO_nobjeù
)

603 
ûÎ
 = 
	`ÿ¡
(
TV®ue
 *, 
p
);

605 
TV®ue
 
k
;

606 
	`£tiv®ue
(&
k
, 
key
);

607 
ûÎ
 = 
	`luaH_Ãwkey
(
L
, 
t
, &
k
);

609 
	`£tobj2t
(
L
, 
ûÎ
, 
v®ue
);

610 
	}
}

613 
	$unbound_£¬ch
 (
TabË
 *
t
, 
j
) {

614 
i
 = 
j
;

615 
j
++;

617 !
	`‰i¢
(
	`luaH_g‘št
(
t
, 
j
))) {

618 
i
 = 
j
;

619 ià(
j
 > 
	`ÿ¡
(, 
MAX_INT
)/2) {

621 
i
 = 1;

622 !
	`‰i¢
(
	`luaH_g‘št
(
t
, 
i
))) i++;

623  
i
 - 1;

625 
j
 *= 2;

628 
j
 - 
i
 > 1) {

629 
m
 = (
i
+
j
)/2;

630 ià(
	`‰i¢
(
	`luaH_g‘št
(
t
, 
m
))è
j
 = m;

631 
i
 = 
m
;

633  
i
;

634 
	}
}

641 
	$luaH_g‘n
 (
TabË
 *
t
) {

642 
j
 = 
t
->
siz—¼ay
;

643 ià(
j
 > 0 && 
	`‰i¢
(&
t
->
¬¿y
[j - 1])) {

645 
i
 = 0;

646 
j
 - 
i
 > 1) {

647 
m
 = (
i
+
j
)/2;

648 ià(
	`‰i¢
(&
t
->
¬¿y
[
m
 - 1])è
j
 = m;

649 
i
 = 
m
;

651  
i
;

654 ià(
	`isdummy
(
t
))

655  
j
;

656  
	`unbound_£¬ch
(
t
, 
j
);

657 
	}
}

661 #ià
defšed
(
LUA_DEBUG
)

663 
Node
 *
	$luaH_mašpos™iÚ
 (cÚ¡ 
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
) {

664  
	`mašpos™iÚ
(
t
, 
key
);

665 
	}
}

667 
	$luaH_isdummy
 (cÚ¡ 
TabË
 *
t
è{  
	`isdummy
Ñ); 
	}
}

	@script/lua/lua-5.3.4/src/ltable.h

7 #iâdeà
ÉabË_h


8 
	#ÉabË_h


	)

10 
	~"lobjeù.h
"

13 
	#gnode
(
t
,
i
è(&Ñ)->
node
[i])

	)

14 
	#gv®
(
n
è(&Ò)->
i_v®
)

	)

15 
	#gÃxt
(
n
è(Ò)->
i_key
.
nk
.
Ãxt
)

	)

19 
	#gkey
(
n
è
	`ÿ¡
(cÚ¡ 
TV®ue
*, (&Ò)->
i_key
.
tvk
))

	)

25 
	#wgkey
(
n
è(&Ò)->
i_key
.
nk
)

	)

27 
	#šv®id©eTMÿche
(
t
è(Ñ)->
æags
 = 0)

	)

31 
	#isdummy
(
t
è(Ñ)->
Ï¡ä“
 =ğ
NULL
)

	)

35 
	#®locsiz’ode
(
t
è(
	`isdummy
Ñè? 0 : 
	`siz’ode
Ñ))

	)

39 
	#keyäomv®
(
v
) \

40 (
	`gkey
(
	`ÿ¡
(
Node
 *, ca¡(*, (
v
)è- 
	`off£tof
(Node, 
i_v®
))))

	)

43 
LUAI_FUNC
 cÚ¡ 
TV®ue
 *
luaH_g‘št
 (
TabË
 *
t
, 
lua_IÁeg”
 
key
);

44 
LUAI_FUNC
 
luaH_£tšt
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
lua_IÁeg”
 
key
,

45 
TV®ue
 *
v®ue
);

46 
LUAI_FUNC
 cÚ¡ 
TV®ue
 *
luaH_g‘shÜt¡r
 (
TabË
 *
t
, 
TSŒšg
 *
key
);

47 
LUAI_FUNC
 cÚ¡ 
TV®ue
 *
luaH_g‘¡r
 (
TabË
 *
t
, 
TSŒšg
 *
key
);

48 
LUAI_FUNC
 cÚ¡ 
TV®ue
 *
luaH_g‘
 (
TabË
 *
t
, cÚ¡ TV®u*
key
);

49 
LUAI_FUNC
 
TV®ue
 *
luaH_Ãwkey
 (
lua_S‹
 *
L
, 
TabË
 *
t
, cÚ¡ TV®u*
key
);

50 
LUAI_FUNC
 
TV®ue
 *
luaH_£t
 (
lua_S‹
 *
L
, 
TabË
 *
t
, cÚ¡ TV®u*
key
);

51 
LUAI_FUNC
 
TabË
 *
luaH_Ãw
 (
lua_S‹
 *
L
);

52 
LUAI_FUNC
 
luaH_»size
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
Çsize
,

53 
nhsize
);

54 
LUAI_FUNC
 
luaH_»siz—¼ay
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
Çsize
);

55 
LUAI_FUNC
 
luaH_ä“
 (
lua_S‹
 *
L
, 
TabË
 *
t
);

56 
LUAI_FUNC
 
luaH_Ãxt
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
StkId
 
key
);

57 
LUAI_FUNC
 
luaH_g‘n
 (
TabË
 *
t
);

60 #ià
defšed
(
LUA_DEBUG
)

61 
LUAI_FUNC
 
Node
 *
luaH_mašpos™iÚ
 (cÚ¡ 
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
);

62 
LUAI_FUNC
 
luaH_isdummy
 (cÚ¡ 
TabË
 *
t
);

	@script/lua/lua-5.3.4/src/ltablib.c

7 
	#Éablib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<lim™s.h
>

14 
	~<¡ddef.h
>

15 
	~<¡ršg.h
>

17 
	~"lua.h
"

19 
	~"Ïuxlib.h
"

20 
	~"lu®ib.h
"

27 
	#TAB_R
 1

	)

28 
	#TAB_W
 2

	)

29 
	#TAB_L
 4

	)

30 
	#TAB_RW
 (
TAB_R
 | 
TAB_W
è

	)

33 
	#aux_g‘n
(
L
,
n
,
w
è(
	`checkb
(L,‚, (wè| 
TAB_L
), 
	`luaL_Ën
(L,‚))

	)

36 
	$checkf›ld
 (
lua_S‹
 *
L
, cÚ¡ *
key
, 
n
) {

37 
	`lua_push¡ršg
(
L
, 
key
);

38  (
	`lua_¿wg‘
(
L
, -
n
è!ğ
LUA_TNIL
);

39 
	}
}

46 
	$checkb
 (
lua_S‹
 *
L
, 
¬g
, 
wh©
) {

47 ià(
	`lua_ty³
(
L
, 
¬g
è!ğ
LUA_TTABLE
) {

48 
n
 = 1;

49 ià(
	`lua_g‘m‘©abË
(
L
, 
¬g
) &&

50 (!(
wh©
 & 
TAB_R
è|| 
	`checkf›ld
(
L
, "__šdex", ++
n
)) &&

51 (!(
wh©
 & 
TAB_W
è|| 
	`checkf›ld
(
L
, "__Ãwšdex", ++
n
)) &&

52 (!(
wh©
 & 
TAB_L
è|| 
	`checkf›ld
(
L
, "__Ën", ++
n
))) {

53 
	`lua_pİ
(
L
, 
n
);

56 
	`luaL_checkty³
(
L
, 
¬g
, 
LUA_TTABLE
);

58 
	}
}

61 #ià
defšed
(
LUA_COMPAT_MAXN
)

62 
	$maxn
 (
lua_S‹
 *
L
) {

63 
lua_Numb”
 
max
 = 0;

64 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

65 
	`lua_pushn
(
L
);

66 
	`lua_Ãxt
(
L
, 1)) {

67 
	`lua_pİ
(
L
, 1);

68 ià(
	`lua_ty³
(
L
, -1è=ğ
LUA_TNUMBER
) {

69 
lua_Numb”
 
v
 = 
	`lua_tÚumb”
(
L
, -1);

70 ià(
v
 > 
max
) max = v;

73 
	`lua_pushnumb”
(
L
, 
max
);

75 
	}
}

79 
	$tš£¹
 (
lua_S‹
 *
L
) {

80 
lua_IÁeg”
 
e
 = 
	`aux_g‘n
(
L
, 1, 
TAB_RW
) + 1;

81 
lua_IÁeg”
 
pos
;

82 
	`lua_g‘tİ
(
L
)) {

84 
pos
 = 
e
;

88 
lua_IÁeg”
 
i
;

89 
pos
 = 
	`luaL_checkš‹g”
(
L
, 2);

90 
	`luaL_¬gcheck
(
L
, 1 <ğ
pos
 &&…o <ğ
e
, 2, "position out of bounds");

91 
i
 = 
e
; i > 
pos
; i--) {

92 
	`lua_g‘i
(
L
, 1, 
i
 - 1);

93 
	`lua_£ti
(
L
, 1, 
i
);

98  
	`luaL_”rÜ
(
L
, "wrong‚umber of‡rgumentso 'insert'");

101 
	`lua_£ti
(
L
, 1, 
pos
);

103 
	}
}

106 
	$Œemove
 (
lua_S‹
 *
L
) {

107 
lua_IÁeg”
 
size
 = 
	`aux_g‘n
(
L
, 1, 
TAB_RW
);

108 
lua_IÁeg”
 
pos
 = 
	`luaL_İtš‹g”
(
L
, 2, 
size
);

109 ià(
pos
 !ğ
size
)

110 
	`luaL_¬gcheck
(
L
, 1 <ğ
pos
 &&…o <ğ
size
 + 1, 1, "position out of bounds");

111 
	`lua_g‘i
(
L
, 1, 
pos
);

112  ; 
pos
 < 
size
;…os++) {

113 
	`lua_g‘i
(
L
, 1, 
pos
 + 1);

114 
	`lua_£ti
(
L
, 1, 
pos
);

116 
	`lua_pushn
(
L
);

117 
	`lua_£ti
(
L
, 1, 
pos
);

119 
	}
}

128 
	$tmove
 (
lua_S‹
 *
L
) {

129 
lua_IÁeg”
 
f
 = 
	`luaL_checkš‹g”
(
L
, 2);

130 
lua_IÁeg”
 
e
 = 
	`luaL_checkš‹g”
(
L
, 3);

131 
lua_IÁeg”
 
t
 = 
	`luaL_checkš‹g”
(
L
, 4);

132 
‰
 = !
	`lua_i¢ÚeÜn
(
L
, 5) ? 5 : 1;

133 
	`checkb
(
L
, 1, 
TAB_R
);

134 
	`checkb
(
L
, 
‰
, 
TAB_W
);

135 ià(
e
 >ğ
f
) {

136 
lua_IÁeg”
 
n
, 
i
;

137 
	`luaL_¬gcheck
(
L
, 
f
 > 0 || 
e
 < 
LUA_MAXINTEGER
 + f, 3,

139 
n
 = 
e
 - 
f
 + 1;

140 
	`luaL_¬gcheck
(
L
, 
t
 <ğ
LUA_MAXINTEGER
 - 
n
 + 1, 4,

142 ià(
t
 > 
e
 || <ğ
f
 || (
‰
 !ğ1 && !
	`lua_com·»
(
L
, 1,t, 
LUA_OPEQ
))) {

143 
i
 = 0; i < 
n
; i++) {

144 
	`lua_g‘i
(
L
, 1, 
f
 + 
i
);

145 
	`lua_£ti
(
L
, 
‰
, 
t
 + 
i
);

149 
i
 = 
n
 - 1; i >= 0; i--) {

150 
	`lua_g‘i
(
L
, 1, 
f
 + 
i
);

151 
	`lua_£ti
(
L
, 
‰
, 
t
 + 
i
);

155 
	`lua_pushv®ue
(
L
, 
‰
);

157 
	}
}

160 
	$addf›ld
 (
lua_S‹
 *
L
, 
luaL_Bufãr
 *
b
, 
lua_IÁeg”
 
i
) {

161 
	`lua_g‘i
(
L
, 1, 
i
);

162 ià(!
	`lua_is¡ršg
(
L
, -1))

163 
	`luaL_”rÜ
(
L
, "invalid value (%s)‡t index %d inable for 'concat'",

164 
	`luaL_ty³Çme
(
L
, -1), 
i
);

165 
	`luaL_addv®ue
(
b
);

166 
	}
}

169 
	$tcÚÿt
 (
lua_S‹
 *
L
) {

170 
luaL_Bufãr
 
b
;

171 
lua_IÁeg”
 
Ï¡
 = 
	`aux_g‘n
(
L
, 1, 
TAB_R
);

172 
size_t
 
l£p
;

173 cÚ¡ *
£p
 = 
	`luaL_İ¡ršg
(
L
, 2, "", &
l£p
);

174 
lua_IÁeg”
 
i
 = 
	`luaL_İtš‹g”
(
L
, 3, 1);

175 
Ï¡
 = 
	`luaL_İtš‹g”
(
L
, 4,†ast);

176 
	`luaL_buffš™
(
L
, &
b
);

177 ; 
i
 < 
Ï¡
; i++) {

178 
	`addf›ld
(
L
, &
b
, 
i
);

179 
	`luaL_addl¡ršg
(&
b
, 
£p
, 
l£p
);

181 ià(
i
 =ğ
Ï¡
)

182 
	`addf›ld
(
L
, &
b
, 
i
);

183 
	`luaL_push»suÉ
(&
b
);

185 
	}
}

194 
	$·ck
 (
lua_S‹
 *
L
) {

195 
i
;

196 
n
 = 
	`lua_g‘tİ
(
L
);

197 
	`lua_ü—‹bË
(
L
, 
n
, 1);

198 
	`lua_š£¹
(
L
, 1);

199 
i
 = 
n
; i >= 1; i--)

200 
	`lua_£ti
(
L
, 1, 
i
);

201 
	`lua_pushš‹g”
(
L
, 
n
);

202 
	`lua_£tf›ld
(
L
, 1, "n");

204 
	}
}

207 
	$uÅack
 (
lua_S‹
 *
L
) {

208 
lua_UnsigÃd
 
n
;

209 
lua_IÁeg”
 
i
 = 
	`luaL_İtš‹g”
(
L
, 2, 1);

210 
lua_IÁeg”
 
e
 = 
	`luaL_İt
(
L
, 
luaL_checkš‹g”
, 3, 
	`luaL_Ën
(L, 1));

211 ià(
i
 > 
e
)  0;

212 
n
 = (
lua_UnsigÃd
)
e
 - 
i
;

213 ià(
n
 >ğ()
INT_MAX
 || !
	`lua_check¡ack
(
L
, ()(++n)))

214  
	`luaL_”rÜ
(
L
, "too many„esultso unpack");

215 ; 
i
 < 
e
; i++) {

216 
	`lua_g‘i
(
L
, 1, 
i
);

218 
	`lua_g‘i
(
L
, 1, 
e
);

219  ()
n
;

220 
	}
}

236 
	tIdxT
;

245 #ià!
defšed
(
l_¿ndomizePivÙ
)

247 
	~<time.h
>

250 
	#sof
(
e
è(Óè/ ())

	)

258 
	$l_¿ndomizePivÙ
 () {

259 
şock_t
 
c
 = 
	`şock
();

260 
time_t
 
t
 = 
	`time
(
NULL
);

261 
buff
[
	`sof
(
c
è+ sof(
t
)];

262 
i
, 
ºd
 = 0;

263 
	`memıy
(
buff
, &
c
, 
	`sof
(c) * ());

264 
	`memıy
(
buff
 + 
	`sof
(
c
), &
t
, sof(t) * ());

265 
i
 = 0; i < 
	`sof
(
buff
); i++)

266 
ºd
 +ğ
buff
[
i
];

267  
ºd
;

268 
	}
}

274 
	#RANLIMIT
 100u

	)

277 
	$£t2
 (
lua_S‹
 *
L
, 
IdxT
 
i
, IdxT 
j
) {

278 
	`lua_£ti
(
L
, 1, 
i
);

279 
	`lua_£ti
(
L
, 1, 
j
);

280 
	}
}

287 
	$sÜt_comp
 (
lua_S‹
 *
L
, 
a
, 
b
) {

288 ià(
	`lua_i¢
(
L
, 2))

289  
	`lua_com·»
(
L
, 
a
, 
b
, 
LUA_OPLT
);

291 
»s
;

292 
	`lua_pushv®ue
(
L
, 2);

293 
	`lua_pushv®ue
(
L
, 
a
-1);

294 
	`lua_pushv®ue
(
L
, 
b
-2);

295 
	`lua_ÿÎ
(
L
, 2, 1);

296 
»s
 = 
	`lua_toboŞ—n
(
L
, -1);

297 
	`lua_pİ
(
L
, 1);

298  
»s
;

300 
	}
}

310 
IdxT
 
	$·¹™iÚ
 (
lua_S‹
 *
L
, 
IdxT
 
lo
, IdxT 
up
) {

311 
IdxT
 
i
 = 
lo
;

312 
IdxT
 
j
 = 
up
 - 1;

316 
	`lua_g‘i
(
L
, 1, ++
i
), 
	`sÜt_comp
(L, -1, -2)) {

317 ià(
i
 =ğ
up
 - 1)

318 
	`luaL_”rÜ
(
L
, "invalid order function for sorting");

319 
	`lua_pİ
(
L
, 1);

323 
	`lua_g‘i
(
L
, 1, --
j
), 
	`sÜt_comp
(L, -3, -1)) {

324 ià(
j
 < 
i
)

325 
	`luaL_”rÜ
(
L
, "invalid order function for sorting");

326 
	`lua_pİ
(
L
, 1);

329 ià(
j
 < 
i
) {

331 
	`lua_pİ
(
L
, 1);

333 
	`£t2
(
L
, 
up
 - 1, 
i
);

334  
i
;

337 
	`£t2
(
L
, 
i
, 
j
);

339 
	}
}

346 
IdxT
 
	$choo£PivÙ
 (
IdxT
 
lo
, IdxT 
up
, 
ºd
) {

347 
IdxT
 
r4
 = (
up
 - 
lo
) / 4;

348 
IdxT
 
p
 = 
ºd
 % (
r4
 * 2è+ (
lo
 +„4);

349 
	`lua_as£¹
(
lo
 + 
r4
 <ğ
p
 &&… <ğ
up
 -„4);

350  
p
;

351 
	}
}

357 
	$auxsÜt
 (
lua_S‹
 *
L
, 
IdxT
 
lo
, IdxT 
up
,

358 
ºd
) {

359 
lo
 < 
up
) {

360 
IdxT
 
p
;

361 
IdxT
 
n
;

363 
	`lua_g‘i
(
L
, 1, 
lo
);

364 
	`lua_g‘i
(
L
, 1, 
up
);

365 ià(
	`sÜt_comp
(
L
, -1, -2))

366 
	`£t2
(
L
, 
lo
, 
up
);

368 
	`lua_pİ
(
L
, 2);

369 ià(
up
 - 
lo
 == 1)

371 ià(
up
 - 
lo
 < 
RANLIMIT
 || 
ºd
 == 0)

372 
p
 = (
lo
 + 
up
)/2;

374 
p
 = 
	`choo£PivÙ
(
lo
, 
up
, 
ºd
);

375 
	`lua_g‘i
(
L
, 1, 
p
);

376 
	`lua_g‘i
(
L
, 1, 
lo
);

377 ià(
	`sÜt_comp
(
L
, -2, -1))

378 
	`£t2
(
L
, 
p
, 
lo
);

380 
	`lua_pİ
(
L
, 1);

381 
	`lua_g‘i
(
L
, 1, 
up
);

382 ià(
	`sÜt_comp
(
L
, -1, -2))

383 
	`£t2
(
L
, 
p
, 
up
);

385 
	`lua_pİ
(
L
, 2);

387 ià(
up
 - 
lo
 == 2)

389 
	`lua_g‘i
(
L
, 1, 
p
);

390 
	`lua_pushv®ue
(
L
, -1);

391 
	`lua_g‘i
(
L
, 1, 
up
 - 1);

392 
	`£t2
(
L
, 
p
, 
up
 - 1);

393 
p
 = 
	`·¹™iÚ
(
L
, 
lo
, 
up
);

395 ià(
p
 - 
lo
 < 
up
 -…) {

396 
	`auxsÜt
(
L
, 
lo
, 
p
 - 1, 
ºd
);

397 
n
 = 
p
 - 
lo
;

398 
lo
 = 
p
 + 1;

401 
	`auxsÜt
(
L
, 
p
 + 1, 
up
, 
ºd
);

402 
n
 = 
up
 - 
p
;

403 
up
 = 
p
 - 1;

405 ià((
up
 - 
lo
è/ 128 > 
n
)

406 
ºd
 = 
	`l_¿ndomizePivÙ
();

408 
	}
}

411 
	$sÜt
 (
lua_S‹
 *
L
) {

412 
lua_IÁeg”
 
n
 = 
	`aux_g‘n
(
L
, 1, 
TAB_RW
);

413 ià(
n
 > 1) {

414 
	`luaL_¬gcheck
(
L
, 
n
 < 
INT_MAX
, 1, "arrayoo big");

415 ià(!
	`lua_i¢ÚeÜn
(
L
, 2))

416 
	`luaL_checkty³
(
L
, 2, 
LUA_TFUNCTION
);

417 
	`lua_£‰İ
(
L
, 2);

418 
	`auxsÜt
(
L
, 1, (
IdxT
)
n
, 0);

421 
	}
}

426 cÚ¡ 
luaL_Reg
 
	gb_funcs
[] = {

427 {"cÚÿt", 
tcÚÿt
},

428 #ià
defšed
(
LUA_COMPAT_MAXN
)

429 {"maxn", 
maxn
},

431 {"š£¹", 
tš£¹
},

432 {"·ck", 
·ck
},

433 {"uÅack", 
uÅack
},

434 {"»move", 
Œemove
},

435 {"move", 
tmove
},

436 {"sÜt", 
sÜt
},

437 {
NULL
, NULL}

441 
LUAMOD_API
 
	$luaİ’_bË
 (
lua_S‹
 *
L
) {

442 
	`luaL_Ãwlib
(
L
, 
b_funcs
);

443 #ià
	`defšed
(
LUA_COMPAT_UNPACK
)

445 
	`lua_g‘f›ld
(
L
, -1, "unpack");

446 
	`lua_£tglob®
(
L
, "unpack");

449 
	}
}

	@script/lua/lua-5.3.4/src/ltm.c

7 
	#Ém_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ršg.h
>

15 
	~"lua.h
"

17 
	~"ldebug.h
"

18 
	~"ldo.h
"

19 
	~"lobjeù.h
"

20 
	~"l¡©e.h
"

21 
	~"l¡ršg.h
"

22 
	~"ÉabË.h
"

23 
	~"Ém.h
"

24 
	~"lvm.h
"

27 cÚ¡ 
	gud©©y³Çme
[] = "userdata";

29 
LUAI_DDEF
 cÚ¡ *cÚ¡ 
	gluaT_ty³Çmes_
[
LUA_TOTALTAGS
] = {

31 "n", "boŞ—n", 
ud©©y³Çme
, "number",

32 "¡ršg", "bË", "funùiÚ", 
ud©©y³Çme
, "thread",

37 
	$luaT_š™
 (
lua_S‹
 *
L
) {

38 cÚ¡ *cÚ¡ 
luaT_ev’Šame
[] = {

47 
i
;

48 
i
=0; i<
TM_N
; i++) {

49 
	`G
(
L
)->
tmÇme
[
i
] = 
	`luaS_Ãw
(L, 
luaT_ev’Šame
[i]);

50 
	`luaC_fix
(
L
, 
	`obj2gco
(
	`G
(L)->
tmÇme
[
i
]));

52 
	}
}

59 cÚ¡ 
TV®ue
 *
	$luaT_g‘tm
 (
TabË
 *
ev’ts
, 
TMS
 
ev’t
, 
TSŒšg
 *
’ame
) {

60 cÚ¡ 
TV®ue
 *
tm
 = 
	`luaH_g‘shÜt¡r
(
ev’ts
, 
’ame
);

61 
	`lua_as£¹
(
ev’t
 <ğ
TM_EQ
);

62 ià(
	`‰i¢
(
tm
)) {

63 
ev’ts
->
æags
 |ğ
	`ÿ¡_by‹
(1u<<
ev’t
);

64  
NULL
;

66  
tm
;

67 
	}
}

70 cÚ¡ 
TV®ue
 *
	$luaT_g‘tmbyobj
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
o
, 
TMS
 
ev’t
) {

71 
TabË
 *
mt
;

72 
	`‰nov
(
o
)) {

73 
LUA_TTABLE
:

74 
mt
 = 
	`hv®ue
(
o
)->
m‘©abË
;

76 
LUA_TUSERDATA
:

77 
mt
 = 
	`uv®ue
(
o
)->
m‘©abË
;

80 
mt
 = 
	`G
(
L
)->mt[
	`‰nov
(
o
)];

82  (
mt
 ? 
	`luaH_g‘shÜt¡r
(mt, 
	`G
(
L
)->
tmÇme
[
ev’t
]è: 
luaO_nobjeù
);

83 
	}
}

90 cÚ¡ *
	$luaT_objty³Çme
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
o
) {

91 
TabË
 *
mt
;

92 ià((
	`‰i¡abË
(
o
è&& (
mt
 = 
	`hv®ue
(o)->
m‘©abË
è!ğ
NULL
) ||

93 (
	`‰isfuÎu£rd©a
(
o
è&& (
mt
 = 
	`uv®ue
(o)->
m‘©abË
è!ğ
NULL
)) {

94 cÚ¡ 
TV®ue
 *
Çme
 = 
	`luaH_g‘shÜt¡r
(
mt
, 
	`luaS_Ãw
(
L
, "__name"));

95 ià(
	`‰is¡ršg
(
Çme
))

96  
	`g‘¡r
(
	`tsv®ue
(
Çme
));

98  
	`‰y³Çme
(
	`‰nov
(
o
));

99 
	}
}

102 
	$luaT_ÿÎTM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
f
, cÚ¡ TV®u*
p1
,

103 cÚ¡ 
TV®ue
 *
p2
, TV®u*
p3
, 
ha¤es
) {

104 
±rdiff_t
 
»suÉ
 = 
	`§ve¡ack
(
L
, 
p3
);

105 
StkId
 
func
 = 
L
->
tİ
;

106 
	`£tobj2s
(
L
, 
func
, 
f
);

107 
	`£tobj2s
(
L
, 
func
 + 1, 
p1
);

108 
	`£tobj2s
(
L
, 
func
 + 2, 
p2
);

109 
L
->
tİ
 += 3;

110 ià(!
ha¤es
)

111 
	`£tobj2s
(
L
, L->
tİ
++, 
p3
);

113 ià(
	`isLua
(
L
->
ci
))

114 
	`luaD_ÿÎ
(
L
, 
func
, 
ha¤es
);

116 
	`luaD_ÿÎnoy›ld
(
L
, 
func
, 
ha¤es
);

117 ià(
ha¤es
) {

118 
p3
 = 
	`»¡Üe¡ack
(
L
, 
»suÉ
);

119 
	`£tobjs2s
(
L
, 
p3
, --L->
tİ
);

121 
	}
}

124 
	$luaT_ÿÎbšTM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
,

125 
StkId
 
»s
, 
TMS
 
ev’t
) {

126 cÚ¡ 
TV®ue
 *
tm
 = 
	`luaT_g‘tmbyobj
(
L
, 
p1
, 
ev’t
);

127 ià(
	`‰i¢
(
tm
))

128 
tm
 = 
	`luaT_g‘tmbyobj
(
L
, 
p2
, 
ev’t
);

129 ià(
	`‰i¢
(
tm
))  0;

130 
	`luaT_ÿÎTM
(
L
, 
tm
, 
p1
, 
p2
, 
»s
, 1);

132 
	}
}

135 
	$luaT_ŒybšTM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
,

136 
StkId
 
»s
, 
TMS
 
ev’t
) {

137 ià(!
	`luaT_ÿÎbšTM
(
L
, 
p1
, 
p2
, 
»s
, 
ev’t
)) {

138 
ev’t
) {

139 
TM_CONCAT
:

140 
	`luaG_cÚÿ‹¼Ü
(
L
, 
p1
, 
p2
);

142 
TM_BAND
: 
TM_BOR
: 
TM_BXOR
:

143 
TM_SHL
: 
TM_SHR
: 
TM_BNOT
: {

144 
lua_Numb”
 
dummy
;

145 ià(
	`tÚumb”
(
p1
, &
dummy
è&&Úumb”(
p2
, &dummy))

146 
	`luaG_toš‹¼Ü
(
L
, 
p1
, 
p2
);

148 
	`luaG_İš‹¼Ü
(
L
, 
p1
, 
p2
, "perform bitwise operation on");

152 
	`luaG_İš‹¼Ü
(
L
, 
p1
, 
p2
, "perform‡rithmetic on");

155 
	}
}

158 
	$luaT_ÿÎÜd”TM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
,

159 
TMS
 
ev’t
) {

160 ià(!
	`luaT_ÿÎbšTM
(
L
, 
p1
, 
p2
, L->
tİ
, 
ev’t
))

163  !
	`l_isçl£
(
L
->
tİ
);

164 
	}
}

	@script/lua/lua-5.3.4/src/ltm.h

7 #iâdeà
Ém_h


8 
	#Ém_h


	)

11 
	~"lobjeù.h
"

19 
	mTM_INDEX
,

20 
	mTM_NEWINDEX
,

21 
	mTM_GC
,

22 
	mTM_MODE
,

23 
	mTM_LEN
,

24 
	mTM_EQ
,

25 
	mTM_ADD
,

26 
	mTM_SUB
,

27 
	mTM_MUL
,

28 
	mTM_MOD
,

29 
	mTM_POW
,

30 
	mTM_DIV
,

31 
	mTM_IDIV
,

32 
	mTM_BAND
,

33 
	mTM_BOR
,

34 
	mTM_BXOR
,

35 
	mTM_SHL
,

36 
	mTM_SHR
,

37 
	mTM_UNM
,

38 
	mTM_BNOT
,

39 
	mTM_LT
,

40 
	mTM_LE
,

41 
	mTM_CONCAT
,

42 
	mTM_CALL
,

43 
	mTM_N


44 } 
	tTMS
;

48 
	#gç¡tm
(
g
,
‘
,
e
è(Ótè=ğ
NULL
 ? NULL : \

49 ((
‘
)->
æags
 & (1u<<(
e
))è? 
NULL
 : 
	`luaT_g‘tm
Ót,ƒ, (
g
)->
tmÇme
[e]))

	)

51 
	#ç¡tm
(
l
,
‘
,
e
è
	`gç¡tm
(
	`G
Ö),ƒt,ƒ)

	)

53 
	#‰y³Çme
(
x
è
luaT_ty³Çmes_
[(xè+ 1]

	)

55 
LUAI_DDEC
 cÚ¡ *cÚ¡ 
	gluaT_ty³Çmes_
[
LUA_TOTALTAGS
];

58 
LUAI_FUNC
 cÚ¡ *
luaT_objty³Çme
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
o
);

60 
LUAI_FUNC
 cÚ¡ 
TV®ue
 *
luaT_g‘tm
 (
TabË
 *
ev’ts
, 
TMS
 
ev’t
, 
TSŒšg
 *
’ame
);

61 
LUAI_FUNC
 cÚ¡ 
TV®ue
 *
luaT_g‘tmbyobj
 (
lua_S‹
 *
L
, cÚ¡ TV®u*
o
,

62 
TMS
 
ev’t
);

63 
LUAI_FUNC
 
luaT_š™
 (
lua_S‹
 *
L
);

65 
LUAI_FUNC
 
luaT_ÿÎTM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
f
, cÚ¡ TV®u*
p1
,

66 cÚ¡ 
TV®ue
 *
p2
, TV®u*
p3
, 
ha¤es
);

67 
LUAI_FUNC
 
luaT_ÿÎbšTM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
,

68 
StkId
 
»s
, 
TMS
 
ev’t
);

69 
LUAI_FUNC
 
luaT_ŒybšTM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
,

70 
StkId
 
»s
, 
TMS
 
ev’t
);

71 
LUAI_FUNC
 
luaT_ÿÎÜd”TM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
,

72 cÚ¡ 
TV®ue
 *
p2
, 
TMS
 
ev’t
);

	@script/lua/lua-5.3.4/src/lua.c

7 
	#lua_c


	)

9 
	~"Í»fix.h
"

12 
	~<sigÇl.h
>

13 
	~<¡dio.h
>

14 
	~<¡dlib.h
>

15 
	~<¡ršg.h
>

17 
	~"lua.h
"

19 
	~"Ïuxlib.h
"

20 
	~"lu®ib.h
"

24 #ià!
defšed
(
LUA_PROMPT
)

25 
	#LUA_PROMPT
 "> "

	)

26 
	#LUA_PROMPT2
 ">> "

	)

29 #ià!
defšed
(
LUA_PROGNAME
)

30 
	#LUA_PROGNAME
 "lua"

	)

33 #ià!
defšed
(
LUA_MAXINPUT
)

34 
	#LUA_MAXINPUT
 512

	)

37 #ià!
defšed
(
LUA_INIT_VAR
)

38 
	#LUA_INIT_VAR
 "LUA_INIT"

	)

41 
	#LUA_INITVARVERSION
 
LUA_INIT_VAR
 
LUA_VERSUFFIX


	)

48 #ià!
defšed
(
lua_¡dš_is_‰y
)

50 #ià
defšed
(
LUA_USE_POSIX
)

52 
	~<uni¡d.h
>

53 
	#lua_¡dš_is_‰y
(è
	`i§‰y
(0)

	)

55 #–ià
defšed
(
LUA_USE_WINDOWS
)

57 
	~<io.h
>

58 
	~<wšdows.h
>

60 
	#lua_¡dš_is_‰y
(è
	`_i§‰y
(
	`_f’o
(
¡dš
))

	)

65 
	#lua_¡dš_is_‰y
(è1

	)

78 #ià!
defšed
(
lua_»adlše
)

80 #ià
defšed
(
LUA_USE_READLINE
)

82 
	~<»adlše/»adlše.h
>

83 
	~<»adlše/hi¡Üy.h
>

84 
	#lua_»adlše
(
L
,
b
,
p
è(()L, ((b)=
	`»adlše
Õ)è!ğ
NULL
)

	)

85 
	#lua_§v–še
(
L
,
lše
è(()L, 
	`add_hi¡Üy
Öše))

	)

86 
	#lua_ä“lše
(
L
,
b
è(()L, 
	`ä“
(b))

	)

90 
	#lua_»adlše
(
L
,
b
,
p
) \

91 (()
L
, 
	`åuts
(
p
, 
¡dout
), 
	`fæush
(stdout), \

92 
	`fg‘s
(
b
, 
LUA_MAXINPUT
, 
¡dš
è!ğ
NULL
è

	)

93 
	#lua_§v–še
(
L
,
lše
è{ ()L; (îše; }

	)

94 
	#lua_ä“lše
(
L
,
b
è{ ()L; ()b; }

	)

103 
lua_S‹
 *
	gglob®L
 = 
NULL
;

105 cÚ¡ *
	g´ogÇme
 = 
LUA_PROGNAME
;

111 
	$l¡İ
 (
lua_S‹
 *
L
, 
lua_Debug
 *
¬
) {

112 ()
¬
;

113 
	`lua_£thook
(
L
, 
NULL
, 0, 0);

114 
	`luaL_”rÜ
(
L
, "interrupted!");

115 
	}
}

124 
	$ÏùiÚ
 (
i
) {

125 
	`sigÇl
(
i
, 
SIG_DFL
);

126 
	`lua_£thook
(
glob®L
, 
l¡İ
, 
LUA_MASKCALL
 | 
LUA_MASKRET
 | 
LUA_MASKCOUNT
, 1);

127 
	}
}

130 
	$´št_u§ge
 (cÚ¡ *
badİtiÚ
) {

131 
	`lua_wr™e¡ršg”rÜ
("%s: ", 
´ogÇme
);

132 ià(
badİtiÚ
[1] == 'e' || badoption[1] == 'l')

133 
	`lua_wr™e¡ršg”rÜ
("'%s'‚“d ¬gum’t\n", 
badİtiÚ
);

135 
	`lua_wr™e¡ršg”rÜ
("uÄecognized o±iÚ '%s'\n", 
badİtiÚ
);

136 
	`lua_wr™e¡ršg”rÜ
(

147 
´ogÇme
);

148 
	}
}

155 
	$l_mes§ge
 (cÚ¡ *
²ame
, cÚ¡ *
msg
) {

156 ià(
²ame
è
	`lua_wr™e¡ršg”rÜ
("%s: ",…name);

157 
	`lua_wr™e¡ršg”rÜ
("%s\n", 
msg
);

158 
	}
}

166 
	$»pÜt
 (
lua_S‹
 *
L
, 
¡©us
) {

167 ià(
¡©us
 !ğ
LUA_OK
) {

168 cÚ¡ *
msg
 = 
	`lua_to¡ršg
(
L
, -1);

169 
	`l_mes§ge
(
´ogÇme
, 
msg
);

170 
	`lua_pİ
(
L
, 1);

172  
¡©us
;

173 
	}
}

179 
	$msghªdËr
 (
lua_S‹
 *
L
) {

180 cÚ¡ *
msg
 = 
	`lua_to¡ršg
(
L
, 1);

181 ià(
msg
 =ğ
NULL
) {

182 ià(
	`luaL_ÿÎm‘a
(
L
, 1, "__tostring") &&

183 
	`lua_ty³
(
L
, -1è=ğ
LUA_TSTRING
)

186 
msg
 = 
	`lua_pushf¡ršg
(
L
, "(error object is‡ %s value)",

187 
	`luaL_ty³Çme
(
L
, 1));

189 
	`luaL_Œaûback
(
L
, L, 
msg
, 1);

191 
	}
}

198 
	$doÿÎ
 (
lua_S‹
 *
L
, 
Çrg
, 
Äes
) {

199 
¡©us
;

200 
ba£
 = 
	`lua_g‘tİ
(
L
è- 
Çrg
;

201 
	`lua_pushcfunùiÚ
(
L
, 
msghªdËr
);

202 
	`lua_š£¹
(
L
, 
ba£
);

203 
glob®L
 = 
L
;

204 
	`sigÇl
(
SIGINT
, 
ÏùiÚ
);

205 
¡©us
 = 
	`lua_pÿÎ
(
L
, 
Çrg
, 
Äes
, 
ba£
);

206 
	`sigÇl
(
SIGINT
, 
SIG_DFL
);

207 
	`lua_»move
(
L
, 
ba£
);

208  
¡©us
;

209 
	}
}

212 
	$´št_v”siÚ
 () {

213 
	`lua_wr™e¡ršg
(
LUA_COPYRIGHT
, 
	`¡¾’
(LUA_COPYRIGHT));

214 
	`lua_wr™–še
();

215 
	}
}

226 
	$ü—‹¬gbË
 (
lua_S‹
 *
L
, **
¬gv
, 
¬gc
, 
süt
) {

227 
i
, 
Çrg
;

228 ià(
süt
 =ğ
¬gc
) script = 0;

229 
Çrg
 = 
¬gc
 - (
süt
 + 1);

230 
	`lua_ü—‹bË
(
L
, 
Çrg
, 
süt
 + 1);

231 
i
 = 0; i < 
¬gc
; i++) {

232 
	`lua_push¡ršg
(
L
, 
¬gv
[
i
]);

233 
	`lua_¿w£ti
(
L
, -2, 
i
 - 
süt
);

235 
	`lua_£tglob®
(
L
, "arg");

236 
	}
}

239 
	$dochunk
 (
lua_S‹
 *
L
, 
¡©us
) {

240 ià(
¡©us
 =ğ
LUA_OK
è¡©u ğ
	`doÿÎ
(
L
, 0, 0);

241  
	`»pÜt
(
L
, 
¡©us
);

242 
	}
}

245 
	$dofe
 (
lua_S‹
 *
L
, cÚ¡ *
Çme
) {

246  
	`dochunk
(
L
, 
	`luaL_lßdfe
(L, 
Çme
));

247 
	}
}

250 
	$do¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
s
, cÚ¡ *
Çme
) {

251  
	`dochunk
(
L
, 
	`luaL_lßdbufãr
(L, 
s
, 
	`¡¾’
(s), 
Çme
));

252 
	}
}

259 
	$dŞib¿ry
 (
lua_S‹
 *
L
, cÚ¡ *
Çme
) {

260 
¡©us
;

261 
	`lua_g‘glob®
(
L
, "require");

262 
	`lua_push¡ršg
(
L
, 
Çme
);

263 
¡©us
 = 
	`doÿÎ
(
L
, 1, 1);

264 ià(
¡©us
 =ğ
LUA_OK
)

265 
	`lua_£tglob®
(
L
, 
Çme
);

266  
	`»pÜt
(
L
, 
¡©us
);

267 
	}
}

273 cÚ¡ *
	$g‘_´om±
 (
lua_S‹
 *
L
, 
fœ¡lše
) {

274 cÚ¡ *
p
;

275 
	`lua_g‘glob®
(
L
, 
fœ¡lše
 ? "_PROMPT" : "_PROMPT2");

276 
p
 = 
	`lua_to¡ršg
(
L
, -1);

277 ià(
p
 =ğ
NULL
è°ğ(
fœ¡lše
 ? 
LUA_PROMPT
 : 
LUA_PROMPT2
);

278  
p
;

279 
	}
}

282 
	#EOFMARK
 "<eof>"

	)

283 
	#m¬kËn
 ((
EOFMARK
)/(è- 1)

	)

291 
	$šcom¶‘e
 (
lua_S‹
 *
L
, 
¡©us
) {

292 ià(
¡©us
 =ğ
LUA_ERRSYNTAX
) {

293 
size_t
 
lmsg
;

294 cÚ¡ *
msg
 = 
	`lua_tŞ¡ršg
(
L
, -1, &
lmsg
);

295 ià(
lmsg
 >ğ
m¬kËn
 && 
	`¡rcmp
(
msg
 +†msg - m¬kËn, 
EOFMARK
) == 0) {

296 
	`lua_pİ
(
L
, 1);

301 
	}
}

307 
	$pushlše
 (
lua_S‹
 *
L
, 
fœ¡lše
) {

308 
bufãr
[
LUA_MAXINPUT
];

309 *
b
 = 
bufãr
;

310 
size_t
 
l
;

311 cÚ¡ *
´mt
 = 
	`g‘_´om±
(
L
, 
fœ¡lše
);

312 
»ad¡©us
 = 
	`lua_»adlše
(
L
, 
b
, 
´mt
);

313 ià(
»ad¡©us
 == 0)

315 
	`lua_pİ
(
L
, 1);

316 
l
 = 
	`¡¾’
(
b
);

317 ià(
l
 > 0 && 
b
[l-1] == '\n')

318 
b
[--
l
] = '\0';

319 ià(
fœ¡lše
 && 
b
[0] == '=')

320 
	`lua_pushf¡ršg
(
L
, "»tuº %s", 
b
 + 1);

322 
	`lua_pushl¡ršg
(
L
, 
b
, 
l
);

323 
	`lua_ä“lše
(
L
, 
b
);

325 
	}
}

332 
	$add»tuº
 (
lua_S‹
 *
L
) {

333 cÚ¡ *
lše
 = 
	`lua_to¡ršg
(
L
, -1);

334 cÚ¡ *
»še
 = 
	`lua_pushf¡ršg
(
L
, "»tuº %s;", 
lše
);

335 
¡©us
 = 
	`luaL_lßdbufãr
(
L
, 
»še
, 
	`¡¾’
(retline), "=stdin");

336 ià(
¡©us
 =ğ
LUA_OK
) {

337 
	`lua_»move
(
L
, -2);

338 ià(
lše
[0] != '\0')

339 
	`lua_§v–še
(
L
, 
lše
);

342 
	`lua_pİ
(
L
, 2);

343  
¡©us
;

344 
	}
}

350 
	$muÉše
 (
lua_S‹
 *
L
) {

352 
size_t
 
Ën
;

353 cÚ¡ *
lše
 = 
	`lua_tŞ¡ršg
(
L
, 1, &
Ën
);

354 
¡©us
 = 
	`luaL_lßdbufãr
(
L
, 
lše
, 
Ën
, "=stdin");

355 ià(!
	`šcom¶‘e
(
L
, 
¡©us
è|| !
	`pushlše
(L, 0)) {

356 
	`lua_§v–še
(
L
, 
lše
);

357  
¡©us
;

359 
	`lua_pushl™”®
(
L
, "\n");

360 
	`lua_š£¹
(
L
, -2);

361 
	`lua_cÚÿt
(
L
, 3);

363 
	}
}

372 
	$lßdlše
 (
lua_S‹
 *
L
) {

373 
¡©us
;

374 
	`lua_£‰İ
(
L
, 0);

375 ià(!
	`pushlše
(
L
, 1))

377 ià((
¡©us
 = 
	`add»tuº
(
L
)è!ğ
LUA_OK
)

378 
¡©us
 = 
	`muÉše
(
L
);

379 
	`lua_»move
(
L
, 1);

380 
	`lua_as£¹
(
	`lua_g‘tİ
(
L
) == 1);

381  
¡©us
;

382 
	}
}

388 
	$l_´št
 (
lua_S‹
 *
L
) {

389 
n
 = 
	`lua_g‘tİ
(
L
);

390 ià(
n
 > 0) {

391 
	`luaL_check¡ack
(
L
, 
LUA_MINSTACK
, "too many„esultso…rint");

392 
	`lua_g‘glob®
(
L
, "print");

393 
	`lua_š£¹
(
L
, 1);

394 ià(
	`lua_pÿÎ
(
L
, 
n
, 0, 0è!ğ
LUA_OK
)

395 
	`l_mes§ge
(
´ogÇme
, 
	`lua_pushf¡ršg
(
L
, "error calling 'print' (%s)",

396 
	`lua_to¡ršg
(
L
, -1)));

398 
	}
}

405 
	$doREPL
 (
lua_S‹
 *
L
) {

406 
¡©us
;

407 cÚ¡ *
Şd´ogÇme
 = 
´ogÇme
;

408 
´ogÇme
 = 
NULL
;

409 (
¡©us
 = 
	`lßdlše
(
L
)) != -1) {

410 ià(
¡©us
 =ğ
LUA_OK
)

411 
¡©us
 = 
	`doÿÎ
(
L
, 0, 
LUA_MULTRET
);

412 ià(
¡©us
 =ğ
LUA_OK
è
	`l_´št
(
L
);

413 
	`»pÜt
(
L
, 
¡©us
);

415 
	`lua_£‰İ
(
L
, 0);

416 
	`lua_wr™–še
();

417 
´ogÇme
 = 
Şd´ogÇme
;

418 
	}
}

424 
	$push¬gs
 (
lua_S‹
 *
L
) {

425 
i
, 
n
;

426 ià(
	`lua_g‘glob®
(
L
, "¬g"è!ğ
LUA_TTABLE
)

427 
	`luaL_”rÜ
(
L
, "'arg' is‚ot‡able");

428 
n
 = ()
	`luaL_Ën
(
L
, -1);

429 
	`luaL_check¡ack
(
L
, 
n
 + 3, "too many‡rgumentso script");

430 
i
 = 1; i <ğ
n
; i++)

431 
	`lua_¿wg‘i
(
L
, -
i
, i);

432 
	`lua_»move
(
L
, -
i
);

433  
n
;

434 
	}
}

437 
	$hªdË_süt
 (
lua_S‹
 *
L
, **
¬gv
) {

438 
¡©us
;

439 cÚ¡ *
âame
 = 
¬gv
[0];

440 ià(
	`¡rcmp
(
âame
, "-"è=ğ0 && sŒcmp(
¬gv
[-1], "--") != 0)

441 
âame
 = 
NULL
;

442 
¡©us
 = 
	`luaL_lßdfe
(
L
, 
âame
);

443 ià(
¡©us
 =ğ
LUA_OK
) {

444 
n
 = 
	`push¬gs
(
L
);

445 
¡©us
 = 
	`doÿÎ
(
L
, 
n
, 
LUA_MULTRET
);

447  
	`»pÜt
(
L
, 
¡©us
);

448 
	}
}

453 
	#has_”rÜ
 1

	)

454 
	#has_i
 2

	)

455 
	#has_v
 4

	)

456 
	#has_e
 8

	)

457 
	#has_E
 16

	)

465 
	$cŞËù¬gs
 (**
¬gv
, *
fœ¡
) {

466 
¬gs
 = 0;

467 
i
;

468 
i
 = 1; 
¬gv
[i] !ğ
NULL
; i++) {

469 *
fœ¡
 = 
i
;

470 ià(
¬gv
[
i
][0] != '-')

471  
¬gs
;

472 
¬gv
[
i
][1]) {

474 ià(
¬gv
[
i
][2] != '\0')

475  
has_”rÜ
;

476 *
fœ¡
 = 
i
 + 1;

477  
¬gs
;

479  
¬gs
;

481 ià(
¬gv
[
i
][2] != '\0')

482  
has_”rÜ
;

483 
¬gs
 |ğ
has_E
;

486 
¬gs
 |ğ
has_i
;

488 ià(
¬gv
[
i
][2] != '\0')

489  
has_”rÜ
;

490 
¬gs
 |ğ
has_v
;

493 
¬gs
 |ğ
has_e
;

495 ià(
¬gv
[
i
][2] == '\0') {

496 
i
++;

497 ià(
¬gv
[
i
] =ğ
NULL
 ||‡rgv[i][0] == '-')

498  
has_”rÜ
;

502  
has_”rÜ
;

505 *
fœ¡
 = 
i
;

506  
¬gs
;

507 
	}
}

514 
	$ruÇrgs
 (
lua_S‹
 *
L
, **
¬gv
, 
n
) {

515 
i
;

516 
i
 = 1; i < 
n
; i++) {

517 
İtiÚ
 = 
¬gv
[
i
][1];

518 
	`lua_as£¹
(
¬gv
[
i
][0] == '-');

519 ià(
İtiÚ
 == 'e' || option == 'l') {

520 
¡©us
;

521 cÚ¡ *
exŒa
 = 
¬gv
[
i
] + 2;

522 ià(*
exŒa
 =ğ'\0'èexŒ¨ğ
¬gv
[++
i
];

523 
	`lua_as£¹
(
exŒa
 !ğ
NULL
);

524 
¡©us
 = (
İtiÚ
 == 'e')

525 ? 
	`do¡ršg
(
L
, 
exŒa
, "=(command†ine)")

526 : 
	`dŞib¿ry
(
L
, 
exŒa
);

527 ià(
¡©us
 !ğ
LUA_OK
)  0;

531 
	}
}

535 
	$hªdË_luaš™
 (
lua_S‹
 *
L
) {

536 cÚ¡ *
Çme
 = "=" 
LUA_INITVARVERSION
;

537 cÚ¡ *
š™
 = 
	`g‘’v
(
Çme
 + 1);

538 ià(
š™
 =ğ
NULL
) {

539 
Çme
 = "=" 
LUA_INIT_VAR
;

540 
š™
 = 
	`g‘’v
(
Çme
 + 1);

542 ià(
š™
 =ğ
NULL
è 
LUA_OK
;

543 ià(
š™
[0] == '@')

544  
	`dofe
(
L
, 
š™
+1);

546  
	`do¡ršg
(
L
, 
š™
, 
Çme
);

547 
	}
}

554 
	$pmaš
 (
lua_S‹
 *
L
) {

555 
¬gc
 = ()
	`lua_toš‹g”
(
L
, 1);

556 **
¬gv
 = (**)
	`lua_tou£rd©a
(
L
, 2);

557 
süt
;

558 
¬gs
 = 
	`cŞËù¬gs
(
¬gv
, &
süt
);

559 
	`luaL_checkv”siÚ
(
L
);

560 ià(
¬gv
[0] &&‡rgv[0][0]è
´ogÇme
 =‡rgv[0];

561 ià(
¬gs
 =ğ
has_”rÜ
) {

562 
	`´št_u§ge
(
¬gv
[
süt
]);

565 ià(
¬gs
 & 
has_v
)

566 
	`´št_v”siÚ
();

567 ià(
¬gs
 & 
has_E
) {

568 
	`lua_pushboŞ—n
(
L
, 1);

569 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, "LUA_NOENV");

571 
	`luaL_İ’libs
(
L
);

572 
	`ü—‹¬gbË
(
L
, 
¬gv
, 
¬gc
, 
süt
);

573 ià(!(
¬gs
 & 
has_E
)) {

574 ià(
	`hªdË_luaš™
(
L
è!ğ
LUA_OK
)

577 ià(!
	`ruÇrgs
(
L
, 
¬gv
, 
süt
))

579 ià(
süt
 < 
¬gc
 &&

580 
	`hªdË_süt
(
L
, 
¬gv
 + 
süt
è!ğ
LUA_OK
)

582 ià(
¬gs
 & 
has_i
)

583 
	`doREPL
(
L
);

584 ià(
süt
 =ğ
¬gc
 && !(
¬gs
 & (
has_e
 | 
has_v
))) {

585 ià(
	`lua_¡dš_is_‰y
()) {

586 
	`´št_v”siÚ
();

587 
	`doREPL
(
L
);

589 
	`dofe
(
L
, 
NULL
);

591 
	`lua_pushboŞ—n
(
L
, 1);

593 
	}
}

596 
	$maš
 (
¬gc
, **
¬gv
) {

597 
¡©us
, 
»suÉ
;

598 
lua_S‹
 *
L
 = 
	`luaL_Ãw¡©e
();

599 ià(
L
 =ğ
NULL
) {

600 
	`l_mes§ge
(
¬gv
[0], "cannot create state:‚otƒnough memory");

601  
EXIT_FAILURE
;

603 
	`lua_pushcfunùiÚ
(
L
, &
pmaš
);

604 
	`lua_pushš‹g”
(
L
, 
¬gc
);

605 
	`lua_pushlightu£rd©a
(
L
, 
¬gv
);

606 
¡©us
 = 
	`lua_pÿÎ
(
L
, 2, 1, 0);

607 
»suÉ
 = 
	`lua_toboŞ—n
(
L
, -1);

608 
	`»pÜt
(
L
, 
¡©us
);

609 
	`lua_şo£
(
L
);

610  (
»suÉ
 && 
¡©us
 =ğ
LUA_OK
è? 
EXIT_SUCCESS
 : 
EXIT_FAILURE
;

611 
	}
}

	@script/lua/lua-5.3.4/src/lua.h

9 #iâdeà
lua_h


10 
	#lua_h


	)

12 
	~<¡d¬g.h
>

13 
	~<¡ddef.h
>

16 
	~"luacÚf.h
"

19 
	#LUA_VERSION_MAJOR
 "5"

	)

20 
	#LUA_VERSION_MINOR
 "3"

	)

21 
	#LUA_VERSION_NUM
 503

	)

22 
	#LUA_VERSION_RELEASE
 "4"

	)

24 
	#LUA_VERSION
 "Lu¨" 
LUA_VERSION_MAJOR
 "." 
LUA_VERSION_MINOR


	)

25 
	#LUA_RELEASE
 
LUA_VERSION
 "." 
LUA_VERSION_RELEASE


	)

26 
	#LUA_COPYRIGHT
 
LUA_RELEASE
 " Cİyrighˆ(Cè1994-2017 Lua.Üg, PUC-Rio"

	)

27 
	#LUA_AUTHORS
 "R. I”u§limschy, L. H. dFigueœedo, W. C–es"

	)

31 
	#LUA_SIGNATURE
 "\x1bLua"

	)

34 
	#LUA_MULTRET
 (-1)

	)

42 
	#LUA_REGISTRYINDEX
 (-
LUAI_MAXSTACK
 - 1000)

	)

43 
	#lua_upv®uešdex
(
i
è(
LUA_REGISTRYINDEX
 - (i))

	)

47 
	#LUA_OK
 0

	)

48 
	#LUA_YIELD
 1

	)

49 
	#LUA_ERRRUN
 2

	)

50 
	#LUA_ERRSYNTAX
 3

	)

51 
	#LUA_ERRMEM
 4

	)

52 
	#LUA_ERRGCMM
 5

	)

53 
	#LUA_ERRERR
 6

	)

56 
lua_S‹
 
	tlua_S‹
;

62 
	#LUA_TNONE
 (-1)

	)

64 
	#LUA_TNIL
 0

	)

65 
	#LUA_TBOOLEAN
 1

	)

66 
	#LUA_TLIGHTUSERDATA
 2

	)

67 
	#LUA_TNUMBER
 3

	)

68 
	#LUA_TSTRING
 4

	)

69 
	#LUA_TTABLE
 5

	)

70 
	#LUA_TFUNCTION
 6

	)

71 
	#LUA_TUSERDATA
 7

	)

72 
	#LUA_TTHREAD
 8

	)

74 
	#LUA_NUMTAGS
 9

	)

79 
	#LUA_MINSTACK
 20

	)

83 
	#LUA_RIDX_MAINTHREAD
 1

	)

84 
	#LUA_RIDX_GLOBALS
 2

	)

85 
	#LUA_RIDX_LAST
 
LUA_RIDX_GLOBALS


	)

89 
LUA_NUMBER
 
	tlua_Numb”
;

93 
LUA_INTEGER
 
	tlua_IÁeg”
;

96 
LUA_UNSIGNED
 
	tlua_UnsigÃd
;

99 
LUA_KCONTEXT
 
	tlua_KCÚ‹xt
;

105 (*
	tlua_CFunùiÚ
è(
	tlua_S‹
 *
	tL
);

110 (*
	tlua_KFunùiÚ
è(
	tlua_S‹
 *
	tL
, 
	t¡©us
, 
	tlua_KCÚ‹xt
 
	tùx
);

116 cÚ¡ * (*
	tlua_R—d”
è(
	tlua_S‹
 *
	tL
, *
	tud
, 
	tsize_t
 *
	tsz
);

118 (*
	tlua_Wr™”
è(
	tlua_S‹
 *
	tL
, cÚ¡ *
	tp
, 
	tsize_t
 
	tsz
, *
	tud
);

124 * (*
	tlua_AÎoc
è(*
	tud
, *
	t±r
, 
	tsize_t
 
	tosize
, size_ˆ
	tnsize
);

131 #ià
	`defšed
(
LUA_USER_H
)

132 #šşud
LUA_USER_H


139 cÚ¡ 
lua_id’t
[];

145 
LUA_API
 
lua_S‹
 *(
lua_Ãw¡©e
è(
lua_AÎoc
 
f
, *
ud
);

146 
LUA_API
 (
lua_şo£
è(
lua_S‹
 *
L
);

147 
LUA_API
 
lua_S‹
 *(
lua_Ãwth»ad
èÖua_S‹ *
L
);

149 
LUA_API
 
	$lua_CFunùiÚ
 (
lua_©·nic
è(
lua_S‹
 *
L
, 
lua_CFunùiÚ
 
·nicf
);

152 
LUA_API
 cÚ¡ 
lua_Numb”
 *(
lua_v”siÚ
è(
lua_S‹
 *
L
);

158 
LUA_API
 (
lua_absšdex
è(
lua_S‹
 *
L
, 
idx
);

159 
LUA_API
 (
lua_g‘tİ
è(
lua_S‹
 *
L
);

160 
LUA_API
 (
lua_£‰İ
è(
lua_S‹
 *
L
, 
idx
);

161 
LUA_API
 (
lua_pushv®ue
è(
lua_S‹
 *
L
, 
idx
);

162 
LUA_API
 (
lua_rÙ©e
è(
lua_S‹
 *
L
, 
idx
, 
n
);

163 
LUA_API
 (
lua_cİy
è(
lua_S‹
 *
L
, 
äomidx
, 
toidx
);

164 
LUA_API
 (
lua_check¡ack
è(
lua_S‹
 *
L
, 
n
);

166 
LUA_API
 (
lua_xmove
è(
lua_S‹
 *
äom
,†ua_S‹ *
to
, 
n
);

173 
LUA_API
 (
lua_i¢umb”
è(
lua_S‹
 *
L
, 
idx
);

174 
LUA_API
 (
lua_is¡ršg
è(
lua_S‹
 *
L
, 
idx
);

175 
LUA_API
 (
lua_iscfunùiÚ
è(
lua_S‹
 *
L
, 
idx
);

176 
LUA_API
 (
lua_isš‹g”
è(
lua_S‹
 *
L
, 
idx
);

177 
LUA_API
 (
lua_isu£rd©a
è(
lua_S‹
 *
L
, 
idx
);

178 
LUA_API
 (
lua_ty³
è(
lua_S‹
 *
L
, 
idx
);

179 
LUA_API
 cÚ¡ *(
lua_ty³Çme
è(
lua_S‹
 *
L
, 

);

181 
LUA_API
 
	$lua_Numb”
 (
lua_tÚumb”x
è(
lua_S‹
 *
L
, 
idx
, *
i¢um
);

182 
LUA_API
 
	$lua_IÁeg”
 (
lua_toš‹g”x
è(
lua_S‹
 *
L
, 
idx
, *
i¢um
);

183 
LUA_API
 (
lua_toboŞ—n
è(
lua_S‹
 *
L
, 
idx
);

184 
LUA_API
 cÚ¡ *(
lua_tŞ¡ršg
è(
lua_S‹
 *
L
, 
idx
, 
size_t
 *
Ën
);

185 
LUA_API
 
	$size_t
 (
lua_¿wËn
è(
lua_S‹
 *
L
, 
idx
);

186 
LUA_API
 
	$lua_CFunùiÚ
 (
lua_tocfunùiÚ
è(
lua_S‹
 *
L
, 
idx
);

187 
LUA_API
 *(
lua_tou£rd©a
è(
lua_S‹
 *
L
, 
idx
);

188 
LUA_API
 
lua_S‹
 *(
lua_tÙh»ad
èÖua_S‹ *
L
, 
idx
);

189 
LUA_API
 cÚ¡ *(
lua_tİoš‹r
è(
lua_S‹
 *
L
, 
idx
);

196 
	#LUA_OPADD
 0

	)

197 
	#LUA_OPSUB
 1

	)

198 
	#LUA_OPMUL
 2

	)

199 
	#LUA_OPMOD
 3

	)

200 
	#LUA_OPPOW
 4

	)

201 
	#LUA_OPDIV
 5

	)

202 
	#LUA_OPIDIV
 6

	)

203 
	#LUA_OPBAND
 7

	)

204 
	#LUA_OPBOR
 8

	)

205 
	#LUA_OPBXOR
 9

	)

206 
	#LUA_OPSHL
 10

	)

207 
	#LUA_OPSHR
 11

	)

208 
	#LUA_OPUNM
 12

	)

209 
	#LUA_OPBNOT
 13

	)

211 
LUA_API
 (
lua_¬™h
è(
lua_S‹
 *
L
, 
İ
);

213 
	#LUA_OPEQ
 0

	)

214 
	#LUA_OPLT
 1

	)

215 
	#LUA_OPLE
 2

	)

217 
LUA_API
 (
lua_¿wequ®
è(
lua_S‹
 *
L
, 
idx1
, 
idx2
);

218 
LUA_API
 (
lua_com·»
è(
lua_S‹
 *
L
, 
idx1
, 
idx2
, 
İ
);

224 
LUA_API
 (
lua_pushn
è(
lua_S‹
 *
L
);

225 
LUA_API
 (
lua_pushnumb”
è(
lua_S‹
 *
L
, 
lua_Numb”
 
n
);

226 
LUA_API
 (
lua_pushš‹g”
è(
lua_S‹
 *
L
, 
lua_IÁeg”
 
n
);

227 
LUA_API
 cÚ¡ *(
lua_pushl¡ršg
è(
lua_S‹
 *
L
, cÚ¡ *
s
, 
size_t
 
Ën
);

228 
LUA_API
 cÚ¡ *(
lua_push¡ršg
è(
lua_S‹
 *
L
, cÚ¡ *
s
);

229 
LUA_API
 cÚ¡ *(
lua_pushvf¡ršg
è(
lua_S‹
 *
L
, cÚ¡ *
fmt
,

230 
va_li¡
 
¬gp
);

231 
LUA_API
 cÚ¡ *(
lua_pushf¡ršg
è(
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...);

232 
LUA_API
 (
lua_pushcşosu»
è(
lua_S‹
 *
L
, 
lua_CFunùiÚ
 
â
, 
n
);

233 
LUA_API
 (
lua_pushboŞ—n
è(
lua_S‹
 *
L
, 
b
);

234 
LUA_API
 (
lua_pushlightu£rd©a
è(
lua_S‹
 *
L
, *
p
);

235 
LUA_API
 (
lua_pushth»ad
è(
lua_S‹
 *
L
);

241 
LUA_API
 (
lua_g‘glob®
è(
lua_S‹
 *
L
, cÚ¡ *
Çme
);

242 
LUA_API
 (
lua_g‘bË
è(
lua_S‹
 *
L
, 
idx
);

243 
LUA_API
 (
lua_g‘f›ld
è(
lua_S‹
 *
L
, 
idx
, cÚ¡ *
k
);

244 
LUA_API
 (
lua_g‘i
è(
lua_S‹
 *
L
, 
idx
, 
lua_IÁeg”
 
n
);

245 
LUA_API
 (
lua_¿wg‘
è(
lua_S‹
 *
L
, 
idx
);

246 
LUA_API
 (
lua_¿wg‘i
è(
lua_S‹
 *
L
, 
idx
, 
lua_IÁeg”
 
n
);

247 
LUA_API
 (
lua_¿wg‘p
è(
lua_S‹
 *
L
, 
idx
, cÚ¡ *
p
);

249 
LUA_API
 (
lua_ü—‹bË
è(
lua_S‹
 *
L
, 
Ç¼
, 
Äec
);

250 
LUA_API
 *(
lua_Ãwu£rd©a
è(
lua_S‹
 *
L
, 
size_t
 
sz
);

251 
LUA_API
 (
lua_g‘m‘©abË
è(
lua_S‹
 *
L
, 
objšdex
);

252 
LUA_API
 (
lua_g‘u£rv®ue
è(
lua_S‹
 *
L
, 
idx
);

258 
LUA_API
 (
lua_£tglob®
è(
lua_S‹
 *
L
, cÚ¡ *
Çme
);

259 
LUA_API
 (
lua_£‰abË
è(
lua_S‹
 *
L
, 
idx
);

260 
LUA_API
 (
lua_£tf›ld
è(
lua_S‹
 *
L
, 
idx
, cÚ¡ *
k
);

261 
LUA_API
 (
lua_£ti
è(
lua_S‹
 *
L
, 
idx
, 
lua_IÁeg”
 
n
);

262 
LUA_API
 (
lua_¿w£t
è(
lua_S‹
 *
L
, 
idx
);

263 
LUA_API
 (
lua_¿w£ti
è(
lua_S‹
 *
L
, 
idx
, 
lua_IÁeg”
 
n
);

264 
LUA_API
 (
lua_¿w£
è(
lua_S‹
 *
L
, 
idx
, cÚ¡ *
p
);

265 
LUA_API
 (
lua_£tm‘©abË
è(
lua_S‹
 *
L
, 
objšdex
);

266 
LUA_API
 (
lua_£tu£rv®ue
è(
lua_S‹
 *
L
, 
idx
);

272 
LUA_API
 (
lua_ÿÎk
è(
lua_S‹
 *
L
, 
Çrgs
, 
ÄesuÉs
,

273 
lua_KCÚ‹xt
 
ùx
, 
lua_KFunùiÚ
 
k
);

274 
	#lua_ÿÎ
(
L
,
n
,
r
è
	`lua_ÿÎk
(L, (n), (r), 0, 
NULL
)

	)

276 
LUA_API
 (
lua_pÿÎk
è(
lua_S‹
 *
L
, 
Çrgs
, 
ÄesuÉs
, 
”rfunc
,

277 
lua_KCÚ‹xt
 
ùx
, 
lua_KFunùiÚ
 
k
);

278 
	#lua_pÿÎ
(
L
,
n
,
r
,
f
è
	`lua_pÿÎk
(L, (n), (r), (f), 0, 
NULL
)

	)

280 
LUA_API
 (
lua_lßd
è(
lua_S‹
 *
L
, 
lua_R—d”
 
»ad”
, *
dt
,

281 cÚ¡ *
chunkÇme
, cÚ¡ *
mode
);

283 
LUA_API
 (
lua_dump
è(
lua_S‹
 *
L
, 
lua_Wr™”
 
wr™”
, *
d©a
, 
¡r
);

289 
LUA_API
 (
lua_y›ldk
è(
lua_S‹
 *
L
, 
ÄesuÉs
, 
lua_KCÚ‹xt
 
ùx
,

290 
lua_KFunùiÚ
 
k
);

291 
LUA_API
 (
lua_»sume
è(
lua_S‹
 *
L
,†ua_S‹ *
äom
, 
Çrg
);

292 
LUA_API
 (
lua_¡©us
è(
lua_S‹
 *
L
);

293 
LUA_API
 (
lua_isy›ldabË
è(
lua_S‹
 *
L
);

295 
	#lua_y›ld
(
L
,
n
è
	`lua_y›ldk
(L, (n), 0, 
NULL
)

	)

302 
	#LUA_GCSTOP
 0

	)

303 
	#LUA_GCRESTART
 1

	)

304 
	#LUA_GCCOLLECT
 2

	)

305 
	#LUA_GCCOUNT
 3

	)

306 
	#LUA_GCCOUNTB
 4

	)

307 
	#LUA_GCSTEP
 5

	)

308 
	#LUA_GCSETPAUSE
 6

	)

309 
	#LUA_GCSETSTEPMUL
 7

	)

310 
	#LUA_GCISRUNNING
 9

	)

312 
LUA_API
 (
lua_gc
è(
lua_S‹
 *
L
, 
wh©
, 
d©a
);

319 
LUA_API
 (
lua_”rÜ
è(
lua_S‹
 *
L
);

321 
LUA_API
 (
lua_Ãxt
è(
lua_S‹
 *
L
, 
idx
);

323 
LUA_API
 (
lua_cÚÿt
è(
lua_S‹
 *
L
, 
n
);

324 
LUA_API
 (
lua_Ën
è(
lua_S‹
 *
L
, 
idx
);

326 
LUA_API
 
	$size_t
 (
lua_¡ršgtÚumb”
è(
lua_S‹
 *
L
, cÚ¡ *
s
);

328 
LUA_API
 
	$lua_AÎoc
 (
lua_g‘®locf
è(
lua_S‹
 *
L
, **
ud
);

329 
LUA_API
 (
lua_£Îocf
è(
lua_S‹
 *
L
, 
lua_AÎoc
 
f
, *
ud
);

339 
	#lua_g‘exŒa¥aû
(
L
è((*)((*)(Lè- 
LUA_EXTRASPACE
))

	)

341 
	#lua_tÚumb”
(
L
,
i
è
	`lua_tÚumb”x
(L,(i),
NULL
)

	)

342 
	#lua_toš‹g”
(
L
,
i
è
	`lua_toš‹g”x
(L,(i),
NULL
)

	)

344 
	#lua_pİ
(
L
,
n
è
	`lua_£‰İ
(L, -Ò)-1)

	)

346 
	#lua_ÃwbË
(
L
è
	`lua_ü—‹bË
(L, 0, 0)

	)

348 
	#lua_»gi¡”
(
L
,
n
,
f
è(
	`lua_pushcfunùiÚ
(L, (f)), 
	`lua_£tglob®
(L, (n)))

	)

350 
	#lua_pushcfunùiÚ
(
L
,
f
è
	`lua_pushcşosu»
(L, (f), 0)

	)

352 
	#lua_isfunùiÚ
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TFUNCTION
)

	)

353 
	#lua_i¡abË
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TTABLE
)

	)

354 
	#lua_i¦ightu£rd©a
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TLIGHTUSERDATA
)

	)

355 
	#lua_i¢
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TNIL
)

	)

356 
	#lua_isboŞ—n
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TBOOLEAN
)

	)

357 
	#lua_i¡h»ad
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TTHREAD
)

	)

358 
	#lua_i¢Úe
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TNONE
)

	)

359 
	#lua_i¢ÚeÜn
(
L
, 
n
è(
	`lua_ty³
(L, (n)è<ğ0)

	)

361 
	#lua_pushl™”®
(
L
, 
s
è
	`lua_push¡ršg
(L, "" s)

	)

363 
	#lua_pushglob®bË
(
L
) \

364 (()
	`lua_¿wg‘i
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_RIDX_GLOBALS
))

	)

366 
	#lua_to¡ršg
(
L
,
i
è
	`lua_tŞ¡ršg
(L, (i), 
NULL
)

	)

369 
	#lua_š£¹
(
L
,
idx
è
	`lua_rÙ©e
(L, (idx), 1)

	)

371 
	#lua_»move
(
L
,
idx
è(
	`lua_rÙ©e
(L, (idx), -1), 
	`lua_pİ
(L, 1))

	)

373 
	#lua_»¶aû
(
L
,
idx
è(
	`lua_cİy
(L, -1, (idx)), 
	`lua_pİ
(L, 1))

	)

383 #ià
	`defšed
(
LUA_COMPAT_APIINTCASTS
)

385 
	#lua_pushunsigÃd
(
L
,
n
è
	`lua_pushš‹g”
(L, (
lua_IÁeg”
)Ò))

	)

386 
	#lua_tounsigÃdx
(
L
,
i
,
is
è((
lua_UnsigÃd
)
	`lua_toš‹g”x
(L,i,is))

	)

387 
	#lua_tounsigÃd
(
L
,
i
è
	`lua_tounsigÃdx
(L,(i),
NULL
)

	)

402 
	#LUA_HOOKCALL
 0

	)

403 
	#LUA_HOOKRET
 1

	)

404 
	#LUA_HOOKLINE
 2

	)

405 
	#LUA_HOOKCOUNT
 3

	)

406 
	#LUA_HOOKTAILCALL
 4

	)

412 
	#LUA_MASKCALL
 (1 << 
LUA_HOOKCALL
)

	)

413 
	#LUA_MASKRET
 (1 << 
LUA_HOOKRET
)

	)

414 
	#LUA_MASKLINE
 (1 << 
LUA_HOOKLINE
)

	)

415 
	#LUA_MASKCOUNT
 (1 << 
LUA_HOOKCOUNT
)

	)

417 
lua_Debug
 
	tlua_Debug
;

421 (*
	tlua_Hook
è(
	tlua_S‹
 *
	tL
, 
	tlua_Debug
 *
	t¬
);

424 
LUA_API
 (
lua_g‘¡ack
è(
lua_S‹
 *
L
, 
Ëv–
, 
lua_Debug
 *
¬
);

425 
LUA_API
 (
lua_g‘šfo
è(
lua_S‹
 *
L
, cÚ¡ *
wh©
, 
lua_Debug
 *
¬
);

426 
LUA_API
 cÚ¡ *(
lua_g‘loÿl
è(
lua_S‹
 *
L
, cÚ¡ 
lua_Debug
 *
¬
, 
n
);

427 
LUA_API
 cÚ¡ *(
lua_£oÿl
è(
lua_S‹
 *
L
, cÚ¡ 
lua_Debug
 *
¬
, 
n
);

428 
LUA_API
 cÚ¡ *(
lua_g‘upv®ue
è(
lua_S‹
 *
L
, 
funcšdex
, 
n
);

429 
LUA_API
 cÚ¡ *(
lua_£tupv®ue
è(
lua_S‹
 *
L
, 
funcšdex
, 
n
);

431 
LUA_API
 *(
lua_upv®ueid
è(
lua_S‹
 *
L
, 
fidx
, 
n
);

432 
LUA_API
 (
lua_upv®uejoš
è(
lua_S‹
 *
L
, 
fidx1
, 
n1
,

433 
fidx2
, 
n2
);

435 
LUA_API
 (
lua_£thook
è(
lua_S‹
 *
L
, 
lua_Hook
 
func
, 
mask
, 
couÁ
);

436 
LUA_API
 
	$lua_Hook
 (
lua_g‘hook
è(
lua_S‹
 *
L
);

437 
LUA_API
 (
lua_g‘hookmask
è(
lua_S‹
 *
L
);

438 
LUA_API
 (
lua_g‘hookcouÁ
è(
lua_S‹
 *
L
);

441 
	slua_Debug
 {

442 
ev’t
;

443 cÚ¡ *
Çme
;

444 cÚ¡ *
Çmewh©
;

445 cÚ¡ *
wh©
;

446 cÚ¡ *
sourû
;

447 
cu¼’še
;

448 
lšedefšed
;

449 
Ï¡lšedefšed
;

450 
nups
;

451 
Å¬ams
;

452 
isv¬¬g
;

453 
i¡aÿÎ
;

454 
shÜt_¤c
[
LUA_IDSIZE
];

456 
C®lInfo
 *
i_ci
;

	@script/lua/lua-5.3.4/src/lua.hpp

6 
	~"lua.h
"

7 
	~"lu®ib.h
"

8 
	~"Ïuxlib.h
"

	@script/lua/lua-5.3.4/src/luac.c

7 
	#luac_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

12 
	~<ùy³.h
>

13 
	~<”ºo.h
>

14 
	~<¡dio.h
>

15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

18 
	~"lua.h
"

19 
	~"Ïuxlib.h
"

21 
	~"lobjeù.h
"

22 
	~"l¡©e.h
"

23 
	~"lundump.h
"

25 
PrštFunùiÚ
(cÚ¡ 
PrÙo
* 
f
, 
fuÎ
);

26 
	#luaU_´št
 
PrštFunùiÚ


	)

28 
	#PROGNAME
 "luac"

	)

29 
	#OUTPUT
 
PROGNAME
 ".out"

	)

31 
	gli¡šg
=0;

32 
	gdumpšg
=1;

33 
	g¡rpšg
=0;

34 
	gOuut
[]={ 
OUTPUT
 };

35 cÚ¡ * 
	gouut
=
Ouut
;

36 cÚ¡ * 
	g´ogÇme
=
PROGNAME
;

38 
	$çl
(cÚ¡ * 
mes§ge
)

40 
	`årštf
(
¡d”r
,"%s: %s\n",
´ogÇme
,
mes§ge
);

41 
	`ex™
(
EXIT_FAILURE
);

42 
	}
}

44 
	$ÿÂÙ
(cÚ¡ * 
wh©
)

46 
	`årštf
(
¡d”r
,"%s: cªnÙ % %s: %s\n",
´ogÇme
,
wh©
,
ouut
,
	`¡»¼Ü
(
”ºo
));

47 
	`ex™
(
EXIT_FAILURE
);

48 
	}
}

50 
	$u§ge
(cÚ¡ * 
mes§ge
)

52 ià(*
mes§ge
=='-')

53 
	`årštf
(
¡d”r
,"%s: uÄecognized o±iÚ '%s'\n",
´ogÇme
,
mes§ge
);

55 
	`årštf
(
¡d”r
,"%s: %s\n",
´ogÇme
,
mes§ge
);

56 
	`årštf
(
¡d”r
,

66 ,
´ogÇme
,
Ouut
);

67 
	`ex™
(
EXIT_FAILURE
);

68 
	}
}

70 
	#IS
(
s
è(
	`¡rcmp
(
¬gv
[
i
],s)==0)

	)

72 
	$dßrgs
(
¬gc
, * 
¬gv
[])

74 
i
;

75 
v”siÚ
=0;

76 ià(
¬gv
[0]!=
NULL
 && *¬gv[0]!=0è
´ogÇme
=argv[0];

77 
i
=1; i<
¬gc
; i++)

79 ià(*
¬gv
[
i
]!='-')

81 ià(
	`IS
("--"))

83 ++
i
;

84 ià(
v”siÚ
) ++version;

87 ià(
	`IS
("-"))

89 ià(
	`IS
("-l"))

90 ++
li¡šg
;

91 ià(
	`IS
("-o"))

93 
ouut
=
¬gv
[++
i
];

94 ià(
ouut
==
NULL
 || *output==0 || (*output=='-' && output[1]!=0))

95 
	`u§ge
("'-o'‚eeds‡rgument");

96 ià(
	`IS
("-")è
ouut
=
NULL
;

98 ià(
	`IS
("-p"))

99 
dumpšg
=0;

100 ià(
	`IS
("-s"))

101 
¡rpšg
=1;

102 ià(
	`IS
("-v"))

103 ++
v”siÚ
;

105 
	`u§ge
(
¬gv
[
i
]);

107 ià(
i
==
¬gc
 && (
li¡šg
 || !
dumpšg
))

109 
dumpšg
=0;

110 
¬gv
[--
i
]=
Ouut
;

112 ià(
v”siÚ
)

114 
	`´štf
("%s\n",
LUA_COPYRIGHT
);

115 ià(
v”siÚ
==
¬gc
-1è
	`ex™
(
EXIT_SUCCESS
);

117  
i
;

118 
	}
}

120 
	#FUNCTION
 "(funùiÚ(ënd)();"

	)

122 cÚ¡ * 
	$»ad”
(
lua_S‹
 *
L
, *
ud
, 
size_t
 *
size
)

124 
	`UNUSED
(
L
);

125 ià((*(*)
ud
)--)

127 *
size
=(
FUNCTION
)-1;

128  
FUNCTION
;

132 *
size
=0;

133  
NULL
;

135 
	}
}

137 
	#tİrÙo
(
L
,
i
è
	`g‘´Ùo
(L->
tİ
+(i))

	)

139 cÚ¡ 
PrÙo
* 
	$combše
(
lua_S‹
* 
L
, 
n
)

141 ià(
n
==1)

142  
	`tİrÙo
(
L
,-1);

145 
PrÙo
* 
f
;

146 
i
=
n
;

147 ià(
	`lua_lßd
(
L
,
»ad”
,&
i
,"=(" 
PROGNAME
 ")",
NULL
)!=
LUA_OK
è
	`çl
(
	`lua_to¡ršg
(L,-1));

148 
f
=
	`tİrÙo
(
L
,-1);

149 
i
=0; i<
n
; i++)

151 
f
->
p
[
i
]=
	`tİrÙo
(
L
,i-
n
-1);

152 ià(
f
->
p
[
i
]->
sizeupv®ues
>0èf->p[i]->
upv®ues
[0].
š¡ack
=0;

154 
f
->
siz–šešfo
=0;

155  
f
;

157 
	}
}

159 
	$wr™”
(
lua_S‹
* 
L
, cÚ¡ * 
p
, 
size_t
 
size
, * 
u
)

161 
	`UNUSED
(
L
);

162  (
	`fwr™e
(
p
,
size
,1,(
FILE
*)
u
)!=1) && (size!=0);

163 
	}
}

165 
	$pmaš
(
lua_S‹
* 
L
)

167 
¬gc
=()
	`lua_toš‹g”
(
L
,1);

168 ** 
¬gv
=(**)
	`lua_tou£rd©a
(
L
,2);

169 cÚ¡ 
PrÙo
* 
f
;

170 
i
;

171 ià(!
	`lua_check¡ack
(
L
,
¬gc
)è
	`çl
("too many input files");

172 
i
=0; i<
¬gc
; i++)

174 cÚ¡ * 
f’ame
=
	`IS
("-"è? 
NULL
 : 
¬gv
[
i
];

175 ià(
	`luaL_lßdfe
(
L
,
f’ame
)!=
LUA_OK
è
	`çl
(
	`lua_to¡ršg
(L,-1));

177 
f
=
	`combše
(
L
,
¬gc
);

178 ià(
li¡šg
è
	`luaU_´št
(
f
,listing>1);

179 ià(
dumpšg
)

181 
FILE
* 
D
ğ(
ouut
==
NULL
è? 
¡dout
 : 
	`fİ’
(output,"wb");

182 ià(
D
==
NULL
è
	`ÿÂÙ
("open");

183 
	`lua_lock
(
L
);

184 
	`luaU_dump
(
L
,
f
,
wr™”
,
D
,
¡rpšg
);

185 
	`lua_uÆock
(
L
);

186 ià(
	`ã¼Ü
(
D
)è
	`ÿÂÙ
("write");

187 ià(
	`fşo£
(
D
)è
	`ÿÂÙ
("close");

190 
	}
}

192 
	$maš
(
¬gc
, * 
¬gv
[])

194 
lua_S‹
* 
L
;

195 
i
=
	`dßrgs
(
¬gc
,
¬gv
);

196 
¬gc
-=
i
; 
¬gv
+=i;

197 ià(
¬gc
<=0è
	`u§ge
("no input files given");

198 
L
=
	`luaL_Ãw¡©e
();

199 ià(
L
==
NULL
è
	`çl
("cannot create state:‚otƒnough memory");

200 
	`lua_pushcfunùiÚ
(
L
,&
pmaš
);

201 
	`lua_pushš‹g”
(
L
,
¬gc
);

202 
	`lua_pushlightu£rd©a
(
L
,
¬gv
);

203 ià(
	`lua_pÿÎ
(
L
,2,0,0)!=
LUA_OK
è
	`çl
(
	`lua_to¡ršg
(L,-1));

204 
	`lua_şo£
(
L
);

205  
EXIT_SUCCESS
;

206 
	}
}

214 
	~<ùy³.h
>

215 
	~<¡dio.h
>

217 
	#luac_c


	)

218 
	#LUA_CORE


	)

220 
	~"ldebug.h
"

221 
	~"lobjeù.h
"

222 
	~"lİcodes.h
"

224 
	#VOID
(
p
è((cÚ¡ *)Õ))

	)

226 
	$PrštSŒšg
(cÚ¡ 
TSŒšg
* 
ts
)

228 cÚ¡ * 
s
=
	`g‘¡r
(
ts
);

229 
size_t
 
i
,
n
=
	`ts¦’
(
ts
);

230 
	`´štf
("%c",'"');

231 
i
=0; i<
n
; i++)

233 
c
=()()
s
[
i
];

234 
c
)

236 '"': 
	`´štf
("\\\""); ;

237 '\\': 
	`´štf
("\\\\"); ;

238 '\a': 
	`´štf
("\\a"); ;

239 '\b': 
	`´štf
("\\b"); ;

240 '\f': 
	`´štf
("\\f"); ;

241 '\n': 
	`´štf
("\\n"); ;

242 '\r': 
	`´štf
("\\r"); ;

243 '\t': 
	`´štf
("\\t"); ;

244 '\v': 
	`´štf
("\\v"); ;

245 : ià(
	`i¥ršt
(
c
))

246 
	`´štf
("%c",
c
);

248 
	`´štf
("\\%03d",
c
);

251 
	`´štf
("%c",'"');

252 
	}
}

254 
	$PrštCÚ¡ªt
(cÚ¡ 
PrÙo
* 
f
, 
i
)

256 cÚ¡ 
TV®ue
* 
o
=&
f
->
k
[
i
];

257 
	`‰y³
(
o
))

259 
LUA_TNIL
:

260 
	`´štf
("nil");

262 
LUA_TBOOLEAN
:

263 
	`´štf
(
	`bv®ue
(
o
) ? "true" : "false");

265 
LUA_TNUMFLT
:

267 
buff
[100];

268 
	`¥rštf
(
buff
,
LUA_NUMBER_FMT
,
	`ætv®ue
(
o
));

269 
	`´štf
("%s",
buff
);

270 ià(
buff
[
	`¡r¥n
(buff,"-0123456789")]=='\0'è
	`´štf
(".0");

273 
LUA_TNUMINT
:

274 
	`´štf
(
LUA_INTEGER_FMT
,
	`iv®ue
(
o
));

276 
LUA_TSHRSTR
: 
LUA_TLNGSTR
:

277 
	`PrštSŒšg
(
	`tsv®ue
(
o
));

280 
	`´štf
("?y³=%d",
	`‰y³
(
o
));

283 
	}
}

285 
	#UPVALNAME
(
x
è((
f
->
upv®ues
[x].
Çme
è? 
	`g‘¡r
(f->upv®ues[x].Çmeè: "-")

	)

286 
	#MYK
(
x
è(-1-(x))

	)

288 
	$PrštCode
(cÚ¡ 
PrÙo
* 
f
)

290 cÚ¡ 
In¡ruùiÚ
* 
code
=
f
->code;

291 
pc
,
n
=
f
->
sizecode
;

292 
pc
=0;…c<
n
;…c++)

294 
In¡ruùiÚ
 
i
=
code
[
pc
];

295 
OpCode
 
o
=
	`GET_OPCODE
(
i
);

296 
a
=
	`GETARG_A
(
i
);

297 
b
=
	`GETARG_B
(
i
);

298 
c
=
	`GETARG_C
(
i
);

299 
ax
=
	`GETARG_Ax
(
i
);

300 
bx
=
	`GETARG_Bx
(
i
);

301 
sbx
=
	`GETARG_sBx
(
i
);

302 
lše
=
	`g‘funşše
(
f
,
pc
);

303 
	`´štf
("\t%d\t",
pc
+1);

304 ià(
lše
>0è
	`´štf
("[%d]\t",line); printf("[-]\t");

305 
	`´štf
("%-9s\t",
luaP_İÇmes
[
o
]);

306 
	`g‘OpMode
(
o
))

308 
iABC
:

309 
	`´štf
("%d",
a
);

310 ià(
	`g‘BMode
(
o
)!=
OpArgN
è
	`´štf
(" %d",
	`ISK
(
b
è? (
	`MYK
(
	`INDEXK
(b))) : b);

311 ià(
	`g‘CMode
(
o
)!=
OpArgN
è
	`´štf
(" %d",
	`ISK
(
c
è? (
	`MYK
(
	`INDEXK
(c))) : c);

313 
iABx
:

314 
	`´štf
("%d",
a
);

315 ià(
	`g‘BMode
(
o
)==
OpArgK
è
	`´štf
(" %d",
	`MYK
(
bx
));

316 ià(
	`g‘BMode
(
o
)==
OpArgU
è
	`´štf
(" %d",
bx
);

318 
iAsBx
:

319 
	`´štf
("%d %d",
a
,
sbx
);

321 
iAx
:

322 
	`´štf
("%d",
	`MYK
(
ax
));

325 
o
)

327 
OP_LOADK
:

328 
	`´štf
("\t; "); 
	`PrštCÚ¡ªt
(
f
,
bx
);

330 
OP_GETUPVAL
:

331 
OP_SETUPVAL
:

332 
	`´štf
("\t; %s",
	`UPVALNAME
(
b
));

334 
OP_GETTABUP
:

335 
	`´štf
("\t; %s",
	`UPVALNAME
(
b
));

336 ià(
	`ISK
(
c
)è{ 
	`´štf
(" "); 
	`PrštCÚ¡ªt
(
f
,
	`INDEXK
(c)); }

338 
OP_SETTABUP
:

339 
	`´štf
("\t; %s",
	`UPVALNAME
(
a
));

340 ià(
	`ISK
(
b
)è{ 
	`´štf
(" "); 
	`PrštCÚ¡ªt
(
f
,
	`INDEXK
(b)); }

341 ià(
	`ISK
(
c
)è{ 
	`´štf
(" "); 
	`PrštCÚ¡ªt
(
f
,
	`INDEXK
(c)); }

343 
OP_GETTABLE
:

344 
OP_SELF
:

345 ià(
	`ISK
(
c
)è{ 
	`´štf
("\t; "); 
	`PrštCÚ¡ªt
(
f
,
	`INDEXK
(c)); }

347 
OP_SETTABLE
:

348 
OP_ADD
:

349 
OP_SUB
:

350 
OP_MUL
:

351 
OP_POW
:

352 
OP_DIV
:

353 
OP_IDIV
:

354 
OP_BAND
:

355 
OP_BOR
:

356 
OP_BXOR
:

357 
OP_SHL
:

358 
OP_SHR
:

359 
OP_EQ
:

360 
OP_LT
:

361 
OP_LE
:

362 ià(
	`ISK
(
b
è|| ISK(
c
))

364 
	`´štf
("\t; ");

365 ià(
	`ISK
(
b
)è
	`PrštCÚ¡ªt
(
f
,
	`INDEXK
(b)); 
	`´štf
("-");

366 
	`´štf
(" ");

367 ià(
	`ISK
(
c
)è
	`PrštCÚ¡ªt
(
f
,
	`INDEXK
(c)); 
	`´štf
("-");

370 
OP_JMP
:

371 
OP_FORLOOP
:

372 
OP_FORPREP
:

373 
OP_TFORLOOP
:

374 
	`´štf
("\t;Ø%d",
sbx
+
pc
+2);

376 
OP_CLOSURE
:

377 
	`´štf
("\t; %p",
	`VOID
(
f
->
p
[
bx
]));

379 
OP_SETLIST
:

380 ià(
c
==0è
	`´štf
("\t; %d",()
code
[++
pc
]); printf("\t; %d",c);

382 
OP_EXTRAARG
:

383 
	`´štf
("\t; "); 
	`PrštCÚ¡ªt
(
f
,
ax
);

388 
	`´štf
("\n");

390 
	}
}

392 
	#SS
(
x
è((x==1)?"":"s")

	)

393 
	#S
(
x
è()(x),
	`SS
(x)

	)

395 
	$PrštH—d”
(cÚ¡ 
PrÙo
* 
f
)

397 cÚ¡ * 
s
=
f
->
sourû
 ? 
	`g‘¡r
(f->source) : "=?";

398 ià(*
s
=='@' || *s=='=')

399 
s
++;

400 ià(*
s
==
LUA_SIGNATURE
[0])

401 
s
="(bstring)";

403 
s
="(string)";

404 
	`´štf
("\n%s <%s:%d,%d> (%d instruction%s‡t %p)\n",

405 (
f
->
lšedefšed
==0)?"maš":"funùiÚ",
s
,

406 
f
->
lšedefšed
,f->
Ï¡lšedefšed
,

407 
	`S
(
f
->
sizecode
),
	`VOID
(f));

408 
	`´štf
("%d%s…aram%s, %d slot%s, %d upvalue%s, ",

409 ()(
f
->
num·¿ms
),f->
is_v¬¬g
?"+":"",
	`SS
(f->numparams),

410 
	`S
(
f
->
max¡acksize
),S(f->
sizeupv®ues
));

411 
	`´štf
("%d†ocal%s, %d constant%s, %d function%s\n",

412 
	`S
(
f
->
siz–ocv¬s
),S(f->
sizek
),S(f->
siz•
));

413 
	}
}

415 
	$PrštDebug
(cÚ¡ 
PrÙo
* 
f
)

417 
i
,
n
;

418 
n
=
f
->
sizek
;

419 
	`´štf
("cÚ¡ªt (%dèfÜ %p:\n",
n
,
	`VOID
(
f
));

420 
i
=0; i<
n
; i++)

422 
	`´štf
("\t%d\t",
i
+1);

423 
	`PrštCÚ¡ªt
(
f
,
i
);

424 
	`´štf
("\n");

426 
n
=
f
->
siz–ocv¬s
;

427 
	`´štf
("loÿl (%dèfÜ %p:\n",
n
,
	`VOID
(
f
));

428 
i
=0; i<
n
; i++)

430 
	`´štf
("\t%d\t%s\t%d\t%d\n",

431 
i
,
	`g‘¡r
(
f
->
locv¬s
[i].
v¬Çme
),f->locv¬s[i].
¡¬c
+1,f->locv¬s[i].
’dpc
+1);

433 
n
=
f
->
sizeupv®ues
;

434 
	`´štf
("upv®ue (%dèfÜ %p:\n",
n
,
	`VOID
(
f
));

435 
i
=0; i<
n
; i++)

437 
	`´štf
("\t%d\t%s\t%d\t%d\n",

438 
i
,
	`UPVALNAME
(i),
f
->
upv®ues
[i].
š¡ack
,f->upv®ues[i].
idx
);

440 
	}
}

442 
	$PrštFunùiÚ
(cÚ¡ 
PrÙo
* 
f
, 
fuÎ
)

444 
i
,
n
=
f
->
siz•
;

445 
	`PrštH—d”
(
f
);

446 
	`PrštCode
(
f
);

447 ià(
fuÎ
è
	`PrštDebug
(
f
);

448 
i
=0; i<
n
; i++è
	`PrštFunùiÚ
(
f
->
p
[i],
fuÎ
);

449 
	}
}

	@script/lua/lua-5.3.4/src/luaconf.h

8 #iâdeà
luacÚf_h


9 
	#luacÚf_h


	)

11 
	~<lim™s.h
>

12 
	~<¡ddef.h
>

50 #ià!
defšed
(
LUA_USE_C89
è&& defšed(
_WIN32
è&& !defšed(
_WIN32_WCE
)

51 
	#LUA_USE_WINDOWS


	)

55 #ià
defšed
(
LUA_USE_WINDOWS
)

56 
	#LUA_DL_DLL


	)

57 
	#LUA_USE_C89


	)

61 #ià
defšed
(
LUA_USE_LINUX
)

62 
	#LUA_USE_POSIX


	)

63 
	#LUA_USE_DLOPEN


	)

64 
	#LUA_USE_READLINE


	)

68 #ià
defšed
(
LUA_USE_MACOSX
)

69 
	#LUA_USE_POSIX


	)

70 
	#LUA_USE_DLOPEN


	)

71 
	#LUA_USE_READLINE


	)

80 #ià
defšed
(
LUA_USE_C89
è&& !defšed(
LUA_USE_WINDOWS
)

81 
	#LUA_C89_NUMBERS


	)

90 #ià((
INT_MAX
 >> 15) >> 15) >= 1

91 
	#LUAI_BITSINT
 32

	)

94 
	#LUAI_BITSINT
 16

	)

109 
	#LUA_INT_INT
 1

	)

110 
	#LUA_INT_LONG
 2

	)

111 
	#LUA_INT_LONGLONG
 3

	)

114 
	#LUA_FLOAT_FLOAT
 1

	)

115 
	#LUA_FLOAT_DOUBLE
 2

	)

116 
	#LUA_FLOAT_LONGDOUBLE
 3

	)

118 #ià
defšed
(
LUA_32BITS
)

122 #ià
LUAI_BITSINT
 >= 32

123 
	#LUA_INT_TYPE
 
LUA_INT_INT


	)

125 
	#LUA_INT_TYPE
 
LUA_INT_LONG


	)

127 
	#LUA_FLOAT_TYPE
 
LUA_FLOAT_FLOAT


	)

129 #–ià
defšed
(
LUA_C89_NUMBERS
)

133 
	#LUA_INT_TYPE
 
LUA_INT_LONG


	)

134 
	#LUA_FLOAT_TYPE
 
LUA_FLOAT_DOUBLE


	)

142 #ià!
defšed
(
LUA_INT_TYPE
)

143 
	#LUA_INT_TYPE
 
LUA_INT_LONGLONG


	)

146 #ià!
defšed
(
LUA_FLOAT_TYPE
)

147 
	#LUA_FLOAT_TYPE
 
LUA_FLOAT_DOUBLE


	)

168 
	#LUA_PATH_SEP
 ";"

	)

169 
	#LUA_PATH_MARK
 "?"

	)

170 
	#LUA_EXEC_DIR
 "!"

	)

182 
	#LUA_VDIR
 
LUA_VERSION_MAJOR
 "." 
LUA_VERSION_MINOR


	)

183 #ià
defšed
(
_WIN32
)

188 
	#LUA_LDIR
 "!\\lua\\"

	)

189 
	#LUA_CDIR
 "!\\"

	)

190 
	#LUA_SHRDIR
 "!\\..\\sh¬e\\lua\\" 
LUA_VDIR
 "\\"

	)

191 
	#LUA_PATH_DEFAULT
 \

192 
LUA_LDIR
"?.lua;" LUA_LDIR"?\\init.lua;" \

193 
LUA_CDIR
"?.lua;" LUA_CDIR"?\\init.lua;" \

194 
LUA_SHRDIR
"?.lua;" LUA_SHRDIR"?\\init.lua;" \

195 ".\\?.lua;" ".\\?\\š™.lua"

	)

196 
	#LUA_CPATH_DEFAULT
 \

197 
LUA_CDIR
"?.dll;" \

198 
LUA_CDIR
"..\\lib\\lua\\" 
LUA_VDIR
 "\\?.dll;" \

199 
LUA_CDIR
"lßd®l.dÎ;" ".\\?.dÎ"

	)

203 
	#LUA_ROOT
 "/u¤/loÿl/"

	)

204 
	#LUA_LDIR
 
LUA_ROOT
 "sh¬e/lua/" 
LUA_VDIR
 "/"

	)

205 
	#LUA_CDIR
 
LUA_ROOT
 "lib/lua/" 
LUA_VDIR
 "/"

	)

206 
	#LUA_PATH_DEFAULT
 \

207 
LUA_LDIR
"?.lua;" LUA_LDIR"?/init.lua;" \

208 
LUA_CDIR
"?.lua;" LUA_CDIR"?/init.lua;" \

209 "./?.lua;" "./?/š™.lua"

	)

210 
	#LUA_CPATH_DEFAULT
 \

211 
LUA_CDIR
"?.so;" LUA_CDIR"lßd®l.so;" "./?.so"

	)

220 #ià
defšed
(
_WIN32
)

221 
	#LUA_DIRSEP
 "\\"

	)

223 
	#LUA_DIRSEP
 "/"

	)

244 #ià
defšed
(
LUA_BUILD_AS_DLL
)

246 #ià
defšed
(
LUA_CORE
è|| defšed(
LUA_LIB
)

247 
	#LUA_API
 
	`__deş¥ec
(
dÎexpÜt
)

	)

249 
	#LUA_API
 
	`__deş¥ec
(
dÎimpÜt
)

	)

254 
	#LUA_API
 

	)

260 
	#LUALIB_API
 
LUA_API


	)

261 
	#LUAMOD_API
 
LUALIB_API


	)

278 #ià
defšed
(
__GNUC__
è&& ((__GNUC__*100 + 
__GNUC_MINOR__
) >= 302) && \

279 
	$defšed
(
__ELF__
)

280 
	#LUAI_FUNC
 
	`__©Œibu‹__
((
	`visib™y
("hidd’"))è

	)

282 
	#LUAI_FUNC
 

	)

285 
	#LUAI_DDEC
 
LUAI_FUNC


	)

286 
	#LUAI_DDEF


	)

303 #ià
	`defšed
(
LUA_COMPAT_5_2
)

309 
	#LUA_COMPAT_MATHLIB


	)

314 
	#LUA_COMPAT_BITLIB


	)

319 
	#LUA_COMPAT_IPAIRS


	)

326 
	#LUA_COMPAT_APIINTCASTS


	)

331 #ià
	`defšed
(
LUA_COMPAT_5_1
)

334 
	#LUA_COMPAT_MATHLIB


	)

335 
	#LUA_COMPAT_APIINTCASTS


	)

341 
	#LUA_COMPAT_UNPACK


	)

347 
	#LUA_COMPAT_LOADERS


	)

353 
	#lua_ıÿÎ
(
L
,
f
,
u
) \

354 (
	`lua_pushcfunùiÚ
(
L
, (
f
)), \

355 
	`lua_pushlightu£rd©a
(
L
,(
u
)), \

356 
	`lua_pÿÎ
(
L
,1,0,0))

	)

363 
	#LUA_COMPAT_LOG10


	)

369 
	#LUA_COMPAT_LOADSTRING


	)

374 
	#LUA_COMPAT_MAXN


	)

381 
	#lua_¡¾’
(
L
,
i
è
	`lua_¿wËn
(L, (i))

	)

383 
	#lua_objËn
(
L
,
i
è
	`lua_¿wËn
(L, (i))

	)

385 
	#lua_equ®
(
L
,
idx1
,
idx2
è
	`lua_com·»
(L,(idx1),(idx2),
LUA_OPEQ
)

	)

386 
	#lua_Ës¡hª
(
L
,
idx1
,
idx2
è
	`lua_com·»
(L,(idx1),(idx2),
LUA_OPLT
)

	)

392 
	#LUA_COMPAT_MODULE


	)

434 
	#l_æoÜ
(
x
è(
	`l_m©hİ
(
æoÜ
)(x))

	)

436 
	#lua_numb”2¡r
(
s
,
sz
,
n
) \

437 
	`l_¥rštf
((
s
), 
sz
, 
LUA_NUMBER_FMT
, (
LUAI_UACNUMBER
)(
n
))

	)

447 
	#lua_numb”toš‹g”
(
n
,
p
) \

448 ((
n
è>ğ(
LUA_NUMBER
)(
LUA_MININTEGER
) && \

449 (
n
è< -(
LUA_NUMBER
)(
LUA_MININTEGER
) && \

450 (*(
p
èğ(
LUA_INTEGER
)(
n
), 1))

	)

455 #ià
LUA_FLOAT_TYPE
 =ğ
LUA_FLOAT_FLOAT


457 
	#LUA_NUMBER
 

	)

459 
	#l_m©hlim
(
n
è(
FLT_
##n)

	)

461 
	#LUAI_UACNUMBER
 

	)

463 
	#LUA_NUMBER_FRMLEN
 ""

	)

464 
	#LUA_NUMBER_FMT
 "%.7g"

	)

466 
	#l_m©hİ
(
İ
èİ##
f


	)

468 
	#lua_¡r2numb”
(
s
,
p
è
	`¡¹of
((s), (p))

	)

471 #–ià
LUA_FLOAT_TYPE
 =ğ
LUA_FLOAT_LONGDOUBLE


473 
	#LUA_NUMBER
 

	)

475 
	#l_m©hlim
(
n
è(
LDBL_
##n)

	)

477 
	#LUAI_UACNUMBER
 

	)

479 
	#LUA_NUMBER_FRMLEN
 "L"

	)

480 
	#LUA_NUMBER_FMT
 "%.19Lg"

	)

482 
	#l_m©hİ
(
İ
èİ##
l


	)

484 
	#lua_¡r2numb”
(
s
,
p
è
	`¡¹Şd
((s), (p))

	)

486 #–ià
LUA_FLOAT_TYPE
 =ğ
LUA_FLOAT_DOUBLE


488 
	#LUA_NUMBER
 

	)

490 
	#l_m©hlim
(
n
è(
DBL_
##n)

	)

492 
	#LUAI_UACNUMBER
 

	)

494 
	#LUA_NUMBER_FRMLEN
 ""

	)

495 
	#LUA_NUMBER_FMT
 "%.14g"

	)

497 
	#l_m©hİ
(
İ
è
	)
op

499 
	#lua_¡r2numb”
(
s
,
p
è
	`¡¹od
((s), (p))

	)

526 
	#LUA_INTEGER_FMT
 "%" 
LUA_INTEGER_FRMLEN
 "d"

	)

528 
	#LUAI_UACINT
 
LUA_INTEGER


	)

530 
	#lua_š‹g”2¡r
(
s
,
sz
,
n
) \

531 
	`l_¥rštf
((
s
), 
sz
, 
LUA_INTEGER_FMT
, (
LUAI_UACINT
)(
n
))

	)

537 
	#LUA_UNSIGNED
 
LUAI_UACINT


	)

542 #ià
LUA_INT_TYPE
 =ğ
LUA_INT_INT


544 
	#LUA_INTEGER
 

	)

545 
	#LUA_INTEGER_FRMLEN
 ""

	)

547 
	#LUA_MAXINTEGER
 
INT_MAX


	)

548 
	#LUA_MININTEGER
 
INT_MIN


	)

550 #–ià
LUA_INT_TYPE
 =ğ
LUA_INT_LONG


552 
	#LUA_INTEGER
 

	)

553 
	#LUA_INTEGER_FRMLEN
 "l"

	)

555 
	#LUA_MAXINTEGER
 
LONG_MAX


	)

556 
	#LUA_MININTEGER
 
LONG_MIN


	)

558 #–ià
LUA_INT_TYPE
 =ğ
LUA_INT_LONGLONG


561 #ià
	`defšed
(
LLONG_MAX
)

564 
	#LUA_INTEGER
 

	)

565 
	#LUA_INTEGER_FRMLEN
 "Î"

	)

567 
	#LUA_MAXINTEGER
 
LLONG_MAX


	)

568 
	#LUA_MININTEGER
 
LLONG_MIN


	)

570 #–ià
	`defšed
(
LUA_USE_WINDOWS
)

573 
	#LUA_INTEGER
 
__št64


	)

574 
	#LUA_INTEGER_FRMLEN
 "I64"

	)

576 
	#LUA_MAXINTEGER
 
_I64_MAX


	)

577 
	#LUA_MININTEGER
 
_I64_MIN


	)

605 #ià!
	`defšed
(
LUA_USE_C89
)

606 
	#l_¥rštf
(
s
,
sz
,
f
,
i
è
	`¢´štf
(s,sz,f,i)

	)

608 
	#l_¥rštf
(
s
,
sz
,
f
,
i
è(()(sz), 
	`¥rštf
(s,f,i))

	)

618 #ià!
	`defšed
(
LUA_USE_C89
)

619 
	#lua_¡rx2numb”
(
s
,
p
è
	`lua_¡r2numb”
(s,p)

	)

629 #ià!
	`defšed
(
LUA_USE_C89
)

630 
	#lua_numb”2¡rx
(
L
,
b
,
sz
,
f
,
n
) \

631 (()
L
, 
	`l_¥rštf
(
b
,
sz
,
f
,(
LUAI_UACNUMBER
)(
n
)))

	)

641 #ià
	`defšed
(
LUA_USE_C89
è|| (defšed(
HUGE_VAL
è&& !defšed(
HUGE_VALF
))

642 #undeà
l_m©hİ


643 #undeà
lua_¡r2numb”


644 
	#l_m©hİ
(
İ
è(
lua_Numb”
)İ

	)

645 
	#lua_¡r2numb”
(
s
,
p
è((
lua_Numb”
)
	`¡¹od
((s), (p)))

	)

655 
	#LUA_KCONTEXT
 
±rdiff_t


	)

657 #ià!
	`defšed
(
LUA_USE_C89
è&& defšed(
__STDC_VERSION__
) && \

658 
__STDC_VERSION__
 >= 199901L

659 
	~<¡dšt.h
>

660 #ià
	`defšed
(
INTPTR_MAX
)

661 #undeà
LUA_KCONTEXT


662 
	#LUA_KCONTEXT
 
šŒ_t


	)

672 #ià!
	`defšed
(
lua_g‘loÿËdeıošt
)

673 
	#lua_g‘loÿËdeıošt
(è(
	`loÿËcÚv
()->
decim®_pošt
[0])

	)

699 #ià
	`defšed
(
LUA_USE_APICHECK
)

700 
	~<as£¹.h
>

701 
	#luai_­icheck
(
l
,
e
è
	`as£¹
Ó)

	)

721 #ià
LUAI_BITSINT
 >= 32

722 
	#LUAI_MAXSTACK
 1000000

	)

724 
	#LUAI_MAXSTACK
 15000

	)

733 
	#LUA_EXTRASPACE
 ((*))

	)

741 
	#LUA_IDSIZE
 60

	)

751 #ià
LUA_FLOAT_TYPE
 =ğ
LUA_FLOAT_LONGDOUBLE


752 
	#LUAL_BUFFERSIZE
 8192

	)

754 
	#LUAL_BUFFERSIZE
 (()(0x80 * (*è* (
lua_IÁeg”
)))

	)

765 
	#LUA_QL
(
x
è"'" x "'"

	)

766 
	#LUA_QS
 
	`LUA_QL
("%s")

	)

	@script/lua/lua-5.3.4/src/lualib.h

8 #iâdeà
lu®ib_h


9 
	#lu®ib_h


	)

11 
	~"lua.h
"

15 
	#LUA_VERSUFFIX
 "_" 
LUA_VERSION_MAJOR
 "_" 
LUA_VERSION_MINOR


	)

18 
LUAMOD_API
 (
luaİ’_ba£
è(
lua_S‹
 *
L
);

20 
	#LUA_COLIBNAME
 "cÜoutše"

	)

21 
LUAMOD_API
 (
luaİ’_cÜoutše
è(
lua_S‹
 *
L
);

23 
	#LUA_TABLIBNAME
 "bË"

	)

24 
LUAMOD_API
 (
luaİ’_bË
è(
lua_S‹
 *
L
);

26 
	#LUA_IOLIBNAME
 "io"

	)

27 
LUAMOD_API
 (
luaİ’_io
è(
lua_S‹
 *
L
);

29 
	#LUA_OSLIBNAME
 "os"

	)

30 
LUAMOD_API
 (
luaİ’_os
è(
lua_S‹
 *
L
);

32 
	#LUA_STRLIBNAME
 "¡ršg"

	)

33 
LUAMOD_API
 (
luaİ’_¡ršg
è(
lua_S‹
 *
L
);

35 
	#LUA_UTF8LIBNAME
 "utf8"

	)

36 
LUAMOD_API
 (
luaİ’_utf8
è(
lua_S‹
 *
L
);

38 
	#LUA_BITLIBNAME
 "b™32"

	)

39 
LUAMOD_API
 (
luaİ’_b™32
è(
lua_S‹
 *
L
);

41 
	#LUA_MATHLIBNAME
 "m©h"

	)

42 
LUAMOD_API
 (
luaİ’_m©h
è(
lua_S‹
 *
L
);

44 
	#LUA_DBLIBNAME
 "debug"

	)

45 
LUAMOD_API
 (
luaİ’_debug
è(
lua_S‹
 *
L
);

47 
	#LUA_LOADLIBNAME
 "·ckage"

	)

48 
LUAMOD_API
 (
luaİ’_·ckage
è(
lua_S‹
 *
L
);

52 
LUALIB_API
 (
luaL_İ’libs
è(
lua_S‹
 *
L
);

56 #ià!
	`defšed
(
lua_as£¹
)

57 
	#lua_as£¹
(
x
è(()0)

	)

	@script/lua/lua-5.3.4/src/lundump.c

7 
	#lundump_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ršg.h
>

15 
	~"lua.h
"

17 
	~"ldebug.h
"

18 
	~"ldo.h
"

19 
	~"lfunc.h
"

20 
	~"lmem.h
"

21 
	~"lobjeù.h
"

22 
	~"l¡ršg.h
"

23 
	~"lundump.h
"

24 
	~"lzio.h
"

27 #ià!
defšed
(
luai_v”ifycode
)

28 
	#luai_v”ifycode
(
L
,
b
,
f
è

	)

33 
lua_S‹
 *
	mL
;

34 
ZIO
 *
	mZ
;

35 cÚ¡ *
	mÇme
;

36 } 
	tLßdS‹
;

39 
l_nÜ‘
 
	$”rÜ
(
LßdS‹
 *
S
, cÚ¡ *
why
) {

40 
	`luaO_pushf¡ršg
(
S
->
L
, "%s: % ´ecomped chunk", S->
Çme
, 
why
);

41 
	`luaD_throw
(
S
->
L
, 
LUA_ERRSYNTAX
);

42 
	}
}

49 
	#LßdVeùÜ
(
S
,
b
,
n
è
	`LßdBlock
(S,b,Ò)*((b)[0]))

	)

51 
	$LßdBlock
 (
LßdS‹
 *
S
, *
b
, 
size_t
 
size
) {

52 ià(
	`luaZ_»ad
(
S
->
Z
, 
b
, 
size
) != 0)

53 
	`”rÜ
(
S
, "truncated");

54 
	}
}

57 
	#LßdV¬
(
S
,
x
è
	`LßdVeùÜ
(S,&x,1)

	)

60 
lu_by‹
 
	$LßdBy‹
 (
LßdS‹
 *
S
) {

61 
lu_by‹
 
x
;

62 
	`LßdV¬
(
S
, 
x
);

63  
x
;

64 
	}
}

67 
	$LßdIÁ
 (
LßdS‹
 *
S
) {

68 
x
;

69 
	`LßdV¬
(
S
, 
x
);

70  
x
;

71 
	}
}

74 
lua_Numb”
 
	$LßdNumb”
 (
LßdS‹
 *
S
) {

75 
lua_Numb”
 
x
;

76 
	`LßdV¬
(
S
, 
x
);

77  
x
;

78 
	}
}

81 
lua_IÁeg”
 
	$LßdIÁeg”
 (
LßdS‹
 *
S
) {

82 
lua_IÁeg”
 
x
;

83 
	`LßdV¬
(
S
, 
x
);

84  
x
;

85 
	}
}

88 
TSŒšg
 *
	$LßdSŒšg
 (
LßdS‹
 *
S
) {

89 
size_t
 
size
 = 
	`LßdBy‹
(
S
);

90 ià(
size
 == 0xFF)

91 
	`LßdV¬
(
S
, 
size
);

92 ià(
size
 == 0)

93  
NULL
;

94 ià(--
size
 <ğ
LUAI_MAXSHORTLEN
) {

95 
buff
[
LUAI_MAXSHORTLEN
];

96 
	`LßdVeùÜ
(
S
, 
buff
, 
size
);

97  
	`luaS_Ãwl¡r
(
S
->
L
, 
buff
, 
size
);

100 
TSŒšg
 *
ts
 = 
	`luaS_ü—‹Êg¡robj
(
S
->
L
, 
size
);

101 
	`LßdVeùÜ
(
S
, 
	`g‘¡r
(
ts
), 
size
);

102  
ts
;

104 
	}
}

107 
	$LßdCode
 (
LßdS‹
 *
S
, 
PrÙo
 *
f
) {

108 
n
 = 
	`LßdIÁ
(
S
);

109 
f
->
code
 = 
	`luaM_ÃwveùÜ
(
S
->
L
, 
n
, 
In¡ruùiÚ
);

110 
f
->
sizecode
 = 
n
;

111 
	`LßdVeùÜ
(
S
, 
f
->
code
, 
n
);

112 
	}
}

115 
LßdFunùiÚ
(
LßdS‹
 *
S
, 
PrÙo
 *
f
, 
TSŒšg
 *
psourû
);

118 
	$LßdCÚ¡ªts
 (
LßdS‹
 *
S
, 
PrÙo
 *
f
) {

119 
i
;

120 
n
 = 
	`LßdIÁ
(
S
);

121 
f
->
k
 = 
	`luaM_ÃwveùÜ
(
S
->
L
, 
n
, 
TV®ue
);

122 
f
->
sizek
 = 
n
;

123 
i
 = 0; i < 
n
; i++)

124 
	`£Šv®ue
(&
f
->
k
[
i
]);

125 
i
 = 0; i < 
n
; i++) {

126 
TV®ue
 *
o
 = &
f
->
k
[
i
];

127 
t
 = 
	`LßdBy‹
(
S
);

128 
t
) {

129 
LUA_TNIL
:

130 
	`£Šv®ue
(
o
);

132 
LUA_TBOOLEAN
:

133 
	`£tbv®ue
(
o
, 
	`LßdBy‹
(
S
));

135 
LUA_TNUMFLT
:

136 
	`£tætv®ue
(
o
, 
	`LßdNumb”
(
S
));

138 
LUA_TNUMINT
:

139 
	`£tiv®ue
(
o
, 
	`LßdIÁeg”
(
S
));

141 
LUA_TSHRSTR
:

142 
LUA_TLNGSTR
:

143 
	`£tsv®ue2n
(
S
->
L
, 
o
, 
	`LßdSŒšg
(S));

146 
	`lua_as£¹
(0);

149 
	}
}

152 
	$LßdPrÙos
 (
LßdS‹
 *
S
, 
PrÙo
 *
f
) {

153 
i
;

154 
n
 = 
	`LßdIÁ
(
S
);

155 
f
->
p
 = 
	`luaM_ÃwveùÜ
(
S
->
L
, 
n
, 
PrÙo
 *);

156 
f
->
siz•
 = 
n
;

157 
i
 = 0; i < 
n
; i++)

158 
f
->
p
[
i
] = 
NULL
;

159 
i
 = 0; i < 
n
; i++) {

160 
f
->
p
[
i
] = 
	`luaF_Ãw´Ùo
(
S
->
L
);

161 
	`LßdFunùiÚ
(
S
, 
f
->
p
[
i
], f->
sourû
);

163 
	}
}

166 
	$LßdUpv®ues
 (
LßdS‹
 *
S
, 
PrÙo
 *
f
) {

167 
i
, 
n
;

168 
n
 = 
	`LßdIÁ
(
S
);

169 
f
->
upv®ues
 = 
	`luaM_ÃwveùÜ
(
S
->
L
, 
n
, 
Upv®desc
);

170 
f
->
sizeupv®ues
 = 
n
;

171 
i
 = 0; i < 
n
; i++)

172 
f
->
upv®ues
[
i
].
Çme
 = 
NULL
;

173 
i
 = 0; i < 
n
; i++) {

174 
f
->
upv®ues
[
i
].
š¡ack
 = 
	`LßdBy‹
(
S
);

175 
f
->
upv®ues
[
i
].
idx
 = 
	`LßdBy‹
(
S
);

177 
	}
}

180 
	$LßdDebug
 (
LßdS‹
 *
S
, 
PrÙo
 *
f
) {

181 
i
, 
n
;

182 
n
 = 
	`LßdIÁ
(
S
);

183 
f
->
lšešfo
 = 
	`luaM_ÃwveùÜ
(
S
->
L
, 
n
, );

184 
f
->
siz–šešfo
 = 
n
;

185 
	`LßdVeùÜ
(
S
, 
f
->
lšešfo
, 
n
);

186 
n
 = 
	`LßdIÁ
(
S
);

187 
f
->
locv¬s
 = 
	`luaM_ÃwveùÜ
(
S
->
L
, 
n
, 
LocV¬
);

188 
f
->
siz–ocv¬s
 = 
n
;

189 
i
 = 0; i < 
n
; i++)

190 
f
->
locv¬s
[
i
].
v¬Çme
 = 
NULL
;

191 
i
 = 0; i < 
n
; i++) {

192 
f
->
locv¬s
[
i
].
v¬Çme
 = 
	`LßdSŒšg
(
S
);

193 
f
->
locv¬s
[
i
].
¡¬c
 = 
	`LßdIÁ
(
S
);

194 
f
->
locv¬s
[
i
].
’dpc
 = 
	`LßdIÁ
(
S
);

196 
n
 = 
	`LßdIÁ
(
S
);

197 
i
 = 0; i < 
n
; i++)

198 
f
->
upv®ues
[
i
].
Çme
 = 
	`LßdSŒšg
(
S
);

199 
	}
}

202 
	$LßdFunùiÚ
 (
LßdS‹
 *
S
, 
PrÙo
 *
f
, 
TSŒšg
 *
psourû
) {

203 
f
->
sourû
 = 
	`LßdSŒšg
(
S
);

204 ià(
f
->
sourû
 =ğ
NULL
)

205 
f
->
sourû
 = 
psourû
;

206 
f
->
lšedefšed
 = 
	`LßdIÁ
(
S
);

207 
f
->
Ï¡lšedefšed
 = 
	`LßdIÁ
(
S
);

208 
f
->
num·¿ms
 = 
	`LßdBy‹
(
S
);

209 
f
->
is_v¬¬g
 = 
	`LßdBy‹
(
S
);

210 
f
->
max¡acksize
 = 
	`LßdBy‹
(
S
);

211 
	`LßdCode
(
S
, 
f
);

212 
	`LßdCÚ¡ªts
(
S
, 
f
);

213 
	`LßdUpv®ues
(
S
, 
f
);

214 
	`LßdPrÙos
(
S
, 
f
);

215 
	`LßdDebug
(
S
, 
f
);

216 
	}
}

219 
	$checkl™”®
 (
LßdS‹
 *
S
, cÚ¡ *
s
, cÚ¡ *
msg
) {

220 
buff
[(
LUA_SIGNATURE
è+ (
LUAC_DATA
)];

221 
size_t
 
Ën
 = 
	`¡¾’
(
s
);

222 
	`LßdVeùÜ
(
S
, 
buff
, 
Ën
);

223 ià(
	`memcmp
(
s
, 
buff
, 
Ën
) != 0)

224 
	`”rÜ
(
S
, 
msg
);

225 
	}
}

228 
	$fchecksize
 (
LßdS‹
 *
S
, 
size_t
 
size
, cÚ¡ *
Šame
) {

229 ià(
	`LßdBy‹
(
S
è!ğ
size
)

230 
	`”rÜ
(
S
, 
	`luaO_pushf¡ršg
(S->
L
, "% sizmism©ch in", 
Šame
));

231 
	}
}

234 
	#checksize
(
S
,
t
è
	`fchecksize
(S,Ñ),#t)

	)

236 
	$checkH—d”
 (
LßdS‹
 *
S
) {

237 
	`checkl™”®
(
S
, 
LUA_SIGNATURE
 + 1, "not‡");

238 ià(
	`LßdBy‹
(
S
è!ğ
LUAC_VERSION
)

239 
	`”rÜ
(
S
, "version mismatch in");

240 ià(
	`LßdBy‹
(
S
è!ğ
LUAC_FORMAT
)

241 
	`”rÜ
(
S
, "format mismatch in");

242 
	`checkl™”®
(
S
, 
LUAC_DATA
, "corrupted");

243 
	`checksize
(
S
, );

244 
	`checksize
(
S
, 
size_t
);

245 
	`checksize
(
S
, 
In¡ruùiÚ
);

246 
	`checksize
(
S
, 
lua_IÁeg”
);

247 
	`checksize
(
S
, 
lua_Numb”
);

248 ià(
	`LßdIÁeg”
(
S
è!ğ
LUAC_INT
)

249 
	`”rÜ
(
S
, "endianness mismatch in");

250 ià(
	`LßdNumb”
(
S
è!ğ
LUAC_NUM
)

251 
	`”rÜ
(
S
, "float format mismatch in");

252 
	}
}

258 
LClosu»
 *
	$luaU_undump
(
lua_S‹
 *
L
, 
ZIO
 *
Z
, cÚ¡ *
Çme
) {

259 
LßdS‹
 
S
;

260 
LClosu»
 *
ş
;

261 ià(*
Çme
 == '@' || *name == '=')

262 
S
.
Çme
 =‚ame + 1;

263 ià(*
Çme
 =ğ
LUA_SIGNATURE
[0])

264 
S
.
Çme
 = "binary string";

266 
S
.
Çme
 =‚ame;

267 
S
.
L
 = L;

268 
S
.
Z
 = Z;

269 
	`checkH—d”
(&
S
);

270 
ş
 = 
	`luaF_ÃwLşosu»
(
L
, 
	`LßdBy‹
(&
S
));

271 
	`£tşLv®ue
(
L
, L->
tİ
, 
ş
);

272 
	`luaD_šùİ
(
L
);

273 
ş
->
p
 = 
	`luaF_Ãw´Ùo
(
L
);

274 
	`LßdFunùiÚ
(&
S
, 
ş
->
p
, 
NULL
);

275 
	`lua_as£¹
(
ş
->
nupv®ues
 =ğş->
p
->
sizeupv®ues
);

276 
	`luai_v”ifycode
(
L
, 
buff
, 
ş
->
p
);

277  
ş
;

278 
	}
}

	@script/lua/lua-5.3.4/src/lundump.h

7 #iâdeà
lundump_h


8 
	#lundump_h


	)

10 
	~"Îim™s.h
"

11 
	~"lobjeù.h
"

12 
	~"lzio.h
"

16 
	#LUAC_DATA
 "\x19\x93\r\n\x1a\n"

	)

18 
	#LUAC_INT
 0x5678

	)

19 
	#LUAC_NUM
 
	`ÿ¡_num
(370.5)

	)

21 
	#MYINT
(
s
è(s[0]-'0')

	)

22 
	#LUAC_VERSION
 (
	`MYINT
(
LUA_VERSION_MAJOR
)*16+MYINT(
LUA_VERSION_MINOR
))

	)

23 
	#LUAC_FORMAT
 0

	)

26 
LUAI_FUNC
 
LClosu»
* 
luaU_undump
 (
lua_S‹
* 
L
, 
ZIO
* 
Z
, cÚ¡ * 
Çme
);

29 
LUAI_FUNC
 
luaU_dump
 (
lua_S‹
* 
L
, cÚ¡ 
PrÙo
* 
f
, 
lua_Wr™”
 
w
,

30 * 
d©a
, 
¡r
);

	@script/lua/lua-5.3.4/src/lutf8lib.c

7 
	#lutf8lib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<as£¹.h
>

14 
	~<lim™s.h
>

15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

18 
	~"lua.h
"

20 
	~"Ïuxlib.h
"

21 
	~"lu®ib.h
"

23 
	#MAXUNICODE
 0x10FFFF

	)

25 
	#iscÚt
(
p
è((*Õè& 0xC0è=ğ0x80)

	)

30 
lua_IÁeg”
 
	$u_po¤–©
 (
lua_IÁeg”
 
pos
, 
size_t
 
Ën
) {

31 ià(
pos
 >= 0) …os;

32 ià(0u - (
size_t
)
pos
 > 
Ën
)  0;

33  (
lua_IÁeg”
)
Ën
 + 
pos
 + 1;

34 
	}
}

40 cÚ¡ *
	$utf8_decode
 (cÚ¡ *
o
, *
v®
) {

41 cÚ¡ 
lim™s
[] = {0xFF, 0x7F, 0x7FF, 0xFFFF};

42 cÚ¡ *
s
 = (cÚ¡ *)
o
;

43 
c
 = 
s
[0];

44 
»s
 = 0;

45 ià(
c
 < 0x80)

46 
»s
 = 
c
;

48 
couÁ
 = 0;

49 
c
 & 0x40) {

50 
cc
 = 
s
[++
couÁ
];

51 ià((
cc
 & 0xC0) != 0x80)

52  
NULL
;

53 
»s
 = (» << 6è| (
cc
 & 0x3F);

54 
c
 <<= 1;

56 
»s
 |ğ((
c
 & 0x7Fè<< (
couÁ
 * 5));

57 ià(
couÁ
 > 3 || 
»s
 > 
MAXUNICODE
 ||„e <ğ
lim™s
[count])

58  
NULL
;

59 
s
 +ğ
couÁ
;

61 ià(
v®
è*v® = 
»s
;

62  (cÚ¡ *)
s
 + 1;

63 
	}
}

71 
	$utæ’
 (
lua_S‹
 *
L
) {

72 
n
 = 0;

73 
size_t
 
Ën
;

74 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
Ën
);

75 
lua_IÁeg”
 
posi
 = 
	`u_po¤–©
(
	`luaL_İtš‹g”
(
L
, 2, 1), 
Ën
);

76 
lua_IÁeg”
 
posj
 = 
	`u_po¤–©
(
	`luaL_İtš‹g”
(
L
, 3, -1), 
Ën
);

77 
	`luaL_¬gcheck
(
L
, 1 <ğ
posi
 && --pos˜<ğ(
lua_IÁeg”
)
Ën
, 2,

79 
	`luaL_¬gcheck
(
L
, --
posj
 < (
lua_IÁeg”
)
Ën
, 3,

81 
posi
 <ğ
posj
) {

82 cÚ¡ *
s1
 = 
	`utf8_decode
(
s
 + 
posi
, 
NULL
);

83 ià(
s1
 =ğ
NULL
) {

84 
	`lua_pushn
(
L
);

85 
	`lua_pushš‹g”
(
L
, 
posi
 + 1);

88 
posi
 = 
s1
 - 
s
;

89 
n
++;

91 
	`lua_pushš‹g”
(
L
, 
n
);

93 
	}
}

100 
	$cod•ošt
 (
lua_S‹
 *
L
) {

101 
size_t
 
Ën
;

102 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
Ën
);

103 
lua_IÁeg”
 
posi
 = 
	`u_po¤–©
(
	`luaL_İtš‹g”
(
L
, 2, 1), 
Ën
);

104 
lua_IÁeg”
 
po£
 = 
	`u_po¤–©
(
	`luaL_İtš‹g”
(
L
, 3, 
posi
), 
Ën
);

105 
n
;

106 cÚ¡ *
£
;

107 
	`luaL_¬gcheck
(
L
, 
posi
 >= 1, 2, "out of„ange");

108 
	`luaL_¬gcheck
(
L
, 
po£
 <ğ(
lua_IÁeg”
)
Ën
, 3, "out of„ange");

109 ià(
posi
 > 
po£
)  0;

110 ià(
po£
 - 
posi
 >ğ
INT_MAX
)

111  
	`luaL_”rÜ
(
L
, "string sliceoo†ong");

112 
n
 = ()(
po£
 - 
posi
) + 1;

113 
	`luaL_check¡ack
(
L
, 
n
, "string sliceoo†ong");

114 
n
 = 0;

115 
£
 = 
s
 + 
po£
;

116 
s
 +ğ
posi
 - 1; s < 
£
;) {

117 
code
;

118 
s
 = 
	`utf8_decode
(s, &
code
);

119 ià(
s
 =ğ
NULL
)

120  
	`luaL_”rÜ
(
L
, "invalid UTF-8 code");

121 
	`lua_pushš‹g”
(
L
, 
code
);

122 
n
++;

124  
n
;

125 
	}
}

128 
	$pushutfch¬
 (
lua_S‹
 *
L
, 
¬g
) {

129 
lua_IÁeg”
 
code
 = 
	`luaL_checkš‹g”
(
L
, 
¬g
);

130 
	`luaL_¬gcheck
(
L
, 0 <ğ
code
 && cod<ğ
MAXUNICODE
, 
¬g
, "value out of„ange");

131 
	`lua_pushf¡ršg
(
L
, "%U", ()
code
);

132 
	}
}

138 
	$utfch¬
 (
lua_S‹
 *
L
) {

139 
n
 = 
	`lua_g‘tİ
(
L
);

140 ià(
n
 == 1)

141 
	`pushutfch¬
(
L
, 1);

143 
i
;

144 
luaL_Bufãr
 
b
;

145 
	`luaL_buffš™
(
L
, &
b
);

146 
i
 = 1; i <ğ
n
; i++) {

147 
	`pushutfch¬
(
L
, 
i
);

148 
	`luaL_addv®ue
(&
b
);

150 
	`luaL_push»suÉ
(&
b
);

153 
	}
}

160 
	$by‹off£t
 (
lua_S‹
 *
L
) {

161 
size_t
 
Ën
;

162 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
Ën
);

163 
lua_IÁeg”
 
n
 = 
	`luaL_checkš‹g”
(
L
, 2);

164 
lua_IÁeg”
 
posi
 = (
n
 >ğ0è? 1 : 
Ën
 + 1;

165 
posi
 = 
	`u_po¤–©
(
	`luaL_İtš‹g”
(
L
, 3,…osi), 
Ën
);

166 
	`luaL_¬gcheck
(
L
, 1 <ğ
posi
 && --pos˜<ğ(
lua_IÁeg”
)
Ën
, 3,

168 ià(
n
 == 0) {

170 
posi
 > 0 && 
	`iscÚt
(
s
 +…osi))…osi--;

173 ià(
	`iscÚt
(
s
 + 
posi
))

174 
	`luaL_”rÜ
(
L
, "initial…osition is‡ continuation byte");

175 ià(
n
 < 0) {

176 
n
 < 0 && 
posi
 > 0) {

178 
posi
--;

179 } 
posi
 > 0 && 
	`iscÚt
(
s
 +…osi));

180 
n
++;

184 
n
--;

185 
n
 > 0 && 
posi
 < (
lua_IÁeg”
)
Ën
) {

187 
posi
++;

188 } 
	`iscÚt
(
s
 + 
posi
));

189 
n
--;

193 ià(
n
 == 0)

194 
	`lua_pushš‹g”
(
L
, 
posi
 + 1);

196 
	`lua_pushn
(
L
);

198 
	}
}

201 
	$™”_aux
 (
lua_S‹
 *
L
) {

202 
size_t
 
Ën
;

203 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
Ën
);

204 
lua_IÁeg”
 
n
 = 
	`lua_toš‹g”
(
L
, 2) - 1;

205 ià(
n
 < 0)

206 
n
 = 0;

207 ià(
n
 < (
lua_IÁeg”
)
Ën
) {

208 
n
++;

209 
	`iscÚt
(
s
 + 
n
))‚++;

211 ià(
n
 >ğ(
lua_IÁeg”
)
Ën
)

214 
code
;

215 cÚ¡ *
Ãxt
 = 
	`utf8_decode
(
s
 + 
n
, &
code
);

216 ià(
Ãxt
 =ğ
NULL
 || 
	`iscÚt
(next))

217  
	`luaL_”rÜ
(
L
, "invalid UTF-8 code");

218 
	`lua_pushš‹g”
(
L
, 
n
 + 1);

219 
	`lua_pushš‹g”
(
L
, 
code
);

222 
	}
}

225 
	$™”_codes
 (
lua_S‹
 *
L
) {

226 
	`luaL_check¡ršg
(
L
, 1);

227 
	`lua_pushcfunùiÚ
(
L
, 
™”_aux
);

228 
	`lua_pushv®ue
(
L
, 1);

229 
	`lua_pushš‹g”
(
L
, 0);

231 
	}
}

235 
	#UTF8PATT
 "[\0-\x7F\xC2-\xF4][\x80-\xBF]*"

	)

238 cÚ¡ 
luaL_Reg
 
	gfuncs
[] = {

239 {"off£t", 
by‹off£t
},

240 {"cod•ošt", 
cod•ošt
},

241 {"ch¬", 
utfch¬
},

242 {"Ën", 
utæ’
},

243 {"codes", 
™”_codes
},

245 {"ch¬·‰”n", 
NULL
},

246 {
NULL
, NULL}

250 
LUAMOD_API
 
	$luaİ’_utf8
 (
lua_S‹
 *
L
) {

251 
	`luaL_Ãwlib
(
L
, 
funcs
);

252 
	`lua_pushl¡ršg
(
L
, 
UTF8PATT
, (UTF8PATT)/() - 1);

253 
	`lua_£tf›ld
(
L
, -2, "charpattern");

255 
	}
}

	@script/lua/lua-5.3.4/src/lvm.c

7 
	#lvm_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

12 
	~<æßt.h
>

13 
	~<lim™s.h
>

14 
	~<m©h.h
>

15 
	~<¡dio.h
>

16 
	~<¡dlib.h
>

17 
	~<¡ršg.h
>

19 
	~"lua.h
"

21 
	~"ldebug.h
"

22 
	~"ldo.h
"

23 
	~"lfunc.h
"

24 
	~"lgc.h
"

25 
	~"lobjeù.h
"

26 
	~"lİcodes.h
"

27 
	~"l¡©e.h
"

28 
	~"l¡ršg.h
"

29 
	~"ÉabË.h
"

30 
	~"Ém.h
"

31 
	~"lvm.h
"

35 
	#MAXTAGLOOP
 2000

	)

44 #ià!
defšed
(
l_štf™sf
)

47 
	#NBM
 (
	`l_m©hlim
(
MANT_DIG
))

	)

56 #ià((((
LUA_MAXINTEGER
 >> (
NBM
 / 4)) >> (NBM / 4)) >> (NBM / 4)) \

57 >> (
	gNBM
 - (3 * (NBM / 4)))) > 0

59 
	#l_štf™sf
(
i
) \

60 (-((
lua_IÁeg”
)1 << 
NBM
è<ğ(
i
è&& (iè<ğ(Öua_IÁeg”)1 << NBM))

	)

72 
	$luaV_tÚumb”_
 (cÚ¡ 
TV®ue
 *
obj
, 
lua_Numb”
 *
n
) {

73 
TV®ue
 
v
;

74 ià(
	`‰isš‹g”
(
obj
)) {

75 *
n
 = 
	`ÿ¡_num
(
	`iv®ue
(
obj
));

78 ià(
	`cvt2num
(
obj
) &&

79 
	`luaO_¡r2num
(
	`sv®ue
(
obj
), &
v
è=ğ
	`v¦’
(obj) + 1) {

80 *
n
 = 
	`nv®ue
(&
v
);

85 
	}
}

94 
	$luaV_toš‹g”
 (cÚ¡ 
TV®ue
 *
obj
, 
lua_IÁeg”
 *
p
, 
mode
) {

95 
TV®ue
 
v
;

96 
agaš
:

97 ià(
	`‰isæßt
(
obj
)) {

98 
lua_Numb”
 
n
 = 
	`ætv®ue
(
obj
);

99 
lua_Numb”
 
f
 = 
	`l_æoÜ
(
n
);

100 ià(
n
 !ğ
f
) {

101 ià(
mode
 == 0)  0;

102 ià(
mode
 > 1)

103 
f
 += 1;

105  
	`lua_numb”toš‹g”
(
f
, 
p
);

107 ià(
	`‰isš‹g”
(
obj
)) {

108 *
p
 = 
	`iv®ue
(
obj
);

111 ià(
	`cvt2num
(
obj
) &&

112 
	`luaO_¡r2num
(
	`sv®ue
(
obj
), &
v
è=ğ
	`v¦’
(obj) + 1) {

113 
obj
 = &
v
;

114 
agaš
;

117 
	}
}

135 
	$fÜlim™
 (cÚ¡ 
TV®ue
 *
obj
, 
lua_IÁeg”
 *
p
,†ua_IÁeg” 
¡•
,

136 *
¡İnow
) {

137 *
¡İnow
 = 0;

138 ià(!
	`luaV_toš‹g”
(
obj
, 
p
, (
¡•
 < 0 ? 2 : 1))) {

139 
lua_Numb”
 
n
;

140 ià(!
	`tÚumb”
(
obj
, &
n
))

142 ià(
	`luai_numÉ
(0, 
n
)) {

143 *
p
 = 
LUA_MAXINTEGER
;

144 ià(
¡•
 < 0è*
¡İnow
 = 1;

147 *
p
 = 
LUA_MININTEGER
;

148 ià(
¡•
 >ğ0è*
¡İnow
 = 1;

152 
	}
}

160 
	$luaV_fšishg‘
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t
, TV®u*
key
, 
StkId
 
v®
,

161 cÚ¡ 
TV®ue
 *
¦Ù
) {

162 
loİ
;

163 cÚ¡ 
TV®ue
 *
tm
;

164 
loİ
 = 0;†oİ < 
MAXTAGLOOP
;†oop++) {

165 ià(
¦Ù
 =ğ
NULL
) {

166 
	`lua_as£¹
(!
	`‰i¡abË
(
t
));

167 
tm
 = 
	`luaT_g‘tmbyobj
(
L
, 
t
, 
TM_INDEX
);

168 ià(
	`‰i¢
(
tm
))

169 
	`luaG_ty³”rÜ
(
L
, 
t
, "index");

173 
	`lua_as£¹
(
	`‰i¢
(
¦Ù
));

174 
tm
 = 
	`ç¡tm
(
L
, 
	`hv®ue
(
t
)->
m‘©abË
, 
TM_INDEX
);

175 ià(
tm
 =ğ
NULL
) {

176 
	`£Šv®ue
(
v®
);

181 ià(
	`‰isfunùiÚ
(
tm
)) {

182 
	`luaT_ÿÎTM
(
L
, 
tm
, 
t
, 
key
, 
v®
, 1);

185 
t
 = 
tm
;

186 ià(
	`luaV_ç¡g‘
(
L
,
t
,
key
,
¦Ù
,
luaH_g‘
)) {

187 
	`£tobj2s
(
L
, 
v®
, 
¦Ù
);

192 
	`luaG_ruÃ¼Ü
(
L
, "'__index' chainoo†ong;…ossible†oop");

193 
	}
}

203 
	$luaV_fšish£t
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t
, TV®u*
key
,

204 
StkId
 
v®
, cÚ¡ 
TV®ue
 *
¦Ù
) {

205 
loİ
;

206 
loİ
 = 0;†oİ < 
MAXTAGLOOP
;†oop++) {

207 cÚ¡ 
TV®ue
 *
tm
;

208 ià(
¦Ù
 !ğ
NULL
) {

209 
TabË
 *
h
 = 
	`hv®ue
(
t
);

210 
	`lua_as£¹
(
	`‰i¢
(
¦Ù
));

211 
tm
 = 
	`ç¡tm
(
L
, 
h
->
m‘©abË
, 
TM_NEWINDEX
);

212 ià(
tm
 =ğ
NULL
) {

213 ià(
¦Ù
 =ğ
luaO_nobjeù
)

214 
¦Ù
 = 
	`luaH_Ãwkey
(
L
, 
h
, 
key
);

216 
	`£tobj2t
(
L
, 
	`ÿ¡
(
TV®ue
 *, 
¦Ù
), 
v®
);

217 
	`šv®id©eTMÿche
(
h
);

218 
	`luaC_b¬r›rback
(
L
, 
h
, 
v®
);

224 ià(
	`‰i¢
(
tm
 = 
	`luaT_g‘tmbyobj
(
L
, 
t
, 
TM_NEWINDEX
)))

225 
	`luaG_ty³”rÜ
(
L
, 
t
, "index");

228 ià(
	`‰isfunùiÚ
(
tm
)) {

229 
	`luaT_ÿÎTM
(
L
, 
tm
, 
t
, 
key
, 
v®
, 0);

232 
t
 = 
tm
;

233 ià(
	`luaV_ç¡£t
(
L
, 
t
, 
key
, 
¦Ù
, 
luaH_g‘
, 
v®
))

237 
	`luaG_ruÃ¼Ü
(
L
, "'__newindex' chainoo†ong;…ossible†oop");

238 
	}
}

248 
	$l_¡rcmp
 (cÚ¡ 
TSŒšg
 *
ls
, cÚ¡ TSŒšg *
rs
) {

249 cÚ¡ *
l
 = 
	`g‘¡r
(
ls
);

250 
size_t
 
Î
 = 
	`ts¦’
(
ls
);

251 cÚ¡ *
r
 = 
	`g‘¡r
(
rs
);

252 
size_t
 
Ì
 = 
	`ts¦’
(
rs
);

254 
‹mp
 = 
	`¡rcŞl
(
l
, 
r
);

255 ià(
‹mp
 != 0)

256  
‹mp
;

258 
size_t
 
Ën
 = 
	`¡¾’
(
l
);

259 ià(
Ën
 =ğ
Ì
)

260  (
Ën
 =ğ
Î
) ? 0 : 1;

261 ià(
Ën
 =ğ
Î
)

264 
Ën
++;

265 
l
 +ğ
Ën
; 
Î
 -ğËn; 
r
 +ğËn; 
Ì
 -=†en;

268 
	}
}

281 
	$LTštæßt
 (
lua_IÁeg”
 
i
, 
lua_Numb”
 
f
) {

282 #ià
	`defšed
(
l_štf™sf
)

283 ià(!
	`l_štf™sf
(
i
)) {

284 ià(
f
 >ğ-
	`ÿ¡_num
(
LUA_MININTEGER
))

286 ià(
f
 > 
	`ÿ¡_num
(
LUA_MININTEGER
))

287  (
i
 < 
	`ÿ¡
(
lua_IÁeg”
, 
f
));

292  
	`luai_numÉ
(
	`ÿ¡_num
(
i
), 
f
);

293 
	}
}

300 
	$LEštæßt
 (
lua_IÁeg”
 
i
, 
lua_Numb”
 
f
) {

301 #ià
	`defšed
(
l_štf™sf
)

302 ià(!
	`l_štf™sf
(
i
)) {

303 ià(
f
 >ğ-
	`ÿ¡_num
(
LUA_MININTEGER
))

305 ià(
f
 >ğ
	`ÿ¡_num
(
LUA_MININTEGER
))

306  (
i
 <ğ
	`ÿ¡
(
lua_IÁeg”
, 
f
));

311  
	`luai_numË
(
	`ÿ¡_num
(
i
), 
f
);

312 
	}
}

318 
	$LTnum
 (cÚ¡ 
TV®ue
 *
l
, cÚ¡ TV®u*
r
) {

319 ià(
	`‰isš‹g”
(
l
)) {

320 
lua_IÁeg”
 
li
 = 
	`iv®ue
(
l
);

321 ià(
	`‰isš‹g”
(
r
))

322  
li
 < 
	`iv®ue
(
r
);

324  
	`LTštæßt
(
li
, 
	`ætv®ue
(
r
));

327 
lua_Numb”
 
lf
 = 
	`ætv®ue
(
l
);

328 ià(
	`‰isæßt
(
r
))

329  
	`luai_numÉ
(
lf
, 
	`ætv®ue
(
r
));

330 ià(
	`luai_numi¢ª
(
lf
))

333  !
	`LEštæßt
(
	`iv®ue
(
r
), 
lf
);

335 
	}
}

341 
	$LEnum
 (cÚ¡ 
TV®ue
 *
l
, cÚ¡ TV®u*
r
) {

342 ià(
	`‰isš‹g”
(
l
)) {

343 
lua_IÁeg”
 
li
 = 
	`iv®ue
(
l
);

344 ià(
	`‰isš‹g”
(
r
))

345  
li
 <ğ
	`iv®ue
(
r
);

347  
	`LEštæßt
(
li
, 
	`ætv®ue
(
r
));

350 
lua_Numb”
 
lf
 = 
	`ætv®ue
(
l
);

351 ià(
	`‰isæßt
(
r
))

352  
	`luai_numË
(
lf
, 
	`ætv®ue
(
r
));

353 ià(
	`luai_numi¢ª
(
lf
))

356  !
	`LTštæßt
(
	`iv®ue
(
r
), 
lf
);

358 
	}
}

364 
	$luaV_Ës¡hª
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
l
, cÚ¡ TV®u*
r
) {

365 
»s
;

366 ià(
	`‰i¢umb”
(
l
è&&ti¢umb”(
r
))

367  
	`LTnum
(
l
, 
r
);

368 ià(
	`‰is¡ršg
(
l
è&&tis¡ršg(
r
))

369  
	`l_¡rcmp
(
	`tsv®ue
(
l
),sv®ue(
r
)) < 0;

370 ià((
»s
 = 
	`luaT_ÿÎÜd”TM
(
L
, 
l
, 
r
, 
TM_LT
)) < 0)

371 
	`luaG_Üd””rÜ
(
L
, 
l
, 
r
);

372  
»s
;

373 
	}
}

384 
	$luaV_Ës£qu®
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
l
, cÚ¡ TV®u*
r
) {

385 
»s
;

386 ià(
	`‰i¢umb”
(
l
è&&ti¢umb”(
r
))

387  
	`LEnum
(
l
, 
r
);

388 ià(
	`‰is¡ršg
(
l
è&&tis¡ršg(
r
))

389  
	`l_¡rcmp
(
	`tsv®ue
(
l
),sv®ue(
r
)) <= 0;

390 ià((
»s
 = 
	`luaT_ÿÎÜd”TM
(
L
, 
l
, 
r
, 
TM_LE
)) >= 0)

391  
»s
;

393 
L
->
ci
->
ÿÎ¡©us
 |ğ
CIST_LEQ
;

394 
»s
 = 
	`luaT_ÿÎÜd”TM
(
L
, 
r
, 
l
, 
TM_LT
);

395 
L
->
ci
->
ÿÎ¡©us
 ^ğ
CIST_LEQ
;

396 ià(
»s
 < 0)

397 
	`luaG_Üd””rÜ
(
L
, 
l
, 
r
);

398  !
»s
;

400 
	}
}

407 
	$luaV_equ®obj
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t1
, cÚ¡ TV®u*
t2
) {

408 cÚ¡ 
TV®ue
 *
tm
;

409 ià(
	`‰y³
(
t1
è!ğ‰y³(
t2
)) {

410 ià(
	`‰nov
(
t1
è!ğ‰nov(
t2
è||ŠovÑ1è!ğ
LUA_TNUMBER
)

413 
lua_IÁeg”
 
i1
, 
i2
;

414  (
	`toš‹g”
(
t1
, &
i1
è&&oš‹g”(
t2
, &
i2
) && i1 == i2);

418 
	`‰y³
(
t1
)) {

419 
LUA_TNIL
:  1;

420 
LUA_TNUMINT
:  (
	`iv®ue
(
t1
è=ğiv®ue(
t2
));

421 
LUA_TNUMFLT
:  
	`luai_numeq
(
	`ætv®ue
(
t1
), fÉv®ue(
t2
));

422 
LUA_TBOOLEAN
:  
	`bv®ue
(
t1
è=ğbv®ue(
t2
);

423 
LUA_TLIGHTUSERDATA
:  
	`pv®ue
(
t1
è=ğpv®ue(
t2
);

424 
LUA_TLCF
:  
	`fv®ue
(
t1
è=ğfv®ue(
t2
);

425 
LUA_TSHRSTR
:  
	`eqshr¡r
(
	`tsv®ue
(
t1
),sv®ue(
t2
));

426 
LUA_TLNGSTR
:  
	`luaS_eqÊg¡r
(
	`tsv®ue
(
t1
),sv®ue(
t2
));

427 
LUA_TUSERDATA
: {

428 ià(
	`uv®ue
(
t1
è=ğuv®ue(
t2
))  1;

429 ià(
L
 =ğ
NULL
)  0;

430 
tm
 = 
	`ç¡tm
(
L
, 
	`uv®ue
(
t1
)->
m‘©abË
, 
TM_EQ
);

431 ià(
tm
 =ğ
NULL
)

432 
tm
 = 
	`ç¡tm
(
L
, 
	`uv®ue
(
t2
)->
m‘©abË
, 
TM_EQ
);

435 
LUA_TTABLE
: {

436 ià(
	`hv®ue
(
t1
è=ğhv®ue(
t2
))  1;

437 ià(
L
 =ğ
NULL
)  0;

438 
tm
 = 
	`ç¡tm
(
L
, 
	`hv®ue
(
t1
)->
m‘©abË
, 
TM_EQ
);

439 ià(
tm
 =ğ
NULL
)

440 
tm
 = 
	`ç¡tm
(
L
, 
	`hv®ue
(
t2
)->
m‘©abË
, 
TM_EQ
);

444  
	`gcv®ue
(
t1
è=ğgcv®ue(
t2
);

446 ià(
tm
 =ğ
NULL
)

448 
	`luaT_ÿÎTM
(
L
, 
tm
, 
t1
, 
t2
, L->
tİ
, 1);

449  !
	`l_isçl£
(
L
->
tİ
);

450 
	}
}

454 
	#to¡ršg
(
L
,
o
) \

455 (
	`‰is¡ršg
(
o
è|| (
	`cvt2¡r
(oè&& (
	`luaO_to¡ršg
(
L
, o), 1)))

	)

457 
	#i£m±y¡r
(
o
è(
	`‰isshr¡ršg
(oè&& 
	`tsv®ue
(o)->
sh¾’
 =ğ0)

	)

460 
	$cİy2buff
 (
StkId
 
tİ
, 
n
, *
buff
) {

461 
size_t
 

 = 0;

463 
size_t
 
l
 = 
	`v¦’
(
tİ
 - 
n
);

464 
	`memıy
(
buff
 + 

, 
	`sv®ue
(
tİ
 - 
n
), 
l
 * ());

465 

 +ğ
l
;

466 } --
n
 > 0);

467 
	}
}

474 
	$luaV_cÚÿt
 (
lua_S‹
 *
L
, 
tÙ®
) {

475 
	`lua_as£¹
(
tÙ®
 >= 2);

477 
StkId
 
tİ
 = 
L
->top;

478 
n
 = 2;

479 ià(!(
	`‰is¡ršg
(
tİ
-2è|| 
	`cvt2¡r
Ñİ-2)è|| !
	`to¡ršg
(
L
,op-1))

480 
	`luaT_ŒybšTM
(
L
, 
tİ
-2,İ-1,İ-2, 
TM_CONCAT
);

481 ià(
	`i£m±y¡r
(
tİ
 - 1))

482 
	`ÿ¡_void
(
	`to¡ršg
(
L
, 
tİ
 - 2));

483 ià(
	`i£m±y¡r
(
tİ
 - 2)) {

484 
	`£tobjs2s
(
L
, 
tİ
 - 2,op - 1);

488 
size_t
 

 = 
	`v¦’
(
tİ
 - 1);

489 
TSŒšg
 *
ts
;

491 
n
 = 1;‚ < 
tÙ®
 && 
	`to¡ršg
(
L
, 
tİ
 -‚ - 1);‚++) {

492 
size_t
 
l
 = 
	`v¦’
(
tİ
 - 
n
 - 1);

493 ià(
l
 >ğ(
MAX_SIZE
/()è- 

)

494 
	`luaG_ruÃ¼Ü
(
L
, "string†ength overflow");

495 

 +ğ
l
;

497 ià(

 <ğ
LUAI_MAXSHORTLEN
) {

498 
buff
[
LUAI_MAXSHORTLEN
];

499 
	`cİy2buff
(
tİ
, 
n
, 
buff
);

500 
ts
 = 
	`luaS_Ãwl¡r
(
L
, 
buff
, 

);

503 
ts
 = 
	`luaS_ü—‹Êg¡robj
(
L
, 

);

504 
	`cİy2buff
(
tİ
, 
n
, 
	`g‘¡r
(
ts
));

506 
	`£tsv®ue2s
(
L
, 
tİ
 - 
n
, 
ts
);

508 
tÙ®
 -ğ
n
-1;

509 
L
->
tİ
 -ğ
n
-1;

510 } 
tÙ®
 > 1);

511 
	}
}

517 
	$luaV_objËn
 (
lua_S‹
 *
L
, 
StkId
 
¿
, cÚ¡ 
TV®ue
 *
rb
) {

518 cÚ¡ 
TV®ue
 *
tm
;

519 
	`‰y³
(
rb
)) {

520 
LUA_TTABLE
: {

521 
TabË
 *
h
 = 
	`hv®ue
(
rb
);

522 
tm
 = 
	`ç¡tm
(
L
, 
h
->
m‘©abË
, 
TM_LEN
);

523 ià(
tm
) ;

524 
	`£tiv®ue
(
¿
, 
	`luaH_g‘n
(
h
));

527 
LUA_TSHRSTR
: {

528 
	`£tiv®ue
(
¿
, 
	`tsv®ue
(
rb
)->
sh¾’
);

531 
LUA_TLNGSTR
: {

532 
	`£tiv®ue
(
¿
, 
	`tsv®ue
(
rb
)->
u
.
ÊgËn
);

536 
tm
 = 
	`luaT_g‘tmbyobj
(
L
, 
rb
, 
TM_LEN
);

537 ià(
	`‰i¢
(
tm
))

538 
	`luaG_ty³”rÜ
(
L
, 
rb
, "get†ength of");

542 
	`luaT_ÿÎTM
(
L
, 
tm
, 
rb
,„b, 
¿
, 1);

543 
	}
}

552 
lua_IÁeg”
 
	$luaV_div
 (
lua_S‹
 *
L
, 
lua_IÁeg”
 
m
,†ua_IÁeg” 
n
) {

553 ià(
	`l_ÿ¡S2U
(
n
) + 1u <= 1u) {

554 ià(
n
 == 0)

555 
	`luaG_ruÃ¼Ü
(
L
, "attempto divide by zero");

556  
	`štİ
(-, 0, 
m
);

559 
lua_IÁeg”
 
q
 = 
m
 / 
n
;

560 ià((
m
 ^ 
n
) < 0 && m %‚ != 0)

561 
q
 -= 1;

562  
q
;

564 
	}
}

572 
lua_IÁeg”
 
	$luaV_mod
 (
lua_S‹
 *
L
, 
lua_IÁeg”
 
m
,†ua_IÁeg” 
n
) {

573 ià(
	`l_ÿ¡S2U
(
n
) + 1u <= 1u) {

574 ià(
n
 == 0)

575 
	`luaG_ruÃ¼Ü
(
L
, "attempto…erform 'n%%0'");

579 
lua_IÁeg”
 
r
 = 
m
 % 
n
;

580 ià(
r
 !ğ0 && (
m
 ^ 
n
) < 0)

581 
r
 +ğ
n
;

582  
r
;

584 
	}
}

588 
	#NBITS
 
	`ÿ¡_št
((
lua_IÁeg”
è* 
CHAR_BIT
)

	)

593 
lua_IÁeg”
 
	$luaV_shiál
 (
lua_IÁeg”
 
x
,†ua_IÁeg” 
y
) {

594 ià(
y
 < 0) {

595 ià(
y
 <ğ-
NBITS
)  0;

596  
	`štİ
(>>, 
x
, -
y
);

599 ià(
y
 >ğ
NBITS
)  0;

600  
	`štİ
(<<, 
x
, 
y
);

602 
	}
}

610 
LClosu»
 *
	$g‘ÿched
 (
PrÙo
 *
p
, 
UpV®
 **
’cup
, 
StkId
 
ba£
) {

611 
LClosu»
 *
c
 = 
p
->
ÿche
;

612 ià(
c
 !ğ
NULL
) {

613 
nup
 = 
p
->
sizeupv®ues
;

614 
Upv®desc
 *
uv
 = 
p
->
upv®ues
;

615 
i
;

616 
i
 = 0; i < 
nup
; i++) {

617 
TV®ue
 *
v
 = 
uv
[
i
].
š¡ack
 ? 
ba£
 + uv[i].
idx
 : 
’cup
[uv[i].idx]->v;

618 ià(
c
->
upv®s
[
i
]->
v
 != v)

619  
NULL
;

622  
c
;

623 
	}
}

632 
	$pushşosu»
 (
lua_S‹
 *
L
, 
PrÙo
 *
p
, 
UpV®
 **
’cup
, 
StkId
 
ba£
,

633 
StkId
 
¿
) {

634 
nup
 = 
p
->
sizeupv®ues
;

635 
Upv®desc
 *
uv
 = 
p
->
upv®ues
;

636 
i
;

637 
LClosu»
 *
nş
 = 
	`luaF_ÃwLşosu»
(
L
, 
nup
);

638 
nş
->
p
 =…;

639 
	`£tşLv®ue
(
L
, 
¿
, 
nş
);

640 
i
 = 0; i < 
nup
; i++) {

641 ià(
uv
[
i
].
š¡ack
)

642 
nş
->
upv®s
[
i
] = 
	`luaF_fšdupv®
(
L
, 
ba£
 + 
uv
[i].
idx
);

644 
nş
->
upv®s
[
i
] = 
’cup
[
uv
[i].
idx
];

645 
nş
->
upv®s
[
i
]->
»fcouÁ
++;

648 ià(!
	`isbÏck
(
p
))

649 
p
->
ÿche
 = 
nş
;

650 
	}
}

656 
	$luaV_fšishOp
 (
lua_S‹
 *
L
) {

657 
C®lInfo
 *
ci
 = 
L
->ci;

658 
StkId
 
ba£
 = 
ci
->
u
.
l
.base;

659 
In¡ruùiÚ
 
š¡
 = *(
ci
->
u
.
l
.
§vedpc
 - 1);

660 
OpCode
 
İ
 = 
	`GET_OPCODE
(
š¡
);

661 
İ
) {

662 
OP_ADD
: 
OP_SUB
: 
OP_MUL
: 
OP_DIV
: 
OP_IDIV
:

663 
OP_BAND
: 
OP_BOR
: 
OP_BXOR
: 
OP_SHL
: 
OP_SHR
:

664 
OP_MOD
: 
OP_POW
:

665 
OP_UNM
: 
OP_BNOT
: 
OP_LEN
:

666 
OP_GETTABUP
: 
OP_GETTABLE
: 
OP_SELF
: {

667 
	`£tobjs2s
(
L
, 
ba£
 + 
	`GETARG_A
(
š¡
), --L->
tİ
);

670 
OP_LE
: 
OP_LT
: 
OP_EQ
: {

671 
»s
 = !
	`l_isçl£
(
L
->
tİ
 - 1);

672 
L
->
tİ
--;

673 ià(
ci
->
ÿÎ¡©us
 & 
CIST_LEQ
) {

674 
	`lua_as£¹
(
İ
 =ğ
OP_LE
);

675 
ci
->
ÿÎ¡©us
 ^ğ
CIST_LEQ
;

676 
»s
 = !res;

678 
	`lua_as£¹
(
	`GET_OPCODE
(*
ci
->
u
.
l
.
§vedpc
è=ğ
OP_JMP
);

679 ià(
»s
 !ğ
	`GETARG_A
(
š¡
))

680 
ci
->
u
.
l
.
§vedpc
++;

683 
OP_CONCAT
: {

684 
StkId
 
tİ
 = 
L
->top - 1;

685 
b
 = 
	`GETARG_B
(
š¡
);

686 
tÙ®
 = 
	`ÿ¡_št
(
tİ
 - 1 - (
ba£
 + 
b
));

687 
	`£tobj2s
(
L
, 
tİ
 - 2,op);

688 ià(
tÙ®
 > 1) {

689 
L
->
tİ
 =op - 1;

690 
	`luaV_cÚÿt
(
L
, 
tÙ®
);

693 
	`£tobj2s
(
L
, 
ci
->
u
.
l
.
ba£
 + 
	`GETARG_A
(
š¡
), L->
tİ
 - 1);

694 
L
->
tİ
 = 
ci
->top;

697 
OP_TFORCALL
: {

698 
	`lua_as£¹
(
	`GET_OPCODE
(*
ci
->
u
.
l
.
§vedpc
è=ğ
OP_TFORLOOP
);

699 
L
->
tİ
 = 
ci
->top;

702 
OP_CALL
: {

703 ià(
	`GETARG_C
(
š¡
) - 1 >= 0)

704 
L
->
tİ
 = 
ci
->top;

707 
OP_TAILCALL
: 
OP_SETTABUP
: 
OP_SETTABLE
:

709 : 
	`lua_as£¹
(0);

711 
	}
}

728 
	#RA
(
i
è(
ba£
+
	`GETARG_A
(i))

	)

729 
	#RB
(
i
è
	`check_exp
(
	`g‘BMode
(
	`GET_OPCODE
(i)è=ğ
OpArgR
, 
ba£
+
	`GETARG_B
(i))

	)

730 
	#RC
(
i
è
	`check_exp
(
	`g‘CMode
(
	`GET_OPCODE
(i)è=ğ
OpArgR
, 
ba£
+
	`GETARG_C
(i))

	)

731 
	#RKB
(
i
è
	`check_exp
(
	`g‘BMode
(
	`GET_OPCODE
(i)è=ğ
OpArgK
, \

732 
	`ISK
(
	`GETARG_B
(
i
)è? 
k
+
	`INDEXK
(GETARG_B(i)è: 
ba£
+GETARG_B(i))

	)

733 
	#RKC
(
i
è
	`check_exp
(
	`g‘CMode
(
	`GET_OPCODE
(i)è=ğ
OpArgK
, \

734 
	`ISK
(
	`GETARG_C
(
i
)è? 
k
+
	`INDEXK
(GETARG_C(i)è: 
ba£
+GETARG_C(i))

	)

738 
	#dojump
(
ci
,
i
,
e
) \

739 { 
a
 = 
	`GETARG_A
(
i
); \

740 ià(
a
 !ğ0è
	`luaF_şo£
(
L
, 
ci
->
u
.
l
.
ba£
 +‡ - 1); \

741 
ci
->
u
.
l
.
§vedpc
 +ğ
	`GETARG_sBx
(
i
è+ 
e
; }

	)

744 
	#dÚextjump
(
ci
è{ 
i
 = *ci->
u
.
l
.
§vedpc
; 
	`dojump
(ci, i, 1); }

	)

747 
	#PrÙeù
(
x
è{ {x;}; 
ba£
 = 
ci
->
u
.
l
.ba£; }

	)

749 
	#checkGC
(
L
,
c
) \

750 { 
	`luaC_cÚdGC
(
L
, L->
tİ
 = (
c
), \

751 
	`PrÙeù
(
L
->
tİ
 = 
ci
->top)); \

752 
	`luai_th»ady›ld
(
L
); }

	)

756 
	#vmãtch
() { \

757 
i
 = *(
ci
->
u
.
l
.
§vedpc
++); \

758 ià(
L
->
hookmask
 & (
LUA_MASKLINE
 | 
LUA_MASKCOUNT
)) \

759 
	`PrÙeù
(
	`luaG_Œaûexec
(
L
)); \

760 
¿
 = 
	`RA
(
i
); \

761 
	`lua_as£¹
(
ba£
 =ğ
ci
->
u
.
l
.base); \

762 
	`lua_as£¹
(
ba£
 <ğ
L
->
tİ
 && L->tİ < L->
¡ack
 + L->
¡acksize
); \

763 }

	)

765 
	#vmdi¥©ch
(
o
èo)

	)

766 
	#vmÿ£
(
l
èl:

	)

767 
	#vmb»ak
 

	)

774 
	#g‘bËPrÙeùed
(
L
,
t
,
k
,
v
è{ cÚ¡ 
TV®ue
 *
¦Ù
; \

775 ià(
	`luaV_ç¡g‘
(
L
,
t
,
k
,
¦Ù
,
luaH_g‘
)è{ 
	`£tobj2s
(L, 
v
, slot); } \

776 
	`PrÙeù
(
	`luaV_fšishg‘
(
L
,
t
,
k
,
v
,
¦Ù
)); }

	)

780 
	#£‰abËPrÙeùed
(
L
,
t
,
k
,
v
è{ cÚ¡ 
TV®ue
 *
¦Ù
; \

781 ià(!
	`luaV_ç¡£t
(
L
,
t
,
k
,
¦Ù
,
luaH_g‘
,
v
)) \

782 
	`PrÙeù
(
	`luaV_fšish£t
(
L
,
t
,
k
,
v
,
¦Ù
)); }

	)

786 
	$luaV_execu‹
 (
lua_S‹
 *
L
) {

787 
C®lInfo
 *
ci
 = 
L
->ci;

788 
LClosu»
 *
ş
;

789 
TV®ue
 *
k
;

790 
StkId
 
ba£
;

791 
ci
->
ÿÎ¡©us
 |ğ
CIST_FRESH
;

792 
Ãwäame
:

793 
	`lua_as£¹
(
ci
 =ğ
L
->ci);

794 
ş
 = 
	`şLv®ue
(
ci
->
func
);

795 
k
 = 
ş
->
p
->k;

796 
ba£
 = 
ci
->
u
.
l
.base;

799 
In¡ruùiÚ
 
i
;

800 
StkId
 
¿
;

801 
	`vmãtch
();

802 
	`vmdi¥©ch
 (
	`GET_OPCODE
(
i
)) {

803 
	`vmÿ£
(
OP_MOVE
) {

804 
	`£tobjs2s
(
L
, 
¿
, 
	`RB
(
i
));

805 
vmb»ak
;

807 
	`vmÿ£
(
OP_LOADK
) {

808 
TV®ue
 *
rb
 = 
k
 + 
	`GETARG_Bx
(
i
);

809 
	`£tobj2s
(
L
, 
¿
, 
rb
);

810 
vmb»ak
;

812 
	`vmÿ£
(
OP_LOADKX
) {

813 
TV®ue
 *
rb
;

814 
	`lua_as£¹
(
	`GET_OPCODE
(*
ci
->
u
.
l
.
§vedpc
è=ğ
OP_EXTRAARG
);

815 
rb
 = 
k
 + 
	`GETARG_Ax
(*
ci
->
u
.
l
.
§vedpc
++);

816 
	`£tobj2s
(
L
, 
¿
, 
rb
);

817 
vmb»ak
;

819 
	`vmÿ£
(
OP_LOADBOOL
) {

820 
	`£tbv®ue
(
¿
, 
	`GETARG_B
(
i
));

821 ià(
	`GETARG_C
(
i
)è
ci
->
u
.
l
.
§vedpc
++;

822 
vmb»ak
;

824 
	`vmÿ£
(
OP_LOADNIL
) {

825 
b
 = 
	`GETARG_B
(
i
);

827 
	`£Šv®ue
(
¿
++);

828 } 
b
--);

829 
vmb»ak
;

831 
	`vmÿ£
(
OP_GETUPVAL
) {

832 
b
 = 
	`GETARG_B
(
i
);

833 
	`£tobj2s
(
L
, 
¿
, 
ş
->
upv®s
[
b
]->
v
);

834 
vmb»ak
;

836 
	`vmÿ£
(
OP_GETTABUP
) {

837 
TV®ue
 *
upv®
 = 
ş
->
upv®s
[
	`GETARG_B
(
i
)]->
v
;

838 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

839 
	`g‘bËPrÙeùed
(
L
, 
upv®
, 
rc
, 
¿
);

840 
vmb»ak
;

842 
	`vmÿ£
(
OP_GETTABLE
) {

843 
StkId
 
rb
 = 
	`RB
(
i
);

844 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

845 
	`g‘bËPrÙeùed
(
L
, 
rb
, 
rc
, 
¿
);

846 
vmb»ak
;

848 
	`vmÿ£
(
OP_SETTABUP
) {

849 
TV®ue
 *
upv®
 = 
ş
->
upv®s
[
	`GETARG_A
(
i
)]->
v
;

850 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

851 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

852 
	`£‰abËPrÙeùed
(
L
, 
upv®
, 
rb
, 
rc
);

853 
vmb»ak
;

855 
	`vmÿ£
(
OP_SETUPVAL
) {

856 
UpV®
 *
uv
 = 
ş
->
upv®s
[
	`GETARG_B
(
i
)];

857 
	`£tobj
(
L
, 
uv
->
v
, 
¿
);

858 
	`luaC_upv®b¬r›r
(
L
, 
uv
);

859 
vmb»ak
;

861 
	`vmÿ£
(
OP_SETTABLE
) {

862 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

863 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

864 
	`£‰abËPrÙeùed
(
L
, 
¿
, 
rb
, 
rc
);

865 
vmb»ak
;

867 
	`vmÿ£
(
OP_NEWTABLE
) {

868 
b
 = 
	`GETARG_B
(
i
);

869 
c
 = 
	`GETARG_C
(
i
);

870 
TabË
 *
t
 = 
	`luaH_Ãw
(
L
);

871 
	`£thv®ue
(
L
, 
¿
, 
t
);

872 ià(
b
 !ğ0 || 
c
 != 0)

873 
	`luaH_»size
(
L
, 
t
, 
	`luaO_fb2št
(
b
),†uaO_fb2št(
c
));

874 
	`checkGC
(
L
, 
¿
 + 1);

875 
vmb»ak
;

877 
	`vmÿ£
(
OP_SELF
) {

878 cÚ¡ 
TV®ue
 *
aux
;

879 
StkId
 
rb
 = 
	`RB
(
i
);

880 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

881 
TSŒšg
 *
key
 = 
	`tsv®ue
(
rc
);

882 
	`£tobjs2s
(
L
, 
¿
 + 1, 
rb
);

883 ià(
	`luaV_ç¡g‘
(
L
, 
rb
, 
key
, 
aux
, 
luaH_g‘¡r
)) {

884 
	`£tobj2s
(
L
, 
¿
, 
aux
);

886 
	`PrÙeù
(
	`luaV_fšishg‘
(
L
, 
rb
, 
rc
, 
¿
, 
aux
));

887 
vmb»ak
;

889 
	`vmÿ£
(
OP_ADD
) {

890 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

891 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

892 
lua_Numb”
 
nb
;†ua_Numb” 
nc
;

893 ià(
	`‰isš‹g”
(
rb
è&&tisš‹g”(
rc
)) {

894 
lua_IÁeg”
 
ib
 = 
	`iv®ue
(
rb
);†ua_IÁeg” 
ic
 = iv®ue(
rc
);

895 
	`£tiv®ue
(
¿
, 
	`štİ
(+, 
ib
, 
ic
));

897 ià(
	`tÚumb”
(
rb
, &
nb
è&&Úumb”(
rc
, &
nc
)) {

898 
	`£tætv®ue
(
¿
, 
	`luai_numadd
(
L
, 
nb
, 
nc
));

900 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_ADD
)); }

901 
vmb»ak
;

903 
	`vmÿ£
(
OP_SUB
) {

904 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

905 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

906 
lua_Numb”
 
nb
;†ua_Numb” 
nc
;

907 ià(
	`‰isš‹g”
(
rb
è&&tisš‹g”(
rc
)) {

908 
lua_IÁeg”
 
ib
 = 
	`iv®ue
(
rb
);†ua_IÁeg” 
ic
 = iv®ue(
rc
);

909 
	`£tiv®ue
(
¿
, 
	`štİ
(-, 
ib
, 
ic
));

911 ià(
	`tÚumb”
(
rb
, &
nb
è&&Úumb”(
rc
, &
nc
)) {

912 
	`£tætv®ue
(
¿
, 
	`luai_numsub
(
L
, 
nb
, 
nc
));

914 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_SUB
)); }

915 
vmb»ak
;

917 
	`vmÿ£
(
OP_MUL
) {

918 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

919 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

920 
lua_Numb”
 
nb
;†ua_Numb” 
nc
;

921 ià(
	`‰isš‹g”
(
rb
è&&tisš‹g”(
rc
)) {

922 
lua_IÁeg”
 
ib
 = 
	`iv®ue
(
rb
);†ua_IÁeg” 
ic
 = iv®ue(
rc
);

923 
	`£tiv®ue
(
¿
, 
	`štİ
(*, 
ib
, 
ic
));

925 ià(
	`tÚumb”
(
rb
, &
nb
è&&Úumb”(
rc
, &
nc
)) {

926 
	`£tætv®ue
(
¿
, 
	`luai_nummul
(
L
, 
nb
, 
nc
));

928 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_MUL
)); }

929 
vmb»ak
;

931 
	`vmÿ£
(
OP_DIV
) {

932 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

933 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

934 
lua_Numb”
 
nb
;†ua_Numb” 
nc
;

935 ià(
	`tÚumb”
(
rb
, &
nb
è&&Úumb”(
rc
, &
nc
)) {

936 
	`£tætv®ue
(
¿
, 
	`luai_numdiv
(
L
, 
nb
, 
nc
));

938 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_DIV
)); }

939 
vmb»ak
;

941 
	`vmÿ£
(
OP_BAND
) {

942 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

943 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

944 
lua_IÁeg”
 
ib
;†ua_IÁeg” 
ic
;

945 ià(
	`toš‹g”
(
rb
, &
ib
è&&oš‹g”(
rc
, &
ic
)) {

946 
	`£tiv®ue
(
¿
, 
	`štİ
(&, 
ib
, 
ic
));

948 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_BAND
)); }

949 
vmb»ak
;

951 
	`vmÿ£
(
OP_BOR
) {

952 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

953 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

954 
lua_IÁeg”
 
ib
;†ua_IÁeg” 
ic
;

955 ià(
	`toš‹g”
(
rb
, &
ib
è&&oš‹g”(
rc
, &
ic
)) {

956 
	`£tiv®ue
(
¿
, 
	`štİ
(|, 
ib
, 
ic
));

958 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_BOR
)); }

959 
vmb»ak
;

961 
	`vmÿ£
(
OP_BXOR
) {

962 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

963 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

964 
lua_IÁeg”
 
ib
;†ua_IÁeg” 
ic
;

965 ià(
	`toš‹g”
(
rb
, &
ib
è&&oš‹g”(
rc
, &
ic
)) {

966 
	`£tiv®ue
(
¿
, 
	`štİ
(^, 
ib
, 
ic
));

968 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_BXOR
)); }

969 
vmb»ak
;

971 
	`vmÿ£
(
OP_SHL
) {

972 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

973 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

974 
lua_IÁeg”
 
ib
;†ua_IÁeg” 
ic
;

975 ià(
	`toš‹g”
(
rb
, &
ib
è&&oš‹g”(
rc
, &
ic
)) {

976 
	`£tiv®ue
(
¿
, 
	`luaV_shiál
(
ib
, 
ic
));

978 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_SHL
)); }

979 
vmb»ak
;

981 
	`vmÿ£
(
OP_SHR
) {

982 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

983 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

984 
lua_IÁeg”
 
ib
;†ua_IÁeg” 
ic
;

985 ià(
	`toš‹g”
(
rb
, &
ib
è&&oš‹g”(
rc
, &
ic
)) {

986 
	`£tiv®ue
(
¿
, 
	`luaV_shiál
(
ib
, -
ic
));

988 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_SHR
)); }

989 
vmb»ak
;

991 
	`vmÿ£
(
OP_MOD
) {

992 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

993 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

994 
lua_Numb”
 
nb
;†ua_Numb” 
nc
;

995 ià(
	`‰isš‹g”
(
rb
è&&tisš‹g”(
rc
)) {

996 
lua_IÁeg”
 
ib
 = 
	`iv®ue
(
rb
);†ua_IÁeg” 
ic
 = iv®ue(
rc
);

997 
	`£tiv®ue
(
¿
, 
	`luaV_mod
(
L
, 
ib
, 
ic
));

999 ià(
	`tÚumb”
(
rb
, &
nb
è&&Úumb”(
rc
, &
nc
)) {

1000 
lua_Numb”
 
m
;

1001 
	`luai_nummod
(
L
, 
nb
, 
nc
, 
m
);

1002 
	`£tætv®ue
(
¿
, 
m
);

1004 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_MOD
)); }

1005 
vmb»ak
;

1007 
	`vmÿ£
(
OP_IDIV
) {

1008 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

1009 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

1010 
lua_Numb”
 
nb
;†ua_Numb” 
nc
;

1011 ià(
	`‰isš‹g”
(
rb
è&&tisš‹g”(
rc
)) {

1012 
lua_IÁeg”
 
ib
 = 
	`iv®ue
(
rb
);†ua_IÁeg” 
ic
 = iv®ue(
rc
);

1013 
	`£tiv®ue
(
¿
, 
	`luaV_div
(
L
, 
ib
, 
ic
));

1015 ià(
	`tÚumb”
(
rb
, &
nb
è&&Úumb”(
rc
, &
nc
)) {

1016 
	`£tætv®ue
(
¿
, 
	`luai_numidiv
(
L
, 
nb
, 
nc
));

1018 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_IDIV
)); }

1019 
vmb»ak
;

1021 
	`vmÿ£
(
OP_POW
) {

1022 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

1023 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

1024 
lua_Numb”
 
nb
;†ua_Numb” 
nc
;

1025 ià(
	`tÚumb”
(
rb
, &
nb
è&&Úumb”(
rc
, &
nc
)) {

1026 
	`£tætv®ue
(
¿
, 
	`luai_numpow
(
L
, 
nb
, 
nc
));

1028 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_POW
)); }

1029 
vmb»ak
;

1031 
	`vmÿ£
(
OP_UNM
) {

1032 
TV®ue
 *
rb
 = 
	`RB
(
i
);

1033 
lua_Numb”
 
nb
;

1034 ià(
	`‰isš‹g”
(
rb
)) {

1035 
lua_IÁeg”
 
ib
 = 
	`iv®ue
(
rb
);

1036 
	`£tiv®ue
(
¿
, 
	`štİ
(-, 0, 
ib
));

1038 ià(
	`tÚumb”
(
rb
, &
nb
)) {

1039 
	`£tætv®ue
(
¿
, 
	`luai_numunm
(
L
, 
nb
));

1042 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
,„b, 
¿
, 
TM_UNM
));

1044 
vmb»ak
;

1046 
	`vmÿ£
(
OP_BNOT
) {

1047 
TV®ue
 *
rb
 = 
	`RB
(
i
);

1048 
lua_IÁeg”
 
ib
;

1049 ià(
	`toš‹g”
(
rb
, &
ib
)) {

1050 
	`£tiv®ue
(
¿
, 
	`štİ
(^, ~
	`l_ÿ¡S2U
(0), 
ib
));

1053 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
,„b, 
¿
, 
TM_BNOT
));

1055 
vmb»ak
;

1057 
	`vmÿ£
(
OP_NOT
) {

1058 
TV®ue
 *
rb
 = 
	`RB
(
i
);

1059 
»s
 = 
	`l_isçl£
(
rb
);

1060 
	`£tbv®ue
(
¿
, 
»s
);

1061 
vmb»ak
;

1063 
	`vmÿ£
(
OP_LEN
) {

1064 
	`PrÙeù
(
	`luaV_objËn
(
L
, 
¿
, 
	`RB
(
i
)));

1065 
vmb»ak
;

1067 
	`vmÿ£
(
OP_CONCAT
) {

1068 
b
 = 
	`GETARG_B
(
i
);

1069 
c
 = 
	`GETARG_C
(
i
);

1070 
StkId
 
rb
;

1071 
L
->
tİ
 = 
ba£
 + 
c
 + 1;

1072 
	`PrÙeù
(
	`luaV_cÚÿt
(
L
, 
c
 - 
b
 + 1));

1073 
¿
 = 
	`RA
(
i
);

1074 
rb
 = 
ba£
 + 
b
;

1075 
	`£tobjs2s
(
L
, 
¿
, 
rb
);

1076 
	`checkGC
(
L
, (
¿
 >ğ
rb
 ?„a + 1 :„b));

1077 
L
->
tİ
 = 
ci
->top;

1078 
vmb»ak
;

1080 
	`vmÿ£
(
OP_JMP
) {

1081 
	`dojump
(
ci
, 
i
, 0);

1082 
vmb»ak
;

1084 
	`vmÿ£
(
OP_EQ
) {

1085 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

1086 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

1087 
	`PrÙeù
(

1088 ià(
	`luaV_equ®obj
(
L
, 
rb
, 
rc
è!ğ
	`GETARG_A
(
i
))

1089 
ci
->
u
.
l
.
§vedpc
++;

1091 
	`dÚextjump
(
ci
);

1093 
vmb»ak
;

1095 
	`vmÿ£
(
OP_LT
) {

1096 
	`PrÙeù
(

1097 ià(
	`luaV_Ës¡hª
(
L
, 
	`RKB
(
i
), 
	`RKC
(i)è!ğ
	`GETARG_A
(i))

1098 
ci
->
u
.
l
.
§vedpc
++;

1100 
	`dÚextjump
(
ci
);

1102 
vmb»ak
;

1104 
	`vmÿ£
(
OP_LE
) {

1105 
	`PrÙeù
(

1106 ià(
	`luaV_Ës£qu®
(
L
, 
	`RKB
(
i
), 
	`RKC
(i)è!ğ
	`GETARG_A
(i))

1107 
ci
->
u
.
l
.
§vedpc
++;

1109 
	`dÚextjump
(
ci
);

1111 
vmb»ak
;

1113 
	`vmÿ£
(
OP_TEST
) {

1114 ià(
	`GETARG_C
(
i
è? 
	`l_isçl£
(
¿
) : !l_isfalse(ra))

1115 
ci
->
u
.
l
.
§vedpc
++;

1117 
	`dÚextjump
(
ci
);

1118 
vmb»ak
;

1120 
	`vmÿ£
(
OP_TESTSET
) {

1121 
TV®ue
 *
rb
 = 
	`RB
(
i
);

1122 ià(
	`GETARG_C
(
i
è? 
	`l_isçl£
(
rb
) : !l_isfalse(rb))

1123 
ci
->
u
.
l
.
§vedpc
++;

1125 
	`£tobjs2s
(
L
, 
¿
, 
rb
);

1126 
	`dÚextjump
(
ci
);

1128 
vmb»ak
;

1130 
	`vmÿ£
(
OP_CALL
) {

1131 
b
 = 
	`GETARG_B
(
i
);

1132 
ÄesuÉs
 = 
	`GETARG_C
(
i
) - 1;

1133 ià(
b
 !ğ0è
L
->
tİ
 = 
¿
+b;

1134 ià(
	`luaD_´eÿÎ
(
L
, 
¿
, 
ÄesuÉs
)) {

1135 ià(
ÄesuÉs
 >= 0)

1136 
L
->
tİ
 = 
ci
->top;

1137 
	`PrÙeù
(()0);

1140 
ci
 = 
L
->ci;

1141 
Ãwäame
;

1143 
vmb»ak
;

1145 
	`vmÿ£
(
OP_TAILCALL
) {

1146 
b
 = 
	`GETARG_B
(
i
);

1147 ià(
b
 !ğ0è
L
->
tİ
 = 
¿
+b;

1148 
	`lua_as£¹
(
	`GETARG_C
(
i
è- 1 =ğ
LUA_MULTRET
);

1149 ià(
	`luaD_´eÿÎ
(
L
, 
¿
, 
LUA_MULTRET
)) {

1150 
	`PrÙeù
(()0);

1154 
C®lInfo
 *
nci
 = 
L
->
ci
;

1155 
C®lInfo
 *
oci
 = 
nci
->
´evious
;

1156 
StkId
 
nfunc
 = 
nci
->
func
;

1157 
StkId
 
ofunc
 = 
oci
->
func
;

1159 
StkId
 
lim
 = 
nci
->
u
.
l
.
ba£
 + 
	`g‘´Ùo
(
nfunc
)->
num·¿ms
;

1160 
aux
;

1162 ià(
ş
->
p
->
siz•
 > 0è
	`luaF_şo£
(
L
, 
oci
->
u
.
l
.
ba£
);

1164 
aux
 = 0; 
nfunc
 +‡ux < 
lim
;‡ux++)

1165 
	`£tobjs2s
(
L
, 
ofunc
 + 
aux
, 
nfunc
 +‡ux);

1166 
oci
->
u
.
l
.
ba£
 = 
ofunc
 + (
nci
->u.l.ba£ - 
nfunc
);

1167 
oci
->
tİ
 = 
L
->tİ = 
ofunc
 + (L->tİ - 
nfunc
);

1168 
oci
->
u
.
l
.
§vedpc
 = 
nci
->u.l.savedpc;

1169 
oci
->
ÿÎ¡©us
 |ğ
CIST_TAIL
;

1170 
ci
 = 
L
->c˜ğ
oci
;

1171 
	`lua_as£¹
(
L
->
tİ
 =ğ
oci
->
u
.
l
.
ba£
 + 
	`g‘´Ùo
(
ofunc
)->
max¡acksize
);

1172 
Ãwäame
;

1174 
vmb»ak
;

1176 
	`vmÿ£
(
OP_RETURN
) {

1177 
b
 = 
	`GETARG_B
(
i
);

1178 ià(
ş
->
p
->
siz•
 > 0è
	`luaF_şo£
(
L
, 
ba£
);

1179 
b
 = 
	`luaD_posÿÎ
(
L
, 
ci
, 
¿
, (b !ğ0 ? b - 1 : 
	`ÿ¡_št
(L->
tİ
 -„a)));

1180 ià(
ci
->
ÿÎ¡©us
 & 
CIST_FRESH
)

1183 
ci
 = 
L
->ci;

1184 ià(
b
è
L
->
tİ
 = 
ci
->top;

1185 
	`lua_as£¹
(
	`isLua
(
ci
));

1186 
	`lua_as£¹
(
	`GET_OPCODE
(*((
ci
)->
u
.
l
.
§vedpc
 - 1)è=ğ
OP_CALL
);

1187 
Ãwäame
;

1190 
	`vmÿ£
(
OP_FORLOOP
) {

1191 ià(
	`‰isš‹g”
(
¿
)) {

1192 
lua_IÁeg”
 
¡•
 = 
	`iv®ue
(
¿
 + 2);

1193 
lua_IÁeg”
 
idx
 = 
	`štİ
(+, 
	`iv®ue
(
¿
), 
¡•
);

1194 
lua_IÁeg”
 
lim™
 = 
	`iv®ue
(
¿
 + 1);

1195 ià((0 < 
¡•
è? (
idx
 <ğ
lim™
) : (limit <= idx)) {

1196 
ci
->
u
.
l
.
§vedpc
 +ğ
	`GETARG_sBx
(
i
);

1197 
	`chgiv®ue
(
¿
, 
idx
);

1198 
	`£tiv®ue
(
¿
 + 3, 
idx
);

1202 
lua_Numb”
 
¡•
 = 
	`ætv®ue
(
¿
 + 2);

1203 
lua_Numb”
 
idx
 = 
	`luai_numadd
(
L
, 
	`ætv®ue
(
¿
), 
¡•
);

1204 
lua_Numb”
 
lim™
 = 
	`ætv®ue
(
¿
 + 1);

1205 ià(
	`luai_numÉ
(0, 
¡•
è? 
	`luai_numË
(
idx
, 
lim™
)

1206 : 
	`luai_numË
(
lim™
, 
idx
)) {

1207 
ci
->
u
.
l
.
§vedpc
 +ğ
	`GETARG_sBx
(
i
);

1208 
	`chgætv®ue
(
¿
, 
idx
);

1209 
	`£tætv®ue
(
¿
 + 3, 
idx
);

1212 
vmb»ak
;

1214 
	`vmÿ£
(
OP_FORPREP
) {

1215 
TV®ue
 *
š™
 = 
¿
;

1216 
TV®ue
 *
¶im™
 = 
¿
 + 1;

1217 
TV®ue
 *
p¡•
 = 
¿
 + 2;

1218 
lua_IÁeg”
 
im™
;

1219 
¡İnow
;

1220 ià(
	`‰isš‹g”
(
š™
è&&tisš‹g”(
p¡•
) &&

1221 
	`fÜlim™
(
¶im™
, &
im™
, 
	`iv®ue
(
p¡•
), &
¡İnow
)) {

1223 
lua_IÁeg”
 
š™v
 = (
¡İnow
 ? 0 : 
	`iv®ue
(
š™
));

1224 
	`£tiv®ue
(
¶im™
, 
im™
);

1225 
	`£tiv®ue
(
š™
, 
	`štİ
(-, 
š™v
, 
	`iv®ue
(
p¡•
)));

1228 
lua_Numb”
 
nš™
;†ua_Numb” 
Æim™
;†ua_Numb” 
n¡•
;

1229 ià(!
	`tÚumb”
(
¶im™
, &
Æim™
))

1230 
	`luaG_ruÃ¼Ü
(
L
, "'for'†imit must be‡‚umber");

1231 
	`£tætv®ue
(
¶im™
, 
Æim™
);

1232 ià(!
	`tÚumb”
(
p¡•
, &
n¡•
))

1233 
	`luaG_ruÃ¼Ü
(
L
, "'for' step must be‡‚umber");

1234 
	`£tætv®ue
(
p¡•
, 
n¡•
);

1235 ià(!
	`tÚumb”
(
š™
, &
nš™
))

1236 
	`luaG_ruÃ¼Ü
(
L
, "'for' initial value must be‡‚umber");

1237 
	`£tætv®ue
(
š™
, 
	`luai_numsub
(
L
, 
nš™
, 
n¡•
));

1239 
ci
->
u
.
l
.
§vedpc
 +ğ
	`GETARG_sBx
(
i
);

1240 
vmb»ak
;

1242 
	`vmÿ£
(
OP_TFORCALL
) {

1243 
StkId
 
cb
 = 
¿
 + 3;

1244 
	`£tobjs2s
(
L
, 
cb
+2, 
¿
+2);

1245 
	`£tobjs2s
(
L
, 
cb
+1, 
¿
+1);

1246 
	`£tobjs2s
(
L
, 
cb
, 
¿
);

1247 
L
->
tİ
 = 
cb
 + 3;

1248 
	`PrÙeù
(
	`luaD_ÿÎ
(
L
, 
cb
, 
	`GETARG_C
(
i
)));

1249 
L
->
tİ
 = 
ci
->top;

1250 
i
 = *(
ci
->
u
.
l
.
§vedpc
++);

1251 
¿
 = 
	`RA
(
i
);

1252 
	`lua_as£¹
(
	`GET_OPCODE
(
i
è=ğ
OP_TFORLOOP
);

1253 
l_tfÜloİ
;

1255 
	`vmÿ£
(
OP_TFORLOOP
) {

1256 
l_tfÜloİ
:

1257 ià(!
	`‰i¢
(
¿
 + 1)) {

1258 
	`£tobjs2s
(
L
, 
¿
,„a + 1);

1259 
ci
->
u
.
l
.
§vedpc
 +ğ
	`GETARG_sBx
(
i
);

1261 
vmb»ak
;

1263 
	`vmÿ£
(
OP_SETLIST
) {

1264 
n
 = 
	`GETARG_B
(
i
);

1265 
c
 = 
	`GETARG_C
(
i
);

1266 
Ï¡
;

1267 
TabË
 *
h
;

1268 ià(
n
 =ğ0èÀğ
	`ÿ¡_št
(
L
->
tİ
 - 
¿
) - 1;

1269 ià(
c
 == 0) {

1270 
	`lua_as£¹
(
	`GET_OPCODE
(*
ci
->
u
.
l
.
§vedpc
è=ğ
OP_EXTRAARG
);

1271 
c
 = 
	`GETARG_Ax
(*
ci
->
u
.
l
.
§vedpc
++);

1273 
h
 = 
	`hv®ue
(
¿
);

1274 
Ï¡
 = ((
c
-1)*
LFIELDS_PER_FLUSH
è+ 
n
;

1275 ià(
Ï¡
 > 
h
->
siz—¼ay
)

1276 
	`luaH_»siz—¼ay
(
L
, 
h
, 
Ï¡
);

1277 ; 
n
 > 0;‚--) {

1278 
TV®ue
 *
v®
 = 
¿
+
n
;

1279 
	`luaH_£tšt
(
L
, 
h
, 
Ï¡
--, 
v®
);

1280 
	`luaC_b¬r›rback
(
L
, 
h
, 
v®
);

1282 
L
->
tİ
 = 
ci
->top;

1283 
vmb»ak
;

1285 
	`vmÿ£
(
OP_CLOSURE
) {

1286 
PrÙo
 *
p
 = 
ş
->p->p[
	`GETARG_Bx
(
i
)];

1287 
LClosu»
 *
nş
 = 
	`g‘ÿched
(
p
, 
ş
->
upv®s
, 
ba£
);

1288 ià(
nş
 =ğ
NULL
)

1289 
	`pushşosu»
(
L
, 
p
, 
ş
->
upv®s
, 
ba£
, 
¿
);

1291 
	`£tşLv®ue
(
L
, 
¿
, 
nş
);

1292 
	`checkGC
(
L
, 
¿
 + 1);

1293 
vmb»ak
;

1295 
	`vmÿ£
(
OP_VARARG
) {

1296 
b
 = 
	`GETARG_B
(
i
) - 1;

1297 
j
;

1298 
n
 = 
	`ÿ¡_št
(
ba£
 - 
ci
->
func
è- 
ş
->
p
->
num·¿ms
 - 1;

1299 ià(
n
 < 0)

1300 
n
 = 0;

1301 ià(
b
 < 0) {

1302 
b
 = 
n
;

1303 
	`PrÙeù
(
	`luaD_check¡ack
(
L
, 
n
));

1304 
¿
 = 
	`RA
(
i
);

1305 
L
->
tİ
 = 
¿
 + 
n
;

1307 
j
 = 0; j < 
b
 && j < 
n
; j++)

1308 
	`£tobjs2s
(
L
, 
¿
 + 
j
, 
ba£
 - 
n
 + j);

1309 ; 
j
 < 
b
; j++)

1310 
	`£Šv®ue
(
¿
 + 
j
);

1311 
vmb»ak
;

1313 
	`vmÿ£
(
OP_EXTRAARG
) {

1314 
	`lua_as£¹
(0);

1315 
vmb»ak
;

1319 
	}
}

	@script/lua/lua-5.3.4/src/lvm.h

7 #iâdeà
lvm_h


8 
	#lvm_h


	)

11 
	~"ldo.h
"

12 
	~"lobjeù.h
"

13 
	~"Ém.h
"

16 #ià!
defšed
(
LUA_NOCVTN2S
)

17 
	#cvt2¡r
(
o
è
	`‰i¢umb”
(o)

	)

19 
	#cvt2¡r
(
o
è0

	)

23 #ià!
defšed
(
LUA_NOCVTS2N
)

24 
	#cvt2num
(
o
è
	`‰is¡ršg
(o)

	)

26 
	#cvt2num
(
o
è0

	)

35 #ià!
defšed
(
LUA_FLOORN2I
)

36 
	#LUA_FLOORN2I
 0

	)

40 
	#tÚumb”
(
o
,
n
) \

41 (
	`‰isæßt
(
o
è? (*(
n
èğ
	`ætv®ue
(o), 1è: 
	`luaV_tÚumb”_
(o,n))

	)

43 
	#toš‹g”
(
o
,
i
) \

44 (
	`‰isš‹g”
(
o
è? (*(
i
èğ
	`iv®ue
(o), 1è: 
	`luaV_toš‹g”
(o,i,
LUA_FLOORN2I
))

	)

46 
	#štİ
(
İ
,
v1
,
v2
è
	`l_ÿ¡U2S
(
	`l_ÿ¡S2U
(v1èİ†_ÿ¡S2U(v2))

	)

48 
	#luaV_¿wequ®obj
(
t1
,
t2
è
	`luaV_equ®obj
(
NULL
,t1,t2)

	)

58 
	#luaV_ç¡g‘
(
L
,
t
,
k
,
¦Ù
,
f
) \

59 (!
	`‰i¡abË
(
t
) \

60 ? (
¦Ù
 = 
NULL
, 0) \

61 : (
¦Ù
 = 
	`f
(
	`hv®ue
(
t
), 
k
), \

62 !
	`‰i¢
(
¦Ù
))è

	)

67 
	#luaV_g‘bË
(
L
,
t
,
k
,
v
è{ cÚ¡ 
TV®ue
 *
¦Ù
; \

68 ià(
	`luaV_ç¡g‘
(
L
,
t
,
k
,
¦Ù
,
luaH_g‘
)è{ 
	`£tobj2s
(L, 
v
, slot); } \

69 
	`luaV_fšishg‘
(
L
,
t
,
k
,
v
,
¦Ù
); }

	)

80 
	#luaV_ç¡£t
(
L
,
t
,
k
,
¦Ù
,
f
,
v
) \

81 (!
	`‰i¡abË
(
t
) \

82 ? (
¦Ù
 = 
NULL
, 0) \

83 : (
¦Ù
 = 
	`f
(
	`hv®ue
(
t
), 
k
), \

84 
	`‰i¢
(
¦Ù
) ? 0 \

85 : (
	`luaC_b¬r›rback
(
L
, 
	`hv®ue
(
t
), 
v
), \

86 
	`£tobj2t
(
L
, 
	`ÿ¡
(
TV®ue
 *,
¦Ù
), 
v
), \

87 1)))

	)

90 
	#luaV_£‰abË
(
L
,
t
,
k
,
v
è{ cÚ¡ 
TV®ue
 *
¦Ù
; \

91 ià(!
	`luaV_ç¡£t
(
L
,
t
,
k
,
¦Ù
,
luaH_g‘
,
v
)) \

92 
	`luaV_fšish£t
(
L
,
t
,
k
,
v
,
¦Ù
); }

	)

96 
LUAI_FUNC
 
luaV_equ®obj
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t1
, cÚ¡ TV®u*
t2
);

97 
LUAI_FUNC
 
luaV_Ës¡hª
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
l
, cÚ¡ TV®u*
r
);

98 
LUAI_FUNC
 
luaV_Ës£qu®
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
l
, cÚ¡ TV®u*
r
);

99 
LUAI_FUNC
 
luaV_tÚumb”_
 (cÚ¡ 
TV®ue
 *
obj
, 
lua_Numb”
 *
n
);

100 
LUAI_FUNC
 
luaV_toš‹g”
 (cÚ¡ 
TV®ue
 *
obj
, 
lua_IÁeg”
 *
p
, 
mode
);

101 
LUAI_FUNC
 
luaV_fšishg‘
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t
, TV®u*
key
,

102 
StkId
 
v®
, cÚ¡ 
TV®ue
 *
¦Ù
);

103 
LUAI_FUNC
 
luaV_fšish£t
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t
, TV®u*
key
,

104 
StkId
 
v®
, cÚ¡ 
TV®ue
 *
¦Ù
);

105 
LUAI_FUNC
 
luaV_fšishOp
 (
lua_S‹
 *
L
);

106 
LUAI_FUNC
 
luaV_execu‹
 (
lua_S‹
 *
L
);

107 
LUAI_FUNC
 
luaV_cÚÿt
 (
lua_S‹
 *
L
, 
tÙ®
);

108 
LUAI_FUNC
 
lua_IÁeg”
 
luaV_div
 (
lua_S‹
 *
L
,†ua_IÁeg” 
x
,†ua_IÁeg” 
y
);

109 
LUAI_FUNC
 
lua_IÁeg”
 
luaV_mod
 (
lua_S‹
 *
L
,†ua_IÁeg” 
x
,†ua_IÁeg” 
y
);

110 
LUAI_FUNC
 
lua_IÁeg”
 
luaV_shiál
 (lua_IÁeg” 
x
,†ua_IÁeg” 
y
);

111 
LUAI_FUNC
 
luaV_objËn
 (
lua_S‹
 *
L
, 
StkId
 
¿
, cÚ¡ 
TV®ue
 *
rb
);

	@script/lua/lua-5.3.4/src/lzio.c

7 
	#lzio_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ršg.h
>

15 
	~"lua.h
"

17 
	~"Îim™s.h
"

18 
	~"lmem.h
"

19 
	~"l¡©e.h
"

20 
	~"lzio.h
"

23 
	$luaZ_fl
 (
ZIO
 *
z
) {

24 
size_t
 
size
;

25 
lua_S‹
 *
L
 = 
z
->L;

26 cÚ¡ *
buff
;

27 
	`lua_uÆock
(
L
);

28 
buff
 = 
z
->
	`»ad”
(
L
, z->
d©a
, &
size
);

29 
	`lua_lock
(
L
);

30 ià(
buff
 =ğ
NULL
 || 
size
 == 0)

31  
EOZ
;

32 
z
->
n
 = 
size
 - 1;

33 
z
->
p
 = 
buff
;

34  
	`ÿ¡_uch¬
(*(
z
->
p
++));

35 
	}
}

38 
	$luaZ_š™
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, 
lua_R—d”
 
»ad”
, *
d©a
) {

39 
z
->
L
 = L;

40 
z
->
»ad”
 =„eader;

41 
z
->
d©a
 = data;

42 
z
->
n
 = 0;

43 
z
->
p
 = 
NULL
;

44 
	}
}

48 
size_t
 
	$luaZ_»ad
 (
ZIO
 *
z
, *
b
, 
size_t
 
n
) {

49 
n
) {

50 
size_t
 
m
;

51 ià(
z
->
n
 == 0) {

52 ià(
	`luaZ_fl
(
z
è=ğ
EOZ
)

53  
n
;

55 
z
->
n
++;

56 
z
->
p
--;

59 
m
 = (
n
 <ğ
z
->n) ?‚ : z->n;

60 
	`memıy
(
b
, 
z
->
p
, 
m
);

61 
z
->
n
 -ğ
m
;

62 
z
->
p
 +ğ
m
;

63 
b
 = (*)b + 
m
;

64 
n
 -ğ
m
;

67 
	}
}

	@script/lua/lua-5.3.4/src/lzio.h

8 #iâdeà
lzio_h


9 
	#lzio_h


	)

11 
	~"lua.h
"

13 
	~"lmem.h
"

16 
	#EOZ
 (-1è

	)

18 
Zio
 
	tZIO
;

20 
	#zg‘c
(
z
è(((z)->
n
--)>0 ? 
	`ÿ¡_uch¬
(*(z)->
p
++è: 
	`luaZ_fl
(z))

	)

23 
	sMbufãr
 {

24 *
	mbufãr
;

25 
size_t
 
	mn
;

26 
size_t
 
	mbuffsize
;

27 } 
	tMbufãr
;

29 
	#luaZ_š™bufãr
(
L
, 
buff
è((buff)->
bufãr
 = 
NULL
, (buff)->
buffsize
 = 0)

	)

31 
	#luaZ_bufãr
(
buff
è((buff)->
bufãr
)

	)

32 
	#luaZ_sizebufãr
(
buff
è((buff)->
buffsize
)

	)

33 
	#luaZ_bufæ’
(
buff
è((buff)->
n
)

	)

35 
	#luaZ_bufäemove
(
buff
,
i
è((buff)->
n
 -ğ(i))

	)

36 
	#luaZ_»£tbufãr
(
buff
è((buff)->
n
 = 0)

	)

39 
	#luaZ_»sizebufãr
(
L
, 
buff
, 
size
) \

40 ((
buff
)->
bufãr
 = 
	`luaM_»®locvch¬
(
L
, (buff)->buffer, \

41 (
buff
)->
buffsize
, 
size
), \

42 (
buff
)->
buffsize
 = 
size
)

	)

44 
	#luaZ_ä“bufãr
(
L
, 
buff
è
	`luaZ_»sizebufãr
(L, buff, 0)

	)

47 
LUAI_FUNC
 
luaZ_š™
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, 
lua_R—d”
 
»ad”
,

48 *
d©a
);

49 
LUAI_FUNC
 
size_t
 
luaZ_»ad
 (
ZIO
* 
z
, *
b
, size_ˆ
n
);

55 
	sZio
 {

56 
size_t
 
	mn
;

57 cÚ¡ *
	mp
;

58 
lua_R—d”
 
	m»ad”
;

59 *
	md©a
;

60 
lua_S‹
 *
	mL
;

64 
LUAI_FUNC
 
luaZ_fl
 (
ZIO
 *
z
);

	@
1
.
0
144
3778
Gear.cpp
Gear.h
base/Array.h
base/List.h
base/Map.h
base/QList.h
base/Queue.h
base/Singleton.h
base/base.h
debug/DebugInput.cpp
debug/DebugInput.h
debug/debugfunc.h
gearkit.h
kit/Buffer.cpp
kit/Buffer.h
kit/BufferPool.cpp
kit/BufferPool.h
kit/Emitter.h
kit/Functions.cpp
kit/Functions.h
kit/Logger.cpp
kit/Logger.h
kit/Ref.cpp
kit/Ref.h
kit/RefPool.cpp
kit/RefPool.h
kit/Thread.cpp
kit/Thread.h
kit/Timer.cpp
kit/Timer.h
kit/impl/BufferImpl.h
kit/kit.h
kit/kitsys.cpp
kit/kitsys.h
kit/platform/linux/Thread_linux.cpp
kit/platform/linux/Thread_linux.h
network/Client.cpp
network/Client.h
network/Packet.cpp
network/Packet.h
network/Protocol.cpp
network/Protocol.h
network/Server.cpp
network/Server.h
network/Session.cpp
network/Session.h
network/SockAddr.cpp
network/SockAddr.h
network/Socket.cpp
network/Socket.h
network/Terminal.cpp
network/Terminal.h
network/msg.h
network/netsys.h
network/network.h
network/platform/linux/Client_linux.cpp
network/platform/linux/Client_linux.h
network/platform/linux/Server_linux.cpp
network/platform/linux/Server_linux.h
network/platform/linux/SockAddr_linux.cpp
network/platform/linux/SockAddr_linux.h
network/platform/linux/Socket_linux.cpp
network/platform/linux/Socket_linux.h
network/platform/win/Client.cpp
network/platform/win/Server.cpp
network/platform/win/SockAddr.cpp
network/platform/win/Socket.cpp
script/ScriptSupport.cpp
script/ScriptSupport.h
script/js/JSCore.cpp
script/js/JSCore.h
script/lua/LuaBinding.cpp
script/lua/LuaBinding.h
script/lua/LuaBuffer.cpp
script/lua/LuaBuffer.h
script/lua/LuaCore.cpp
script/lua/LuaCore.h
script/lua/LuaDebug.cpp
script/lua/LuaDebug.h
script/lua/LuaFunctions.cpp
script/lua/LuaFunctions.h
script/lua/LuaProtocol.cpp
script/lua/LuaProtocol.h
script/lua/lua-5.3.4/src/lapi.c
script/lua/lua-5.3.4/src/lapi.h
script/lua/lua-5.3.4/src/lauxlib.c
script/lua/lua-5.3.4/src/lauxlib.h
script/lua/lua-5.3.4/src/lbaselib.c
script/lua/lua-5.3.4/src/lbitlib.c
script/lua/lua-5.3.4/src/lcode.c
script/lua/lua-5.3.4/src/lcode.h
script/lua/lua-5.3.4/src/lcorolib.c
script/lua/lua-5.3.4/src/lctype.c
script/lua/lua-5.3.4/src/lctype.h
script/lua/lua-5.3.4/src/ldblib.c
script/lua/lua-5.3.4/src/ldebug.c
script/lua/lua-5.3.4/src/ldebug.h
script/lua/lua-5.3.4/src/ldo.c
script/lua/lua-5.3.4/src/ldo.h
script/lua/lua-5.3.4/src/ldump.c
script/lua/lua-5.3.4/src/lfunc.c
script/lua/lua-5.3.4/src/lfunc.h
script/lua/lua-5.3.4/src/lgc.c
script/lua/lua-5.3.4/src/lgc.h
script/lua/lua-5.3.4/src/linit.c
script/lua/lua-5.3.4/src/liolib.c
script/lua/lua-5.3.4/src/llex.c
script/lua/lua-5.3.4/src/llex.h
script/lua/lua-5.3.4/src/llimits.h
script/lua/lua-5.3.4/src/lmathlib.c
script/lua/lua-5.3.4/src/lmem.c
script/lua/lua-5.3.4/src/lmem.h
script/lua/lua-5.3.4/src/loadlib.c
script/lua/lua-5.3.4/src/lobject.c
script/lua/lua-5.3.4/src/lobject.h
script/lua/lua-5.3.4/src/lopcodes.c
script/lua/lua-5.3.4/src/lopcodes.h
script/lua/lua-5.3.4/src/loslib.c
script/lua/lua-5.3.4/src/lparser.c
script/lua/lua-5.3.4/src/lparser.h
script/lua/lua-5.3.4/src/lprefix.h
script/lua/lua-5.3.4/src/lstate.c
script/lua/lua-5.3.4/src/lstate.h
script/lua/lua-5.3.4/src/lstring.c
script/lua/lua-5.3.4/src/lstring.h
script/lua/lua-5.3.4/src/lstrlib.c
script/lua/lua-5.3.4/src/ltable.c
script/lua/lua-5.3.4/src/ltable.h
script/lua/lua-5.3.4/src/ltablib.c
script/lua/lua-5.3.4/src/ltm.c
script/lua/lua-5.3.4/src/ltm.h
script/lua/lua-5.3.4/src/lua.c
script/lua/lua-5.3.4/src/lua.h
script/lua/lua-5.3.4/src/lua.hpp
script/lua/lua-5.3.4/src/luac.c
script/lua/lua-5.3.4/src/luaconf.h
script/lua/lua-5.3.4/src/lualib.h
script/lua/lua-5.3.4/src/lundump.c
script/lua/lua-5.3.4/src/lundump.h
script/lua/lua-5.3.4/src/lutf8lib.c
script/lua/lua-5.3.4/src/lvm.c
script/lua/lua-5.3.4/src/lvm.h
script/lua/lua-5.3.4/src/lzio.c
script/lua/lua-5.3.4/src/lzio.h
